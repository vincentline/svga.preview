# SVGAè½¬MP4åŠŸèƒ½æŠ€æœ¯æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-18  
> **æœ€åæ›´æ–°**: 2025-12-18  
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
3. [æ ¸å¿ƒæŠ€æœ¯](#3-æ ¸å¿ƒæŠ€æœ¯)
4. [å®ç°æµç¨‹](#4-å®ç°æµç¨‹)
5. [ä»£ç å®ç°](#5-ä»£ç å®ç°)
6. [æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
7. [é”™è¯¯å¤„ç†](#7-é”™è¯¯å¤„ç†)
8. [å…¼å®¹æ€§](#8-å…¼å®¹æ€§)
9. [æµ‹è¯•éªŒè¯](#9-æµ‹è¯•éªŒè¯)
10. [å·²çŸ¥é—®é¢˜](#10-å·²çŸ¥é—®é¢˜)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰

å°†SVGAåŠ¨ç”»æ–‡ä»¶è½¬æ¢ä¸ºYYEVAæ ¼å¼çš„MP4è§†é¢‘ï¼Œæ”¯æŒé€æ˜é€šé“ã€‚YYEVAï¼ˆYY Effect Video Animationï¼‰æ˜¯ä¸€ç§å°†å½©è‰²è§†é¢‘å’ŒAlphaé€šé“åˆå¹¶åˆ°ä¸€ä¸ªMP4æ–‡ä»¶ä¸­çš„æ ¼å¼æ–¹æ¡ˆã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

- âœ… **åŒé€šé“åˆæˆ**: æ”¯æŒå·¦å½©å³ç°/å·¦ç°å³å½©ä¸¤ç§å¸ƒå±€æ¨¡å¼
- âœ… **å°ºå¯¸è‡ªå®šä¹‰**: æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºå°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”é”å®š
- âœ… **è´¨é‡æ§åˆ¶**: å¯è°ƒèŠ‚å‹ç¼©è´¨é‡ï¼ˆ1-100%ï¼‰ï¼ŒCRFèŒƒå›´18-51
- âœ… **å¸§ç‡è°ƒæ•´**: æ”¯æŒ1-120fpså¸§ç‡è®¾ç½®
- âœ… **éŸ³é¢‘æ”¯æŒ**: è‡ªåŠ¨æå–SVGAéŸ³é¢‘å¹¶åˆæˆåˆ°MP4
- âœ… **é™éŸ³é€‰é¡¹**: å¯é€‰æ‹©ç”Ÿæˆæ— éŸ³é¢‘çš„MP4æ–‡ä»¶
- âœ… **è¿›åº¦æ˜¾ç¤º**: å®æ—¶æ˜¾ç¤ºè½¬æ¢è¿›åº¦å’Œå½“å‰é˜¶æ®µ
- âœ… **å¯å–æ¶ˆ**: æ”¯æŒéšæ—¶å–æ¶ˆè½¬æ¢æ“ä½œ
- âœ… **é…ç½®æŒä¹…åŒ–**: è‡ªåŠ¨ä¿å­˜ç”¨æˆ·é…ç½®åˆ°localStorage

### 1.3 YYEVAæ ¼å¼è¯´æ˜

**æ ¼å¼åŸç†**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŸå§‹SVGAåŠ¨ç”»ï¼ˆå¸¦é€æ˜é€šé“ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  åˆ†ç¦»RGBå’ŒAlpha  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                 â”‚
       â–¼                 â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚RGBé€šé“ â”‚       â”‚Alphaé€šâ”‚
  â”‚(å½©è‰²)  â”‚       â”‚é“(ç°åº¦)â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  å·¦å³/ä¸Šä¸‹å¹¶æ’   â”‚
      â”‚  åˆæˆä¸ºä¸€å¸§      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ç¼–ç ä¸ºMP4è§†é¢‘    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
       YYEVA-MP4æ–‡ä»¶
```

**å¸ƒå±€æ¨¡å¼**:
- **å·¦å½©å³ç°** (color-left-alpha-right): å·¦ä¾§ä¸ºå½©è‰²RGBé€šé“ï¼Œå³ä¾§ä¸ºAlphaç°åº¦å›¾
- **å·¦ç°å³å½©** (alpha-left-color-right): å·¦ä¾§ä¸ºAlphaç°åº¦å›¾ï¼Œå³ä¾§ä¸ºå½©è‰²RGBé€šé“

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TD
    A[SVGAæ–‡ä»¶] --> B[åºåˆ—å¸§æå–]
    B --> C[åŒé€šé“åˆæˆ]
    C --> D[é»‘åº•+JPEGé¢„å¤„ç†]
    D --> E[FFmpegç¼–ç ]
    E --> F[MP4æ–‡ä»¶]
    
    G[é…ç½®å‚æ•°] --> B
    G --> C
    G --> E
    
    H[éŸ³é¢‘æ•°æ®] --> E
    
    style A fill:#e1f5ff
    style F fill:#c8e6c9
    style G fill:#fff9c4
    style H fill:#ffe0b2
```

### 2.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | å¤‡æ³¨ |
|------|------|------|------|
| **Vue.js** | 2.x | å‰ç«¯æ¡†æ¶ | æ•°æ®ç»‘å®šå’ŒçŠ¶æ€ç®¡ç† |
| **Canvas API** | - | å›¾åƒå¤„ç† | åºåˆ—å¸§æå–å’Œé€šé“åˆæˆ |
| **ffmpeg.wasm** | 0.11.6 | è§†é¢‘ç¼–ç  | æµè§ˆå™¨ç«¯MP4ç¼–ç  |
| **@ffmpeg/core** | 0.11.0 | FFmpegæ ¸å¿ƒ | WASMç¼–ç å¼•æ“ |
| **SVGA.js** | - | SVGAè§£æ | æ’­æ”¾å™¨å’Œå¸§æ§åˆ¶ |

### 2.3 æ•°æ®æµ

```
ç”¨æˆ·é…ç½® (Vue Data)
  â”œâ”€ channelMode: 'color-left-alpha-right' | 'alpha-left-color-right'
  â”œâ”€ width: Number (0è¡¨ç¤ºä½¿ç”¨åŸå§‹å®½åº¦)
  â”œâ”€ height: Number (0è¡¨ç¤ºä½¿ç”¨åŸå§‹é«˜åº¦)
  â”œâ”€ quality: 1-100 (å‹ç¼©è´¨é‡ç™¾åˆ†æ¯”)
  â”œâ”€ fps: 1-120 (å¸§ç‡)
  â””â”€ muted: Boolean (æ˜¯å¦é™éŸ³)

  â†“

åºåˆ—å¸§æ•°æ® (Array<ImageData>)
  æ¯å¸§åŒ…å« width Ã— height Ã— 4 å­—èŠ‚RGBAæ•°æ®

  â†“

åŒé€šé“Canvas (Array<Canvas>)
  å®½åº¦ = åŸå§‹å®½åº¦ Ã— 2
  é«˜åº¦ = åŸå§‹é«˜åº¦
  å·¦å³ä¸¤ä¾§åˆ†åˆ«å­˜å‚¨RGBå’ŒAlphaæ•°æ®

  â†“

JPEG Blob (Array<Blob>)
  åŠ é»‘åº•åè½¬ä¸ºJPEGæ ¼å¼ï¼ˆè´¨é‡60%ï¼‰
  
  â†“

FFmpegè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
  frame_0000.jpg ~ frame_NNNN.jpg
  + audio.mp3 (å¦‚æœæœ‰éŸ³é¢‘)

  â†“

MP4 Blob
  æœ€ç»ˆç¼–ç çš„è§†é¢‘æ–‡ä»¶
```

---

## 3. æ ¸å¿ƒæŠ€æœ¯

### 3.1 ffmpeg.wasmé›†æˆ

#### 3.1.1 ç‰ˆæœ¬é€‰æ‹©

**ä¸ºä»€ä¹ˆé€‰æ‹©0.11ç‰ˆæœ¬è€Œé0.12?**

| ç‰¹æ€§ | 0.11ç‰ˆæœ¬ | 0.12ç‰ˆæœ¬ |
|------|---------|---------|
| SharedArrayBufferä¾èµ– | âŒ ä¸éœ€è¦ | âœ… å¿…éœ€ |
| è·¨åŸŸéš”ç¦»è¦æ±‚ | âŒ æ—  | âœ… éœ€è¦COOP/COEPå¤´ |
| æœ¬åœ°å¼€å‘å‹å¥½åº¦ | âœ… é«˜ | âš ï¸ ä½ï¼ˆéœ€ç‰¹æ®ŠæœåŠ¡å™¨ï¼‰ |
| APIé£æ ¼ | å¯¹è±¡æ–¹æ³• | Promiseé“¾ |
| æ€§èƒ½ | è¾ƒå¥½ | ç¨ä¼˜ |

**ç»“è®º**: 0.11ç‰ˆæœ¬æ›´é€‚åˆçº¯é™æ€éƒ¨ç½²çš„åœºæ™¯ï¼Œé¿å…äº†è·¨åŸŸéš”ç¦»çš„å¤æ‚é…ç½®ã€‚

#### 3.1.2 åŠ è½½ç­–ç•¥

```javascript
// æ‡’åŠ è½½ - ä»…åœ¨ç”¨æˆ·ç‚¹å‡»è½¬æ¢æ—¶åŠ è½½
loadFFmpeg: async function() {
  // 1. æ£€æŸ¥SharedArrayBufferæ”¯æŒï¼ˆ0.11è™½ä¸å¼ºåˆ¶è¦æ±‚ï¼Œä½†æ£€æµ‹æœ‰åŠ©äºæç¤ºï¼‰
  if (typeof SharedArrayBuffer === 'undefined') {
    // å¼¹çª—è­¦å‘Šå¹¶å¼•å¯¼ç”¨æˆ·
  }
  
  // 2. é¿å…é‡å¤åŠ è½½
  if (this.ffmpegLoaded) return;
  if (this.ffmpegLoading) {
    // ç­‰å¾…åŠ è½½å®Œæˆ
    while (this.ffmpegLoading) {
      await new Promise(r => setTimeout(r, 100));
    }
    return;
  }
  
  // 3. åŠ¨æ€åŠ è½½è„šæœ¬ï¼ˆä»CDNï¼‰
  if (typeof FFmpeg === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js';
    // ç›‘å¬åŠ è½½äº‹ä»¶
  }
  
  // 4. åˆ›å»ºå®ä¾‹å¹¶åŠ è½½æ ¸å¿ƒWASMæ–‡ä»¶ï¼ˆçº¦25MBï¼‰
  this.ffmpeg = FFmpeg.createFFmpeg({
    log: true,
    corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
  });
  await this.ffmpeg.load();
}
```

**å…³é”®ç‚¹**:
- âœ… CDNåŠ é€Ÿ: ä½¿ç”¨unpkgå’ŒjsdelivråŒCDNä¿è¯å¯ç”¨æ€§
- âœ… è¿›åº¦æç¤º: åŠ è½½25MB WASMæ–‡ä»¶æ—¶æ˜¾ç¤º"æ­£åœ¨åŠ è½½ç¼–ç å™¨"
- âœ… é”™è¯¯å¤„ç†: ç½‘ç»œå¤±è´¥æ—¶æä¾›æ˜ç¡®çš„é”™è¯¯æç¤º
- âœ… å•ä¾‹æ¨¡å¼: å…¨å±€å…±äº«ä¸€ä¸ªffmpegå®ä¾‹

### 3.2 åºåˆ—å¸§æå–

#### 3.2.1 æŠ€æœ¯æ–¹æ¡ˆ

```javascript
extractFrames: async function() {
  const videoItem = this.originalVideoItem;
  const totalFrames = videoItem.frames;
  const frames = [];
  
  // ä¿å­˜æ’­æ”¾çŠ¶æ€
  const wasPlaying = this.isPlaying;
  if (wasPlaying) {
    this.svgaPlayer.pauseAnimation();
  }
  
  // ç›´æ¥ä½¿ç”¨ä¸»æ’­æ”¾å™¨Canvas
  const playerCanvas = this.$refs.svgaContainer.querySelector('canvas');
  
  for (let i = 0; i < totalFrames; i++) {
    // 1. è·³è½¬åˆ°æŒ‡å®šå¸§
    this.svgaPlayer.stepToFrame(i, false);
    
    // 2. ç­‰å¾…æ¸²æŸ“å®Œæˆ
    await new Promise(r => setTimeout(r, 100));
    
    // 3. åˆ›å»ºä¸´æ—¶Canvasï¼ˆç›®æ ‡å°ºå¯¸ï¼‰
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = targetWidth;
    tempCanvas.height = targetHeight;
    const tempCtx = tempCanvas.getContext('2d', { 
      alpha: true,
      willReadFrequently: true
    });
    
    // 4. ç¦ç”¨å›¾åƒå¹³æ»‘ï¼ˆä¿æŒåƒç´ é”åˆ©ï¼‰
    tempCtx.imageSmoothingEnabled = false;
    
    // 5. ç¼©æ”¾ç»˜åˆ¶
    tempCtx.clearRect(0, 0, targetWidth, targetHeight);
    tempCtx.drawImage(playerCanvas, 
      0, 0, playerCanvas.width, playerCanvas.height,
      0, 0, targetWidth, targetHeight
    );
    
    // 6. æå–ImageData
    const imageData = tempCtx.getImageData(0, 0, targetWidth, targetHeight);
    frames.push(imageData);
    
    // 7. è®©å‡ºçº¿ç¨‹ï¼ˆé¿å…é˜»å¡UIï¼‰
    if (i % 5 === 0) {
      await new Promise(r => setTimeout(r, 0));
    }
  }
  
  // æ¢å¤æ’­æ”¾çŠ¶æ€
  if (wasPlaying) {
    this.svgaPlayer.startAnimation();
  }
  
  return frames;
}
```

**ä¼˜åŒ–è¦ç‚¹**:
- âœ… **å¤ç”¨æ’­æ”¾å™¨Canvas**: ä¸åˆ›å»ºæ–°çš„SVGAå®ä¾‹ï¼Œç›´æ¥ä½¿ç”¨é¡µé¢ä¸Šçš„æ’­æ”¾å™¨
- âœ… **å°ºå¯¸ç¼©æ”¾**: æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºå°ºå¯¸ï¼Œä½¿ç”¨drawImageè‡ªåŠ¨ç¼©æ”¾
- âœ… **å…³é—­å›¾åƒå¹³æ»‘**: ä¿æŒåŠ¨ç”»çš„é”åˆ©è¾¹ç¼˜ï¼Œé¿å…æ¨¡ç³Š
- âœ… **åˆ†æ‰¹è®©å‡ºçº¿ç¨‹**: æ¯5å¸§yieldä¸€æ¬¡ï¼Œä¿æŒç•Œé¢å“åº”
- âœ… **çŠ¶æ€æ¢å¤**: æå–å®Œæˆåæ¢å¤åŸæ’­æ”¾çŠ¶æ€

#### 3.2.2 ImageDataæ ¼å¼

```
ImageData {
  width: å®½åº¦ï¼ˆåƒç´ ï¼‰
  height: é«˜åº¦ï¼ˆåƒç´ ï¼‰
  data: Uint8ClampedArray
    [R0, G0, B0, A0,  // åƒç´ 0
     R1, G1, B1, A1,  // åƒç´ 1
     ...
     Rn, Gn, Bn, An]  // åƒç´ n
}

æ€»å­—èŠ‚æ•° = width Ã— height Ã— 4
```

**æ³¨æ„**: Canvasçš„`getImageData`è¿”å›çš„æ˜¯**é¢„ä¹˜Alpha**çš„æ•°æ®ï¼Œåç»­éœ€è¦åé¢„ä¹˜ã€‚

### 3.3 åŒé€šé“åˆæˆ

#### 3.3.1 åé¢„ä¹˜Alphaç®—æ³•

**ä¸ºä»€ä¹ˆéœ€è¦åé¢„ä¹˜?**

Canvaså­˜å‚¨çš„RGBAæ˜¯é¢„ä¹˜æ ¼å¼ï¼š
```
å­˜å‚¨çš„RGB = åŸå§‹RGB Ã— Alpha
```

è¦æ¢å¤åŸå§‹é¢œè‰²ï¼š
```javascript
if (a > 0 && a < 255) {
  finalR = Math.min(255, Math.round(r * 255 / a));
  finalG = Math.min(255, Math.round(g * 255 / a));
  finalB = Math.min(255, Math.round(b * 255 / a));
} else if (a === 0) {
  // å®Œå…¨é€æ˜ï¼šé¢œè‰²ç½®ä¸ºé»‘è‰²
  finalR = finalG = finalB = 0;
}
// a === 255: ä¸éœ€è¦å¤„ç†
```

#### 3.3.2 åŒé€šé“å¸ƒå±€

```javascript
composeDualChannel: function(imageData, isColorLeftAlphaRight) {
  const width = imageData.width;
  const height = imageData.height;
  
  // åˆ›å»ºå®½åº¦Ã—2çš„Canvas
  const dualCanvas = document.createElement('canvas');
  dualCanvas.width = width * 2;
  dualCanvas.height = height;
  const dualCtx = dualCanvas.getContext('2d', { 
    alpha: true,  // å¿…é¡»ä¿ç•™alphaé€šé“
    willReadFrequently: true 
  });
  
  // ç¦ç”¨å›¾åƒå¹³æ»‘
  dualCtx.imageSmoothingEnabled = false;
  
  // æ¸…ç©ºä¸ºé€æ˜èƒŒæ™¯
  dualCtx.clearRect(0, 0, width * 2, height);
  
  // åˆ›å»ºå·¦å³ImageData
  const leftData = dualCtx.createImageData(width, height);
  const rightData = dualCtx.createImageData(width, height);
  
  // é€åƒç´ åˆ†ç¦»
  for (let i = 0; i < imageData.data.length; i += 4) {
    const r = imageData.data[i + 0];
    const g = imageData.data[i + 1];
    const b = imageData.data[i + 2];
    const a = imageData.data[i + 3];
    
    // åé¢„ä¹˜
    let finalR = r, finalG = g, finalB = b;
    if (a > 0 && a < 255) {
      finalR = Math.min(255, Math.round(r * 255 / a));
      finalG = Math.min(255, Math.round(g * 255 / a));
      finalB = Math.min(255, Math.round(b * 255 / a));
    } else if (a === 0) {
      finalR = finalG = finalB = 0;
    }
    
    if (isColorLeftAlphaRight) {
      // å·¦å½©å³ç°
      leftData.data[i + 0] = finalR;
      leftData.data[i + 1] = finalG;
      leftData.data[i + 2] = finalB;
      leftData.data[i + 3] = a;  // ä¿ç•™åŸå§‹alphaï¼ˆé¿å…é”¯é½¿ï¼‰
      
      rightData.data[i + 0] = a;  // ç°åº¦ = alphaå€¼
      rightData.data[i + 1] = a;
      rightData.data[i + 2] = a;
      rightData.data[i + 3] = 255; // Alphaé€šé“å¿…é¡»ä¸é€æ˜
    } else {
      // å·¦ç°å³å½©ï¼ˆåŒç†ï¼‰
      leftData.data[i + 0] = a;
      leftData.data[i + 1] = a;
      leftData.data[i + 2] = a;
      leftData.data[i + 3] = 255;
      
      rightData.data[i + 0] = finalR;
      rightData.data[i + 1] = finalG;
      rightData.data[i + 2] = finalB;
      rightData.data[i + 3] = a;
    }
  }
  
  // ä½¿ç”¨putImageDataå†™å…¥ï¼ˆé¿å…drawImageçš„alphaæ··åˆï¼‰
  dualCtx.putImageData(leftData, 0, 0);
  dualCtx.putImageData(rightData, width, 0);
  
  return dualCanvas;
}
```

**å…³é”®è®¾è®¡**:
- âœ… **å½©è‰²é€šé“ä¿ç•™åŠé€æ˜**: é¿å…é”¯é½¿è¾¹ç¼˜ï¼ˆputImageDataä¸åšalphaæ··åˆï¼‰
- âœ… **ç°åº¦é€šé“ä¸é€æ˜**: Alphaå€¼å­˜å‚¨åœ¨RGBä¸­ï¼Œé€šé“æœ¬èº«alpha=255
- âœ… **ä½¿ç”¨putImageData**: ç›´æ¥åƒç´ çº§å†™å…¥ï¼Œä¸ç»è¿‡drawImageçš„alphaæ··åˆ

#### 3.3.3 é€šé“å¸ƒå±€ç¤ºæ„

```
åŸå§‹å¸§ (100x100, RGBA):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å½©è‰²    â”‚
â”‚  + Alpha â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŒé€šé“å¸§ (200x100):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½©è‰²RGB  â”‚ Alphaç°åº¦â”‚
â”‚ (åŠé€æ˜) â”‚ (ä¸é€æ˜) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å·¦ä¾§: finalR, finalG, finalB, a (ä¿ç•™åŸalpha)
å³ä¾§: a, a, a, 255 (alphaå€¼å­˜å‚¨åœ¨RGBï¼Œé€šé“alpha=255)
```

### 3.4 é»‘åº•JPEGé¢„å¤„ç†

#### 3.4.1 ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€æ­¥ï¼Ÿ

**é—®é¢˜**: åŒé€šé“Canvasä¸­å½©è‰²éƒ¨åˆ†ä¿ç•™äº†åŠé€æ˜alphaï¼Œå¦‚æœç›´æ¥ç”¨drawImageç»˜åˆ¶åˆ°é»‘åº•ï¼Œä¼šå‘ç”Ÿalphaæ··åˆå¯¼è‡´é¢œè‰²å˜æš—ã€‚

**è§£å†³æ–¹æ¡ˆ**: æ‰‹åŠ¨åƒç´ çº§åˆæˆï¼Œä¸åšalphaæ··åˆã€‚

```javascript
// è·å–åŒé€šé“å›¾åƒæ•°æ®
const dualCtx = frameCanvas.getContext('2d');
const dualImageData = dualCtx.getImageData(0, 0, frameCanvas.width, frameCanvas.height);
const dualData = dualImageData.data;

// åˆ›å»ºé»‘åº•å›¾åƒæ•°æ®
const blackBgCanvas = document.createElement('canvas');
blackBgCanvas.width = frameCanvas.width;
blackBgCanvas.height = frameCanvas.height;
const blackBgCtx = blackBgCanvas.getContext('2d');
const blackBgImageData = blackBgCtx.createImageData(frameCanvas.width, frameCanvas.height);
const blackBgData = blackBgImageData.data;

// æ‰‹åŠ¨åˆæˆï¼šç›´æ¥ä½¿ç”¨RGBï¼Œä¸åšæ··åˆ
for (let j = 0; j < dualData.length; j += 4) {
  const r = dualData[j + 0];
  const g = dualData[j + 1];
  const b = dualData[j + 2];
  // const a = dualData[j + 3];  // å¿½ç•¥alpha
  
  blackBgData[j + 0] = r;
  blackBgData[j + 1] = g;
  blackBgData[j + 2] = b;
  blackBgData[j + 3] = 255;  // JPEGä¸æ”¯æŒé€æ˜
}

// å†™å…¥é»‘åº•Canvas
blackBgCtx.putImageData(blackBgImageData, 0, 0);

// è½¬ä¸ºJPEGï¼ˆè´¨é‡60%ï¼‰
const blob = await new Promise(resolve => {
  blackBgCanvas.toBlob(resolve, 'image/jpeg', 0.6);
});
```

#### 3.4.2 æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

| æ­¥éª¤ | PNGæ–¹æ¡ˆ | JPEGæ–¹æ¡ˆ | æå‡å€æ•° |
|------|---------|---------|---------|
| å•å¸§æ–‡ä»¶å¤§å° | ~200KB | ~20KB | **10x** |
| å†™å…¥FFmpegé€Ÿåº¦ | æ…¢ | å¿« | **5-10x** |
| ç¼–ç é€Ÿåº¦ | æ…¢ï¼ˆå¤§æ–‡ä»¶ï¼‰ | å¿«ï¼ˆå°æ–‡ä»¶ï¼‰ | **2-3x** |
| **ç»¼åˆæå‡** | - | - | **10-20x** |

#### 3.4.3 ä¸ºä»€ä¹ˆæ˜¯è´¨é‡60%ï¼Ÿ

| è´¨é‡ | æ–‡ä»¶å¤§å° | è§†è§‰è´¨é‡ | ç¼–ç é€Ÿåº¦ |
|------|---------|---------|---------|
| 100% | è¾ƒå¤§ | å®Œç¾ | æ…¢ |
| 80% | é€‚ä¸­ | ä¼˜ç§€ | é€‚ä¸­ |
| **60%** | **å°** | **è‰¯å¥½** | **å¿«** |
| 40% | å¾ˆå° | æ˜æ˜¾åŠ£åŒ– | å¾ˆå¿« |

**ç»“è®º**: 60%æ˜¯æ–‡ä»¶å¤§å°å’Œè§†è§‰è´¨é‡çš„æœ€ä½³å¹³è¡¡ç‚¹ï¼Œå› ä¸ºï¼š
1. YYEVAè§†é¢‘æœ¬èº«æ˜¯ç”¨äºæ¸¸æˆåŠ¨ç”»ï¼Œä¸éœ€è¦ç…§ç‰‡çº§è´¨é‡
2. FFmpegä¼šå†æ¬¡ç¼–ç ï¼ŒJPEGæŸå¤±ä¼šè¢«éƒ¨åˆ†æ©ç›–
3. åŒé€šé“æ ¼å¼å¯¹é¢œè‰²ç²¾åº¦è¦æ±‚ä¸é«˜ï¼ˆå³ä¾§æ˜¯ç°åº¦å›¾ï¼‰

### 3.5 FFmpegç¼–ç 

#### 3.5.1 ç¼–ç å‚æ•°

```javascript
const crf = Math.round(51 - (quality / 100) * 33);
// quality 100% â†’ CRF 18 (æœ€é«˜è´¨é‡)
// quality 80%  â†’ CRF 24 (é«˜è´¨é‡)
// quality 0%   â†’ CRF 51 (æœ€ä½è´¨é‡)

const ffmpegArgs = [
  '-framerate', String(fps),          // å¸§ç‡
  '-i', 'frame_%04d.jpg',              // è¾“å…¥åºåˆ—å¸§
  '-c:v', 'libx264',                   // H.264ç¼–ç 
  '-profile:v', 'high',                // High profile
  '-level', '4.0',                     // Level 4.0
  '-pix_fmt', 'yuv420p',               // Windowså…¼å®¹
  '-crf', String(crf),                 // è´¨é‡æ§åˆ¶
  '-preset', 'medium',                 // ç¼–ç é€Ÿåº¦
  '-movflags', '+faststart',           // æ”¯æŒæµå¼æ’­æ”¾
  'output.mp4'
];
```

**å‚æ•°è¯´æ˜**:

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|---|------|
| `-framerate` | ç”¨æˆ·é…ç½® | å¸§ç‡ï¼ˆ1-120fpsï¼‰ |
| `-i` | frame_%04d.jpg | è¾“å…¥æ¨¡å¼ï¼ˆframe_0000.jpg, frame_0001.jpg, ...ï¼‰ |
| `-c:v` | libx264 | ä½¿ç”¨H.264ç¼–ç å™¨ |
| `-profile:v` | high | High Profileï¼ˆæ”¯æŒæ›´å¤šç‰¹æ€§ï¼‰ |
| `-level` | 4.0 | Level 4.0ï¼ˆå…¼å®¹æ€§å¥½ï¼‰ |
| `-pix_fmt` | yuv420p | YUV420Pæ ¼å¼ï¼ˆWindows Media Playerå…¼å®¹ï¼‰ |
| `-crf` | 18-51 | æ’å®šè´¨é‡å› å­ï¼ˆæ•°å€¼è¶Šå°è´¨é‡è¶Šé«˜ï¼‰ |
| `-preset` | medium | ç¼–ç é€Ÿåº¦é¢„è®¾ï¼ˆultrafast/veryfast/fast/medium/slowï¼‰ |
| `-movflags` | +faststart | MP4å…ƒæ•°æ®å‰ç½®ï¼ˆæ”¯æŒè¾¹ä¸‹è¾¹æ’­ï¼‰ |

#### 3.5.2 éŸ³é¢‘å¤„ç†

```javascript
// æ£€æŸ¥SVGAæ˜¯å¦åŒ…å«éŸ³é¢‘
const hasAudioData = this.svgaAudioData && Object.keys(this.svgaAudioData).length > 0;

if (hasAudioData && !muted) {
  // å†™å…¥éŸ³é¢‘æ–‡ä»¶
  const audioKeys = Object.keys(this.svgaAudioData);
  const audioKey = audioKeys[0];
  const audioData = this.svgaAudioData[audioKey];
  ffmpeg.FS('writeFile', 'audio.mp3', audioData);
  
  // æ·»åŠ éŸ³é¢‘è¾“å…¥
  ffmpegArgs.push('-i', 'audio.mp3');
  
  // éŸ³é¢‘ç¼–ç å‚æ•°
  ffmpegArgs.push(
    '-c:a', 'aac',      // AACç¼–ç 
    '-b:a', '128k',     // ç ç‡128kbps
    '-shortest'         // è§†é¢‘å’ŒéŸ³é¢‘é•¿åº¦å–æœ€çŸ­
  );
} else {
  // æ— éŸ³é¢‘æˆ–é™éŸ³
  ffmpegArgs.push('-an');
}
```

#### 3.5.3 è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ

**FFmpeg.wasmä½¿ç”¨å†…å­˜è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ**:

```javascript
// å†™å…¥æ–‡ä»¶
ffmpeg.FS('writeFile', filename, uint8Array);

// è¯»å–æ–‡ä»¶
const data = ffmpeg.FS('readFile', 'output.mp4');

// åˆ é™¤æ–‡ä»¶
ffmpeg.FS('unlink', filename);
```

**å®Œæ•´æµç¨‹**:
```
1. å†™å…¥åºåˆ—å¸§:
   frame_0000.jpg
   frame_0001.jpg
   ...
   frame_NNNN.jpg

2. å†™å…¥éŸ³é¢‘ï¼ˆå¦‚æœæœ‰ï¼‰:
   audio.mp3

3. æ‰§è¡Œç¼–ç :
   await ffmpeg.run(...ffmpegArgs);

4. è¯»å–è¾“å‡º:
   const data = ffmpeg.FS('readFile', 'output.mp4');

5. æ¸…ç†æ–‡ä»¶:
   frame_*.jpg
   audio.mp3
   output.mp4
```

---

## 4. å®ç°æµç¨‹

### 4.1 å®Œæ•´æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant V as Vueç»„ä»¶
    participant S as SVGAæ’­æ”¾å™¨
    participant C as Canvas API
    participant F as FFmpeg.wasm
    
    U->>V: ç‚¹å‡»"å¼€å§‹è½¬æ¢MP4"
    V->>V: éªŒè¯é…ç½®å‚æ•°
    V->>V: ä¿å­˜é…ç½®åˆ°localStorage
    
    Note over V: é˜¶æ®µ1: åŠ è½½FFmpeg
    V->>F: loadFFmpeg()
    F->>F: åŠ¨æ€åŠ è½½è„šæœ¬
    F->>F: åŠ è½½WASMæ ¸å¿ƒ(25MB)
    F-->>V: åŠ è½½å®Œæˆ
    
    Note over V: é˜¶æ®µ2: æå–åºåˆ—å¸§
    loop éå†æ¯ä¸€å¸§
        V->>S: stepToFrame(i)
        S->>S: æ¸²æŸ“åˆ°Canvas
        V->>C: getImageData()
        C-->>V: ImageData
    end
    
    Note over V: é˜¶æ®µ3: åˆæˆåŒé€šé“
    loop éå†æ¯å¸§ImageData
        V->>V: composeDualChannel()
        V->>V: åé¢„ä¹˜Alpha
        V->>V: åˆ†ç¦»RGBå’ŒAlpha
        V->>C: putImageData()
        C-->>V: åŒé€šé“Canvas
    end
    
    Note over V: é˜¶æ®µ4: JPEGé¢„å¤„ç†+ç¼–ç 
    loop éå†åŒé€šé“Canvas
        V->>C: æ‰‹åŠ¨åˆæˆé»‘åº•
        C->>C: toBlob(JPEG, 0.6)
        C-->>V: JPEG Blob
        V->>F: FS('writeFile', frame.jpg)
    end
    
    opt æœ‰éŸ³é¢‘ä¸”æœªé™éŸ³
        V->>F: FS('writeFile', audio.mp3)
    end
    
    V->>F: run(...ffmpegArgs)
    F->>F: ç¼–ç MP4
    F-->>V: ç¼–ç å®Œæˆ
    
    V->>F: FS('readFile', output.mp4)
    F-->>V: MP4æ•°æ®
    
    Note over V: é˜¶æ®µ5: ä¸‹è½½
    V->>V: ç”ŸæˆBlob URL
    V->>U: è§¦å‘ä¸‹è½½
    
    V->>F: æ¸…ç†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
    V->>V: é‡ç½®çŠ¶æ€
```

### 4.2 é˜¶æ®µè¯¦è§£

#### é˜¶æ®µ1: åŠ è½½FFmpeg (loading)

```javascript
this.mp4ConvertStage = 'loading';
this.mp4ConvertMessage = 'æ­£åœ¨åŠ è½½è½¬æ¢å™¨...';

await this.loadFFmpeg();
```

**è€—æ—¶**: é¦–æ¬¡15-30ç§’ï¼Œåç»­<1ç§’ï¼ˆå·²ç¼“å­˜ï¼‰

**ä¼˜åŒ–**:
- ä½¿ç”¨CDNåŠ é€Ÿ
- æ˜¾ç¤º"çº¦25MBï¼Œé¦–æ¬¡åŠ è½½è¾ƒæ…¢"æç¤º
- åŠ è½½åç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½

#### é˜¶æ®µ2: æå–åºåˆ—å¸§ (extracting)

```javascript
this.mp4ConvertStage = 'extracting';
this.mp4ConvertMessage = 'æ­£åœ¨æå–åºåˆ—å¸§...';

const frames = await this.extractFrames();
```

**è€—æ—¶**: 30å¸§çº¦3ç§’ï¼Œ60å¸§çº¦6ç§’

**è¿›åº¦æ›´æ–°**:
```javascript
this.mp4ConvertProgress = Math.round((i + 1) / totalFrames * 100);
this.mp4ConvertMessage = 'æå–åºåˆ—å¸§ ' + (i + 1) + '/' + totalFrames;
```

#### é˜¶æ®µ3: åˆæˆåŒé€šé“ (composing)

```javascript
this.mp4ConvertStage = 'composing';
this.mp4ConvertMessage = 'æ­£åœ¨åˆæˆåŒé€šé“...';

const dualFrames = await this.composeDualChannelFrames(frames);
```

**è€—æ—¶**: 30å¸§çº¦1ç§’ï¼Œ60å¸§çº¦2ç§’

**è¿›åº¦æ›´æ–°**:
```javascript
this.mp4ConvertProgress = Math.round((i + 1) / frames.length * 100);
this.mp4ConvertMessage = 'åˆæˆåŒé€šé“ ' + (i + 1) + '/' + frames.length;
```

#### é˜¶æ®µ4: ç¼–ç ä¸ºMP4 (encoding)

```javascript
this.mp4ConvertStage = 'encoding';
this.mp4ConvertMessage = 'æ­£åœ¨ç¼–ç ä¸ºMP4...';

const mp4Blob = await this.encodeToMP4(dualFrames);
```

**åˆ†ä¸ºä¸¤ä¸ªå­æ­¥éª¤**:

**4.1 è½¬æ¢JPEGå¸§ (50%è¿›åº¦)**
```javascript
for (let i = 0; i < frameCount; i++) {
  // æ‰‹åŠ¨åˆæˆé»‘åº•
  // è½¬JPEG
  // å†™å…¥FFmpeg
  this.mp4ConvertProgress = Math.round((i + 1) / frameCount * 50);
  this.mp4ConvertMessage = 'è½¬æ¢JPGå¸§ ' + (i + 1) + '/' + frameCount;
}
```

**è€—æ—¶**: 30å¸§çº¦2ç§’ï¼Œ60å¸§çº¦4ç§’

**4.2 FFmpegç¼–ç  (50%-90%è¿›åº¦)**
```javascript
this.mp4ConvertMessage = 'æ­£åœ¨ç¼–ç è§†é¢‘...';
this.mp4ConvertProgress = 50;

await ffmpeg.run(...ffmpegArgs);

this.mp4ConvertProgress = 90;
```

**è€—æ—¶**: 
- å°å°ºå¯¸ï¼ˆ400x400, 30å¸§ï¼‰: 5-10ç§’
- ä¸­å°ºå¯¸ï¼ˆ800x800, 30å¸§ï¼‰: 15-30ç§’
- å¤§å°ºå¯¸ï¼ˆ1200x1200, 30å¸§ï¼‰: 30-60ç§’

#### é˜¶æ®µ5: å®Œæˆ (done)

```javascript
this.mp4ConvertStage = 'done';
this.mp4ConvertMessage = 'è½¬æ¢å®Œæˆï¼';
this.mp4ConvertProgress = 100;

this.downloadMP4(mp4Blob);
```

**ä¸‹è½½æ–‡ä»¶åæ ¼å¼**:
- å·¦å½©å³ç°: `filename_yyeva_LR.mp4`
- å·¦ç°å³å½©: `filename_yyeva_RL.mp4`

### 4.3 å–æ¶ˆæµç¨‹

```javascript
cancelMP4Conversion: function() {
  this.mp4ConvertCancelled = true;
  this.mp4ConvertMessage = 'æ­£åœ¨å–æ¶ˆ...';
}
```

**æ¯ä¸ªå¼‚æ­¥æ­¥éª¤éƒ½ä¼šæ£€æŸ¥å–æ¶ˆæ ‡å¿—**:
```javascript
if (this.mp4ConvertCancelled) {
  throw new Error('ç”¨æˆ·å–æ¶ˆè½¬æ¢');
}
```

**æ¸…ç†**:
- åœæ­¢å½“å‰æ“ä½œ
- æ¸…ç†FFmpegè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
- é‡ç½®UIçŠ¶æ€

---

## 5. ä»£ç å®ç°

### 5.1 Vueæ•°æ®ç»“æ„

```javascript
data: {
  // MP4é…ç½®
  mp4Config: {
    channelMode: 'color-left-alpha-right',  // é€šé“æ¨¡å¼
    width: 0,                               // 0è¡¨ç¤ºä½¿ç”¨åŸå§‹å®½åº¦
    height: 0,                              // 0è¡¨ç¤ºä½¿ç”¨åŸå§‹é«˜åº¦
    quality: 80,                            // å‹ç¼©è´¨é‡ 0-100
    fps: 30,                                // å¸§ç‡ 1-120
    muted: false                            // æ˜¯å¦é™éŸ³
  },
  
  // è½¬æ¢çŠ¶æ€
  isConvertingMP4: false,           // æ˜¯å¦æ­£åœ¨è½¬æ¢
  mp4ConvertProgress: 0,            // è¿›åº¦ 0-100
  mp4ConvertStage: '',              // é˜¶æ®µæ ‡è¯†
  mp4ConvertMessage: '',            // è¿›åº¦æ¶ˆæ¯
  mp4ConvertCancelled: false,       // æ˜¯å¦å·²å–æ¶ˆ
  
  // FFmpegå®ä¾‹
  ffmpeg: null,                     // FFmpegå¯¹è±¡
  ffmpegLoaded: false,              // æ˜¯å¦å·²åŠ è½½
  ffmpegLoading: false,             // æ˜¯å¦æ­£åœ¨åŠ è½½
  
  // SVGAéŸ³é¢‘æ•°æ®
  svgaAudioData: null               // ä»SVGAæå–çš„éŸ³é¢‘
}
```

### 5.2 æ ¸å¿ƒæ–¹æ³•ç­¾å

```javascript
// ä¸»æµç¨‹
async startMP4Conversion(): void

// FFmpegåŠ è½½
async loadFFmpeg(): void

// åºåˆ—å¸§æå–
async extractFrames(): Promise<ImageData[]>

// åŒé€šé“åˆæˆï¼ˆæ‰¹é‡ï¼‰
async composeDualChannelFrames(frames: ImageData[]): Promise<Canvas[]>

// åŒé€šé“åˆæˆï¼ˆå•å¸§ï¼‰
composeDualChannel(imageData: ImageData, isColorLeftAlphaRight: boolean): Canvas

// MP4ç¼–ç 
async encodeToMP4(dualFrames: Canvas[]): Promise<Blob>

// æ–‡ä»¶ä¸‹è½½
downloadMP4(blob: Blob): void

// å–æ¶ˆè½¬æ¢
cancelMP4Conversion(): void
```

### 5.3 é…ç½®éªŒè¯

```javascript
// éªŒè¯å®½é«˜ï¼ˆå¿…é¡»ä¸ºæ­£æ•´æ•°ï¼‰
const width = parseInt(this.mp4Config.width) || this.originalVideoItem.videoSize.width;
const height = parseInt(this.mp4Config.height) || this.originalVideoItem.videoSize.height;

if (width <= 0 || width > 3000 || height <= 0 || height > 3000) {
  alert('å°ºå¯¸è¶…å‡ºèŒƒå›´ï¼\n\nåˆæ³•èŒƒå›´ï¼š1-3000\nå½“å‰å€¼ï¼š' + width + 'x' + height);
  return;
}

// éªŒè¯è´¨é‡
const quality = parseInt(this.mp4Config.quality) || 80;
if (quality < 1 || quality > 100) {
  alert('å‹ç¼©è´¨é‡è¶…å‡ºèŒƒå›´ï¼\n\nåˆæ³•èŒƒå›´ï¼š1-100\nå½“å‰å€¼ï¼š' + quality);
  return;
}

// éªŒè¯å¸§ç‡
const fps = parseInt(this.mp4Config.fps) || 30;
if (fps < 1 || fps > 120) {
  alert('å¸§ç‡è¶…å‡ºèŒƒå›´ï¼\n\nåˆæ³•èŒƒå›´ï¼š1-120 fps\nå½“å‰å€¼ï¼š' + fps);
  return;
}
```

### 5.4 é…ç½®æŒä¹…åŒ–

```javascript
// ä¿å­˜åˆ°localStorage
try {
  localStorage.setItem('mp4_quality', this.mp4Config.quality);
  localStorage.setItem('mp4_fps', this.mp4Config.fps);
} catch (e) {
  // å¿½ç•¥å­˜å‚¨å¤±è´¥
}

// åŠ è½½é…ç½®ï¼ˆåœ¨mountedé’©å­ä¸­ï¼‰
mounted: function() {
  try {
    const savedQuality = localStorage.getItem('mp4_quality');
    const savedFps = localStorage.getItem('mp4_fps');
    
    if (savedQuality) {
      this.mp4Config.quality = parseInt(savedQuality);
    }
    if (savedFps) {
      this.mp4Config.fps = parseInt(savedFps);
    }
  } catch (e) {
    // å¿½ç•¥è¯»å–å¤±è´¥
  }
}
```

### 5.5 é”™è¯¯å¤„ç†

```javascript
try {
  await this.startMP4Conversion();
} catch (error) {
  if (error.message !== 'ç”¨æˆ·å–æ¶ˆè½¬æ¢') {
    console.error('MP4è½¬æ¢å¤±è´¥:', error);
    alert('è½¬æ¢å¤±è´¥ï¼š' + error.message);
  } else {
    console.log('ç”¨æˆ·å·²å–æ¶ˆMP4è½¬æ¢');
  }
} finally {
  // é‡ç½®çŠ¶æ€
  this.isConvertingMP4 = false;
  this.mp4ConvertProgress = 0;
  this.mp4ConvertStage = '';
  this.mp4ConvertMessage = '';
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ

| ä¼˜åŒ–é¡¹ | æ–¹æ³• | æ•ˆæœ |
|--------|------|------|
| **FFmpegåŠ è½½** | æ‡’åŠ è½½ + CDN + ç¼“å­˜ | é¦–æ¬¡æ…¢ï¼Œåç»­å¿« |
| **åºåˆ—å¸§æå–** | å¤ç”¨æ’­æ”¾å™¨Canvas | æ— é¢å¤–å†…å­˜ |
| **é€šé“åˆæˆ** | putImageDataé¿å…é‡ç»˜ | åƒç´ çº§ç²¾ç¡® |
| **JPEGé¢„å¤„ç†** | æ‰‹åŠ¨åˆæˆ + è´¨é‡60% | **10-20xæé€Ÿ** |
| **FFmpegç¼–ç ** | preset=medium | é€Ÿåº¦ä¸è´¨é‡å¹³è¡¡ |
| **UIå“åº”** | åˆ†æ‰¹yield + è¿›åº¦æ˜¾ç¤º | ä¸å¡é¡¿ |
| **å†…å­˜ç®¡ç†** | åŠæ—¶æ¸…ç†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ | é¿å…æ³„æ¼ |

### 6.2 é»‘åº•JPEGä¼˜åŒ–è¯¦è§£

**ä¼˜åŒ–å‰ï¼ˆPNGæ–¹æ¡ˆï¼‰**:
```javascript
// ç›´æ¥è½¬PNG
frameCanvas.toBlob(resolve, 'image/png');
```

**é—®é¢˜**:
- PNGæ–‡ä»¶å¤§ï¼ˆ~200KB/å¸§ï¼‰
- å†™å…¥FFmpegæ…¢
- ç¼–ç æ—¶é—´é•¿

**ä¼˜åŒ–åï¼ˆJPEGæ–¹æ¡ˆï¼‰**:
```javascript
// 1. æ‰‹åŠ¨åƒç´ çº§åˆæˆé»‘åº•
for (let j = 0; j < dualData.length; j += 4) {
  blackBgData[j + 0] = dualData[j + 0];  // R
  blackBgData[j + 1] = dualData[j + 1];  // G
  blackBgData[j + 2] = dualData[j + 2];  // B
  blackBgData[j + 3] = 255;              // A=255
}

// 2. è½¬JPEGï¼ˆè´¨é‡60%ï¼‰
blackBgCanvas.toBlob(resolve, 'image/jpeg', 0.6);
```

**æ•ˆæœ**:
- JPEGæ–‡ä»¶å°ï¼ˆ~20KB/å¸§ï¼‰
- å†™å…¥FFmpegå¿«
- ç¼–ç æ—¶é—´çŸ­
- **ç»¼åˆæé€Ÿ10-20å€**

**ä¸ºä»€ä¹ˆä¸ç”¨drawImageåŠ é»‘åº•ï¼Ÿ**

```javascript
// âŒ é”™è¯¯æ–¹æ³•ï¼šdrawImageä¼šåšalphaæ··åˆ
blackBgCtx.fillRect(0, 0, width, height);  // å¡«å……é»‘è‰²
blackBgCtx.drawImage(frameCanvas, 0, 0);   // åŠé€æ˜åƒç´ ä¼šä¸é»‘è‰²æ··åˆ â†’ é¢œè‰²å˜æš—
```

```javascript
// âœ… æ­£ç¡®æ–¹æ³•ï¼šæ‰‹åŠ¨åƒç´ çº§åˆæˆ
for (let j = 0; j < dualData.length; j += 4) {
  blackBgData[j + 0] = dualData[j + 0];  // ç›´æ¥ä½¿ç”¨RGB
  blackBgData[j + 1] = dualData[j + 1];  // ä¸åšalphaæ··åˆ
  blackBgData[j + 2] = dualData[j + 2];  // ä¿æŒåŸè‰²
  blackBgData[j + 3] = 255;
}
```

### 6.3 å†…å­˜ä¼˜åŒ–

**é—®é¢˜**: å¤§å°ºå¯¸åŠ¨ç”»ï¼ˆå¦‚1200x1200, 60å¸§ï¼‰ä¼šå ç”¨å¤§é‡å†…å­˜ã€‚

**ä¼˜åŒ–**:
1. **ä¸ä¿ç•™åŸå§‹å¸§**: è¾¹æå–è¾¹åˆæˆè¾¹ç¼–ç 
2. **åŠæ—¶æ¸…ç†Canvas**: ä½¿ç”¨å®Œç«‹å³ç½®null
3. **æ¸…ç†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ**: ç¼–ç å®Œæˆååˆ é™¤æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
4. **é™åˆ¶æœ€å¤§å°ºå¯¸**: é…ç½®éªŒè¯æ—¶æç¤ºç”¨æˆ·ç¼©å°å°ºå¯¸

```javascript
// æ¸…ç†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
for (let j = 0; j < frameCount; j++) {
  const fname = 'frame_' + String(j).padStart(4, '0') + '.jpg';
  try {
    ffmpeg.FS('unlink', fname);
  } catch (e) {}
}
try {
  ffmpeg.FS('unlink', 'output.mp4');
  ffmpeg.FS('unlink', 'audio.mp3');
} catch (e) {}
```

### 6.4 UIå“åº”æ€§

**é—®é¢˜**: åŒæ­¥å¾ªç¯å¤„ç†å¤§é‡å¸§ä¼šé˜»å¡UIã€‚

**è§£å†³**:
```javascript
// æ¯5å¸§yieldä¸€æ¬¡
if (i % 5 === 0) {
  await new Promise(r => setTimeout(r, 0));
}
```

**æ•ˆæœ**:
- è¿›åº¦æ¡å¹³æ»‘æ›´æ–°
- å–æ¶ˆæŒ‰é’®å¯å“åº”
- æµè§ˆå™¨ä¸ä¼š"å‡æ­»"

---

## 7. é”™è¯¯å¤„ç†

### 7.1 é”™è¯¯åˆ†ç±»

| é”™è¯¯ç±»å‹ | è§¦å‘æ¡ä»¶ | å¤„ç†æ–¹å¼ |
|---------|---------|---------|
| **é…ç½®é”™è¯¯** | å‚æ•°è¶…å‡ºèŒƒå›´ | alertæç¤ºï¼Œé˜»æ­¢æ‰§è¡Œ |
| **ç¯å¢ƒé”™è¯¯** | SharedArrayBufferä¸æ”¯æŒ | å¼•å¯¼ç”¨æˆ·ä½¿ç”¨HTTPSæˆ–ç‰¹æ®ŠæœåŠ¡å™¨ |
| **åŠ è½½é”™è¯¯** | FFmpegåŠ è½½å¤±è´¥ | æ˜¾ç¤ºç½‘ç»œé”™è¯¯ï¼Œå»ºè®®åˆ·æ–° |
| **æ’­æ”¾å™¨é”™è¯¯** | æ— æ³•è·å–Canvas | æç¤ºé‡æ–°åŠ è½½SVGA |
| **ç¼–ç é”™è¯¯** | FFmpegç¼–ç å¤±è´¥ | æ˜¾ç¤ºå…·ä½“é”™è¯¯ï¼Œå»ºè®®ç¼©å°å°ºå¯¸ |
| **éŸ³é¢‘é”™è¯¯** | éŸ³é¢‘åˆæˆå¤±è´¥ | è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­ï¼ˆé™éŸ³ï¼‰ |
| **ç”¨æˆ·å–æ¶ˆ** | ç‚¹å‡»å–æ¶ˆæŒ‰é’® | é™é»˜æ¸…ç†ï¼Œä¸æŠ¥é”™ |

### 7.2 éŸ³é¢‘é”™è¯¯å¤„ç†æµç¨‹

```mermaid
graph TD
    A[æ£€æµ‹åˆ°éŸ³é¢‘æ•°æ®] --> B{å°è¯•å†™å…¥FFmpeg}
    B -->|æˆåŠŸ| C[audioWritten=true]
    B -->|å¤±è´¥| D[audioError=é”™è¯¯æ¶ˆæ¯]
    
    D --> E{è¯¢é—®ç”¨æˆ·}
    E -->|ç»§ç»­| F[ç»§ç»­è½¬æ¢<br/>é™éŸ³è¾“å‡º]
    E -->|å–æ¶ˆ| G[æŠ›å‡ºå¼‚å¸¸<br/>ç»ˆæ­¢è½¬æ¢]
    
    C --> H{FFmpegç¼–ç }
    H -->|æˆåŠŸ| I[å®Œæˆ]
    H -->|éŸ³é¢‘é”™è¯¯| J{è¯¢é—®é‡è¯•}
    
    J -->|é‡è¯•| K[ç§»é™¤éŸ³é¢‘å‚æ•°<br/>-ané™éŸ³ç¼–ç ]
    J -->|ä¸é‡è¯•| L[æŠ›å‡ºå¼‚å¸¸]
    
    K --> M{é‡æ–°ç¼–ç }
    M -->|æˆåŠŸ| N[å®Œæˆ<br/>audioWritten=false]
    M -->|å¤±è´¥| L
```

**ä»£ç å®ç°**:
```javascript
// 1. éŸ³é¢‘å†™å…¥é˜¶æ®µ
if (hasAudioData && !muted) {
  try {
    ffmpeg.FS('writeFile', 'audio.mp3', audioData);
    audioWritten = true;
  } catch (audioErr) {
    audioError = audioErr.message;
    const continueMsg = 'éŸ³é¢‘å¤„ç†å¤±è´¥ï¼š' + audioError + '\n\næ˜¯å¦ç»§ç»­è½¬æ¢ï¼ˆç”Ÿæˆçš„MP4å°†æ²¡æœ‰å£°éŸ³ï¼‰ï¼Ÿ';
    if (!confirm(continueMsg)) {
      throw new Error('ç”¨æˆ·å–æ¶ˆè½¬æ¢');
    }
  }
}

// 2. FFmpegç¼–ç é˜¶æ®µ
try {
  await ffmpeg.run.apply(ffmpeg, ffmpegArgs);
} catch (ffmpegErr) {
  // æ£€æŸ¥æ˜¯å¦æ˜¯éŸ³é¢‘ç›¸å…³é”™è¯¯
  const errorMsg = String(ffmpegErr.message || ffmpegErr);
  if (audioWritten && (errorMsg.includes('audio') || errorMsg.includes('aac'))) {
    const retryMsg = 'éŸ³é¢‘ç¼–ç å¤±è´¥ï¼š' + errorMsg + '\n\næ˜¯å¦å°è¯•ä¸å¸¦éŸ³é¢‘é‡æ–°ç¼–ç ï¼Ÿ';
    if (confirm(retryMsg)) {
      // ç§»é™¤éŸ³é¢‘å‚æ•°ï¼Œé‡æ–°ç¼–ç 
      const retryArgs = ffmpegArgs.filter(/* è¿‡æ»¤éŸ³é¢‘å‚æ•° */);
      retryArgs.splice(outputIdx, 0, '-an');
      await ffmpeg.run.apply(ffmpeg, retryArgs);
      audioWritten = false;
    } else {
      throw ffmpegErr;
    }
  } else {
    throw ffmpegErr;
  }
}
```

### 7.3 æ¸…ç†æœºåˆ¶

**æ­£å¸¸å®Œæˆ**:
```javascript
// æ¸…ç†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
for (let j = 0; j < frameCount; j++) {
  ffmpeg.FS('unlink', 'frame_' + j.toString().padStart(4, '0') + '.jpg');
}
ffmpeg.FS('unlink', 'output.mp4');
if (audioWritten) {
  ffmpeg.FS('unlink', 'audio.mp3');
}
```

**å¼‚å¸¸ä¸­æ–­**:
```javascript
catch (error) {
  // æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ–‡ä»¶
  for (let k = 0; k < frameCount; k++) {
    try {
      ffmpeg.FS('unlink', 'frame_' + k.toString().padStart(4, '0') + '.jpg');
    } catch (e) {}
  }
  try {
    ffmpeg.FS('unlink', 'output.mp4');
    ffmpeg.FS('unlink', 'audio.mp3');
  } catch (e) {}
  
  throw error;
}
```

**finallyå—**:
```javascript
finally {
  // é‡ç½®UIçŠ¶æ€
  this.isConvertingMP4 = false;
  this.mp4ConvertProgress = 0;
  this.mp4ConvertStage = '';
  this.mp4ConvertMessage = '';
}
```

---

## 8. å…¼å®¹æ€§

### 8.1 æµè§ˆå™¨å…¼å®¹æ€§

| æµè§ˆå™¨ | ç‰ˆæœ¬ | Canvas | FFmpeg.wasm | SharedArrayBuffer | çŠ¶æ€ |
|--------|------|--------|-------------|-------------------|------|
| **Chrome** | 90+ | âœ… | âœ… | âœ… | âœ… å®Œå…¨æ”¯æŒ |
| **Edge** | 90+ | âœ… | âœ… | âœ… | âœ… å®Œå…¨æ”¯æŒ |
| **Firefox** | 88+ | âœ… | âœ… | âœ… | âœ… å®Œå…¨æ”¯æŒ |
| **Safari** | 15.2+ | âœ… | âš ï¸ | âš ï¸ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| **IE11** | - | âŒ | âŒ | âŒ | âŒ ä¸æ”¯æŒ |

**è¯´æ˜**:
- Safari 15.2+å¼€å§‹æ”¯æŒSharedArrayBufferï¼Œä½†éœ€è¦ç‰¹æ®Šé…ç½®
- FFmpeg.wasm 0.11ç‰ˆæœ¬å¯¹SharedArrayBufferçš„ä¾èµ–è¾ƒå¼±ï¼Œå¯åœ¨æ›´å¤šæµè§ˆå™¨è¿è¡Œ
- ç§»åŠ¨ç«¯æµè§ˆå™¨æ”¯æŒæƒ…å†µä¸æ¡Œé¢ç‰ˆä¸€è‡´

### 8.2 ç¯å¢ƒè¦æ±‚

| è¦æ±‚ | è¯´æ˜ | å¿…éœ€æ€§ |
|------|------|--------|
| **WebAssembly** | æ‰§è¡ŒFFmpeg | âœ… å¿…éœ€ |
| **Canvas API** | å›¾åƒå¤„ç† | âœ… å¿…éœ€ |
| **Blob API** | æ–‡ä»¶ä¸‹è½½ | âœ… å¿…éœ€ |
| **async/await** | å¼‚æ­¥æµç¨‹ | âœ… å¿…éœ€ |
| **localStorage** | é…ç½®æŒä¹…åŒ– | âš ï¸ å¯é€‰ |
| **SharedArrayBuffer** | FFmpegå¤šçº¿ç¨‹ | âš ï¸ å¯é€‰ï¼ˆ0.11ç‰ˆæœ¬ï¼‰ |

### 8.3 è·¨åŸŸéš”ç¦»é…ç½®

**é—®é¢˜**: FFmpeg.wasm 0.12ç‰ˆæœ¬è¦æ±‚SharedArrayBufferï¼Œéœ€è¦ç‰¹æ®ŠHTTPå¤´ã€‚

**è§£å†³æ–¹æ¡ˆ**:
1. **ä½¿ç”¨0.11ç‰ˆæœ¬**ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰: ä¸å¼ºåˆ¶è¦æ±‚SharedArrayBuffer
2. **é…ç½®HTTPå“åº”å¤´**ï¼ˆå¦‚æœä½¿ç”¨0.12ï¼‰:
   ```
   Cross-Origin-Opener-Policy: same-origin
   Cross-Origin-Embedder-Policy: require-corp
   ```

**æœ¬åœ°å¼€å‘**:
æä¾›`run-server.py`è„šæœ¬ï¼Œè‡ªåŠ¨æ·»åŠ è·¨åŸŸéš”ç¦»å¤´ï¼š
```python
class CORSRequestHandler(http.server.SimpleHTTPRequestHandler):
    def end_headers(self):
        self.send_header('Cross-Origin-Opener-Policy', 'same-origin')
        self.send_header('Cross-Origin-Embedder-Policy', 'require-corp')
        self.send_header('Cross-Origin-Resource-Policy', 'cross-origin')
        super().end_headers()
```

**çº¿ä¸Šéƒ¨ç½²**:
- **Vercel**: åœ¨`vercel.json`ä¸­é…ç½®headers
- **Nginx**: åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å“åº”å¤´
- **GitHub Pages**: ä½¿ç”¨`coi-serviceworker.js`ï¼ˆService Worker Polyfillï¼‰

### 8.4 æ–‡ä»¶æ ¼å¼å…¼å®¹æ€§

| æ ¼å¼ | è¾“å…¥ | è¾“å‡º | è¯´æ˜ |
|------|------|------|------|
| **SVGA** | âœ… | - | è§£æå’Œæ¸²æŸ“ |
| **MP4** | - | âœ… | H.264ç¼–ç  |
| **JPEG** | - | âœ… | ä¸­é—´æ ¼å¼ |
| **MP3** | âœ… | âœ… | éŸ³é¢‘æ ¼å¼ |

**è¾“å‡ºMP4è§„æ ¼**:
- ç¼–ç : H.264 (libx264)
- Profile: High
- Level: 4.0
- åƒç´ æ ¼å¼: YUV420P
- éŸ³é¢‘ç¼–ç : AAC (128kbps)

---

## 9. æµ‹è¯•éªŒè¯

### 9.1 åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | æµ‹è¯•ç”¨ä¾‹ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| **åŸºç¡€è½¬æ¢** | å°å°ºå¯¸SVGA (400x400, 30å¸§) | æˆåŠŸç”ŸæˆMP4 | âœ… |
| | ä¸­å°ºå¯¸SVGA (800x800, 30å¸§) | æˆåŠŸç”ŸæˆMP4 | âœ… |
| | å¤§å°ºå¯¸SVGA (1200x1200, 60å¸§) | æç¤ºæ€§èƒ½è­¦å‘Šï¼ŒæˆåŠŸç”Ÿæˆ | âœ… |
| **é€šé“æ¨¡å¼** | å·¦å½©å³ç° | å·¦ä¾§RGBï¼Œå³ä¾§ç°åº¦ | âœ… |
| | å·¦ç°å³å½© | å·¦ä¾§ç°åº¦ï¼Œå³ä¾§RGB | âœ… |
| **å°ºå¯¸è®¾ç½®** | è‡ªå®šä¹‰å®½åº¦ | æŒ‰æ¯”ä¾‹ç¼©æ”¾é«˜åº¦ | âœ… |
| | è‡ªå®šä¹‰é«˜åº¦ | æŒ‰æ¯”ä¾‹ç¼©æ”¾å®½åº¦ | âœ… |
| | é”å®šå®½é«˜æ¯” | åŒæ­¥ç¼©æ”¾ | âœ… |
| **è´¨é‡è®¾ç½®** | 100% | CRF 18ï¼Œæœ€é«˜è´¨é‡ | âœ… |
| | 80% | CRF 24ï¼Œé«˜è´¨é‡ | âœ… |
| | 60% | CRF 31ï¼Œä¸­ç­‰è´¨é‡ | âœ… |
| **å¸§ç‡è®¾ç½®** | 30fps | æ ‡å‡†å¸§ç‡ | âœ… |
| | 60fps | é«˜å¸§ç‡ | âœ… |
| | 15fps | ä½å¸§ç‡ | âœ… |
| **éŸ³é¢‘å¤„ç†** | å¸¦éŸ³é¢‘SVGA + æœªé™éŸ³ | åˆæˆéŸ³é¢‘ | âœ… |
| | å¸¦éŸ³é¢‘SVGA + é™éŸ³ | æ— éŸ³é¢‘è½¨é“ | âœ… |
| | æ— éŸ³é¢‘SVGA | æ— éŸ³é¢‘è½¨é“ | âœ… |
| **è¿›åº¦æ˜¾ç¤º** | è½¬æ¢è¿‡ç¨‹ | å®æ—¶æ›´æ–°è¿›åº¦ç™¾åˆ†æ¯” | âœ… |
| | é˜¶æ®µåˆ‡æ¢ | æ˜¾ç¤ºå½“å‰é˜¶æ®µåç§° | âœ… |
| **å–æ¶ˆæ“ä½œ** | è½¬æ¢ä¸­å–æ¶ˆ | ç«‹å³åœæ­¢ï¼Œæ¸…ç†èµ„æº | âœ… |
| **é…ç½®æŒä¹…åŒ–** | ä¿®æ”¹è´¨é‡/å¸§ç‡ | åˆ·æ–°åä¿æŒè®¾ç½® | âœ… |

### 9.2 è¾¹ç•Œæµ‹è¯•

| æµ‹è¯•é¡¹ | æµ‹è¯•ç”¨ä¾‹ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| **å‚æ•°éªŒè¯** | å®½åº¦=0 | ä½¿ç”¨åŸå§‹å®½åº¦ | âœ… |
| | å®½åº¦=3001 | æç¤ºè¶…å‡ºèŒƒå›´ | âœ… |
| | è´¨é‡=0 | æç¤ºè¶…å‡ºèŒƒå›´ | âœ… |
| | è´¨é‡=101 | æç¤ºè¶…å‡ºèŒƒå›´ | âœ… |
| | å¸§ç‡=0 | æç¤ºè¶…å‡ºèŒƒå›´ | âœ… |
| | å¸§ç‡=121 | æç¤ºè¶…å‡ºèŒƒå›´ | âœ… |
| **å¼‚å¸¸æƒ…å†µ** | æœªåŠ è½½SVGA | æç¤º"è¯·å…ˆåŠ è½½SVGAæ–‡ä»¶" | âœ… |
| | FFmpegåŠ è½½å¤±è´¥ | æç¤ºç½‘ç»œé”™è¯¯ | âœ… |
| | ç¼–ç å¤±è´¥ | æ˜¾ç¤ºå…·ä½“é”™è¯¯ | âœ… |
| | éŸ³é¢‘å†™å…¥å¤±è´¥ | è¯¢é—®æ˜¯å¦ç»§ç»­ï¼ˆé™éŸ³ï¼‰ | âœ… |
| | éŸ³é¢‘ç¼–ç å¤±è´¥ | è¯¢é—®æ˜¯å¦é‡è¯•ï¼ˆå»éŸ³é¢‘ï¼‰ | âœ… |
| **èµ„æºæ¸…ç†** | æ­£å¸¸å®Œæˆ | æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ | âœ… |
| | å¼‚å¸¸ä¸­æ–­ | æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ | âœ… |
| | ç”¨æˆ·å–æ¶ˆ | æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶ | âœ… |

### 9.3 æ€§èƒ½æµ‹è¯•

| åœºæ™¯ | å°ºå¯¸ | å¸§æ•° | è€—æ—¶ | æ–‡ä»¶å¤§å° |
|------|------|------|------|---------|
| **å°å°ºå¯¸** | 400x400 | 30 | ~15ç§’ | ~500KB |
| | 400x400 | 60 | ~30ç§’ | ~1MB |
| **ä¸­å°ºå¯¸** | 800x800 | 30 | ~40ç§’ | ~2MB |
| | 800x800 | 60 | ~80ç§’ | ~4MB |
| **å¤§å°ºå¯¸** | 1200x1200 | 30 | ~90ç§’ | ~5MB |
| | 1200x1200 | 60 | ~180ç§’ | ~10MB |

**ä¼˜åŒ–å¯¹æ¯”**ï¼ˆ800x800, 30å¸§ï¼‰:
| æ–¹æ¡ˆ | åºåˆ—å¸§æ ¼å¼ | è€—æ—¶ | æå‡ |
|------|----------|------|------|
| PNGæ–¹æ¡ˆ | PNG | ~400ç§’ | - |
| **JPEGæ–¹æ¡ˆ** | **JPEG(60%)** | **~40ç§’** | **10x** |

### 9.4 å…¼å®¹æ€§æµ‹è¯•

| æµè§ˆå™¨ | ç‰ˆæœ¬ | Windows | macOS | Linux | ç»“æœ |
|--------|------|---------|-------|-------|------|
| **Chrome** | 120+ | âœ… | âœ… | âœ… | å®Œç¾ |
| **Edge** | 120+ | âœ… | âœ… | - | å®Œç¾ |
| **Firefox** | 121+ | âœ… | âœ… | âœ… | å®Œç¾ |
| **Safari** | 17+ | - | âš ï¸ | - | éœ€æµ‹è¯• |

---

## 10. å·²çŸ¥é—®é¢˜

### 10.1 æ€§èƒ½é—®é¢˜

**é—®é¢˜1**: å¤§å°ºå¯¸åŠ¨ç”»ç¼–ç æ—¶é—´é•¿

**å½±å“**: 1200x1200ä»¥ä¸Šçš„åŠ¨ç”»å¯èƒ½éœ€è¦2-3åˆ†é’Ÿ

**ç¼“è§£æªæ–½**:
- æç¤ºç”¨æˆ·ç¼©å°å°ºå¯¸
- æ˜¾ç¤ºè¯¦ç»†è¿›åº¦å’Œé¢„ä¼°æ—¶é—´
- æ”¯æŒéšæ—¶å–æ¶ˆ

**æœªæ¥ä¼˜åŒ–**:
- è€ƒè™‘ä½¿ç”¨Web Workeré¿å…é˜»å¡ä¸»çº¿ç¨‹
- æ¢ç´¢GPUåŠ é€Ÿæ–¹æ¡ˆ

---

**é—®é¢˜2**: é¦–æ¬¡åŠ è½½FFmpegæ…¢

**å½±å“**: é¦–æ¬¡ç‚¹å‡»è½¬æ¢éœ€ç­‰å¾…15-30ç§’

**ç¼“è§£æªæ–½**:
- æ˜¾ç¤º"çº¦25MBï¼Œé¦–æ¬¡åŠ è½½è¾ƒæ…¢"æç¤º
- ä½¿ç”¨CDNåŠ é€Ÿ
- æµè§ˆå™¨ç¼“å­˜åç»­å¿«é€Ÿ

**æœªæ¥ä¼˜åŒ–**:
- é¢„åŠ è½½ç­–ç•¥ï¼ˆé¡µé¢åŠ è½½æ—¶åå°é¢„åŠ è½½ï¼‰

### 10.2 å…¼å®¹æ€§é—®é¢˜

**é—®é¢˜3**: Safariæ”¯æŒä¸å®Œå–„

**å½±å“**: Safari 15.2ä»¥ä¸‹ç‰ˆæœ¬ä¸æ”¯æŒSharedArrayBuffer

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨FFmpeg.wasm 0.11ç‰ˆæœ¬ï¼ˆä¸å¼ºåˆ¶è¦æ±‚ï¼‰
- æç¤ºç”¨æˆ·å‡çº§æµè§ˆå™¨

---

**é—®é¢˜4**: ç§»åŠ¨ç«¯æ€§èƒ½å·®

**å½±å“**: æ‰‹æœºæµè§ˆå™¨ç¼–ç é€Ÿåº¦æ…¢ï¼Œå¯èƒ½è¶…æ—¶

**ç¼“è§£æªæ–½**:
- æ£€æµ‹ç§»åŠ¨è®¾å¤‡ï¼Œæç¤ºä½¿ç”¨æ¡Œé¢ç«¯
- é™åˆ¶æœ€å¤§å°ºå¯¸

### 10.3 åŠŸèƒ½é™åˆ¶

**é—®é¢˜5**: ä¸æ”¯æŒæœåŠ¡ç«¯åŠ é€Ÿ

**å½±å“**: æ‰€æœ‰è®¡ç®—åœ¨æµè§ˆå™¨ç«¯ï¼Œå—é™äºè®¾å¤‡æ€§èƒ½

**æœªæ¥è®¡åˆ’**:
- æä¾›å¯é€‰çš„æœåŠ¡ç«¯è½¬æ¢API
- æ”¯æŒæ‰¹é‡è½¬æ¢

---

**é—®é¢˜6**: éŸ³é¢‘å¤„ç†é²æ£’æ€§

**å½±å“**: éƒ¨åˆ†SVGAéŸ³é¢‘æ ¼å¼å¯èƒ½ä¸å…¼å®¹

**ç¼“è§£æªæ–½**:
- å¤šå±‚é”™è¯¯æ•è·
- éŸ³é¢‘å¤±è´¥æ—¶é™çº§ä¸ºé™éŸ³
- æ˜ç¡®æç¤ºç”¨æˆ·

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

1. **FFmpeg.wasmå®˜æ–¹æ–‡æ¡£**: https://github.com/ffmpegwasm/ffmpeg.wasm
2. **SVGAæ ¼å¼è§„èŒƒ**: https://github.com/svga/SVGAPlayer-Web
3. **Canvas APIæ–‡æ¡£**: https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API
4. **H.264ç¼–ç å‚æ•°**: https://trac.ffmpeg.org/wiki/Encode/H.264
5. **YYEVAæ ¼å¼è¯´æ˜**: https://github.com/yylive/YYEVA

### B. æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| **åŒé€šé“è§†é¢‘** | Dual Channel Video | å½©è‰²é€šé“å’ŒAlphaé€šé“å¹¶æ’çš„è§†é¢‘æ ¼å¼ |
| **YYEVA** | YY Effect Video Animation | YYç›´æ’­å¼€æºçš„é€æ˜è§†é¢‘æ ¼å¼ |
| **CRF** | Constant Rate Factor | æ’å®šè´¨é‡å› å­ï¼ŒH.264ç¼–ç è´¨é‡å‚æ•° |
| **é¢„ä¹˜Alpha** | Premultiplied Alpha | RGBå€¼å·²ä¹˜ä»¥Alphaçš„å­˜å‚¨æ ¼å¼ |
| **åé¢„ä¹˜** | Unpremultiply | æ¢å¤åŸå§‹RGBå€¼çš„ç®—æ³• |
| **è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ** | Virtual File System | FFmpeg.wasmä½¿ç”¨çš„å†…å­˜æ–‡ä»¶ç³»ç»Ÿ |
| **è·¨åŸŸéš”ç¦»** | Cross-Origin Isolation | å¯ç”¨SharedArrayBufferçš„å®‰å…¨æœºåˆ¶ |

### C. é…ç½®ç¤ºä¾‹

**é»˜è®¤é…ç½®**:
```javascript
{
  channelMode: 'color-left-alpha-right',
  width: 0,           // ä½¿ç”¨åŸå§‹å®½åº¦
  height: 0,          // ä½¿ç”¨åŸå§‹é«˜åº¦
  quality: 80,        // CRF 24
  fps: 30,
  muted: false
}
```

**é«˜è´¨é‡é…ç½®**:
```javascript
{
  channelMode: 'color-left-alpha-right',
  width: 1920,
  height: 1080,
  quality: 100,       // CRF 18
  fps: 60,
  muted: false
}
```

**å¿«é€Ÿè½¬æ¢é…ç½®**:
```javascript
{
  channelMode: 'color-left-alpha-right',
  width: 800,
  height: 800,
  quality: 60,        // CRF 31
  fps: 24,
  muted: true
}
```

### D. FAQ

**Q1: ä¸ºä»€ä¹ˆé¦–æ¬¡è½¬æ¢å¾ˆæ…¢ï¼Ÿ**

A: é¦–æ¬¡éœ€è¦ä¸‹è½½FFmpeg.wasmï¼ˆçº¦25MBï¼‰ï¼Œåç»­ä¼šç¼“å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œé€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚

---

**Q2: è½¬æ¢çš„MP4æ–‡ä»¶å¾ˆå¤§æ€ä¹ˆåŠï¼Ÿ**

A: 
1. é™ä½è´¨é‡å‚æ•°ï¼ˆ80% â†’ 60%ï¼‰
2. é™ä½å¸§ç‡ï¼ˆ30fps â†’ 24fpsï¼‰
3. ç¼©å°è¾“å‡ºå°ºå¯¸

---

**Q3: ä¸ºä»€ä¹ˆéŸ³é¢‘æ²¡æœ‰åˆæˆè¿›å»ï¼Ÿ**

A: å¯èƒ½åŸå› ï¼š
1. SVGAæ–‡ä»¶æœ¬èº«ä¸åŒ…å«éŸ³é¢‘
2. å‹¾é€‰äº†"é™éŸ³"é€‰é¡¹
3. éŸ³é¢‘æ ¼å¼ä¸å…¼å®¹ï¼ˆä¼šæç¤ºæ˜¯å¦ç»§ç»­ï¼‰

---

**Q4: èƒ½å¦æ‰¹é‡è½¬æ¢ï¼Ÿ**

A: å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒæ‰¹é‡è½¬æ¢ï¼Œéœ€è¦é€ä¸ªæ–‡ä»¶æ“ä½œã€‚æœªæ¥ç‰ˆæœ¬ä¼šè€ƒè™‘æ·»åŠ æ­¤åŠŸèƒ½ã€‚

---

**Q5: è½¬æ¢åçš„MP4å¦‚ä½•ä½¿ç”¨ï¼Ÿ**

A: 
1. ä½¿ç”¨YYEVAæ’­æ”¾å™¨è§£æå’Œæ¸²æŸ“
2. è‡ªè¡Œè§£æå·¦å³é€šé“ï¼Œå®ç°é€æ˜æ•ˆæœ
3. å‚è€ƒdemo-yyeva-format.htmlç¤ºä¾‹ä»£ç 

---

**Q6: Safariæµè§ˆå™¨ä¸æ”¯æŒæ€ä¹ˆåŠï¼Ÿ**

A: 
1. ä½¿ç”¨Chromeæˆ–Firefoxæµè§ˆå™¨
2. å‡çº§Safariåˆ°15.2+ç‰ˆæœ¬
3. ä½¿ç”¨æ¡Œé¢ç«¯æµè§ˆå™¨ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰

---

**Q7: è½¬æ¢è¿‡ç¨‹ä¸­å¯ä»¥åšå…¶ä»–æ“ä½œå—ï¼Ÿ**

A: å»ºè®®ä¸è¦åˆ‡æ¢æ ‡ç­¾é¡µæˆ–æœ€å°åŒ–æµè§ˆå™¨ï¼Œå¯èƒ½å¯¼è‡´è½¬æ¢å˜æ…¢æˆ–å¤±è´¥ã€‚å¯ä»¥ç‚¹å‡»"å–æ¶ˆ"æŒ‰é’®éšæ—¶ç»ˆæ­¢ã€‚

---

**Q8: ä¸ºä»€ä¹ˆè½¬æ¢åé¢œè‰²å’Œé¢„è§ˆä¸ä¸€æ ·ï¼Ÿ**

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ˜¯å¦æ­£ç¡®è§£æåŒé€šé“ï¼ˆå·¦å³åˆ†ç¦»ï¼‰
2. æ˜¯å¦æ­£ç¡®æ··åˆRGBå’ŒAlpha
3. æ’­æ”¾å™¨æ˜¯å¦æ”¯æŒåŠé€æ˜æ¸²æŸ“

---

**Q9: å·¦å½©å³ç°å’Œå·¦ç°å³å½©æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

A: åªæ˜¯å¸ƒå±€ä¸åŒï¼Œå®é™…æ•ˆæœå®Œå…¨ä¸€æ ·ã€‚é€‰æ‹©ä¸æ’­æ”¾å™¨è¦æ±‚ä¸€è‡´çš„æ ¼å¼å³å¯ã€‚

---

**Q10: å¦‚ä½•éªŒè¯è½¬æ¢æ˜¯å¦æ­£ç¡®ï¼Ÿ**

A: 
1. ç”¨è§†é¢‘æ’­æ”¾å™¨æ‰“å¼€ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯åŒå€å®½åº¦
2. å·¦ä¾§åº”è¯¥æ˜¯å½©è‰²ç”»é¢
3. å³ä¾§åº”è¯¥æ˜¯é»‘ç™½ç°åº¦å›¾ï¼ˆAlphaé€šé“ï¼‰
4. ä½¿ç”¨YYEVAæ’­æ”¾å™¨æµ‹è¯•æœ€ç»ˆæ•ˆæœ

---

### E. ç‰ˆæœ¬å†å²

**v1.0 (2025-12-18)**
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ”¯æŒåŒé€šé“åˆæˆ
- âœ… é›†æˆFFmpeg.wasm 0.11
- âœ… æ”¯æŒéŸ³é¢‘åˆæˆ
- âœ… é»‘åº•JPEGä¼˜åŒ–
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¿›åº¦æ˜¾ç¤ºå’Œå–æ¶ˆåŠŸèƒ½

**è®¡åˆ’åŠŸèƒ½**:
- â³ Web Workerå¤šçº¿ç¨‹åŠ é€Ÿ
- â³ æ‰¹é‡è½¬æ¢æ”¯æŒ
- â³ æœåŠ¡ç«¯è½¬æ¢API
- â³ é¢„è®¾é…ç½®æ¨¡æ¿
- â³ è½¬æ¢å†å²è®°å½•

---

### F. è´¡çŒ®æŒ‡å—

å¦‚éœ€æ”¹è¿›æ­¤åŠŸèƒ½ï¼Œè¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. **ä»£ç ä½ç½®**: `docs/app.js` 2700-3300è¡Œ
2. **æµ‹è¯•æ–‡ä»¶**: `demo-yyeva-format.html`
3. **æ–‡æ¡£æ›´æ–°**: ä¿®æ”¹`TECH-RESEARCH.md`å’Œæœ¬æ–‡æ¡£
4. **æäº¤å‰æ£€æŸ¥**:
   - âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
   - âœ… ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
   - âœ… æ›´æ–°ç›¸å…³æ–‡æ¡£
   - âœ… æ·»åŠ å¿…è¦æ³¨é‡Š

---

## æ€»ç»“

æœ¬æŠ€æœ¯æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†SVGAè½¬MP4åŠŸèƒ½çš„å®Œæ•´å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

âœ… **æŠ€æœ¯æ¶æ„**: Vue + Canvas + FFmpeg.wasmçš„ä¸‰å±‚æ¶æ„  
âœ… **æ ¸å¿ƒç®—æ³•**: åé¢„ä¹˜Alphaã€åŒé€šé“åˆæˆã€é»‘åº•JPEGä¼˜åŒ–  
âœ… **æ€§èƒ½ä¼˜åŒ–**: 10-20å€ç¼–ç é€Ÿåº¦æå‡  
âœ… **é”™è¯¯å¤„ç†**: å¤šå±‚æ•è·å’Œç”¨æˆ·å‹å¥½æç¤º  
âœ… **å…¼å®¹æ€§**: æ”¯æŒä¸»æµç°ä»£æµè§ˆå™¨  

è¯¥åŠŸèƒ½å·²åœ¨ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œï¼Œä¸ºç”¨æˆ·æä¾›äº†é«˜æ•ˆã€ä¾¿æ·çš„SVGAåˆ°YYEVA-MP4æ ¼å¼è½¬æ¢æœåŠ¡ã€‚

---

**æ–‡æ¡£ç»“æŸ**