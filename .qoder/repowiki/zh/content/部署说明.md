# 部署说明

<cite>
**本文引用的文件**
- [deploy.ps1](file://deploy.ps1)
- [run-deploy.ps1](file://run-deploy.ps1)
- [env-check.ps1](file://env-check.ps1)
- [package.json](file://package.json)
- [CNAME](file://CNAME)
</cite>

## 更新摘要
**变更内容**
- 新增对自动化部署脚本 `deploy.ps1` 的详细说明，明确其功能为校验分支状态、检查工作区、同步 `docs/` 内容至 `gh-pages` 分支并推送，强调该脚本不再执行自动构建。
- 更新“核心组件”与“详细组件分析”章节，准确反映 `deploy.ps1` 的职责变更。
- 更新“故障排除指南”与“部署前检查清单”，以匹配当前需手动构建的流程。
- 移除关于自动构建和交互式预览的过时描述。

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能与稳定性考量](#性能与稳定性考量)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文档面向需要在 Windows PowerShell 环境下自动化部署 VuePress 文档站点的用户，系统性地梳理从构建到发布的完整流程。重点解析以下脚本与文件的作用：
- 自动化部署脚本：deploy.ps1、run-deploy.ps1
- 环境检查脚本：env-check.ps1
- 构建配置：package.json
- 自定义域名文件：CNAME

目标是帮助用户安全、可重复地完成“手动构建 → 发布到 gh-pages”的全流程，并提供部署前检查清单与常见问题排查方法。

## 项目结构
该仓库采用“根目录 + docs 输出目录”的典型 VuePress 结构：
- 根目录包含部署与开发辅助脚本、项目配置与自定义域名文件
- docs 目录为 VuePress 构建输出的静态站点资源
- CNAME 文件用于 GitHub Pages 绑定自定义域名

```mermaid
graph TB
A["根目录"] --> B["docs/ 静态站点输出"]
A --> C["deploy.ps1 自动化部署脚本"]
A --> D["run-deploy.ps1 包装器"]
A --> E["env-check.ps1 环境检查"]
A --> F["package.json 构建脚本与依赖"]
A --> G["CNAME 自定义域名"]
```

**图表来源**
- [deploy.ps1](file://deploy.ps1#L1-L147)
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- [env-check.ps1](file://env-check.ps1#L1-L103)
- [package.json](file://package.json#L1-L19)
- [CNAME](file://CNAME#L1-L1)

**章节来源**
- [package.json](file://package.json#L1-L19)

## 核心组件
- **自动化部署脚本 deploy.ps1**
  - 功能：校验当前分支是否为 main 且工作区干净，检查 `docs/` 目录是否存在，切换到 gh-pages 分支，清理根目录（保留 CNAME 等），复制 `docs/` 内容，提交并推送，最后切回 main 分支。**不执行构建**。
- **包装器 run-deploy.ps1**
  - 功能：以绕过执行策略的方式调用 `deploy.ps1`，便于双击运行。
- **环境检查 env-check.ps1**
  - 功能：检测 Node.js、npm 等工具是否可用，读取 `package.json` 信息，并检查本地依赖（如 node_modules）状态。
- **构建配置 package.json**
  - 功能：定义 `dev` 和 `build` 脚本，驱动 VuePress 构建与开发。
- **自定义域名 CNAME**
  - 功能：GitHub Pages 识别该文件以绑定自定义域名。

**章节来源**
- [deploy.ps1](file://deploy.ps1#L1-L147)
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- [env-check.ps1](file://env-check.ps1#L1-L103)
- [package.json](file://package.json#L1-L19)
- [CNAME](file://CNAME#L1-L1)

## 架构总览
下图展示了从本地构建到 GitHub Pages 发布的整体流程。**请注意，`deploy.ps1` 不执行 `npm run build`，用户必须预先手动构建。**

```mermaid
sequenceDiagram
participant Dev as "开发者"
participant RD as "run-deploy.ps1"
participant DP as "deploy.ps1"
participant Git as "Git 仓库"
participant GH as "GitHub Pages(gh-pages)"
Dev->>RD : 双击运行包装器
RD->>DP : 以绕过执行策略方式调用
DP->>Git : 检查当前分支(main)与工作区状态
Note right of DP : 脚本不执行构建
DP->>Git : 切换到 gh-pages 分支
DP->>Git : 清理 gh-pages 根目录(保留 CNAME)
DP->>Git : 复制 docs/ 内容到 gh-pages 根
DP->>Git : 添加、提交、推送 gh-pages
DP->>Git : 切回 main 分支
DP-->>Dev : 输出部署完成提示
```

**图表来源**
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- [deploy.ps1](file://deploy.ps1#L1-L147)

## 详细组件分析

### 自动化部署脚本 deploy.ps1
- **分支与工作区校验**
  - 强制要求当前位于 main 分支，且工作区干净（无未提交更改），防止误部署。
- **构建阶段检查**
  - **不执行** `npm run build`。脚本会检查 `docs/` 目录是否存在，若不存在则提示用户先运行 `npm run build`。
- **部署到 gh-pages**
  - 切换到 gh-pages 分支，清理根目录（保留 CNAME、README.md 等）。
  - 将 `main` 分支的 `docs/` 目录内容复制到 `gh-pages` 分支的根目录。
  - 执行 `git add`、`commit`、`push` 推送至远程；最后切回 `main` 分支。

```mermaid
flowchart TD
Start(["开始"]) --> CheckBranch["检查当前分支是否为 main"]
CheckBranch --> BranchOK{"分支正确？"}
BranchOK --> |否| ExitErr1["退出并提示切换到 main"]
BranchOK --> |是| CheckDocs["检查 docs/ 目录是否存在"]
CheckDocs --> DocsOK{"docs/ 存在？"}
DocsOK --> |否| ExitErr2["退出并提示运行 'npm run build'"]
DocsOK --> |是| CheckClean["检查工作区是否干净"]
CheckClean --> CleanOK{"无未提交更改？"}
CleanOK --> |否| ExitErr3["退出并提示先提交或丢弃更改"]
CleanOK --> |是| Checkout["切换到 gh-pages 分支"]
Checkout --> CleanGH["清理 gh-pages 根目录(保留 CNAME 等)"]
CleanGH --> CopyDocs["复制 docs/ 内容到 gh-pages 根"]
CopyDocs --> CommitPush["git add/commit/push gh-pages"]
CommitPush --> SwitchBack["切回 main 分支"]
SwitchBack --> Done(["完成"])
```

**图表来源**
- [deploy.ps1](file://deploy.ps1#L1-L147)

**章节来源**
- [deploy.ps1](file://deploy.ps1#L1-L147)

### 包装器 run-deploy.ps1
- 作用：确保在项目根目录找到 `deploy.ps1` 后，以绕过执行策略的方式运行，降低权限限制带来的阻塞。
- 实现：使用 `powershell -ExecutionPolicy Bypass` 调用 `deploy.ps1`。

**章节来源**
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)

### 环境检查 env-check.ps1
- 工具链检测：Node.js、npm、winget、yarn、pnpm。
- 项目信息：读取 `package.json` 中的 name、scripts、devDependencies、dependencies。
- 本地依赖：检查 `node_modules` 与本地 vuepress 版本是否存在。
- 下一步建议：缺失工具或依赖时给出安装指引。

**章节来源**
- [env-check.ps1](file://env-check.ps1#L1-L103)
- [package.json](file://package.json#L1-L19)

### 构建配置 package.json
- `scripts.dev` 与 `scripts.build`：分别对应 VuePress 开发与构建命令。
- 依赖：`devDependencies` 包含 VuePress，`dependencies` 包含 element-ui。
- 用途：被 `deploy.ps1` 与 `run-dev.ps1` 调用。

**章节来源**
- [package.json](file://package.json#L1-L19)

### 自定义域名 CNAME
- 位置：根目录。
- 作用：GitHub Pages 识别该文件作为自定义域名标识。
- 注意：部署完成后需在 GitHub Pages 设置中启用自定义域名并配置 DNS。

**章节来源**
- [CNAME](file://CNAME#L1-L1)

## 依赖关系分析
- 脚本耦合
  - `run-deploy.ps1` 依赖 `deploy.ps1` 存在。
  - `deploy.ps1` 依赖 Git 命令与 `docs/` 目录（由 `npm run build` 生成）。
- 外部依赖
  - Node.js/npm
  - Git
  - GitHub 远程仓库（origin）

```mermaid
graph LR
RD["run-deploy.ps1"] --> DP["deploy.ps1"]
DP --> GIT["Git 命令"]
DP --> DOCS["docs/ 目录 (由 npm run build 生成)"]
RD --> PKG["package.json"]
DP --> CNAME["CNAME 文件"]
```

**图表来源**
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- [deploy.ps1](file://deploy.ps1#L1-L147)
- [package.json](file://package.json#L1-L19)
- [CNAME](file://CNAME#L1-L1)

**章节来源**
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- [deploy.ps1](file://deploy.ps1#L1-L147)
- [package.json](file://package.json#L1-L19)

## 性能与稳定性考量
- 构建时间优化
  - 保持 `node_modules` 稳定，避免重复安装。
  - 在网络受限环境下，可考虑使用 npm 镜像源加速。
- 部署稳定性
  - 严格的工作区状态检查可避免误推脏数据。
  - 部署前导出 `docs/` 再覆盖 `gh-pages` 根目录，减少不必要的文件变更。
- 可靠性建议
  - 使用包装器 `run-deploy.ps1` 降低执行策略对部署的影响。

## 故障排除指南
- **权限问题（无法执行脚本）**
  - 现象：双击 `run-deploy.ps1` 无响应或报错。
  - 处理：使用 `run-deploy.ps1` 包装器运行；若仍失败，检查 PowerShell 执行策略。
  - 参考路径：[run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- **Git 分支或状态不符**
  - 现象：脚本报错提示不在 main 分支或工作区不干净。
  - 处理：切换到 main 并提交/丢弃未提交更改后再运行。
  - 参考路径：[deploy.ps1](file://deploy.ps1#L24-L35)
- **构建失败或 docs 目录缺失**
  - 现象：`deploy.ps1` 报错提示 'docs' 目录未找到。
  - 处理：**在运行 `deploy.ps1` 之前，手动执行 `npm run build`**。查看构建输出；使用 `env-check.ps1` 检查 Node/npm 状态。
  - 参考路径：[deploy.ps1](file://deploy.ps1#L38-L41)、[package.json](file://package.json#L7-L8)、[env-check.ps1](file://env-check.ps1#L1-L103)
- **无法切换到 gh-pages 分支**
  - 现象：提示 gh-pages 不存在。
  - 处理：在本地创建并关联远程 gh-pages 分支，或在 GitHub 上启用 Pages。
  - 参考路径：[deploy.ps1](file://deploy.ps1#L78-L89)
- **推送失败（网络/凭据）**
  - 现象：`git push origin gh-pages` 失败。
  - 处理：检查网络连通性、SSH/Git 凭据；必要时改用 HTTPS 并输入凭据。
  - 参考路径：[deploy.ps1](file://deploy.ps1#L127-L133)
- **自定义域名未生效**
  - 现象：访问自定义域名 404 或未绑定。
  - 处理：确认 CNAME 文件内容正确；在 GitHub Pages 设置中启用自定义域名并配置 DNS。
  - 参考路径：[CNAME](file://CNAME#L1-L1)

**章节来源**
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- [deploy.ps1](file://deploy.ps1#L12-L147)
- [env-check.ps1](file://env-check.ps1#L1-L103)
- [CNAME](file://CNAME#L1-L1)

## 结论
通过 `deploy.ps1`、`run-deploy.ps1`、`env-check.ps1` 与 `package.json` 的协同，本项目实现了从构建到发布的自动化流程。**`deploy.ps1` 脚本的职责已明确分离，不再负责构建，而是专注于将已构建的静态文件部署到 gh-pages 分支**。结合 CNAME 文件，可实现稳定的 GitHub Pages 自定义域名发布。建议在每次部署前使用 `env-check.ps1` 进行环境核验，并遵循部署前检查清单，以提升成功率与可重复性。

## 附录

### 部署前检查清单
- **环境依赖**
  - Node.js 与 npm 可用，版本满足要求。
  - `package.json` 存在且包含 dev/build 脚本。
  - 本地已安装依赖（`node_modules` 存在）。
- **Git 配置**
  - 当前位于 main 分支。
  - 工作区干净（无未提交更改）。
  - 已配置并可访问远程 origin。
- **构建状态**
  - **已手动执行 `npm run build`，`docs/` 目录存在且内容正确**。
- **分支状态**
  - gh-pages 分支存在（本地或远程）。
- **自定义域名**
  - CNAME 文件存在且内容正确。
  - GitHub Pages 设置中已启用自定义域名。

**章节来源**
- [env-check.ps1](file://env-check.ps1#L1-L103)
- [deploy.ps1](file://deploy.ps1#L24-L61)
- [package.json](file://package.json#L1-L19)
- [CNAME](file://CNAME#L1-L1)

### 关键流程时序（部署到 gh-pages）
```mermaid
sequenceDiagram
participant U as "用户"
participant RD as "run-deploy.ps1"
participant DP as "deploy.ps1"
participant G as "Git"
participant R as "远程(origin)"
U->>U : 手动执行 : npm run build
U->>RD : 运行包装器
RD->>DP : 调用部署脚本
DP->>G : 校验分支与工作区
Note right of DP : 脚本不执行构建
DP->>G : 切换到 gh-pages
DP->>G : 清理 gh-pages 根目录
DP->>G : 复制 docs/ 内容
DP->>G : add/commit
DP->>R : push gh-pages
DP->>G : 切回 main
DP-->>U : 输出完成
```

**图表来源**
- [run-deploy.ps1](file://run-deploy.ps1#L1-L15)
- [deploy.ps1](file://deploy.ps1#L78-L147)