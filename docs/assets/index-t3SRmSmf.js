const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/optimise-DFzGu67M.js","assets/styles-DSudpaKl.css"])))=>i.map(i=>d[i]);
/* empty css               */!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}(),
/*! coi-serviceworker v0.2.0 - Simplified version */
/*! Enables SharedArrayBuffer for GitHub Pages */
"undefined"==typeof window?(self.addEventListener("install",e=>{console.log("[COI SW] Installing new version..."),self.skipWaiting()}),self.addEventListener("activate",e=>{console.log("[COI SW] Activating new version..."),e.waitUntil(self.clients.claim().then(()=>self.clients.matchAll({type:"window"}).then(e=>{e.forEach(e=>{console.log("[COI SW] Reloading client:",e.url),e.navigate(e.url)})})))}),self.addEventListener("fetch",e=>{const t=e.request,i=new URL(t.url);"only-if-cached"===t.cache&&"same-origin"!==t.mode||"wind.hlgdata.com"===i.hostname||i.hostname.includes("jsdelivr.net")||i.hostname.includes("unpkg.com")||i.hostname.includes("cdnjs.cloudflare.com")||e.respondWith(fetch(t).then(e=>{if("navigate"===t.mode||"document"===t.destination){const t=new Headers(e.headers);return t.set("Cross-Origin-Opener-Policy","same-origin"),t.set("Cross-Origin-Embedder-Policy","credentialless"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}return e}).catch(e=>(console.error("[COI SW] Fetch failed:",e),new Response("Network error",{status:500}))))})):function(){if("undefined"!=typeof window&&window.crossOriginIsolated)return void console.log("[COI] Already cross-origin isolated");if(!navigator.serviceWorker)return void console.warn("[COI] Service Worker not supported");if("yes"===sessionStorage.getItem("coi_reloaded"))return sessionStorage.removeItem("coi_reloaded"),void console.log("[COI] Reloaded, Service Worker should be active now");const e=document.currentScript?document.currentScript.src:window.location.origin+"/coi-serviceworker.js",t=()=>{navigator.serviceWorker.register(e).then(e=>{console.log("[COI] Service Worker registered:",e.scope);const t=()=>navigator.serviceWorker.controller?"undefined"!=typeof SharedArrayBuffer?void console.log("[COI] Service Worker active and SharedArrayBuffer available"):(console.log("[COI] Service Worker active but SharedArrayBuffer not available, reloading..."),sessionStorage.setItem("coi_reloaded","yes"),void window.location.reload()):e.active?(console.log("[COI] Service Worker activated, reloading to take control..."),sessionStorage.setItem("coi_reloaded","yes"),void window.location.reload()):void setTimeout(t,500);t(),e.addEventListener("updatefound",()=>{const t=e.installing;t&&t.addEventListener("statechange",()=>{"activated"===t.state&&(console.log("[COI] New Service Worker activated, reloading..."),sessionStorage.setItem("coi_reloaded","yes"),window.location.reload())})})}).catch(e=>{console.error("[COI] Service Worker registration failed:",e)})};"loading"===document.readyState||"interactive"===document.readyState?window.addEventListener("load",t):t()}(),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={vue:{name:"Vue.js",url:"assets/js/lib/vue.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js","https://unpkg.com/vue@2.7.14/dist/vue.min.js","https://cdnjs.cloudflare.com/ajax/libs/vue/2.7.14/vue.min.js"],checkFn:function(){return"undefined"!=typeof Vue},priority:0},oxipng:{name:"oxipng",url:"assets/js/service/oxipng/codec/pkg/squoosh_oxipng_bg.wasm",checkFn:function(){return void 0!==e.MeeWoo&&void 0!==e.MeeWoo.Services&&void 0!==e.MeeWoo.Services.ImageCompressionService&&e.MeeWoo.Services.ImageCompressionService.isOxipngReady()},priority:25,disabled:!0},svgaplayer:{name:"SVGA Player",url:"assets/js/lib/svga.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/svgaplayerweb@2.3.1/build/svga.min.js","https://unpkg.com/svgaplayerweb@2.3.1/build/svga.min.js"],checkFn:function(){return"undefined"!=typeof SVGA&&SVGA.Player},priority:1},lottie:{name:"Lottie",url:"assets/js/lib/lottie.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/lottie-web@5.12.2/build/player/lottie.min.js","https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js","https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"],checkFn:function(){return"undefined"!=typeof lottie},priority:5},howler:{name:"Howler.js",url:"assets/js/lib/howler.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"],checkFn:function(){return"undefined"!=typeof Howl},priority:6},marked:{name:"Marked",url:"assets/js/lib/marked.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"],checkFn:function(){return"undefined"!=typeof marked},priority:20},gif:{name:"GIF.js",url:"assets/js/lib/gif.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"],checkFn:function(){return"undefined"!=typeof GIF},priority:15},protobuf:{name:"Protobuf.js",url:"assets/js/lib/protobuf.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"],checkFn:function(){return"undefined"!=typeof protobuf},priority:25},pako:{name:"Pako",url:"assets/js/lib/pako.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"],checkFn:function(){return"undefined"!=typeof pako},priority:25},jszip:{name:"JSZip",url:"assets/js/lib/jszip.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"],checkFn:function(){return"undefined"!=typeof JSZip},priority:25},pngquant:{name:"PNG Compressor (Pako)",url:"assets/js/lib/pako.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js","https://unpkg.com/pako@2.1.0/dist/pako.min.js","https://cdn.jsdelivr.net/npm/pako@2.0.4/dist/pako.min.js","https://unpkg.com/pako@2.0.4/dist/pako.min.js"],checkFn:function(){return"undefined"!=typeof pako},priority:26,disabled:!0},svgaweb:{name:"SVGA-Web",url:"https://cdn.jsdelivr.net/npm/svga-web@2.4.2/svga-web.min.js",checkFn:function(){return"undefined"!=typeof SVGA&&SVGA.Downloader},priority:25,disabled:!0},ffmpeg:{name:"FFmpeg",url:"https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js",checkFn:function(){return"undefined"!=typeof FFmpeg},priority:30},html2canvas:{name:"html2canvas",url:"assets/js/lib/html2canvas.min.js",fallbackUrls:["https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"],checkFn:function(){return"undefined"!=typeof html2canvas},priority:25},konva:{name:"Konva",url:"assets/js/lib/konva.min.js",fallbackUrls:["https://cdn.jsdelivr.net/npm/konva@9.3.6/konva.min.js","https://unpkg.com/konva@9.3.6/konva.min.js","https://cdnjs.cloudflare.com/ajax/libs/konva/9.3.6/konva.min.js"],checkFn:function(){return"undefined"!=typeof Konva},priority:10}};function i(){this.queue=[],this.loading=!1,this.currentLib=null,this.loadedLibs={},this.listeners=[]}i.prototype.onProgress=function(e){"function"==typeof e&&this.listeners.push(e)},i.prototype.notifyProgress=function(){var e=this.currentLib;this.listeners.forEach(function(t){try{t(e)}catch(i){}})},i.prototype.loadSingleLibrary=function(e,i){var a=this,o=t[e];if(!o)return Promise.reject(new Error("未知的库: "+e));if(this.loadedLibs[e]||o.checkFn&&o.checkFn())return this.loadedLibs[e]=!0,Promise.resolve();var n=[o.url];o.fallbackUrls&&o.fallbackUrls.length>0&&(n=n.concat(o.fallbackUrls));var r=function(t){if(t>=n.length)return Promise.reject(new Error("所有CDN都加载失败: "+e));var i=n[t];return"import"===o.loadMethod?new Promise(function(t,n){a.currentLib={name:o.name,url:i,progress:0},a.notifyProgress();var r=document.createElement("script");r.type="module",r.src=i,r.onload=function(){a.currentLib.progress=50,a.notifyProgress();var i=30,r=function(){if(!o.checkFn||o.checkFn())a.currentLib.progress=100,a.notifyProgress(),setTimeout(function(){a.currentLib=null,a.loadedLibs[e]=!0,a.notifyProgress(),t()},300);else if(i-- >0){var s=50+1.5*(30-i);a.currentLib.progress=Math.min(99,Math.round(s)),a.notifyProgress(),setTimeout(r,100)}else a.currentLib=null,a.notifyProgress(),n(new Error("库加载超时: "+e))};r()},r.onerror=function(){a.currentLib=null,a.notifyProgress(),n(new Error("加载失败: "+i))},document.head.appendChild(r)}).catch(function(e){return o.fallbackUrls&&o.fallbackUrls.length>0&&t<n.length-1?r(t+1):Promise.reject(e)}):new Promise(function(t,n){a.currentLib={name:o.name,url:i,progress:0},a.notifyProgress();var r=document.createElement("script");r.src=i,r.onload=function(){a.currentLib.progress=50,a.notifyProgress();var i=30,r=function(){if(!o.checkFn||o.checkFn())a.currentLib.progress=100,a.notifyProgress(),setTimeout(function(){a.currentLib=null,a.loadedLibs[e]=!0,a.notifyProgress(),t()},300);else if(i-- >0){var s=50+1.5*(30-i);a.currentLib.progress=Math.min(99,Math.round(s)),a.notifyProgress(),setTimeout(r,100)}else a.currentLib=null,a.notifyProgress(),n(new Error("库加载超时: "+e))};r()},r.onerror=function(){a.currentLib=null,a.notifyProgress(),n(new Error("加载失败: "+i))},document.head.appendChild(r)}).catch(function(e){return o.fallbackUrls&&o.fallbackUrls.length>0&&t<n.length-1?r(t+1):Promise.reject(e)})};return r(0)},i.prototype.load=function(e,t){var i=this;return"string"==typeof e&&(e=[e]),new Promise(function(a,o){var n={libs:e,priority:t?0:10,resolve:a,reject:o};t?i.queue.unshift(n):i.queue.push(n),i.processQueue()})},i.prototype.processQueue=function(){var e=this;if(!this.loading&&0!==this.queue.length){this.loading=!0,this.queue.sort(function(e,t){return e.priority-t.priority});var t=this.queue.shift();if(0===t.priority){for(var i=[],a=0;a<t.libs.length;a+=5)i.push(t.libs.slice(a,a+5));var o=Promise.resolve();i.forEach(function(t){o=o.then(function(){var i=t.map(function(t){return e.loadSingleLibrary(t,!0)});return Promise.all(i)})}),o.then(function(){t.resolve(),e.loading=!1,e.processQueue()}).catch(function(i){t.reject(i),e.loading=!1,e.processQueue()})}else{var n=Promise.resolve();t.libs.forEach(function(i){n=n.then(function(){return e.loadSingleLibrary(i,0===t.priority)})}),n.then(function(){t.resolve(),e.loading=!1,e.processQueue()}).catch(function(i){t.reject(i),e.loading=!1,e.processQueue()})}}},i.prototype.preload=function(){var e=this,i=Object.keys(t).map(function(e){return{key:e,priority:t[e].priority}}).sort(function(e,t){return e.priority-t.priority}).filter(function(i){var a=t[i.key];return!e.isLoaded(i.key)&&!a.disabled}).map(function(e){return e.key});0!==i.length&&setTimeout(function(){i.forEach(function(t){e.load(t,!1).catch(function(e){})})},1e3)},i.prototype.isLoaded=function(e){var i=t[e];return!!i&&(this.loadedLibs[e]||i.checkFn&&i.checkFn())},i.prototype.getConfig=function(e){return e?t[e]:t},e.MeeWoo.Core.LibraryLoader=i,e.MeeWoo.Core.libraryLoader=new i}(window),function(e){function t(){this._groups={},this._refCount={}}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{},t.prototype.createObjectURL=function(e,t){if(!e)return"";t=t||"default";var i=URL.createObjectURL(e);return this._groups[t]||(this._groups[t]=new Set),this._groups[t].add(i),i},t.prototype.revokeObjectURL=function(e,t){if(e){try{URL.revokeObjectURL(e)}catch(a){console.warn("Error revoking object URL:",a)}if(t&&this._groups[t])this._groups[t].delete(e);else for(var i in this._groups)if(this._groups[i].has(e)){this._groups[i].delete(e);break}}},t.prototype.releaseGroup=function(e){this._groups[e]&&(this._groups[e].forEach(function(e){try{URL.revokeObjectURL(e)}catch(t){console.warn("Error revoking object URL:",t)}}),this._groups[e].clear())},t.prototype.releaseAll=function(){for(var t in this._groups)this.releaseGroup(t);e.MeeWoo.Controllers&&e.MeeWoo.Controllers.GlobalAudioManager&&e.MeeWoo.Controllers.GlobalAudioManager.unloadAll()},e.MeeWoo.Core.ResourceManager=t,e.MeeWoo.Core.resourceManager=new t}(window);const e={},t=function(t,i,a){let o=Promise.resolve();if(i&&i.length>0){document.getElementsByTagName("link");const t=document.querySelector("meta[property=csp-nonce]"),a=(null==t?void 0:t.nonce)||(null==t?void 0:t.getAttribute("nonce"));o=Promise.allSettled(i.map(t=>{if((t=function(e){return"/"+e}(t))in e)return;e[t]=!0;const i=t.endsWith(".css"),o=i?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${t}"]${o}`))return;const n=document.createElement("link");return n.rel=i?"stylesheet":"modulepreload",i||(n.as="script"),n.crossOrigin="",n.href=t,a&&n.setAttribute("nonce",a),document.head.appendChild(n),i?new Promise((e,i)=>{n.addEventListener("load",e),n.addEventListener("error",()=>i(new Error(`Unable to preload CSS for ${t}`)))}):void 0}))}function n(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return o.then(e=>{for(const t of e||[])"rejected"===t.status&&n(t.reason);return t().catch(n)})};!function(){window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Services=window.MeeWoo.Services||{};const e={oxipngModule:null,initialized:!1,compressionFailed:!1,oxipngReady:!1,init:async function(){try{const{default:e,init:i}=await t(async()=>{const{default:e,init:t}=await import("./optimise-DFzGu67M.js");return{default:e,init:t}},__vite__mapDeps([0,1]));await i(),this.oxipngModule={optimise:e},this.initialized=!0,this.oxipngReady=!0,console.log("ImageCompressionService initialized with oxipng wasm")}catch(e){console.error("Failed to load oxipng wasm:",e),this.initialized=!0,this.oxipngReady=!1,console.log("ImageCompressionService initialized with fallback mode")}},isOxipngReady:function(){return this.oxipngReady},detectFileType:function(e){if(e.length>=8){const t=[137,80,78,71,13,10,26,10];let i=!0;for(let a=0;a<8;a++)if(e[a]!==t[a]){i=!1;break}if(i)return"png"}return"unknown"},compressWithOxipng:async function(e,t){if(this.initialized||await this.init(),!this.isOxipngReady())throw new Error("oxipng not available");try{const i=Math.min(6,Math.max(1,Math.round(t/20))),a=await this.oxipngModule.optimise(e.buffer,{level:i,interlace:!1,optimiseAlpha:!0});return new Uint8Array(a)}catch(i){throw console.error("oxipng compression failed:",i),i}},compressWithPako:async function(e){if("undefined"==typeof pako)throw new Error("pako not available");try{const t=new DataView(e.buffer),i=t.getUint32(16),a=t.getUint32(20),o=document.createElement("canvas");o.width=i,o.height=a;const n=o.getContext("2d",{willReadFrequently:!0}),r=await new Promise((t,i)=>{const a=new Image;a.onload=()=>t(a),a.onerror=()=>i(new Error("Image load failed")),a.src=URL.createObjectURL(new Blob([e],{type:"image/png"}))});n.drawImage(r,0,0);const s=n.getImageData(0,0,i,a).data,l=new Uint8Array(a*(1+4*i));for(let e=0;e<a;e++){l[e*(1+4*i)]=0;for(let t=0;t<i;t++){const a=4*(e*i+t),o=e*(1+4*i)+1+4*t;l[o]=s[a],l[o+1]=s[a+1],l[o+2]=s[a+2],l[o+3]=s[a+3]}}const h=pako.deflate(l);return this._buildSimplePNG(i,a,h)}catch(t){throw console.error("pako compression failed:",t),t}},compressWithBrowserDefault:async function(e){try{const t=await new Promise((t,i)=>{const a=new Image;a.onload=()=>t(a),a.onerror=()=>i(new Error("Image load failed")),a.src=URL.createObjectURL(new Blob([e],{type:"image/png"}))}),i=document.createElement("canvas");i.width=t.width,i.height=t.height;i.getContext("2d").drawImage(t,0,0);const a=await new Promise(e=>{i.toBlob(e,"image/png")}),o=await a.arrayBuffer();return new Uint8Array(o)}catch(t){throw console.error("Browser default compression failed:",t),t}},compressPNG:async function(e,t=80){let i;try{if(this.initialized||await this.init(),this.isOxipngReady())return i=await this.compressWithOxipng(e,t),console.log("oxipng compression succeeded"),i;console.log("oxipng not ready, trying pako...")}catch(a){console.error("oxipng compression failed:",a)}try{return i=await this.compressWithPako(e),console.log("pako compression succeeded"),i}catch(a){this.compressionFailed=!0,console.log("pako compression failed, trying browser default...")}try{return i=await this.compressWithBrowserDefault(e),console.log("browser default compression succeeded"),i}catch(a){return this.compressionFailed=!0,console.error("All compression methods failed, returning original data"),e}},compressCanvas:async function(e,t=80){const i=await new Promise(t=>{e.toBlob(t,"image/png")}),a=await i.arrayBuffer(),o=new Uint8Array(a);return await this.compressPNG(o,t)},compressImage:async function(e,t=80){return"png"===this.detectFileType(e)?await this.compressPNG(e,t):e},hasCompressionFailed:function(){return this.compressionFailed},resetCompressionFailed:function(){this.compressionFailed=!1},_buildSimplePNG:function(e,t,i){const a=new Uint8Array([137,80,78,71,13,10,26,10]),o=new Uint8Array(13),n=new DataView(o.buffer);n.setUint32(0,e),n.setUint32(4,t),o[8]=8,o[9]=6,o[10]=0,o[11]=0,o[12]=0;const r=this._createPNGChunk("IHDR",o),s=this._createPNGChunk("IDAT",i),l=this._createPNGChunk("IEND",new Uint8Array(0)),h=a.length+r.length+s.length+l.length,c=new Uint8Array(h);let d=0;return c.set(a,d),d+=a.length,c.set(r,d),d+=r.length,c.set(s,d),d+=s.length,c.set(l,d),c},_createPNGChunk:function(e,t){const i=t.length,a=new Uint8Array(12+i),o=new DataView(a.buffer);o.setUint32(0,i);for(let r=0;r<4;r++)a[4+r]=e.charCodeAt(r);a.set(t,8);const n=this._crc32(a.subarray(4,8+i));return o.setUint32(8+i,n),a},_crc32:function(e){if(!this._crc32Table){this._crc32Table=new Uint32Array(256);for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;this._crc32Table[e]=t}}let t=-1;for(let i=0;i<e.length;i++)t=this._crc32Table[255&(t^e[i])]^t>>>8;return(-1^t)>>>0},_crc32Table:null};window.MeeWoo.Services.ImageCompressionService=e}(),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Service=e.MeeWoo.Service||{},e.MeeWoo.Service.PanelDrag={init:function(){this.setupDragListeners(),this.setupCloseAnimation()},setupDragListeners:function(){document.querySelectorAll(".side-panel").forEach(e=>{this.setupPanel(e)})},setupCloseAnimation:function(){document.querySelectorAll(".side-panel").forEach(e=>{e.addEventListener("transitionend",t=>{"opacity"===t.propertyName&&e.classList.contains("closing")?(e.classList.add("fly-out"),e.classList.contains("side-panel--left")?e.style.left="-400px":e.style.right="-400px",e.style.top="",e.style.transform="",setTimeout(()=>{e.classList.remove("closing","fly-out"),this.resetPanelPosition(e)},100)):"opacity"===t.propertyName&&this.resetPanelPosition(e)}),e.addEventListener("animationend",t=>{this.resetPanelPosition(e)})})},closePanel:function(e){e&&(e.classList.remove("show"),e.classList.add("closing"))},resetPanelPosition:function(e){e&&(e.style.left="",e.style.right="",e.style.top="",e.style.transform="",e.classList.remove("dragging","closing","fly-out"))},setupPanel:function(e){if(!e)return;if(e._dragInitialized)return;e._dragInitialized=!0;let t=e.querySelector(".side-panel-header");if(!t&&e.classList.contains("material-panel")&&(t=e.querySelector(".material-panel-stats")),!t)return;e.classList.add("draggable");let i=!1,a=0,o=0,n=0,r=0;t.addEventListener("mousedown",t=>{if(0!==t.button)return;t.preventDefault(),i=!0,e.classList.add("dragging"),e.style.opacity="0.9",a=t.clientX,o=t.clientY;const s=e.getBoundingClientRect();n=s.left,r=s.top,e.style.left,e.style.right,e.style.top,e.style.transition,e.style.opacity,document.body&&(document.body.style.overflow="hidden")}),document.addEventListener("mousemove",t=>{if(!i)return;const s=t.clientX-a,l=t.clientY-o,h=n+s,c=r+l;e.style.right="",e.style.left=`${h}px`,e.style.top=`${c}px`,e.style.transition="none"}),document.addEventListener("mouseup",()=>{i&&(i=!1,e.classList.remove("dragging"),e.style.transition="none",e.style.opacity="",document.body&&(document.body.style.overflow=""),e.offsetHeight)}),document.addEventListener("mouseleave",()=>{i&&(i=!1,e.classList.remove("dragging"),e.style.transition="none",e.style.opacity="",document.body&&(document.body.style.overflow=""),e.offsetHeight)})}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{e.MeeWoo&&e.MeeWoo.Service&&e.MeeWoo.Service.PanelDrag&&e.MeeWoo.Service.PanelDrag.init()},100)}):setTimeout(()=>{e.MeeWoo&&e.MeeWoo.Service&&e.MeeWoo.Service.PanelDrag&&e.MeeWoo.Service.PanelDrag.init()},100);const t=new MutationObserver(t=>{try{t.forEach(t=>{t.addedNodes.length>0&&t.addedNodes.forEach(t=>{if(1===t.nodeType){t.classList&&t.classList.contains("side-panel")&&e.MeeWoo&&e.MeeWoo.Service&&e.MeeWoo.Service.PanelDrag&&e.MeeWoo.Service.PanelDrag.setupPanel(t);t.querySelectorAll(".side-panel").forEach(t=>{e.MeeWoo&&e.MeeWoo.Service&&e.MeeWoo.Service.PanelDrag&&e.MeeWoo.Service.PanelDrag.setupPanel(t)})}})})}catch(i){console.error("[PanelDrag] MutationObserver error:",i)}});!function e(){if(document&&document.body)try{t.observe(document.body,{childList:!0,subtree:!0})}catch(i){console.error("[PanelDrag] Observer error:",i)}else document&&document.addEventListener("DOMContentLoaded",e)}()}(window);const i=new class{constructor(){this.tokenKey="imghelptoken",this.userKey="imghelpuser",this.loginUrl="https://www.imghlp.com/auth/login.html"}isLoggedIn(){try{return!!localStorage.getItem(this.tokenKey)}catch(e){return console.error("检查登录状态失败:",e),!1}}getToken(){try{return localStorage.getItem(this.tokenKey)}catch(e){return console.error("获取Token失败:",e),null}}getUserInfo(){try{const e=localStorage.getItem(this.userKey);return e?JSON.parse(e):null}catch(e){return console.error("获取用户信息失败:",e),null}}saveToken(e){try{return localStorage.setItem(this.tokenKey,e),!0}catch(t){return console.error("存储Token失败:",t),!1}}saveUserInfo(e){try{const t={username:e.username||"",id:e.id||""};return localStorage.setItem(this.userKey,JSON.stringify(t)),!0}catch(t){return console.error("存储用户信息失败:",t),!1}}clearAuth(){try{return localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.userKey),!0}catch(e){return console.error("清除登录信息失败:",e),!1}}redirectToLogin(e){const t=encodeURIComponent(e||window.location.href);window.location.href=`${this.loginUrl}?returnUrl=${t}`}handleLoginCallback(){const e=new URLSearchParams(window.location.search),t=e.get("authToken")||e.get("token"),i=e.get("userInfo")||e.get("user");if(t&&i)try{this.saveToken(t),this.saveUserInfo(JSON.parse(i));const e=new URL(window.location.href);return e.searchParams.delete("authToken"),e.searchParams.delete("token"),e.searchParams.delete("userInfo"),e.searchParams.delete("user"),window.history.replaceState({},"",e.toString()),!0}catch(a){return console.error("处理登录回调失败:",a),!1}return!1}};window.authUtils=i;const a=new class{constructor(){this.baseUrl="https://api.imghlp.com"}checkLogin(){if(!window.authUtils.isLoggedIn())throw new Error("未登录，请先登录");return window.authUtils.getToken()}async request(e,t){const i=this.checkLogin();try{const a=await fetch(`${this.baseUrl}${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(t)});if(!a.ok){if(401===a.status)throw window.authUtils.redirectToLogin(window.location.href),new Error("登录已过期，请重新登录");throw new Error(`API调用失败: ${a.status}`)}const o=await a.json();if(!o.success)throw new Error(o.message||"API调用失败");return o.data}catch(a){throw console.error("API请求失败:",a),a}}async mergeImages(e){return this.request("/merge",{images:e})}async splitImage(e,t){return this.request("/split",{mergedImage:e,positionData:t})}fileToBase64(e){return new Promise((t,i)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=i,a.readAsDataURL(e)})}base64ToBlob(e){const t=e.match(/^data:image\/(\w+);base64,(.+)$/);if(!t)throw new Error("无效的Base64格式");const i=t[1],a=Uint8Array.from(atob(t[2]),e=>e.charCodeAt(0));return new Blob([a],{type:`image/${i}`})}};var o;window.imageApi=a,function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};const t={version:"1.0.0",features:{advertisement:{enabled:!1,position:"right-float"}}};e.MeeWoo.Core.SiteConfig=new class{constructor(){this.config=null,this.loaded=!1,this.callbacks=[]}async load(i="https://blog-1258489735.cos.ap-chengdu.myqcloud.com/other/svga_set/site-config.json"){if(this.loaded&&this.config)return this.config;if(["localhost","127.0.0.1","0.0.0.0",""].includes(e.location.hostname))try{console.log("[SiteConfig] 本地环境，尝试加载本地配置");const e="/site-config.json",t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const i=await t.json();if(this.validateConfig(i))return this.config=i,this.loaded=!0,console.log("[SiteConfig] 本地配置加载成功:",i),i;throw new Error("Invalid local config format")}catch(a){return console.warn("[SiteConfig] 本地配置加载失败，使用默认配置:",a.message),this.config=t,this.loaded=!0,t}try{const e=this.buildCacheBustingUrl(i),t=new AbortController,a=setTimeout(()=>t.abort(),3e3),o=await fetch(e,{method:"GET",signal:t.signal,headers:{Accept:"application/json"}});if(clearTimeout(a),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=await o.json();if(!this.validateConfig(n))throw new Error("Invalid config format");return this.config=n,this.loaded=!0,console.log("[SiteConfig] 配置加载成功:",n),n}catch(a){return console.warn("[SiteConfig] 配置加载失败，使用默认配置:",a.message),this.config=t,this.loaded=!0,t}}buildCacheBustingUrl(e){const t=Date.now(),i=e.includes("?")?"&":"?";return`${e}${i}t=${t}`}validateConfig(e){return!(!e||"object"!=typeof e)&&!(!e.version||!e.features)}getFeature(e){return this.config&&this.config.features&&this.config.features[e]||null}isFeatureEnabled(e){const t=this.getFeature(e);return t&&!0===t.enabled}getUserLevelsConfig(){return this.getFeature("userLevels")||{}}ready(){return this.loaded?Promise.resolve(this.config):new Promise(e=>{this.callbacks.push(e)})}notifyCallbacks(){this.callbacks.forEach(e=>e(this.config)),this.callbacks=[]}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{e.MeeWoo.Core.SiteConfig.load().then(()=>{e.MeeWoo.Core.SiteConfig.notifyCallbacks()})}):e.MeeWoo.Core.SiteConfig.load().then(()=>{e.MeeWoo.Core.SiteConfig.notifyCallbacks()})}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Controllers=e.MeeWoo.Controllers||{};e.MeeWoo.Controllers.AdController=new class{constructor(){this.initialized=!1,this.containers=new Map}async init(){if(this.initialized)return;e.MeeWoo&&e.MeeWoo.Core&&e.MeeWoo.Core.SiteConfig&&await e.MeeWoo.Core.SiteConfig.ready(),this.findAdContainers();["localhost","127.0.0.1"].includes(e.location.hostname)?console.log("[AdController] 本地环境，跳过广告加载"):(this.applyConfig(),this.initialized=!0)}findAdContainers(){document.querySelectorAll("[data-ad-position]").forEach(e=>{const t=e.getAttribute("data-ad-position");this.containers.set(t,e)})}applyConfig(){let t=null,i={};if(e.MeeWoo&&e.MeeWoo.Core&&e.MeeWoo.Core.SiteConfig){t=e.MeeWoo.Core.SiteConfig.getFeature("advertisement");let a="anonymous";e.authUtils&&e.authUtils.isLoggedIn()&&(a="loggedIn");const o=e.MeeWoo.Core.SiteConfig.getFeature("userLevels")||{};let n={...o.anonymous||{}};if("loggedIn"===a||"admin"===a){const e=o.loggedIn||{};n={...n,...e}}if("admin"===a){const e=o.admin||{};n={...n,...e}}i=n}if(!t)return void this.hideAllAds();const{enabled:a,position:o}=t,{showAdvertisement:n=!0}=i;a&&o&&n?this.showAd(o):this.hideAllAds()}showAd(e){const t=this.containers.get(e);t?(t.style.display="block",t.setAttribute("data-ad-visible","true"),this.initAdSense(t)):console.warn(`[AdController] 未找到广告位容器: ${e}`)}initAdSense(t){this.loadAdSenseScript();const i=t.querySelectorAll(".adsbygoogle");if(i.length>0&&e.adsbygoogle)try{i.forEach(t=>{t.getAttribute("data-adsbygoogle-status")||(e.adsbygoogle=e.adsbygoogle||[]).push({})})}catch(a){console.error("[AdController] AdSense 初始化失败:",a)}}loadAdSenseScript(){if(document.getElementById("adsense-script"))return;const e=document.createElement("script");e.id="adsense-script",e.async=!0,e.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9291089781078791",e.crossOrigin="anonymous",e.onerror=e=>{console.warn("[AdController] AdSense 脚本加载失败或被拦截 (正常现象):",e)},document.head.appendChild(e)}hideAd(e){const t=this.containers.get(e);t&&(t.style.display="none",t.setAttribute("data-ad-visible","false"))}hideAllAds(){this.containers.forEach((e,t)=>{this.hideAd(t)})}isAdVisible(e){const t=this.containers.get(e);return!!t&&"true"===t.getAttribute("data-ad-visible")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{e.MeeWoo.Controllers.AdController.init()}):e.MeeWoo.Controllers.AdController.init()}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Controllers=e.MeeWoo.Controllers||{};if(e.MeeWoo.Controllers.UserTypeController=new class{constructor(){this.initialized=!1,this.elements=new Map,this.observers=[],this.lastLoginStatus=null,this.pollingInterval=null,this.customRules=new Map}async init(){this.initialized||(e.MeeWoo&&e.MeeWoo.Core&&e.MeeWoo.Core.SiteConfig&&await e.MeeWoo.Core.SiteConfig.ready(),this.findControlledElements(),this.applyUserTypeConfig(),this.initialized=!0)}findControlledElements(){document.querySelectorAll("[data-user-type]").forEach(e=>{const t=e.getAttribute("data-user-type");this.elements.has(t)||this.elements.set(t,[]),this.elements.get(t).push(e)})}getUserType(){return e.authUtils&&e.authUtils.isLoggedIn()?"loggedIn":"anonymous"}applyUserTypeConfig(){const t=this.getUserType();let i={};if(e.MeeWoo&&e.MeeWoo.Core&&e.MeeWoo.Core.SiteConfig){i=e.MeeWoo.Core.SiteConfig.getFeature("userLevels")||{}}const a=this.mergeUserLevelConfigs(t,i);if(a.showAllButtons)return void this.elements.forEach((e,t)=>{e.forEach(e=>{this.showElement(e)})});const o=a.hideButtons||[],n=a.showButtons||[];o.forEach(e=>{const t=this.elements.get(e);t&&t.forEach(e=>{this.hideElement(e)})}),n.forEach(e=>{const t=this.elements.get(e);t&&t.forEach(e=>{this.showElement(e)})}),this.elements.forEach((e,t)=>{o.includes(t)||n.includes(t)||e.forEach(e=>{this.showElement(e)})})}mergeUserLevelConfigs(e,t){let i={...t.anonymous||{}};if("loggedIn"===e||"admin"===e){const e=t.loggedIn||{};i={...i,...e}}if("admin"===e){const e=t.admin||{};i={...i,...e}}return i}showElement(e){e&&(e.style.display="",e.style.visibility="visible",e.setAttribute("data-user-visible","true"))}hideElement(e){e&&(e.style.display="none",e.style.visibility="hidden",e.setAttribute("data-user-visible","false"))}isElementVisible(e){const t=this.elements.get(e);if(!t||0===t.length)return!1;const i=t[0];return i&&"true"===i.getAttribute("data-user-visible")}refresh(){this.findControlledElements(),this.applyUserTypeConfig()}startLoginStatusPolling(){this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=setInterval(()=>{const t=e.authUtils&&e.authUtils.isLoggedIn();t!==this.lastLoginStatus&&(this.lastLoginStatus=t,this.refresh(),this.notifyObservers())},500)}stopLoginStatusPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}addObserver(e){"function"!=typeof e||this.observers.includes(e)||this.observers.push(e)}removeObserver(e){const t=this.observers.indexOf(e);t>-1&&this.observers.splice(t,1)}notifyObservers(){const t=e.authUtils&&e.authUtils.isLoggedIn(),i=this.getUserType();this.observers.forEach(e=>{try{e(t,i)}catch(a){console.error("Observer callback error:",a)}})}registerElement(e,t){"string"==typeof e&&(e=document.querySelector(e)),e&&t&&(e.setAttribute("data-user-type",t),this.refresh())}registerElements(e){e.forEach(e=>{this.registerElement(e.element,e.type)})}shouldShowElement(t){if(this.customRules&&this.customRules.has(t)){const e=this.customRules.get(t);try{return e()}catch(r){console.error("Custom rule error:",r)}}const i=this.getUserType();let a={};if(e.MeeWoo&&e.MeeWoo.Core&&e.MeeWoo.Core.SiteConfig){a=e.MeeWoo.Core.SiteConfig.getFeature("userLevels")||{}}const o=this.mergeUserLevelConfigs(i,a);if(o.showAllButtons)return!0;const n=o.hideButtons||[];return!!(o.showButtons||[]).includes(t)||!n.includes(t)}isLoggedIn(){return e.authUtils&&e.authUtils.isLoggedIn()}getCurrentUserType(){return this.getUserType()}addCustomRule(e,t){this.customRules||(this.customRules=new Map),this.customRules.set(e,t)}removeCustomRule(e){this.customRules&&this.customRules.delete(e)}},"loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{const t=e.MeeWoo.Controllers.UserTypeController;t.init().then(()=>{t.startLoginStatusPolling()})});else{const t=e.MeeWoo.Controllers.UserTypeController;t.init().then(()=>{t.startLoginStatusPolling()})}}(window),function(e){function t(){this.ffmpeg=null,this.isLoaded=!1,this.isLoading=!1,this.loadError=null,this.isBusy=!1,this._eventListeners={},this._instanceId=Math.random().toString(36).substr(2,9)}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},t.prototype={_getBestCorePath:async function(){var e="https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js";return console.log("[调试] 使用固定FFmpeg Core Path:",e),e},_emit:function(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(function(e){try{e(t)}catch(i){console.error("事件处理函数执行错误:",i)}})},init:async function(t){var i=(t=t||{}).onProgress||function(){},a=t.highPriority||!1,o=void 0!==t.log&&t.log;if(!this.isLoaded||!this.ffmpeg){if(this.isLoading){for(;this.isLoading;)await new Promise(function(e){setTimeout(e,100)});if(this.isLoaded)return;if(this.loadError)throw new Error(this.loadError)}this.isLoading=!0,this.loadError=null,this._emit("loading",{stage:"start",progress:0});try{this._checkSharedArrayBuffer(),"undefined"!=typeof FFmpeg&&void 0!==FFmpeg.createFFmpeg||(i({stage:"loading-library",progress:.1,message:"正在加载FFmpeg库..."}),this._emit("loading",{stage:"loading-library",progress:.1,message:"正在加载FFmpeg库..."}),e.MeeWoo.Core.libraryLoader?await e.MeeWoo.Core.libraryLoader.load(["ffmpeg"],a):await this._loadFFmpegLibrary());var n=t.corePath;n||(i({stage:"checking-cdn",progress:.2,message:"正在优选最佳线路..."}),this._emit("loading",{stage:"checking-cdn",progress:.2,message:"正在优选最佳线路..."}),n=await this._getBestCorePath(),console.log("Selected FFmpeg Core Path:",n)),i({stage:"creating-instance",progress:.3,message:"正在创建FFmpeg实例..."}),this._emit("loading",{stage:"creating-instance",progress:.3,message:"正在创建FFmpeg实例..."}),this.ffmpeg=FFmpeg.createFFmpeg({log:o,corePath:n,progress:function(e){}}),i({stage:"loading-core",progress:.5,message:"正在加载编码器（约25MB，首次加载较慢）..."}),this._emit("loading",{stage:"loading-core",progress:.5,message:"正在加载编码器（约25MB，首次加载较慢）..."}),await this.ffmpeg.load(),i({stage:"done",progress:1,message:"FFmpeg加载完成"}),this._emit("loading",{stage:"done",progress:1,message:"FFmpeg加载完成"}),this.isLoaded=!0,this._emit("loaded",{instanceId:this._instanceId})}catch(r){throw this.loadError=r.message,console.error("FFmpeg加载失败:",r),this._emit("error",{error:r,stage:"loading"}),new Error("加载FFmpeg失败："+r.message)}finally{this.isLoading=!1}}},_checkSharedArrayBuffer:function(){if("undefined"==typeof SharedArrayBuffer){if("serviceWorker"in navigator){var t='SharedArrayBuffer 未启用，需要刷新页面。\n\nService Worker 已就绪，但需要刷新页面才能启用跨域隔离。\n点击"确定"将自动刷新页面。';throw confirm(t)&&e.location.reload(),new Error("需要刷新页面启用 SharedArrayBuffer")}t="您的浏览器不支持 Service Worker，无法启用 SharedArrayBuffer。\n\n请使用现代浏览器（Chrome 67+、Firefox 79+、Safari 15.2+）。";throw alert(t),new Error(t)}},_loadFFmpegLibrary:async function(){var e;if(await(e="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js",new Promise(function(t,i){var a=setTimeout(function(){i(new Error("加载超时(30s): "+e))},3e4),o=document.createElement("script");o.src=e,o.onload=function(){clearTimeout(a),t()},o.onerror=function(){clearTimeout(a),i(new Error("加载失败: "+e))},document.head.appendChild(o)})),"undefined"==typeof FFmpeg||void 0===FFmpeg.createFFmpeg)throw new Error("FFmpeg库加载成功但对象未找到")},extractAudio:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,i=e.totalFrames,a=e.fps,o=e.speedRatio||1,n=e.onProgress||function(){},r=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});try{var s=this.ffmpeg,l="input_audio.mp4",h="audio.mp3";if(n(.1),r())throw new Error("用户取消");var c=await t.arrayBuffer();s.FS("writeFile",l,new Uint8Array(c)),n(.2);var d=["-i",l,"-vn","-acodec","libmp3lame","-q:a","2"];if(Math.abs(o-1)>.01){var g=this.buildAudioTempoFilter(o);d.push("-af",g)}if(d.push("-y",h),n(.3),r())throw new Error("用户取消");await s.run.apply(s,d),n(.9);var f=s.FS("readFile",h);if(this._cleanupFiles([l,h]),n(1),!f||0===f.length)return null;var u=0;return a>0&&(u=Math.round(i/a*1e3)),Number.isFinite(u)||(u=0),[{audioKey:"audio_0",audioData:new Uint8Array(f.buffer||f),startFrame:0,endFrame:i,startTime:0,totalTime:u}]}catch(m){if(this._cleanupFiles(["input_audio.mp4","audio.mp3"]),"用户取消"===m.message)throw this._emit("cancelled",{task:"extractAudio"}),m;return console.error("音频提取失败:",m),this._emit("error",{error:m,task:"extractAudio"}),null}finally{this.isBusy=!1,this._emit("busy",{status:!1})}},buildAudioTempoFilter:function(e){if(e<.2?(console.warn("音频变速比例 "+e+" 过小，强制限制为 0.2"),e=.2):e>12&&(console.warn("音频变速比例 "+e+" 过大，强制限制为 12.0"),e=12),e>=.5&&e<=2)return"atempo="+e.toFixed(4);var t=[];console.log("音频变速比例 "+e.toFixed(4)+" 超出 0.5-2.0 范围，正在构建链式滤镜");for(var i=e;i>2;)t.push("atempo=2.0"),i/=2;for(;i<.5;)t.push("atempo=0.5"),i/=.5;return Math.abs(i-1)>.01&&t.push("atempo="+i.toFixed(4)),t.join(",")},extractAudioWithSpeedRemap:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,i=e.keyframes,a=e.totalFrames,o=parseFloat(e.fps)||30;o<=0&&(o=30);var n=e.originalTotalFrames,r=e.originalFps||o;(!r||r<=0)&&(r=30);var s=e.onProgress||function(){},l=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});try{var h=this.ffmpeg,c="input_video.mp4",d=await t.arrayBuffer();if(h.FS("writeFile",c,new Uint8Array(d)),s(.1),l())throw new Error("用户取消");var g=n/r,f=a/o;Number.isFinite(f)||(f=0),console.log("多段变速音频 - 原始:",g.toFixed(2)+"s","目标:",f.toFixed(2)+"s");for(var u=[],m=0;m<i.length-1;m++){var p=i[m],v=i[m+1],y=p.originalFrame/n*g,w=v.originalFrame/n*g-y;if(!(w<=0)){var C=p.position*f,M=w/(v.position*f-C);u.push({startTime:y,duration:w,speedRatio:M,index:m})}}if(0===u.length)return console.log("无有效音频段"),h.FS("unlink",c),null;if(s(.2),l())throw new Error("用户取消");var S=[],b=u.filter(e=>{var t=Math.max(0,Math.min(e.startTime,g));return Math.min(e.duration,g-t)>0});if(0===b.length)return console.warn("无有效音频段(调整后)"),h.FS("unlink",c),null;var F=.6/b.length;for(m=0;m<u.length;m++){var k=u[m],P=Math.max(0,Math.min(k.startTime,g)),x=Math.min(k.duration,g-P);if(x<=0)console.warn("段"+m+"调整后持续时间为0，跳过");else{var I="segment_"+m+".wav",T=["-ss",P.toFixed(3),"-t",x.toFixed(3),"-i",c,"-vn","-acodec","pcm_s16le","-ar","44100","-ac","1"];if(Math.abs(k.speedRatio-1)>.01){var E=this.buildAudioTempoFilter(k.speedRatio);T.push("-af",E)}if(T.push("-y",I),await h.run.apply(h,T),S.push(I),s(.2+S.length*F),l()){for(var W=[],L=0;L<=m;L++)W.push("segment_"+L+".wav");throw this._cleanupFiles(W),new Error("用户取消")}}}var D="output_audio.mp3";if(1===S.length)await h.run("-i",S[0],"-acodec","libmp3lame","-ar","44100","-ac","1","-b:a","128k","-y",D),this._cleanupFiles([S[0]]);else{var A=S.map(function(e){return"file '"+e+"'"}).join("\n");h.FS("writeFile","concat_list.txt",(new TextEncoder).encode(A)),await h.run("-f","concat","-safe","0","-i","concat_list.txt","-acodec","libmp3lame","-ar","44100","-ac","1","-b:a","128k","-y",D),S.push("concat_list.txt"),this._cleanupFiles(S)}if(s(.9),l())throw new Error("用户取消");var R=h.FS("readFile",D),_=new Blob([R.buffer],{type:"audio/mpeg"}),O=await _.arrayBuffer(),H=Array.from(new Uint8Array(O)),V=0;o>0&&(V=Math.round(a/o*1e3)),Number.isFinite(V)||(V=0);var U=[{audioKey:"audio.mp3",startFrame:0,endFrame:a,startTime:0,totalTime:V,audioData:H}];return this._cleanupFiles([c,D]),s(1),U}catch(B){if(console.error("多段变速音频提取失败:",B),this._cleanupFiles(["input_video.mp4","output_audio.mp3"]),"用户取消"===B.message)throw this._emit("cancelled",{task:"extractAudioWithSpeedRemap"}),B;return this._emit("error",{error:B,task:"extractAudioWithSpeedRemap"}),null}finally{this.isBusy=!1,this._emit("busy",{status:!1})}},convertVideoFormat:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.inputFile,i=e.maxWidth||1280,a=e.onProgress||function(){},o=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var n=this.ffmpeg,r="input.mp4",s="output.mp4";try{if(a(.1),o())throw new Error("用户取消");var l=await t.arrayBuffer();n.FS("writeFile",r,new Uint8Array(l)),a(.2);if(n.setProgress(function(e){a(.2+.7*e.ratio)}),o())throw new Error("用户取消");var h="scale='min("+i+",iw)':-2";if(await n.run("-i",r,"-vf",h,"-c:v","libx264","-profile:v","baseline","-level","3.0","-crf","28","-preset","ultrafast","-c:a","aac","-b:a","96k","-max_muxing_queue_size","1024",s),a(.95),o())throw new Error("用户取消");var c=n.FS("readFile",s),d=new Blob([c.buffer],{type:"video/mp4"});return this._cleanupFiles([r,s]),a(1),d}catch(g){if(this._cleanupFiles([r,s]),"用户取消"===g.message)throw this._emit("cancelled",{task:"convertVideoFormat"}),g;throw this._emit("error",{error:g,task:"convertVideoFormat"}),g}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},convertFramesToMp4:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.frames,i=e.fps||30,a=e.inputFps||i,o=e.quality||80,n=e.audioData,r=e.audioSpeedRatio||1,s=e.onProgress||function(){},l=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var h=this.ffmpeg,c=t.length,d="output.mp4",g="audio.mp3";try{for(var f=0;f<c;f++){if(l())throw new Error("用户取消");var u="frame_"+String(f).padStart(6,"0")+".jpg",m=t[f];m instanceof Blob&&(m=new Uint8Array(await m.arrayBuffer())),m instanceof Uint8Array||(m=new Uint8Array(m)),h.FS("writeFile",u,m),f%5==0&&s(f/c*.4)}var p=!1;if(n&&n.length>0){var v=n;n instanceof Uint8Array||(v=new Uint8Array(n)),h.FS("writeFile",g,v),p=!0}s(.45);var y=Math.round(51-o/100*33),w=["-thread_queue_size","512","-framerate",String(a),"-i","frame_%06d.jpg"];if(p&&(w.push("-thread_queue_size","512"),w.push("-vn","-i",g)),w.push("-c:v","libx264","-preset","fast","-tune","animation","-profile:v","high","-level","4.0","-pix_fmt","yuv420p","-crf",String(y),"-movflags","+faststart","-r",String(i)),p){if(w.push("-c:a","aac","-b:a","128k"),Math.abs(r-1)>.01){var C=this.buildAudioTempoFilter(r);w.push("-af",C)}w.push("-shortest")}w.push("-y",d);if(h.setProgress(function(e){var t=0;void 0!==e.ratio?t=e.ratio:e.time&&e.duration&&(t=e.time/e.duration),s(.45+.5*t)}),l())throw new Error("用户取消");await h.run.apply(h,w),s(.95);var M=h.FS("readFile",d),S=new Blob([M.buffer],{type:"video/mp4"}),b=[d];p&&b.push(g);for(f=0;f<c;f++)b.push("frame_"+String(f).padStart(6,"0")+".jpg");return this._cleanupFiles(b),s(1),S}catch(k){var F=[d,g];for(f=0;f<c;f++)F.push("frame_"+String(f).padStart(6,"0")+".jpg");if(this._cleanupFiles(F),"用户取消"===k.message)throw this._emit("cancelled",{task:"convertFramesToMp4"}),k;throw this._emit("error",{error:k,task:"convertFramesToMp4"}),k}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},extractFrames:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,i=e.fps||30,a=e.width,o=e.height,n=e.onProgress||function(){},r=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var s=this.ffmpeg,l="input.mp4";try{if(n(.1),r())throw new Error("用户取消");var h=await t.arrayBuffer();s.FS("writeFile",l,new Uint8Array(h)),n(.2);var c=["-i",l,"-vf",`fps=${i},scale=${a}:${o}`,"-f","image2","-y","frame_%d.png"];if(n(.3),r())throw new Error("用户取消");if(s.setProgress(function(e){var t=0;void 0!==e.ratio?t=e.ratio:e.time&&e.duration&&(t=e.time/e.duration),n(.3+.5*t)}),await s.run.apply(s,c),n(.8),r())throw new Error("用户取消");for(var d=[],g=1;;){var f=`frame_${g}.png`;try{var u=s.FS("readFile",f);d.push(new Uint8Array(u.buffer||u)),g++}catch(v){break}}for(var m=[l],p=1;p<g;p++)m.push(`frame_${p}.png`);return this._cleanupFiles(m),n(1),d}catch(y){this._cleanupFiles([l]);for(g=1;;){f=`frame_${g}.png`;try{s.FS("unlink",f),g++}catch(v){break}}if("用户取消"===y.message)throw this._emit("cancelled",{task:"extractFrames"}),y;throw console.error("帧提取失败:",y),this._emit("error",{error:y,task:"extractFrames"}),y}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},runCommand:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.args||[],i=e.inputFiles||[],a=e.outputFiles||[],o=e.onProgress||function(){};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var n=this.ffmpeg,r=[];try{for(var s=0;s<i.length;s++){var l=i[s];l.name&&l.data&&(n.FS("writeFile",l.name,new Uint8Array(l.data)),r.push(l.name))}n.setProgress(function(e){void 0!==e.ratio&&o(e.ratio)}),await n.run.apply(n,t);var h={};for(s=0;s<a.length;s++){var c=a[s];try{var d=n.FS("readFile",c);h[c]=d,r.push(c)}catch(g){console.warn("无法读取输出文件:",c,g)}}return this._cleanupFiles(r),h}catch(f){throw this._cleanupFiles(r),this._emit("error",{error:f,task:"runCommand"}),f}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},_cleanupFiles:function(e){if(this.ffmpeg){var t=this.ffmpeg;e.forEach(function(e){try{t.FS("unlink",e)}catch(i){}})}},getVersion:function(){return this.isLoaded?"FFmpeg 0.11.6 (ffmpeg-core 0.11.0)":"未加载"},reset:function(){if(this.ffmpeg)try{this._cleanupFiles(["input_audio.mp4","audio.mp3","input_video.mp4","output_audio.mp3","input.mp4","output.mp4","output.mp4","audio.mp3","concat_list.txt"])}catch(e){}this.ffmpeg=null,this.isLoaded=!1,this.isLoading=!1,this.loadError=null,this.isBusy=!1,this._emit("reset",{})},destroy:function(){this.reset(),this._eventListeners={},this._emit("destroy",{instanceId:this._instanceId})},on:function(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)},off:function(e,t){this._eventListeners[e]&&(this._eventListeners[e]=this._eventListeners[e].filter(function(e){return e!==t}))},getInstanceId:function(){return this._instanceId}};var i={_instance:null,_instances:[],getInstance:function(){return this._instance||(this._instance=new t,this._instances.push(this._instance)),this._instance},createInstance:function(){var e=new t;return this._instances.push(e),e},destroyInstance:function(e){e&&(e.destroy(),this._instances=this._instances.filter(function(t){return t.getInstanceId()!==e.getInstanceId()}),this._instance===e&&(this._instance=null))},destroyAllInstances:function(){this._instances.forEach(function(e){e.destroy()}),this._instances=[],this._instance=null},getAllInstances:function(){return[...this._instances]},init:function(){return this.getInstance().init.apply(this.getInstance(),arguments)},extractAudio:function(){return this.getInstance().extractAudio.apply(this.getInstance(),arguments)},extractAudioWithSpeedRemap:function(){return this.getInstance().extractAudioWithSpeedRemap.apply(this.getInstance(),arguments)},convertVideoFormat:function(){return this.getInstance().convertVideoFormat.apply(this.getInstance(),arguments)},convertFramesToMp4:function(){return this.getInstance().convertFramesToMp4.apply(this.getInstance(),arguments)},extractFrames:function(){return this.getInstance().extractFrames.apply(this.getInstance(),arguments)},runCommand:function(){return this.getInstance().runCommand.apply(this.getInstance(),arguments)},getVersion:function(){return this.getInstance().getVersion.apply(this.getInstance(),arguments)},reset:function(){return this.getInstance().reset.apply(this.getInstance(),arguments)},destroy:function(){return this.getInstance().destroy.apply(this.getInstance(),arguments)},on:function(){return this.getInstance().on.apply(this.getInstance(),arguments)},off:function(){return this.getInstance().off.apply(this.getInstance(),arguments)},buildAudioTempoFilter:function(){return this.getInstance().buildAudioTempoFilter.apply(this.getInstance(),arguments)}};e.MeeWoo.Services.FFmpegService=i}(window),function(e){if(window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Services=window.MeeWoo.Services||{},"function"==typeof require)try{require("./memory-pool.js"),require("./worker-pool.js"),require("./wasm/wasm-loader.js")}catch(i){}var t={defaults:{mode:"color-left-alpha-right",jpegQuality:.6,format:"jpeg",workerPath:"assets/js/service/dual-channel/dual-channel-worker.js",memoryPool:{enabled:!0,maxPoolSize:100,clearInterval:6e4},workerPool:{enabled:!0,minWorkers:1,maxWorkers:navigator.hardwareConcurrency||4,maxTasksPerWorker:10,taskTimeout:6e4,idleTimeout:3e4},wasm:{enabled:!0,modulePath:"assets/js/service/dual-channel/wasm/dual-channel-core.wasm",fallbackToJS:!0,useSIMD:!0},debug:{enabled:!1,performanceMonitoring:!0,detailedLogging:!1,memoryProfiling:!1,benchmarking:!1}},_performanceData:{tasks:[],totalTime:0,workerTime:0,mainThreadTime:0,memoryUsage:[],workerCount:0,taskCount:0,errorCount:0},_taskId:0,_worker:null,_workerPool:null,_memoryPool:null,_memoryClearInterval:null,_wasmLoader:null,_worker:null,_workerPool:null,_taskId:0,_memoryPool:null,_memoryClearInterval:null,_workerPool:null,_wasmLoader:null,_isWorkerSupported:function(){return"undefined"!=typeof Worker},_startPerformanceTimer:function(e,t){if(!this.defaults.debug.performanceMonitoring)return null;return{taskType:e,startTime:performance.now(),startMemory:this._getMemoryUsage(),taskData:JSON.parse(JSON.stringify(t)),timestamp:(new Date).toISOString()}},_endPerformanceTimer:function(e,t,i){if(!e||!this.defaults.debug.performanceMonitoring)return;const a=performance.now(),o=this._getMemoryUsage(),n=a-e.startTime,r={id:++this._performanceData.taskCount,type:e.taskType,duration:n,startTime:e.startTime,endTime:a,success:t,processingMethod:i,startMemory:e.startMemory,endMemory:o,memoryDelta:o.totalJSHeapSize-e.startMemory.totalJSHeapSize,timestamp:e.timestamp,taskDetails:e.taskData};this._performanceData.tasks.push(r),this._performanceData.totalTime+=n,"worker"===i?this._performanceData.workerTime+=n:this._performanceData.mainThreadTime+=n,t||this._performanceData.errorCount++,this._performanceData.memoryUsage.push(o),this.defaults.debug.detailedLogging&&console.log(`[Performance] ${e.taskType} - ${i} - ${n.toFixed(2)}ms - ${t?"Success":"Error"}`)},_getMemoryUsage:function(){return"undefined"!=typeof performance&&performance.memory?{totalJSHeapSize:performance.memory.totalJSHeapSize,usedJSHeapSize:performance.memory.usedJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}:{totalJSHeapSize:0,usedJSHeapSize:0,jsHeapSizeLimit:0}},generatePerformanceReport:function(){const e=this._performanceData.tasks,t={summary:{totalTasks:e.length,totalTime:this._performanceData.totalTime,averageTaskTime:e.length>0?this._performanceData.totalTime/e.length:0,workerTime:this._performanceData.workerTime,mainThreadTime:this._performanceData.mainThreadTime,errorCount:this._performanceData.errorCount,successRate:e.length>0?((e.length-this._performanceData.errorCount)/e.length*100).toFixed(2)+"%":"0%"},taskBreakdown:{},memoryUsage:{peak:this._performanceData.memoryUsage.length>0?Math.max(...this._performanceData.memoryUsage.map(e=>e.usedJSHeapSize)):0,average:this._performanceData.memoryUsage.length>0?this._performanceData.memoryUsage.reduce((e,t)=>e+t.usedJSHeapSize,0)/this._performanceData.memoryUsage.length:0},tasks:e.slice(-10)};return e.forEach(e=>{t.taskBreakdown[e.type]||(t.taskBreakdown[e.type]={count:0,totalTime:0,averageTime:0,successCount:0}),t.taskBreakdown[e.type].count++,t.taskBreakdown[e.type].totalTime+=e.duration,t.taskBreakdown[e.type].averageTime=t.taskBreakdown[e.type].totalTime/t.taskBreakdown[e.type].count,e.success&&t.taskBreakdown[e.type].successCount++}),t},clearPerformanceData:function(){this._performanceData={tasks:[],totalTime:0,workerTime:0,mainThreadTime:0,memoryUsage:[],workerCount:0,taskCount:0,errorCount:0}},_debugLog:function(e,t,i){if(!this.defaults.debug.enabled)return;const a=console[e]||console.log,o=(new Date).toISOString();i&&this.defaults.debug.detailedLogging?a(`[${o}] [${e.toUpperCase()}] ${t}`,i):a(`[${o}] [${e.toUpperCase()}] ${t}`)},_initWorker:function(){if(!this._worker)try{if(!this._isWorkerSupported())throw new Error("当前浏览器不支持Web Worker");console.log("开始初始化Web Worker");try{const e="./dual-channel-worker.js";console.log("尝试加载外部Worker文件:",e),this._worker=new Worker(new URL(e,import.meta.url)),console.log("Web Worker 外部文件加载成功")}catch(e){console.warn("Vite Worker加载失败，尝试使用传统路径:",e.message);const t=this.defaults.workerPath;console.log("尝试加载外部Worker文件（传统路径）:",t),this._worker=new Worker(t),console.log("Web Worker 外部文件（传统路径）加载成功")}}catch(t){console.error("Worker外部文件加载失败:",t);try{console.log("回退到内联Worker代码");const e=new Blob(["\n// 分块大小配置\nconst BLOCK_SIZE = 128;\n\n// 检测SIMD支持\nconst hasSIMD = false;\n\n// 处理消息\nself.onmessage = function(e) {\n  var task = e.data;\n  console.log('Worker received task:', task.type, 'Task ID:', task.id);\n  \n  try {\n    switch(task.type) {\n      case 'composeFrame':\n        console.log('Processing composeFrame task');\n        handleComposeFrame(task).catch(function(error) {\n          console.error('Error in handleComposeFrame:', error);\n          self.postMessage({ id: task.id, type: 'error', error: error.message });\n        });\n        break;\n      case 'composeFrames':\n        console.log('Processing composeFrames task, frame count:', task.frames ? task.frames.length : (task.data ? task.data.frames.length : 0));\n        handleComposeFrames(task).catch(function(error) {\n          console.error('Error in handleComposeFrames:', error);\n          self.postMessage({ id: task.id, type: 'error', error: error.message });\n        });\n        break;\n      default:\n        throw new Error('Unknown task type: ' + task.type);\n    }\n  } catch(error) {\n    console.error('Error in message handler:', error);\n    self.postMessage({ id: task.id, type: 'error', error: error.message });\n  }\n};\n\nasync function handleComposeFrame(task) {\n  // 兼容两种数据结构：直接的属性或嵌套的data属性\n  var frame = task.frame || (task.data ? task.data.frame : undefined);\n  var width = task.width || (task.data ? task.data.width : undefined);\n  var height = task.height || (task.data ? task.data.height : undefined);\n  var mode = task.mode || (task.data ? task.data.mode : undefined);\n  \n  if (!frame || !frame.data) {\n    throw new Error('缺少frame数据');\n  }\n  \n  var frameData = frame.data;\n  var isColorLeftAlphaRight = mode === 'color-left-alpha-right';\n  var dualWidth = width * 2;\n  var dualHeight = height;\n  var dualDataSize = dualWidth * dualHeight * 4;\n  \n  var dualData = new Uint8ClampedArray(dualDataSize);\n  var blackBgData = new Uint8ClampedArray(dualDataSize);\n  \n  var blocks = [];\n  for (var y = 0; y < height; y += BLOCK_SIZE) {\n    for (var x = 0; x < width; x += BLOCK_SIZE) {\n      blocks.push({ x: x, y: y, width: Math.min(BLOCK_SIZE, width - x), height: Math.min(BLOCK_SIZE, height - y) });\n    }\n  }\n  \n  try {\n    var processedBlocks = 0;\n    var totalBlocks = blocks.length;\n    \n    await Promise.all(blocks.map(async block => {\n      await processBlock(block, frameData, width, height, dualWidth, dualData, blackBgData, isColorLeftAlphaRight);\n      \n      processedBlocks++;\n      var progress = Math.round((processedBlocks / totalBlocks) * 100);\n      \n      if (progress % 5 === 0) {\n        self.postMessage({ id: task.id, type: 'progress', progress: progress });\n      }\n    }));\n  } catch (error) {\n    console.error('Error during block processing:', error);\n    throw error;\n  }\n  \n  self.postMessage({ id: task.id, type: 'result', result: { blackBgData: blackBgData, dualData: dualData, width: dualWidth, height: dualHeight } }, [blackBgData.buffer, dualData.buffer]);\n}\n\nasync function handleComposeFrames(task) {\n  // 兼容两种数据结构：直接的frames属性或嵌套的data.frames\n  var frames = task.frames || (task.data ? task.data.frames : undefined);\n  var mode = task.mode || (task.data ? task.data.mode : undefined);\n  \n  if (!frames) {\n    throw new Error('缺少frames数据');\n  }\n  \n  var frameCount = frames.length;\n  if (frameCount === 0) {\n    throw new Error('帧数组不能为空');\n  }\n  \n  var results = [];\n  var width = frames[0].width;\n  var height = frames[0].height;\n  var isColorLeftAlphaRight = mode === 'color-left-alpha-right';\n  var dualWidth = width * 2;\n  var dualDataSize = dualWidth * height * 4;\n  \n  const BATCH_SIZE = 20;\n  \n  for (let batchStart = 0; batchStart < frameCount; batchStart += BATCH_SIZE) {\n    const batchEnd = Math.min(batchStart + BATCH_SIZE, frameCount);\n    const batchFrames = frames.slice(batchStart, batchEnd);\n    const batchSize = batchFrames.length;\n    \n    var framePromises = batchFrames.map(async function(frameData, index) {\n      const frameIndex = batchStart + index;\n      \n      var dualData = new Uint8ClampedArray(dualDataSize);\n      var blackBgData = new Uint8ClampedArray(dualDataSize);\n      \n      var blocks = [];\n      for (var y = 0; y < height; y += BLOCK_SIZE) {\n        for (var x = 0; x < width; x += BLOCK_SIZE) {\n          blocks.push({ x: x, y: y, width: Math.min(BLOCK_SIZE, width - x), height: Math.min(BLOCK_SIZE, height - y) });\n        }\n      }\n      \n      try {\n        await Promise.all(blocks.map(block => processBlock(block, frameData.data, width, height, dualWidth, dualData, blackBgData, isColorLeftAlphaRight)));\n      } catch (error) {\n        console.error('Error processing frame', frameIndex, ':', error);\n        return null;\n      }\n      \n      return { blackBgData: blackBgData, width: dualWidth, height: height };\n    });\n    \n    try {\n      const batchResults = await Promise.all(framePromises);\n      \n      const validResults = batchResults.filter(result => result !== null);\n      results.push(...validResults);\n      \n      const processedFrames = Math.min(batchEnd, frameCount);\n      var progress = Math.round((processedFrames / frameCount) * 100);\n      \n      if (progress % 5 === 0) {\n        self.postMessage({ id: task.id, type: 'progress', progress: progress });\n      }\n    } catch (error) {\n      console.error('Error in batch processing:', error);\n      continue;\n    }\n  }\n  \n  var transferables = [];\n  results.forEach(result => {\n    transferables.push(result.blackBgData.buffer);\n  });\n  \n  self.postMessage({ id: task.id, type: 'result', result: results }, transferables);\n}\n\nfunction processBlock(block, frameData, width, height, dualWidth, dualData, blackBgData, isColorLeftAlphaRight) {\n  return new Promise(function(resolve) {\n    var startX = block.x;\n    var startY = block.y;\n    var blockWidth = block.width;\n    var blockHeight = block.height;\n    \n    var inv255 = 1 / 255;\n    \n    try {\n      processBlockWithoutSIMD(block, frameData, width, height, dualWidth, dualData, blackBgData, isColorLeftAlphaRight, inv255);\n      resolve();\n    } catch (error) {\n      console.error('Error processing block:', error, 'at position:', startX, ',', startY);\n      resolve();\n    }\n  });\n}\n\nfunction processBlockWithoutSIMD(block, frameData, width, height, dualWidth, dualData, blackBgData, isColorLeftAlphaRight, inv255) {\n  var startX = block.x;\n  var startY = block.y;\n  var blockWidth = block.width;\n  var blockHeight = block.height;\n  \n  for (var y = startY; y < startY + blockHeight; y++) {\n    for (var x = startX; x < startX + blockWidth; x++) {\n      try {\n        processSinglePixel(x, y, frameData, width, dualWidth, dualData, blackBgData, isColorLeftAlphaRight, inv255);\n      } catch (error) {\n        console.error('Error processing pixel at', x, ',', y, ':', error);\n      }\n    }\n  }\n}\n\nfunction processSinglePixel(x, y, frameData, width, dualWidth, dualData, blackBgData, isColorLeftAlphaRight, inv255) {\n  var pixelIndex = y * width + x;\n  var frameIdx = pixelIndex * 4;\n  \n  if (frameIdx + 3 >= frameData.length) {\n    console.error('Invalid frame index:', frameIdx, 'for frame data length:', frameData.length);\n    return;\n  }\n  \n  var r = frameData[frameIdx + 0];\n  var g = frameData[frameIdx + 1];\n  var b = frameData[frameIdx + 2];\n  var a = frameData[frameIdx + 3];\n\n  var finalR = r, finalG = g, finalB = b;\n  if (a > 0) {\n    if (a < 255) {\n      var alphaFactor = 255 * inv255;\n      finalR = Math.min(255, Math.round(r * alphaFactor));\n      finalG = Math.min(255, Math.round(g * alphaFactor));\n      finalB = Math.min(255, Math.round(b * alphaFactor));\n    }\n  } else {\n    finalR = 0; finalG = 0; finalB = 0;\n  }\n\n  var leftIdx = (y * dualWidth + x) * 4;\n  var rightIdx = (y * dualWidth + x + width) * 4;\n\n  if (leftIdx + 3 >= dualData.length || rightIdx + 3 >= dualData.length) {\n    console.error('Invalid dual data index:', leftIdx, 'or', rightIdx, 'for dual data length:', dualData.length);\n    return;\n  }\n\n  if (isColorLeftAlphaRight) {\n    dualData[leftIdx + 0] = finalR;\n    dualData[leftIdx + 1] = finalG;\n    dualData[leftIdx + 2] = finalB;\n    dualData[leftIdx + 3] = a;\n    dualData[rightIdx + 0] = a;\n    dualData[rightIdx + 1] = a;\n    dualData[rightIdx + 2] = a;\n    dualData[rightIdx + 3] = 255;\n  } else {\n    dualData[leftIdx + 0] = a;\n    dualData[leftIdx + 1] = a;\n    dualData[leftIdx + 2] = a;\n    dualData[leftIdx + 3] = 255;\n    dualData[rightIdx + 0] = finalR;\n    dualData[rightIdx + 1] = finalG;\n    dualData[rightIdx + 2] = finalB;\n    dualData[rightIdx + 3] = a;\n  }\n\n  var pixelAlphaLeft = dualData[leftIdx + 3];\n  if (pixelAlphaLeft === 255) {\n    blackBgData[leftIdx + 0] = dualData[leftIdx + 0];\n    blackBgData[leftIdx + 1] = dualData[leftIdx + 1];\n    blackBgData[leftIdx + 2] = dualData[leftIdx + 2];\n  } else if (pixelAlphaLeft === 0) {\n    blackBgData[leftIdx + 0] = 0;\n    blackBgData[leftIdx + 1] = 0;\n    blackBgData[leftIdx + 2] = 0;\n  } else {\n    var alphaFactorLeft = pixelAlphaLeft * inv255;\n    blackBgData[leftIdx + 0] = Math.round(dualData[leftIdx + 0] * alphaFactorLeft);\n    blackBgData[leftIdx + 1] = Math.round(dualData[leftIdx + 1] * alphaFactorLeft);\n    blackBgData[leftIdx + 2] = Math.round(dualData[leftIdx + 2] * alphaFactorLeft);\n  }\n  blackBgData[leftIdx + 3] = 255;\n\n  var pixelAlphaRight = dualData[rightIdx + 3];\n  if (pixelAlphaRight === 255) {\n    blackBgData[rightIdx + 0] = dualData[rightIdx + 0];\n    blackBgData[rightIdx + 1] = dualData[rightIdx + 1];\n    blackBgData[rightIdx + 2] = dualData[rightIdx + 2];\n  } else if (pixelAlphaRight === 0) {\n    blackBgData[rightIdx + 0] = 0;\n    blackBgData[rightIdx + 1] = 0;\n    blackBgData[rightIdx + 2] = 0;\n  } else {\n    var alphaFactorRight = pixelAlphaRight * inv255;\n    blackBgData[rightIdx + 0] = Math.round(dualData[rightIdx + 0] * alphaFactorRight);\n    blackBgData[rightIdx + 1] = Math.round(dualData[rightIdx + 1] * alphaFactorRight);\n    blackBgData[rightIdx + 2] = Math.round(dualData[rightIdx + 2] * alphaFactorRight);\n  }\n  blackBgData[rightIdx + 3] = 255;\n}\n                    "],{type:"application/javascript"}),t=URL.createObjectURL(e);this._worker=new Worker(t),console.log("Web Worker 内联代码加载成功")}catch(i){throw console.error("Worker内联代码加载失败:",i),new Error("无法加载Web Worker: "+i.message)}}},_initMemoryPool:function(){this.defaults.memoryPool.enabled&&window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.MemoryPool&&(this._memoryPool=window.MeeWoo.Services.MemoryPool,console.log("内存池初始化成功"))},_startMemoryClearInterval:function(){this._memoryClearInterval&&clearInterval(this._memoryClearInterval),this.defaults.memoryPool.enabled&&this.defaults.memoryPool.clearInterval>0&&(this._memoryClearInterval=setInterval(()=>{this._clearMemoryPool()},this.defaults.memoryPool.clearInterval))},_clearMemoryPool:function(){if(this._memoryPool)try{this._memoryPool.clear(),console.log("内存池清理完成")}catch(e){console.error("内存池清理失败:",e)}},_initWorkerPool:function(){this.defaults.workerPool.enabled&&window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.WorkerPool&&(this._workerPool=window.MeeWoo.Services.WorkerPool,console.log("Worker池初始化成功"))},_initWasm:async function(){if(this.defaults.wasm.enabled&&window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.WasmLoader)if(this._wasmLoader=window.MeeWoo.Services.WasmLoader,this._wasmLoader.getIsSupported())try{await this._wasmLoader.load(this.defaults.wasm.modulePath),console.log("WebAssembly初始化成功")}catch(e){console.warn("WebAssembly加载失败，回退到JavaScript:",e.message),this._wasmLoader=null}else console.warn("当前浏览器不支持WebAssembly，回退到JavaScript"),this._wasmLoader=null},_sendTask:function(e,t,i){const a=(i=i||{}).onProgress||function(){},o=this._startPerformanceTimer(e,t);return new Promise((n,r)=>{try{if(!this._isWorkerSupported())return this._debugLog("warn","当前浏览器不支持Web Worker，回退到主线程处理"),void this._processInMainThread(e,t,i).then(e=>{this._endPerformanceTimer(o,!0,"main-thread"),n(e)}).catch(e=>{this._endPerformanceTimer(o,!1,"main-thread"),r(e)});if(this.defaults.workerPool.enabled&&window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.WorkerPool)this._debugLog("info","使用Worker池发送任务",{type:e}),this._workerPool||(this._workerPool=window.MeeWoo.Services.WorkerPool,this._debugLog("info","Worker池初始化成功")),this._workerPool.submitTask(e,t,{onProgress:a,priority:"composeFrames"===e?8:5}).then(e=>{this._endPerformanceTimer(o,!0,"worker"),n(e)}).catch(e=>{this._endPerformanceTimer(o,!1,"worker"),r(e)});else{this._debugLog("info","回退到单个Worker发送任务",{type:e}),this._initWorker();const i=++this._taskId,s={id:i,type:e,...t},l=t=>{const s=t.data;if(s.id===i)switch(s.type){case"result":this._debugLog("info","Web Worker任务完成",{type:e,taskId:i}),this._worker.removeEventListener("message",l),this._worker.removeEventListener("error",h),this._endPerformanceTimer(o,!0,"worker"),n(s.result);break;case"progress":a(s.progress/100);break;case"error":this._debugLog("error","Web Worker任务错误",{error:s.error,taskId:i}),this._worker.removeEventListener("message",l),this._worker.removeEventListener("error",h),this._endPerformanceTimer(o,!1,"worker"),r(new Error("Worker处理失败: "+s.error))}},h=e=>{this._debugLog("error","Web Worker错误",{error:e.message}),this._worker.removeEventListener("message",l),this._worker.removeEventListener("error",h),this._endPerformanceTimer(o,!1,"worker"),r(new Error("Worker执行错误: "+e.message))};this._worker.addEventListener("message",l),this._worker.addEventListener("error",h),this._debugLog("info","发送任务数据到Worker",{taskId:i,dataSize:JSON.stringify(t).length}),this._worker.postMessage(s,this._getTransferables(s)),this._debugLog("info","任务发送成功",{taskId:i})}}catch(s){this._debugLog("error","发送任务到Worker失败",{error:s.message}),this._processInMainThread(e,t,i).then(e=>{this._endPerformanceTimer(o,!0,"main-thread"),n(e)}).catch(e=>{this._endPerformanceTimer(o,!1,"main-thread"),r(e)})}})},_getTransferables:function(e){const t=[];return e.frame&&e.frame.data&&t.push(e.frame.data.buffer),e.frames&&e.frames.forEach(e=>{e.data&&t.push(e.data.buffer)}),t},_processInMainThread:async function(e,t,i){const a=(i=i||{}).onProgress||function(){};console.log("Worker失败，在主线程处理任务，类型:",e);try{if(a(.25),await new Promise(e=>setTimeout(e,200)),a(.5),await new Promise(e=>setTimeout(e,200)),a(.75),await new Promise(e=>setTimeout(e,200)),a(1),"composeFrame"===e){const e=t.width,i=t.height;return{blackBgData:new Uint8ClampedArray(2*e*i*4),dualData:new Uint8ClampedArray(2*e*i*4),width:2*e,height:i}}if("composeFrames"===e){const e=t.frames.length,i=t.frames[0].width,a=t.frames[0].height,o=[];for(let t=0;t<e;t++)o.push({blackBgData:new Uint8ClampedArray(2*i*a*4),width:2*i,height:a});return o}return{success:!0}}catch(o){throw console.error("主线程处理任务失败:",o),new Error("处理任务失败: "+o.message)}},_processWithWasm:function(e,t,i){return new Promise((t,a)=>{try{console.log("WebAssembly处理任务:",e),setTimeout(()=>{i(.5),setTimeout(()=>{i(1),t({success:!0,message:"WebAssembly处理完成"})},500)},500)}catch(o){console.error("WebAssembly处理失败:",o),a(new Error("WebAssembly处理失败: "+o.message))}})},composeSingleFrame:async function(e,t){const i=(t=t||{}).mode||this.defaults.mode,a=t.format||this.defaults.format,o=t.quality,n=t.onProgress||function(){};if(!e||!e.data)throw new Error("无效的ImageData对象");const r=e.width,s=e.height;this._debugLog("info","开始单帧合成",{width:r,height:s,mode:i,format:a});let l=o;if(void 0===l&&"jpeg"===a){const e=2*r*s;l=e<5e5?.7:e>2e6?.5:.6,this._debugLog("info","计算自适应JPEG质量",{totalPixels:e,quality:l})}try{const t=await this._sendTask("composeFrame",{frame:e,mode:i,width:r,height:s},{onProgress:n}),o=document.createElement("canvas");o.width=2*r,o.height=s;const h=o.getContext("2d",{alpha:!0,willReadFrequently:!0}),c=h.createImageData(2*r,s);c.data.set(t.dualData),h.putImageData(c,0,0);const d=document.createElement("canvas");d.width=2*r,d.height=s;const g=d.getContext("2d"),f=g.createImageData(2*r,s);f.data.set(t.blackBgData),g.putImageData(f,0,0);const u=await new Promise(function(e){"png"===a?d.toBlob(e,"image/png"):d.toBlob(e,"image/jpeg",l)}),m=await u.arrayBuffer();return o.width=0,o.height=0,d.width=0,d.height=0,this._debugLog("info","单帧合成完成",{outputSize:m.byteLength,format:a}),new Uint8Array(m)}catch(h){throw this._debugLog("error","单帧合成失败",{error:h.message}),h}},composeToJPEG:async function(e,t){return this.composeFrames(e,t)},composeFrames:async function(e,t){const i=(t=t||{}).mode||this.defaults.mode,a=t.format||this.defaults.format,o=t.quality,n=t.onProgress||function(){},r=t.onCancel||function(){return!1},s=e.length;if(this._debugLog("info","开始批量合成双通道图像",{frameCount:s,format:a,mode:i}),0===s)throw new Error("帧数组不能为空");const l=[],h=e[0].width,c=e[0].height;this._debugLog("info","图像尺寸信息",{width:h,height:c,dualWidth:2*h,dualHeight:c});let d=o;if(void 0===d&&"jpeg"===a){const e=2*h*c;d=e<5e5?.7:e>2e6?.5:.6,this._debugLog("info","计算自适应JPEG质量",{totalPixels:e,quality:d})}this._debugLog("info","分批处理配置",{batchSize:50,totalBatches:Math.ceil(s/50)});try{for(let t=0;t<s;t+=50){if(r())throw new Error("用户取消");const o=Math.min(t+50,s),f=e.slice(t,o),u=f.length;this._debugLog("info","处理批次",{batchStart:t,batchEnd:o,batchSize:u,batchIndex:Math.floor(t/50)+1}),this._debugLog("info","开始使用Web Worker处理批次");const m=await this._sendTask("composeFrames",{frames:f,mode:i,width:h,height:c,frameCount:u},{onProgress:function(e){n((t+e*u)/s)}});this._debugLog("info","Web Worker批次处理完成",{returnedResults:m.length});for(let e=0;e<u;e++){if(r())throw new Error("用户取消");try{const i=document.createElement("canvas");i.width=2*h,i.height=c;const o=i.getContext("2d"),r=o.createImageData(2*h,c);r.data.set(m[e].blackBgData),o.putImageData(r,0,0);const g=await new Promise(function(e){"png"===a?i.toBlob(e,"image/png"):i.toBlob(e,"image/jpeg",d)}),f=await g.arrayBuffer();l.push(new Uint8Array(f)),i.width=0,i.height=0;const u=t+e;n((u+1)/s),(u+1)%10==0&&await new Promise(function(e){setTimeout(e,0)})}catch(g){this._debugLog("error","处理帧时出错",{frameIndex:t+e,error:g.message});continue}}"function"==typeof gc&&(gc(),this._debugLog("info","执行垃圾回收")),this._debugLog("info","批次处理完成",{processedFrames:l.length,totalFrames:s})}if(this._debugLog("info","批量合成双通道图像完成",{generatedFrames:l.length,originalFrames:s}),this.defaults.debug.performanceMonitoring){const e=this.generatePerformanceReport();this._debugLog("info","性能报告",e.summary)}return l}catch(g){throw this._debugLog("error","批量合成失败",{error:g.message}),g}},setConfig:function(e){Object.assign(this.defaults,e)},getConfig:function(){return{...this.defaults}},destroy:function(){if(this._worker&&(this._worker.terminate(),this._worker=null,this._debugLog("info","Worker销毁成功")),this._workerPool){try{this._workerPool.shutdown(),this._debugLog("info","Worker池销毁成功")}catch(e){this._debugLog("error","Worker池销毁失败",{error:e.message})}this._workerPool=null}this.clearPerformanceData(),this._debugLog("info","资源清理完成")}};"undefined"!=typeof module&&module.exports?module.exports=t:e.MeeWoo.Services.DualChannelComposer=t}("undefined"!=typeof window?window:void 0),function(e){window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Services=window.MeeWoo.Services||{};const t={defaults:{protoPath:"./svga.proto",quality:80,fps:30,pngCompression:{enabled:!0,quality:80,speed:6}},build:async function(e){var t=this;this._validateDependencies(e.dependencies);var i=e.frames||[],a=e.width||100,o=e.height||100,n=e.fps||this.defaults.fps,r=Math.max(10,Math.min(100,e.quality||this.defaults.quality)),s=e.originalSize||null,l=e.audios||[],h=e.muted||!1,c=e.onProgress||function(){},d=e.protoPath||this.defaults.protoPath,g=e.dependencies.protobuf,f=e.dependencies.pako,u=i.length;if(0===u)throw new Error("帧数组不能为空");var m=r/100,p=Math.round(a*m),v=Math.round(o*m),y=1/m,w=s&&100===r&&a===s.width&&o===s.height,C=[];if(w)for(var M=0;M<u;M++){var S=i[M],b=await t._blobToArrayBuffer(S.blob),F=new Uint8Array(b);C.push(F),c((M+1)/u*.5)}else{for(var k=[],P=[],x=0;x<4;x++){var I=document.createElement("canvas");I.width=p,I.height=v;var T=I.getContext("2d",{willReadFrequently:!0});T.imageSmoothingEnabled=!1,k.push(I),P.push(T)}async function R(e,i){(await Promise.all(i.map(async(e,i)=>{var a,o=e.frame,n=e.index,s=k[i%4],l=P[i%4],h=await t._loadImageFromBlob(o.blob);return l.clearRect(0,0,p,v),l.drawImage(h,0,0,p,v),a=h.src,setTimeout(function(){URL.revokeObjectURL(a)},100),{index:n,pngData:await t._canvasToPNG(s,r)}}))).forEach(e=>{C[e.index]=e.pngData}),c((e+i.length)/u*.5)}C=new Array(u);for(M=0;M<u;M+=4){for(var E=Math.min(M+4,u),W=[],L=M;L<E;L++)W.push({frame:i[L],index:L});if(await R(M,W),e.cancelled&&e.cancelled())throw new Error("用户取消转换")}}var D=await t._encodeSVGA({pngFrames:C,scaledWidth:p,scaledHeight:v,displayWidth:a,displayHeight:o,scaleUp:y,fps:n,audios:l,muted:h,protoPath:d,protobuf:g,pako:f,onProgress:function(e){c(.5+.5*e)}});if(window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService){var A=window.MeeWoo.Services.ImageCompressionService;A.hasCompressionFailed()&&(alert("部分图片压缩失败，已使用降级方案处理"),A.resetCompressionFailed())}return D},buildFromPNG:async function(e){this._validateDependencies(e.dependencies);var t=e.frames||[],i=e.scaledWidth,a=e.scaledHeight,o=e.displayWidth,n=e.displayHeight,r=1/(e.scaleFactor||1),s=e.fps||this.defaults.fps,l=Math.max(10,Math.min(100,e.quality||this.defaults.quality)),h=e.audios||[],c=e.muted||!1,d=e.onProgress||function(){},g=e.protoPath||this.defaults.protoPath,f=e.dependencies.protobuf,u=e.dependencies.pako;if(0===t.length)throw new Error("帧数组不能为空");if(window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService){for(var m=window.MeeWoo.Services.ImageCompressionService,p=[],v=0;v<t.length;v++){var y=await m.compressPNG(t[v],l);p.push(y),d((v+1)/t.length*.5)}t=p}var w=await this._encodeSVGA({pngFrames:t,scaledWidth:i,scaledHeight:a,displayWidth:o,displayHeight:n,scaleUp:r,fps:s,audios:h,muted:c,protoPath:g,protobuf:f,pako:u,onProgress:function(e){d(.5+.5*e)}});window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService&&((m=window.MeeWoo.Services.ImageCompressionService).hasCompressionFailed()&&(alert("部分图片压缩失败，已使用降级方案处理"),m.resetCompressionFailed()));return w},_encodeSVGA:function(e){var t=e.pngFrames,i=e.scaledWidth,a=e.scaledHeight,o=e.displayWidth,n=e.displayHeight,r=e.scaleUp,s=e.fps,l=e.audios||[],h=e.muted||!1,c=e.protoPath,d=e.protobuf,g=e.pako,f=e.onProgress,u=t.length;return new Promise(function(e,m){d.load(c,function(c,d){if(c)m(new Error("Proto加载失败: "+c.message));else try{var p=d.lookupType("com.opensource.svga.MovieEntity");if(!p)return void m(new Error("Proto文件中未找到MovieEntity定义"));for(var v={},y=0;y<u;y++){v[S="img_"+y]=t[y],f((y+1)/u*.4)}var w=[],C={alpha:1,layout:{x:0,y:0,width:i,height:a},transform:{a:r,b:0,c:0,d:r,tx:0,ty:0}},M={alpha:0};for(y=0;y<u;y++){var S="img_"+y,b=new Array(u);b[y]=C;for(var F=0;F<y;F++)b[F]=M;for(F=y+1;F<u;F++)b[F]=M;w.push({imageKey:S,frames:b}),f(.4+(y+1)/u*.4)}var k=[];!h&&l&&l.length>0&&l.forEach(function(e,t){var i=e.audioKey||"audio_"+t;e.audioData&&(v[i]=e.audioData),k.push({audioKey:i,startFrame:e.startFrame||0,endFrame:e.endFrame||u,startTime:e.startTime||0,totalTime:e.totalTime||0})});var P={version:"2.0",params:{viewBoxWidth:o,viewBoxHeight:n,fps:s,frames:u},images:v,sprites:w,audios:k};f(.8);var x=p.verify(P);if(x)return void m(new Error("MovieEntity验证失败: "+x));var I=p.create(P),T=p.encode(I).finish();f(.9);var E=g.deflate(T),W=new Blob([E],{type:"application/octet-stream"});f(1),e(W)}catch(L){m(new Error("SVGA构建失败: "+L.message))}})})},_validateDependencies:function(e){if(!e)throw new Error("缺少依赖配置");if(!e.protobuf)throw new Error("缺少依赖：protobuf.js");if(!e.pako)throw new Error("缺少依赖：pako")},_loadImageFromBlob:function(e){return new Promise(function(t,i){var a=new Image;a.onload=function(){t(a)},a.onerror=function(){i(new Error("图片加载失败"))},a.src=URL.createObjectURL(e)})},_blobToArrayBuffer:function(e){return new Promise(function(t,i){var a=new FileReader;a.onload=function(){t(a.result)},a.onerror=function(){i(new Error("Blob读取失败"))},a.readAsArrayBuffer(e)})},_canvasToPNG:async function(e,t){try{if(window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService)return await window.MeeWoo.Services.ImageCompressionService.compressCanvas(e,t)}catch(s){console.warn("ImageCompressionService压缩失败，使用优化的原始编码:",s)}for(var i=e.toDataURL("image/png").split(",")[1],a=atob(i),o=a.length,n=new Uint8Array(o),r=0;r<o;r++)n[r]=a.charCodeAt(r);return n},_buildSimplePNG:function(e,t,i){var a=new Uint8Array([137,80,78,71,13,10,26,10]),o=new Uint8Array(13),n=new DataView(o.buffer);n.setUint32(0,e),n.setUint32(4,t),o[8]=8,o[9]=6,o[10]=0,o[11]=0,o[12]=0;var r=this._createPNGChunk("IHDR",o),s=this._createPNGChunk("IDAT",i),l=this._createPNGChunk("IEND",new Uint8Array(0)),h=a.length+r.length+s.length+l.length,c=new Uint8Array(h),d=0;return c.set(a,d),d+=a.length,c.set(r,d),d+=r.length,c.set(s,d),d+=s.length,c.set(l,d),c},decode:function(e,t,i){this._validateDependencies(t),i=i||this.defaults.protoPath;var a=t.protobuf,o=t.pako;return new Promise(function(t,n){(e instanceof Blob?e.arrayBuffer():Promise.resolve(e)).then(function(e){try{var r=new Uint8Array(e),s=o.inflate(r);a.load(i,function(e,i){if(e)n(new Error("Proto加载失败: "+e.message));else{var a=i.lookupType("com.opensource.svga.MovieEntity");if(a){var o=a.decode(s);t(o)}else n(new Error("Proto文件中未找到MovieEntity定义"))}})}catch(l){n(new Error("SVGA解析失败: "+l.message))}}).catch(n)})},encode:function(e,t,i){this._validateDependencies(t),i=i||this.defaults.protoPath;var a=t.protobuf,o=t.pako;return new Promise(function(t,n){a.load(i,function(i,a){if(i)n(new Error("Proto加载失败: "+i.message));else try{var r=a.lookupType("com.opensource.svga.MovieEntity");if(!r)return void n(new Error("Proto文件中未找到MovieEntity定义"));var s=r.verify(e);if(s)return void n(new Error("MovieEntity验证失败: "+s));var l=r.create(e),h=r.encode(l).finish(),c=o.deflate(h),d=new Blob([c],{type:"application/octet-stream"});t(d)}catch(g){n(new Error("SVGA编码失败: "+g.message))}})})},_createPNGChunk:function(e,t){var i=t.length,a=new Uint8Array(12+i),o=new DataView(a.buffer);o.setUint32(0,i);for(var n=0;n<4;n++)a[4+n]=e.charCodeAt(n);a.set(t,8);var r=this._crc32(a.subarray(4,8+i));return o.setUint32(8+i,r),a},_crc32:function(e){if(!this._crc32Table){this._crc32Table=new Uint32Array(256);for(var t=0;t<256;t++){for(var i=t,a=0;a<8;a++)i=1&i?3988292384^i>>>1:i>>>1;this._crc32Table[t]=i}}var o=-1;for(t=0;t<e.length;t++)o=this._crc32Table[255&(o^e[t])]^o>>>8;return(-1^o)>>>0},_crc32Table:null};"undefined"!=typeof module&&module.exports?module.exports=t:e.MeeWoo.Services.SvgaBuilder=t}("undefined"!=typeof window?window:void 0),function(e){window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const t={encoder:null,export:async function(e){if(!e.getFrame)throw new Error("缺少 getFrame 回调");if(!e.totalFrames||e.totalFrames<=0)throw new Error("帧数无效");if("undefined"==typeof GIF){if(!(window.MeeWoo&&window.MeeWoo.Core&&window.MeeWoo.Core.libraryLoader))throw new Error("库加载器不可用");try{await window.MeeWoo.Core.libraryLoader.load("gif",!0)}catch(L){throw new Error("GIF.js库加载失败: "+L.message)}}var t=e.width||300,i=e.height||300,a=e.fps||30,o=e.totalFrames,n=Math.round(1e3/a),r=e.transparent||!1,s=e.dither||!1,l=e.ditherColor||"#ffffff",h=31-Math.max(1,Math.min(30,e.quality||10)),c=e.onProgress||function(){},d=e.onComplete||function(){},g=e.onError||function(){},f=e.shouldCancel||function(){return!1},u=document.createElement("canvas");u.width=t,u.height=i;var m=u.getContext("2d",{willReadFrequently:!0,alpha:!0});if("undefined"==typeof Worker){console.warn("浏览器不支持Web Worker，将使用单线程编码，可能会较慢");var p={workers:0,quality:Math.min(h,15),width:t,height:i,repeat:0,background:"#ffffff"}}else{var v=navigator.hardwareConcurrency||2,y=Math.max(1,Math.min(Math.floor(v/2),4));console.log("[GIF Exporter] 检测到",v,"个CPU核心，将使用",y,"个Worker");var w,C=[];if(S.on("workerCreated",function(e){C.push(e),console.log("[GIF Exporter] Worker创建，当前Worker数量:",C.length)}),"undefined"!=typeof window&&window.location){var M=window.location.origin+window.location.pathname;M=M.substring(0,M.lastIndexOf("/")+1),w=M+"src/assets/js/service/gif/gif.worker.js"}else w="src/assets/js/service/gif/gif.worker.js";try{fetch(w,{method:"HEAD"}).catch(function(){console.warn("Worker脚本路径可能不正确:",w)})}catch(D){console.warn("无法验证Worker脚本路径:",D)}p={workers:y,workerScript:w,quality:Math.min(h,20),width:t,height:i,repeat:0,background:"#ffffff"}}r?p.transparent=0:("transparent"===(k=e.backgroundColor||"#ffffff")&&(k="#ffffff"),p.background=k);var S=new GIF(p),b=new Promise(function(e,t){console.log("[GIF Exporter] 注册事件监听器..."),S.on("progress",function(e){console.log("[GIF Exporter] 编码进度:",e),c(50+Math.floor(50*e),"encoding","编码中...")}),S.on("finished",function(i){console.log("[GIF Exporter] 编码完成，blob:",i),i&&"object"==typeof i&&i.size?e(i):t(new Error("GIF编码器生成的blob无效"))}),S.on("abort",function(){console.log("[GIF Exporter] 编码被取消"),t(new Error("用户取消"))}),S.on("error",function(e){console.error("[GIF Exporter] 编码错误:",e),e.message&&(e.message.includes("Worker")||e.message.includes("worker"))?(console.warn("[GIF Exporter] Worker相关错误，建议禁用Worker重试"),t(new Error("Worker相关错误: "+(e.message||e)+"，请尝试禁用Worker重试"))):t(new Error("GIF编码失败: "+(e.message||e)))})});try{for(var F=0;F<o;F++){if(f())throw S.abort(),new Error("用户取消");var k,P=await e.getFrame(F);if(!P)throw new Error("无法获取帧 "+F);if(m.clearRect(0,0,t,i),!r)"transparent"===(k=e.backgroundColor||"#ffffff")&&(k="#ffffff"),m.fillStyle=k,m.fillRect(0,0,t,i);m.globalCompositeOperation="source-over",m.drawImage(P,0,0,t,i),r&&(s&&l?this._processDither(m,t,i,l):this._processAlphaThreshold(m,t,i));var x=m.getImageData(0,0,t,i);if(!x||!x.data||0===x.data.length)throw new Error("处理后的图像数据无效");var I={delay:n};r&&(I.transparent=!0),S.addFrame(x,I);var T=Math.floor(F/o*50);c(T,"capturing","捕获帧 "+(F+1)+"/"+o)}c(50,"encoding","编码中...");try{console.log("[GIF Exporter] 开始编码..."),console.log("[GIF Exporter] GIF实例:",S),console.log("[GIF Exporter] GIF选项:",S.options),console.log("[GIF Exporter] 帧数:",S.frames.length),S.render(),console.log("[GIF Exporter] 编码启动成功")}catch(A){throw console.error("[GIF Exporter] 编码启动失败:",A),new Error("编码启动失败: "+A.message)}var E=new Promise(function(e){setTimeout(function(){e(new Error("GIF编码超时，可能是由于GIF.js库问题或文件过大导致"))},12e4)}),W=await Promise.race([b,E]);if(!W||"object"!=typeof W||!W.size)throw new Error("生成的GIF blob无效");return d(W,W.size),W}catch(R){throw g(R),R}},_processDither:function(e,t,i,a){for(var o=e.getImageData(0,0,t,i),n=o.data,r=a.replace("#",""),s=parseInt(r.substr(0,2),16),l=parseInt(r.substr(2,2),16),h=parseInt(r.substr(4,2),16),c=0;c<n.length;c+=4){var d=n[c+3]/255;d>0&&d<1&&(n[c]=Math.round(n[c]*d+s*(1-d)),n[c+1]=Math.round(n[c+1]*d+l*(1-d)),n[c+2]=Math.round(n[c+2]*d+h*(1-d)),n[c+3]=255)}e.putImageData(o,0,0)},_processAlphaThreshold:function(e,t,i){for(var a=e.getImageData(0,0,t,i),o=a.data,n=0;n<o.length;n+=4){var r=o[n+3];r>0&&r<255&&(o[n+3]=r<128?0:255)}e.putImageData(a,0,0)},download:function(e,t){var i=URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=t||"animation.gif",document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(function(){URL.revokeObjectURL(i)},100)},estimate:function(e){var t=e.width||100,i=e.height||100,a=e.fps||30,o=e.duration||0,n=Math.ceil(o*a),r=e.transparent||!1,s=e.dither||!1,l=r?.16:.13;r&&s&&(l=.18);var h=t*i*l*n,c="？";return n>0&&(c=h>=1048576?(h/1024/1024).toFixed(2)+"M":Math.round(h/1024)+"kb"),{frames:n,duration:o,fileSize:c,fileSizeBytes:h}},formatBytes:function(e){return e>=1048576?(e/1024/1024).toFixed(2)+" MB":e>=1024?(e/1024).toFixed(1)+" KB":e+" B"}};e.MeeWoo.Exporters.GifExporter=t}("undefined"!=typeof window?window:void 0),function(){window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const e={export:async function(e){if(!e.getFrame)throw new Error("缺少 getFrame 回调");var t=e.width||300,i=e.height||300;e.fps;var a=e.onProgress||function(){},o=e.onError||function(){},n=e.shouldCancel||function(){return!1};try{a(0,"capturing","捕获帧数据...");var r=document.createElement("canvas");r.width=t,r.height=i;for(var s=r.getContext("2d",{willReadFrequently:!0,alpha:!0}),l=null,h=0;!l&&h<3;){h++;try{(l=await e.getFrame(0))||(console.warn("[WebP导出] 第"+h+"次尝试获取帧数据失败，重试..."),await new Promise(e=>setTimeout(e,200)))}catch(g){console.warn("[WebP导出] 第"+h+"次尝试获取帧数据出错:",g),await new Promise(e=>setTimeout(e,200))}}if(!l)throw new Error("无法获取帧数据");if(0===l.width||0===l.height)throw new Error("获取的帧画布尺寸无效");if(console.log("[WebP导出] 获取到帧数据:",{width:l.width,height:l.height,type:l.constructor.name}),n())throw new Error("导出已取消");a(.3,"converting","转换为WebP格式..."),s.clearRect(0,0,t,i),s.drawImage(l,0,0,t,i);var c=r.toDataURL("image/webp",.9);a(.8,"downloading","生成下载文件...");var d=document.createElement("a");return d.href=c,d.download="export.webp",document.body.appendChild(d),d.click(),document.body.removeChild(d),a(1,"completed","导出完成"),c}catch(g){throw o(g),g}},captureFrames:async function(e){var t=e.width||300,i=e.height||300,a=e.fps||30,o=e.duration||1,n=Math.ceil(o*a),r=[],s=e.seekToFrame,l=e.getCurrentFrameCanvas,h=e.onProgress||function(){},c=e.shouldCancel||function(){return!1};if(!s||!l)throw new Error("缺少必要的帧操作方法");for(var d=0;d<n;d++){if(c())throw new Error("导出已取消");var g=Math.floor(d/a*a);await s(g,a);var f=l();if(!f)throw new Error("无法获取帧画布");var u=document.createElement("canvas");u.width=t,u.height=i,u.getContext("2d").drawImage(f,0,0,t,i);var m=new Image;m.src=u.toDataURL("image/png"),await new Promise(function(e){m.onload=e}),r.push(m),h(d/n*.3,"capturing","捕获帧数据...")}return r}};window.MeeWoo.Exporters.WebPExporter=e}(),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Service=e.MeeWoo.Service||{};class t{constructor(){this.zip=null,this.currentFrame=0,this.totalFrames=0,this.callbacks={progress:null,error:null,complete:null}}async initJSZip(){if("undefined"==typeof JSZip)throw new Error("JSZip library not loaded");this.zip=new JSZip}async exportFrames(e,t,i,a,o,n){try{this.callbacks.progress=a,this.callbacks.error=o,this.callbacks.complete=n,await this.initJSZip(),this.totalFrames=Math.ceil(i*e.fps),this.currentFrame=0;const r=this.zip.folder("frames");await this.captureFrames(r,t,e),await this.generateZip()}catch(r){console.error("导出序列帧失败:",r),this.callbacks.error&&this.callbacks.error(r.message)}}async captureFrames(e,t,i){return new Promise((a,o)=>{const n=async()=>{if(this.currentFrame>=this.totalFrames)a();else try{const a=this.currentFrame/this.totalFrames;this.callbacks.progress&&this.callbacks.progress(a,`正在捕获第 ${this.currentFrame+1} 帧`);const o=document.createElement("canvas");o.width=i.width,o.height=i.height;o.getContext("2d").drawImage(t,0,0,i.width,i.height);const r=await this.canvasToPNG(o,i.quality),s=`frame_${String(this.currentFrame).padStart(4,"0")}.png`;e.file(s,r,{binary:!0}),this.currentFrame++,requestAnimationFrame(n)}catch(r){o(r)}};n()})}async canvasToPNG(e,t){return new Promise(t=>{e.toBlob(e=>{t(e)},"image/png")})}async generateZip(){return new Promise((e,t)=>{this.callbacks.progress&&this.callbacks.progress(.9,"正在生成ZIP文件"),this.zip.generateAsync({type:"blob"},e=>{const t=.9+e.percent/100*.1;this.callbacks.progress&&this.callbacks.progress(t,"正在生成ZIP文件")}).then(t=>{this.downloadZip(t),this.callbacks.progress&&this.callbacks.progress(1,"导出完成"),this.callbacks.complete&&this.callbacks.complete(),e()}).catch(e=>{t(e)})})}downloadZip(e){const t=URL.createObjectURL(e),i=document.createElement("a");i.href=t,i.download=`frames_${Date.now()}.zip`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(t)}cancel(){this.zip=null,this.currentFrame=0,this.totalFrames=0}}e.MeeWoo.Service.FramesExporter=t,e.FramesExporter=t}(window),function(e){function t(e){this.libraryLoader=e}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},t.prototype.validateFile=function(e,t){var i=this;return new Promise(function(a,o){"svga"===t?i._validateSvga(e,a,o):"lottie"===t?i._validateLottie(e,a,o):"yyeva"===t?i._validateYyeva(e,a,o):"mp4"===t?i._validateMp4(e,a,o):o("不支持的文件类型")})},t.prototype._validateSvga=function(e,t,i){var a=new FileReader;a.onload=function(a){var o=a.target.result,n=new Blob([o],{type:"application/octet-stream"}),r=URL.createObjectURL(n);(new SVGA.Parser).load(r,function(i){URL.revokeObjectURL(r),t({videoItem:i,file:e})},function(e){URL.revokeObjectURL(r),i("SVGA文件解析失败："+(e.message||e))})},a.onerror=function(){i("文件读取失败")},a.readAsArrayBuffer(e)},t.prototype._validateLottie=function(e,t,i){(e.name||"").toLowerCase().endsWith(".lottie")?this._validateLottieZip(e,t,i):this._validateLottieJson(e,t,i)},t.prototype._validateLottieZip=function(e,t,i){var a=this;this.libraryLoader.load("jszip",!0).then(function(){var o=new FileReader;o.onload=function(o){JSZip.loadAsync(o.target.result).then(function(o){var n=o.file("manifest.json");n?n.async("text").then(function(n){try{var r=JSON.parse(n),s="";if(r.animations&&r.animations.length>0){var l=r.activeAnimationId,h=r.animations[0];if(l)for(var c=0;c<r.animations.length;c++)if(r.animations[c].id===l){h=r.animations[c];break}s="animations/"+h.id+".json",o.file(s)||(o.file(h.id+".json")?s=h.id+".json":o.file(h.id)&&(s=h.id))}s&&o.file(s)?a._readZipJsonFile(o,s,e,t,i):a._findAndReadAnyJson(o,e,t,i)}catch(d){a._findAndReadAnyJson(o,e,t,i)}}).catch(function(){a._findAndReadAnyJson(o,e,t,i)}):a._findAndReadAnyJson(o,e,t,i)}).catch(function(e){i(".lottie文件解压失败："+e.message)})},o.onerror=function(){i("文件读取失败")},o.readAsArrayBuffer(e)}).catch(function(e){i("JSZip库加载失败")})},t.prototype._findAndReadAnyJson=function(e,t,i,a){var o=[];if(e.forEach(function(e,t){e.endsWith(".json")&&!e.startsWith("__MACOSX")&&o.push(e)}),0!==o.length){for(var n=o[0],r=0;r<o.length;r++)if(-1!==o[r].toLowerCase().indexOf("data.json")){n=o[r];break}this._readZipJsonFile(e,n,t,i,a)}else a(".lottie文件中未找到JSON数据")},t.prototype._readZipJsonFile=function(e,t,i,a,o){var n=this;e.file(t).async("text").then(function(e){try{var t=JSON.parse(e),r=t;t.animations&&Array.isArray(t.animations)&&t.animations.length>0&&(t.animations[0].data?r=t.animations[0].data:t.animations[0].animation&&(r=t.animations[0].animation)),n._validateLottieAnimationData(r,i,a,o)}catch(s){o("JSON解析失败："+s.message)}}).catch(function(e){o("读取JSON文件失败："+e.message)})},t.prototype._validateLottieJson=function(e,t,i){var a=this,o=new FileReader;o.onload=function(o){try{var n=JSON.parse(o.target.result),r=n;n.animation&&"object"==typeof n.animation&&(r=n.animation),a._validateLottieAnimationData(r,e,t,i)}catch(s){i("JSON解析失败："+s.message)}},o.onerror=function(){i("文件读取失败")},o.readAsText(e)},t.prototype._validateLottieAnimationData=function(e,t,i,a){var o=e.w||e.width||0,n=e.h||e.height||0;o&&n?i({animationData:e,file:t}):a("Lottie文件缺少尺寸信息，可能文件格式不正确")},t.prototype._validateYyeva=function(e,t,i){var a=this;Promise.all([new Promise(function(t,i){a.detectMp4Type(e,function(e,a){e?t({isDualChannel:!0,alphaDirection:a}):i("检测未发现透明通道特征，请确认是双通道MP4文件")})}),a.detectMp4Fps(e)]).then(function(i){var a=i[0],o=i[1];t({file:e,isDualChannel:a.isDualChannel,alphaDirection:a.alphaDirection,detectedFps:o})}).catch(function(e){i(e)})},t.prototype._validateMp4=function(e,t,i){var a=this,o=URL.createObjectURL(e),n=document.createElement("video");n.src=o,n.muted=!0,n.onloadedmetadata=function(){URL.revokeObjectURL(o),a.detectMp4Fps(e).then(function(i){t({file:e,detectedFps:i})})},n.onerror=function(){URL.revokeObjectURL(o),i("视频文件加载失败")}},t.prototype.detectMp4Fps=function(e){return new Promise(function(t){var i=Math.min(e.size,512e3),a=new FileReader;a.onload=function(e){try{var i=e.target.result,a=function(e){var t=0,i=e.byteLength;function a(i,a){for(;t<a;){if(t+8>a)return null;var o=t,n=e.getUint32(t),r=String.fromCharCode(e.getUint8(t+4),e.getUint8(t+5),e.getUint8(t+6),e.getUint8(t+7));if(1!==n){if(0===n)return null;if(r===i)return t=o+8,{size:n,start:o,end:o+n};t=o+n}else t+=8,t=o+8+8}return null}var o=a("moov",i);if(!o)return null;t=o.start+8;var n=o.end;for(;t<n;){var r=a("trak",n);if(!r)break;var s=r.end;t=r.start+8;var l=a("mdia",s);if(l){t=l.start+8;for(var h=l.end,c=null,d=null,g=null,f=t;f<h;){t=f;var u=e.getUint32(t),m=String.fromCharCode(e.getUint8(t+4),e.getUint8(t+5),e.getUint8(t+6),e.getUint8(t+7));"hdlr"===m?c={start:t,size:u}:"mdhd"===m?d={start:t,size:u}:"minf"===m&&(g={start:t,size:u,end:t+u}),f+=u}if(c)if(t=c.start+8+4,t+=4,"vide"===String.fromCharCode(e.getUint8(t),e.getUint8(t+1),e.getUint8(t+2),e.getUint8(t+3))&&d&&g){t=d.start+8;var p=e.getUint8(t);t+=4;var v=0;1===p?(t+=16,v=e.getUint32(t)):(t+=8,v=e.getUint32(t)),t=g.start+8;var y=a("stbl",g.end);if(y){t=y.start+8;var w=a("stts",y.end);if(w){t=w.start+8,t+=4;var C=e.getUint32(t);if(t+=4,C>0){e.getUint32(t);var M=e.getUint32(t+4);if(M>0&&v>0)return Math.round(v/M)}}}}}t=s}return null}(new DataView(i));t(a)}catch(o){console.warn("MP4 FPS parsing failed:",o),t(null)}},a.onerror=function(){t(null)},a.readAsArrayBuffer(e.slice(0,i))})},t.prototype.detectMp4Type=function(e,t){var i=URL.createObjectURL(e),a=document.createElement("video");a.src=i,a.muted=!0;var o={pureBlackThreshold:.015,saturationDiffThreshold:.02,brightnessDiffThreshold:.03,checkFramePositions:[.3,.7]};function n(){a&&(a.onloadedmetadata=null,a.onseeked=null,a.onerror=null,a.removeAttribute("src"),a.src=""),i&&(setTimeout(function(){URL.revokeObjectURL(i)},100),i=null)}a.onloadedmetadata=function(){var e=a.videoWidth,i=a.videoHeight,r=a.duration,s=document.createElement("canvas"),l=Math.min(1,320/e),h=Math.max(1,Math.floor(e*l)),c=Math.max(1,Math.floor(i*l));s.width=h,s.height=c;var d=s.getContext("2d",{willReadFrequently:!0}),g=0,f=!1,u=null;function m(e){for(var t=e.data,i=0,a=0,o=0,n=0;n<t.length;n+=4){var r=t[n]/255,s=t[n+1]/255,l=t[n+2]/255,h=Math.max(r,s,l),c=Math.min(r,s,l);i+=0===h?0:(h-c)/h,a+=.299*r+.587*s+.114*l,o++}return{saturation:0===o?0:i/o,brightness:0===o?0:a/o}}function p(){d.drawImage(a,0,0,h,c);var e=Math.floor(h/2);if(e<=0||c<=0)return!1;var t=d.getImageData(0,0,e,c),i=d.getImageData(e,0,e,c),n=m(t),r=m(i),s=Math.abs(n.saturation-r.saturation),l=Math.abs(n.brightness-r.brightness),g=n.saturation<o.pureBlackThreshold||r.saturation<o.pureBlackThreshold,f=s>o.saturationDiffThreshold,u=l>o.brightnessDiffThreshold;return n.saturation<o.pureBlackThreshold&&r.saturation<o.pureBlackThreshold&&(f=s>.003,u=l>.003),g&&(f||u)?n.saturation<r.saturation?"left":"right":null}function v(){if(g>=o.checkFramePositions.length)return n(),void t(f,u);var e=o.checkFramePositions[g];if(!isFinite(r)||r<=0)if(0===g){var i=p();i&&(f=!0,u=i),n(),t(f,u)}else n(),t(f,u);else a.currentTime=r*e}a.onseeked=function(){var e=p();e&&(f=!0,u||(u=e)),g++,v()},a.onerror=function(){n(),t(!1,null)},v()},a.onerror=function(){n(),t(!1,null)}},t.prototype.isSequenceFrames=function(e){if(e.length<2)return!1;for(var t=/\d+/g,i=[],a=0;a<e.length;a++){var o=e[a].name.replace(/\.[^.]+$/,""),n=o.match(t);if(!n||0===n.length)return!1;var r=parseInt(n[n.length-1],10),s=o.lastIndexOf(n[n.length-1]),l=o.substring(0,s);i.push({file:e[a],seqNum:r,prefix:l})}for(var h=i[0].prefix,c=1;c<i.length;c++)if(i[c].prefix!==h)return!1;var d=i.map(function(e){return e.seqNum}),g=Math.min.apply(null,d);return Math.max.apply(null,d)-g+1<=1.5*e.length},e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},e.MeeWoo.Services.FileValidator=t}(window),function(e){e.MeeWoo=e.MeeWoo||{};var t={formatBytes:function(e){if(!e&&0!==e)return"";var t=e/1024;return t<1024?t.toFixed(2)+" KB":(t/1024).toFixed(4)+" MB"},loadImageFromFile:function(e,t){return new Promise(function(i,a){var o=URL.createObjectURL(e);t&&Array.isArray(t)&&t.push(o);var n=new Image;n.onload=function(){i(n)},n.onerror=function(){URL.revokeObjectURL(o),a(new Error("图片加载失败"))},n.src=o})},revokeObjectURLs:function(e){if(e&&Array.isArray(e))for(var t=0;t<e.length;t++)e[t]&&URL.revokeObjectURL(e[t])},extractNumberFromString:function(e){if(!e)return null;var t=e.match(/\d+/);return t?parseInt(t[0],10):null},padZero:function(e,t){for(var i=e.toString();i.length<t;)i="0"+i;return i},copyToClipboard:function(e){return new Promise(function(t,i){if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).then(t).catch(i);else{var a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.opacity="0",document.body.appendChild(a),a.select();try{var o=document.execCommand("copy");document.body.removeChild(a),o?t():i(new Error("复制失败"))}catch(n){document.body.removeChild(a),i(n)}}})},deepClone:function(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof Array){for(var i=[],a=0;a<e.length;a++)i[a]=t.deepClone(e[a]);return i}if(e instanceof Object){var o={};for(var n in e)e.hasOwnProperty(n)&&(o[n]=t.deepClone(e[n]));return o}throw new Error("Unable to copy obj! Its type isn't supported.")},sortFilesByName:function(e){return e.slice().sort(function(e,i){var a=t.extractNumberFromString(e.name)||0,o=t.extractNumberFromString(i.name)||0;return a!==o?a-o:e.name.localeCompare(i.name)})},formatDuration:function(e,i){if(!e&&0!==e)return"00:00";var a=Math.floor(e/3600),o=Math.floor(e%3600/60),n=Math.floor(e%60);return i||a>0?t.padZero(a,2)+":"+t.padZero(o,2)+":"+t.padZero(n,2):t.padZero(o,2)+":"+t.padZero(n,2)},getCurrentTimestamp:function(){return Date.now()},rgbToHex:function(e,t,i){var a=function(e){var t=e.toString(16).toUpperCase();return 1===t.length?"0"+t:t};return"#"+a(e)+a(t)+a(i)},hexToRgb:function(e){return 3===(e=e.replace(/^#/,"")).length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),6!==e.length?null:{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16)}},downloadFile:function(e,t){var i=URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=t,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(function(){URL.revokeObjectURL(i)},100)},downloadFromDataURL:function(e,t){var i=document.createElement("a");i.href=e,i.download=t,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)},debounce:function(e,t){var i;return function(){var a=this,o=arguments;clearTimeout(i),i=setTimeout(function(){e.apply(a,o)},t)}},throttle:function(e,t){var i,a,o,n=null,r=0,s=function(){r=Date.now(),n=null,o=e.apply(i,a),n||(i=a=null)};return function(){var l=Date.now(),h=t-(l-r);return i=this,a=arguments,h<=0||h>t?(n&&(clearTimeout(n),n=null),r=l,o=e.apply(i,a),n||(i=a=null)):n||(n=setTimeout(s,h)),o}},isMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},generateId:function(e){e=e||8;for(var t="abcdefghijklmnopqrstuvwxyz0123456789",i="",a=0;a<e;a++)i+=t.charAt(Math.floor(36*Math.random()));return i},showToast:function(e,t){t=t||3e3;var i=document.querySelector(".toast-container");if(!i){(i=document.createElement("div")).className="toast-container";var a=document.createElement("div");a.className="toast-message",i.appendChild(a),document.body.appendChild(i)}var o=i.querySelector(".toast-message");o&&(o.textContent=e),i.hideTimer&&clearTimeout(i.hideTimer),requestAnimationFrame(function(){i.classList.add("visible")}),i.hideTimer=setTimeout(function(){i.classList.remove("visible")},t)}};e.MeeWoo.Utils=t}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Controllers=e.MeeWoo.Controllers||{};var t=function(e){this.options=e||{},this.container=this.options.container||document.body,this.onDrop=this.options.onDrop||function(){},this.onHoverChange=this.options.onHoverChange||function(){},this.dragCounter=0,this._handleDragEnter=this.handleDragEnter.bind(this),this._handleDragLeave=this.handleDragLeave.bind(this),this._handleDragOver=this.handleDragOver.bind(this),this._handleDrop=this.handleDrop.bind(this),this.init()};t.prototype={init:function(){"true"===this.container.dataset.hasInputController&&(console.warn("InputController: Container already has an input controller. Overwriting..."),window.MeeWoo_GlobalInputController&&window.MeeWoo_GlobalInputController.destroy&&window.MeeWoo_GlobalInputController.destroy()),this.container.addEventListener("dragenter",this._handleDragEnter),this.container.addEventListener("dragleave",this._handleDragLeave),this.container.addEventListener("dragover",this._handleDragOver),this.container.addEventListener("drop",this._handleDrop),this.container.dataset.hasInputController="true"},handleDragEnter:function(e){this.dragCounter++,1===this.dragCounter&&this.onHoverChange(!0)},handleDragLeave:function(e){this.dragCounter--,0===this.dragCounter&&this.onHoverChange(!1)},handleDragOver:function(e){e.preventDefault()},handleDrop:function(e){e.preventDefault(),e.stopPropagation(),this.dragCounter=0,this.onHoverChange(!1);var t=e.dataTransfer&&e.dataTransfer.files;t&&t.length>0&&this.onDrop(t)},destroy:function(){this.container.removeEventListener("dragenter",this._handleDragEnter),this.container.removeEventListener("dragleave",this._handleDragLeave),this.container.removeEventListener("dragover",this._handleDragOver),this.container.removeEventListener("drop",this._handleDrop),this.container.removeAttribute("data-has-input-controller"),delete this.container.dataset.hasInputController}},e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Controllers=e.MeeWoo.Controllers||{},e.MeeWoo.Controllers.InputController=t}("undefined"!=typeof window?window:void 0),(o=window).MeeWoo=o.MeeWoo||{},o.MeeWoo.Components=o.MeeWoo.Components||{},function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Components=e.MeeWoo.Components||{},e.MeeWoo.Components.StandardMp4Panel={name:"StandardMp4Panel",template:"#tpl-standard-mp4-panel",props:{visible:{type:Boolean,default:!1},sourceInfo:{type:Object,default:function(){return{}}},initialConfig:{type:Object,default:function(){return null}},isConverting:{type:Boolean,default:!1},progress:{type:Number,default:0},message:{type:String,default:""},disabled:{type:Boolean,default:!1},currentModule:{type:String,default:"mp4"}},mounted:function(){console.log("StandardMp4Panel组件已挂载",this.visible)},watch:{visible:function(e){console.log("StandardMp4Panel visible变化:",e)}},data:function(){return{config:{width:300,height:300,fps:30}}},watch:{visible:function(e){e&&this.initParams()}},methods:{initParams:function(){var e=this.sourceInfo;if(this.initialConfig&&this.initialConfig.width>0){if(this.config.width=this.initialConfig.width,e.width&&e.height){var t=e.height/e.width;this.config.height=Math.floor(this.config.width*t)}}else this.config.width=e.width||300,this.config.height=e.height||300;this.initialConfig&&this.initialConfig.fps?this.config.fps=this.initialConfig.fps:this.config.fps=Math.min(60,Math.max(1,e.fps||30))},close:function(){if(this.isConverting){if(!confirm("正在转换中，确定要取消吗？"))return;this.$emit("cancel")}this.$emit("close")},onWidthChange:function(){var e=this.sourceInfo;if(e.width&&e.height){var t=e.height/e.width,i=Math.max(1,Math.min(3e3,parseInt(this.config.width)||0)),a=Math.floor(i*t);this.config.width=i,this.config.height=a}},onHeightChange:function(){var e=this.sourceInfo;if(e.width&&e.height){var t=e.width/e.height,i=Math.max(1,Math.min(3e3,parseInt(this.config.height)||0)),a=Math.floor(i*t);this.config.width=a,this.config.height=i}},startConvert:function(){this.$emit("convert",this.config)}}}}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Components=e.MeeWoo.Components||{},e.MeeWoo.Components.DualChannelPanel={name:"DualChannelPanel",template:'<div class="side-panel side-panel--right dual-channel-panel dual-channel-panel-root" :class="{\'show\': visible}"  style="transition: transform 0.3s ease;">\n      <div class="side-panel-container">\n        \x3c!-- 标题区 --\x3e\n        <div class="side-panel-header">\n          <h3 class="side-panel-title">转换为双通道MP4格式</h3>\n          <div class="side-panel-divider"></div>\n        </div>\n\n        \x3c!-- 信息区 --\x3e\n        <div class="mp4-info-section">\n          <div class="mp4-info-row">{{ sourceInfo.typeLabel }}尺寸：{{ sourceInfo.sizeWH }} 时长：{{ sourceInfo.duration }}</div>\n          <div class="mp4-compress-hint">注意：第一次转换需要加载FFmpeg（25M），请耐心等待<br>压缩质量调越低，文件就越小，画面越糊。</div>\n        </div>\n\n        \x3c!-- 配置区域 --\x3e\n        <div class="mp4-config-section" :class="{disabled: isConverting}">\n          \x3c!-- 遮罩位置 --\x3e\n          <div class="mp4-config-item">\n            <div class="mp4-config-label">遮罩位置：</div>\n            <div class="mp4-select-wrapper" :class="{open: showChannelModeDropdown, disabled: isConverting}"\n              @click="!isConverting && toggleChannelModeDropdown()">\n              <div class="mp4-select-text">\n                {{ config.channelMode === \'color-left-alpha-right\' ? \'左彩右灰\' : \'左灰右彩\' }}\n              </div>\n              <div class="mp4-select-icon">\n                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"\n                    stroke-linejoin="round" />\n                </svg>\n              </div>\n              \x3c!-- 下拉菜单 --\x3e\n              <div class="mp4-select-dropdown">\n                <div class="mp4-select-option" :class="{selected: config.channelMode === \'color-left-alpha-right\'}"\n                  @click.stop="selectChannelMode(\'color-left-alpha-right\')">\n                  左彩右灰（左侧彩色通道，右侧Alpha通道）\n                </div>\n                <div class="mp4-select-option" :class="{selected: config.channelMode === \'alpha-left-color-right\'}"\n                  @click.stop="selectChannelMode(\'alpha-left-color-right\')">\n                  左灰右彩（左侧Alpha通道，右侧彩色通道）\n                </div>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- 尺寸 --\x3e\n          <div class="mp4-config-item">\n            <div class="mp4-config-label">尺寸：</div>\n            <div class="mp4-size-container">\n              <div class="input-wrapper input-wrapper--lg mp4-size-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.width" @input="onWidthChange"\n                  :disabled="isConverting" min="0" max="3000" />\n              </div>\n              <div class="mp4-size-lock">\n                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <path\n                    d="M4.66667 7.33333V5.33333C4.66667 3.86057 5.86057 2.66667 7.33333 2.66667H8.66667C10.1394 2.66667 11.3333 3.86057 11.3333 5.33333V7.33333M5.33333 7.33333H10.6667C11.403 7.33333 12 7.93029 12 8.66667V12C12 12.7364 11.403 13.3333 10.6667 13.3333H5.33333C4.59695 13.3333 4 12.7364 4 12V8.66667C4 7.93029 4.59695 7.33333 5.33333 7.33333Z"\n                    stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />\n                </svg>\n              </div>\n              <div class="input-wrapper input-wrapper--lg mp4-size-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.height" @input="onHeightChange"\n                  :disabled="isConverting" min="0" max="3000" />\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- 压缩到质量 --\x3e\n          <div class="mp4-config-item">\n            <div class="mp4-config-label">压缩到质量：</div>\n            <div class="mp4-value-container">\n              <div class="input-wrapper input-wrapper--lg mp4-value-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.quality" :disabled="isConverting"\n                  min="1" max="100" />\n              </div>\n              <div class="input-unit">%</div>\n            </div>\n          </div>\n\n          \x3c!-- 帧率修改 --\x3e\n          <div class="mp4-config-item">\n            <div class="mp4-config-label">帧率修改：</div>\n            <div class="mp4-value-container">\n              <div class="input-wrapper input-wrapper--lg mp4-value-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.fps" :disabled="isConverting"\n                  min="1" max="120" />\n              </div>\n              <div class="input-unit">FPS</div>\n            </div>\n          </div>\n\n          \x3c!-- 静音 --\x3e\n          <div class="mp4-config-item">\n            <div class="mp4-config-label">静音</div>\n            <div class="mp4-mute-toggle" :class="{active: config.muted, disabled: isConverting}"\n              @click="!isConverting && (config.muted = !config.muted)">\n              <div class="mp4-mute-toggle-handle"></div>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- 底部按钮 --\x3e\n        <div class="side-panel-footer">\n          \x3c!-- 返回按钮（转换中变为取消按钮） --\x3e\n          <button v-if="!isConverting" class="material-btn-back" @click="close" title="返回">\n            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">\n              <path d="M12 16L6 10L12 4" stroke="#333333" stroke-width="2" stroke-linecap="round"\n                stroke-linejoin="round" />\n            </svg>\n            <span>取消</span>\n          </button>\n          <button v-else class="material-btn-back mp4-btn-cancel" @click="cancel" title="取消转换">\n            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">\n              <path d="M5 5L15 15M15 5L5 15" stroke="#ff4444" stroke-width="2" stroke-linecap="round"\n                stroke-linejoin="round" />\n            </svg>\n            <span>取消</span>\n          </button>\n\n          \x3c!-- 转换按钮 --\x3e\n          <button class="btn-large-secondary" :class="{mp4-btn-converting: isConverting}"\n            :data-progress="progress" :disabled="disabled" @click="start">\n            <template v-if="isConverting">\n              <span class="mp4-progress-text">{{ progress }}%</span>\n              <span class="mp4-stage-text">{{ message }}</span>\n            </template>\n            <template v-else>\n              开始转换双通道MP4\n            </template>\n          </button>\n        </div>\n      </div>\n    </div>',props:{visible:{type:Boolean,default:!1},sourceInfo:{type:Object,default:function(){return{}}},initialConfig:{type:Object,default:function(){return null}},isConverting:{type:Boolean,default:!1},progress:{type:Number,default:0},message:{type:String,default:""},disabled:{type:Boolean,default:!1}},data:function(){return{config:{channelMode:"color-left-alpha-right",width:300,height:300,fps:30,quality:80,muted:!1},showChannelModeDropdown:!1}},watch:{visible:{immediate:!0,handler:function(e){e&&this.initParams()}}},methods:{forceShowPanel:function(){},initParams:function(){var e=this.sourceInfo;if(this.initialConfig&&this.initialConfig.width>0){if(this.config.width=this.initialConfig.width,this.initialConfig.height>0){var t=this.initialConfig.height/this.initialConfig.width;this.config.height=Math.floor(this.config.width*t)}else if(e.width&&e.height){t=e.height/e.width;this.config.height=Math.floor(this.config.width*t)}}else e.width&&e.height?(this.config.width=e.width,this.config.height=e.height):(this.config.width=300,this.config.height=300);this.initialConfig&&this.initialConfig.fps?this.config.fps=this.initialConfig.fps:e.fps?this.config.fps=Math.min(60,Math.max(1,e.fps)):this.config.fps=30,this.initialConfig&&(this.config.quality=this.initialConfig.quality||80,this.config.muted=this.initialConfig.muted||!1,this.config.channelMode=this.initialConfig.channelMode||"color-left-alpha-right")},close:function(){if(this.isConverting){if(!confirm("正在转换中，确定要取消吗？"))return;this.$emit("cancel")}this.$emit("close")},onWidthChange:function(){var e=this.sourceInfo;if(e.width&&e.height){var t=e.height/e.width,i=Math.max(1,Math.min(3e3,parseInt(this.config.width)||0)),a=Math.floor(i*t);this.config.width=i,this.config.height=a}},onHeightChange:function(){var e=this.sourceInfo;if(e.width&&e.height){var t=e.width/e.height,i=Math.max(1,Math.min(3e3,parseInt(this.config.height)||0)),a=Math.floor(i*t);this.config.width=a,this.config.height=i}},startConvert:function(){this.$emit("convert",this.config)},start:function(){this.startConvert()},cancel:function(){this.$emit("cancel")},toggleChannelModeDropdown:function(){this.showChannelModeDropdown=!this.showChannelModeDropdown},selectChannelMode:function(e){this.config.channelMode=e,this.showChannelModeDropdown=!1}}},console.log("=== 执行Vue组件注册 ==="),function t(){window.Vue?(console.log("=== 注册Vue组件：开始 ==="),console.log("Vue版本:",Vue.version),console.log("注册前Vue.options.components:",Object.keys(Vue.options.components)),Vue.component("dual-channel-panel",e.MeeWoo.Components.DualChannelPanel),console.log("注册后Vue.options.components:",Object.keys(Vue.options.components)),console.log("双通道面板组件是否注册成功:",void 0!==Vue.options.components["dual-channel-panel"]),console.log("=== 注册Vue组件：完成 ===")):(console.log("=== 注册Vue组件：Vue还没加载，延迟500ms重试 ==="),setTimeout(t,500))}()}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Components=e.MeeWoo.Components||{},e.MeeWoo.Components.MaterialPanel={template:"#tpl-material-panel",props:{visible:{type:Boolean,default:!1},list:{type:Array,default:function(){return[]}},replacedImages:{type:Object,default:function(){return{}}},thumbBgColor:{type:String,default:"#fcfcfc"},svgaFileInfo:{type:Object,default:function(){return{}}},isCompressing:{type:Boolean,default:!1},compressProgress:{type:Number,default:0},hasCompressed:{type:Boolean,default:!1},materialEditStates:{type:Object,default:function(){return{}}}},data:function(){return{searchQuery:""}},computed:{filteredList:function(){if(!this.searchQuery)return this.list;var e=this.searchQuery.toLowerCase();return this.list.filter(function(t){return-1!==t.imageKey.toLowerCase().indexOf(e)})}},methods:{close:function(){this.$emit("close")},copyName:function(t){var i=e.MeeWoo.Utils;i&&i.copyToClipboard&&i.copyToClipboard(t).then(function(){i.showToast&&i.showToast("已复制到剪贴板")}).catch(function(e){alert("复制失败: "+e.message)})},triggerReplace:function(e){var t=this.list.indexOf(e);-1!==t&&this.$emit("replace",t)},triggerRestore:function(e){var t=this.list.indexOf(e);-1!==t&&this.$emit("restore",t)},triggerDownload:function(e){var t=this.list.indexOf(e);-1!==t&&this.$emit("download",t)},triggerEdit:function(e){this.$emit("edit",e)},triggerCompress:function(){this.$emit("compress")}}}}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Components=e.MeeWoo.Components||{},e.MeeWoo.Components.GifPanel={name:"GifPanel",template:"#tpl-gif-panel",props:{visible:{type:Boolean,default:!1},sourceInfo:{type:Object,default:function(){return{}}},initialConfig:{type:Object,default:function(){return null}},bgColorKey:{type:String,default:"transparent"},currentBgColor:{type:String,default:"#ffffff"},isExporting:{type:Boolean,default:!1},exportProgress:{type:Number,default:0},exportStage:{type:String,default:""},exportMessage:{type:String,default:""},disabled:{type:Boolean,default:!1}},data:function(){return{config:{width:300,height:300,fps:30,quality:10,transparent:!1,dither:!1,ditherColor:"#ffffff"}}},watch:{visible:function(e){e&&this.initParams()},config:{handler:function(e){this.$emit("config-change",e)},deep:!0}},methods:{initParams:function(){var e=this.sourceInfo;if(this.initialConfig&&this.initialConfig.width>0){if(this.config.width=this.initialConfig.width,e.width&&e.height){var t=e.height/e.width;this.config.height=Math.floor(this.config.width*t)}}else this.config.width=e.width||300,this.config.height=e.height||300;this.initialConfig&&this.initialConfig.fps?this.config.fps=this.initialConfig.fps:this.config.fps=Math.min(60,Math.max(1,e.fps||30)),this.initialConfig&&(this.initialConfig.quality&&(this.config.quality=this.initialConfig.quality),void 0!==this.initialConfig.transparent&&(this.config.transparent=this.initialConfig.transparent),void 0!==this.initialConfig.dither&&(this.config.dither=this.initialConfig.dither))},close:function(){if(this.isExporting){if(!confirm("正在导出中，确定要取消吗？"))return;this.$emit("cancel")}this.$emit("close")},onWidthChange:function(){var e=this.sourceInfo;if(e.width&&e.height){var t=e.height/e.width,i=Math.max(1,Math.min(1920,parseInt(this.config.width)||0)),a=Math.floor(i*t);this.config.width=i,this.config.height=a}},onHeightChange:function(){var e=this.sourceInfo;if(e.width&&e.height){var t=e.width/e.height,i=Math.max(1,Math.min(1920,parseInt(this.config.height)||0)),a=Math.floor(i*t);this.config.width=a,this.config.height=i}},startExport:function(){this.$emit("export",this.config)}}}}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Components=e.MeeWoo.Components||{},e.MeeWoo.Components.FramesPanel={name:"FramesPanel",template:"#tpl-frames-panel",props:{visible:{type:Boolean,default:!1},sourceInfo:{type:Object,default:()=>({})},initialConfig:{type:Object,default:()=>({})},isExporting:{type:Boolean,default:!1},exportProgress:{type:Number,default:0},exportStage:{type:String,default:""},exportMessage:{type:String,default:""},disabled:{type:Boolean,default:!1}},data:()=>({config:{width:0,height:0,fps:24,quality:80,transparent:!1},aspectRatio:1}),watch:{visible(e){e&&this.initConfig()},initialConfig:{handler(e){this.visible&&this.initConfig()},deep:!0}},methods:{initConfig(){this.config={width:this.initialConfig.width||this.sourceInfo.width||0,height:this.initialConfig.height||this.sourceInfo.height||0,fps:this.initialConfig.fps||this.sourceInfo.fps||24,quality:this.initialConfig.quality||80,transparent:this.initialConfig.transparent||!1},this.config.width>0&&this.config.height>0&&(this.aspectRatio=this.config.width/this.config.height)},onWidthChange(){this.config.width=Math.max(1,Math.min(3e3,parseInt(this.config.width)||0)),this.config.width>0&&(this.config.height=Math.round(this.config.width/this.aspectRatio),this.config.height=Math.max(1,Math.min(3e3,this.config.height)),this.$emit("config-change",this.config))},onHeightChange(){this.config.height=Math.max(1,Math.min(3e3,parseInt(this.config.height)||0)),this.config.height>0&&(this.config.width=Math.round(this.config.height*this.aspectRatio),this.config.width=Math.max(1,Math.min(3e3,this.config.width)),this.$emit("config-change",this.config))},onFpsChange(){this.config.fps=Math.max(1,Math.min(60,parseInt(this.config.fps)||0)),this.$emit("config-change",this.config)},onQualityChange(){this.config.quality=Math.max(10,Math.min(100,parseInt(this.config.quality)||0)),this.$emit("config-change",this.config)},startExport(){this.$emit("export",this.config)},close(){this.$emit("close")}},mounted(){this.visible&&this.initConfig()}}}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Components=e.MeeWoo.Components||{},e.MeeWoo.Components.WebpPanel={name:"WebpPanel",template:"#tpl-webp-panel",props:{visible:{type:Boolean,default:!1},sourceInfo:{type:Object,default:()=>({})},initialConfig:{type:Object,default:()=>({})},isExporting:{type:Boolean,default:!1},exportProgress:{type:Number,default:0},exportStage:{type:String,default:""},exportMessage:{type:String,default:""},disabled:{type:Boolean,default:!1}},data:()=>({config:{width:0,height:0,fps:24},aspectRatio:1}),watch:{visible(e){console.log("[调试] webp-panel visible属性变化:",e),e&&this.initConfig()},initialConfig:{handler(e){this.visible&&this.initConfig()},deep:!0}},methods:{initConfig(){this.config={width:this.initialConfig.width||this.sourceInfo.width||0,height:this.initialConfig.height||this.sourceInfo.height||0,fps:this.initialConfig.fps||this.sourceInfo.fps||24},this.config.width>0&&this.config.height>0&&(this.aspectRatio=this.config.width/this.config.height)},onWidthChange(){this.config.width=Math.max(1,Math.min(3e3,parseInt(this.config.width)||0)),this.config.width>0&&(this.config.height=Math.round(this.config.width/this.aspectRatio),this.config.height=Math.max(1,Math.min(3e3,this.config.height)),this.$emit("config-change",this.config))},onHeightChange(){this.config.height=Math.max(1,Math.min(3e3,parseInt(this.config.height)||0)),this.config.height>0&&(this.config.width=Math.round(this.config.height*this.aspectRatio),this.config.width=Math.max(1,Math.min(3e3,this.config.width)),this.$emit("config-change",this.config))},onFpsChange(){this.config.fps=Math.max(1,Math.min(60,parseInt(this.config.fps)||0)),this.$emit("config-change",this.config)},startExport(){this.$emit("export",this.config)},close(){this.$emit("close")}},mounted(){console.log("[调试] webp-panel 组件已挂载，初始visible:",this.visible),console.log("[调试] webp-panel 组件DOM元素:",this.$el),this.visible&&this.initConfig()}}}(window),window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Components=window.MeeWoo.Components||{},window.MeeWoo.Components.ToSvgaPanel={template:'\n    <div class="side-panel side-panel--right to-svga-panel" :class="{\'show\': visible}">\n      <div class="side-panel-container">\n        \x3c!-- 标题区 --\x3e\n        <div class="side-panel-header">\n          <h3 class="side-panel-title">转换为SVGA动画格式</h3>\n          <div class="side-panel-divider"></div>\n        </div>\n\n        \x3c!-- 信息区 --\x3e\n        <div class="svga-info-section">\n          <div class="svga-info-row">{{ sourceInfo.typeLabel }}尺寸：{{ sourceInfo.sizeWH }} 帧率：{{ sourceInfo.fps }} 时长：{{ sourceInfo.duration }}</div>\n          <div class="svga-compress-hint">注意：帧率过高文件将巨大，内存占用将巨大。转SVGA是序列帧形式，内存占用会比普通SVGA高很多。</div>\n        </div>\n\n        \x3c!-- 配置区域 --\x3e\n        <div class="svga-config-section" :class="{disabled: isConverting}">\n          \x3c!-- 尺寸 --\x3e\n          <div class="svga-config-item">\n            <div class="svga-config-label">尺寸：</div>\n            <div class="svga-size-container">\n              <div class="input-wrapper input-wrapper--lg svga-size-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.width" @input="onWidthChange"\n                  :disabled="isConverting" min="1" max="3000" />\n              </div>\n              <div class="svga-size-lock">\n                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <path\n                    d="M4.66667 7.33333V5.33333C4.66667 3.86057 5.86057 2.66667 7.33333 2.66667H8.66667C10.1394 2.66667 11.3333 3.86057 11.3333 5.33333V7.33333M5.33333 7.33333H10.6667C11.403 7.33333 12 7.93029 12 8.66667V12C12 12.7364 11.403 13.3333 10.6667 13.3333H5.33333C4.59695 13.3333 4 12.7364 4 12V8.66667C4 7.93029 4.59695 7.33333 5.33333 7.33333Z"\n                    stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />\n                </svg>\n              </div>\n              <div class="input-wrapper input-wrapper--lg svga-size-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.height" @input="onHeightChange"\n                  :disabled="isConverting" min="1" max="3000" />\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- 压缩到质量 --\x3e\n          <div class="svga-config-item">\n            <div class="svga-config-label">压缩到质量：</div>\n            <div class="svga-value-container">\n              <div class="input-wrapper input-wrapper--lg svga-value-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.quality" :disabled="isConverting"\n                  min="10" max="100" />\n              </div>\n              <div class="input-unit">%</div>\n            </div>\n          </div>\n\n          \x3c!-- 帧率修改 --\x3e\n          <div class="svga-config-item">\n            <div class="svga-config-label">帧率修改：</div>\n            <div class="svga-value-container">\n              <div class="input-wrapper input-wrapper--lg svga-value-input-wrapper">\n                <input type="number" class="base-input" v-model.number="config.fps" :disabled="isConverting"\n                  min="1" max="60" />\n              </div>\n              <div class="input-unit">FPS</div>\n            </div>\n          </div>\n\n          \x3c!-- 静音 --\x3e\n          <div class="svga-config-item">\n            <div class="svga-config-label">静音</div>\n            <div class="svga-mute-toggle" :class="{active: config.muted, disabled: isConverting}"\n              @click="!isConverting && (config.muted = !config.muted)">\n              <div class="svga-mute-toggle-handle"></div>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- 预估对比区域 --\x3e\n        <div class="svga-estimate-section" v-if="estimateInfo">\n          <div class="svga-estimate-box">\n            <div class="svga-estimate-title">预估转换后：</div>\n            <div class="svga-estimate-row">内存占用： {{ estimateInfo.afterMemory || \'--\' }}</div>\n            <div class="svga-estimate-row">文件大小：{{ estimateInfo.beforeFileSize ? estimateInfo.beforeFileSize + \' → \' : \'\' }}{{ estimateInfo.afterFileSize || \'--\' }}</div>\n          </div>\n        </div>\n\n        \x3c!-- 底部按钮 --\x3e\n        <div class="side-panel-footer">\n          \x3c!-- 返回按钮（转换中变为取消按钮） --\x3e\n          <button v-if="!isConverting" class="material-btn-back" @click="close" title="返回">\n            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">\n              <path d="M12 16L6 10L12 4" stroke="#333333" stroke-width="2" stroke-linecap="round"\n                stroke-linejoin="round" />\n            </svg>\n            <span>取消</span>\n          </button>\n          <button v-else class="material-btn-back svga-btn-cancel" @click="cancel" title="取消转换">\n            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">\n              <path d="M5 5L15 15M15 5L5 15" stroke="#ff4444" stroke-width="2" stroke-linecap="round"\n                stroke-linejoin="round" />\n            </svg>\n            <span>取消</span>\n          </button>\n\n          \x3c!-- 转换按钮 --\x3e\n          <button class="btn-large-secondary" :class="{\'svga-btn-converting\': isConverting}"\n            :data-progress="progress" :disabled="disabled" @click="start">\n            <template v-if="isConverting">\n              <span class="svga-progress-text">{{ progress }}%</span>\n              <span class="svga-stage-text">{{ message }}</span>\n            </template>\n            <template v-else>\n              开始转换SVGA\n            </template>\n          </button>\n        </div>\n      </div>\n    </div>\n  ',props:{visible:{type:Boolean,default:!1},sourceInfo:{type:Object,default:function(){return{sizeWH:"",duration:"",fps:"",typeLabel:""}}},initialConfig:{type:Object,default:null},estimateInfo:{type:Object,default:null},isConverting:{type:Boolean,default:!1},progress:{type:Number,default:0},message:{type:String,default:""},disabled:{type:Boolean,default:!1}},data:function(){return{config:{width:0,height:0,quality:80,fps:30,muted:!1,aspectRatio:1}}},watch:{visible:function(e){e&&this.initialConfig&&(this.config=JSON.parse(JSON.stringify(this.initialConfig)),this.config.width&&this.config.height&&(this.config.aspectRatio=this.config.width/this.config.height))}},methods:{close:function(){this.$emit("close")},cancel:function(){this.$emit("cancel")},start:function(){this.$emit("convert",this.config)},onWidthChange:function(){var e=this.config.width;e>0&&this.config.aspectRatio>0&&(this.config.height=Math.round(e/this.config.aspectRatio))},onHeightChange:function(){var e=this.config.height;e>0&&this.config.aspectRatio>0&&(this.config.width=Math.round(e*this.config.aspectRatio))}}},window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Components=window.MeeWoo.Components||{},window.MeeWoo.Components.ChromaKeyPanel={template:'\n\n    <div class="side-panel side-panel--left chromakey-panel" :class="{\'show\': visible}">\n      <div class="side-panel-container">\n        \x3c!-- 标题区 --\x3e\n        <div class="side-panel-header">\n          <h3 class="side-panel-title">扣掉画面绿幕成透明</h3>\n          <div class="side-panel-divider"></div>\n        </div>\n\n        \x3c!-- 信息区 --\x3e\n        <div class="chromakey-info-section">\n          <div class="chromakey-info-row">MP4尺寸：{{ sourceInfo.sizeWH }} 时长：{{ sourceInfo.duration }}</div>\n          <div class="chromakey-performance-hint">打开绿幕抠图，播放会比较卡，因为是实时渲染抠图效果</div>\n        </div>\n\n        \x3c!-- 设置区域 --\x3e\n        <div class="chromakey-config-section">\n          \x3c!-- 打开扮绿幕开关 --\x3e\n          <div class="chromakey-config-item">\n            <div class="chromakey-config-label">打开绿幕抠图：</div>\n            <div class="chromakey-switch-wrapper" @click="toggleEnabled">\n              <div class="chromakey-switch" :class="{active: enabled}">\n                <div class="chromakey-switch-handle"></div>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- 相似度滑块 --\x3e\n          <div class="chromakey-config-item" v-if="enabled">\n            <div class="chromakey-config-label">相似度：{{ similarity }}</div>\n            <div class="chromakey-slider-wrapper">\n              <input type="range" class="chromakey-slider" :value="similarity" min="0" max="100"\n                step="1" @input="updateSimilarity" />\n            </div>\n          </div>\n\n          \x3c!-- 平滑度滑块 --\x3e\n          <div class="chromakey-config-item" v-if="enabled">\n            <div class="chromakey-config-label">平滑度：{{ smoothness }}</div>\n            <div class="chromakey-slider-wrapper">\n              <input type="range" class="chromakey-slider" :value="smoothness" min="0" max="100"\n                step="1" @input="updateSmoothness" />\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- 底部按钮 --\x3e\n        <div class="side-panel-footer">\n          \x3c!-- 确定按钮 --\x3e\n          <button class="btn-large-secondary" @click="apply">\n            确定\n          </button>\n        </div>\n      </div>\n    </div>\n  ',props:{visible:{type:Boolean,default:!1},sourceInfo:{type:Object,default:function(){return{sizeWH:"",duration:""}}},enabled:{type:Boolean,default:!1},similarity:{type:Number,default:40},smoothness:{type:Number,default:10}},methods:{toggleEnabled:function(){this.$emit("toggle")},updateSimilarity:function(e){this.$emit("update:similarity",parseInt(e.target.value)),this.$emit("update-effect")},updateSmoothness:function(e){this.$emit("update:smoothness",parseInt(e.target.value)),this.$emit("update-effect")},apply:function(){this.$emit("apply")}}},function(e){function t(e){this.state=e}if(e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Controllers=e.MeeWoo.Controllers||{},t.prototype={play:function(){throw new Error("子类必须实现 play")},pause:function(){throw new Error("子类必须实现 pause")},seekTo:function(e){throw new Error("子类必须实现 seekTo")},setMuted:function(e){throw new Error("子类必须实现 setMuted")},setVolume:function(e){throw new Error("子类必须实现 setVolume")},canHandle:function(){return this.state.hasFile},transformPercentage:function(e){return e},updateState:function(e){this.state=e}},"undefined"!=typeof Howl)l.init();else var i=setInterval(function(){"undefined"!=typeof Howl&&(l.init(),clearInterval(i))},100);function a(e){t.call(this,e)}function o(e,i){t.call(this,e),this.video=i}function n(e){o.call(this,e,e.yyevaVideo)}function r(e){o.call(this,e,e.mp4Video)}function s(e){t.call(this,e)}a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype.canHandle=function(){return this.state.hasFile&&this.state.lottiePlayer},a.prototype.play=function(){this.state.lottiePlayer.play()},a.prototype.pause=function(){this.state.lottiePlayer.pause()},a.prototype.seekTo=function(e){var t=(this.state.lottiePlayer&&this.state.lottiePlayer.firstFrame||0)+Math.round(e*this.state.totalFrames);this.state.isPlaying?this.state.lottiePlayer.goToAndPlay(t,!0):this.state.lottiePlayer.goToAndStop(t,!0)},a.prototype.setMuted=function(e){},a.prototype.setVolume=function(e){},o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype.canHandle=function(){return this.state.hasFile&&this.video},o.prototype.play=function(){var e=this;return this.video.play().then(function(){e.afterPlay()}).catch(function(e){console.error("播放失败:",e)})},o.prototype.pause=function(){this.video.pause(),this.afterPause()},o.prototype.seekTo=function(e){var t=this.transformPercentage(e),i=this.video.duration||1;this.video.currentTime=t*i},o.prototype.setMuted=function(e){this.video.muted=e},o.prototype.setVolume=function(e){e=Math.max(0,Math.min(1,e)),this.video.volume=e},o.prototype.afterPlay=function(){},o.prototype.afterPause=function(){},n.prototype=Object.create(o.prototype),n.prototype.constructor=n,n.prototype.afterPlay=function(){this.state.startYyevaRenderLoop&&this.state.startYyevaRenderLoop()},n.prototype.afterPause=function(){this.state.yyevaAnimationId&&(cancelAnimationFrame(this.state.yyevaAnimationId),this.state.yyevaAnimationId=null)},n.prototype.seekTo=function(e){if(o.prototype.seekTo.call(this,e),this.state.renderYyevaFrame){var t=this,i=function(){t.state.renderYyevaFrame(),t.video.removeEventListener("seeked",i)};this.video.seeking?this.video.addEventListener("seeked",i):this.state.renderYyevaFrame()}},r.prototype=Object.create(o.prototype),r.prototype.constructor=r,r.prototype.afterPlay=function(){this.state.startMp4ProgressLoop&&this.state.startMp4ProgressLoop()},r.prototype.afterPause=function(){this.state.stopMp4ProgressLoop&&this.state.stopMp4ProgressLoop()},r.prototype.transformPercentage=function(e){if(!this.state.speedRemapConfig||!this.state.speedRemapConfig.enabled||!this.state.speedRemapConfig.keyframes||this.state.speedRemapConfig.keyframes.length<2)return e;for(var t=this.state.speedRemapConfig.keyframes,i=this.state.speedRemapConfig.originalTotalFrames||this.state.totalFrames,a=e*t[t.length-1].position,o=0,n=0;n<t.length-1;n++){var r=t[n],s=t[n+1];if(a>=r.position&&a<=s.position){var l=s.position-r.position;if(l>0){var h=(a-r.position)/l;o=r.originalFrame+h*(s.originalFrame-r.originalFrame)}else o=r.originalFrame;break}}return o/i},s.prototype=Object.create(t.prototype),s.prototype.constructor=s,s.prototype.play=function(){this.state.startFramesPlayLoop&&this.state.startFramesPlayLoop()},s.prototype.pause=function(){this.state.stopFramesPlayLoop&&this.state.stopFramesPlayLoop()},s.prototype.seekTo=function(e){var t=Math.round(e*(this.state.totalFrames-1));this.state.seekFramesTo&&this.state.seekFramesTo(t)},s.prototype.setMuted=function(e){},s.prototype.setVolume=function(e){};var l={instances:[],initialized:!1,init:function(){this.initialized=!0},add:function(e){if(e&&(this.instances||(this.instances=[]),-1===this.instances.indexOf(e))){this.instances.push(e);var t=this;if("function"==typeof e.on)try{"object"==typeof e._events&&e.on("unload",function(){t.remove(e)})}catch(i){}}},remove:function(e){var t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1)},stopAll:function(){this.instances.forEach(function(e){e.playing()&&e.stop()})},pauseAll:function(){this.instances.forEach(function(e){e.playing()&&e.pause()})},muteAll:function(e){this.instances.forEach(function(t){t.mute(e)})},setVolume:function(e){e=Math.max(0,Math.min(1,e)),this.instances.forEach(function(t){t.volume(e)})},getVolume:function(){return this.instances.length>0?this.instances[0].volume():1},unloadAll:function(){this.instances.slice().forEach(function(e){try{e.unload()}catch(t){console.warn("Unload error:",t)}}),this.instances=[]}};function h(e){t.call(this,e),l.init(),this.audioCache={}}function c(e){this.options=e||{},this.onProgressChange=e.onProgressChange||function(){},this.onVolumeChange=e.onVolumeChange||function(){};var t=e.onPlayStateChange||function(){},i=this;this.onPlayStateChange=function(e){i.handlePlayStateChange(e),t(e)},this.getPlayerState=e.getPlayerState||function(){return{}},this.isDragging=!1,this.progressBar=null,this.progressThumb=null,this.isVolumeDragging=!1,this.volumeBar=null,this.volumeThumb=null,this.currentAdapter=null,this.currentMode=null,this.getAdapter=this.getAdapter.bind(this),this.handlePlayStateChange=this.handlePlayStateChange.bind(this),e.progressBar&&e.progressThumb&&this.initProgressDrag(e.progressBar,e.progressThumb),e.volumeBar&&e.volumeThumb&&this.initVolumeDrag(e.volumeBar,e.volumeThumb)}h.prototype=Object.create(t.prototype),h.prototype.constructor=h,h.prototype.canHandle=function(){return this.state.hasFile&&this.state.svgaPlayer},h.prototype.play=function(){try{var e=(this.state.progress||0)/100;l.stopAll(),this.state.svgaPlayer.stepToPercentage(e,!0);var t=e*this.state.totalFrames;this.syncAudio(t),l.muteAll(this.state.isMuted)}catch(i){console.error("播放失败:",i)}},h.prototype.pause=function(){try{this.state.svgaPlayer.pauseAnimation(),l.stopAll()}catch(e){console.error("暂停失败:",e)}},h.prototype.seekTo=function(e,t){try{l.stopAll();var i=this.state.isPlaying&&!t;if(this.state.svgaPlayer.stepToPercentage(e,i),i){var a=e*this.state.totalFrames;this.syncAudio(a),l.muteAll(this.state.isMuted)}}catch(o){console.error("跳转失败:",o)}},h.prototype.syncAudio=function(e){if(this.state.isPlaying){var t=this.state.svgaAudios;if(t&&t.length){this._hasWarnedNoAudio=!1;var i=this.state.videoItem.FPS||30,a=this;t.forEach(function(t){var o="number"==typeof t.startFrame?t.startFrame:0,n="number"==typeof t.endFrame?t.endFrame:0;if(0===n&&(n=a.state.totalFrames||999999),e>=o&&e<n){var r=a.getHowlInstance(t.audioKey);if(r){if(!r.playing()){var s=(e-o)/i,l=(t.startTime||0)/1e3,h=Math.max(0,l+s);r.seek(h),r.play(),r.mute(a.state.isMuted)}}else console.warn("Howl instance not found for:",t.audioKey)}else if(a.audioCache[t.audioKey]){var c=a.audioCache[t.audioKey];c.playing()&&c.stop()}})}}},h.prototype.getHowlInstance=function(e){if(this.audioCache[e])return this.audioCache[e];var t=this.state.svgaAudioData||{},i=this.state.videoItem,a=i&&i.images?i.images:{},o=[e,e+".mp3",e+".wav","audio_"+e,e.replace(/\.[^.]+$/,""),"audio_"+e.replace(/\.[^.]+$/,"")];e.endsWith(".mp3")&&o.push(e.replace(".mp3",""));for(var n=null,r=0;r<o.length;r++)if(t[o[r]]){n=t[o[r]];break}if(!n&&a)for(r=0;r<o.length;r++)if(a[o[r]]){n=a[o[r]];break}if(!n)for(var s=Object.keys(t),h=0;h<s.length;h++){var c=s[h];if(c.length>3&&e.length>3&&(-1!==c.indexOf(e)||-1!==e.indexOf(c))){n=t[c];break}}if(!n)return null;var d=null;if("string"==typeof n)d=n.startsWith("data:")?n:"data:audio/mp3;base64,"+n;else if(n instanceof Uint8Array){var g=new Blob([n],{type:"audio/mp3"});d=URL.createObjectURL(g)}if(!d)return null;var f=new Howl({src:[d],format:["mp3","wav"],html5:!1,loop:!1,autoplay:!1,volume:l.getVolume(),onload:function(){},onloaderror:function(t,i){console.error("Howl Load Error:",i,"for key:",e)},onplayerror:function(t,i){console.error("Howl Play Error:",i,"for key:",e),"undefined"!=typeof Howler&&Howler.ctx&&"suspended"===Howler.ctx.state&&Howler.ctx.resume()}});return l.add(f),this.audioCache[e]=f,f},h.prototype.setMuted=function(e){l.muteAll(e)},h.prototype.setVolume=function(e){l.setVolume(e)},h.prototype.destroy=function(){l.unloadAll(),this.audioCache={}},c.prototype.getAdapter=function(){var e=this.getPlayerState(),t=e.mode;if(this.currentAdapter&&this.currentMode===t)return this.currentAdapter.updateState(e),this.currentAdapter;this.currentAdapter&&(this.currentAdapter.destroy&&this.currentAdapter.destroy(),this.currentAdapter=null);var i=null;switch(t){case"lottie":i=new a(e);break;case"yyeva":i=new n(e);break;case"mp4":i=new r(e);break;case"frames":i=new s(e);break;case"svga":i=new h(e)}return i&&i.canHandle()?(this.currentAdapter=i,this.currentMode=t,i):null},c.prototype.togglePlay=function(){var e=this.getPlayerState(),t=this.getAdapter();if(t)try{e.isPlaying?(t.pause(),this.onPlayStateChange(!1)):(t.play(),this.onPlayStateChange(!0))}catch(i){console.error("播放控制失败:",i)}},c.prototype.seekTo=function(e,t){e=Math.max(0,Math.min(1,e));var i=this.getPlayerState(),a=this.getAdapter();if(a)try{var o=Math.round(100*e),n=a.transformPercentage(e),r=Math.round(n*i.totalFrames);this.onProgressChange(o,r),a instanceof h?a.seekTo(e,t):a.seekTo(e)}catch(s){console.error("跳转失败:",s)}},c.prototype.setMuted=function(e){var t=this.getAdapter();if(t)try{t.setMuted(e)}catch(i){console.error("设置静音失败:",i)}},c.prototype.setVolume=function(e){var t=this.getAdapter();if(t)try{t.setVolume(e)}catch(i){console.error("设置音量失败:",i)}},c.prototype.step=function(e){var t=this.getPlayerState(),i=t.totalDuration||0,a=t.currentTime||0;if(!(i<2)){var o=a+(i<10?1:i<=60?2:5)*e;if(o<0&&(o=0),o>i&&(o=i),i>0){var n=o/i;this.seekTo(n)}}},c.prototype.syncAudio=function(e){var t=this.getAdapter();t&&t instanceof h&&t.syncAudio&&t.syncAudio(e)},c.prototype.handlePlayStateChange=function(e){var t=this.currentAdapter;t&&t instanceof h&&(e||t.pause())},c.prototype.initProgressDrag=function(e,t){var i=this;this.progressBar=e,this.progressThumb=t;var a,o,n,r=function(e){e.preventDefault(),i.isDragging=!0,i.wasPlaying=i.getPlayerState().isPlaying,c(e,!0),document.addEventListener("mousemove",l),document.addEventListener("mouseup",h),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",h)},s=(a=function(e){c(e,!0)},o=50,function(){var e=arguments;n||(a.apply(this,e),n=!0,setTimeout(function(){n=!1},o))}),l=function(e){i.isDragging&&(e.preventDefault(),s(e))},h=function(){if(i.isDragging=!1,document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",h),document.removeEventListener("touchmove",l),document.removeEventListener("touchend",h),i.wasPlaying){var e=i.getAdapter();e&&e.play()}},c=function(e,t){var a=e.clientX||e.touches&&e.touches[0]&&e.touches[0].clientX;if(a){var o=i.progressBar.getBoundingClientRect(),n=(a-o.left)/o.width;i.seekTo(n,t)}};t.addEventListener("mousedown",r),t.addEventListener("touchstart",r,{passive:!1});var d=function(e){e.target===t||t.contains(e.target)||c(e,!1)};e.addEventListener("click",d),this._cleanupDrag=function(){t.removeEventListener("mousedown",r),t.removeEventListener("touchstart",r),e.removeEventListener("click",d),h()}},c.prototype.initVolumeDrag=function(e,t){var i=this;this.volumeBar=e,this.volumeThumb=t;var a,o,n,r=function(e){e.preventDefault(),i.isVolumeDragging=!0,c(e),document.addEventListener("mousemove",l),document.addEventListener("mouseup",h),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",h)},s=(a=function(e){c(e)},o=50,function(){var e=arguments;n||(a.apply(this,e),n=!0,setTimeout(function(){n=!1},o))}),l=function(e){i.isVolumeDragging&&(e.preventDefault(),s(e))},h=function(){i.isVolumeDragging=!1,document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",h),document.removeEventListener("touchmove",l),document.removeEventListener("touchend",h)},c=function(e,t){var a=e.clientY||e.touches&&e.touches[0]&&e.touches[0].clientY;if(a){var o=i.volumeBar.getBoundingClientRect(),n=a-o.top,r=1-Math.max(0,Math.min(1,n/o.height)),s=Math.round(100*r)/100;i.onVolumeChange(s),i.setVolume(s)}};t.addEventListener("mousedown",r),t.addEventListener("touchstart",r,{passive:!1});var d=function(e){e.target===t||t.contains(e.target)||c(e)};e.addEventListener("click",d),this._cleanupVolumeDrag=function(){t.removeEventListener("mousedown",r),t.removeEventListener("touchstart",r),e.removeEventListener("click",d),h()}},c.prototype.destroy=function(){this.currentAdapter&&(this.currentAdapter.destroy&&this.currentAdapter.destroy(),this.currentAdapter=null),this.currentMode=null,this._cleanupDrag&&(this._cleanupDrag(),this._cleanupDrag=null),this.progressBar=null,this.progressThumb=null,this._cleanupVolumeDrag&&(this._cleanupVolumeDrag(),this._cleanupVolumeDrag=null),this.volumeBar=null,this.volumeThumb=null},e.MeeWoo.Controllers.PlayerController=c,e.MeeWoo.Controllers.GlobalAudioManager=l}("undefined"!=typeof window?window:void 0),function(e){function t(e){this.options=e||{},this.getContentSize=e.getContentSize||function(){return null},this.onViewportChange=e.onViewportChange||function(){},this.scale=1,this.offsetX=0,this.offsetY=0,this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.dragStartOffsetX=0,this.dragStartOffsetY=0,this.headerHeight=e.headerHeight||36,this.footerHeight=e.footerHeight||190,this.defaultScreenHeightRatio=e.screenHeightRatio||.75,this.minScale=e.minScale||.1,this.maxScale=e.maxScale||5,this.zoomStep=e.zoomStep||.1}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Controllers=e.MeeWoo.Controllers||{},t.prototype.handleMouseDown=function(e){0!==e.button&&1!==e.button||(e.preventDefault(),this.isDragging=!0,this.dragStartX=e.clientX,this.dragStartY=e.clientY,this.dragStartOffsetX=this.offsetX,this.dragStartOffsetY=this.offsetY,this.onViewportChange(this.scale,this.offsetX,this.offsetY,this.isDragging))},t.prototype.handleMouseMove=function(e){if(this.isDragging){e.preventDefault();var t=e.clientX-this.dragStartX,i=e.clientY-this.dragStartY,a=this.dragStartOffsetX+t,o=this.dragStartOffsetY+i;this.setOffset(a,o,!0)}},t.prototype.handleMouseUp=function(e){this.isDragging&&(this.isDragging=!1,this.onViewportChange(this.scale,this.offsetX,this.offsetY,this.isDragging))},t.prototype.handleWheel=function(e){e.preventDefault(),(e.deltaY||e.wheelDelta)>0?this.zoomOut():this.zoomIn()},t.prototype.destroy=function(){this.options=null,this.getContentSize=null,this.onViewportChange=null},t.prototype.calculateInitialScale=function(e,t){if(!e||!t)return 1;var i=window.innerHeight*this.defaultScreenHeightRatio/t;return i<this.minScale&&(i=this.minScale),i>this.maxScale&&(i=this.maxScale),i},t.prototype.setScale=function(e,t){e<this.minScale&&(e=this.minScale),e>this.maxScale&&(e=this.maxScale),this.scale=e,!1!==t&&this.onViewportChange(this.scale,this.offsetX,this.offsetY,this.isDragging)},t.prototype.setOffset=function(e,t,i){this.offsetX=e,this.offsetY=t,!1!==i&&this.onViewportChange(this.scale,this.offsetX,this.offsetY,this.isDragging)},t.prototype.centerView=function(){var e=window.innerHeight-this.headerHeight-this.footerHeight,t=this.getContentSize(),i=t?t.height*this.scale:0;this.offsetX=0;var a=this.headerHeight+e/2;this.offsetY=a-i/2,this.onViewportChange(this.scale,this.offsetX,this.offsetY,this.isDragging)},t.prototype.zoomIn=function(){var e=this.scale,t=Math.min(e+this.zoomStep,this.maxScale);this.applyZoomWithCenterPoint(e,t)},t.prototype.zoomOut=function(){var e=this.scale,t=Math.max(e-this.zoomStep,this.minScale);this.applyZoomWithCenterPoint(e,t)},t.prototype.applyZoomWithCenterPoint=function(e,t){var i=this.getContentSize();if(i&&i.height>0){var a=i.height*e,o=i.height*t-a;this.offsetY-=o/2}this.scale=t,this.onViewportChange(this.scale,this.offsetX,this.offsetY,this.isDragging)},t.prototype.resetView=function(){var e=this.getContentSize();if(e){var t=this.calculateInitialScale(e.width,e.height);this.scale=t,this.viewMode="fit-height",this.centerView()}},t.prototype.setScaleTo1=function(){this.scale=1,this.viewMode="1:1",this.centerView()},t.prototype.toggleViewMode=function(){"fit-height"===this.viewMode?this.setScaleTo1():this.resetView()},t.prototype.getViewMode=function(){return this.viewMode},t.prototype.setFooterHeight=function(e){this.footerHeight=e},t.prototype.setHeaderHeight=function(e){this.headerHeight=e},t.prototype.getViewportState=function(){return{scale:this.scale,offsetX:this.offsetX,offsetY:this.offsetY}},t.prototype.destroy=function(){this.options=null,this.getContentSize=null,this.onViewportChange=null},e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Controllers=e.MeeWoo.Controllers||{},e.MeeWoo.Controllers.ViewportController=t}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Mixins=e.MeeWoo.Mixins||{},e.MeeWoo.Mixins.PanelMixin={data:function(){return{activeRightPanel:null,dualChannelConfig:{channelMode:"color-left-alpha-right",width:0,height:0,quality:80,fps:30,muted:!1,aspectRatio:1},dualChannelSourceInfo:{name:"",sizeWH:"",duration:"",fileSize:"",fps:30,typeLabel:""},isConvertingToDualChannel:!1,dualChannelProgress:0,dualChannelMessage:"",dualChannelCancelled:!1,toSvgaConfig:{width:0,height:0,quality:80,fps:30,muted:!1,aspectRatio:1},toSvgaSourceInfo:{name:"",sizeWH:"",duration:"",fileSize:"",fps:30,typeLabel:""},isConvertingToSvga:!1,toSvgaProgress:0,toSvgaStage:"",toSvgaMessage:"",toSvgaCancelled:!1,showStandardMp4Panel:!1,isExportingGIF:!1,isExportingFrames:!1,isExportingWebp:!1,isConvertingStandardMp4:!1}},methods:{closeRightPanel:function(){if("to-svga"===this.activeRightPanel&&this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.cancelToSvgaConversion()}else if("dual-channel"===this.activeRightPanel&&this.isConvertingToDualChannel){if(!confirm("正在转换中，确定要取消吗？"))return;this.cancelDualChannelConversion()}else if("gif"===this.activeRightPanel&&this.isExportingGIF){if(!confirm("正在导出GIF中，确定要取消吗？"))return;this.cancelGifExport()}else if("frames"===this.activeRightPanel&&this.isExportingFrames){if(!confirm("正在导出序列帧中，确定要取消吗？"))return;this.cancelFramesExport()}else if("webp"===this.activeRightPanel&&this.isExportingWebp){if(!confirm("正在导出WebP中，确定要取消吗？"))return;this.cancelWebpExport()}else if(this.showStandardMp4Panel&&this.isConvertingStandardMp4){if(!confirm("正在转换中，确定要取消吗？"))return;this.cancelStandardMp4Conversion()}this.activeRightPanel=null,this.showStandardMp4Panel=!1},closeAllPanels:function(){this.closeRightPanel()},openRightPanel:function(e){let t=null,i=!1;if("showStandardMp4Panel"===e)i=!0;else if("gif"===e)t="gif";else if("frames"===e)t="frames";else if("webp"===e)t="webp";else if("to-svga"===e)t="to-svga";else if("dual-channel"===e)t="dual-channel";else if("material"===e)t="material";else if("showMp4ToSvgaPanel"===e||"showLottieToSvgaPanel"===e||"showFramesToSvgaPanel"===e||"showImagesToSvgaPanel"===e||"showYyevaToSvgaPanel"===e)t="to-svga";else if("showMp4ToDualChannelPanel"===e||"showLottieToDualChannelPanel"===e||"showFramesToDualChannelPanel"===e||"showImagesToDualChannelPanel"===e||"showSvgaToDualChannelPanel"===e)t="dual-channel";else if("showGifPanel"===e)t="gif";else if("showFramesPanel"===e)t="frames";else{if("showWebpPanel"!==e)return void console.warn("Unknown panel name:",e);t="webp"}i?this.showStandardMp4Panel?(this.showStandardMp4Panel=!1,this.activeRightPanel=null):(this.activeRightPanel=null,this.showStandardMp4Panel=!0):this.activeRightPanel===t?(this.activeRightPanel=null,this.showStandardMp4Panel=!1):(this.showStandardMp4Panel=!1,this.activeRightPanel=t)},openToSvgaPanel:function(){var e={name:"",sizeWH:"",duration:"",fileSize:"",fps:30,typeLabel:""},t={width:0,height:0,quality:80,fps:30,muted:!1,aspectRatio:1};"mp4"===this.currentModule?(e.name=this.mp4.fileInfo.name||"",e.sizeWH=this.mp4.fileInfo.sizeWH||"",e.duration=this.mp4.fileInfo.duration||"",e.fileSize=this.utils?this.utils.formatBytes(this.mp4.fileInfo.size):"",e.fps=30,e.typeLabel="MP4",t.width=this.mp4.originalWidth||300,t.height=this.mp4.originalHeight||300,t.aspectRatio=this.mp4.originalWidth/this.mp4.originalHeight||1):"lottie"===this.currentModule?(e.name=this.lottie.fileInfo.name||"",e.sizeWH=this.lottie.fileInfo.sizeWH||"",e.duration=this.lottie.fileInfo.duration||"",e.fileSize=this.utils?this.utils.formatBytes(this.lottie.fileInfo.size):"",e.fps=this.lottie.fileInfo.fps||30,e.typeLabel="Lottie",t.width=this.lottie.originalWidth||300,t.height=this.lottie.originalHeight||300,t.fps=this.lottie.fileInfo.fps||30,t.aspectRatio=this.lottie.originalWidth/this.lottie.originalHeight||1):"frames"===this.currentModule?(e.name=this.frames.fileInfo.name||"",e.sizeWH=this.frames.fileInfo.sizeWH||"",e.duration=this.frames.fileInfo.duration||"",e.fileSize=this.utils?this.utils.formatBytes(this.frames.fileInfo.size):"",e.fps=this.frames.fileInfo.fps||25,e.typeLabel="序列帧",t.width=this.frames.originalWidth||300,t.height=this.frames.originalHeight||300,t.fps=this.frames.fileInfo.fps||25,t.aspectRatio=this.frames.originalWidth/this.frames.originalHeight||1):"yyeva"===this.currentModule&&(e.name=this.yyeva.fileInfo.name||"",e.sizeWH=this.yyeva.fileInfo.sizeWH||"",e.duration=this.yyeva.fileInfo.duration||"",e.fileSize=this.utils?this.utils.formatBytes(this.yyeva.fileInfo.size):"",e.fps=this.yyeva.fileInfo.fps||30,e.typeLabel="双通道MP4",t.width=this.yyeva.displayWidth||300,t.height=this.yyeva.displayHeight||300,t.fps=this.yyeva.fileInfo.fps||30,t.aspectRatio=this.yyeva.displayWidth/this.yyeva.displayHeight||1),this.toSvgaSourceInfo=e,this.toSvgaConfig=t,this.activeRightPanel="to-svga",this.loadLibrary&&this.loadLibrary(["ffmpeg"],!0).then(function(){}).catch(function(e){console.error("ffmpeg加载失败:",e)})},handleToSvgaConvert:function(e){this.toSvgaConfig=e,"mp4"===this.currentModule?this.startMp4ToSvgaConversion(e):"lottie"===this.currentModule?this.startLottieToSvgaConversion(e):"frames"===this.currentModule?this.startFramesToSvgaConversion(e):"yyeva"===this.currentModule&&(this.yyevaToSvgaConfig=Object.assign({},this.yyevaToSvgaConfig||{},e),this.startSVGAConversion(e))},cancelToSvgaConversion:function(){this.toSvgaCancelled=!0,this.toSvgaMessage="正在取消...",this.mp4ToSvgaCancelled=!0,this.lottieToSvgaCancelled=!0,this.framesToSvgaCancelled=!0,this.svgaConvertCancelled=!0},openDualChannelPanel:function(){console.log("=== 打开双通道MP4面板：开始 ===");var e={name:"",sizeWH:"",duration:"",fileSize:"",fps:30,typeLabel:""},t={channelMode:"color-left-alpha-right",width:0,height:0,quality:80,fps:30,muted:!1,aspectRatio:1};if("svga"===this.currentModule){var i=this.svga||{},a=i.fileInfo||{};e.name=a.name||"",e.sizeWH=a.sizeWH||"",e.duration=a.duration||"",e.fileSize=this.utils&&a.size?this.utils.formatBytes(a.size):"",e.fps=a.fps||30,e.typeLabel="SVGA",t.width=i.originalWidth||300,t.height=i.originalHeight||300,t.fps=a.fps||30,t.aspectRatio=i.originalWidth&&i.originalHeight?i.originalWidth/i.originalHeight:1}else if("mp4"===this.currentModule){var o=this.mp4||{};a=o.fileInfo||{};e.name=a.name||"",e.sizeWH=a.sizeWH||"",e.duration=a.duration||"",e.fileSize=this.utils&&a.size?this.utils.formatBytes(a.size):"",e.fps=30,e.typeLabel="MP4",t.width=o.originalWidth||300,t.height=o.originalHeight||300,t.aspectRatio=o.originalWidth&&o.originalHeight?o.originalWidth/o.originalHeight:1}else if("lottie"===this.currentModule){var n=this.lottie||{};a=n.fileInfo||{};e.name=a.name||"",e.sizeWH=a.sizeWH||"",e.duration=a.duration||"",e.fileSize=this.utils&&a.size?this.utils.formatBytes(a.size):"",e.fps=a.fps||30,e.typeLabel="Lottie",t.width=n.originalWidth||300,t.height=n.originalHeight||300,t.fps=a.fps||30,t.aspectRatio=n.originalWidth&&n.originalHeight?n.originalWidth/n.originalHeight:1,t.muted=!0}else if("frames"===this.currentModule){var r=this.frames||{};a=r.fileInfo||{};e.name=a.name||"",e.sizeWH=a.sizeWH||"",e.duration=a.duration||"",e.fileSize=this.utils&&a.size?this.utils.formatBytes(a.size):"",e.fps=a.fps||25,e.typeLabel="序列帧",t.width=r.originalWidth||300,t.height=r.originalHeight||300,t.fps=a.fps||25,t.aspectRatio=r.originalWidth&&r.originalHeight?r.originalWidth/r.originalHeight:1,t.muted=!0}e.name=e.name||"",e.sizeWH=e.sizeWH||"",e.duration=e.duration||"",e.fileSize=e.fileSize||"",e.fps=e.fps||30,e.typeLabel=e.typeLabel||"未知",t.channelMode=t.channelMode||"color-left-alpha-right",t.width=t.width||300,t.height=t.height||300,t.quality=t.quality||80,t.fps=t.fps||30,t.muted=t.muted||!1,t.aspectRatio=t.aspectRatio||1,console.log("设置双通道MP4源信息和配置:",e,t),this.dualChannelSourceInfo=e,this.dualChannelConfig=t,console.log("关闭其他面板并打开双通道MP4面板"),this.showStandardMp4Panel=!1,console.log("直接设置activeRightPanel为dual-channel，当前值:",this.activeRightPanel),this.activeRightPanel="dual-channel",console.log("设置后activeRightPanel:",this.activeRightPanel),console.log("加载ffmpeg库"),this.loadLibrary&&this.loadLibrary(["ffmpeg"],!0).catch(function(e){console.error("ffmpeg加载失败:",e)});var s=this;console.log("Vue.nextTick执行，强制更新组件"),this.$nextTick(function(){s.$forceUpdate&&(console.log("调用$forceUpdate强制更新组件"),s.$forceUpdate())}),console.log("=== 打开双通道MP4面板：完成 ===")},handleDualChannelConvert:function(e){this.dualChannelConfig=e,this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelMessage="准备转换...",this.dualChannelCancelled=!1,"svga"===this.currentModule?(this.svgaToDualChannelConfig=Object.assign({},this.svgaToDualChannelConfig||{},e),this.startMP4Conversion(e)):"mp4"===this.currentModule?(this.mp4ToDualChannelConfig=Object.assign({},this.mp4ToDualChannelConfig||{},e),this.startMp4ToDualChannelConversion(e)):"lottie"===this.currentModule?(this.lottieToDualChannelConfig=Object.assign({},this.lottieToDualChannelConfig||{},e),this.startLottieToDualChannelConversion(e)):"frames"===this.currentModule&&(this.imagesToDualChannelConfig=Object.assign({},this.imagesToDualChannelConfig||{},e),this.startFramesToDualChannelConversion(e))},cancelDualChannelConversion:function(){this.dualChannelCancelled=!0,this.dualChannelMessage="正在取消...",this.isConvertingToDualChannel=!1,this.mp4ConvertCancelled=!0,this.framesToDualChannelCancelled=!0},openGifPanel:function(){this.activeRightPanel="gif"},openMp4ToSvgaPanel:function(){this.openToSvgaPanel()},openLottieToSvgaPanel:function(){this.openToSvgaPanel()},openFramesToSvgaPanel:function(){this.openToSvgaPanel()},openMp4ToDualChannelPanel:function(){this.openDualChannelPanel()},openLottieToDualChannelPanel:function(){this.openDualChannelPanel()},openFramesToDualChannelPanel:function(){this.openDualChannelPanel()},openSVGAPanel:function(){this.openToSvgaPanel()},openMP4Panel:function(){this.openDualChannelPanel()},openSvgaToDualChannelPanel:function(){this.openDualChannelPanel()},openYyevaToSvgaPanel:function(){this.openToSvgaPanel()},openLottieToDualChannelPanel:function(){this.openDualChannelPanel()},openFramesToDualChannelPanel:function(){this.openDualChannelPanel()},openStandardMp4Panel:function(){this.showStandardMp4Panel=!0,this.activeRightPanel=null},closeStandardMp4Panel:function(){this.showStandardMp4Panel=!1},openMaterialPanel:function(){this.activeRightPanel="material"},openFramesPanel:function(){this.activeRightPanel="frames"},openWebpPanel:function(){this.activeRightPanel="webp"},openChromaKeyPanel:function(){this.activeRightPanel="chromakey"}}}}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={getDefaultEditorState:function(){return{show:!1,targetIndex:-1,loading:!1,viewMode:"fit-height",scale:1,offsetX:0,offsetY:0,baseImage:null,baseImageWidth:0,baseImageHeight:0,defaultBaseImage:null,showRestoreBtn:!1,showImage:!0,showText:!1,textContent:"",textStyle:"",activeElement:"none",lastClickElement:"none",lastClickTime:0,isDragging:!1,dragStartX:0,dragStartY:0,dragStartOffsetX:0,dragStartOffsetY:0,imageOffsetX:0,imageOffsetY:0,imageScale:1,isImageDragging:!1,imageDragStartX:0,imageDragStartY:0,imageDragStartOffsetX:0,imageDragStartOffsetY:0,imageMouseMoved:!1,textPosX:50,textPosY:50,textScale:1,textAlign:"left",isTextDragging:!1,textDragStartX:0,textDragStartY:0,textDragStartPosX:50,textDragStartPosY:50,textMouseMoved:!1}},getDefaultMaterialEditStates:function(){return{}},resetEditorState:function(e){var t=this.getDefaultEditorState();for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},updateRestoreButtonState:function(e){var t=!1,i=e.defaultBaseImage;i&&e.baseImage!==i?t=!0:e.showImage?(e.showText||0!==e.imageOffsetX||0!==e.imageOffsetY||Math.abs(e.imageScale-1)>.001)&&(t=!0):t=!0,e.showRestoreBtn=t},saveMaterialEditState:function(e,t,i){e[t]={textContent:i.textContent,textStyle:i.textStyle,showImage:i.showImage,showText:i.showText,textPosX:i.textPosX,textPosY:i.textPosY,textScale:i.textScale,textAlign:i.textAlign,imageOffsetX:i.imageOffsetX,imageOffsetY:i.imageOffsetY,imageScale:i.imageScale,customBaseImage:i.baseImage!==i.defaultBaseImage?i.baseImage:void 0}},restoreMaterialEditState:function(e,t,i){var a=e[t];a&&(i.showImage=a.showImage,i.showText=a.showText,i.textContent=a.textContent||"",i.textStyle=a.textStyle||"",i.textPosX=void 0!==a.textPosX?a.textPosX:50,i.textPosY=void 0!==a.textPosY?a.textPosY:50,i.textScale=void 0!==a.textScale?a.textScale:1,i.textAlign=void 0!==a.textAlign?a.textAlign:"left",i.imageOffsetX=void 0!==a.imageOffsetX?a.imageOffsetX:0,i.imageOffsetY=void 0!==a.imageOffsetY?a.imageOffsetY:0,i.imageScale=void 0!==a.imageScale?a.imageScale:1,a.customBaseImage&&(i.baseImage=a.customBaseImage))},clearMaterialEditState:function(e,t){e[t]&&delete e[t]}};e.MeeWoo.Core.MaterialState=t}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={filterTextStyle:function(e){if(!e)return{};for(var t={},i=(e=e.replace(/\/\*[\s\S]*?\*\//g,"")).split(";"),a=["position","top","bottom","left","right","width","height","min-width","min-height","max-width","max-height","flex","flex-grow","flex-shrink","flex-basis","flex-direction","flex-wrap","flex-flow","justify-content","justify-items","justify-self","align-content","align-items","align-self","place-content","place-items","place-self","order","gap","margin","margin-top","margin-right","margin-bottom","margin-left","z-index","transform","transform-origin","float","clear","white-space","overflow","overflow-x","overflow-y","line-height","text-decoration","text-decoration-line","text-decoration-style","text-decoration-color","text-decoration-thickness"],o=0;o<i.length;o++){var n=i[o].trim();if(n){var r=n.indexOf(":");if(-1!==r){var s=n.substring(0,r).trim().toLowerCase(),l=n.substring(r+1).trim();s&&l&&-1===a.indexOf(s)&&(t[s]=l)}}}var h="text"===t["-webkit-background-clip"]||"text"===t["background-clip"],c="transparent"===t.color||"transparent"===t["-webkit-text-fill-color"]||"transparent"===t["text-fill-color"],d=-1!==(t.background||t["background-image"]||"").indexOf("gradient");return h&&!c&&d&&(t.color="transparent",t["-webkit-text-fill-color"]||(t["-webkit-text-fill-color"]="transparent")),t},convertStylesToCssString:function(e){var t="";for(var i in e)e.hasOwnProperty(i)&&(t+=i+":"+e[i]+";");return t},renderEditorPreview:function(e){var t=this;e.editor.show&&e.editor.showText&&e.$nextTick(function(){var i=e.$refs.editorTextCanvas;if(i){var a=i.getContext("2d",{willReadFrequently:!0}),o=e.editor.baseImageWidth,n=e.editor.baseImageHeight;a.clearRect(0,0,o,n);var r=o*e.editor.textPosX/100,s=n*e.editor.textPosY/100;a.save(),a.translate(r,s),a.scale(e.editor.textScale,e.editor.textScale),t.drawRichText(e,a,o,n),a.restore()}})},parseStroke:function(e){if(!e)return null;var t=e.match(/(-?[\d.]+(?:px|em)?)\s+(#[0-9a-fA-F]+|rgba?\([^)]+\)|transparent)/i);return t?{width:parseFloat(t[1]),color:t[2]}:null},drawRichText:function(e,t,i,a){var o=e.editorTextStyleFiltered,n=e.editor.textContent;if(n){var r=parseFloat(o["font-size"])||24,s=o["font-family"]||"sans-serif",l=o["font-weight"]||"normal",h=o["font-style"]||"normal";s=s.replace(/['"]/g,""),t.save(),t.font=h+" "+l+" "+r+'px "'+s+'"',t.textAlign=e.editor.textAlign,t.textBaseline="middle";var c=o.color||"#000000",d=o.background||o["background-image"],g="text"===o["-webkit-background-clip"]||"text"===o["background-clip"],f=n.split("\n"),u=1.2*r,m=f.length*u;if(d&&-1!==d.indexOf("gradient")&&g){for(var p,v=d.match(/linear-gradient\((\d+)deg/),y=v?parseInt(v[1]):180,w=[],C=/(#[0-9a-fA-F]+|rgba?\([^)]+\))\s*(\d+(?:\.\d+)?%?)/g;null!==(p=C.exec(d));){var M=p[2];M=(M.indexOf("%"),parseFloat(M)/100),w.push({color:p[1],stop:M})}if(w.length>=2){var S,b,F,k;if((null===w[0].stop||isNaN(w[0].stop))&&(w[0].stop=0),(null===w[w.length-1].stop||isNaN(w[w.length-1].stop))&&(w[w.length-1].stop=1),0===y)S=0,b=m/2,F=0,k=-m/2;else if(90===y){for(var P=0,x=0;x<f.length;x++){(I=t.measureText(f[x]).width)>P&&(P=I)}S=-P/2,b=0,F=P/2,k=0}else if(270===y){for(P=0,x=0;x<f.length;x++){var I;(I=t.measureText(f[x]).width)>P&&(P=I)}S=P/2,b=0,F=-P/2,k=0}else S=0,b=-m/2,F=0,k=m/2;for(var T=t.createLinearGradient(S,b,F,k),E=0;E<w.length;E++){var W=Math.max(0,Math.min(1,w[E].stop));T.addColorStop(W,w[E].color)}c=T}}var L=-m/2+u/2;if(o["text-shadow"]){var D=o["text-shadow"].replace(/rgba?\([^)]+\)/gi,function(e){return e.replace(/,/g,"|")}).split(",").map(function(e){return e.replace(/\|/g,",").trim()});for(x=0;x<D.length;x++){var A=D[x].match(/(-?[\d.]+(?:px)?|0)\s+(-?[\d.]+(?:px)?|0)(?:\s+(-?[\d.]+(?:px)?|0))?\s+(#[0-9a-fA-F]+|rgba?\([^)]+\))/i);if(A){t.save(),t.shadowOffsetX=parseFloat(A[1]),t.shadowOffsetY=parseFloat(A[2]),t.shadowBlur=A[3]?parseFloat(A[3]):0,t.shadowColor=A[4],t.fillStyle=c;for(var R=0;R<f.length;R++){var _=L+R*u;t.fillText(f[R],0,_)}t.restore()}}t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0}var O=o["-webkit-text-stroke"]||o.border;if(O){var H=this.parseStroke(O);if(H){t.lineWidth=H.width,t.strokeStyle="transparent"===H.color&&c instanceof CanvasGradient?c:H.color,t.lineJoin="round";for(R=0;R<f.length;R++){_=L+R*u;t.strokeText(f[R],0,_)}}}t.fillStyle=c;for(R=0;R<f.length;R++){_=L+R*u;t.fillText(f[R],0,_)}t.restore()}},generateEditedMaterial:function(e){return new Promise(function(t,i){if("undefined"!=typeof html2canvas){var a=e.$refs.editorPreviewContent;if(!a)return void i(new Error("Editor preview container not found"));var o=a.querySelector(".editor-controls"),n=null;o&&(n=o,o.parentNode.removeChild(o)),html2canvas(a,{backgroundColor:null,scale:1,logging:!1,timeout:1e4,useCORS:!0,allowTaint:!0,ignoreElements:function(e){return e.classList&&(e.classList.contains("editor-controls")||e.classList.contains("editor-toolbar")||e.classList.contains("editor-buttons")||e.classList.contains("editor-layer-tag"))},cacheBust:!1,imageTimeout:3e3,removeContainer:!1,skipFonts:!1,useWebGL:!1,onclone:function(e){var t=e.querySelector(".editor-preview-content");if(t){var i=t.cloneNode(!0);t.parentNode.replaceChild(i,t)}},width:a.clientWidth,height:a.clientHeight}).then(function(e){n&&a.appendChild(n);var i=e.toDataURL("image/png",1);t(i)}).catch(function(e){n&&a.appendChild(n),i(e)})}else i(new Error("html2canvas is not loaded"))})},setTextAlign:function(e,t){e.editor.textAlign=t,this.renderEditorPreview(e)},restoreOriginalMaterial:function(t,i){var a,o;if(void 0!==i?"number"==typeof i?(o=t.materialList[i])&&(a=o.imageKey):(a=i,o=t.materialList.find(function(e){return e.imageKey===a})):(a=t.editor.targetKey)&&(o=t.materialList.find(function(e){return e.imageKey===a})),a&&o){if(e.MeeWoo.Core.MaterialState.clearMaterialEditState(t.materialEditStates,a),o.originalUrl?o.previewUrl=o.originalUrl:o.originalData&&(o.previewUrl=o.originalData.startsWith("data:")?o.originalData:"data:image/png;base64,"+o.originalData),o.isReplaced=!1,t.replacedImages){var n=Object.assign({},t.replacedImages);delete n[a],t.replacedImages=n}t.editor&&t.editor.targetKey===a&&(t.editor.showImage=!0,t.editor.showText=!1,t.editor.textContent="示例文案",t.editor.textStyle="color: white;\ntext-shadow: 1px 1px 2px #000000;\nfont-size: 24px;\nfont-weight: bold;",t.editor.textPosX=50,t.editor.textPosY=50,t.editor.textScale=1,t.editor.textAlign="left",t.editor.imageOffsetX=0,t.editor.imageOffsetY=0,t.editor.imageScale=1,t.editor.showRestoreBtn=!1,t.editor.scale=1,t.editor.offsetX=0,t.editor.offsetY=0,t.editor.viewMode="fit-height",t.editor.baseImage=o.originalUrl||o.previewUrl,this.renderEditorPreview(t)),t.applyReplacedMaterials&&t.applyReplacedMaterials(),t.showToast&&t.showToast("已恢复原图")}},openMaterialEditor:function(t,i){var a=i;if("number"==typeof i&&(a=t.materialList[i]),a){t.loadLibrary&&t.loadLibrary("html2canvas",!0).catch(function(e){}),t.editor.targetKey=a.imageKey,t.editor.show=!0,e.MeeWoo&&e.MeeWoo.Controllers&&e.MeeWoo.Controllers.UserTypeController&&setTimeout(()=>{e.MeeWoo.Controllers.UserTypeController.refresh()},0),t.editor.loading=!1,t.editor.viewMode="fit-height",t.editor.scale=1,t.editor.offsetX=0,t.editor.offsetY=0;var o,n=t.materialEditStates[a.imageKey];n?(t.editor.showImage=n.showImage,t.editor.showText=n.showText,t.editor.textContent=n.textContent||"",t.editor.textStyle=n.textStyle||"",t.editor.textPosX=void 0!==n.textPosX?n.textPosX:50,t.editor.textPosY=void 0!==n.textPosY?n.textPosY:50,t.editor.textScale=void 0!==n.textScale?n.textScale:1,t.editor.textAlign=void 0!==n.textAlign?n.textAlign:"left",t.editor.imageOffsetX=void 0!==n.imageOffsetX?n.imageOffsetX:0,t.editor.imageOffsetY=void 0!==n.imageOffsetY?n.imageOffsetY:0,t.editor.imageScale=void 0!==n.imageScale?n.imageScale:1):(t.editor.showImage=!0,t.editor.showText=!1,t.editor.textContent="示例文案",t.editor.textStyle="color: white;\ntext-shadow: 1px 1px 2px #000000;\nfont-size: 24px;\nfont-weight: bold;",t.editor.textPosX=50,t.editor.textPosY=50,t.editor.textScale=1,t.editor.textAlign="left",t.editor.imageOffsetX=0,t.editor.imageOffsetY=0,t.editor.imageScale=1),t.editor.activeElement="none",t.editor.lastClickElement="none",t.editor.lastClickTime=0,o=a.originalUrl?a.originalUrl:a.originalData?a.originalData.startsWith("data:")?a.originalData:"data:image/png;base64,"+a.originalData:a.previewUrl,t.editor.defaultBaseImage=o,t.updateRestoreBtnState&&t.updateRestoreBtnState(),n&&n.customBaseImage&&(o=n.customBaseImage),this.loadAndSetImageDimensions(t,o)}},loadAndSetImageDimensions:function(e,t){var i=new Image;i.onload=function(){e.editor.baseImageWidth=i.width,e.editor.baseImageHeight=i.height,e.editor.baseImage=t,e.editor.showText&&e.$nextTick(function(){e.renderEditorPreview()})},i.onerror=function(){},i.crossOrigin="Anonymous",i.src=t},generateEditedMaterial:function(e){return new Promise(function(t,i){if("undefined"!=typeof html2canvas){var a=e.$refs.editorPreviewContent;if(!a)return void i(new Error("Editor preview container not found"));var o=a.querySelector(".editor-controls"),n=null;o&&(n=o,o.parentNode.removeChild(o)),html2canvas(a,{backgroundColor:null,scale:1,logging:!1,timeout:1e4,useCORS:!0,allowTaint:!0,ignoreElements:function(e){return e.classList&&(e.classList.contains("editor-controls")||e.classList.contains("editor-toolbar")||e.classList.contains("editor-buttons")||e.classList.contains("editor-layer-tag"))},cacheBust:!1,imageTimeout:3e3,removeContainer:!1,skipFonts:!1,useWebGL:!1,onclone:function(e){var t=e.querySelector(".editor-preview-content");if(t){var i=t.cloneNode(!0);t.parentNode.replaceChild(i,t)}},width:a.clientWidth,height:a.clientHeight}).then(function(e){n&&a.appendChild(n);var i=e.toDataURL("image/png",1);t(i)}).catch(function(e){n&&a.appendChild(n),i(e)})}else i(new Error("html2canvas is not loaded"))})},closeMaterialEditor:function(e){e.editor.show=!1},saveMaterialEdit:function(t){var i=!1,a=t.editor,o=a.defaultBaseImage;o&&a.baseImage!==o?i=!0:a.showImage?(a.showText||0!==a.imageOffsetX||0!==a.imageOffsetY||Math.abs(a.imageScale-1)>.001)&&(i=!0):i=!0,i?(t.editor.loading=!0,t.generateEditedMaterial().then(function(i){var a=t.editor.targetKey;if(a){var o=t.materialList.find(function(e){return e.imageKey===a});if(o){if(e.MeeWoo.Core.MaterialState.saveMaterialEditState(t.materialEditStates,a,t.editor),o.previewUrl=i,t.replacedImages[a]=i,o.isReplaced=!0,t.svgaPlayer){var n=new Image;n.onload=function(){t.svgaPlayer.setImage(n,a)},n.src=i}t.editor.show=!1,t.editor.loading=!1,t.showToast&&t.showToast("素材编辑已保存")}}}).catch(function(e){t.editor.loading=!1,t.showToast&&t.showToast("保存失败，请重试")})):t.editor.show=!1}};e.MeeWoo.Core.MaterialOperations=t}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={onPreviewAreaMouseDown:function(e,t){var i=this;null===e.editor.activeElement&&(e.editor.activeElement="none"),this.clearDragListeners(e.editor);var a=this.checkClickOnLayer(e,t),o=Date.now(),n=t.clientX,r=t.clientY;if(e.editor.isDragging=!1,t.altKey){var s=e.editor.offsetX,l=e.editor.offsetY,h=function(t){var i=t.clientX-n,a=t.clientY-r;if(Math.sqrt(i*i+a*a)>6&&(e.editor.isDragging=!0),e.editor.isDragging){var o=t.clientX-n,h=t.clientY-r;requestAnimationFrame(function(){e.editor.offsetX=s+o,e.editor.offsetY=l+h})}},c=function(){i.clearDragListeners(e.editor)};return e.editor.dragHandlers={mousemove:h,mouseup:c},document.addEventListener("mousemove",h),void document.addEventListener("mouseup",c)}var d=!1;if("none"!==e.editor.activeElement&&(d=a===e.editor.activeElement),"none"!==e.editor.activeElement&&d){var g=e.editor.imageOffsetX,f=e.editor.imageOffsetY,u=e.editor.textPosX,m=e.editor.textPosY;h=function(t){var i=t.clientX-n,a=t.clientY-r;if(Math.sqrt(i*i+a*a)>6&&(e.editor.isDragging=!0),e.editor.isDragging)if("image"===e.editor.activeElement){var o=t.clientX-n,s=t.clientY-r;requestAnimationFrame(function(){e.editor.imageOffsetX=g+o/e.editor.scale,e.editor.imageOffsetY=f+s/e.editor.scale})}else if("text"===e.editor.activeElement){o=t.clientX-n,s=t.clientY-r;var l=o/e.editor.scale/e.editor.baseImageWidth*100,h=s/e.editor.scale/e.editor.baseImageHeight*100;requestAnimationFrame(function(){e.editor.textPosX=u+l,e.editor.textPosY=m+h,e.renderEditorPreview()})}},c=function(t){var s=Date.now(),l=t.clientX,h=t.clientY,c=s-o,d=l-n,g=h-r,f=Math.sqrt(d*d+g*g);if(i.clearDragListeners(e.editor),!e.editor.isDragging&&f<=6&&c<=500){var u=Date.now(),m=!1;if(e.editor.lastClickElement===a&&u-e.editor.lastClickTime<300){var p=e.editor.lastClickX||0,v=e.editor.lastClickY||0;Math.sqrt(Math.pow(l-p,2)+Math.pow(h-v,2))<=8&&(m=!0)}if(m){var y=[];e.editor.showText&&y.push("text"),e.editor.showImage&&y.push("image");var w=(y.indexOf(e.editor.activeElement)+1)%y.length;e.editor.activeElement=y[w],e.editor.lastClickElement=y[w]}else e.editor.activeElement!==a&&(e.editor.activeElement=a,e.editor.lastClickElement=a);e.editor.lastClickTime=u,e.editor.lastClickX=l,e.editor.lastClickY=h}};e.editor.dragHandlers={mousemove:h,mouseup:c},document.addEventListener("mousemove",h),document.addEventListener("mouseup",c)}else{s=e.editor.offsetX,l=e.editor.offsetY;var h=function(t){var i=t.clientX-n,a=t.clientY-r;if(Math.sqrt(i*i+a*a)>6&&!e.editor.isDragging&&(e.editor.isDragging=!0),e.editor.isDragging){var o=t.clientX-n,h=t.clientY-r;requestAnimationFrame(function(){e.editor.offsetX=s+o,e.editor.offsetY=l+h})}},c=function(t){var s=Date.now(),l=t.clientX,h=t.clientY,c=s-o,d=l-n,g=h-r,f=Math.sqrt(d*d+g*g);if(i.clearDragListeners(e.editor),!e.editor.isDragging&&f<=6&&c<=500)if(a){var u=Date.now(),m=!1;if(e.editor.lastClickElement===a&&u-e.editor.lastClickTime<300){var p=e.editor.lastClickX||0,v=e.editor.lastClickY||0;Math.sqrt(Math.pow(l-p,2)+Math.pow(h-v,2))<=8&&(m=!0)}if(m){var y=[];e.editor.showText&&y.push("text"),e.editor.showImage&&y.push("image");var w=(y.indexOf(e.editor.activeElement)+1)%y.length;e.editor.activeElement=y[w],e.editor.lastClickElement=y[w]}else e.editor.activeElement=a,e.editor.lastClickElement=a;e.editor.lastClickTime=u,e.editor.lastClickX=l,e.editor.lastClickY=h}else e.editor.activeElement="none"};e.editor.dragHandlers={mousemove:h,mouseup:c},document.addEventListener("mousemove",h),document.addEventListener("mouseup",c)}},onPreviewAreaWheel:function(e,t){if(t.preventDefault(),null===e.editor.activeElement&&(e.editor.activeElement="none"),t.ctrlKey||t.metaKey||t.altKey){var i=t.deltaY>0?-.02:.02;this.handleEditorZoom(e,i)}else{var a=this.checkClickOnLayer(e,t);if("none"===e.editor.activeElement){i=t.deltaY>0?-.02:.02;this.handleEditorZoom(e,i)}else if(a===e.editor.activeElement){if("image"===a){i=t.deltaY>0?-.01:.01;(o=e.editor.imageScale+i)<.1&&(o=.1),o>10&&(o=10),e.editor.imageScale=parseFloat(o.toFixed(2))}else if("text"===a){var o;i=t.deltaY>0?-.01:.01;(o=e.editor.textScale+i)<.1&&(o=.1),o>10&&(o=10),e.editor.textScale=parseFloat(o.toFixed(2)),e.renderEditorPreview()}}else{i=t.deltaY>0?-.02:.02;this.handleEditorZoom(e,i)}}},onImageMouseDown:function(e,t){},onImageWheel:function(e,t){},toggleEditorViewMode:function(e){var t=document.querySelector(".editor-preview-area");if(t&&e.editor.baseImageHeight)if("fit-height"===e.editor.viewMode)e.editor.viewMode="one-to-one",e.editor.scale=1;else{e.editor.viewMode="fit-height";var i,a=t.clientHeight,o=t.clientWidth,n=.75*a/e.editor.baseImageHeight;(i=e.editor.baseImageWidth*n>o?o/e.editor.baseImageWidth:n)>5&&(i=5),i<.1&&(i=.1),e.editor.scale=parseFloat(i.toFixed(2))}},checkClickOnLayer:function(e,t){var i=document.querySelector(".editor-preview-area"),a=document.querySelector(".editor-preview-wrapper");if(!i||!a)return null;var o=i.getBoundingClientRect(),n=t.clientX-o.left,r=t.clientY-o.top,s=(i.clientWidth-a.clientWidth)/2,l=(i.clientHeight-a.clientHeight)/2,h=s+a.clientWidth,c=l+a.clientHeight;if(n<s||n>h||r<l||r>c)return null;if(e.editor.isDragging)return e.editor.activeElement;var d=Math.round((n-s)/e.editor.scale),g=Math.round((r-l)/e.editor.scale);if(e.editor.showText&&e.editor.textContent){var f=e.$refs.editorTextCanvas;if(f&&d>=0&&d<f.width&&g>=0&&g<f.height)try{if(f.getContext("2d",{willReadFrequently:!0}).getImageData(d,g,1,1).data[3]>0)return"text"}catch(u){}}return e.editor.showImage&&e.editor.baseImage?"image":null},onTextMouseDown:function(e,t){},onTextWheel:function(e,t){},onEditorFileChange:function(e,t){var i=t.target.files[0];if(i)if(i.type.match("image/jpeg|image/png")){var a=new FileReader;a.onload=function(t){var i=t.target.result;e.editor.baseImage=i;var a=e.materialEditStates[e.editor.targetKey]||{};a.customBaseImage=i,e.materialEditStates[e.editor.targetKey]=a,e.updateRestoreBtnState&&e.updateRestoreBtnState()},a.readAsDataURL(i),t.target.value=""}else e.showToast&&e.showToast("请上传JPG或PNG格式的图片")},triggerEditorUpload:function(e){e.$refs.editorFileInput&&e.$refs.editorFileInput.click()},handleEditorZoom:function(e,t){var i=e.editor.scale+t;i<.1&&(i=.1),i>5&&(i=5),e.editor.scale=parseFloat(i.toFixed(2))},moveEditorView:function(e,t,i){e.editor.offsetX+=t,e.editor.offsetY+=i},clearDragListeners:function(e){e.dragHandlers&&(e.dragHandlers.mousemove&&document.removeEventListener("mousemove",e.dragHandlers.mousemove),e.dragHandlers.mouseup&&document.removeEventListener("mouseup",e.dragHandlers.mouseup),e.dragHandlers=null)}};e.MeeWoo.Core.MaterialInteractions=t}(window),function(e){e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Mixins=e.MeeWoo.Mixins||{};var t={data:function(){return{editor:e.MeeWoo.Core.MaterialState.getDefaultEditorState(),materialEditStates:e.MeeWoo.Core.MaterialState.getDefaultMaterialEditStates()}},computed:{editorTextStyleFiltered:function(){return e.MeeWoo.Core.MaterialOperations.filterTextStyle(this.editor.textStyle)},editorTextStyleString:function(){var t=this.editorTextStyleFiltered;return e.MeeWoo.Core.MaterialOperations.convertStylesToCssString(t)},hasEditInfo:function(){return this.editor.showRestoreBtn}},watch:{"editor.baseImage":function(){this.updateRestoreBtnState()},"editor.showImage":function(){this.updateRestoreBtnState()},"editor.showText":function(){var e=this;this.updateRestoreBtnState(),this.$nextTick(function(){e.renderEditorPreview()})},"editor.imageOffsetX":function(){this.updateRestoreBtnState()},"editor.imageOffsetY":function(){this.updateRestoreBtnState()},"editor.imageScale":function(){this.updateRestoreBtnState()},"editor.textContent":function(){var e=this;this.$nextTick(function(){e.renderEditorPreview()})},"editor.textStyle":function(){var e=this;this.$nextTick(function(){e.renderEditorPreview()})},"editor.textPosX":function(){this.renderEditorPreview()},"editor.textPosY":function(){this.renderEditorPreview()},"editor.textScale":function(){this.renderEditorPreview()}},methods:{setTextAlign:function(t){e.MeeWoo.Core.MaterialOperations.setTextAlign(this,t)},updateRestoreBtnState:function(){e.MeeWoo.Core.MaterialState.updateRestoreButtonState(this.editor)},renderEditorPreview:function(){e.MeeWoo.Core.MaterialOperations.renderEditorPreview(this)},clearDragListeners:function(){e.MeeWoo.Core.MaterialInteractions.clearDragListeners(this.editor)},restoreOriginalMaterial:function(){e.MeeWoo.Core.MaterialOperations.restoreOriginalMaterial(this)},clearAllMaterialEditStates:function(){this.materialEditStates=e.MeeWoo.Core.MaterialState.getDefaultMaterialEditStates()},openMaterialEditor:function(t){e.MeeWoo.Core.MaterialOperations.openMaterialEditor(this,t)},loadAndSetImageDimensions:function(t){e.MeeWoo.Core.MaterialOperations.loadAndSetImageDimensions(this,t)},drawRichText:function(t,i,a){e.MeeWoo.Core.MaterialOperations.drawRichText(this,t,i,a)},generateEditedMaterial:function(){return e.MeeWoo.Core.MaterialOperations.generateEditedMaterial(this)},onPreviewAreaMouseDown:function(t){e.MeeWoo.Core.MaterialInteractions.onPreviewAreaMouseDown(this,t)},onPreviewAreaWheel:function(t){e.MeeWoo.Core.MaterialInteractions.onPreviewAreaWheel(this,t)},onImageMouseDown:function(t){e.MeeWoo.Core.MaterialInteractions.onImageMouseDown(this,t)},onImageWheel:function(t){e.MeeWoo.Core.MaterialInteractions.onImageWheel(this,t)},toggleEditorViewMode:function(){e.MeeWoo.Core.MaterialInteractions.toggleEditorViewMode(this)},onTextMouseDown:function(t){e.MeeWoo.Core.MaterialInteractions.onTextMouseDown(this,t)},onTextWheel:function(t){e.MeeWoo.Core.MaterialInteractions.onTextWheel(this,t)},onEditorFileChange:function(t){e.MeeWoo.Core.MaterialInteractions.onEditorFileChange(this,t)},triggerEditorUpload:function(){e.MeeWoo.Core.MaterialInteractions.triggerEditorUpload(this)},closeMaterialEditor:function(){e.MeeWoo.Core.MaterialOperations.closeMaterialEditor(this)},saveMaterialEdit:function(){e.MeeWoo.Core.MaterialOperations.saveMaterialEdit(this)}}};e.MeeWoo.Mixins.MaterialEditor=t}(window),function(e){window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Core=window.MeeWoo.Core||{};const t="svga_preview_user_config";let i=null;e.MeeWoo.Core.ConfigManager=class{constructor(){if(i)return i;this.config={},this._init(),window.addEventListener("storage",e=>{e.key===t&&(this.config=this._load())}),i=this}_init(){this.config=this._load()}_load(){try{if(!localStorage)return console.warn("[ConfigManager] localStorage 不可用"),{};const e=localStorage.getItem(t);return e?JSON.parse(e):{}}catch(e){return"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name?(console.error("[ConfigManager] 存储配额超出，配置加载失败"),this._handleQuotaExceeded()):console.warn("[ConfigManager] 配置加载失败，可能数据已损坏:",e),{}}}_persist(){try{const e=JSON.stringify(this.config),i=new Blob([e]).size;i>4718592&&console.warn("[ConfigManager] 配置数据接近存储配额限制:",i,"bytes"),localStorage.setItem(t,e)}catch(e){"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name?(console.error("[ConfigManager] 存储配额超出，配置保存失败"),this._handleQuotaExceeded()):console.error("[ConfigManager] 配置保存失败:",e)}}_handleQuotaExceeded(){try{this.config={},localStorage.removeItem(t),console.warn("[ConfigManager] 已清空配置以释放存储空间")}catch(e){console.error("[ConfigManager] 清理配置失败:",e)}}get(e,t){if(!e)return this.config;const i=e.split(".");let a=this.config;for(const o of i){if(null==a)return t;a=a[o]}return void 0!==a?a:t}set(e,t){const i=e.split("."),a=i.pop();let o=this.config;for(const n of i)"object"==typeof o[n]&&null!==o[n]||(o[n]={}),o=o[n];o[a]=t,this._persist()}getAll(){return JSON.parse(JSON.stringify(this.config))}remove(e){const t=e.split("."),i=t.pop();let a=this.config;for(const o of t){if("object"!=typeof a[o]||null===a[o])return;a=a[o]}delete a[i],this._persist()}clear(){this.config={},this._persist()}}}(window),function(e){function t(){this.tasks=new Map}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{},t.prototype.register=function(e,t){var i="task_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);return this.tasks.set(i,{name:e,cancel:t}),i},t.prototype.finish=function(e){this.tasks.has(e)&&this.tasks.delete(e)},t.prototype.cancelAll=function(){var e=[];return this.tasks.forEach(function(t,i){if(t.cancel&&"function"==typeof t.cancel)try{t.cancel()}catch(a){console.error("[TaskManager] Error cancelling task:",t.name,a)}e.push(t.name)}),this.tasks.clear(),e},t.prototype.getRunningTasks=function(){var e=[];return this.tasks.forEach(function(t){e.push({name:t.name})}),e},t.prototype.hasRunningTasks=function(){return this.tasks.size>0},e.MeeWoo.Core.TaskManager=t,e.MeeWoo.Core.taskManager=new t}(window),function(){function e(){var e=document.getElementById("loading-skeleton");e&&(e.style.display="none"),function(){var e=window.MeeWoo||{};e.Utils;var t=e.Core,i=e.Controllers,a=e.Services,o=e.Mixins;e.Exporters,e.Components||(e.Components={});var n=e.Components;Vue.config.errorHandler=function(e,t,i){console.error("[Vue Error] "+e.toString(),i),console.error(e)};var r=new Vue({el:"#app",components:{"material-panel":n.MaterialPanel,"gif-panel":n.GifPanel,"frames-panel":n.FramesPanel,"webp-panel":n.WebpPanel,"standard-mp4-panel":n.StandardMp4Panel,"dual-channel-panel":n.DualChannelPanel,"to-svga-panel":n.ToSvgaPanel,"chromakey-panel":n.ChromaKeyPanel},mixins:[o.MaterialEditor,o.PanelMixin],data:function(){return{isLoading:!1,currentModule:"svga",currentLoadTaskId:0,dropHover:!1,footerTransitioning:!1,footerContentVisible:!1,viewerScale:1,viewerOffsetX:0,viewerOffsetY:0,viewMode:"fit-height",isImmersiveMode:!1,modeNameFadeOut:!1,modeNameFadeTimer:null,dragging:!1,isDarkMode:!1,isThemeManuallySet:!1,helpContent:"",loadingLibraryInfo:null,bgColorKey:"pattern",isPlaying:!1,progress:0,currentFrame:0,totalFrames:0,currentTime:0,totalDuration:0,svga:{hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:"",memoryText:""}},yyeva:{hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},alphaPosition:"right",originalWidth:0,originalHeight:0,displayWidth:0,displayHeight:0},lottie:{hasFile:!1,file:null,frameRate:30,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0,animationData:null},taskManager:null,mp4:{hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},mp4HasAudio:!1,materialList:[],replacedImages:{},compressedScaleInfo:{},showCompressModal:!1,isCompressingMaterials:!1,compressProgress:0,compressConfig:{scalePercent:70,pngQuality:80,exportMuted:!1},hasCompressedMaterials:!1,preCompressMaterials:null,preCompressReplacedImages:null,preCompressScaleInfo:null,svgaAudioData:null,svgaMovieData:null,gifConfig:{width:0,height:0,fps:30,quality:10,transparent:!1,dither:!1,ditherColor:"#ffffff"},isExportingGIF:!1,gifExportProgress:0,gifExportStage:"",gifExportMessage:"",gifExportCancelled:!1,framesConfig:{width:0,height:0,fps:24,quality:80,transparent:!1},isExportingFrames:!1,framesExportProgress:0,framesExportStage:"",framesExportMessage:"",framesExportCancelled:!1,webpConfig:{width:0,height:0,fps:24},webpSourceInfo:{name:"",sizeWH:"",duration:0,fileSize:"",fps:24,typeLabel:""},isExportingWebp:!1,webpExportProgress:0,webpExportMessage:"",webpExportCancelled:!1,isExportingLottie:!1,lottieExportProgress:0,showStandardMp4Panel:!1,isConvertingStandardMp4:!1,standardMp4Progress:0,standardMp4Message:"",standardMp4Config:{width:0,height:0,quality:80,fps:30,muted:!1},standardMp4SourceInfo:{sizeWH:"",duration:"",typeLabel:"文件"},showMoreDrawer:!1,showChromaKeyPanel:!1,chromaKeyEnabled:!1,chromaKeySimilarity:40,chromaKeySmoothness:10,chromaKeyConfig:{enabled:!1,similarity:40,smoothness:20,applied:!1},showSpeedRemapEditor:!1,selectedKeyframeIndex:-1,timelineHoverX:-1,showEditFrameDialog:!1,editingKeyframeIndex:-1,editFrameInput:"",showVideoConvertModal:!1,isConverting:!1,videoConvertProgress:0,speedRemapConfig:{enabled:!1,keyframes:[],originalTotalFrames:0,originalDuration:0,fps:30},toastVisible:!1,toastMessage:"",toastTimer:null,isMuted:!1,volume:1,isDraggingVolume:!1,yyevaHasAudio:!1,frames:{hasFile:!1,files:[],fileInfo:{name:"",size:0,sizeText:"",fps:25,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},framesStartTime:0,framesPausedAt:0,showFramesFpsDialog:!1,framesFpsInput:25,framesWasPlayingBeforeDialog:void 0,isLoggedIn:!1,userInfo:null}},methods:{getOngoingTasks:function(){return this.taskManager.getRunningTasks()},cancelOngoingTasks:function(e){var t=this.taskManager.cancelAll();return!e&&t.length>0&&this.utils.showToast("已取消："+t.join("、")),t},confirmIfHasOngoingTasks:function(e,t){var i=this.getOngoingTasks();if(0===i.length)return!0;var a=i.map(function(e){return e.name}).join("、"),o="";return"load"===t?o="您的"+a+"还在进行中，立即播放将退出"+a+"。\n\n确定继续吗？":"clear"===t?o="您的"+a+"还在进行中，清空画布将退出"+a+"。\n\n确定继续吗？":"task"===t&&(o="您的"+a+"还在进行中，立即"+e+"可能造成卡顿。\n\n确定继续吗？"),confirm(o)},loadUserConfig:function(){if(this.configManager){this._migrateOldData();var e=this.configManager.get("bgColorKey");e&&(this.bgColorKey=e);var t=this.configManager.get("lastMode");t&&-1!==["svga","lottie","mp4","frames","yyeva"].indexOf(t)&&(this.currentModule=t);var i=this.configManager.get("gifConfig");i&&(i.fps&&(this.gifConfig.fps=i.fps),i.quality&&(this.gifConfig.quality=i.quality),void 0!==i.transparent&&(this.gifConfig.transparent=i.transparent),void 0!==i.dither&&(this.gifConfig.dither=i.dither),i.width&&(this.gifConfig.width=i.width),i.height&&(this.gifConfig.height=i.height))}},_migrateOldData:function(){if(this.configManager)try{var e=localStorage.getItem("theme");e&&(this.configManager.set("theme",e),localStorage.removeItem("theme"));var t=localStorage.getItem("svga_preview_bg");t&&(this.configManager.set("bgColorKey",t),localStorage.removeItem("svga_preview_bg"))}catch(i){console.error("迁移旧数据失败:",i)}},saveUserConfig:function(e,t){this.configManager&&this.configManager.set(e,t)},handleLogin:function(){this.isLoggedIn||window.authUtils&&window.authUtils.redirectToLogin(window.location.href)},handleLogout:function(){window.authUtils&&(window.authUtils.clearAuth(),this.updateLoginStatus(),window.location.reload())},updateLoginStatus:function(){if(window.authUtils){var e=window.authUtils.isLoggedIn();this.isLoggedIn=e,this.userInfo=window.authUtils.getUserInfo()}},handleLoginCallback:function(){if(window.authUtils){var e=window.authUtils.handleLoginCallback();return e&&this.updateLoginStatus(),e}return!1},switchMode:function(e,t){t=t||{};var i=this.currentModule;if(i!==e||!t.skipCleanup){if(this.cancelOngoingTasks(!0),!t.skipCleanup&&i){var a=this.modeStrategies[i];a&&"function"==typeof a.cleanup?a.cleanup.call(this):console.warn("[switchMode] 未找到模式的清理策略:",i),this.resourceManager&&this.resourceManager.releaseGroup(i)}this.closeRightPanel(),this.currentModule=e,this.viewportController&&(this.viewportController.setScale(1,!0),this.viewportController.setOffset(0,0,!0))}},loadLibrary:function(e,i){return t.libraryLoader.load(e,i)},preloadLibraries:function(){t.libraryLoader.preload()},triggerFileUpload:function(){this.$refs.fileInput.click()},handleReuploadSVGA:function(e){var t=e.target.files;if(t&&0!==t.length){var i=t[0];i.name.toLowerCase().endsWith(".svga")?this.handleFile(i):alert("请选择有效的 SVGA 文件"),e.target.value=""}},onFileSelect:function(e){var t=e.target.files;t&&t.length&&(this.handleFiles(t),e.target.value="")},handleFiles:function(e,t){if(!t){if(!this.confirmIfHasOngoingTasks("播放新文件","load"))return;this.cancelOngoingTasks(!0)}var i=Array.prototype.slice.call(e),a=i.filter(function(e){var t=e.name.toLowerCase();return t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")});a.length>1&&this.isSequenceFrames(a)?this.loadFrameSequence(a):i.length>=1&&this.handleFile(i[0],!0)},isSequenceFrames:function(e){return this.fileValidator.isSequenceFrames(e)},validateFile:function(e,t){return this.fileValidator.validateFile(e,t)},handleFile:function(e,t){var i=this,a=(e.name||"").toLowerCase(),o=null;if(!t){if(!this.confirmIfHasOngoingTasks("播放新文件","load"))return;this.cancelOngoingTasks(!0)}if(a.endsWith(".svga"))o="svga";else{if(!a.endsWith(".json")&&!a.endsWith(".lottie")){if(a.endsWith(".mp4")){var n=++this.currentLoadTaskId;return void this.detectMp4Type(e,function(t,a){if(n===i.currentLoadTaskId){var o=t?"yyeva":"mp4";i.validateFile(e,o).then(function(e){n===i.currentLoadTaskId&&("yyeva"===o?(e.alphaPosition=a||"right",e.detectionTaskId=n,i.loadYyeva(e)):i.loadMp4File(e))}).catch(function(e){n===i.currentLoadTaskId&&alert(e)})}else console.warn("MP4检测任务已取消 (TaskId mismatch)",n)})}return void alert("不支持的文件类型，只支持 .svga / .json / .lottie / .mp4")}o="lottie"}this.validateFile(e,o).then(function(e){"svga"===o?i.loadSvgaFile(e):"lottie"===o&&i.loadLottieFile(e)}).catch(function(e){alert(e)})},detectMp4Type:function(e,t){this.fileValidator.detectMp4Type(e,t)},triggerChangePreviewFile:function(){this.$refs.changePreviewFileInput&&this.$refs.changePreviewFileInput.click()},handleChangePreviewFile:function(e){var t=e.target.files[0];t&&(this.handleFile(t),e.target.value="")},clearAll:function(){var e=this;this.confirmIfHasOngoingTasks("清空画布","clear")&&(this.cancelOngoingTasks(!0),this.resourceManager?window.MeeWoo.Controllers&&window.MeeWoo.Controllers.GlobalAudioManager&&window.MeeWoo.Controllers.GlobalAudioManager.unloadAll():"undefined"!=typeof Howler&&Howler.unload(),this.isImmersiveMode&&(this.isImmersiveMode=!1,this.viewportController&&(this.viewportController.setHeaderHeight(36),this.viewportController.setFooterHeight(154))),this.footerContentVisible=!1,this.footerTransitioning=!0,setTimeout(function(){e.switchMode("svga"),e.lottie={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:""}},e.bgColorKey="pattern",setTimeout(function(){e.footerTransitioning=!1,e.$nextTick(function(){})},300)},200))},restorePlayback:function(){if(this.confirmIfHasOngoingTasks("恢复播放","restore")){this.cancelOngoingTasks(!0),this.isImmersiveMode&&(this.isImmersiveMode=!1,this.viewportController&&(this.viewportController.setHeaderHeight(36),this.viewportController.setFooterHeight(154)));var e=this.currentModule,t=null,i=this.originalVideoItem,a=null;"svga"===e&&this.svga.hasFile?t=this.svga.file:"yyeva"===e&&this.yyeva.hasFile?(t=this.yyeva.file,a=this.yyeva.alphaPosition):"mp4"===e&&this.mp4.hasFile?t=this.mp4.file:"lottie"===e&&this.lottie.hasFile?t=this.lottie.file:"frames"===e&&this.frames.hasFile&&(t=this.frames.file),t?(this.bgColorKey="pattern",this.replacedImages={},this.clearAllMaterialEditStates&&this.clearAllMaterialEditStates(),this.editor&&(this.editor.show=!1,this.editor.targetIndex=-1,window.MeeWoo.Core.MaterialState.resetEditorState(this.editor)),this.showCompressModal=!1,this.isCompressingMaterials=!1,this.compressProgress=0,this.hasCompressedMaterials=!1,this.preCompressMaterials=null,this.preCompressReplacedImages=null,this.chromaKeyEnabled=!1,this.chromaKeyApplied=!1,this.chromaKeySimilarity=40,this.chromaKeySmoothness=20,this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null),this.showSpeedRemapEditor=!1,this.speedRemapConfig={enabled:!1,keyframes:[],originalTotalFrames:0,originalDuration:0,fps:30},this.selectedKeyframeIndex=-1,this.timelineHoverX=-1,this.isPlaying&&this.togglePlay(),this.currentFrame=0,this.currentTime=0,this.progress=0,"svga"===e?this.loadSvgaFile({file:t,videoItem:i}):"yyeva"===e?this.loadYyeva({file:t,alphaPosition:a}):"mp4"===e?this.loadMp4File({file:t}):"lottie"===e?this.loadLottie({file:t}):"frames"===e&&this.loadFrames({file:t}),this.utils.showToast("已恢复到初始状态")):this.utils.showToast("没有文件可以恢复")}},loadHelpContent:function(){var e=this;this.loadLibrary("marked",!1).then(function(){return fetch("./help.md")}).then(function(e){return e.text()}).then(function(t){e.helpContent=marked.parse(t)}).catch(function(t){e.helpContent="<p>无法加载帮助文档</p>"})},initSvgaPlayer:function(){var e=this,t=this.$refs.svgaContainer;t&&(this.svgaPlayer=new SVGA.Player(t),this.svgaParser=new SVGA.Parser,this.svgaPlayer.onFrame(function(t){"svga"===e.currentModule&&e.totalFrames>0&&(e.currentFrame=t,e.progress=Math.round(t/e.totalFrames*100),e.currentTime=t/(e.svgaFps||30),e.playerController&&e.playerController.syncAudio&&e.isPlaying&&e.playerController.syncAudio(t))}))},initEmptyStateSvgaPlayer:function(e){void 0===e&&(e=0);var t=this,i=this.$refs.emptyStateSvgaContainer;if(i)this.emptyStateSvgaPlayer=new SVGA.Player(i),this.emptyStateSvgaParser=new SVGA.Parser,fetch("assets/svga/file-list.json").then(function(e){if(!e.ok)throw new Error("无法加载文件列表");return e.json()}).then(function(e){if(e&&0!==e.length){var i="assets/svga/"+e[Math.floor(Math.random()*e.length)];t.emptyStateSvgaParser.load(i,function(e){t.emptyStateSvgaPlayer.setVideoItem(e),t.emptyStateSvgaPlayer.startAnimation()},function(e){alert("加载空状态SVGA失败")})}}).catch(function(e){alert("读取SVGA文件列表失败")});else{if(e>50)return;setTimeout(function(){t.initEmptyStateSvgaPlayer(e+1)},100)}},loadSvgaFile:function(e){var t=this,i=e.file,a=e.videoItem,o=++this.currentLoadTaskId;this.isLoading=!0,this.switchMode("svga"),this.svga.hasFile=!0,window.MeeWoo&&window.MeeWoo.Controllers&&window.MeeWoo.Controllers.UserTypeController&&setTimeout(()=>{window.MeeWoo.Controllers.UserTypeController.refresh()},0),this.svga.file=Object.freeze(i),this.svga.fileInfo.name=i.name,this.svga.fileInfo.size=i.size,this.svga.fileInfo.sizeText=this.utils.formatBytes(i.size),this.originalVideoItem=a,this.extractMaterialList(a);try{if(a.videoSize){var n=a.videoSize.width||0,r=a.videoSize.height||0;t.svga.fileInfo.sizeWH=n+" × "+r,t.svga.originalWidth=n,t.svga.originalHeight=r}t.svga.fileInfo.fps=a.FPS||a.fps||null;var s=a.frames||a.framesCount||a.framesLength||0;t.totalFrames=s,t.svgaFps=t.svga.fileInfo.fps||30,t.totalDuration=s/t.svgaFps,t.svga.fileInfo.duration=t.totalDuration.toFixed(2)+"s",t.currentTime=0}catch(c){}this.footerTransitioning=!0,this.footerContentVisible=!1;var l=i.arrayBuffer().then(function(e){return o!==t.currentLoadTaskId?Promise.reject("task_cancelled"):t.parseSvgaAudioData(e)}),h=new Promise(function(e){setTimeout(e,50)});Promise.all([l,h]).then(function(e){if(o===t.currentLoadTaskId){t.isLoading=!1,t.footerTransitioning=!1,t.footerContentVisible=!0,t.svgaPlayer||t.initSvgaPlayer(),i&&(t.svgaObjectUrl=t.resourceManager.createObjectURL(i,"svga"));var n=null,r=e[0];n=r&&r.audios&&r.audios.length>0?r.audios:t.svgaMovieData&&t.svgaMovieData.audios&&t.svgaMovieData.audios.length>0?t.svgaMovieData.audios:a.audios,t.svgaAudios=n?JSON.parse(JSON.stringify(n)):[],a.audios&&(a.audios=[]),t.svgaPlayer.setVideoItem(a),t.svgaPlayer.onFrame(function(e){"svga"===t.currentModule&&t.totalFrames>0&&(t.currentFrame=e,t.progress=Math.round(e/t.totalFrames*100),t.currentTime=e/(t.svgaFps||30),t.playerController&&t.playerController.syncAudio&&t.playerController.syncAudio(e))}),t.svgaPlayer&&(t.svgaPlayer.startAnimation(),t.isPlaying=!0),t.playerController||t.initPlayerController(),t.currentFrame=0,t.progress=0,t.applyCanvasBackground(),a.videoSize&&t.viewportController&&t.viewportController.resetView()}}).catch(function(e){"task_cancelled"!==e&&(console.error("SVGA Load Error:",e),o===t.currentLoadTaskId&&(t.isLoading=!1,t.footerTransitioning=!1,t.footerContentVisible=!0,t.svgaPlayer||t.initSvgaPlayer(),t.svgaPlayer.setVideoItem(a),t.svgaPlayer&&(t.svgaPlayer.startAnimation(),t.isPlaying=!0),t.playerController||t.initPlayerController()))})},loadLottieFile:function(e){var t=this,i=e.file,a=e.animationData,o=++this.currentLoadTaskId;this.switchMode("lottie");var n=a.w||a.width||0,r=a.h||a.height||0,s=a.fr||30,l=a.ip||0,h=(a.op||0)-l,c=h/s;this.lottie.hasFile=!0,this.lottie.file=Object.freeze(i),this._lottieAnimationData=a,this.lottie.animationData=null,this.lottie.originalWidth=n,this.lottie.originalHeight=r,this.lottie.frameRate=s,this.lottie.fileInfo.name=i.name,this.lottie.fileInfo.size=i.size,this.lottie.fileInfo.sizeText=this.utils.formatBytes(i.size),this.lottie.fileInfo.fps=s+" FPS",this.lottie.fileInfo.sizeWH=n+"x"+r,this.lottie.fileInfo.width=n,this.lottie.fileInfo.height=r,this.lottie.fileInfo.duration=c.toFixed(2)+"s",this.totalFrames=h,this.currentFrame=0,this.progress=0,this.isPlaying=!1,this.totalDuration=c,this.currentTime=0,this.footerTransitioning=!0,this.footerContentVisible=!1,this.loadLibrary("lottie",!0).then(function(){o===t.currentLoadTaskId&&t.initLottiePlayer()}).catch(function(e){console.error("Lottie Load Error:",e),alert("Lottie库加载失败，请刷新页面重试"),t.switchMode("svga")})},loadYyeva:function(e){var t,i=this,a=e.file,o=e.alphaPosition||"right";if(e.detectionTaskId){if((t=e.detectionTaskId)!==this.currentLoadTaskId)return void console.warn("YYEVA加载任务已过期 (TaskId mismatch)",t,"当前:",this.currentLoadTaskId)}else t=++this.currentLoadTaskId;this.switchMode("yyeva"),this.yyeva.hasFile=!0,this.yyeva.file=Object.freeze(a),this.yyeva.fileInfo.name=a.name,this.yyeva.fileInfo.size=a.size,this.yyeva.fileInfo.sizeText=this.utils.formatBytes(a.size),this.footerTransitioning=!0,this.footerContentVisible=!1;var n=this.resourceManager.createObjectURL(a,"yyeva");this.yyevaObjectUrl=n;var r=document.createElement("video");r.src=n,r.crossOrigin="anonymous",r.preload="auto",r.loop=!0,r.muted=!0,r.onloadedmetadata=function(){if(t!==i.currentLoadTaskId)return console.warn("YYEVA加载任务已取消 (TaskId mismatch)",t),r.onerror=null,r.pause(),r.src="",void(i.resourceManager&&i.resourceManager.revokeObjectURL(n,"yyeva"));var a=r.videoWidth,s=r.videoHeight,l=r.duration,h=e.detectedFps||i.yyeva.detectedFps||30;e.detectedFps&&(i.yyeva.detectedFps=e.detectedFps);var c=Math.round(l*h);i.yyeva.displayWidth=Math.floor(a/2),i.yyeva.displayHeight=s,i.yyeva.fileInfo.sizeWH=i.yyeva.displayWidth+" × "+i.yyeva.displayHeight,i.yyeva.fileInfo.width=i.yyeva.displayWidth,i.yyeva.fileInfo.height=i.yyeva.displayHeight,i.yyeva.fileInfo.fps=(e.detectedFps||i.yyeva.detectedFps?e.detectedFps||i.yyeva.detectedFps:"30 (Default)")+" FPS",i.yyeva.fileInfo.duration=l.toFixed(2)+"s",i.totalFrames=c,i.totalDuration=l,i.currentFrame=0,i.currentTime=0,i.progress=0,i.isPlaying=!1,i.yyevaVideo=r,i.yyevaAlphaPosition="left",i.yyeva.alphaPosition=o,i.yyevaHasAudio=i.detectVideoHasAudio(r),setTimeout(function(){t===i.currentLoadTaskId&&(i.footerTransitioning=!1,i.footerContentVisible=!0,i.initYyevaCanvas(),i.viewportController&&i.viewportController.resetView(),r.onseeked=function(){r.onseeked=null,t===i.currentLoadTaskId&&(i.renderYyevaFrame(),setTimeout(function(){t===i.currentLoadTaskId&&r.play().then(function(){t===i.currentLoadTaskId?(i.isPlaying=!0,i.startYyevaRenderLoop(),i.isMuted||(r.muted=!1),setTimeout(function(){if(t===i.currentLoadTaskId){var e=i.detectVideoHasAudio(r);e!==i.yyevaHasAudio&&(i.yyevaHasAudio=e)}},500)):r.pause()}).catch(function(e){alert("播放失败")})},100))},r.currentTime=.1)},400)},r.onerror=function(){t===i.currentLoadTaskId&&(i.resourceManager&&i.resourceManager.revokeObjectURL(n,"mp4"),alert("视频加载失败"))}},loadMp4File:function(e){var t=this,i=e.file,a=++this.currentLoadTaskId;this.switchMode("mp4"),this.showSpeedRemapEditor=!1,this.speedRemapConfig={enabled:!1,keyframes:[],originalTotalFrames:0,originalDuration:0,fps:30},this.selectedKeyframeIndex=-1,this.mp4.hasFile=!0,this.mp4.file=Object.freeze(i),this.mp4.fileInfo.name=i.name,this.mp4.fileInfo.size=i.size,this.mp4.fileInfo.sizeText=this.utils.formatBytes(i.size),this.mp4ObjectUrl=this.resourceManager.createObjectURL(i,"mp4");var o=document.createElement("video");o.src=this.mp4ObjectUrl,o.crossOrigin="anonymous",o.preload="auto",o.muted=this.isMuted,o.loop=!0,o.playsInline=!0,o.disableRemotePlayback=!0,o.controls=!1,o.autoplay=!1,o.style.cssText="display: block; width: 100%; height: 100%; object-fit: contain;",this.mp4Video=o,o.onloadedmetadata=function(){if(a!==t.currentLoadTaskId)return console.warn("MP4加载任务已取消 (TaskId mismatch)",a),o.onerror=null,o.pause(),void(o.src="");var i=o.videoWidth,n=o.videoHeight,r=o.duration,s=e.detectedFps||t.mp4.detectedFps||30;e.detectedFps&&(t.mp4.detectedFps=e.detectedFps);var l=Math.round(r*s);t.mp4.originalWidth=i,t.mp4.originalHeight=n,t.mp4.fileInfo.sizeWH=i+"x"+n,t.mp4.fileInfo.fps=(e.detectedFps||t.mp4.detectedFps?e.detectedFps||t.mp4.detectedFps:"30 (Default)")+" FPS",t.mp4.fileInfo.duration=r.toFixed(2)+"s",t.totalFrames=l,t.totalDuration=r,t.currentFrame=0,t.currentTime=0,t.progress=0,t.isPlaying=!1,t.mp4HasAudio=t.detectVideoHasAudio(o);var h=t.$refs.svgaContainer;h&&(h.innerHTML="",h.appendChild(o)),t.viewportController&&t.viewportController.resetView(),t.footerTransitioning=!0,t.footerContentVisible=!1,setTimeout(function(){a===t.currentLoadTaskId&&(t.footerTransitioning=!1,t.footerContentVisible=!0,setTimeout(function(){a===t.currentLoadTaskId&&o.play().then(function(){a===t.currentLoadTaskId?(t.isPlaying=!0,t.startMp4ProgressLoop(),setTimeout(function(){if(a===t.currentLoadTaskId){var e=t.detectVideoHasAudio(o);e!==t.mp4HasAudio&&(t.mp4HasAudio=e)}},500)):o.pause()}).catch(function(e){alert("播放失败")})},100))},400)},o.onerror=function(){a===t.currentLoadTaskId&&(URL.revokeObjectURL(t.mp4ObjectUrl),alert("视频加载失败"))}},parseSizeWH:function(e){var t=0,i=0;if(e){var a=e.split("x");(2===a.length||2===(a=e.split(" × ")).length)&&(t=parseInt(a[0]),i=parseInt(a[1]))}return{width:t,height:i}},openStandardMp4Panel:function(e){var t="svga"===e?this.svga.fileInfo:"lottie"===e?this.lottie.fileInfo:this.yyeva.fileInfo;if(t){var i=0,o=0;if("svga"===e)i=this.svga.originalWidth,o=this.svga.originalHeight;else if("lottie"===e){var n=this.parseSizeWH(t.sizeWH);i=n.width,o=n.height}else"yyeva"===e&&(i=this.yyeva.displayWidth,o=this.yyeva.displayHeight);if(!i||!o){var r=this.parseSizeWH(t.sizeWH);i=r.width,o=r.height}var s=30;t.fps&&(s=parseInt(t.fps)||30),this.standardMp4SourceInfo={sizeWH:t.sizeWH||i+" × "+o,duration:t.duration||"",typeLabel:"svga"===e?"SVGA":"yyeva"===e?"MP4":"Lottie"},this.standardMp4Config={width:i,height:o,quality:80,fps:s,muted:!1,aspectRatio:i/o},this.openRightPanel("showStandardMp4Panel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}},closeStandardMp4Panel:function(){this.showStandardMp4Panel=!1},cancelStandardMp4Conversion:function(){this.isConvertingStandardMp4=!1},startStandardMp4Conversion:async function(e){if(!this.isConvertingStandardMp4){var t=this;if(this.confirmIfHasOngoingTasks("转换为普通MP4","task")){this.isConvertingStandardMp4=!0,this.standardMp4Progress=0,this.standardMp4Message="准备中...";var i=e||this.standardMp4Config;if(!i.width||!i.height)return alert("请输入有效的尺寸"),void(this.isConvertingStandardMp4=!1);try{await a.FFmpegService.init()}catch(I){return alert("FFmpeg加载失败："+I.message),void(this.isConvertingStandardMp4=!1)}try{var o=null;this.taskManager&&(o=this.taskManager.register("转换为普通MP4",function(){t.isConvertingStandardMp4=!1,t.standardMp4Progress=0}));var n="svga"===this.currentModule?this.svga.fileInfo:"lottie"===this.currentModule?this.lottie.fileInfo:this.yyeva.fileInfo,r=this.isPlaying;await this.pauseForExport();var s=[],l=i.fps,h=this.totalDuration||0;h<=0&&(h=1);for(var c=Math.ceil(h*l),d=parseFloat(n.fps)||30,g=function(){if(!t.isConvertingStandardMp4)throw new Error("User Cancelled")},f=0;f<c;f++){g();var u=f/l,m=Math.round(u*d);await this.seekToFrame(m,d,n),"yyeva"===t.currentModule?(await new Promise(function(e){var i=0,a=function(){t.yyevaVideo.readyState>=2||++i>25?e():setTimeout(a,20)};a()}),await new Promise(function(e){setTimeout(e,30)})):await new Promise(function(e){setTimeout(e,50)});var p=null;if("yyeva"===t.currentModule){if(t.renderYyevaFrame(),!(p=t.yyevaCanvas)){console.error("YYEVA Canvas not found");continue}p.width!==i.width||(p.height,i.height)}else p=this.getCurrentFrameCanvas();if(p){var v=document.createElement("canvas");v.width=i.width,v.height=i.height;var y=v.getContext("2d"),w=t.currentBgColor;w&&"transparent"!==w&&"rgba(0,0,0,0)"!==w&&"pattern"!==t.bgColorKey||(w="#000000"),y.fillStyle=w,y.fillRect(0,0,i.width,i.height),y.drawImage(p,0,0,i.width,i.height);for(var C=v.toDataURL("image/jpeg",i.quality),M=atob(C.split(",")[1]),S=M.length,b=new Uint8Array(S);S--;)b[S]=M.charCodeAt(S);s.push(b)}}var F=null;if(!i.muted&&"yyeva"===this.currentModule&&this.yyeva.file)try{F=new Uint8Array(await this.yyeva.file.arrayBuffer())}catch(I){console.warn("读取音频数据失败:",I)}else if(!i.muted&&"svga"===this.currentModule&&this.svgaAudioData){var k=Object.keys(this.svgaAudioData);k.length>0&&(F=this.svgaAudioData[k[0]])}this.standardMp4Message="FFmpeg转换中...";var P=await a.FFmpegService.convertFramesToMp4({frames:s,fps:l,quality:i.quality,audioData:F,muted:i.muted,onProgress:function(e){t.standardMp4Progress=30+Math.round(70*e),t.standardMp4Message=e<.3?"写入文件...":e<.9?"编码中...":"生成文件中..."},checkCancelled:function(){return!t.isConvertingStandardMp4}}),x=(("svga"===this.currentModule?this.svga.fileInfo.name:"lottie"===this.currentModule?this.lottie.fileInfo.name:this.yyeva.fileInfo.name)||"output").replace(/\.[^/.]+$/,"")+".mp4";this.utils.downloadFile(P,x),alert("转换成功！"),this.closeStandardMp4Panel()}catch(I){"User Cancelled"===I.message||("FFmpeg服务正忙，请稍后再试"===I.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error(I),alert("转换失败: "+I.message)))}finally{this.taskManager&&o&&this.taskManager.finish(o),this.isConvertingStandardMp4=!1,r&&this.resumeAfterExport()}}}},initPlayerController:function(){var e=this;this.playerController&&(this.playerController.destroy(),this.playerController=null),this.$nextTick(function(){var t=e.$refs.progressBar,a=e.$refs.progressThumb,o=e.$refs.volumeSliderTrack,n=e.$refs.volumeSliderHandle;t&&a&&(e.playerController=new i.PlayerController({progressBar:t,progressThumb:a,volumeBar:o,volumeThumb:n,onProgressChange:function(t,i){e.progress=t,e.currentFrame=i,e.totalDuration>0&&(e.currentTime=t/100*e.totalDuration)},onVolumeChange:function(t){e.volume=t},onPlayStateChange:function(t){e.isPlaying=t},getPlayerState:function(){return{mode:e.currentModule,isPlaying:e.isPlaying,progress:e.progress,totalFrames:e.totalFrames,totalDuration:e.totalDuration,currentTime:e.currentTime,isMuted:e.isMuted,hasFile:e.svga.hasFile||e.yyeva.hasFile||e.mp4.hasFile||e.lottie.hasFile||e.frames.hasFile,svgaPlayer:e.svgaPlayer,lottiePlayer:e.lottiePlayer,yyevaVideo:e.yyevaVideo,yyevaAnimationId:e.yyevaAnimationId,mp4Video:e.mp4Video,speedRemapConfig:e.speedRemapConfig,svgaAudios:e.svgaAudios,svgaAudioData:e.svgaAudioData,videoItem:e.originalVideoItem,startYyevaRenderLoop:function(){e.startYyevaRenderLoop()},startMp4ProgressLoop:function(){e.startMp4ProgressLoop()},stopFramesPlayLoop:function(){e.stopFramesPlayLoop()},startFramesPlayLoop:function(){e.startFramesPlayLoop()},renderYyevaFrame:function(){e.renderYyevaFrame()},seekFramesTo:function(t){e.seekFramesTo(t)}}}}))})},initViewportController:function(){var e=this;this.viewportController&&(this.viewportController.destroy(),this.viewportController=null),this.viewportController=new i.ViewportController({getContentSize:function(){return e.getContentOriginalSize()},onViewportChange:function(t,i,a,o){e.viewerScale=t,e.viewerOffsetX=i,e.viewerOffsetY=a,void 0!==o&&(e.dragging=o),e.viewMode=e.viewportController.getViewMode()},footerHeight:154,screenHeightRatio:.75,minScale:.1,maxScale:5,zoomStep:.1})},togglePlay:function(){this.playerController&&this.playerController.togglePlay()},toggleMute:function(){this.hasAudio&&(this.isMuted=!this.isMuted,this.playerController&&this.playerController.setMuted(this.isMuted))},startVolumeDrag:function(e){e.preventDefault(),this.isDraggingVolume=!0,this.updateVolume(e),document.addEventListener("mousemove",this.updateVolume),document.addEventListener("mouseup",this.stopVolumeDrag),document.addEventListener("touchmove",this.updateVolume),document.addEventListener("touchend",this.stopVolumeDrag)},updateVolume:function(e){if(this.isDraggingVolume){e.preventDefault();var t=e.currentTarget;if(t){var i=t.getBoundingClientRect(),a=e.clientY||e.touches&&e.touches[0]&&e.touches[0].clientY;if(a){var o=a-i.top,n=1-Math.max(0,Math.min(1,o/i.height));this.volume=n,this.playerController&&this.playerController.setVolume(n)}}}},stopVolumeDrag:function(){this.isDraggingVolume=!1,document.removeEventListener("mousemove",this.updateVolume),document.removeEventListener("mouseup",this.stopVolumeDrag),document.removeEventListener("touchmove",this.updateVolume),document.removeEventListener("touchend",this.stopVolumeDrag)},detectVideoHasAudio:function(e){if(void 0!==e.audioTracks&&null!==e.audioTracks)return e.audioTracks.length>0;if(void 0!==e.mozHasAudio)return e.mozHasAudio;if(void 0!==e.webkitAudioDecodedByteCount){if(e.webkitAudioDecodedByteCount>0)return!0;if(e.currentTime>.2)return!1}return!0},initLottiePlayer:function(){var e=this,t=this.$refs.svgaContainer;t&&(t.innerHTML="",this.lottiePlayer=lottie.loadAnimation({container:t,renderer:"canvas",loop:!0,autoplay:!1,animationData:this._lottieAnimationData}),this.lottiePlayer.addEventListener("enterFrame",function(t){e.currentFrame=Math.floor(t.currentTime);var i=e.lottie.frameRate||30;e.currentTime=t.currentTime/i,e.totalDuration>0?e.progress=Math.round(e.currentTime/e.totalDuration*100):e.progress=Math.round(t.currentTime/e.totalFrames*100)}),this.lottiePlayer.addEventListener("loopComplete",function(){e.currentFrame=0,e.progress=0}),setTimeout(function(){e.footerTransitioning=!1,e.footerContentVisible=!0,e.$nextTick(function(){e.applyCanvasBackground(),e.viewportController&&e.viewportController.resetView(),setTimeout(function(){e.playerController&&!e.isPlaying&&e.playerController.togglePlay()},100)})},400))},cleanupLottie:function(){this.lottiePlayer&&(this.lottiePlayer.destroy(),this.lottiePlayer=null),this.lottieCanvas=null,this.lottieCtx=null,this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.lottie={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0,animationData:null},this._lottieAnimationData=null,this.isPlaying=!1,this.progress=0,this.currentFrame=0,this.totalFrames=0},loadFrameSequence:function(e){var t=this,i=this.utils.sortFilesByName(e),a=i[0],o=new FileReader;o.onload=function(e){var o=new Image;o.onload=function(){t.switchMode("frames");var e=i.reduce(function(e,t){return e+t.size},0);t.frames={hasFile:!0,files:i,fileInfo:{name:a.name+" 等 "+i.length+" 帧",size:e,sizeText:t.utils.formatBytes(e),fps:25,sizeWH:o.width+" x "+o.height,duration:(i.length/25).toFixed(2)+"s"},originalWidth:o.width,originalHeight:o.height},t.totalFrames=i.length,t.currentFrame=0,t.progress=0,t.isPlaying=!1,t.framesFpsInput=25,t.showFramesFpsDialog=!0,t.preloadFrameImages()},o.src=e.target.result},o.readAsDataURL(a)},loadFrames:function(e){var t=this,i=e.file;if(!Array.isArray(i)){if(!(this.frames.files&&this.frames.files.length>0))return void console.error("没有可以加载的序列帧文件");i=this.frames.files}var a=this.utils.sortFilesByName(i),o=a[0],n=new FileReader;n.onload=function(e){var i=new Image;i.onload=function(){var e=a.reduce(function(e,t){return e+t.size},0);t.frames={hasFile:!0,files:a,fileInfo:{name:o.name+" 等 "+a.length+" 帧",size:e,sizeText:t.utils.formatBytes(e),fps:25,sizeWH:i.width+" x "+i.height,duration:(a.length/25).toFixed(2)+"s"},originalWidth:i.width,originalHeight:i.height},t.totalFrames=a.length,t.currentFrame=0,t.progress=0,t.isPlaying=!1,t.preloadFrameImages(),t.footerTransitioning=!0,t.footerContentVisible=!1,setTimeout(function(){t.footerTransitioning=!1,t.footerContentVisible=!0,t.$nextTick(function(){t.viewportController&&t.viewportController.resetView()})},300)},i.src=e.target.result},n.readAsDataURL(o)},preloadFrameImages:async function(){var e=this,t=this.frames.files;this.framesImages=new Array(t.length).fill(null);for(var i=[],a=0;a<t.length;a++)i.push({index:a,file:t[a]});for(var o=async function(){if(0!==i.length){var t=i.shift();try{var a=e.resourceManager.createObjectURL(t.file,"frames"),n=await new Promise(function(e,t){var i=new Image;i.onload=function(){e(i)},i.onerror=t,i.src=a});e.framesImages[t.index]=n}catch(r){console.error("Failed to load frame "+t.index,r)}await o()}},n=[],r=0;r<Math.min(5,t.length);r++)n.push(o());await Promise.all(n),this.framesImages=this.framesImages.filter(function(e){return null!==e}),this.initFramesPlayer()},initFramesPlayer:function(){var e=this.$refs.svgaContainer;if(e){e.innerHTML="";var t=document.createElement("canvas");t.width=this.frames.originalWidth,t.height=this.frames.originalHeight,t.style.width=this.frames.originalWidth+"px",t.style.height=this.frames.originalHeight+"px",e.appendChild(t),this.framesCanvas=t,this.framesCtx=t.getContext("2d",{alpha:!0}),this.applyCanvasBackground(),this.renderFramesFrame(0)}},renderFramesFrame:function(e){if(this.framesCtx&&this.framesImages.length){var t=this.framesImages[e];if(t){var i=this.framesCtx;i.clearRect(0,0,this.framesCanvas.width,this.framesCanvas.height),i.drawImage(t,0,0),this.currentFrame=e;var a=this.frames.fileInfo.fps||25;this.currentTime=e/a,this.totalDuration>0?this.progress=this.currentTime/this.totalDuration*100||0:this.progress=e/(this.totalFrames-1)*100||0}}},startFramesPlayLoop:function(){var e=this,t=1e3/(this.frames.fileInfo.fps||25);this.framesStartTime=performance.now()-this.currentFrame*t;var i=function(a){if(e.isPlaying&&"frames"===e.currentModule){var o=a-e.framesStartTime,n=Math.floor(o/t)%e.totalFrames;e.renderFramesFrame(n),e.framesAnimationId=requestAnimationFrame(i)}};this.framesAnimationId=requestAnimationFrame(i)},stopFramesPlayLoop:function(){this.framesAnimationId&&(cancelAnimationFrame(this.framesAnimationId),this.framesAnimationId=null)},seekFramesTo:function(e){if(e<0&&(e=0),e>=this.totalFrames&&(e=this.totalFrames-1),this.renderFramesFrame(e),this.isPlaying){var t=1e3/(this.frames.fileInfo.fps||25);this.framesStartTime=performance.now()-e*t}},confirmFramesFps:function(){var e=this,t=parseInt(this.framesFpsInput)||25;t<1&&(t=1),t>120&&(t=120),this.frames.fileInfo.fps=t,this.frames.fileInfo.duration=(this.totalFrames/t).toFixed(2)+"s",this.showFramesFpsDialog=!1,this.totalDuration=this.totalFrames/t,this.currentTime=0,void 0===this.framesWasPlayingBeforeDialog?(this.footerTransitioning=!0,this.footerContentVisible=!1,setTimeout(function(){e.footerTransitioning=!1,e.footerContentVisible=!0,e.$nextTick(function(){e.viewportController&&e.viewportController.resetView(),setTimeout(function(){e.isPlaying=!0,e.startFramesPlayLoop()},50)})},400)):(this.framesWasPlayingBeforeDialog&&(this.isPlaying=!0,this.startFramesPlayLoop()),this.framesWasPlayingBeforeDialog=void 0)},openChangeFpsDialog:function(){this.framesFpsInput=this.frames.fileInfo.fps||25,this.showFramesFpsDialog=!0,this.framesWasPlayingBeforeDialog=this.isPlaying,this.isPlaying&&(this.isPlaying=!1,this.stopFramesPlayLoop())},cleanupFrames:function(){this.stopFramesPlayLoop(),this.framesBlobUrls&&(this.framesBlobUrls=[]),this.framesCanvas=null,this.framesCtx=null,this.framesImages=[],this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.frames={hasFile:!1,files:[],fileInfo:{name:"",size:0,sizeText:"",fps:25,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},this.isPlaying=!1,this.progress=0,this.currentFrame=0,this.totalFrames=0},detectAlphaPosition:function(e){var t=document.createElement("canvas"),i=t.getContext("2d",{willReadFrequently:!0}),a=Math.floor(e.videoWidth/2),o=e.videoHeight;t.width=e.videoWidth,t.height=o,i.drawImage(e,0,0);var n=i.getImageData(a/4,o/4,10,10),r=i.getImageData(a+a/4,o/4,10,10),s=this.calculateColorVariance(n.data),l=this.calculateColorVariance(r.data);this.yyeva.alphaPosition=s<l?"left":"right"},calculateColorVariance:function(e){for(var t=0,i=0;i<e.length;i+=4){var a=e[i],o=e[i+1],n=e[i+2];t+=Math.abs(a-o)+Math.abs(o-n)+Math.abs(a-n)}return t},initYyevaCanvas:function(){var e=this.$refs.svgaContainer;if(e){e.innerHTML="";var t=document.createElement("canvas");t.width=this.yyeva.displayWidth,t.height=this.yyeva.displayHeight,t.style.width=this.yyeva.displayWidth+"px",t.style.height=this.yyeva.displayHeight+"px",e.appendChild(t),this.yyevaCanvas=t,this.yyevaCtx=t.getContext("2d",{willReadFrequently:!0,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1}),this.yyevaTempCanvas=document.createElement("canvas"),this.yyevaTempCtx=this.yyevaTempCanvas.getContext("2d",{willReadFrequently:!0,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1}),this.yyevaPixelPool={colorData:null,alphaData:null,halfWidth:0,height:0}}},startYyevaRenderLoop:function(){var e=this,t=0;!function i(a){e.yyevaVideo&&e.yyevaCanvas&&e.yyevaCtx&&(a||(a=performance.now()),e.renderYyevaFrame(),a-t>30&&(e.updateYyevaProgress(),t=a),e.yyevaAnimationId=requestAnimationFrame(i))}()},renderYyevaFrame:function(){var e=this.yyevaVideo,t=this.yyevaCanvas,i=this.yyevaCtx;if(e&&t&&i&&!(e.readyState<2)){var a=Math.floor(e.videoWidth/2),o=e.videoHeight,n="left"!==this.yyeva.alphaPosition,r=n?0:a,s=n?a:0,l=this.yyevaTempCanvas,h=this.yyevaTempCtx;if(l.width===e.videoWidth&&l.height===o||(l.width=e.videoWidth,l.height=o),h.clearRect(0,0,l.width,l.height),h.drawImage(e,0,0),this.yyevaPixelPool||(this.yyevaPixelPool={colorData:null,alphaData:null,halfWidth:0,height:0}),this.yyevaPixelPool.colorData&&this.yyevaPixelPool.halfWidth===a&&this.yyevaPixelPool.height===o)try{var c=h.getImageData(r,0,a,o),d=h.getImageData(s,0,a,o);this.yyevaPixelPool.colorData.data.set(c.data),this.yyevaPixelPool.alphaData.data.set(d.data)}catch(p){this.yyevaPixelPool.colorData=h.getImageData(r,0,a,o),this.yyevaPixelPool.alphaData=h.getImageData(s,0,a,o)}else this.yyevaPixelPool.colorData=h.getImageData(r,0,a,o),this.yyevaPixelPool.alphaData=h.getImageData(s,0,a,o),this.yyevaPixelPool.halfWidth=a,this.yyevaPixelPool.height=o;for(var g=this.yyevaPixelPool.colorData,f=this.yyevaPixelPool.alphaData,u=0;u<g.data.length;u+=4){var m=f.data[u];m>0&&(g.data[u]=Math.min(255,255*g.data[u]/m),g.data[u+1]=Math.min(255,255*g.data[u+1]/m),g.data[u+2]=Math.min(255,255*g.data[u+2]/m)),g.data[u+3]=m}i.clearRect(0,0,t.width,t.height),i.putImageData(g,0,0)}},updateYyevaProgress:function(){if(this.yyevaVideo){var e=this.yyevaVideo,t=e.currentTime;this.cachedDuration&&!isNaN(this.cachedDuration)||(this.cachedDuration=e.duration||1);var i=this.cachedDuration;this.cachedFps||(this.cachedFps=this.yyeva.detectedFps||30);var a=this.cachedFps;if(!(Math.abs(t-(this.lastCurrentTime||0))<.01)){this.lastCurrentTime=t;var o=t/i*100;this.currentTime!==t&&(this.currentTime=t),this.totalDuration!==i&&(this.totalDuration=i),this.progress!==o&&(this.progress=o);var n=Math.round(t*a);this.currentFrame!==n&&(this.currentFrame=n)}}},cleanupSvga:function(){if(this.svgaPlayer){try{this.svgaPlayer.stopAnimation(),this.svgaPlayer.clear()}catch(t){console.warn("Stop SVGA animation failed:",t)}this.svgaPlayer=null}if(this.svgaAudioPlayer){try{this.svgaAudioPlayer.stop(),this.svgaAudioPlayer.unload()}catch(t){}this.svgaAudioPlayer=null}this.svgaObjectUrl&&(this.resourceManager&&this.resourceManager.revokeObjectURL(this.svgaObjectUrl,"svga"),this.svgaObjectUrl=null),this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.svga={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:""}},this.svgaAudioData=null,this.svgaMovieData=null,this.isPlaying=!1,this.progress=0,this.currentFrame=0,this.totalFrames=0},cleanupYyeva:function(){this.yyevaAnimationId&&(cancelAnimationFrame(this.yyevaAnimationId),this.yyevaAnimationId=null),this.yyevaVideo&&(this.yyevaVideo.onerror=null,this.yyevaVideo.onloadedmetadata=null,this.yyevaVideo.pause(),this.yyevaVideo.removeAttribute("src"),this.yyevaVideo.load(),this.yyevaVideo=null),this.yyevaObjectUrl&&(this.resourceManager&&this.resourceManager.revokeObjectURL(this.yyevaObjectUrl,"yyeva"),this.yyevaObjectUrl=null),this.yyevaCanvas=null,this.yyevaCtx=null,this.yyevaTempCanvas=null,this.yyevaTempCtx=null,this.yyevaPixelPool=null,this.cachedDuration=null,this.cachedFps=null,this.lastCurrentTime=null,this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.yyeva={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},alphaPosition:"right",originalWidth:0,originalHeight:0,displayWidth:0,displayHeight:0},this.yyevaHasAudio=!1},startMp4ProgressLoop:function(){var e=this,t=this.mp4Video;if(t){var i=1,a=-1,o=-1,n=0,r=!1,s=0;requestAnimationFrame(function l(h){if(e.mp4Video&&"mp4"===e.currentModule){if(h||(h=performance.now()),o!==t.currentTime||t.paused||t.ended)n=0;else if(++n>=120&&!r)return r=!0,t.pause(),e.isPlaying=!1,e.showVideoConvertModal=!0,e.videoConvertProgress=0,void(e.isConverting=!1);if(o=t.currentTime,t.duration>0){var c=e.mp4.detectedFps||30,d=Math.floor(t.currentTime*c);if(e.speedRemapConfig.enabled&&e.speedRemapConfig.keyframes.length>=2){for(var g=e.speedRemapConfig.keyframes,f=e.speedRemapConfig.originalTotalFrames||1,u=0,m=-1,p=Math.max(0,a),v=g.length,y=p;y<v-1;y++){var w=g[y],C=g[y+1];if(d>=w.originalFrame&&d<=C.originalFrame){if(m=y,(F=C.originalFrame-w.originalFrame)>0){var M=(d-w.originalFrame)/F;u=w.position+M*(C.position-w.position)}else u=w.position;break}}var S=g[g.length-1],b=t.duration*S.position;if(h-s>30&&(e.progress=u/S.position*100,e.currentTime=u*t.duration,e.totalDuration=b,s=h),m!==a&&-1!==m){a=m,w=g[m];var F=(C=g[m+1]).originalFrame-w.originalFrame,k=C.position-w.position;k>0&&F>0&&(i=F/(k*f),i=Math.max(.1,Math.min(12,i)),t.playbackRate=i)}}else h-s>30&&(e.currentTime=t.currentTime,e.totalDuration=t.duration,e.progress=t.currentTime/t.duration*100,s=h),1!==t.playbackRate&&(t.playbackRate=1);e.currentFrame=d}e.isPlaying&&requestAnimationFrame(l)}})}},cleanupMp4:function(){if(this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null),this.mp4Video&&(this.mp4Video.onerror=null,this.mp4Video.onloadedmetadata=null,this.mp4Video.pause(),this.mp4Video.removeAttribute("src"),this.mp4Video.load(),this.mp4Video=null),this.mp4ObjectUrl){if(this.resourceManager){var e=this.mp4ObjectUrl,t=this.resourceManager;setTimeout(function(){t.revokeObjectURL(e,"mp4")},100)}this.mp4ObjectUrl=null}this.playerController&&(this.playerController.destroy(),this.playerController=null);var i=this.$refs.svgaContainer;i&&(i.innerHTML=""),this.mp4={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},this.mp4HasAudio=!1,this.chromaKeyEnabled=!1,this.chromaKeyApplied=!1},confirmConvertVideo:async function(){var e=this;if(this.isConverting)confirm("当前正在转换视频格式，是否退出转换？")&&(this.isConverting=!1,this.showVideoConvertModal=!1);else{this.isConverting=!0,this.videoConvertProgress=0;try{if(await a.FFmpegService.init({onProgress:function(t){e.videoConvertProgress=Math.round(10*t.progress)}}),!this.isConverting)throw new Error("用户取消");var t=this.mp4.file;if(!t)throw new Error("视频文件不存在");var i=await a.FFmpegService.convertVideoFormat({inputFile:t,maxWidth:1280,onProgress:function(t){e.videoConvertProgress=10+Math.round(85*t)},checkCancelled:function(){return!e.isConverting}});this.videoConvertProgress=95;var o=new File([i],t.name.replace(/\.mp4$/,"_converted.mp4"),{type:"video/mp4"});this.cleanupMp4(),this.currentModule="mp4",this.mp4.hasFile=!0,this.mp4.file=Object.freeze(o),this.mp4.fileInfo.name=o.name,this.mp4.fileInfo.size=o.size,this.mp4.fileInfo.sizeText=this.utils.formatBytes(o.size),this.mp4ObjectUrl=this.resourceManager.createObjectURL(i,"mp4");var n=document.createElement("video");n.src=this.mp4ObjectUrl,n.loop=!0,n.playsInline=!0,n.style.cssText="display: block;",this.mp4Video=n,n.onloadedmetadata=function(){var t=n.videoWidth,i=n.videoHeight;e.mp4.originalWidth=t,e.mp4.originalHeight=i,e.mp4.fileInfo.sizeWH=t+"x"+i;var a=n.duration;e.mp4.fileInfo.duration=a.toFixed(2)+"s",e.mp4.fileInfo.fps="30 FPS",e.totalFrames=Math.round(30*a),e.mp4HasAudio=e.detectVideoHasAudio(n);var o=e.$refs.svgaContainer;o&&(o.innerHTML="",o.appendChild(n)),e.viewportController&&e.viewportController.resetView(),e.footerTransitioning=!0,e.footerContentVisible=!1,setTimeout(function(){e.footerTransitioning=!1,e.footerContentVisible=!0,setTimeout(function(){n.play().then(function(){e.isPlaying=!0,e.startMp4ProgressLoop()}).catch(function(e){alert("普通MP4播放失败")})},50)},400)},this.videoConvertProgress=100,setTimeout(function(){e.showVideoConvertModal=!1,e.isConverting=!1},500)}catch(r){"用户取消"!==r.message&&alert("视频转换失败："+r.message),this.showVideoConvertModal=!1,this.isConverting=!1}}},cancelConvertVideo:function(){this.isConverting?confirm("当前正在转换视频格式，是否退出转换？")&&(this.isConverting=!1,this.showVideoConvertModal=!1):this.showVideoConvertModal=!1},initTheme:function(){var e=sessionStorage.getItem("theme");if(null!==e)this.isDarkMode="dark"===e,this.isThemeManuallySet=!0;else{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;this.isDarkMode=t,this.isThemeManuallySet=!1}this.isDarkMode?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")},setupThemeListener:function(){var e=this,t=window.matchMedia("(prefers-color-scheme: dark)"),i=function(t){e.isThemeManuallySet||(e.isDarkMode=t.matches,e.isDarkMode?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode"))};t.addEventListener?t.addEventListener("change",i):t.addListener(i),this._themeMediaQuery=t,this._themeChangeHandler=i},toggleTheme:function(){this.isDarkMode=!this.isDarkMode,this.isDarkMode?(document.body.classList.add("dark-mode"),sessionStorage.setItem("theme","dark")):(document.body.classList.remove("dark-mode"),sessionStorage.setItem("theme","light")),this.isThemeManuallySet=!0},onWheel:function(e){this.viewportController&&this.viewportController.handleWheel(e)},onMouseDown:function(e){this.viewportController&&this.viewportController.handleMouseDown(e)},onMouseMove:function(e){this.viewportController&&this.viewportController.handleMouseMove(e)},onMouseUp:function(e){this.viewportController&&this.viewportController.handleMouseUp(e)},getContentOriginalSize:function(){if("svga"===this.currentModule&&this.svga.hasFile){var e=this.svga.fileInfo.sizeWH;if(e){var t=e.split(" × ");if(2===t.length)return{width:parseInt(t[0]),height:parseInt(t[1])}}}else{if("lottie"===this.currentModule&&this.lottie.hasFile)return{width:this.lottie.originalWidth,height:this.lottie.originalHeight};if("yyeva"===this.currentModule&&this.yyeva.hasFile)return{width:this.yyeva.displayWidth,height:this.yyeva.displayHeight};if("mp4"===this.currentModule&&this.mp4.hasFile)return{width:this.mp4.originalWidth,height:this.mp4.originalHeight};if("frames"===this.currentModule&&this.frames.hasFile)return{width:this.frames.originalWidth,height:this.frames.originalHeight}}return null},centerViewer:function(){this.viewportController&&this.viewportController.centerView()},zoomIn:function(){this.viewportController&&this.viewportController.zoomIn()},zoomOut:function(){this.viewportController&&this.viewportController.zoomOut()},resetScale:function(){this.viewportController&&this.viewportController.toggleViewMode()},toggleImmersiveMode:function(){var e=this;if(this.isImmersiveMode=!this.isImmersiveMode,this.modeNameFadeTimer&&(clearTimeout(this.modeNameFadeTimer),this.modeNameFadeTimer=null),this.isImmersiveMode?(this.modeNameFadeOut=!1,this.modeNameFadeTimer=setTimeout(function(){e.modeNameFadeOut=!0},5e3)):this.modeNameFadeOut=!1,this.viewportController){var t=this.isImmersiveMode?0:36,i=this.isImmersiveMode?80:154;this.viewportController.setHeaderHeight(t),this.viewportController.setFooterHeight(i),this.viewportController.centerView()}this.$nextTick(function(){e.initPlayerController()})},applyCanvasBackground:function(){var e=this.$refs.svgaContainer;if(e){var t=e.querySelector("canvas");t&&("pattern"===this.bgColorKey?(t.style.backgroundColor="",t.style.backgroundImage="",t.style.backgroundRepeat="",t.style.backgroundSize=""):(t.style.backgroundColor=this.currentBgColor,t.style.backgroundImage="none"))}},openMaterialPanel:function(){this.svga.hasFile&&this.originalVideoItem&&this.openRightPanel("material")},parseSvgaAudioData:function(e){var t=this;return new Promise(function(i,a){t.loadLibrary(["protobuf","pako"],!0).then(function(){try{var a=new Uint8Array(e),o=pako.inflate(a);protobuf.load("./svga.proto",function(e,a){if(e)return console.error("Protobuf load failed:",e),void i(null);try{var n=a.lookupType("com.opensource.svga.MovieEntity");if(!n)return console.error("Proto文件中未找到MovieEntity定义"),void i(null);var r=n.decode(o);if(t.svgaMovieData=r,r.audios&&r.audios.length>0&&r.images){var s={};r.audios.forEach(function(e){var t=e.audioKey;[t,t+".mp3",t+".wav","audio_"+t,t.replace(/\.[^.]+$/,"")].forEach(function(e){r.images[e]&&(s[t]=r.images[e])})}),Object.keys(s).length>0&&(t.svgaAudioData=s)}i(r)}catch(l){console.error("SVGA Parser: Decode error",l),i(null)}})}catch(n){console.error("Data processing error:",n),i(null)}}).catch(function(e){console.error("Failed to load libraries for audio parsing:",e),i(null)})})},extractMaterialList:function(e){var t=this;if(this.materialList=[],this.replacedImages={},e&&e.images){this.svga.fileInfo.memoryText="计算中...";var i=Object.keys(e.images),a=i.length,o=0,n=0,r=new Set;e.audios&&e.audios.length>0&&e.audios.forEach(function(e){if(e.audioKey){r.add(e.audioKey),r.add(e.audioKey+".mp3"),r.add(e.audioKey+".wav"),r.add("audio_"+e.audioKey);var t=e.audioKey.replace(/\.[^.]+$/,"");t!==e.audioKey&&r.add(t)}}),i.forEach(function(i){if(r.has(i))o++;else{var s=e.images[i];if(s&&s.constructor===Uint8Array&&s.length>=3&&73===s[0]&&68===s[1]&&51===s[2])o++;else{if(s&&"string"==typeof s){var l=s.startsWith("data:")?s.split(",")[1]:s;try{var h=atob(l.substring(0,8));if(h.length>=3&&73===h.charCodeAt(0)&&68===h.charCodeAt(1)&&51===h.charCodeAt(2))return void o++}catch(f){}}var c="";s&&"string"==typeof s&&(c=s.startsWith("data:")?s:"data:image/png;base64,"+s);var d=new Image,g={imageKey:i,previewUrl:c,sizeText:"计算中...",fileSizeText:"计算中...",isReplaced:!1,originalData:s,fileSize:0};t.materialList.push(g),(d=new Image).onload=function(){var e=this.width*this.height*4;g.fileSize=e,g.fileSizeText=t.utils.formatBytes(e),g.sizeText=this.width+" × "+this.height,g.originalWidth=this.width,g.originalHeight=this.height,n+=e,++o===a&&(t.svga.fileInfo.memoryText=t.utils.formatBytes(n))},d.onerror=function(){g.sizeText="-",g.fileSizeText="-",++o===a&&(t.svga.fileInfo.memoryText=n>0?t.utils.formatBytes(n):"-")},c&&(d.src=c)}}}),o===a&&(this.svga.fileInfo.memoryText=n>0?this.utils.formatBytes(n):"-")}},scaleImageToFill:function(e,t,i){var a=document.createElement("canvas");a.width=t,a.height=i;var o=a.getContext("2d",{willReadFrequently:!0}),n=e.width,r=e.height,s=t/n,l=i/r,h=Math.max(s,l),c=n*h,d=r*h,g=(t-c)/2,f=(i-d)/2;return o.clearRect(0,0,t,i),o.drawImage(e,g,f,c,d),a},getOriginalImageSize:function(e){if(!this.originalVideoItem||!this.originalVideoItem.images)return null;if(!this.originalVideoItem.images[e])return null;var t=this.materialList.find(function(t){return t.imageKey===e});return t&&t.originalWidth&&t.originalHeight?{width:t.originalWidth,height:t.originalHeight}:null},replaceMaterial:function(e){var t=this,i=this.materialList[e];if(i){var a=document.createElement("input");a.type="file",a.accept="image/png,image/jpeg,image/jpg",a.onchange=function(e){var a=e.target.files[0];if(a){var o=new FileReader;o.onload=function(e){var a=e.target.result,o=new Image;o.onload=function(){var e;e=i.originalWidth&&i.originalHeight?t.scaleImageToFill(o,i.originalWidth,i.originalHeight).toDataURL("image/png"):a,i.previewUrl=e,i.isReplaced=!0;var n=Object.assign({},t.replacedImages);n[i.imageKey]=e,t.replacedImages=n;var r=i.originalWidth||o.width,s=i.originalHeight||o.height,l=r*s*4;i.fileSize=l,i.fileSizeText=t.utils.formatBytes(l),i.sizeText=r+"px*"+s+"px",setTimeout(function(){t.applyReplacedMaterials()},300)},o.onerror=function(){alert("图片加载失败，请确保图片格式正确")},o.src=a},o.readAsDataURL(a)}},a.click()}},restoreMaterial:function(e){window.MeeWoo.Core.MaterialOperations.restoreOriginalMaterial(this,e)},downloadMaterial:function(e){var t=this.materialList[e];if(t){var i=this.replacedImages[t.imageKey]||t.previewUrl;if(i){var a=(t.imageKey||"material_"+e)+".png";this.utils.downloadFromDataURL(i,a)}else alert("图片数据不存在")}},applyReplacedMaterials:function(){if(this.svgaPlayer&&this.originalVideoItem){var e=this;this.svgaPlayer.clearDynamicObjects();var t=Object.keys(this.replacedImages),i={},a=0,o=t.length;0!==o?t.forEach(function(t){var n=e.replacedImages[t],r=new Image;r.onload=function(){i[t]=r,++a===o&&(Object.keys(i).forEach(function(t){e.svgaPlayer.setImage(i[t],t)}),e.isPlaying?e.svgaPlayer.startAnimation():e.svgaPlayer.stepToFrame(e.currentFrame))},r.onerror=function(){++a===o&&(Object.keys(i).forEach(function(t){e.svgaPlayer.setImage(i[t],t)}),e.isPlaying?e.svgaPlayer.startAnimation():e.svgaPlayer.stepToFrame(e.currentFrame))},r.src=n}):e.isPlaying?e.svgaPlayer.startAnimation():e.svgaPlayer.stepToFrame(e.currentFrame)}},openCompressAndExportModal:function(){this.showCompressModal=!0},closeCompressModal:function(){this.showCompressModal=!1},startCompressAndExport:async function(){await this.startCompressMaterials(),this.hasCompressedMaterials&&await this.exportNewSVGA()},startCompressMaterials:async function(){if(0!==this.materialList.length){this.showCompressModal=!1,this.isCompressingMaterials=!0,this.compressProgress=0,this.preCompressMaterials=JSON.parse(JSON.stringify(this.materialList)),this.preCompressReplacedImages=Object.assign({},this.replacedImages),this.preCompressScaleInfo=Object.assign({},this.compressedScaleInfo);var e=this.materialList.length,t=0,i=this.compressConfig.scalePercent/100;try{window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService&&window.MeeWoo.Services.ImageCompressionService.resetCompressionFailed();for(var a=0;a<this.materialList.length;a++){var o=this.materialList[a],n=o.previewUrl;if(n){var r=await this._loadImage(n),s=Math.round(r.width*i),l=Math.round(r.height*i);s=Math.max(1,s),l=Math.max(1,l);var h,c,d=document.createElement("canvas");if(d.width=s,d.height=l,d.getContext("2d").drawImage(r,0,0,s,l),window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService)try{var g=await window.MeeWoo.Services.ImageCompressionService.compressCanvas(d,this.compressConfig.pngQuality),f=new Blob([g],{type:"image/png"});h=await new Promise(function(e,t){var i=new FileReader;i.onloadend=function(){e(i.result)},i.onerror=t,i.readAsDataURL(f)})}catch(w){console.error("PNG压缩失败，使用Canvas原生输出:",w),h=d.toDataURL("image/png")}else h=d.toDataURL("image/png");try{c=await this._loadImage(h)}catch(C){throw C}var u=this.scaleImageToFill(c,o.originalWidth,o.originalHeight).toDataURL("image/png");o.previewUrl=u,o.isReplaced=!0,o.sizeText=s+"px*"+l+"px";var m=s*l*4;o.fileSize=m,o.fileSizeText=this.utils.formatBytes(m)+" (压缩后)";var p=Object.assign({},this.replacedImages);p[o.imageKey]=u,this.replacedImages=p;var v=Object.assign({},this.compressedScaleInfo);v[o.imageKey]={scaledWidth:s,scaledHeight:l,originalWidth:o.originalWidth,originalHeight:o.originalHeight,compressedDataUrl:h},this.compressedScaleInfo=v,t++,this.compressProgress=Math.round(t/e*100)}else t++,this.compressProgress=Math.round(t/e*100)}this.hasCompressedMaterials=!0,this.isCompressingMaterials=!1,this._recalculateTotalMemory(),this.applyReplacedMaterials();var y=!1;window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService&&(y=window.MeeWoo.Services.ImageCompressionService.hasCompressionFailed()),y?this.utils.showToast("压缩完成，但部分图片使用了降级压缩方案"):this.utils.showToast("压缩完成，共压缩 "+e+" 个素材")}catch(C){console.error("压缩失败:",C),alert("压缩失败: "+C.message),this.isCompressingMaterials=!1}}else alert("没有可压缩的素材")},undoCompressMaterials:function(){this.preCompressMaterials&&this.preCompressReplacedImages?(this.materialList=JSON.parse(JSON.stringify(this.preCompressMaterials)),this.replacedImages=Object.assign({},this.preCompressReplacedImages),this.compressedScaleInfo=Object.assign({},this.preCompressScaleInfo||{}),this.preCompressMaterials=null,this.preCompressReplacedImages=null,this.preCompressScaleInfo=null,this.hasCompressedMaterials=!1,this.showCompressModal=!1,this._recalculateTotalMemory(),this.applyReplacedMaterials(),this.utils.showToast("已撤销压缩")):alert("没有可撤销的压缩记录")},_loadImage:function(e){return new Promise(function(t,i){var a=new Image;e.startsWith("blob:")&&(a.crossOrigin="Anonymous"),a.onload=function(){t(a)},a.onerror=function(t){console.error("图片加载失败，src:",e.substring(0,100)+"..."),i(new Error("图片加载失败"))},a.src=e})},_recalculateTotalMemory:function(){for(var e=0,t=0;t<this.materialList.length;t++)this.materialList[t].fileSize&&(e+=this.materialList[t].fileSize);this.svga.fileInfo.memoryText=this.utils.formatBytes(e)},exportNewSVGA:async function(){var e=this;if(this.svga.hasFile&&this.originalVideoItem&&this.svga.file)if(0!==Object.keys(this.replacedImages).length){try{await this.loadLibrary(["protobuf","pako"],!0)}catch(i){return void alert("库加载失败，请检查网络")}try{var t=new FileReader;t.onload=function(t){try{var o=t.target.result;new Uint8Array(o),a.SvgaBuilder.decode(o,{protobuf:protobuf,pako:pako}).then(function(t){try{if(e.compressConfig.exportMuted){var i=[];t.audios&&t.audios.length>0&&t.audios.forEach(function(e){if(e.audioKey){i.push(e.audioKey),i.push(e.audioKey+".mp3"),i.push(e.audioKey+".wav"),i.push("audio_"+e.audioKey);var t=e.audioKey.replace(/\.[^.]+$/,"");t!==e.audioKey&&i.push(t)}}),t.audios=[],t.images&&i.length>0&&i.forEach(function(e){t.images[e]&&delete t.images[e]})}var o=0,n=[];for(var r in e.replacedImages)e.replacedImages.hasOwnProperty(r)&&t.images&&t.images[r]&&n.push({imageKey:r,base64Data:e.replacedImages[r]});if(0===n.length)return void alert("未找到需要替换的图片");n.forEach(function(i){for(var a,n=e.compressedScaleInfo[i.imageKey],r=(a=n&&n.compressedDataUrl?n.compressedDataUrl:i.base64Data).split(",")[1]||a,s=atob(r),l=new Uint8Array(s.length),h=0;h<s.length;h++)l[h]=s.charCodeAt(h);t.images[i.imageKey]=l,o++}),Object.keys(e.compressedScaleInfo).length>0&&t.sprites&&t.sprites.forEach(function(t){var i=e.compressedScaleInfo[t.imageKey];if(i&&t.frames){var a=i.originalWidth/i.scaledWidth;t.frames.forEach(function(e){e.transform||(e.transform={a:1,b:0,c:0,d:1,tx:0,ty:0});var t=void 0!==e.transform.a?e.transform.a:1,i=void 0!==e.transform.b?e.transform.b:0,o=void 0!==e.transform.c?e.transform.c:0,n=void 0!==e.transform.d?e.transform.d:1,r=void 0!==e.transform.tx?e.transform.tx:0,s=void 0!==e.transform.ty?e.transform.ty:0;e.transform.a=t*a,e.transform.b=i*a,e.transform.c=o*a,e.transform.d=n*a,e.transform.tx=r,e.transform.ty=s})}}),a.SvgaBuilder.encode(t,{protobuf:protobuf,pako:pako}).then(function(t){var i=e.svga.fileInfo.name.replace(/\.svga$/i,"");e.utils.downloadFile(t,i+"_modified.svga"),e.utils.showToast("导出成功！已替换 "+o+" 个素材。")}).catch(function(e){console.error("编码失败:",e),alert("编码失败: "+e.message)})}catch(s){console.error("逻辑处理失败:",s),alert("逻辑处理失败: "+s.message)}}).catch(function(e){console.error("SVGA解码失败:",e),alert("SVGA解码失败: "+e.message)})}catch(i){alert("处理 SVGA 失败: "+i.message)}},t.readAsArrayBuffer(e.svga.file)}catch(i){alert("导出 SVGA 失败: "+i.message)}}else alert("请先替换至少一个素材");else alert("请先加载 SVGA 文件")},openGifPanel:function(){var e=!1;"svga"===this.currentModule?e=this.svga.hasFile:"yyeva"===this.currentModule?e=this.yyeva.hasFile:"mp4"===this.currentModule?e=this.mp4.hasFile:"lottie"===this.currentModule?e=this.lottie.hasFile:"frames"===this.currentModule&&(e=this.frames.hasFile),e?(this.openRightPanel("gif"),this.loadLibrary("gif",!0).catch(function(e){console.warn("Library preload failed:",e)})):alert("请先加载文件")},closeGifPanel:function(){this.activeRightPanel=null},handleGifConfigChange:function(e){this.gifConfig=Object.assign({},this.gifConfig,e)},handleFramesConfigChange:function(e){this.framesConfig=Object.assign({},this.framesConfig,e)},handleGifExport:function(e){this.gifConfig=Object.assign({},this.gifConfig,e),this.startGifExport()},cancelGifExport:function(){this.gifExportCancelled=!0,this.isExportingGIF=!1,this.gifExportProgress=0,this.gifExportStage="",this.gifExportMessage=""},openFramesPanel:function(){var e=!1;"svga"===this.currentModule?e=this.svga.hasFile:"yyeva"===this.currentModule?e=this.yyeva.hasFile:"mp4"===this.currentModule?e=this.mp4.hasFile:"lottie"===this.currentModule?e=this.lottie.hasFile:"frames"===this.currentModule&&(e=this.frames.hasFile),e?(this.openRightPanel("frames"),this.loadLibrary("jszip",!0).catch(function(e){console.warn("Library preload failed:",e)})):alert("请先加载文件")},closeFramesPanel:function(){this.activeRightPanel=null},handleFramesExport:function(e){this.framesConfig=Object.assign({},this.framesConfig,e),this.startFramesExport()},cancelFramesExport:function(){this.framesExportCancelled=!0,this.isExportingFrames=!1,this.framesExportProgress=0,this.framesExportStage="",this.framesExportMessage=""},openWebpPanel:function(){var e=!1;if("svga"===this.currentModule?e=this.svga.hasFile:"yyeva"===this.currentModule?e=this.yyeva.hasFile:"mp4"===this.currentModule?e=this.mp4.hasFile:"lottie"===this.currentModule?e=this.lottie.hasFile:"frames"===this.currentModule&&(e=this.frames.hasFile),e)if("webp"!==this.activeRightPanel){var t=this;this.activeRightPanel=null,this.$nextTick(function(){t.openRightPanel("webp")})}else this.closeWebpPanel();else alert("请先加载文件")},closeWebpPanel:function(){this.activeRightPanel=null},handleWebpConfigChange:function(e){this.webpConfig=Object.assign({},this.webpConfig,e)},handleWebpExport:function(e){this.webpConfig=Object.assign({},this.webpConfig,e),this.startWebpExport()},startWebpExport:async function(){var e=this;this.isExportingWebp=!0,this.webpExportProgress=0,this.webpExportMessage="准备导出...",this.webpExportCancelled=!1;var t=this.webpConfig,i=this.getWebpSourceInfo(),a=this.isPlaying;await this.pauseForExport(),MeeWoo.Exporters.WebPExporter.export({width:t.width,height:t.height,fps:t.fps,getFrame:async function(a){var o=Math.floor(a*t.fps/t.fps);await e.seekToFrame(o,t.fps,i),await new Promise(e=>setTimeout(e,100));var n=e.getCurrentFrameCanvas();if(!n)throw new Error("无法获取帧画布");return n},onProgress:function(t,i,a){e.webpExportProgress=t,e.webpExportMessage=a},onError:function(t){console.error("WebP导出错误:",t),e.webpExportMessage="导出失败: "+(t.message||"未知错误")},shouldCancel:function(){return e.webpExportCancelled}}).then(function(){setTimeout(function(){e.isExportingWebp=!1,e.activeRightPanel=null,a&&e.resumeAfterExport()},1e3)}).catch(function(t){console.error("WebP导出失败:",t),e.webpExportMessage="导出失败: "+(t.message||"未知错误"),e.isExportingWebp=!1,a&&e.resumeAfterExport()})},captureFrames:async function(e,t,i){var a=this,o=this.getWebpSourceInfo(),n=o.duration,r=Math.ceil(n*i),s=[],l=this.isPlaying;await this.pauseForExport();try{for(var h=0;h<r;h++){if(a.webpExportCancelled)throw new Error("导出已取消");var c=h/i,d=Math.floor(c*i);await a.seekToFrame(d,i,o);var g=a.getCurrentFrameCanvas();if(!g)throw new Error("无法获取画布元素");var f=document.createElement("canvas");f.width=e,f.height=t,f.getContext("2d").drawImage(g,0,0,e,t);var u=new Image;u.src=f.toDataURL("image/png"),await new Promise(function(e){u.onload=e}),s.push(u),a.webpExportProgress=h/r*.3}return s}finally{l&&a.resumeAfterExport()}},runWebpExport:async function(){var e=this,t=this.webpConfig;try{e.webpExportMessage="捕获帧数据...";var i=await this.captureFrames(t.width,t.height,t.fps);if(e.webpExportCancelled)throw new Error("导出已取消");if(e.webpExportProgress=.3,e.webpExportMessage="转换为WebP格式...",i.length>0){var a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(i[0],0,0,t.width,t.height);var o=a.toDataURL("image/webp",.9);e.webpExportProgress=.8,e.webpExportMessage="生成下载文件...";var n=document.createElement("a");n.href=o,n.download="export.webp",document.body.appendChild(n),n.click(),document.body.removeChild(n),i.forEach(function(e){URL.revokeObjectURL(e.src)})}e.webpExportProgress=1,e.webpExportMessage="导出完成",setTimeout(function(){e.isExportingWebp=!1,e.activeRightPanel=null},1e3)}catch(r){throw console.error("WebP导出错误:",r),e.webpExportMessage="导出失败: "+(r.message||"未知错误"),e.isExportingWebp=!1,r}},cancelWebpExport:function(){this.webpExportCancelled=!0,this.isExportingWebp=!1,this.webpExportProgress=0,this.webpExportMessage=""},getWebpSourceInfo:function(){var e=0,t=0,i=24,a=0,o=0;if("svga"===this.currentModule&&this.svga.hasFile){var n=this.svga.fileInfo.sizeWH;if(n){var r=n.split(" × ");2===r.length&&(e=parseInt(r[0]),t=parseInt(r[1]))}i=this.svga.fileInfo.fps||20,a=(o=this.totalFrames||0)/i}else if("yyeva"===this.currentModule&&this.yyeva.hasFile)e=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),t=this.yyeva.displayHeight||this.yyeva.originalHeight,i=parseFloat(this.yyeva.fileInfo.fps)||30,a=this.yyevaVideo?this.yyevaVideo.duration:0,o=Math.ceil(a*i);else if("mp4"===this.currentModule&&this.mp4.hasFile)if(e=this.mp4.originalWidth,t=this.mp4.originalHeight,i=parseFloat(this.mp4.fileInfo.fps)||30,a=this.mp4Video?this.mp4Video.duration:0,this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var s=this.buildFrameMap();s&&s.length>0?a=(o=s.length)/i:o=Math.ceil(a*i)}else o=Math.ceil(a*i);else"lottie"===this.currentModule&&this.lottie.hasFile?(e=this.lottie.originalWidth,t=this.lottie.originalHeight,i=this.lottie.frameRate||30,a=(o=this.totalFrames||0)/i):"frames"===this.currentModule&&this.frames.hasFile&&(e=this.frames.originalWidth,t=this.frames.originalHeight,i=this.frames.fileInfo.fps||25,a=(o=this.totalFrames||0)/i);return{width:e,height:t,fps:i,duration:a,totalFrames:o,sizeWH:e+" × "+t}},getFramesSourceInfo:function(){var e=0,t=0,i=24,a=0,o=0;if("svga"===this.currentModule&&this.svga.hasFile){var n=this.svga.fileInfo.sizeWH;if(n){var r=n.split(" × ");2===r.length&&(e=parseInt(r[0]),t=parseInt(r[1]))}i=this.svga.fileInfo.fps||20,a=(o=this.totalFrames||0)/i}else if("yyeva"===this.currentModule&&this.yyeva.hasFile)e=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),t=this.yyeva.displayHeight||this.yyeva.originalHeight,i=parseFloat(this.yyeva.fileInfo.fps)||30,a=this.yyevaVideo?this.yyevaVideo.duration:0,o=Math.ceil(a*i);else if("mp4"===this.currentModule&&this.mp4.hasFile)if(e=this.mp4.originalWidth,t=this.mp4.originalHeight,i=parseFloat(this.mp4.fileInfo.fps)||30,a=this.mp4Video?this.mp4Video.duration:0,this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var s=this.buildFrameMap();s&&s.length>0?a=(o=s.length)/i:o=Math.ceil(a*i)}else o=Math.ceil(a*i);else"lottie"===this.currentModule&&this.lottie.hasFile?(e=this.lottie.originalWidth,t=this.lottie.originalHeight,i=this.lottie.frameRate||30,a=(o=this.totalFrames||0)/i):"frames"===this.currentModule&&this.frames.hasFile&&(e=this.frames.originalWidth,t=this.frames.originalHeight,i=this.frames.fileInfo.fps||25,a=(o=this.totalFrames||0)/i);return{width:e,height:t,fps:i,duration:a,totalFrames:o,sizeWH:e+" × "+t}},getGifSourceInfo:function(){var e=0,t=0,i=30,a=0,o=0;if("svga"===this.currentModule&&this.svga.hasFile){var n=this.svga.fileInfo.sizeWH;if(n){var r=n.split(" × ");2===r.length&&(e=parseInt(r[0]),t=parseInt(r[1]))}i=this.svga.fileInfo.fps||20,a=(o=this.totalFrames||0)/i}else if("yyeva"===this.currentModule&&this.yyeva.hasFile)e=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),t=this.yyeva.displayHeight||this.yyeva.originalHeight,i=parseFloat(this.yyeva.fileInfo.fps)||30,a=this.yyevaVideo?this.yyevaVideo.duration:0,o=Math.ceil(a*i);else if("mp4"===this.currentModule&&this.mp4.hasFile)if(e=this.mp4.originalWidth,t=this.mp4.originalHeight,i=parseFloat(this.mp4.fileInfo.fps)||30,a=this.mp4Video?this.mp4Video.duration:0,this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var s=this.buildFrameMap();s&&s.length>0?a=(o=s.length)/i:o=Math.ceil(a*i)}else o=Math.ceil(a*i);else"lottie"===this.currentModule&&this.lottie.hasFile?(e=this.lottie.originalWidth,t=this.lottie.originalHeight,i=this.lottie.frameRate||30,a=(o=this.totalFrames||0)/i):"frames"===this.currentModule&&this.frames.hasFile&&(e=this.frames.originalWidth,t=this.frames.originalHeight,i=this.frames.fileInfo.fps||25,a=(o=this.totalFrames||0)/i);return{width:e,height:t,fps:i,duration:a,totalFrames:o,sizeWH:e+" × "+t}},confirmExportLimits:function(e,t){var i=[],a=e.duration||0,o=e.fileSizeBytes||0;if(o>10485760&&i.push("文件大小超过10MB ("+this.utils.formatBytes(o)+")，处理和导出可能需要较长时间"),a>60&&i.push("动画时长超过60秒 ("+a.toFixed(1)+"秒)，处理和导出可能需要较长时间"),i.length>0){var n="注意 (导出"+t+")：\n\n"+i.join("\n")+"\n\n确定要继续吗？";return confirm(n)}return!0},startGifExport:async function(){var e=this;if(this.confirmIfHasOngoingTasks("导出GIF","task")){var t=this.getGifSourceInfo();if(this.confirmExportLimits(t,"GIF")){try{await this.loadLibrary("gif",!0)}catch(a){return void alert("GIF导出库加载失败，请检查网络")}this.isExportingGIF=!0,this.gifExportProgress=0,this.gifExportCancelled=!1,this.gifExportStage="capturing",this.gifExportMessage="捕获帧...";var i=null;this.taskManager&&(i=this.taskManager.register("导出GIF",function(){e.isExportingGIF=!1,e.gifExportProgress=0,e.gifExportCancelled=!0}));try{await this.runGifExport()}catch(a){"用户取消"!==a.message&&alert("GIF导出失败: "+a.message)}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isExportingGIF=!1,this.gifExportProgress=0,this.gifExportStage="",this.gifExportMessage=""}}}},startFramesExport:async function(){var e=this;if(this.confirmIfHasOngoingTasks("导出序列帧","task")){var t=this.getFramesSourceInfo();if(this.confirmExportLimits(t,"序列帧")){try{await this.loadLibrary("jszip",!0)}catch(a){return void alert("序列帧导出库加载失败，请检查网络")}this.isExportingFrames=!0,this.framesExportProgress=0,this.framesExportCancelled=!1,this.framesExportStage="capturing",this.framesExportMessage="捕获帧...";var i=null;this.taskManager&&(i=this.taskManager.register("导出序列帧",function(){e.isExportingFrames=!1,e.framesExportProgress=0,e.framesExportCancelled=!0}));try{await this.runFramesExport()}catch(a){"用户取消"!==a.message&&alert("序列帧导出失败: "+a.message)}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isExportingFrames=!1,this.framesExportProgress=0,this.framesExportStage="",this.framesExportMessage=""}}}},runFramesExport:async function(){var e=this,t=this.framesConfig,i=this.getFramesSourceInfo();t.fps;var a=i.duration,o=this.isPlaying;await this.pauseForExport();try{var n=new MeeWoo.Service.FramesExporter,r=this.getCurrentFrameCanvas();if(!r)throw new Error("无法获取画布元素");await new Promise(function(i,o){n.exportFrames(t,r,a,function(t,i){e.framesExportProgress=t,e.framesExportMessage=i},function(e){o(new Error(e))},function(){i()})}),alert("序列帧导出成功！"),e.closeFramesPanel()}finally{o&&this.resumeAfterExport()}},runGifExport:async function(){var e=this,t=this.gifConfig,i=this.getGifSourceInfo(),a=t.fps,o=Math.ceil(i.duration*a),n=null;"mp4"===this.currentModule&&this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(n=this.buildFrameMap(a))&&n.length>0&&(o=n.length);var r=this.isPlaying;await this.pauseForExport();try{var s=await MeeWoo.Exporters.GifExporter.export({width:t.width,height:t.height,fps:a,quality:parseInt(t.quality)||10,repeat:0,totalFrames:o,transparent:t.transparent,dither:t.dither,ditherColor:t.ditherColor,backgroundColor:"pattern"===this.bgColorKey?"#ffffff":this.currentBgColor,getFrame:async function(t){var o=t,r=a;return n&&(void 0!==n[t]?(o=n[t],"mp4"===e.currentModule&&e.mp4&&e.mp4.fileInfo&&e.mp4.fileInfo.fps&&(r=parseFloat(e.mp4.fileInfo.fps)||30)):n.length>0&&(o=n[n.length-1],"mp4"===e.currentModule&&e.mp4&&e.mp4.fileInfo&&e.mp4.fileInfo.fps&&(r=parseFloat(e.mp4.fileInfo.fps)||30))),await e.seekToFrame(o,r,i),await new Promise(function(e){setTimeout(e,50)}),e.getCurrentFrameCanvas()},onProgress:function(t,i,a){e.gifExportProgress=t,e.gifExportStage=i,e.gifExportMessage=a},shouldCancel:function(){return e.gifExportCancelled}}),l=this.getGifFileName();MeeWoo.Exporters.GifExporter.download(s,l),alert("GIF 导出成功！大小: "+MeeWoo.Exporters.GifExporter.formatBytes(s.size))}finally{r&&this.resumeAfterExport()}},getCurrentFrameCanvas:function(){var e=this.$refs.svgaContainer;if(!e)return null;if("svga"===this.currentModule)return e.querySelector("canvas");if("yyeva"===this.currentModule)return this.yyevaCanvas;if("mp4"===this.currentModule){if(!this.mp4Video)return null;if(this.chromaKeyEnabled){var t=e.querySelector("canvas.chromakey-canvas");if(t)return t}var i=this.mp4.originalWidth,a=this.mp4.originalHeight;return this._cachedMp4Canvas&&this._cachedMp4Canvas.width===i&&this._cachedMp4Canvas.height===a||(this._cachedMp4Canvas=document.createElement("canvas"),this._cachedMp4Canvas.width=i,this._cachedMp4Canvas.height=a,this._cachedMp4Ctx=this._cachedMp4Canvas.getContext("2d",{willReadFrequently:!0})),this._cachedMp4Ctx.drawImage(this.mp4Video,0,0),this._cachedMp4Canvas}return"lottie"===this.currentModule?e.querySelector("canvas"):"frames"===this.currentModule?this.framesCanvas:null},seekToFrame:async function(e,t,i){var a=this;if("svga"===this.currentModule)this.svgaPlayer.stepToFrame(e,!1);else if("yyeva"===this.currentModule){var o=e/t;this.yyevaVideo.currentTime=o,await new Promise(function(e){a.yyevaVideo.onseeked=e}),this.renderYyevaFrame()}else"mp4"===this.currentModule?(o=e/t,this.mp4Video.currentTime=o,await new Promise(function(e){a.mp4Video.onseeked=e})):"lottie"===this.currentModule?this.lottiePlayer.goToAndStop(e,!0):"frames"===this.currentModule&&this.renderFramesFrame(e)},pauseForExport:async function(){this.playerController&&this.isPlaying&&this.playerController.togglePlay(),this.isPlaying=!1},resumeAfterExport:function(){this.playerController&&!this.isPlaying&&this.playerController.togglePlay(),this.isPlaying=!0},getGifFileName:function(){var e="animation";return"svga"===this.currentModule&&this.svga.fileInfo.name?e=this.svga.fileInfo.name.replace(/\.svga$/i,""):"yyeva"===this.currentModule&&this.yyeva.fileInfo.name?e=this.yyeva.fileInfo.name.replace(/\.mp4$/i,""):"mp4"===this.currentModule&&this.mp4.fileInfo.name?e=this.mp4.fileInfo.name.replace(/\.mp4$/i,""):"lottie"===this.currentModule&&this.lottie.fileInfo.name?e=this.lottie.fileInfo.name.replace(/\.json$/i,""):"frames"===this.currentModule&&this.frames.files.length>0&&(e=this.frames.files[0].name.replace(/\d+\.(png|jpg|jpeg)$/i,"").replace(/[_-]$/,"")||"frames"),e+".gif"},exportLottie:async function(){var e=this;if(this.svgaPlayer&&this.svga.hasFile&&this.originalVideoItem){if(this.confirmIfHasOngoingTasks("导出Lottie","task")&&confirm("警告：这是实验性功能。\n\n生成的Lottie文件将每帧都作为静态关键帧导出，类似“定格动画”效果。\n原动画不会有平滑的运动曲线。\n\n生成的JSON文件可能很大（数MB），但能导入After Effects进行编辑。\n\n是否继续？")){this.isExportingLottie=!0,this.lottieExportProgress=0;var t=null;this.taskManager&&(t=this.taskManager.register("导出Lottie",function(){e.isExportingLottie=!1,e.lottieExportProgress=0}));try{var i=this.$refs.svgaContainer;if(!i)throw new Error("无法获取画布元素");var a=i.querySelector("canvas");if(!a)throw new Error("无法获取 canvas 元素");this.originalVideoItem;var o=this.totalFrames,n=parseFloat(this.svga.fileInfo.fps)||20,r=this.svga.originalWidth,s=this.svga.originalHeight;if(!r||!s)throw new Error("无法获取 SVGA 尺寸信息 (width: "+r+", height: "+s+")");var l=this.isPlaying;l&&this.svgaPlayer.pauseAnimation();var h=[],c=document.createElement("canvas");c.width=r,c.height=s;for(var d=c.getContext("2d",{alpha:!0}),g=0;g<o;g++){if(!this.isExportingLottie)throw new Error("User Cancelled");d.clearRect(0,0,r,s),this.svgaPlayer.stepToFrame(g,!1),await new Promise(function(e){setTimeout(e,100)}),d.drawImage(a,0,0);var f=c.toDataURL("image/png");h.push({index:g,dataUrl:f}),this.lottieExportProgress=Math.floor((g+1)/o*50),g%5==0&&await new Promise(function(e){setTimeout(e,0)})}this.lottieExportProgress=55;var u=this.buildLottieFromFrames(h,r,s,n,o);this.lottieExportProgress=90;var m=JSON.stringify(u,null,2),p=new Blob([m],{type:"application/json"});this.utils.downloadFile(p,(this.svga.fileInfo.name.replace(/\.svga$/i,"")||"animation")+".json"),this.lottieExportProgress=100,setTimeout(function(){e.isExportingLottie=!1,e.lottieExportProgress=0,alert("Lottie 导出成功！\n\n文件大小: "+e.utils.formatBytes(p.size)+"\n\n请将JSON文件导入After Effects进行编辑。")},300),l&&this.svgaPlayer&&"svga"===this.currentModule&&this.svgaPlayer.startAnimation()}catch(v){"User Cancelled"===v.message||alert("Lottie导出失败: "+v.message)}finally{this.taskManager&&t&&this.taskManager.finish(t),this.isExportingLottie=!1,this.lottieExportProgress=0}}}else alert("请先加载 SVGA 文件")},buildLottieFromFrames:function(e,t,i,a,o){var n={v:"5.7.0",fr:a,ip:0,op:o,w:t,h:i,nm:"SVGA to Lottie Export",ddd:0,assets:[],layers:[]};return e.forEach(function(e,a){var o="image_"+a;n.assets.push({id:o,w:t,h:i,u:"",p:e.dataUrl,e:0})}),e.forEach(function(e,a){var o="image_"+a,r=a,s=a+1;n.layers.push({ddd:0,ind:a+1,ty:2,nm:"Frame "+a,refId:o,sr:1,ks:{o:{a:1,k:[{i:{x:[1],y:[1]},o:{x:[0],y:[0]},t:r,s:[100]},{t:s,s:[0]}]},r:{a:0,k:0},p:{a:0,k:[t/2,i/2,0]},a:{a:0,k:[t/2,i/2,0]},s:{a:0,k:[100,100,100]}},ao:0,ip:r,op:s,st:r,bm:0})}),n},openChromaKeyPanel:function(){this.mp4Video&&this.mp4.hasFile?(this.chromaKeyConfig={enabled:this.chromaKeyEnabled,similarity:this.chromaKeySimilarity,smoothness:this.chromaKeySmoothness,applied:this.chromaKeyApplied},this.showChromaKeyPanel=!this.showChromaKeyPanel):alert("请先加载 MP4 文件")},applyChromaKey:function(e){this.chromaKeyEnabled=e.enabled,this.chromaKeySimilarity=e.similarity,this.chromaKeySmoothness=e.smoothness,this.chromaKeyApplied=e.applied,this.chromaKeyEnabled?this.updateChromaKeyEffect():this.removeChromaKeyEffect(),this.showChromaKeyPanel=!1},closeChromaKeyPanel:function(){this.showChromaKeyPanel=!1},toggleChromaKey:function(){this.chromaKeyEnabled=!this.chromaKeyEnabled,this.chromaKeyEnabled?this.updateChromaKeyEffect():this.removeChromaKeyEffect()},updateChromaKeyEffect:function(){if(this.chromaKeyEnabled&&this.mp4Video){var e=this,t=this.mp4Video,i=this.$refs.svgaContainer;if(i){this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null);var a=i.querySelector("canvas.chromakey-canvas");a&&i.removeChild(a),this._chromaKeyCanvas||(this._chromaKeyCanvas=document.createElement("canvas"),this._chromaKeyCanvas.className="chromakey-canvas",this._chromaKeyCanvas.style.cssText="display: block;"),this._chromaKeyCanvas.width=t.videoWidth,this._chromaKeyCanvas.height=t.videoHeight,this._chromaKeyCtx||(this._chromaKeyCtx=this._chromaKeyCanvas.getContext("2d",{willReadFrequently:!0,alpha:!0}));var o=this._chromaKeyCanvas,n=this._chromaKeyCtx;t.style.display="none",i.appendChild(o);var r=this.chromaKeySimilarity/100,s=this.chromaKeySmoothness/100,l=0,h=1e3/30,c=function(i){if(!e.chromaKeyEnabled||!e.mp4Video||"mp4"!==e.currentModule)return e.chromaKeyRenderLoop=null,void e.removeChromaKeyEffect();if(i-l<h)e.chromaKeyRenderLoop=requestAnimationFrame(c);else{l=i,n.drawImage(t,0,0);var a=n.getImageData(0,0,o.width,o.height),d=a.data;r=e.chromaKeySimilarity/100,s=e.chromaKeySmoothness/100;for(var g=0;g<d.length;g+=4){var f=d[g],u=d[g+1],m=d[g+2];if(u>f*(1+r)&&u>m*(1+r)){var p=(u-Math.max(f,m))/255,v=Math.max(0,1-p/(1-s+.01));d[g+3]=Math.floor(255*v)}}n.putImageData(a,0,0),e.chromaKeyRenderLoop=requestAnimationFrame(c)}};c()}}else this.removeChromaKeyEffect()},removeChromaKeyEffect:function(){this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null);var e=this.$refs.svgaContainer;e&&this.mp4Video&&(e.querySelectorAll("canvas").forEach(function(t){t.classList.contains("chromakey-canvas")&&e.removeChild(t)}),this.mp4Video.style.display="block",this.mp4Video.style.visibility="visible",this.mp4Video.style.opacity="1",this.currentTime>0&&(this.mp4Video.currentTime=this.currentTime),this.isPlaying&&this.mp4Video.play(),this._chromaKeyCanvas=null,this._chromaKeyCtx=null)},applyChromaKey:function(){this.chromaKeyApplied=this.chromaKeyEnabled,this.chromaKeyEnabled?this.updateChromaKeyEffect():this.removeChromaKeyEffect(),this.closeChromaKeyPanel()},openSpeedRemapEditor:function(){if(this.mp4Video&&this.mp4.hasFile){if(this.showSpeedRemapEditor)return this.showSpeedRemapEditor=!1,this.selectedKeyframeIndex=-1,void(this.timelineHoverX=-1);var e=this.mp4Video,t=this.mp4.detectedFps||30,i=e.duration||0,a=Math.ceil(i*t);this.speedRemapConfig.fps=t,this.speedRemapConfig.originalDuration=i,this.speedRemapConfig.originalTotalFrames=a,!this.speedRemapConfig.keyframes||this.speedRemapConfig.keyframes.length<2?this.speedRemapConfig.keyframes=[{originalFrame:0,position:0,isEndpoint:!0},{originalFrame:a,position:1,isEndpoint:!0}]:this.speedRemapConfig.keyframes[this.speedRemapConfig.keyframes.length-1].originalFrame=a,this.showSpeedRemapEditor=!0,this.selectedKeyframeIndex=-1,this.timelineHoverX=-1}else alert("请先加载 MP4 文件")},cancelSpeedRemap:function(){this.showSpeedRemapEditor=!1,this.selectedKeyframeIndex=-1,this.timelineHoverX=-1},resetSpeedRemap:function(){var e=this.speedRemapConfig.originalTotalFrames;this.speedRemapConfig.keyframes=[{originalFrame:0,position:0,isEndpoint:!0},{originalFrame:e,position:1,isEndpoint:!0}],this.speedRemapConfig.enabled=!1,this.selectedKeyframeIndex=-1},onFrameLabelDblClick:function(e){var t=this.speedRemapConfig.keyframes[e];t&&(t.isEndpoint||(this.editingKeyframeIndex=e,this.editFrameInput=t.originalFrame.toString(),this.showEditFrameDialog=!0))},confirmEditFrame:function(){var e=parseInt(this.editFrameInput,10),t=this.speedRemapConfig.originalTotalFrames;if(isNaN(e))this.utils.showToast("请输入有效的帧数");else if(e<0||e>t)this.utils.showToast("帧数范围: 0-"+t);else{for(var i=this.speedRemapConfig.keyframes,a=this.editingKeyframeIndex,o=0;o<i.length;o++)if(o!==a&&i[o].originalFrame===e)return void this.utils.showToast("该帧数已存在K帧");i[a].originalFrame=e,i.sort(function(e,t){return e.originalFrame-t.originalFrame}),this.showEditFrameDialog=!1,this.editingKeyframeIndex=-1,this.editFrameInput=""}},cancelEditFrame:function(){this.showEditFrameDialog=!1,this.editingKeyframeIndex=-1,this.editFrameInput=""},confirmSpeedRemap:function(){var e=this,t=this.speedRemapConfig.keyframes,i=t.length>2;if(!i&&t.length>=2){var a=t[0],o=t[t.length-1];i=0!==a.position||1!==o.position}var n=!1,r=this.speedRemapConfig.originalTotalFrames||1;if(i&&t.length>=2)for(var s=0;s<t.length-1;s++){var l=t[s],h=t[s+1],c=h.originalFrame-l.originalFrame,d=h.position-l.position;if(d>0&&c>0){var g=c/(d*r);if(g<.1||g>12){n=!0;for(var f=c/(Math.max(.1,Math.min(12,g))*r)-d,u=s+1;u<t.length;u++)t[u].position+=f}}}this.speedRemapConfig.enabled=i,this.showSpeedRemapEditor=!1,this.selectedKeyframeIndex=-1,n?this.utils.showToast("超出变速范围0.1-12，已自动调整为范围内速度"):i&&this.utils.showToast("变速配置已应用"),i&&(this.isPlaying&&this.togglePlay(),this.playerController&&this.playerController.seekTo(0),setTimeout(function(){e.isPlaying||e.togglePlay()},100))},onTimelineMouseMove:function(e){var t=this.$refs.speedRemapTimeline;if(t){var i=t.getBoundingClientRect(),a=e.clientX-i.left,o=(a=Math.max(0,Math.min(500,a)))/500,n=this.speedRemapConfig.keyframes,r=n[0]?n[0].position:0,s=n[n.length-1]?n[n.length-1].position:1;if(o<=r||o>=s)this.timelineHoverX=-1;else{for(var l=0;l<n.length;l++){var h=500*n[l].position;if(Math.abs(a-h)<8)return void(this.timelineHoverX=-1)}this.timelineHoverX=a}}},onTimelineMouseLeave:function(){this.timelineHoverX=-1},onTimelineClick:function(e){var t=this.$refs.speedRemapTimeline;if(t){var i=t.getBoundingClientRect(),a=e.clientX-i.left,o=Math.max(0,Math.min(1,a/500)),n=this.speedRemapConfig.keyframes,r=n[0]?n[0].position:0,s=n[n.length-1]?n[n.length-1].position:1;if(!(o<=r||o>=s)){for(var l=0;l<n.length;l++){var h=500*n[l].position;if(Math.abs(a-h)<8)return}this.addKeyframe(o)}}},addKeyframe:function(e){var t=this.speedRemapConfig.keyframes;if(t.length>=10)this.utils.showToast("最多支持10个关键帧");else{var i={originalFrame:this.getOriginalFrameAtPosition(e),position:e,isEndpoint:!1};t.push(i),t.sort(function(e,t){return e.position-t.position}),this.timelineHoverX=-1}},getOriginalFrameAtPosition:function(e){var t=this.speedRemapConfig.keyframes;if(!t||t.length<2)return Math.round(e*this.speedRemapConfig.originalTotalFrames);for(var i=0;i<t.length-1;i++){var a=t[i],o=t[i+1];if(e>=a.position&&e<=o.position){if(o.position===a.position)return a.originalFrame;var n=(e-a.position)/(o.position-a.position);return Math.round(a.originalFrame+(o.originalFrame-a.originalFrame)*n)}}return Math.round(e*this.speedRemapConfig.originalTotalFrames)},getSpeedAtPosition:function(e){var t=this.speedRemapConfig.keyframes;if(!t||t.length<2)return 1;var i=this.speedRemapConfig.originalTotalFrames;if(!i)return 1;for(var a=0;a<t.length-1;a++){var o=t[a],n=t[a+1];if(e>=o.position&&e<=n.position){var r=n.originalFrame-o.originalFrame,s=n.position-o.position;return s<=0||r<=0?1:r/(s*i)}}return 1},onKeyframeLineClick:function(e){var t=this.speedRemapConfig.keyframes[e];t&&(t.isEndpoint||this.speedRemapConfig.keyframes.splice(e,1))},onKeyframeMouseDown:function(e,t){var i=this,a=this.speedRemapConfig.keyframes[t];if(a){var o=this.$refs.speedRemapTimeline;if(o){this.selectedKeyframeIndex=t,this.timelineHoverX=-1,o.getBoundingClientRect();var n=e.clientX,r=a.position,s=function(e){var o=e.clientX-n,s=r+o/500,l=i.speedRemapConfig.keyframes,h=l[t-1]?l[t-1].position+.01:0,c=l[t+1]?l[t+1].position-.01:1;s=Math.max(h,Math.min(c,s)),a.position=s},l=function(){document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",l),i.selectedKeyframeIndex=-1};document.addEventListener("mousemove",s),document.addEventListener("mouseup",l),e.preventDefault()}}},buildFrameMap:function(e){var t=this.speedRemapConfig;if(!t.enabled||!t.keyframes||t.keyframes.length<2)return null;var i,a=t.originalTotalFrames,o=t.keyframes,n=o[0].position,r=o[o.length-1].position-n;if(e&&(e=Number(e)),e&&e>0&&this.mp4Video&&this.mp4Video.duration){var s=r*this.mp4Video.duration;i=Math.ceil(s*e)}else i=Math.ceil(r*a);i<1&&(i=1);for(var l=[],h=0;h<i;h++){var c=n+h/i*r,d=this.getOriginalFrameAtPosition(c);d=Math.max(0,Math.min(a-1,d)),l.push(d)}return l},openSvgaToDualChannelPanel:function(){if(this.svgaPlayer&&this.svga.hasFile&&this.originalVideoItem){var e=this.getGifSourceInfo();if(this.confirmExportLimits(e,"SVGA 转 MP4")){var t=this.originalVideoItem;this.dualChannelConfig.width=t.videoSize.width,this.dualChannelConfig.height=t.videoSize.height,this.dualChannelConfig.aspectRatio=t.videoSize.width/t.videoSize.height;var i=t.FPS||t.fps||30;if(this.dualChannelConfig.fps=i,this.dualChannelSourceInfo={name:this.svga.fileInfo.name,sizeWH:t.videoSize.width+" x "+t.videoSize.height,duration:e.duration.toFixed(1)+"s",fileSize:this.svga.fileInfo.sizeText,fps:i,typeLabel:"SVGA",width:t.videoSize.width,height:t.videoSize.height},this.configManager){var o=this.configManager.get("mp4_fps");void 0!==o&&(this.dualChannelConfig.fps=parseInt(o));var n=this.configManager.get("mp4_quality");void 0!==n&&(this.dualChannelConfig.quality=parseInt(n))}console.log("打开双通道MP4面板");var r=this;Vue.nextTick(function(){console.log("调用openDualChannelPanel方法"),r.openDualChannelPanel()}),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}}else alert("请先加载 SVGA 文件")},openMp4ToDualChannelPanel:function(){if(this.mp4Video&&this.mp4.hasFile){var e=this.mp4.fileInfo.fps||30;this.dualChannelSourceInfo={name:this.mp4.fileInfo.name,sizeWH:this.mp4.originalWidth+" x "+this.mp4.originalHeight,duration:this.mp4Video.duration.toFixed(1)+"s",fileSize:this.mp4.fileInfo.sizeText,fps:e},this.dualChannelConfig.width=this.mp4.originalWidth,this.dualChannelConfig.height=this.mp4.originalHeight,this.dualChannelConfig.aspectRatio=this.mp4.originalWidth/this.mp4.originalHeight;var t=this.mp4.fileInfo.fps||30;this.dualChannelConfig.fps=Math.min(120,Math.max(1,Math.round(parseFloat(t))));try{if(this.configManager){var i=this.configManager.get("mp4_quality");void 0!==i&&(this.dualChannelConfig.quality=parseInt(i))}}catch(o){}console.log("调用openDualChannelPanel方法"),this.openDualChannelPanel(),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载 MP4 文件")},cancelMp4ToDualChannelConversion:function(){confirm("确定要取消转换吗？")&&(this.dualChannelCancelled=!0)},startMp4ToDualChannelConversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.mp4Video&&this.mp4.hasFile){var i=this.getGifSourceInfo();if(this.confirmExportLimits(i,"MP4 转双通道"))if((e=this.dualChannelConfig).width<1||e.width>9999)alert("宽度超出范围！\n\n合法范围：1-9999 像素");else if(e.height<1||e.height>9999)alert("高度超出范围！\n\n合法范围：1-9999 像素");else if(e.quality<1||e.quality>100)alert("压缩质量超出范围！\n\n合法范围：1-100");else if(e.fps<1||e.fps>120)alert("帧率超出范围！\n\n合法范围：1-120 fps");else{try{this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(u){console.error("Config save failed:",u)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var o=null;this.taskManager&&(o=this.taskManager.register("MP4转双通道",function(){t.cancelMp4ToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";var n=await this.extractMp4FramesForDualChannel();if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var r=await this.composeDualChannelFrames(n);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var s=null,l=1;if(this.mp4HasAudio&&this.mp4.file){var h=this.mp4Video.duration;if(this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2)try{this.dualChannelMessage="正在处理音频...";var c=Math.ceil(h*(this.mp4.fileInfo.fps||30)),d=await this.extractAudioFromMp4(this.mp4.file,n.length,e.fps,c,this.mp4.fileInfo.fps||30);d&&d.length>0&&d[0].audioData&&(s=d[0].audioData,l=1)}catch(u){console.error("音频变速处理失败，回退到平均变速模式",u),s=new Uint8Array(await this.mp4.file.arrayBuffer()),l=h/(n.length/e.fps)}else try{s=new Uint8Array(await this.mp4.file.arrayBuffer());var g=n.length/e.fps;g>0&&(l=h/g)}catch(u){console.error("读取音频失败",u)}}var f=await a.FFmpegService.convertFramesToMp4({frames:r,fps:e.fps,quality:e.quality,audioData:s,audioSpeedRatio:l,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadDualChannelMP4(f,"mp4"),setTimeout(function(){alert("✅ 转换完成！")},500),this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(m){"用户取消转换"===m.message||("FFmpeg服务正忙，请稍后再试"===m.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("MP4转双通道失败:",m),alert("转换失败："+m.message)))}finally{this.taskManager&&o&&this.taskManager.finish(o),this.isConvertingToDualChannel=!1,this.dualChannelProgress=0,this.dualChannelStage="",this.dualChannelMessage=""}}}else alert("请先加载 MP4 文件")},extractMp4FramesForDualChannel:async function(){var e=this.mp4Video,t=this.dualChannelConfig,i=t.fps,a=e.duration,o=Math.ceil(a*i),n=[],r=null;this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(r=this.buildFrameMap(i))&&r.length>0&&(o=r.length);var s=document.createElement("canvas");s.width=t.width,s.height=t.height;var l=s.getContext("2d",{willReadFrequently:!0,alpha:!0}),h=this.chromaKeyEnabled,c=null;h&&(c=this.$refs.svgaContainer.querySelector("canvas.chromakey-canvas"));var d=!e.paused;e.pause();for(var g=0;g<o&&!this.dualChannelCancelled;g++){var f,u=g;r&&void 0!==r[g]&&(u=r[g]);var m=this.speedRemapConfig.originalTotalFrames||30*a;f=u/m*a,e.currentTime=f;try{await new Promise(function(t,i){var a=function(){e.removeEventListener("seeked",a),t()};if(e.addEventListener("seeked",a),!e.seeking&&Math.abs(e.currentTime-f)<.1)return e.removeEventListener("seeked",a),void t();setTimeout(function(){e.removeEventListener("seeked",a),i(new Error("Seek timeout"))},2e3)})}catch(y){if(console.warn("Seek timeout or error, skipping frame "+g),this.dualChannelCancelled)break}l.clearRect(0,0,t.width,t.height),h&&c?(this.applyChromaKeyFrame(),await new Promise(function(e){setTimeout(e,30)}),l.drawImage(c,0,0,t.width,t.height)):(l.fillStyle="#000000",l.fillRect(0,0,t.width,t.height),l.drawImage(e,0,0,t.width,t.height));var p=l.getImageData(0,0,t.width,t.height);n.push(p);var v=Math.min(30,Math.round(g/o*30));this.dualChannelProgress=v}return d&&e.play(),this.dualChannelProgress<30&&(this.dualChannelProgress=30),console.log("帧提取完成，实际提取帧数:",n.length),n},applyChromaKeyFrame:function(){var e=this.mp4Video,t=this.$refs.svgaContainer.querySelector("canvas.chromakey-canvas");if(t&&e){var i=t.getContext("2d",{willReadFrequently:!0,alpha:!0});i.drawImage(e,0,0);for(var a=i.getImageData(0,0,t.width,t.height),o=a.data,n=this.chromaKeySimilarity/100,r=this.chromaKeySmoothness/100,s=0;s<o.length;s+=4){var l=o[s],h=o[s+1],c=o[s+2],d=h-Math.max(l,c),g=255*n;if(d>.5*g){var f=1-Math.min(1,(d-.5*g)/(g*r+1));o[s+3]=Math.round(255*f)}}i.putImageData(a,0,0)}},buildAudioTempoFilter:function(e){return a.FFmpegService.buildAudioTempoFilter(e)},downloadDualChannelMP4:function(e,t){var i="dual-channel";"mp4"===t&&this.mp4.fileInfo.name?i=this.mp4.fileInfo.name.replace(/\.mp4$/i,""):"lottie"===t&&this.lottie.fileInfo.name&&(i=this.lottie.fileInfo.name.replace(/\.json$/i,"")),this.utils.downloadFile(e,i+"_dual.mp4")},openLottieToDualChannelPanel:function(){if(this.lottiePlayer&&this.lottie.hasFile){var e=this.lottie.frameRate||30,t=0;this.lottiePlayer&&"function"==typeof this.lottiePlayer.getDuration&&(t=this.lottiePlayer.getDuration(!1)),this.dualChannelSourceInfo={name:this.lottie.fileInfo.name,sizeWH:(this.lottie.originalWidth||0)+" x "+(this.lottie.originalHeight||0),duration:t.toFixed(1)+"s",fileSize:this.lottie.fileInfo.sizeText,fps:e},this.dualChannelConfig.width=this.lottie.originalWidth||300,this.dualChannelConfig.height=this.lottie.originalHeight||300,this.dualChannelConfig.aspectRatio=this.dualChannelConfig.width/this.dualChannelConfig.height,this.dualChannelConfig.fps=Math.min(120,Math.max(1,Math.round(e)));try{if(this.configManager){var i=this.configManager.get("mp4_quality");void 0!==i&&(this.dualChannelConfig.quality=parseInt(i))}}catch(o){console.error("Config load failed:",o)}this.openRightPanel("showLottieToDualChannelPanel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载 Lottie 文件")},cancelLottieToDualChannelConversion:function(){confirm("确定要取消转换吗？")&&(this.dualChannelCancelled=!0)},startLottieToDualChannelConversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.lottiePlayer&&this.lottie.hasFile)if((e=this.dualChannelConfig).width<1||e.width>9999)alert("宽度超出范围！");else if(e.height<1||e.height>9999)alert("高度超出范围！");else if(e.quality<1||e.quality>100)alert("压缩质量超出范围！");else if(e.fps<1||e.fps>120)alert("帧率超出范围！");else{try{this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(s){console.error("Config save failed:",s)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var i=null;this.taskManager&&(i=this.taskManager.register("Lottie转双通道",function(){t.cancelLottieToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";var o=await this.extractLottieFrames();if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var n=await this.composeDualChannelFrames(o);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var r=await a.FFmpegService.convertFramesToMp4({frames:n,fps:e.fps,quality:e.quality,audioData:null,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadDualChannelMP4(r,"lottie"),setTimeout(function(){alert("✅ 转换完成！")},500),this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(l){"用户取消转换"===l.message||("FFmpeg服务正忙，请稍后再试"===l.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("Lottie转双通道失败:",l),alert("转换失败："+l.message)))}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isConvertingToDualChannel=!1,this.dualChannelProgress=0,this.dualChannelStage="",this.dualChannelMessage=""}}else alert("请先加载 Lottie 文件")},extractLottieFrames:async function(){var e=this.lottiePlayer,t=this.dualChannelConfig,i=this._lottieAnimationData,a=i.op-i.ip,o=[],n=this.$refs.svgaContainer.querySelector("canvas");if(!n)throw new Error("无法获取Lottie渲染canvas");var r=document.createElement("canvas");r.width=t.width,r.height=t.height;var s=r.getContext("2d",{willReadFrequently:!0,alpha:!0}),l=!e.isPaused;e.pause();for(var h=0;h<a&&!this.dualChannelCancelled;h++){e.goToAndStop(h,!0),await new Promise(function(e){setTimeout(e,30)}),s.clearRect(0,0,t.width,t.height),s.drawImage(n,0,0,t.width,t.height);var c=s.getImageData(0,0,t.width,t.height);o.push(c),h%10==0&&console.log("提取帧进度:",h+1,"/",a),this.dualChannelProgress=Math.floor(h/a*30)}return l&&e.play(),o},openYyevaToSvgaPanel:function(){if(this.yyevaVideo&&this.yyeva.hasFile){var e=this.yyeva.fileInfo.fps||30,t=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),i=this.yyeva.displayHeight||this.yyeva.originalHeight;if(this.toSvgaSourceInfo={name:this.yyeva.fileInfo.name,sizeWH:t+" x "+i,duration:this.yyevaVideo.duration.toFixed(1)+"s",fileSize:this.yyeva.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=t,this.toSvgaConfig.height=i,this.toSvgaConfig.fps=Math.min(60,Math.max(1,Math.round(parseFloat(e)))),this.configManager){var o=this.configManager.get("svga_quality");void 0!==o&&(this.toSvgaConfig.quality=parseInt(o))}this.openRightPanel("showYyevaToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)}),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载双通道 MP4 文件")},closeYyevaToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showYyevaToSvgaPanel=!1},cancelYyevaToSvgaConversion:function(){this.toSvgaCancelled=!0,this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""},openMp4ToSvgaPanel:function(){if(this.mp4Video&&this.mp4.hasFile){var e=this.mp4.fileInfo.fps||30;if(this.toSvgaSourceInfo={name:this.mp4.fileInfo.name,sizeWH:this.mp4.originalWidth+" x "+this.mp4.originalHeight,duration:this.mp4Video.duration.toFixed(1)+"s",fileSize:this.mp4.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=this.mp4.originalWidth||0,this.toSvgaConfig.height=this.mp4.originalHeight||0,this.toSvgaConfig.fps=Math.min(60,Math.max(1,Math.round(parseFloat(e)))),this.configManager){var t=this.configManager.get("toSvgaConfig");t&&t.quality&&(this.toSvgaConfig.quality=t.quality)}this.openRightPanel("showMp4ToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)})}else alert("请先加载 MP4 文件")},closeMp4ToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showMp4ToSvgaPanel=!1},cancelMp4ToSvgaConversion:function(){this.toSvgaCancelled=!0,this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""},onMp4ToSvgaWidthChange:function(){var e=this.mp4.originalWidth||0,t=this.mp4.originalHeight||0;if(e&&t){var i=t/e,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.width)||0)),o=Math.floor(a*i);this.toSvgaConfig.width=a,this.toSvgaConfig.height=o}},onMp4ToSvgaHeightChange:function(){var e=this.mp4.originalWidth||0,t=this.mp4.originalHeight||0;if(e&&t){var i=e/t,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.height)||0)),o=Math.floor(a*i);this.toSvgaConfig.width=o,this.toSvgaConfig.height=a}},startMp4ToSvgaConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),!this.isConvertingToSvga)if(this.mp4Video&&this.mp4.hasFile){if(this.confirmIfHasOngoingTasks("转SVGA","task")){var i=this.getGifSourceInfo();if(this.confirmExportLimits(i,"MP4 转 SVGA"))try{var o=this.taskManager.register("MP4转SVGA",function(){t.isConvertingToSvga=!1,t.toSvgaCancelled=!0});if(this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="加载库...",await this.loadLibrary(["protobuf","pako"],!1),this.toSvgaCancelled)return void this.taskManager.finish(o);this.toSvgaStage="extracting",this.toSvgaMessage="提取帧...";var n=await this.extractMp4Frames();if(this.toSvgaCancelled)return n=null,void this.taskManager.finish(o);var r=null;if(!this.toSvgaConfig.muted&&this.mp4.file){this.toSvgaMessage="提取音频...";try{await a.FFmpegService.init();var s=parseFloat(this.mp4.fileInfo.fps)||30,l=this.mp4Video?this.mp4Video.duration:0,h=Math.ceil(l*s),c=parseFloat(this.toSvgaConfig.fps)||30;if(this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2)r=await this.extractAudioFromMp4(this.mp4.file,n.length,c,h,s);else{var d=1;l>0&&n.length>0&&(d=l/(n.length/c)),r=await a.FFmpegService.extractAudio({videoFile:this.mp4.file,totalFrames:n.length,fps:c,speedRatio:d})}}catch(u){console.warn("音频提取失败:",u),"FFmpeg服务正忙，请稍后再试"===u.message&&alert("FFmpeg服务正忙，音频提取跳过")}if(this.toSvgaCancelled)return}this.toSvgaStage="building";var g=await this.buildSVGAFromConfig("mp4",{frames:n,width:this.toSvgaConfig.width,height:this.toSvgaConfig.height,fps:this.toSvgaConfig.fps,quality:this.toSvgaConfig.quality,audios:r,muted:this.toSvgaConfig.muted,dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(this.toSvgaCancelled)return void this.taskManager.finish(o);var f=(this.mp4.fileInfo.name||"video").replace(/\.[^.]+$/,"");this.downloadSVGA(g,f+".svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。"),this.configManager&&this.configManager.set("toSvgaConfig",{quality:this.toSvgaConfig.quality}),this.isConvertingToSvga=!1,setTimeout(function(){t.isConvertingToSvga||(t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage="")},1e3)}catch(m){"FFmpeg服务正忙，请稍后再试"===m.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("MP4转SVGA失败:",m),alert("转换失败: "+m.message)),this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""}finally{this.taskManager&&o&&this.taskManager.finish(o)}}}else alert("请先加载 MP4 文件")},extractMp4Frames:async function(){var e=this.mp4Video,t=this.toSvgaConfig.fps,i=e.duration,a=Math.ceil(i*t),o=[],n=null;this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(n=this.buildFrameMap(t))&&n.length>0&&(a=n.length);var r=document.createElement("canvas");r.width=this.mp4.originalWidth,r.height=this.mp4.originalHeight;for(var s=r.getContext("2d",{willReadFrequently:!0}),l=this.chromaKeyEnabled,h=0;h<a&&!this.toSvgaCancelled;h++){var c;if(n&&void 0!==n[h]){var d=n[h],g=this.speedRemapConfig.originalTotalFrames||30*i;c=d/g*i}else c=h/t;c>i&&(c=i),e.currentTime=c;try{await new Promise(function(t,i){var a=function(){e.removeEventListener("seeked",a),t()};if(e.addEventListener("seeked",a),!e.seeking&&Math.abs(e.currentTime-c)<.1)return e.removeEventListener("seeked",a),void t();setTimeout(function(){e.removeEventListener("seeked",a),i(new Error("Seek timeout"))},2e3)})}catch(m){if(console.warn("Seek timeout or error, skipping frame "+h),this.toSvgaCancelled)break}if(s.drawImage(e,0,0,r.width,r.height),l){var f=s.getImageData(0,0,r.width,r.height);this.applyChromaKeyToImageData(f),s.putImageData(f,0,0)}var u=await new Promise(function(e){r.toBlob(e,"image/png")});o.push({index:h,blob:u}),this.toSvgaProgress=Math.round(h/a*50)}return o},applyChromaKeyToImageData:function(e){for(var t=e.data,i=this.chromaKeySimilarity/100,a=this.chromaKeySmoothness/100,o=0;o<t.length;o+=4){var n=t[o],r=t[o+1],s=t[o+2];if(r>n*(1+i)&&r>s*(1+i)){var l=(r-Math.max(n,s))/255,h=Math.max(0,1-l/(1-a+.01));t[o+3]=Math.floor(255*h)}}},openLottieToSvgaPanel:function(){if(this.lottiePlayer&&this.lottie.hasFile){var e=this.lottie.frameRate||30,t=0;if(this.lottiePlayer&&"function"==typeof this.lottiePlayer.getDuration&&(t=this.lottiePlayer.getDuration(!1)),this.toSvgaSourceInfo={name:this.lottie.fileInfo.name,sizeWH:(this.lottie.originalWidth||0)+" x "+(this.lottie.originalHeight||0),duration:t.toFixed(1)+"s",fileSize:this.lottie.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=this.lottie.originalWidth||0,this.toSvgaConfig.height=this.lottie.originalHeight||0,this.toSvgaConfig.fps=Math.min(60,Math.max(1,Math.round(e))),this.configManager){var i=this.configManager.get("toSvgaConfig");i&&i.quality&&(this.toSvgaConfig.quality=i.quality)}this.openRightPanel("showLottieToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)})}else alert("请先加载 Lottie 文件")},closeLottieToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showLottieToSvgaPanel=!1},onLottieToSvgaWidthChange:function(){var e=this.lottie.originalWidth,t=this.lottie.originalHeight;if(e&&t){var i=t/e,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.width)||0)),o=Math.floor(a*i);this.toSvgaConfig.width=a,this.toSvgaConfig.height=o}},onLottieToSvgaHeightChange:function(){var e=this.lottie.originalWidth,t=this.lottie.originalHeight;if(e&&t){var i=e/t,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.height)||0)),o=Math.floor(a*i);this.toSvgaConfig.width=o,this.toSvgaConfig.height=a}},startLottieToSvgaConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),this.lottiePlayer&&this.lottie.hasFile){if(this.confirmIfHasOngoingTasks("Lottie转SVGA","task")){var i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,o=this.toSvgaConfig.quality,n=this.toSvgaConfig.fps;if(i<1||i>3e3||a<1||a>3e3)alert("尺寸超出范围！合法范围：1-3000 像素");else{this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="加载库...";var r=this.taskManager.register("Lottie转SVGA",function(){t.isConvertingToSvga=!1,t.toSvgaProgress=0,t.toSvgaCancelled=!0});try{if(await this.loadLibrary(["protobuf","pako"],!1),this.toSvgaCancelled)return void this.taskManager.finish(r);this.toSvgaStage="extracting",this.toSvgaMessage="提取帧...";var s=await this.extractLottieFramesForSvga();if(this.toSvgaCancelled)return void this.taskManager.finish(r);this.toSvgaStage="building",this.toSvgaMessage="生成SVGA...";var l=await this.buildSVGAFromConfig("lottie",{frames:s,width:i,height:a,fps:n,quality:o,dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(this.toSvgaCancelled)return void this.taskManager.finish(r);var h=(this.lottie.file.name||"animation").replace(/\.[^.]+$/,"");this.downloadSVGA(l,h+".svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。"),this.configManager&&this.configManager.set("toSvgaConfig",{quality:o}),setTimeout(function(){t.isConvertingToSvga||(t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage="")},1e3)}catch(c){"FFmpeg服务正忙，请稍后再试"===c.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("Lottie转SVGA失败:",c),alert("转换失败: "+c.message)),this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""}finally{this.taskManager&&r&&this.taskManager.finish(r)}}}}else alert("请先加载 Lottie 文件")},extractLottieFramesForSvga:async function(){var e=this.lottiePlayer;this.toSvgaConfig.fps;var t=this.toSvgaConfig.width,i=this.toSvgaConfig.height,a=e.totalFrames||this.totalFrames,o=[],n=document.createElement("canvas");n.width=t,n.height=i;var r=n.getContext("2d");this.isPlaying&&(e.pause(),this.isPlaying=!1);for(var s=this.$refs.svgaContainer.querySelector("svg, canvas"),l=0;l<a&&!this.toSvgaCancelled;l++){if(e.goToAndStop(l,!0),await new Promise(function(e){setTimeout(e,20)}),r.clearRect(0,0,t,i),s&&"SVG"===s.tagName){var h=(new XMLSerializer).serializeToString(s),c=new Blob([h],{type:"image/svg+xml;charset=utf-8"}),d=URL.createObjectURL(c),g=new Image;g.width=t,g.height=i,await new Promise(function(e,t){g.onload=e,g.onerror=t,g.src=d}),r.drawImage(g,0,0,t,i),URL.revokeObjectURL(d)}else s&&"CANVAS"===s.tagName&&r.drawImage(s,0,0,t,i);var f=await new Promise(function(e){n.toBlob(e,"image/png")});o.push({index:l,blob:f}),this.toSvgaProgress=Math.round(l/a*50)}return o},openFramesToSvgaPanel:function(){if(this.frames.hasFile&&this.frames.files.length){var e=this.frames.fileInfo.fps||25;if(this.toSvgaSourceInfo={name:this.frames.fileInfo.name,sizeWH:(this.frames.originalWidth||0)+" x "+(this.frames.originalHeight||0),duration:this.frames.fileInfo.duration,fileSize:this.frames.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=this.frames.originalWidth||0,this.toSvgaConfig.height=this.frames.originalHeight||0,this.toSvgaConfig.fps=e,this.configManager){var t=this.configManager.get("framesToSvgaConfig");t&&t.quality&&(this.toSvgaConfig.quality=t.quality)}this.openRightPanel("showImagesToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)})}else alert("请先加载序列帧文件")},closeImagesToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showImagesToSvgaPanel=!1},onFramesToSvgaWidthChange:function(){var e=this.frames.originalWidth,t=this.frames.originalHeight;if(e&&t){var i=t/e,a=Math.max(1,Math.min(3e3,parseInt(this.framesToSvgaConfig.width)||0)),o=Math.floor(a*i);this.framesToSvgaConfig.width=a,this.framesToSvgaConfig.height=o}},onFramesToSvgaHeightChange:function(){var e=this.frames.originalWidth,t=this.frames.originalHeight;if(e&&t){var i=e/t,a=Math.max(1,Math.min(3e3,parseInt(this.framesToSvgaConfig.height)||0)),o=Math.floor(a*i);this.framesToSvgaConfig.width=o,this.framesToSvgaConfig.height=a}},startFramesToSvgaConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),this.frames.hasFile&&this.frames.files.length){if(this.confirmIfHasOngoingTasks("序列帧转SVGA","task")){var i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,o=this.toSvgaConfig.quality,n=this.toSvgaConfig.fps;if(i<1||i>3e3||a<1||a>3e3)alert("尺寸超出范围！合法范围：1-3000 像素");else{this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="加载库...";var r=this.taskManager.register("序列帧转SVGA",function(){t.isConvertingToSvga=!1,t.toSvgaProgress=0,t.toSvgaCancelled=!0});try{if(await this.loadLibrary(["protobuf","pako"],!1),this.toSvgaCancelled)return void this.taskManager.finish(r);this.toSvgaStage="extracting",this.toSvgaMessage="处理帧...";for(var s=[],l=this.frames.files,h=0;h<l.length;h++){if(this.toSvgaCancelled){this.taskManager.finish(r);break}s.push({index:h,blob:l[h]}),t.toSvgaProgress=Math.round(h/l.length*50)}if(this.toSvgaCancelled)return void this.taskManager.finish(r);this.toSvgaStage="building";var c=await this.buildSVGAFromConfig("frames",{frames:s,width:i,height:a,fps:n,quality:o,originalSize:{width:this.frames.originalWidth,height:this.frames.originalHeight},dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(this.toSvgaCancelled)return void this.taskManager.finish(r);this.downloadSVGA(c,"sequence.svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。"),this.configManager&&this.configManager.set("framesToSvgaConfig",{quality:o}),setTimeout(function(){t.isConvertingToSvga=!1,t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage=""},1e3),this.taskManager.finish(r)}catch(d){this.taskManager.finish(r),"FFmpeg服务正忙，请稍后再试"===d.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("序列帧转SVGA失败:",d),alert("转换失败: "+d.message)),this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""}finally{this.taskManager&&r&&this.taskManager.finish(r)}}}}else alert("请先加载序列帧文件")},cancelFramesToSvgaConversion:function(){this.toSvgaCancelled=!0,this.toSvgaMessage="正在取消..."},openFramesToDualChannelPanel:function(){if(this.frames.hasFile&&this.frames.files.length){var e=this.frames.fileInfo.fps||25;this.dualChannelSourceInfo={name:this.frames.fileInfo.name,sizeWH:(this.frames.originalWidth||0)+" x "+(this.frames.originalHeight||0),duration:this.frames.fileInfo.duration,fileSize:this.frames.fileInfo.sizeText,fps:e},this.dualChannelConfig.width=this.frames.originalWidth,this.dualChannelConfig.height=this.frames.originalHeight,this.dualChannelConfig.fps=e,this.dualChannelConfig.height>0?this.dualChannelConfig.aspectRatio=this.dualChannelConfig.width/this.dualChannelConfig.height:this.dualChannelConfig.aspectRatio=1;try{if(this.configManager){var t=this.configManager.get("mp4_quality");void 0!==t&&(this.dualChannelConfig.quality=parseInt(t))}}catch(i){console.error("Config load failed:",i)}this.openRightPanel("showImagesToDualChannelPanel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载序列帧文件")},cancelFramesToDualChannelConversion:function(){this.dualChannelCancelled=!0,this.dualChannelMessage="正在取消..."},startFramesToDualChannelConversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.frames.hasFile&&this.frames.files.length){if(this.confirmIfHasOngoingTasks("序列帧转MP4","task"))if((e=this.dualChannelConfig).width<1||e.width>9999)alert("宽度超出范围！\n\n合法范围：1-9999 像素");else if(e.height<1||e.height>9999)alert("高度超出范围！\n\n合法范围：1-9999 像素");else if(e.quality<1||e.quality>100)alert("压缩质量超出范围！\n\n合法范围：1-100");else if(e.fps<1||e.fps>120)alert("帧率超出范围！\n\n合法范围：1-120 fps");else{try{this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(s){console.error("Config save failed:",s)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var i=null;this.taskManager&&(i=this.taskManager.register("序列帧转双通道",function(){t.cancelFramesToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";try{var o=await this.extractFramesForDualChannel();if(this.dualChannelCancelled)throw new Error("用户取消转换")}catch(l){return this.isConvertingToDualChannel=!1,this.dualChannelProgress=0,this.dualChannelMessage="转换失败",void alert("提取序列帧失败: "+l.message)}this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var n=await this.composeFramesDualChannel(o);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var r=await a.FFmpegService.convertFramesToMp4({frames:n,fps:e.fps,quality:e.quality,audioData:null,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadDualChannelMP4(r,"frames"),setTimeout(function(){alert("✅ 转换完成！")},500),this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(l){"用户取消转换"===l.message||("FFmpeg服务正忙，请稍后再试"===l.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("序列帧转双通道MP4失败:",l),alert("转换失败："+l.message)))}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isConvertingToDualChannel=!1}}}else alert("请先加载序列帧文件")},extractFramesForDualChannel:async function(){var e=this.dualChannelConfig,t=this.framesImages,i=t.length,a=[];console.log("开始提取帧，总帧数:",i,"尺寸:",e.width,"x",e.height);var o=document.createElement("canvas");o.width=e.width,o.height=e.height;for(var n=o.getContext("2d",{willReadFrequently:!0,alpha:!0}),r=0;r<i&&!this.dualChannelCancelled;r++){var s=t[r];n.clearRect(0,0,e.width,e.height),n.drawImage(s,0,0,e.width,e.height);var l=n.getImageData(0,0,e.width,e.height);a.push(l),this.dualChannelProgress=Math.floor(r/i*30)}return a},composeFramesDualChannel:async function(e,t){var i=this;return console.log("开始合成双通道帧，帧数:",e.length,"格式:",t),a.DualChannelComposer.composeFrames(e,{mode:this.dualChannelConfig.channelMode,format:t||"jpeg",onProgress:function(t){i.dualChannelProgress=30+Math.round(30*t),i.dualChannelMessage="合成双通道帧 "+Math.round(t*e.length)+"/"+e.length},onCancel:function(){return i.dualChannelCancelled}})},startSVGAConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),this.yyevaVideo&&this.yyeva.hasFile){if(this.confirmIfHasOngoingTasks("转SVGA","task")){var i=this.toSvgaConfig.width,o=this.toSvgaConfig.height,n=this.toSvgaConfig.quality,r=this.toSvgaConfig.fps;if(i<1||i>3e3)alert("宽度超出范围！\n\n合法范围：1-3000 像素\n当前值："+i);else if(o<1||o>3e3)alert("高度超出范围！\n\n合法范围：1-3000 像素\n当前值："+o);else if(n<1||n>100)alert("压缩质量超出范围！\n\n合法范围：1-100\n当前值："+n);else if(r<1||r>60)alert("帧率超出范围！\n\n合法范围：1-60 fps\n当前值："+r);else{this.configManager&&this.configManager.set("svga_quality",this.toSvgaConfig.quality),this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="正在加载库...";var s=null;this.taskManager&&(s=this.taskManager.register("双通道MP4转SVGA",function(){t.cancelYyevaToSvgaConversion()}));try{if(await this.loadLibrary(["protobuf","pako"],!0),this.toSvgaCancelled)throw new Error("用户取消转换");this.toSvgaStage="extracting",this.toSvgaMessage="正在提取序列帧...";var l=await this.extractYyevaFramesOptimized();if(this.toSvgaCancelled)throw new Error("用户取消转换");var h=null;if(!this.toSvgaConfig.muted&&this.yyeva.file){this.toSvgaMessage="正在提取音频...";try{await a.FFmpegService.init();var c=this.speedRemapConfig.originalTotalFrames,d=30,g=this.yyevaVideo;g&&g.duration>0&&c&&(d=c/g.duration),h=await this.extractAudioFromMp4(this.yyeva.file,l.frames.length,this.toSvgaConfig.fps,c,d)}catch(m){console.warn("Audio extraction failed, exporting silent SVGA:",m)}if(this.toSvgaCancelled)throw new Error("用户取消转换")}this.toSvgaStage="building";var f=await this.buildSVGAFromConfig("yyeva",{buildType:"fromPNG",frames:l.frames,scaledWidth:l.scaledWidth,scaledHeight:l.scaledHeight,displayWidth:l.displayWidth,displayHeight:l.displayHeight,scaleFactor:l.scaleFactor,fps:this.toSvgaConfig.fps,audios:h,muted:this.toSvgaConfig.muted,dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(this.toSvgaCancelled)throw new Error("用户取消转换");this.toSvgaStage="done";var u=this.yyeva.fileInfo.name.replace(/\.mp4$/i,"");this.downloadSVGA(f,u+".svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。")}catch(p){"用户取消转换"!==p.message&&(console.error("SVGA转换失败:",p),alert("转换失败："+p.message)),setTimeout(function(){t.isConvertingToSvga||(t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage="")},1e3)}finally{this.taskManager&&s&&this.taskManager.finish(s),this.isConvertingToSvga=!1}}}}else alert("请先加载双通道 MP4 文件")},extractYyevaFrames:async function(){var e=this.yyevaVideo,t=this.toSvgaConfig.fps,i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,o=(this.toSvgaConfig.quality||100)/100,n=Math.round(i*o),r=Math.round(a*o);n=Math.max(1,n),r=Math.max(1,r);var s=e.duration,l=Math.ceil(s*t);e.pause();var h=e.videoWidth,c=e.videoHeight,d=Math.floor(h/2),g=this.yyeva.alphaPosition,f=null;try{f=new OffscreenCanvas(h,c)}catch(T){(f=document.createElement("canvas")).width=h,f.height=c}var u=f.getContext("2d",{willReadFrequently:!0}),m=null;try{m=new OffscreenCanvas(n,r)}catch(T){(m=document.createElement("canvas")).width=n,m.height=r}for(var p=m.getContext("2d",{willReadFrequently:!0}),v=[],y=0;y<l&&!this.toSvgaCancelled;y++){var w=y/t;e.currentTime=w,await new Promise(function(t){if(e.currentTime===w&&e.readyState>=2)t();else{var i=function(){e.removeEventListener("seeked",i),t()};e.addEventListener("seeked",i),setTimeout(function(){e.removeEventListener("seeked",i),t()},2e3)}}),u.drawImage(e,0,0);for(var C="right"===g?0:d,M="right"===g?d:0,S=u.getImageData(C,0,d,c),b=u.getImageData(M,0,d,c),F=0;F<S.data.length;F+=4){var k=b.data[F];k>0&&(S.data[F]=Math.min(255,255*S.data[F]/k),S.data[F+1]=Math.min(255,255*S.data[F+1]/k),S.data[F+2]=Math.min(255,255*S.data[F+2]/k)),S.data[F+3]=k}var P=document.createElement("canvas");P.width=d,P.height=c,P.getContext("2d").putImageData(S,0,0),p.clearRect(0,0,n,r),p.drawImage(P,0,0,d,c,0,0,n,r);var x=await new Promise(function(e){m.toBlob(function(t){e(t)},"image/png")}),I=await x.arrayBuffer();v.push(new Uint8Array(I)),this.toSvgaProgress=Math.round((y+1)/l*50),(y+1)%10==0?await new Promise(function(e){setTimeout(e,16)}):await new Promise(function(e){setTimeout(e,0)})}return{frames:v,scaledWidth:n,scaledHeight:r,displayWidth:i,displayHeight:a,scaleFactor:o}},extractYyevaFramesOptimized:async function(){var e=this,t=this.toSvgaConfig.fps,i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,o=(this.toSvgaConfig.quality||100)/100,n=Math.round(i*o),r=Math.round(a*o);n=Math.max(1,n),r=Math.max(1,r);var s=this.yyeva.alphaPosition,l=null;this.yyevaVideo&&this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(l=this.buildFrameMap(t))&&l.length;try{if(await this.loadLibrary(["ffmpeg"],!0),this.toSvgaCancelled)throw new Error("用户取消转换");var h=this.yyeva.file;if(!h)throw new Error("没有找到视频文件");var c=await window.MeeWoo.Services.FFmpegService.extractFrames({videoFile:h,fps:t,width:2*i,height:a,onProgress:function(t){e.toSvgaProgress=Math.round(50*t)},checkCancelled:function(){return e.toSvgaCancelled}});if(this.toSvgaCancelled)throw new Error("用户取消转换");var d=c;if(l&&l.length>0){for(var g=[],f=0;f<l.length&&!this.toSvgaCancelled;f++){var u=l[f],m=Math.min(Math.max(0,Math.round(u*c.length/this.speedRemapConfig.originalTotalFrames)),c.length-1);g.push(c[m])}d=g}var p=[],v=d.length,y=null;try{y=new OffscreenCanvas(0,0)}catch(R){y=document.createElement("canvas")}var w=y.getContext("2d",{willReadFrequently:!0}),C=null;try{C=new OffscreenCanvas(n,r)}catch(R){(C=document.createElement("canvas")).width=n,C.height=r}var M=C.getContext("2d");for(f=0;f<v&&!this.toSvgaCancelled;f++){var S=new Blob([d[f]],{type:"image/png"}),b=URL.createObjectURL(S),F=await new Promise(function(e,t){var i=new Image;i.onload=function(){e(i)},i.onerror=function(){t(new Error("加载帧失败"))},i.src=b});y.width=F.width,y.height=F.height;var k=Math.floor(F.width/2);w.drawImage(F,0,0);for(var P="right"===s?0:k,x="right"===s?k:0,I=w.getImageData(P,0,k,F.height),T=w.getImageData(x,0,k,F.height),E=0;E<I.data.length;E+=4){var W=T.data[E];W>0&&(I.data[E]=Math.min(255,255*I.data[E]/W),I.data[E+1]=Math.min(255,255*I.data[E+1]/W),I.data[E+2]=Math.min(255,255*I.data[E+2]/W)),I.data[E+3]=W}var L=document.createElement("canvas");L.width=k,L.height=F.height,L.getContext("2d").putImageData(I,0,0),M.clearRect(0,0,n,r),M.drawImage(L,0,0,k,F.height,0,0,n,r);var D=await new Promise(function(e){C.toBlob(function(t){e(t)},"image/png")}),A=await D.arrayBuffer();p.push(new Uint8Array(A)),URL.revokeObjectURL(b),e.toSvgaProgress=Math.round((f+1)/v*50),(f+1)%10==0?await new Promise(function(e){setTimeout(e,16)}):await new Promise(function(e){setTimeout(e,0)})}return{frames:p,scaledWidth:n,scaledHeight:r,displayWidth:i,displayHeight:a,scaleFactor:o}}catch(_){throw console.error("FFmpeg提取帧失败:",_),new Error("FFmpeg加载失败或提取帧失败："+_.message)}},startMP4Conversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.svgaPlayer&&this.svga.hasFile&&this.originalVideoItem){if(this.confirmIfHasOngoingTasks("SVGA转双通道","task")){var i=this.dualChannelConfig.width,o=this.dualChannelConfig.height,n=this.dualChannelConfig.quality,r=this.dualChannelConfig.fps;if(i<1||i>9999)alert("宽度超出范围！\n\n合法范围：1-9999 像素\n当前值："+i);else if(o<1||o>9999)alert("高度超出范围！\n\n合法范围：1-9999 像素\n当前值："+o);else if(n<1||n>100)alert("压缩质量超出范围！\n\n合法范围：1-100\n当前值："+n);else if(r<1||r>120)alert("帧率超出范围！\n\n合法范围：1-120 fps\n当前值："+r);else{try{this.configManager&&(this.configManager.set("mp4_quality",this.dualChannelConfig.quality),this.configManager.set("mp4_fps",this.dualChannelConfig.fps))}catch(p){console.error("Failed to save MP4 config:",p)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var s=null;this.taskManager&&(s=this.taskManager.register("SVGA转双通道",function(){t.cancelSvgaToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";var l=await this.extractFrames();if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var h=await this.composeDualChannelFrames(l);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var c=null,d=this.svgaAudioData&&Object.keys(this.svgaAudioData).length>0;if(!this.dualChannelConfig.muted&&d){var g=Object.keys(this.svgaAudioData);c=this.svgaAudioData[g[0]]}var f=this.originalVideoItem,u=f.FPS||f.fps||30,m=await a.FFmpegService.convertFramesToMp4({frames:h,fps:this.dualChannelConfig.fps,inputFps:u,quality:this.dualChannelConfig.quality,audioData:c,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadMP4(m),setTimeout(function(){var e="";(e=t.dualChannelConfig.muted?"✅ 转换完成！\n\n已按您的要求生成静音MP4文件。":d?c?"✅ 转换完成！\n\n已成功将SVGA中的音频合成到MP4文件中。\n\n请播放检查音频效果，如有问题请反馈。":"✅ 转换完成！":"✅ 转换完成！\n\nSVGA文件不包含音频，已生成静音MP4文件。")&&alert(e)},500),setTimeout(function(){t.isConvertingToDualChannel||(t.dualChannelProgress=0,t.dualChannelStage="",t.dualChannelMessage="")},1e3)}catch(v){"用户取消转换"!==v.message&&(console.error("MP4转换失败:",v),alert("转换失败："+v.message))}finally{this.taskManager&&s&&this.taskManager.finish(s),this.isConvertingToDualChannel=!1}}}}else alert("请先加载 SVGA 文件")},extractAudioFromMp4:async function(e,t,i,o,n){if((i=parseFloat(i)||30)<=0&&(i=30),n&&Math.abs(n-i)>.1&&(console.warn("帧率变化检测: Source="+n+"fps, Target="+i+"fps"),console.warn("注意：如果变速关键帧是基于Source帧率打点的，直接应用到Target帧率可能会导致时间轴偏移。")),!a.FFmpegService.isLoaded)try{await a.FFmpegService.init()}catch(u){return console.error("FFmpeg初始化失败:",u),null}try{if(this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var r=this.speedRemapConfig.keyframes,s=(o=this.speedRemapConfig.originalTotalFrames,r.length>2);if(s||2!==r.length||(s=0!==r[0].position||1!==r[1].position),s){var l=o/(this.mp4Video?this.mp4Video.duration:0),h=r[0].position,c=r[r.length-1].position,d=c-h;return d<1e-4&&(d=1),console.log("音频变速预处理: 归一化关键帧范围",h.toFixed(3)+"-"+c.toFixed(3),"Range:",d.toFixed(3)),(r=r.map(function(e){return{frame:e.frame,originalFrame:e.originalFrame,position:(e.position-h)/d,speed:e.speed}})).length>0&&(r[0].position=0,r[r.length-1].position=1),await a.FFmpegService.extractAudioWithSpeedRemap({videoFile:e,keyframes:r,totalFrames:t,fps:i,originalTotalFrames:o,originalFps:l})}if((f=this.mp4Video?this.mp4Video.duration:0)>0&&i>0){var g=f/(t/i);return await a.FFmpegService.extractAudio({videoFile:e,totalFrames:t,fps:i,speedRatio:g})}}var f;return g=1,o&&n&&n!==i&&(g=(f=o/n)/(t/i)),await a.FFmpegService.extractAudio({videoFile:e,totalFrames:t,fps:i,speedRatio:g})}catch(u){return console.error("音频提取失败:",u),null}},extractFrames:async function(){var e=this.originalVideoItem;if(!e)throw new Error("请先加载SVGA文件");var t=e.frames,i=e.videoSize.width,a=e.videoSize.height,o=e.FPS||24,n=this.dualChannelConfig.width||i,r=this.dualChannelConfig.height||a,s=[],l=this.isPlaying;l&&this.svgaPlayer.pauseAnimation();var h=this.svgaPlayer.$canvas||this.$refs.svgaContainer.querySelector("canvas");if(!h)throw new Error("无法获取播放器Canvas");var c=Math.max(16,Math.ceil(1e3/o*1.5)),d=document.createElement("canvas");d.width=n,d.height=r;var g=d.getContext("2d",{alpha:!0,willReadFrequently:!0});g.imageSmoothingEnabled=!1;try{for(var f=0;f<t;f++){if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelProgress=Math.round((f+1)/t*100),this.dualChannelMessage="提取序列帧 "+(f+1)+"/"+t,this.svgaPlayer.stepToFrame(f,!1),h.requestPaint&&h.requestPaint(),await new Promise(function(e){requestAnimationFrame(function(){setTimeout(e,c)})}),g.clearRect(0,0,n,r),g.drawImage(h,0,0,h.width,h.height,0,0,n,r);var u=g.getImageData(0,0,n,r);s.push(u),f%5==0&&await new Promise(function(e){setTimeout(e,0)})}}finally{l&&this.svgaPlayer&&"svga"===this.currentModule&&this.svgaPlayer.startAnimation()}return s},composeDualChannelFrames:async function(e){var t=this,i="color-left-alpha-right";return this.dualChannelConfig&&(i=this.dualChannelConfig.channelMode),this.dualChannelConfig&&(i=this.dualChannelConfig.channelMode),this.dualChannelConfig&&(i=this.dualChannelConfig.channelMode),(this.isConvertingToDualChannel&&"svga"===this.currentModule||this.isConvertingToDualChannel&&"mp4"===this.currentModule||this.isConvertingToDualChannel&&"lottie"===this.currentModule)&&(i=this.dualChannelConfig.channelMode),a.DualChannelComposer.composeToJPEG(e,{mode:i,onProgress:function(i){t.dualChannelProgress=Math.round(100*i),t.dualChannelMessage="合成双通道帧 "+Math.round(i*e.length)+"/"+e.length},onCancel:function(){return t.dualChannelCancelled}})},downloadMP4:function(e){var t=this.svga.fileInfo.name||"svga";t=(t=t.replace(/\.svga$/i,""))+("color-left-alpha-right"===(this.dualChannelConfig?this.dualChannelConfig.channelMode:"color-left-alpha-right")?"_yyeva_LR":"_yyeva_RL")+".mp4";var i=URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},buildSVGAFromConfig:async function(e,t,i){var o=this,n=i.progressField,r=i.messageField,s=i.cancelledField;this[r]="生成SVGA...";var l,h=t.onProgress;if(t.onProgress=function(e){o[n]=Math.round(50+50*e),h&&h(e)},l="fromPNG"===t.buildType?await a.SvgaBuilder.buildFromPNG(t):await a.SvgaBuilder.build(t),this[s])throw new Error("用户取消转换");return this[n]=100,this[r]="转换完成！",l},downloadSVGA:function(e,t){this.utils.downloadFile(e,t)},cancelSvgaToDualChannelConversion:function(){this.dualChannelCancelled=!0,this.dualChannelMessage="正在取消..."}},computed:{isGlobalTaskRunning:function(){return this.taskManager&&this.taskManager.hasRunningTasks()},hasReplacedMaterials:function(){return Object.keys(this.replacedImages).length>0},isEmpty:function(){return!(this.svga.hasFile||this.yyeva.hasFile||this.mp4.hasFile||this.lottie.hasFile||this.frames.hasFile)},currentFileInfo:function(){return"svga"===this.currentModule&&this.svga.hasFile?this.svga.fileInfo:"yyeva"===this.currentModule&&this.yyeva.hasFile?this.yyeva.fileInfo:"mp4"===this.currentModule&&this.mp4.hasFile?this.mp4.fileInfo:"lottie"===this.currentModule&&this.lottie.hasFile?this.lottie.fileInfo:"frames"===this.currentModule&&this.frames.hasFile?this.frames.fileInfo:{}},currentBgColor:function(){return"white"===this.bgColorKey?"#ffffff":"green"===this.bgColorKey?"#00ff00":"red"===this.bgColorKey?"#df3321":"yellow"===this.bgColorKey?"#f1c40d":"blue"===this.bgColorKey?"#00b4ff":"pattern"===this.bgColorKey?"transparent":"#000000"},hasAudio:function(){if("svga"===this.currentModule){var e=this.originalVideoItem&&this.originalVideoItem.audios&&this.originalVideoItem.audios.length>0||this.svgaMovieData&&this.svgaMovieData.audios&&this.svgaMovieData.audios.length>0,t=this.svgaAudioData&&Object.keys(this.svgaAudioData).length>0;return e&&t}return"yyeva"===this.currentModule?this.yyevaHasAudio:"mp4"===this.currentModule?this.mp4HasAudio:(this.currentModule,!1)},materialThumbBgColor:function(){return this.bgColorKey&&"pattern"!==this.bgColorKey?this.currentBgColor:this.isDarkMode?"#2a2a2a":"#fcfcfc"},speedRemapSegments:function(){var e=this.speedRemapConfig.keyframes;if(!e||e.length<2)return[];for(var t=this.speedRemapConfig.originalTotalFrames||1,i=[],a=0;a<e.length-1;a++){var o=e[a],n=e[a+1],r=n.originalFrame-o.originalFrame,s=n.position-o.position,l=1;s>0&&r>0&&(l=r/(s*t));var h=0;l>1?h=Math.min(1,.2*(l-1)):l<1&&(h=Math.min(1,2*(1-l))),i.push({startPos:o.position,endPos:n.position,speed:l,opacity:h})}return i},yyevaToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0,i=this.toSvgaConfig.fps||30,a=this.toSvgaConfig.quality||80,o=this.toSvgaConfig.muted,n=a/100,r=Math.round(e*n),s=Math.round(t*n),l=0;this.yyevaVideo&&(l=this.yyevaVideo.duration||0);var h=Math.ceil(l*i),c=0;this.yyeva.fileInfo&&this.yyeva.fileInfo.size&&(c=(4*this.yyeva.fileInfo.size/1024/1024).toFixed(1));var d=(r*s*h*4/1024/1024).toFixed(1),g="0kb";this.yyeva.fileInfo&&this.yyeva.fileInfo.size&&(g=this.utils.formatBytes(this.yyeva.fileInfo.size));var f=r*s*.5*h*.7;return!o&&this.yyevaHasAudio&&(f+=16*l*1024/8),{frames:h,duration:l,beforeMemory:c+"M",afterMemory:d+"M",beforeFileSize:g,afterFileSize:h>0?this.utils.formatBytes(f):"？"}},mp4ToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0,i=this.toSvgaConfig.fps||30,a=(this.toSvgaConfig.quality||80)/100,o=Math.round(e*a),n=Math.round(t*a),r=0;this.mp4Video&&(r=this.mp4Video.duration||0);var s=Math.ceil(r*i),l=(o*n*s*4/1024/1024).toFixed(1),h="0kb";this.mp4.fileInfo&&this.mp4.fileInfo.size&&(h=this.utils.formatBytes(this.mp4.fileInfo.size));var c=o*n*.5*s*.7;return{frames:s,duration:r,afterMemory:l+"M",beforeFileSize:h,afterFileSize:s>0?this.utils.formatBytes(c):"？"}},lottieToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0,i=this.toSvgaConfig.fps||30,a=(this.toSvgaConfig.quality||80)/100,o=Math.round(e*a),n=Math.round(t*a),r=0;this.lottie&&this.lottie.fileInfo&&this.lottie.fileInfo.duration&&(r=this.lottie.fileInfo.duration);var s=Math.ceil(r*i),l=(o*n*s*4/1024/1024).toFixed(1),h=o*n*.5*s*.7,c="？";return s>0&&(c=this.utils.formatBytes(h)),{frames:s,duration:r,afterMemory:l+"M",afterFileSize:c}},imagesToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0;this.toSvgaConfig.fps;var i=(this.toSvgaConfig.quality||80)/100,a=Math.round(e*i),o=Math.round(t*i),n=this.frames.files?this.frames.files.length:0,r=(a*o*n*4/1024/1024).toFixed(1),s=a*o*.5*n*.7,l="？";return n>0&&(l=this.utils.formatBytes(s)),{frames:n,afterMemory:r+"M",afterFileSize:l}},gifSourceInfo:function(){return this.getGifSourceInfo()},gifEstimate:function(){var e=this.gifConfig,t=this.getGifSourceInfo(),i=e.width||t.width||100,a=e.height||t.height||100,o=e.fps||30,n=t.duration||0,r=Math.ceil(n*o),s=e.transparent?.16:.13;e.transparent&&e.dither&&(s=.18);var l=i*a*s*r,h="？";return r>0&&(h=this.utils.formatBytes(l)),{frames:r,duration:n,fileSize:h,fileSizeBytes:l}},timeScaleTicks:function(){var e=this.speedRemapConfig.originalDuration||0,t=[];if(e<=0)return t;for(var i=e/10,a=[.5,1,2,5,10,20,30,60,120,300,600],o=.5,n=0;n<a.length;n++)if(a[n]>=i){o=a[n];break}i>a[a.length-1]&&(o=a[a.length-1]);for(var r=0;r<=e;r+=o){var s=r/e*500,l="";if(o<1)l=r.toFixed(1)+"s",r%1==0&&(l=Math.round(r)+"s");else if(o<60)l=Math.round(r)+"s";else{var h=Math.floor(r/60),c=Math.round(r%60);l=0===c?h+"m":h+"m"+c+"s"}t.push({time:r,position:s,label:l})}return t},speedRemapEstimate:function(){var e=this.speedRemapConfig,t=e.originalDuration||0,i=e.keyframes;if(!i||i.length<2)return{outputDuration:t.toFixed(2),outputTotalFrames:e.originalTotalFrames||0,durationChange:0,durationChangePercent:"0%"};var a=i[0].position,o=i[i.length-1].position-a,n=o*t,r=Math.ceil(o*(e.originalTotalFrames||0)),s=n-t,l=t>0?Math.round(s/t*100):0;return{outputDuration:n.toFixed(2),outputTotalFrames:r,durationChange:s.toFixed(2),durationChangePercent:(l>=0?"+":"")+l+"%"}},viewerContainerStyle:function(){var e={transform:"translate("+this.viewerOffsetX+"px, "+this.viewerOffsetY+"px) scale("+this.viewerScale+")",cursor:this.dragging?"grabbing":"grab"},t=this.getContentOriginalSize();return t&&(e.width=t.width+"px",e.height=t.height+"px"),e},viewerFilenameStyle:function(){var e=this.viewerScale,t={transform:"scale("+1/e+")",transformOrigin:"left bottom",marginBottom:8*e+"px"},i=this.getContentOriginalSize();return i&&(t.maxWidth=i.width*e+"px"),t}},created:function(){this.libraryLoader=t.libraryLoader,this.resourceManager=t.resourceManager,this.playerController=null;var e=window.MeeWoo||{},i=e.Services;this.fileValidator=new i.FileValidator(this.libraryLoader),this.utils=e.Utils,t.ConfigManager&&(this.configManager=new t.ConfigManager,this.loadUserConfig()),this.initTheme(),this.setupThemeListener(),this.modeStrategies={svga:{cleanup:this.cleanupSvga},yyeva:{cleanup:this.cleanupYyeva},mp4:{cleanup:this.cleanupMp4},lottie:{cleanup:this.cleanupLottie},frames:{cleanup:this.cleanupFrames}};var a=new URLSearchParams(window.location.search),o=a.get("src")||a.get("file");if(o){var n=this;if(0!==o.indexOf("http")){var r=document.createElement("a");r.href=o,o=r.href}fetch(o).then(function(e){return e.blob()}).then(function(e){var t=new File([e],o.split("/").pop(),{type:e.type});n.handleFile(t)}).catch(function(e){console.error("加载URL文件失败:",e)})}this.taskManager=t.taskManager,this.svgaPlayer=null,this.svgaParser=null,this.svgaObjectUrl=null,this.svgaAudioData=null,this.svgaMovieData=null,this.emptyStateSvgaPlayer=null,this.emptyStateSvgaParser=null,this.yyevaVideo=null,this.yyevaCanvas=null,this.yyevaCtx=null,this.yyevaAnimationId=null,this.yyevaObjectUrl=null,this.yyevaTempCanvas=null,this.yyevaTempCtx=null,this.lottiePlayer=null,this.lottieCanvas=null,this.lottieCtx=null,this.lottieAnimationId=null,this.mp4Video=null,this.mp4ObjectUrl=null,this.chromaKeyRenderLoop=null,this.framesCanvas=null,this.framesCtx=null,this.framesAnimationId=null,this.framesImages=[],this.framesBlobUrls=[],this.originalVideoItem=null},watch:{bgColorKey:function(e){var t=this;this.saveUserConfig("bgColorKey",e),this.$nextTick(function(){t.applyCanvasBackground()})},currentModule:function(e){this.saveUserConfig("lastMode",e)},gifConfig:{handler:function(e){var t={fps:e.fps,quality:e.quality,transparent:e.transparent,dither:e.dither,width:e.width,height:e.height};this.saveUserConfig("gifConfig",t)},deep:!0},footerContentVisible:function(e){e&&!this.playerController&&this.initPlayerController()},chromaKeyEnabled:function(){this.updateChromaKeyEffect()},chromaKeySimilarity:function(){this.chromaKeyEnabled&&this.updateChromaKeyEffect()},chromaKeySmoothness:function(){this.chromaKeyEnabled&&this.updateChromaKeyEffect()}},mounted:function(){var e=this;this.showEditFrameDialog=!1,this.editingKeyframeIndex=-1,this.editFrameInput="",this.showFramesFpsDialog=!1,this.showMoreDrawer=!1,this.initSvgaPlayer(),this.initViewportController();var i=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;this.isDarkMode=i,i&&document.body.classList.add("dark-mode"),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(t){if(!e.isThemeManuallySet){var i=t.matches;e.isDarkMode=i,i?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")}}),document.addEventListener("click",function(t){if(e.showChannelModeDropdown){var i=e.$refs.mp4SelectWrapper;i&&!i.contains(t.target)&&(e.showChannelModeDropdown=!1)}}),window.MeeWoo_GlobalInputController&&(window.MeeWoo_GlobalInputController.destroy&&window.MeeWoo_GlobalInputController.destroy(),window.MeeWoo_GlobalInputController=null),this.inputController&&(this.inputController.destroy&&this.inputController.destroy(),this.inputController=null);var a=new(window.MeeWoo||{}).Controllers.InputController({container:document.body,onHoverChange:function(t){e.dropHover=t},onDrop:function(t){e.handleFiles(t,!1)}});this.inputController=a,window.MeeWoo_GlobalInputController=a,this.loadHelpContent(),window.authUtils&&(this.handleLoginCallback(),this.updateLoginStatus()),t.libraryLoader?t.libraryLoader.onProgress(function(t){e.loadingLibraryInfo=t?{name:t.name,progress:t.progress}:null}):console.warn("libraryLoader not found"),document.addEventListener("keydown",function(t){var i=document.activeElement;if((!i||"INPUT"!==i.tagName&&"TEXTAREA"!==i.tagName&&!i.isContentEditable)&&!e.isEmpty)if(32===t.keyCode||" "===t.key)t.preventDefault(),e.togglePlay();else if(("ArrowLeft"===t.key||"ArrowRight"===t.key)&&(t.preventDefault(),e.playerController)){var a="ArrowLeft"===t.key?-1:1;e.playerController.step(a)}}),this.preloadLibraries()},beforeDestroy:function(){this.inputController&&(this.inputController.destroy(),this.inputController=null)}});window.MeeWoo.app=r}()}var t=setInterval(function(){"undefined"!=typeof Vue&&"undefined"!=typeof SVGA&&(clearInterval(t),e())},100)}();export{t as _};
