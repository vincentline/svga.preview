!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={commandTypes:{ADD_ELEMENT:"addElement",DELETE_ELEMENT:"deleteElement",UPDATE_ELEMENT:"updateElement",TRANSFORM_ELEMENT:"transformElement",MOVE_ELEMENT:"moveElement",COPY_ELEMENT:"copyElement",PASTE_ELEMENT:"pasteElement",GROUP_ELEMENTS:"groupElements",UNGROUP_ELEMENTS:"ungroupElements",LOCK_ELEMENT:"lockElement",UNLOCK_ELEMENT:"unlockElement",HIDE_ELEMENT:"hideElement",SHOW_ELEMENT:"showElement"},initCommandManager:function(e,t){return{stageInstance:e,config:Object.assign({},{maxHistorySize:100,enabled:!0},t),commandHistory:[],historyIndex:-1,isExecutingCommand:!1,commandQueue:[]}},executeCommand:function(e,t){if(t&&t.execute&&t.undo)if(e.isExecutingCommand)e.commandQueue.push(t);else{e.isExecutingCommand=!0;try{t.execute(),this.updateCommandHistory(e,t),this.triggerCommandEvent(e,"execute",t)}catch(e){console.error("Command execution failed:",e)}finally{e.isExecutingCommand=!1,this.executeCommandQueue(e)}}},executeCommandQueue:function(e){for(;e.commandQueue.length>0;){var t=e.commandQueue.shift();this.executeCommand(e,t)}},undo:function(e){if(this.canUndo(e)){e.isExecutingCommand=!0;try{var t=e.commandHistory[e.historyIndex];t.undo(),e.historyIndex--,this.triggerCommandEvent(e,"undo",t)}catch(e){console.error("Command undo failed:",e)}finally{e.isExecutingCommand=!1}}},redo:function(e){if(this.canRedo(e)){e.isExecutingCommand=!0;try{e.historyIndex++;var t=e.commandHistory[e.historyIndex];t.execute(),this.triggerCommandEvent(e,"redo",t)}catch(e){console.error("Command redo failed:",e)}finally{e.isExecutingCommand=!1}}},updateCommandHistory:function(e,t){e.historyIndex<e.commandHistory.length-1&&(e.commandHistory=e.commandHistory.slice(0,e.historyIndex+1)),e.commandHistory.push(t),e.historyIndex++,e.commandHistory.length>e.config.maxHistorySize&&(e.commandHistory.shift(),e.historyIndex--)},canUndo:function(e){return e.historyIndex>=0},canRedo:function(e){return e.historyIndex<e.commandHistory.length-1},clearCommandHistory:function(e){e.commandHistory=[],e.historyIndex=-1,this.triggerCommandEvent(e,"clearHistory")},triggerCommandEvent:function(e,t,n){e.stageInstance.stage.fire("command:"+t,{commandState:e,command:n,canUndo:this.canUndo(e),canRedo:this.canRedo(e)})},createAddElementCommand:function(e,t,n){return{type:this.commandTypes.ADD_ELEMENT,element:t,layer:n,execute:function(){n.add(t),n.draw()},undo:function(){t.remove(),n.draw()}}},createDeleteElementCommand:function(e,t){var n=t.getParent();return{type:this.commandTypes.DELETE_ELEMENT,element:t,parent:n,execute:function(){t.remove(),n.draw()},undo:function(){n.add(t),n.draw()}}},createUpdateElementCommand:function(e,t,n,o){return{type:this.commandTypes.UPDATE_ELEMENT,element:t,newProperties:n,oldProperties:o||this.saveElementProperties(t,Object.keys(n)),execute:function(){t.setAttrs(this.newProperties),t.getLayer().draw()},undo:function(){t.setAttrs(this.oldProperties),t.getLayer().draw()}}},createTransformElementCommand:function(e,t,n,o){return{type:this.commandTypes.TRANSFORM_ELEMENT,element:t,newTransform:n,oldTransform:o||this.saveTransformState(t),execute:function(){t.setAttrs(this.newTransform),t.getLayer().draw()},undo:function(){t.setAttrs(this.oldTransform),t.getLayer().draw()}}},createCopyElementCommand:function(e,t){return{type:this.commandTypes.COPY_ELEMENT,element:t,copy:null,execute:function(){this.copy=t.clone(),this.copy.setAttr("id","element-"+Date.now()+"-"+Math.floor(1e4*Math.random())),e.stageInstance.stage.fire("command:copy",{element:this.element,copy:this.copy})},undo:function(){this.copy=null}}},createPasteElementCommand:function(e,t,n){return{type:this.commandTypes.PASTE_ELEMENT,element:t,layer:n,execute:function(){n.add(this.element),this.element.x(this.element.x()+20),this.element.y(this.element.y()+20),n.draw()},undo:function(){this.element.remove(),n.draw()}}},saveElementProperties:function(e,t){var n={};return t.forEach(function(t){n[t]=e.getAttr(t)}),n},saveTransformState:function(e){return{x:e.x(),y:e.y(),scaleX:e.scaleX(),scaleY:e.scaleY(),rotation:e.rotation(),skewX:e.skewX(),skewY:e.skewY()}},executeBatchCommands:function(e,t,n){var o={type:"batch",name:n||"batch",commands:t,execute:function(){this.commands.forEach(function(e){e.execute()})},undo:function(){for(var e=this.commands.length-1;e>=0;e--)this.commands[e].undo()}};this.executeCommand(e,o)},getCommandHistory:function(e){return e.commandHistory},getHistoryIndex:function(e){return e.historyIndex},getHistorySize:function(e){return e.commandHistory.length}};e.MeeWoo.Core.KonvaCommand=t}(window);