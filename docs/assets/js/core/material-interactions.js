!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={onPreviewAreaMouseDown:function(e,t){var i=this;null===e.editor.activeElement&&(e.editor.activeElement="none"),this.clearDragListeners(e.editor);var r=this.checkClickOnLayer(e,t),o=Date.now(),a=t.clientX,n=t.clientY;if(e.editor.isDragging=!1,t.altKey){var d=e.editor.offsetX,l=e.editor.offsetY,s=function(t){var i=t.clientX-a,r=t.clientY-n;if(Math.sqrt(i*i+r*r)>6&&(e.editor.isDragging=!0),e.editor.isDragging){var o=t.clientX-a,s=t.clientY-n;requestAnimationFrame(function(){e.editor.offsetX=d+o,e.editor.offsetY=l+s})}},c=function(){i.clearDragListeners(e.editor)};return e.editor.dragHandlers={mousemove:s,mouseup:c},document.addEventListener("mousemove",s),void document.addEventListener("mouseup",c)}var m=!1;if("none"!==e.editor.activeElement&&(m=r===e.editor.activeElement),"none"!==e.editor.activeElement&&m){var g=e.editor.imageOffsetX,u=e.editor.imageOffsetY,f=e.editor.textPosX,v=e.editor.textPosY;s=function(t){var i=t.clientX-a,r=t.clientY-n;if(Math.sqrt(i*i+r*r)>6&&(e.editor.isDragging=!0),e.editor.isDragging)if("image"===e.editor.activeElement){var o=t.clientX-a,d=t.clientY-n;requestAnimationFrame(function(){e.editor.imageOffsetX=g+o/e.editor.scale,e.editor.imageOffsetY=u+d/e.editor.scale})}else if("text"===e.editor.activeElement){o=t.clientX-a,d=t.clientY-n;var l=o/e.editor.scale/e.editor.baseImageWidth*100,s=d/e.editor.scale/e.editor.baseImageHeight*100;requestAnimationFrame(function(){e.editor.textPosX=f+l,e.editor.textPosY=v+s,e.renderEditorPreview()})}},c=function(t){var d=Date.now(),l=t.clientX,s=t.clientY,c=d-o,m=l-a,g=s-n,u=Math.sqrt(m*m+g*g);if(i.clearDragListeners(e.editor),!e.editor.isDragging&&u<=6&&c<=500){var f=Date.now(),v=!1;if(e.editor.lastClickElement===r&&f-e.editor.lastClickTime<300){var h=e.editor.lastClickX||0,E=e.editor.lastClickY||0;Math.sqrt(Math.pow(l-h,2)+Math.pow(s-E,2))<=8&&(v=!0)}if(v){var w=[];e.editor.showText&&w.push("text"),e.editor.showImage&&w.push("image");var p=(w.indexOf(e.editor.activeElement)+1)%w.length;e.editor.activeElement=w[p],e.editor.lastClickElement=w[p]}else e.editor.activeElement!==r&&(e.editor.activeElement=r,e.editor.lastClickElement=r);e.editor.lastClickTime=f,e.editor.lastClickX=l,e.editor.lastClickY=s}};e.editor.dragHandlers={mousemove:s,mouseup:c},document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}else{d=e.editor.offsetX,l=e.editor.offsetY;var s=function(t){var i=t.clientX-a,r=t.clientY-n;if(Math.sqrt(i*i+r*r)>6&&!e.editor.isDragging&&(e.editor.isDragging=!0),e.editor.isDragging){var o=t.clientX-a,s=t.clientY-n;requestAnimationFrame(function(){e.editor.offsetX=d+o,e.editor.offsetY=l+s})}},c=function(t){var d=Date.now(),l=t.clientX,s=t.clientY,c=d-o,m=l-a,g=s-n,u=Math.sqrt(m*m+g*g);if(i.clearDragListeners(e.editor),!e.editor.isDragging&&u<=6&&c<=500)if(r){var f=Date.now(),v=!1;if(e.editor.lastClickElement===r&&f-e.editor.lastClickTime<300){var h=e.editor.lastClickX||0,E=e.editor.lastClickY||0;Math.sqrt(Math.pow(l-h,2)+Math.pow(s-E,2))<=8&&(v=!0)}if(v){var w=[];e.editor.showText&&w.push("text"),e.editor.showImage&&w.push("image");var p=(w.indexOf(e.editor.activeElement)+1)%w.length;e.editor.activeElement=w[p],e.editor.lastClickElement=w[p]}else e.editor.activeElement=r,e.editor.lastClickElement=r;e.editor.lastClickTime=f,e.editor.lastClickX=l,e.editor.lastClickY=s}else e.editor.activeElement="none"};e.editor.dragHandlers={mousemove:s,mouseup:c},document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}},onPreviewAreaWheel:function(e,t){if(t.preventDefault(),null===e.editor.activeElement&&(e.editor.activeElement="none"),t.ctrlKey||t.metaKey||t.altKey){var i=t.deltaY>0?-.02:.02;this.handleEditorZoom(e,i)}else{var r=this.checkClickOnLayer(e,t);if("none"===e.editor.activeElement){i=t.deltaY>0?-.02:.02;this.handleEditorZoom(e,i)}else if(r===e.editor.activeElement){if("image"===r){i=t.deltaY>0?-.01:.01;(o=e.editor.imageScale+i)<.1&&(o=.1),o>10&&(o=10),e.editor.imageScale=parseFloat(o.toFixed(2))}else if("text"===r){var o;i=t.deltaY>0?-.01:.01;(o=e.editor.textScale+i)<.1&&(o=.1),o>10&&(o=10),e.editor.textScale=parseFloat(o.toFixed(2)),e.renderEditorPreview()}}else{i=t.deltaY>0?-.02:.02;this.handleEditorZoom(e,i)}}},onImageMouseDown:function(e,t){},onImageWheel:function(e,t){},toggleEditorViewMode:function(e){var t=document.querySelector(".editor-preview-area");if(t&&e.editor.baseImageHeight)if("fit-height"===e.editor.viewMode)e.editor.viewMode="one-to-one",e.editor.scale=1;else{e.editor.viewMode="fit-height";var i,r=t.clientHeight,o=t.clientWidth,a=.75*r/e.editor.baseImageHeight;(i=e.editor.baseImageWidth*a>o?o/e.editor.baseImageWidth:a)>5&&(i=5),i<.1&&(i=.1),e.editor.scale=parseFloat(i.toFixed(2))}},checkClickOnLayer:function(e,t){var i=document.querySelector(".editor-preview-area"),r=document.querySelector(".editor-preview-wrapper");if(!i||!r)return null;var o=i.getBoundingClientRect(),a=t.clientX-o.left,n=t.clientY-o.top,d=(i.clientWidth-r.clientWidth)/2,l=(i.clientHeight-r.clientHeight)/2,s=d+r.clientWidth,c=l+r.clientHeight;if(a<d||a>s||n<l||n>c)return null;if(e.editor.isDragging)return e.editor.activeElement;var m=Math.round((a-d)/e.editor.scale),g=Math.round((n-l)/e.editor.scale);if(e.editor.showText&&e.editor.textContent){var u=e.$refs.editorTextCanvas;if(u&&m>=0&&m<u.width&&g>=0&&g<u.height)try{if(u.getContext("2d",{willReadFrequently:!0}).getImageData(m,g,1,1).data[3]>0)return"text"}catch(e){}}return e.editor.showImage&&e.editor.baseImage?"image":null},onTextMouseDown:function(e,t){},onTextWheel:function(e,t){},onEditorFileChange:function(e,t){var i=t.target.files[0];if(i)if(i.type.match("image/jpeg|image/png")){var r=new FileReader;r.onload=function(t){var i=t.target.result;e.editor.baseImage=i;var r=e.materialEditStates[e.editor.targetKey]||{};r.customBaseImage=i,e.materialEditStates[e.editor.targetKey]=r,e.updateRestoreBtnState&&e.updateRestoreBtnState()},r.readAsDataURL(i),t.target.value=""}else e.showToast&&e.showToast("请上传JPG或PNG格式的图片")},triggerEditorUpload:function(e){e.$refs.editorFileInput&&e.$refs.editorFileInput.click()},handleEditorZoom:function(e,t){var i=e.editor.scale+t;i<.1&&(i=.1),i>5&&(i=5),e.editor.scale=parseFloat(i.toFixed(2))},moveEditorView:function(e,t,i){e.editor.offsetX+=t,e.editor.offsetY+=i},clearDragListeners:function(e){e.dragHandlers&&(e.dragHandlers.mousemove&&document.removeEventListener("mousemove",e.dragHandlers.mousemove),e.dragHandlers.mouseup&&document.removeEventListener("mouseup",e.dragHandlers.mouseup),e.dragHandlers=null)}};e.MeeWoo.Core.MaterialInteractions=t}(window);