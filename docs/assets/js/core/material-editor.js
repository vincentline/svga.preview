!function(t){"use strict";t.MeeWoo=t.MeeWoo||{},t.MeeWoo.Mixins=t.MeeWoo.Mixins||{};var e={data:function(){return{editor:t.MeeWoo.Core.MaterialState.getDefaultEditorState(),materialEditStates:t.MeeWoo.Core.MaterialState.getDefaultMaterialEditStates(),stageInstance:null,baseLayerInstance:null,textLayerInstance:null,transformerInstance:null,exportAreaGuide:null,konvaLayers:{backgroundLayer:null,textLayer:null,transformerLayer:null},textCanvas:null,textCanvasCtx:null}},computed:{editorTextStyleFiltered:function(){return t.MeeWoo.Core.MaterialOperations.filterTextStyle(this.editor.textStyle)},editorTextStyleString:function(){var e=this.editorTextStyleFiltered;return t.MeeWoo.Core.MaterialOperations.convertStylesToCssString(e)},hasEditInfo:function(){return this.editor.showRestoreBtn}},watch:{"editor.baseImage":function(){this.updateRestoreBtnState(),this.$nextTick(function(){this.updateKonvaBaseImage()}.bind(this))},"editor.showImage":function(t){this.updateRestoreBtnState(),this.baseLayerInstance&&this.stageInstance&&(this.baseLayerInstance.visible(t),this.stageInstance.draw())},"editor.imageOffsetX":function(){this.updateRestoreBtnState(),this.syncKonvaBaseImageTransform()},"editor.imageOffsetY":function(){this.updateRestoreBtnState(),this.syncKonvaBaseImageTransform()},"editor.imageScale":function(){this.updateRestoreBtnState(),this.syncKonvaBaseImageTransform()},"editor.showText":function(t){this.updateRestoreBtnState(),this.textLayerInstance&&this.stageInstance&&(this.textLayerInstance.visible(t),t&&this.renderTextCanvas(),this.stageInstance.draw())},"editor.textContent":function(){this.renderTextCanvas(),this.stageInstance&&this.stageInstance.draw()},"editor.textStyle":function(){this.renderTextCanvas(),this.stageInstance&&this.stageInstance.draw()},"editor.textPosX":function(){this.syncKonvaTextPosition()},"editor.textPosY":function(){this.syncKonvaTextPosition()},"editor.textScale":function(){this.textLayerInstance&&this.stageInstance&&(this.textLayerInstance.scaleX(this.editor.textScale),this.textLayerInstance.scaleY(this.editor.textScale),this.stageInstance.draw())},"editor.textAlign":function(){this.renderTextCanvas(),this.stageInstance&&this.stageInstance.draw()}},methods:{setTextAlign:function(t){this.editor.textAlign=t},updateRestoreBtnState:function(){t.MeeWoo.Core.MaterialState.updateRestoreButtonState(this.editor)},clearDragListeners:function(){},restoreOriginalMaterial:function(){t.MeeWoo.Core.MaterialOperations.restoreOriginalMaterial(this),this.$nextTick(function(){this.updateKonvaBaseImage(),this.renderTextCanvas(),this.stageInstance.draw()}.bind(this))},clearAllMaterialEditStates:function(){this.materialEditStates=t.MeeWoo.Core.MaterialState.getDefaultMaterialEditStates()},initKonvaStage:function(){var t=this,e=this.$refs.editorPreviewContent;if(e)try{if("undefined"==typeof Konva)return void console.error("[Konva] Konva library not loaded");var a=e.parentElement;if(!a)return void console.error("[Konva] Parent element not found");var n=a.clientWidth,s=a.clientHeight;if(0===n||0===s)return void setTimeout(function(){t.initKonvaStage()},100);if(this.stageInstance)return this.clearKonvaContent(),this.stageInstance.width(n),this.stageInstance.height(s),this.textCanvas=null,this.textCanvasCtx=null,this.initExportAreaGuide(),this.initKonvaTransformer(),this.initKonvaBaseImage(),this.initKonvaTextLayer(),void this.stageInstance.draw();this.stageInstance=new Konva.Stage({container:e,width:n,height:s}),this.konvaLayers.backgroundLayer=new Konva.Layer({name:"backgroundLayer"}),this.stageInstance.add(this.konvaLayers.backgroundLayer),this.konvaLayers.textLayer=new Konva.Layer({name:"textLayer"}),this.stageInstance.add(this.konvaLayers.textLayer),this.konvaLayers.transformerLayer=new Konva.Layer({name:"transformerLayer"}),this.stageInstance.add(this.konvaLayers.transformerLayer),this.initExportAreaGuide(),this.initKonvaTransformer(),this.initKonvaBaseImage(),this.initKonvaTextLayer(),this.stageInstance.draw(),this.initKonvaStageEvents(),this.stageInstance.draggable(!0),this.konvaLayers.backgroundLayer.batchDraw(),this.konvaLayers.textLayer.batchDraw(),this.konvaLayers.transformerLayer.batchDraw()}catch(t){console.error("Failed to initialize Konva stage:",t)}else console.error("[Konva] Container not found: $refs.editorPreviewContent is undefined")},initExportAreaGuide:function(){if(this.stageInstance){var t=this.stageInstance.width(),e=this.stageInstance.height(),a=this.editor.baseImageWidth||t,n=this.editor.baseImageHeight||e,s=(t-a)/2,i=(e-n)/2;this.editor.exportAreaX=s,this.editor.exportAreaY=i,this.exportAreaGuide&&this.exportAreaGuide.destroy(),this.exportAreaGuide=new Konva.Rect({x:s,y:i,width:a,height:n,stroke:"#00a8ff",strokeWidth:1,dash:[5,5],listening:!1}),this.konvaLayers.backgroundLayer.add(this.exportAreaGuide)}},clearKonvaContent:function(){this.transformerInstance&&(this.transformerInstance.destroy(),this.transformerInstance=null),this.exportAreaGuide&&(this.exportAreaGuide.destroy(),this.exportAreaGuide=null),this.baseLayerInstance&&(this.baseLayerInstance.destroy(),this.baseLayerInstance=null),this.textLayerInstance&&(this.textLayerInstance.destroy(),this.textLayerInstance=null),this.textCanvas=null,this.textCanvasCtx=null,this.editor.activeElement="none"},initKonvaTransformer:function(){this.stageInstance&&(this.transformerInstance=new Konva.Transformer({rotateEnabled:!1,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:function(t,e){return e.width<20||e.height<20?t:e}}),this.konvaLayers.transformerLayer.add(this.transformerInstance))},updateTransformer:function(){if(this.transformerInstance&&this.stageInstance){var t=null;"image"===this.editor.activeElement&&this.baseLayerInstance?t=this.baseLayerInstance:"text"===this.editor.activeElement&&this.textLayerInstance&&(t=this.textLayerInstance),t?this.transformerInstance.nodes([t]):this.transformerInstance.nodes([]),this.stageInstance.draw()}},initKonvaBaseImage:function(){if(this.stageInstance&&!this.baseLayerInstance){var t=this,e=this.editor.baseImageWidth,a=this.editor.baseImageHeight,n=this.editor.exportAreaX+e/2,s=this.editor.exportAreaY+a/2;if(this.baseLayerInstance=new Konva.Group({name:"baseImageGroup",draggable:!1,visible:this.editor.showImage,x:n+this.editor.imageOffsetX,y:s+this.editor.imageOffsetY,scaleX:this.editor.imageScale,scaleY:this.editor.imageScale}),this.editor.baseImage){var i=new Image;i.onload=function(){var n,s,r=i.width,o=i.height;if(e&&a){var h=e/r,d=a/o,c=Math.max(h,d);n=r*c,s=o*c}else n=r,s=o;var g=new Konva.Image({name:"baseImage",image:i,width:n,height:s,offsetX:n/2,offsetY:s/2,x:0,y:0});t.baseLayerInstance.add(g),t.konvaLayers.backgroundLayer.add(t.baseLayerInstance),t.stageInstance.draw(),t.bindBaseImageEvents()},i.onerror=function(t){console.error("[Konva] Image load error:",t)},i.crossOrigin="Anonymous",i.src=this.editor.baseImage}else this.konvaLayers.backgroundLayer.add(this.baseLayerInstance)}},bindBaseImageEvents:function(){var t=this;if(this.baseLayerInstance){var e=this.editor.exportAreaX+this.editor.baseImageWidth/2,a=this.editor.exportAreaY+this.editor.baseImageHeight/2;this.baseLayerInstance.on("click tap",function(e){e.cancelBubble=!0,t.editor.activeElement="image",t.baseLayerInstance.draggable(!0),t.textLayerInstance&&t.textLayerInstance.draggable(!1),t.stageInstance.draggable(!1),t.updateTransformer()}),this.baseLayerInstance.on("dragstart",function(){t.editor.isImageDragging=!0}),this.baseLayerInstance.on("dragmove",function(){t.editor.imageOffsetX=t.baseLayerInstance.x()-e,t.editor.imageOffsetY=t.baseLayerInstance.y()-a}),this.baseLayerInstance.on("dragend",function(){t.editor.isImageDragging=!1,t.updateRestoreBtnState()}),this.baseLayerInstance.on("transformstart",function(){t.editor.isImageDragging=!0}),this.baseLayerInstance.on("transform",function(){t.editor.imageOffsetX=t.baseLayerInstance.x()-e,t.editor.imageOffsetY=t.baseLayerInstance.y()-a,t.editor.imageScale=t.baseLayerInstance.scaleX()}),this.baseLayerInstance.on("transformend",function(){t.editor.isImageDragging=!1,t.editor.imageScale=parseFloat(t.baseLayerInstance.scaleX().toFixed(2)),t.updateRestoreBtnState()})}},initKonvaTextLayer:function(){if(this.stageInstance&&!this.textLayerInstance){var t=this.editor.baseImageWidth||500,e=this.editor.baseImageHeight||500,a=this.editor.exportAreaX+t/2,n=this.editor.exportAreaY+e/2;this.textCanvas=null,this.textCanvasCtx=null;var s=a+(this.editor.textPosX-50)/100*t,i=n+(this.editor.textPosY-50)/100*e;this.textLayerInstance=new Konva.Image({name:"textContent",image:null,visible:this.editor.showText,draggable:!1,x:s,y:i,offsetX:0,offsetY:0,scaleX:this.editor.textScale,scaleY:this.editor.textScale}),this.konvaLayers.textLayer.add(this.textLayerInstance),this.bindTextEvents(),this.renderTextCanvas()}},renderTextCanvas:function(){var t=this.editorTextStyleFiltered,e=this.editor.textContent;if(!e||!this.editor.showText)return this.textCanvas&&this.textCanvasCtx&&this.textCanvasCtx.clearRect(0,0,this.textCanvas.width,this.textCanvas.height),void(this.textLayerInstance&&this.stageInstance&&this.stageInstance.draw());var a,n=parseFloat(t["font-size"])||24,s=t["font-family"]||"sans-serif",i=t["font-weight"]||"normal",r=t["font-style"]||"normal";if(s=s.replace(/['"]/,""),this.textCanvasCtx)(a=this.textCanvasCtx).font=r+" "+i+" "+n+'px "'+s+'"';else{var o=document.createElement("canvas");o.width=1,o.height=1,(a=o.getContext("2d")).font=r+" "+i+" "+n+'px "'+s+'"'}for(var h=e.split("\n"),d=1.2*n,c=h.length*d,g=0,l=0;l<h.length;l++){var f=a.measureText(h[l]).width;f>g&&(g=f)}var x=.25*Math.max(g,c),I=Math.ceil(g+2*x),u=Math.ceil(c+2*x);this.textCanvas&&this.textCanvas.width===I&&this.textCanvas.height===u||(this.textCanvas=document.createElement("canvas"),this.textCanvas.width=I,this.textCanvas.height=u,this.textCanvasCtx=this.textCanvas.getContext("2d"),(a=this.textCanvasCtx).font=r+" "+i+" "+n+'px "'+s+'"',this.textLayerInstance&&(this.textLayerInstance.image(this.textCanvas),this.textLayerInstance.offsetX(I/2),this.textLayerInstance.offsetY(u/2))),a.clearRect(0,0,I,u),a.save();var y,v=this.editor.textAlign;y="left"===v?x:"right"===v?I-x:I/2;var m=x+d/2;a.textAlign=v,a.textBaseline="middle";var L=t.color||"#000000",b=t.background||t["background-image"],p="text"===t["-webkit-background-clip"]||"text"===t["background-clip"];if(b&&-1!==b.indexOf("gradient")&&p){for(var w,C=b.match(/linear-gradient\((\d+)deg/),S=C?parseInt(C[1]):180,M=[],T=/(#[0-9a-fA-F]+|rgba?\([^)]+\))\s*(\d+(?:\.\d+)?%?)/g;null!==(w=T.exec(b));){var k=w[2];k=(k.indexOf("%"),parseFloat(k)/100),M.push({color:w[1],stop:k})}if(M.length>=2){var K,A,E,X;(null===M[0].stop||isNaN(M[0].stop))&&(M[0].stop=0),(null===M[M.length-1].stop||isNaN(M[M.length-1].stop))&&(M[M.length-1].stop=1),0===S?(K=y,A=m+c/2,E=y,X=m-c/2):90===S?(K=y-g/2,A=u/2,E=y+g/2,X=u/2):270===S?(K=y+g/2,A=u/2,E=y-g/2,X=u/2):(K=y,A=m-c/2,E=y,X=m+c/2);for(var W=a.createLinearGradient(K,A,E,X),Y=0;Y<M.length;Y++){var B=Math.max(0,Math.min(1,M[Y].stop));W.addColorStop(B,M[Y].color)}L=W}}if(t["text-shadow"]){var O=t["text-shadow"].replace(/rgba?\([^)]+\)/gi,function(t){return t.replace(/,/g,"|")}).split(",").map(function(t){return t.replace(/\|/g,",").trim()});for(l=0;l<O.length;l++){var D=O[l].match(/(-?[\d.]+(?:px)?|0)\s+(-?[\d.]+(?:px)?|0)(?:\s+(-?[\d.]+(?:px)?|0))?\s+(#[0-9a-fA-F]+|rgba?\([^)]+\))/i);if(D){a.save(),a.shadowOffsetX=parseFloat(D[1]),a.shadowOffsetY=parseFloat(D[2]),a.shadowBlur=D[3]?parseFloat(D[3]):0,a.shadowColor=D[4],a.fillStyle=L;for(var F=0;F<h.length;F++){var P=m+F*d;a.fillText(h[F],y,P)}a.restore()}}a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0}var G=t["-webkit-text-stroke"]||t.border;if(G){var R=this.parseStroke(G);if(R){a.lineWidth=R.width,a.strokeStyle="transparent"===R.color&&L instanceof CanvasGradient?L:R.color,a.lineJoin="round";for(F=0;F<h.length;F++){P=m+F*d;a.strokeText(h[F],y,P)}}}a.fillStyle=L;for(F=0;F<h.length;F++){P=m+F*d;a.fillText(h[F],y,P)}a.restore(),this.textLayerInstance&&this.stageInstance&&this.stageInstance.draw()},parseStroke:function(t){if(!t)return null;var e=t.match(/(-?[\d.]+(?:px|em)?)\s+(#[0-9a-fA-F]+|rgba?\([^)]+\)|transparent)/i);return e?{width:parseFloat(e[1]),color:e[2]}:null},bindTextEvents:function(){var t=this;if(this.textLayerInstance){var e=this.editor.baseImageWidth||500,a=this.editor.baseImageHeight||500,n=this.editor.exportAreaX+e/2,s=this.editor.exportAreaY+a/2;this.textLayerInstance.on("click tap",function(e){e.cancelBubble=!0,t.editor.activeElement="text",t.textLayerInstance.draggable(!0),t.baseLayerInstance&&t.baseLayerInstance.draggable(!1),t.stageInstance.draggable(!1),t.updateTransformer()}),this.textLayerInstance.on("dragstart",function(){t.editor.isTextDragging=!0}),this.textLayerInstance.on("dragmove",function(){var i=t.textLayerInstance.x()-n,r=t.textLayerInstance.y()-s;t.editor.textPosX=50+i/e*100,t.editor.textPosY=50+r/a*100}),this.textLayerInstance.on("dragend",function(){t.editor.isTextDragging=!1,t.updateRestoreBtnState()}),this.textLayerInstance.on("transformstart",function(){t.editor.isTextDragging=!0}),this.textLayerInstance.on("transform",function(){var i=t.textLayerInstance.x()-n,r=t.textLayerInstance.y()-s;t.editor.textPosX=50+i/e*100,t.editor.textPosY=50+r/a*100,t.editor.textScale=t.textLayerInstance.scaleX()}),this.textLayerInstance.on("transformend",function(){t.editor.isTextDragging=!1,t.editor.textScale=parseFloat(t.textLayerInstance.scaleX().toFixed(2)),t.updateRestoreBtnState()})}},initKonvaStageEvents:function(){var t=this;this.stageInstance.on("mouseenter",function(){"none"===t.editor.activeElement&&t.stageInstance.draggable(!0)}),this.stageInstance.on("click tap",function(e){e.target===t.stageInstance?(t.editor.activeElement="none",t.baseLayerInstance&&t.baseLayerInstance.draggable(!1),t.textLayerInstance&&t.textLayerInstance.draggable(!1),t.stageInstance.draggable(!0),t.updateTransformer()):t.stageInstance.draggable(!1)}),this.stageInstance.on("wheel",function(e){e.evt.preventDefault();var a=t.stageInstance.scaleX(),n=t.stageInstance.getPointerPosition(),s=(n.x-t.stageInstance.x())/a,i=(n.y-t.stageInstance.y())/a,r=(e.evt.deltaY>0?-1:1)>0?1.05*a:a/1.05;r=Math.max(.1,Math.min(5,r)),t.stageInstance.scale({x:r,y:r});var o={x:n.x-s*r,y:n.y-i*r};t.stageInstance.position(o),t.stageInstance.batchDraw(),t.editor.scale=parseFloat(r.toFixed(2))})},updateKonvaBaseImage:function(){var t=this;if(this.baseLayerInstance&&this.editor.baseImage){var e=this.editor.baseImageWidth,a=this.editor.baseImageHeight,n=this.baseLayerInstance.findOne(".baseImage"),s=new Image;s.onload=function(){var i,r,o=s.width,h=s.height;if(e&&a){var d=e/o,c=a/h,g=Math.max(d,c);i=o*g,r=h*g}else i=o,r=h,t.editor.baseImageWidth=o,t.editor.baseImageHeight=h;if(n)n.image(s),n.width(i),n.height(r),n.offsetX(i/2),n.offsetY(r/2),n.x(0),n.y(0);else{var l=new Konva.Image({name:"baseImage",image:s,width:i,height:r,offsetX:i/2,offsetY:r/2,x:0,y:0});t.baseLayerInstance.add(l)}t.stageInstance.draw()},s.crossOrigin="Anonymous",s.src=this.editor.baseImage}},syncKonvaBaseImageTransform:function(){if(this.baseLayerInstance){var t=this.editor.exportAreaX+this.editor.baseImageWidth/2,e=this.editor.exportAreaY+this.editor.baseImageHeight/2;this.baseLayerInstance.x(t+this.editor.imageOffsetX),this.baseLayerInstance.y(e+this.editor.imageOffsetY),this.baseLayerInstance.scaleX(this.editor.imageScale),this.baseLayerInstance.scaleY(this.editor.imageScale),this.stageInstance.draw()}},syncKonvaTextPosition:function(){if(this.textLayerInstance&&this.stageInstance){var t=this.editor.baseImageWidth||500,e=this.editor.baseImageHeight||500,a=this.editor.exportAreaX+t/2,n=this.editor.exportAreaY+e/2,s=a+(this.editor.textPosX-50)/100*t,i=n+(this.editor.textPosY-50)/100*e;this.textLayerInstance.x(s),this.textLayerInstance.y(i),this.stageInstance.draw()}},openMaterialEditor:function(e){var a=this;t.MeeWoo.Core.MaterialOperations.openMaterialEditor(this,e);a.$nextTick(function(){if(a.editor.baseImageWidth&&a.editor.baseImageHeight)setTimeout(function(){a.initKonvaStage()},100);else var t=!1,e=a.$watch("editor.baseImage",function(n){!t&&n&&a.editor.baseImageWidth&&a.editor.baseImageHeight&&(t=!0,e(),a.$nextTick(function(){setTimeout(function(){a.initKonvaStage()},100)}))},{immediate:!0})})},loadAndSetImageDimensions:function(e){t.MeeWoo.Core.MaterialOperations.loadAndSetImageDimensions(this,e),this.$nextTick(function(){this.updateKonvaBaseImage()}.bind(this))},generateEditedMaterial:function(){var t=this;return new Promise(function(e,a){if(t.stageInstance)try{var n=t.editor.baseImageWidth,s=t.editor.baseImageHeight,i=new Konva.Stage({container:document.createElement("div"),width:n,height:s}),r=new Konva.Layer;if(i.add(r),t.baseLayerInstance&&t.editor.showImage){var o=n/2,h=s/2,d=t.baseLayerInstance.findOne(".baseImage");if(d){var c=d.image(),g=new Konva.Image({image:c,width:d.width(),height:d.height(),offsetX:d.offsetX(),offsetY:d.offsetY(),x:o+t.editor.imageOffsetX,y:h+t.editor.imageOffsetY,scaleX:t.editor.imageScale,scaleY:t.editor.imageScale});r.add(g)}}if(t.textLayerInstance&&t.editor.showText&&t.textCanvas){var l=n/2+(t.editor.textPosX-50)/100*n,f=s/2+(t.editor.textPosY-50)/100*s,x=new Konva.Image({image:t.textCanvas,x:l,y:f,offsetX:t.textCanvas.width/2,offsetY:t.textCanvas.height/2,scaleX:t.editor.textScale,scaleY:t.editor.textScale});r.add(x)}i.draw();var I=i.toDataURL({x:0,y:0,width:n,height:s,pixelRatio:1,mimeType:"image/png",quality:1});i.destroy(),e(I)}catch(t){a(t)}else a(new Error("Konva stage not initialized"))})},onPreviewAreaMouseDown:function(t){},onImageMouseDown:function(t){},onImageWheel:function(t){},toggleEditorViewMode:function(){t.MeeWoo.Core.MaterialInteractions.toggleEditorViewMode(this)},onTextMouseDown:function(t){},onTextWheel:function(t){},onEditorFileChange:function(e){t.MeeWoo.Core.MaterialInteractions.onEditorFileChange(this,e),this.$nextTick(function(){this.updateKonvaBaseImage()}.bind(this))},triggerEditorUpload:function(){t.MeeWoo.Core.MaterialInteractions.triggerEditorUpload(this)},closeMaterialEditor:function(){t.MeeWoo.Core.MaterialOperations.closeMaterialEditor(this),this.transformerInstance&&(this.transformerInstance.destroy(),this.transformerInstance=null),this.exportAreaGuide&&(this.exportAreaGuide.destroy(),this.exportAreaGuide=null),this.textLayerInstance&&(this.textLayerInstance.destroy(),this.textLayerInstance=null),this.baseLayerInstance&&(this.baseLayerInstance.destroy(),this.baseLayerInstance=null),this.konvaLayers.backgroundLayer&&(this.konvaLayers.backgroundLayer.destroy(),this.konvaLayers.backgroundLayer=null),this.konvaLayers.textLayer&&(this.konvaLayers.textLayer.destroy(),this.konvaLayers.textLayer=null),this.konvaLayers.transformerLayer&&(this.konvaLayers.transformerLayer.destroy(),this.konvaLayers.transformerLayer=null),this.stageInstance&&(this.stageInstance.destroy(),this.stageInstance=null),this.textCanvas=null,this.textCanvasCtx=null},saveMaterialEdit:function(){t.MeeWoo.Core.MaterialOperations.saveMaterialEdit(this)}}};t.MeeWoo.Mixins.MaterialEditor=e}(window);