!function(r){"use strict";r.MeeWoo=r.MeeWoo||{},r.MeeWoo.Core=r.MeeWoo.Core||{};var t={initTransformer:function(r,t){if("undefined"==typeof Konva)throw new Error("Konva library not loaded");var e=Object.assign({},{borderStroke:"#0099ff",borderStrokeWidth:1,cornerStroke:"#0099ff",cornerStrokeWidth:1,cornerRadius:5,cornerFill:"#ffffff",cornerSize:10,rotatingPointOffset:40,rotatingPointRadius:8,enabledAnchors:["top-left","top-center","top-right","middle-left","middle-right","bottom-left","bottom-center","bottom-right","rotater"],padding:5,keepRatio:!1,centeredScaling:!1,centeredRotation:!0,allowEmptySelection:!1},t),n=new Konva.Transformer({name:"element-transformer",borderStroke:e.borderStroke,borderStrokeWidth:e.borderStrokeWidth,cornerStroke:e.cornerStroke,cornerStrokeWidth:e.cornerStrokeWidth,cornerRadius:e.cornerRadius,cornerFill:e.cornerFill,cornerSize:e.cornerSize,rotatingPointOffset:e.rotatingPointOffset,rotatingPointRadius:e.rotatingPointRadius,enabledAnchors:e.enabledAnchors,padding:e.padding,keepRatio:e.keepRatio,centeredScaling:e.centeredScaling,centeredRotation:e.centeredRotation,allowEmptySelection:e.allowEmptySelection});r.layers.helperLayer&&(r.layers.helperLayer.add(n),r.layers.helperLayer.draw());var a={transformer:n,stageInstance:r,config:e,isTransforming:!1,currentElement:null,startTransformState:null,transformHistory:[]};return this.initTransformEvents(a),a},initTransformEvents:function(r){var t=r.transformer;t.on("transformstart",this.handleTransformStart.bind(this,r)),t.on("transform",this.handleTransform.bind(this,r)),t.on("transformend",this.handleTransformEnd.bind(this,r)),t.on("rotatestart",this.handleRotateStart.bind(this,r)),t.on("rotate",this.handleRotate.bind(this,r)),t.on("rotateend",this.handleRotateEnd.bind(this,r)),t.on("scalestart",this.handleScaleStart.bind(this,r)),t.on("scale",this.handleScale.bind(this,r)),t.on("scaleend",this.handleScaleEnd.bind(this,r)),t.on("dragstart",this.handleDragStart.bind(this,r)),t.on("dragmove",this.handleDragMove.bind(this,r)),t.on("dragend",this.handleDragEnd.bind(this,r))},attachTransformer:function(r,t){var e=r.transformer;Array.isArray(t)||(t=[t]),0!==(t=t.filter(function(r){return r&&r instanceof Konva.Node})).length&&(e.nodes(t),e.visible(!0),r.currentElement=t[0],e.getLayer().draw())},detachTransformer:function(r){var t=r.transformer;t.nodes([]),t.visible(!1),r.currentElement=null,t.getLayer().draw()},updateTransformerConfig:function(r,t){var e=r.transformer;Object.assign(r.config,t),e.setAttrs(t),e.getLayer().draw()},setKeepRatio:function(r,t){var e=r.transformer;e.setAttr("keepRatio",t),r.config.keepRatio=t,e.getLayer().draw()},setEnabledAnchors:function(r,t){var e=r.transformer;e.setAttr("enabledAnchors",t),r.config.enabledAnchors=t,e.getLayer().draw()},handleTransformStart:function(r,t){r.isTransforming=!0,r.startTransformState=this.saveTransformState(r.currentElement),this.triggerTransformEvent(r,"transformstart",t)},handleTransform:function(r,t){this.triggerTransformEvent(r,"transform",t)},handleTransformEnd:function(r,t){r.isTransforming=!1,this.saveTransformHistory(r),this.triggerTransformEvent(r,"transformend",t)},handleRotateStart:function(r,t){this.triggerTransformEvent(r,"rotatestart",t)},handleRotate:function(r,t){this.triggerTransformEvent(r,"rotate",t)},handleRotateEnd:function(r,t){this.triggerTransformEvent(r,"rotateend",t)},handleScaleStart:function(r,t){this.triggerTransformEvent(r,"scalestart",t)},handleScale:function(r,t){this.triggerTransformEvent(r,"scale",t)},handleScaleEnd:function(r,t){this.triggerTransformEvent(r,"scaleend",t)},handleDragStart:function(r,t){this.triggerTransformEvent(r,"dragstart",t)},handleDragMove:function(r,t){this.triggerTransformEvent(r,"dragmove",t)},handleDragEnd:function(r,t){this.triggerTransformEvent(r,"dragend",t)},triggerTransformEvent:function(r,t,e){r.stageInstance.stage.fire("transform:"+t,{transformerState:r,event:e,element:r.currentElement})},saveTransformState:function(r){return r&&r instanceof Konva.Node?{x:r.x(),y:r.y(),scaleX:r.scaleX(),scaleY:r.scaleY(),rotation:r.rotation(),skewX:r.skewX(),skewY:r.skewY(),width:r.width(),height:r.height()}:null},restoreTransformState:function(r,t){r&&r instanceof Konva.Node&&t&&(r.setAttrs({x:t.x,y:t.y,scaleX:t.scaleX,scaleY:t.scaleY,rotation:t.rotation,skewX:t.skewX,skewY:t.skewY}),r.getLayer().draw())},saveTransformHistory:function(r){if(r.currentElement){var t=this.saveTransformState(r.currentElement),e=r.startTransformState;e&&t&&(r.transformHistory.push({startState:e,endState:t,element:r.currentElement,timestamp:Date.now()}),r.transformHistory.length>100&&r.transformHistory.shift())}},getTransformer:function(r){return r.transformer},getCurrentElement:function(r){return r.currentElement},destroyTransformer:function(r){var t=r.transformer;t.off("transformstart"),t.off("transform"),t.off("transformend"),t.off("rotatestart"),t.off("rotate"),t.off("rotateend"),t.off("scalestart"),t.off("scale"),t.off("scaleend"),t.off("dragstart"),t.off("dragmove"),t.off("dragend"),t.destroy(),r.transformer=null,r.currentElement=null,r.transformHistory=[]}};r.MeeWoo.Core.KonvaTransformer=t}(window);