function handleComposeFrame(a){for(var t=a.frame.data,e=a.width,r=a.height,h="color-left-alpha-right"===a.mode,o={width:2*e,height:r,data:new Uint8ClampedArray(2*e*r*4)}.data,n=0;n<t.length;n+=4){var d=t[n+0],l=t[n+1],s=t[n+2],i=t[n+3],m=d,M=l,f=s;i>0&&i<255?(m=Math.min(255,Math.round(255*d/i)),M=Math.min(255,Math.round(255*l/i)),f=Math.min(255,Math.round(255*s/i))):0===i&&(m=0,M=0,f=0);var g=Math.floor(n/4),p=Math.floor(g/e),u=g%e,w=4*(p*e*2+u),c=4*(p*e*2+u+e);h?(o[w+0]=m,o[w+1]=M,o[w+2]=f,o[w+3]=i,o[c+0]=i,o[c+1]=i,o[c+2]=i,o[c+3]=255):(o[w+0]=i,o[w+1]=i,o[w+2]=i,o[w+3]=255,o[c+0]=m,o[c+1]=M,o[c+2]=f,o[c+3]=i)}for(var v=new Uint8ClampedArray(o.length),y=0;y<o.length;y+=4){var C=o[y+3];255===C?(v[y+0]=o[y+0],v[y+1]=o[y+1],v[y+2]=o[y+2]):0===C?(v[y+0]=0,v[y+1]=0,v[y+2]=0):(v[y+0]=Math.round(o[y+0]*C/255),v[y+1]=Math.round(o[y+1]*C/255),v[y+2]=Math.round(o[y+2]*C/255)),v[y+3]=255}self.postMessage({id:a.id,type:"result",result:{blackBgData:v,dualData:o,width:2*e,height:r}})}function handleComposeFrames(a){var t=a.data,e=t.frames,r=t.mode,h=e.length;if(0===h)throw new Error("帧数组不能为空");for(var o=[],n=e[0].width,d=e[0].height,l="color-left-alpha-right"===r,s=0;s<h;s++){for(var i=e[s].data,m={width:2*n,height:d,data:new Uint8ClampedArray(2*n*d*4)}.data,M=0;M<i.length;M+=4){var f=i[M+0],g=i[M+1],p=i[M+2],u=i[M+3],w=f,c=g,v=p;u>0&&u<255?(w=Math.min(255,Math.round(255*f/u)),c=Math.min(255,Math.round(255*g/u)),v=Math.min(255,Math.round(255*p/u))):0===u&&(w=0,c=0,v=0);var y=Math.floor(M/4),C=Math.floor(y/n),k=y%n,F=4*(C*n*2+k),U=4*(C*n*2+k+n);l?(m[F+0]=w,m[F+1]=c,m[F+2]=v,m[F+3]=u,m[U+0]=u,m[U+1]=u,m[U+2]=u,m[U+3]=255):(m[F+0]=u,m[F+1]=u,m[F+2]=u,m[F+3]=255,m[U+0]=w,m[U+1]=c,m[U+2]=v,m[U+3]=u)}for(var b=new Uint8ClampedArray(m.length),A=0;A<m.length;A+=4){var D=m[A+3];255===D?(b[A+0]=m[A+0],b[A+1]=m[A+1],b[A+2]=m[A+2]):0===D?(b[A+0]=0,b[A+1]=0,b[A+2]=0):(b[A+0]=Math.round(m[A+0]*D/255),b[A+1]=Math.round(m[A+1]*D/255),b[A+2]=Math.round(m[A+2]*D/255)),b[A+3]=255}o.push({blackBgData:b,width:2*n,height:d})}self.postMessage({id:a.id,type:"result",result:o})}self.onmessage=function(a){var t=a.data;try{switch(t.type){case"composeFrame":handleComposeFrame(t);break;case"composeFrames":handleComposeFrames(t);break;default:throw new Error("Unknown task type: "+t.type)}}catch(a){self.postMessage({id:t.id,type:"error",error:a.message})}};