class MemoryPool{constructor(){this.pools=new Map,this.maxPoolSize=50,this.minBufferSize=1024,this.maxBufferSize=52428800}getBuffer(e){if(e<=0||e>this.maxBufferSize)return new Uint8ClampedArray(e);const o=this._roundUpToPowerOfTwo(e),r=`Uint8ClampedArray_${o}`;if(this.pools.has(r)&&this.pools.get(r).length>0){return this.pools.get(r).pop()}return new Uint8ClampedArray(o)}recycleBuffer(e){if(!e||!e.buffer)return;const o=e.length;if(o<=0||o>this.maxBufferSize)return;const r=`Uint8ClampedArray_${this._roundUpToPowerOfTwo(o)}`;this.pools.has(r)||this.pools.set(r,[]);const a=this.pools.get(r);a.length<this.maxPoolSize&&(e.fill(0),a.push(e))}clear(){this.pools.forEach(e=>{e.length=0}),this.pools.clear()}_roundUpToPowerOfTwo(e){return e<=this.minBufferSize?this.minBufferSize:(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e)}}const memoryPool=new MemoryPool,BLOCK_SIZE=128,hasSIMD=!1;async function handleComposeFrame(e){try{var o=e.frame||(e.data?e.data.frame:void 0),r=e.width||(e.data?e.data.width:void 0),a=e.height||(e.data?e.data.height:void 0),t=e.mode||(e.data?e.data.mode:void 0);if(!o||!o.data)throw new Error("Missing frame data");if(!r||!a)throw new Error("Missing width or height");if(!t)throw new Error("Missing mode");console.log("Starting handleComposeFrame, frame data length:",o.data.length,"width:",r,"height:",a,"mode:",t);var s=o.data,n="color-left-alpha-right"===t,l=2*r,i=a,c=l*i*4;console.log("Dual channel image size:",l,"x",i,"data size:",c);var h=memoryPool.getBuffer(c),d=memoryPool.getBuffer(c);console.log("Memory allocated successfully");var f=[];console.log("Generating blocks...");for(var m=0;m<a;m+=128)for(var g=0;g<r;g+=128)f.push({x:g,y:m,width:Math.min(128,r-g),height:Math.min(128,a-m)});console.log("Generated",f.length,"blocks"),console.log("Starting parallel processing of blocks...");var p=0,u=f.length;await Promise.all(f.map(async o=>{await processBlock(o,s,r,a,l,h,d,n),p++;var t=Math.round(p/u*100);t%5==0&&self.postMessage({id:e.id,type:"progress",progress:t})})),console.log("Block processing completed"),console.log("Posting result back to main thread"),self.postMessage({id:e.id,type:"result",result:{blackBgData:d,dualData:h,width:l,height:i}},[d.buffer,h.buffer]),console.log("Result posted successfully")}catch(e){throw console.error("Error in handleComposeFrame:",e),e}}async function handleComposeFrames(e){try{var o=e.frames||(e.data?e.data.frames:void 0),r=e.mode||(e.data?e.data.mode:void 0);if(!o)throw new Error("Missing frames data");if(!r)throw new Error("Missing mode");var a=o.length;if(0===a)throw new Error("Empty frames array");console.log("Starting handleComposeFrames, frame count:",a,"mode:",r),console.log("First frame size:",o[0].width,"x",o[0].height);var t=[],s=o[0].width,n=o[0].height,l="color-left-alpha-right"===r,i=2*s,c=i*n*4;console.log("Dual channel image size per frame:",i,"x",n,"data size:",c);const m=20;console.log("Worker使用分批处理，每批",m,"帧");for(let r=0;r<a;r+=m){const f=Math.min(r+m,a),g=o.slice(r,f),p=g.length;console.log("Worker处理批次:",r,"-",f,"共",p,"帧");var h=g.map(async function(e,o){const t=r+o;if(console.log("Processing frame",t+1,"of",a),!e||!e.data)return console.error("Invalid frame data at index:",t),null;var h=memoryPool.getBuffer(c),d=memoryPool.getBuffer(c);console.log("Memory allocated for frame",t);for(var f=[],m=0;m<n;m+=128)for(var g=0;g<s;g+=128)f.push({x:g,y:m,width:Math.min(128,s-g),height:Math.min(128,n-m)});console.log("Generated",f.length,"blocks for frame",t);try{await Promise.all(f.map(o=>processBlock(o,e.data,s,n,i,h,d,l))),console.log("Frame",t,"processing completed")}catch(e){return console.error("Error processing frame",t,":",e),null}return{blackBgData:d,width:i,height:n}});console.log("Waiting for batch frames to complete...");try{const o=(await Promise.all(h)).filter(e=>null!==e);t.push(...o),console.log("Batch processed successfully, valid results:",o.length);const r=Math.min(f,a);var d=Math.round(r/a*100);d%5==0&&self.postMessage({id:e.id,type:"progress",progress:d}),"function"==typeof gc&&gc(),console.log("Batch completed, total results so far:",t.length)}catch(e){console.error("Error in batch processing:",e);continue}}var f=[];t.forEach(e=>{f.push(e.blackBgData.buffer)}),console.log("Extracted transferable objects, count:",f.length),console.log("Posting results back to main thread"),self.postMessage({id:e.id,type:"result",result:t},f),console.log("Results posted successfully, total frames processed:",t.length)}catch(e){throw console.error("Error in handleComposeFrames:",e),e}}function processBlock(e,o,r,a,t,s,n,l){return new Promise(function(i){var c=e.x,h=e.y,d=(e.width,e.height,1/255);try{processBlockWithoutSIMD(e,o,r,a,t,s,n,l,d),i()}catch(e){console.error("Error processing block:",e,"at position:",c,",",h),i()}})}function processBlockWithSIMD(e,o,r,a,t,s,n,l,i){}function process4PixelsWithSIMD(e,o,r,a,t,s,n,l,i,c,h,d){for(var f=[o*a+e,o*a+e+1,o*a+e+2,o*a+e+3].map(e=>4*e),m=SIMD.int32x4(r[f[0]],r[f[1]],r[f[2]],r[f[3]]),g=SIMD.int32x4(r[f[0]+1],r[f[1]+1],r[f[2]+1],r[f[3]+1]),p=SIMD.int32x4(r[f[0]+2],r[f[1]+2],r[f[2]+2],r[f[3]+2]),u=(SIMD.int32x4(r[f[0]+3],r[f[1]+3],r[f[2]+3],r[f[3]+3]),m),M=g,y=p,v=0;v<4;v++){var w=r[f[v]+3];if(w>0&&w<255){var x=255*i;u=SIMD.int32x4.replaceLane(u,v,Math.min(255,Math.round(r[f[v]]*x))),M=SIMD.int32x4.replaceLane(M,v,Math.min(255,Math.round(r[f[v]+1]*x))),y=SIMD.int32x4.replaceLane(y,v,Math.min(255,Math.round(r[f[v]+2]*x)))}else 0===w&&(u=SIMD.int32x4.replaceLane(u,v,0),M=SIMD.int32x4.replaceLane(M,v,0),y=SIMD.int32x4.replaceLane(y,v,0))}for(v=0;v<4;v++){var S=e+v,k=4*(o*a+S),B=SIMD.int32x4.extractLane(u,v),D=SIMD.int32x4.extractLane(M,v),P=SIMD.int32x4.extractLane(y,v),I=r[k+3],E=4*(o*t+S),b=4*(o*t+S+a);l?(s[E+0]=B,s[E+1]=D,s[E+2]=P,s[E+3]=I,s[b+0]=I,s[b+1]=I,s[b+2]=I,s[b+3]=255):(s[E+0]=I,s[E+1]=I,s[E+2]=I,s[E+3]=255,s[b+0]=B,s[b+1]=D,s[b+2]=P,s[b+3]=I);var C=s[E+3];if(255===C)n[E+0]=s[E+0],n[E+1]=s[E+1],n[E+2]=s[E+2];else if(0===C)n[E+0]=0,n[E+1]=0,n[E+2]=0;else{var F=C*i;n[E+0]=Math.round(s[E+0]*F),n[E+1]=Math.round(s[E+1]*F),n[E+2]=Math.round(s[E+2]*F)}n[E+3]=255;var z=s[b+3];if(255===z)n[b+0]=s[b+0],n[b+1]=s[b+1],n[b+2]=s[b+2];else if(0===z)n[b+0]=0,n[b+1]=0,n[b+2]=0;else{var L=z*i;n[b+0]=Math.round(s[b+0]*L),n[b+1]=Math.round(s[b+1]*L),n[b+2]=Math.round(s[b+2]*L)}n[b+3]=255}}function processBlockWithoutSIMD(e,o,r,a,t,s,n,l,i){for(var c=e.x,h=e.y,d=e.width,f=e.height,m=h;m<h+f;m++)for(var g=c;g<c+d;g++)try{processSinglePixel(g,m,o,r,t,s,n,l,i)}catch(e){console.error("Error processing pixel at",g,",",m,":",e)}}function processSinglePixel(e,o,r,a,t,s,n,l,i){var c=4*(o*a+e);if(c+3>=r.length)console.error("Invalid frame index:",c,"for frame data length:",r.length);else{var h=r[c+0],d=r[c+1],f=r[c+2],m=r[c+3],g=h,p=d,u=f;if(m>0){if(m<255){var M=255*i;g=Math.min(255,Math.round(h*M)),p=Math.min(255,Math.round(d*M)),u=Math.min(255,Math.round(f*M))}}else g=0,p=0,u=0;var y=4*(o*t+e),v=4*(o*t+e+a);if(y+3>=s.length||v+3>=s.length)console.error("Invalid dual data index:",y,"or",v,"for dual data length:",s.length);else{l?(s[y+0]=g,s[y+1]=p,s[y+2]=u,s[y+3]=m,s[v+0]=m,s[v+1]=m,s[v+2]=m,s[v+3]=255):(s[y+0]=m,s[y+1]=m,s[y+2]=m,s[y+3]=255,s[v+0]=g,s[v+1]=p,s[v+2]=u,s[v+3]=m);var w=s[y+3];if(255===w)n[y+0]=s[y+0],n[y+1]=s[y+1],n[y+2]=s[y+2];else if(0===w)n[y+0]=0,n[y+1]=0,n[y+2]=0;else{var x=w*i;n[y+0]=Math.round(s[y+0]*x),n[y+1]=Math.round(s[y+1]*x),n[y+2]=Math.round(s[y+2]*x)}n[y+3]=255;var S=s[v+3];if(255===S)n[v+0]=s[v+0],n[v+1]=s[v+1],n[v+2]=s[v+2];else if(0===S)n[v+0]=0,n[v+1]=0,n[v+2]=0;else{var k=S*i;n[v+0]=Math.round(s[v+0]*k),n[v+1]=Math.round(s[v+1]*k),n[v+2]=Math.round(s[v+2]*k)}n[v+3]=255}}}self.onmessage=function(e){var o=e.data;console.log("Worker received task:",o.type,"Task ID:",o.id);try{if(!o||!o.id||!o.type)throw new Error("Invalid task structure: missing id or type");switch(o.type){case"composeFrame":console.log("Processing composeFrame task"),handleComposeFrame(o).catch(function(e){console.error("Error in handleComposeFrame:",e),self.postMessage({id:o.id,type:"error",error:e.message})});break;case"composeFrames":console.log("Processing composeFrames task"),handleComposeFrames(o).catch(function(e){console.error("Error in handleComposeFrames:",e),self.postMessage({id:o.id,type:"error",error:e.message})});break;case"clearMemory":console.log("Clearing memory pool"),memoryPool.clear(),self.postMessage({id:o.id,type:"success"});break;default:throw new Error("Unknown task type: "+o.type)}}catch(e){console.error("Error in message handler:",e),self.postMessage({id:o?o.id:null,type:"error",error:e.message})}};