console.log("[DualChannelWorker] Â∑≤Âä†ËΩΩ"),self.onerror=function(r,e,o,t,a){return console.error("üü° [DualChannelWorker] ÂÖ®Â±ÄÈîôËØØ:",{message:r,source:e,lineno:o,colno:t,error:a?a.stack:"no stack"}),!0};class MemoryPool{constructor(){this.pools=new Map,this.maxPoolSize=50,this.minBufferSize=1024,this.maxBufferSize=52428800}getBuffer(r){if(r<=0||r>this.maxBufferSize)return new Uint8ClampedArray(r);const e=this._roundUpToPowerOfTwo(r),o=`Uint8ClampedArray_${e}`;if(this.pools.has(o)&&this.pools.get(o).length>0){return this.pools.get(o).pop()}return new Uint8ClampedArray(e)}recycleBuffer(r){if(!r||!r.buffer)return;const e=r.length;if(e<=0||e>this.maxBufferSize)return;const o=`Uint8ClampedArray_${this._roundUpToPowerOfTwo(e)}`;this.pools.has(o)||this.pools.set(o,[]);const t=this.pools.get(o);t.length<this.maxPoolSize&&(r.fill(0),t.push(r))}clear(){this.pools.forEach(r=>{r.length=0}),this.pools.clear()}_roundUpToPowerOfTwo(r){return r<=this.minBufferSize?this.minBufferSize:(r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,++r)}}const memoryPool=new MemoryPool,BLOCK_SIZE=128,hasSIMD=!1;async function handleComposeFrame(r){try{var e=r.data||r,o=e.frame,t=e.width,a=e.height,s=e.mode;if(!o||!o.data)throw new Error("Missing frame data");if(!t||!a)throw new Error("Missing width or height");if(!s)throw new Error("Missing mode");for(var i=o.data,n="color-left-alpha-right"===s,l=2*t,h=a,f=l*h*4,c=memoryPool.getBuffer(f),u=memoryPool.getBuffer(f),d=[],p=0;p<a;p+=128)for(var m=0;m<t;m+=128)d.push({x:m,y:p,width:Math.min(128,t-m),height:Math.min(128,a-p)});var g=0,y=d.length;await Promise.all(d.map(async e=>{await processBlock(e,i,t,a,l,c,u,n),g++;var o=Math.round(g/y*100);o%5==0&&self.postMessage({id:r.id,type:"progress",progress:o})})),self.postMessage({id:r.id,type:"result",result:{blackBgData:u.subarray(0,f),dualData:c.subarray(0,f),width:l,height:h}})}catch(r){throw r}}async function handleComposeFrames(r){try{var e=r.data||r,o=e.frames,t=e.mode;if(!o||!Array.isArray(o))throw new Error("Invalid frames data");if(!t)throw new Error("Missing mode");var a=o.length;if(0===a)throw new Error("Empty frames array");var s=o[0].width||e.width,i=o[0].height||e.height;if(!s||!i)throw new Error("Cannot determine frame dimensions");console.log("[Worker] Â§ÑÁêÜ",a,"Â∏ß,",s,"x",i);var n=[],l="color-left-alpha-right"===t,h=2*s,f=h*i*4;const d=20;for(let e=0;e<a;e+=d){const t=Math.min(e+d,a);var c=o.slice(e,t).map(async function(r,e){if(!r||!r.data||!ArrayBuffer.isView(r.data))return null;if(r.data.length!==s*i*4)return null;for(var o=memoryPool.getBuffer(f),t=memoryPool.getBuffer(f),a=[],n=0;n<i;n+=128)for(var c=0;c<s;c+=128)a.push({x:c,y:n,width:Math.min(128,s-c),height:Math.min(128,i-n)});try{await Promise.all(a.map(e=>processBlock(e,r.data,s,i,h,o,t,l)))}catch(r){return null}return{blackBgData:t.subarray(0,f),width:h,height:i}});try{const e=(await Promise.all(c)).filter(r=>null!==r);n.push(...e);var u=Math.round(t/a*100);u%10==0&&self.postMessage({id:r.id,type:"progress",progress:u})}catch(r){continue}}console.log("[Worker] ÂÆåÊàê, ËæìÂá∫",n.length,"Â∏ß"),self.postMessage({id:r.id,type:"result",result:n})}catch(r){throw r}}function processBlock(r,e,o,t,a,s,i,n){return new Promise(function(l){var h=r.x,f=r.y,c=(r.width,r.height,1/255);try{processBlockWithoutSIMD(r,e,o,t,a,s,i,n,c),l()}catch(r){console.error("Error processing block:",r,"at position:",h,",",f),l()}})}function processBlockWithSIMD(r,e,o,t,a,s,i,n,l){processBlockWithoutSIMD(r,e,o,t,a,s,i,n,l)}function processBlockWithoutSIMD(r,e,o,t,a,s,i,n,l){for(var h=r.x,f=r.y,c=r.width,u=r.height,d=f;d<f+u;d++)for(var p=h;p<h+c;p++)try{processSinglePixel(p,d,e,o,a,s,i,n,l)}catch(r){console.error("Error processing pixel at",p,",",d,":",r)}}function processSinglePixel(r,e,o,t,a,s,i,n,l){var h=4*(e*t+r);if(h+3>=o.length)console.error("Invalid frame index:",h,"for frame data length:",o.length);else{var f=o[h+0],c=o[h+1],u=o[h+2],d=o[h+3],p=f,m=c,g=u;if(d>0){if(d<255){var y=255/d;p=Math.min(255,Math.round(f*y)),m=Math.min(255,Math.round(c*y)),g=Math.min(255,Math.round(u*y))}}else p=0,m=0,g=0;var w=4*(e*a+r),M=4*(e*a+r+t);if(w+3>=s.length||M+3>=s.length)console.error("Invalid dual data index:",w,"or",M,"for dual data length:",s.length);else{n?(s[w+0]=p,s[w+1]=m,s[w+2]=g,s[w+3]=d,s[M+0]=d,s[M+1]=d,s[M+2]=d,s[M+3]=255):(s[w+0]=d,s[w+1]=d,s[w+2]=d,s[w+3]=255,s[M+0]=p,s[M+1]=m,s[M+2]=g,s[M+3]=d);var v=s[w+3];if(255===v)i[w+0]=s[w+0],i[w+1]=s[w+1],i[w+2]=s[w+2];else if(0===v)i[w+0]=0,i[w+1]=0,i[w+2]=0;else{var B=v*l;i[w+0]=Math.round(s[w+0]*B),i[w+1]=Math.round(s[w+1]*B),i[w+2]=Math.round(s[w+2]*B)}i[w+3]=255;var k=s[M+3];if(255===k)i[M+0]=s[M+0],i[M+1]=s[M+1],i[M+2]=s[M+2];else if(0===k)i[M+0]=0,i[M+1]=0,i[M+2]=0;else{var P=k*l;i[M+0]=Math.round(s[M+0]*P),i[M+1]=Math.round(s[M+1]*P),i[M+2]=Math.round(s[M+2]*P)}i[M+3]=255}}}self.onmessage=function(r){var e=r.data;try{if(!e||!e.id||!e.type)return void self.postMessage({id:e?e.id:null,type:"error",error:"Invalid task structure"});switch(e.type){case"composeFrame":handleComposeFrame(e).catch(function(r){self.postMessage({id:e.id,type:"error",error:r.message})});break;case"composeFrames":handleComposeFrames(e).catch(function(r){self.postMessage({id:e.id,type:"error",error:r.message})});break;case"clearMemory":memoryPool.clear(),self.postMessage({id:e.id,type:"success"});break;default:self.postMessage({id:e.id,type:"error",error:"Unknown task type: "+e.type})}}catch(r){self.postMessage({id:e?e.id:null,type:"error",error:r.message})}};