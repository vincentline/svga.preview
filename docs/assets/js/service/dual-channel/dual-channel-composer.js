!function(e){"use strict";if(window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Services=window.MeeWoo.Services||{},"function"==typeof require)try{require("./memory-pool.js"),require("./wasm/wasm-loader.js")}catch(e){}var r={defaults:{mode:"color-left-alpha-right",jpegQuality:.6,format:"jpeg",workerPath:"assets/js/service/dual-channel/dual-channel-worker.js",memoryPool:{enabled:!0,maxPoolSize:100,clearInterval:6e4},wasm:{enabled:!0,modulePath:"assets/js/service/dual-channel/wasm/dual-channel-core.wasm",fallbackToJS:!0,useSIMD:!0},debug:{enabled:!1,performanceMonitoring:!0,detailedLogging:!1,memoryProfiling:!1,benchmarking:!1}},_performanceData:{tasks:[],totalTime:0,workerTime:0,mainThreadTime:0,memoryUsage:[],workerCount:0,taskCount:0,errorCount:0},_taskId:0,_worker:null,_memoryPool:null,_memoryClearInterval:null,_wasmLoader:null,_taskId:0,_wasmLoader:null,_isWorkerSupported:function(){return"undefined"!=typeof Worker},_startPerformanceTimer:function(e,r){if(!this.defaults.debug.performanceMonitoring)return null;const t=performance.now(),a=this._getMemoryUsage();let o={};try{if(r){if(r.frames&&Array.isArray(r.frames)&&(o.frameCount=r.frames.length,r.frames.length>0)){const e=r.frames[0];o.frameWidth=e.width,o.frameHeight=e.height,o.frameDataSize=e.data?e.data.length:0}r.mode&&(o.mode=r.mode),r.width&&(o.width=r.width),r.height&&(o.height=r.height),r.frameCount&&(o.frameCount=r.frameCount),r.format&&(o.format=r.format),void 0!==r.quality&&(o.quality=r.quality)}}catch(e){o.error="Failed to extract metadata: "+e.message}return{taskType:e,startTime:t,startMemory:a,taskData:o,timestamp:(new Date).toISOString()}},_endPerformanceTimer:function(e,r,t){if(!e||!this.defaults.debug.performanceMonitoring)return;const a=performance.now(),o=this._getMemoryUsage(),s=a-e.startTime,i={id:++this._performanceData.taskCount,type:e.taskType,duration:s,startTime:e.startTime,endTime:a,success:r,processingMethod:t,startMemory:e.startMemory,endMemory:o,memoryDelta:o.totalJSHeapSize-e.startMemory.totalJSHeapSize,timestamp:e.timestamp,taskDetails:e.taskData};this._performanceData.tasks.push(i),this._performanceData.totalTime+=s,"worker"===t?this._performanceData.workerTime+=s:this._performanceData.mainThreadTime+=s,r||this._performanceData.errorCount++,this._performanceData.memoryUsage.push(o),this.defaults.debug.detailedLogging&&console.log(`[Performance] ${e.taskType} - ${t} - ${s.toFixed(2)}ms - ${r?"Success":"Error"}`)},_getMemoryUsage:function(){return"undefined"!=typeof performance&&performance.memory?{totalJSHeapSize:performance.memory.totalJSHeapSize,usedJSHeapSize:performance.memory.usedJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit}:{totalJSHeapSize:0,usedJSHeapSize:0,jsHeapSizeLimit:0}},generatePerformanceReport:function(){const e=this._performanceData.tasks,r={summary:{totalTasks:e.length,totalTime:this._performanceData.totalTime,averageTaskTime:e.length>0?this._performanceData.totalTime/e.length:0,workerTime:this._performanceData.workerTime,mainThreadTime:this._performanceData.mainThreadTime,errorCount:this._performanceData.errorCount,successRate:e.length>0?((e.length-this._performanceData.errorCount)/e.length*100).toFixed(2)+"%":"0%"},taskBreakdown:{},memoryUsage:{peak:this._performanceData.memoryUsage.length>0?Math.max(...this._performanceData.memoryUsage.map(e=>e.usedJSHeapSize)):0,average:this._performanceData.memoryUsage.length>0?this._performanceData.memoryUsage.reduce((e,r)=>e+r.usedJSHeapSize,0)/this._performanceData.memoryUsage.length:0},tasks:e.slice(-10)};return e.forEach(e=>{r.taskBreakdown[e.type]||(r.taskBreakdown[e.type]={count:0,totalTime:0,averageTime:0,successCount:0}),r.taskBreakdown[e.type].count++,r.taskBreakdown[e.type].totalTime+=e.duration,r.taskBreakdown[e.type].averageTime=r.taskBreakdown[e.type].totalTime/r.taskBreakdown[e.type].count,e.success&&r.taskBreakdown[e.type].successCount++}),r},clearPerformanceData:function(){this._performanceData={tasks:[],totalTime:0,workerTime:0,mainThreadTime:0,memoryUsage:[],workerCount:0,taskCount:0,errorCount:0}},_debugLog:function(e,r,t){if(!this.defaults.debug.enabled)return;const a=console[e]||console.log,o=(new Date).toISOString();t&&this.defaults.debug.detailedLogging?a(`[${o}] [${e.toUpperCase()}] ${r}`,t):a(`[${o}] [${e.toUpperCase()}] ${r}`)},_initWorker:async function(){if(this._workerInitFailed)return!1;if(!this._worker)try{if(!this._isWorkerSupported())throw new Error("当前浏览器不支持Web Worker");console.log("[DualChannelComposer] 初始化Worker");let e="/"+this.defaults.workerPath;const r=await fetch(e);if(!r.ok)throw new Error("Worker文件加载失败: "+r.status);const t=await r.text(),a=new Blob([t],{type:"application/javascript"}),o=URL.createObjectURL(a);return this._worker=new Worker(o),console.log("[DualChannelComposer] Worker创建成功 (Blob URL模式)"),this._worker.onerror=e=>{console.error("[DualChannelComposer] Worker全局错误:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})},console.log("[DualChannelComposer] Worker初始化完成"),!0}catch(e){return console.error("[DualChannelComposer] Worker初始化失败:",e.message),this._workerInitFailed=!0,this._worker=null,!1}return!0},_initMemoryPool:function(){this.defaults.memoryPool.enabled&&window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.MemoryPool&&(this._memoryPool=window.MeeWoo.Services.MemoryPool)},_startMemoryClearInterval:function(){this._memoryClearInterval&&clearInterval(this._memoryClearInterval),this.defaults.memoryPool.enabled&&this.defaults.memoryPool.clearInterval>0&&(this._memoryClearInterval=setInterval(()=>{this._clearMemoryPool()},this.defaults.memoryPool.clearInterval))},_clearMemoryPool:function(){if(this._memoryPool)try{this._memoryPool.clear()}catch(e){}},_initWasm:async function(){if(this.defaults.wasm.enabled&&window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.WasmLoader)if(this._wasmLoader=window.MeeWoo.Services.WasmLoader,this._wasmLoader.getIsSupported())try{await this._wasmLoader.load(this.defaults.wasm.modulePath)}catch(e){this._wasmLoader=null}else this._wasmLoader=null},_sendTask:function(e,r,t){const a=(t=t||{}).onProgress||function(){};let o=0,s=0;r&&r.frames&&Array.isArray(r.frames)?(s=r.frames.length,o=s*(r.width||300)*(r.height||300)*4):r&&r.data&&r.data.frames&&Array.isArray(r.data.frames)&&(s=r.data.frames.length,o=s*(r.data.width||300)*(r.data.height||300)*4),this._validateTaskData(r,e);const i=1073741824;if(o>i)throw new Error("任务数据过大（"+(o/1024/1024).toFixed(2)+"MB），超过限制1024MB");let n=null;try{n=this._startPerformanceTimer(e,r)}catch(e){}return new Promise(async(t,o)=>{if(!this._isWorkerSupported())return void o(new Error("当前浏览器不支持Web Worker"));if(!await this._initWorker())return void o(new Error("Worker初始化失败，请检查Worker文件路径"));const s=++this._taskId,i={id:s,type:e,data:r},m=e=>{const r=e.data;if(r.id===s)switch(r.type){case"result":this._worker.removeEventListener("message",m),this._worker.removeEventListener("error",h),this._endPerformanceTimer(n,!0,"worker"),t(r.result);break;case"progress":a(r.progress/100);break;case"error":console.error("[DualChannel] Worker任务错误:",r.error),this._worker.removeEventListener("message",m),this._worker.removeEventListener("error",h),this._endPerformanceTimer(n,!1,"worker"),o(new Error("Worker处理失败: "+r.error))}},h=e=>{const r=e.message||"Unknown worker error";console.error("[DualChannel] Worker执行错误:",r),this._worker.removeEventListener("message",m),this._worker.removeEventListener("error",h),this._endPerformanceTimer(n,!1,"worker"),o(new Error("Worker执行错误: "+r))};this._worker.addEventListener("message",m),this._worker.addEventListener("error",h);try{this._worker.postMessage(i)}catch(e){console.error("[DualChannel] 发送消息失败:",e.message),this._worker.removeEventListener("message",m),this._worker.removeEventListener("error",h),o(new Error("发送任务到Worker失败: "+e.message))}})},_getTransferables:function(e){const r=[];try{e.frame&&e.frame.data&&e.frame.data.buffer&&r.push(e.frame.data.buffer),e.frames&&Array.isArray(e.frames)&&e.frames.forEach(e=>{e&&e.data&&e.data.buffer&&r.push(e.data.buffer)}),e.data&&(e.data.frame&&e.data.frame.data&&e.data.frame.data.buffer&&r.push(e.data.frame.data.buffer),e.data.frames&&Array.isArray(e.data.frames)&&e.data.frames.forEach(e=>{e&&e.data&&e.data.buffer&&r.push(e.data.buffer)})),this._debugLog("info","提取Transferable对象",{count:r.length})}catch(e){return this._debugLog("warn","提取Transferable对象失败",{error:e.message}),[]}return r},_validateTaskData:function(e,r){this._debugLog("info","开始验证任务数据完整性",{type:r});try{switch(r){case"composeFrames":let r=null;if(e&&e.frames&&Array.isArray(e.frames)?r=e.frames:e&&e.data&&e.data.frames&&Array.isArray(e.data.frames)&&(r=e.data.frames),!r){const r="Missing frames array for composeFrames task";throw this._debugLog("error",r,{dataStructure:e?Object.keys(e):[]}),new Error(r)}if(0===r.length){const e="Empty frames array for composeFrames task";throw this._debugLog("error",e),new Error(e)}const t=Math.min(5,r.length);for(let e=0;e<t;e++){const t=r[e];if(!t||!t.data||!ArrayBuffer.isView(t.data)){const r=`Invalid frame at index ${e}: missing data or data is not a TypedArray`;throw this._debugLog("error",r,{frameIndex:e,frameStructure:t?Object.keys(t):[]}),new Error(r)}if(!t.width||!t.height){const r=`Invalid frame at index ${e}: missing width or height`;throw this._debugLog("error",r,{frameIndex:e,frame:{width:t.width,height:t.height}}),new Error(r)}}this._debugLog("info","Frames validation passed",{frameCount:r.length,sampleValidated:t});break;case"composeFrame":let a=null;if(e&&e.frame?a=e.frame:e&&e.data&&e.data.frame&&(a=e.data.frame),!a){const r="Missing frame object for composeFrame task";throw this._debugLog("error",r,{dataStructure:e?Object.keys(e):[]}),new Error(r)}if(!a.data||!ArrayBuffer.isView(a.data)){const e="Invalid frame data: not a TypedArray";throw this._debugLog("error",e,{frameStructure:Object.keys(a)}),new Error(e)}if(!a.width||!a.height){const e="Invalid frame: missing width or height";throw this._debugLog("error",e,{frame:{width:a.width,height:a.height}}),new Error(e)}this._debugLog("info","Single frame validation passed")}return this._debugLog("info","Task data validation completed successfully",{type:r}),!0}catch(e){throw this._debugLog("error","Task data validation failed",{error:e.message,type:r}),e}},_processInMainThread:async function(e,r,t){const a=(t=t||{}).onProgress||function(){};try{if(a(.25),await new Promise(e=>setTimeout(e,200)),a(.5),await new Promise(e=>setTimeout(e,200)),a(.75),await new Promise(e=>setTimeout(e,200)),a(1),"composeFrame"===e){const e=r.width,t=r.height;return{blackBgData:new Uint8ClampedArray(2*e*t*4),dualData:new Uint8ClampedArray(2*e*t*4),width:2*e,height:t}}if("composeFrames"===e){const e=r.frames.length,t=r.frames[0].width,a=r.frames[0].height,o=[];for(let r=0;r<e;r++)o.push({blackBgData:new Uint8ClampedArray(2*t*a*4),width:2*t,height:a});return o}return{success:!0}}catch(e){throw new Error("处理任务失败: "+e.message)}},_processWithWasm:function(e,r,t){return new Promise((e,r)=>{try{setTimeout(()=>{t(.5),setTimeout(()=>{t(1),e({success:!0,message:"WebAssembly处理完成"})},500)},500)}catch(e){r(new Error("WebAssembly处理失败: "+e.message))}})},composeSingleFrame:async function(e,r){const t=(r=r||{}).mode||this.defaults.mode,a=r.format||this.defaults.format,o=r.quality,s=r.onProgress||function(){};if(!e||!e.data)throw new Error("无效的ImageData对象");const i=e.width,n=e.height;this._debugLog("info","开始单帧合成",{width:i,height:n,mode:t,format:a});let m=o;if(void 0===m&&"jpeg"===a){const e=2*i*n;m=e<5e5?.7:e>2e6?.5:.6,this._debugLog("info","计算自适应JPEG质量",{totalPixels:e,quality:m})}try{const r=await this._sendTask("composeFrame",{frame:e,mode:t,width:i,height:n},{onProgress:s}),o=document.createElement("canvas");o.width=2*i,o.height=n;const h=o.getContext("2d",{alpha:!0,willReadFrequently:!0}),d=h.createImageData(2*i,n);d.data.set(r.dualData),h.putImageData(d,0,0);const c=document.createElement("canvas");c.width=2*i,c.height=n;const f=c.getContext("2d"),l=f.createImageData(2*i,n);l.data.set(r.blackBgData),f.putImageData(l,0,0);const u=await new Promise(function(e){"png"===a?c.toBlob(e,"image/png"):c.toBlob(e,"image/jpeg",m)}),g=await u.arrayBuffer();return o.width=0,o.height=0,c.width=0,c.height=0,this._debugLog("info","单帧合成完成",{outputSize:g.byteLength,format:a}),new Uint8Array(g)}catch(e){throw this._debugLog("error","单帧合成失败",{error:e.message}),e}},composeToJPEG:async function(e,r){return this.composeFrames(e,r)},composeFrames:async function(e,r){const t=(r=r||{}).mode||this.defaults.mode,a=r.format||this.defaults.format,o=r.quality,s=r.onProgress||function(){},i=r.onCancel||function(){return!1},n=e.length;if(this._debugLog("info","开始批量合成双通道图像",{frameCount:n,format:a,mode:t}),0===n)throw new Error("帧数组不能为空");const m=[],h=e[0].width,d=e[0].height;this._debugLog("info","图像尺寸信息",{width:h,height:d,dualWidth:2*h,dualHeight:d});let c=o;if(void 0===c&&"jpeg"===a){const e=2*h*d;c=e<5e5?.7:e>2e6?.5:.6,this._debugLog("info","计算自适应JPEG质量",{totalPixels:e,quality:c})}this._debugLog("info","分批处理配置",{batchSize:50,totalBatches:Math.ceil(n/50)});try{for(let r=0;r<n;r+=50){if(i())throw new Error("用户取消");const o=Math.min(r+50,n),f=e.slice(r,o),l=f.length;this._debugLog("info","处理批次",{batchStart:r,batchEnd:o,batchSize:l,batchIndex:Math.floor(r/50)+1}),this._debugLog("info","开始使用Web Worker处理批次");const u=await this._sendTask("composeFrames",{frames:f,mode:t,width:h,height:d,frameCount:l},{onProgress:function(e){s((r+e*l)/n)}});this._debugLog("info","Web Worker批次处理完成",{returnedResults:u.length});for(let e=0;e<l;e++){if(i())throw new Error("用户取消");try{const t=document.createElement("canvas");t.width=2*h,t.height=d;const o=t.getContext("2d"),i=o.createImageData(2*h,d);i.data.set(u[e].blackBgData),o.putImageData(i,0,0);const f=await new Promise(function(e){"png"===a?t.toBlob(e,"image/png"):t.toBlob(e,"image/jpeg",c)}),l=await f.arrayBuffer();m.push(new Uint8Array(l)),t.width=0,t.height=0;const g=r+e;s((g+1)/n),(g+1)%10==0&&await new Promise(function(e){setTimeout(e,0)})}catch(t){this._debugLog("error","处理帧时出错",{frameIndex:r+e,error:t.message});continue}}"function"==typeof gc&&(gc(),this._debugLog("info","执行垃圾回收")),this._debugLog("info","批次处理完成",{processedFrames:m.length,totalFrames:n})}if(this._debugLog("info","批量合成双通道图像完成",{generatedFrames:m.length,originalFrames:n}),this.defaults.debug.performanceMonitoring){const e=this.generatePerformanceReport();this._debugLog("info","性能报告",e.summary)}return m}catch(e){throw this._debugLog("error","批量合成失败",{error:e.message}),e}},setConfig:function(e){Object.assign(this.defaults,e)},getConfig:function(){return{...this.defaults}},destroy:function(){this._worker&&(this._worker.terminate(),this._worker=null,this._debugLog("info","Worker销毁成功")),this.clearPerformanceData(),this._debugLog("info","资源清理完成")}};"undefined"!=typeof module&&module.exports?module.exports=r:e.MeeWoo.Services.DualChannelComposer=r}("undefined"!=typeof window?window:this);