!function(e){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Services=window.MeeWoo.Services||{};var t={defaults:{mode:"color-left-alpha-right",jpegQuality:.6,format:"jpeg",workerPath:"assets/js/service/dual-channel/dual-channel-worker.js"},_worker:null,_taskId:0,_initWorker:function(){this._worker||(this._worker=new Worker(this.defaults.workerPath))},_sendTask:function(e,t){return new Promise((a,o)=>{this._initWorker();const n=++this._taskId,r={id:n,type:e,data:t},i=e=>{e.data.id===n&&(this._worker.removeEventListener("message",i),"error"===e.data.type?o(new Error(e.data.error)):a(e.data.result))};this._worker.addEventListener("message",i),this._worker.postMessage(r)})},composeSingleFrame:async function(e,t){const a=(t=t||{}).mode||this.defaults.mode,o=t.format||this.defaults.format,n=t.quality;if(!e||!e.data)throw new Error("无效的ImageData对象");const r=e.width,i=e.height;let s=n;if(void 0===s&&"jpeg"===o){const e=2*r*i;s=e<5e5?.7:e>2e6?.5:.6}const d=await this._sendTask("composeFrame",{frame:e,mode:a,width:r,height:i}),h=document.createElement("canvas");h.width=2*r,h.height=i;const c=h.getContext("2d",{alpha:!0,willReadFrequently:!0}),m=c.createImageData(2*r,i);m.data.set(d.dualData),c.putImageData(m,0,0);const u=document.createElement("canvas");u.width=2*r,u.height=i;const w=u.getContext("2d"),l=w.createImageData(2*r,i);l.data.set(d.blackBgData),w.putImageData(l,0,0);const f=await new Promise(function(e){"png"===o?u.toBlob(e,"image/png"):u.toBlob(e,"image/jpeg",s)}),g=await f.arrayBuffer();return h.width=0,h.height=0,u.width=0,u.height=0,new Uint8Array(g)},composeToJPEG:async function(e,t){return this.composeFrames(e,t)},composeFrames:async function(e,t){const a=(t=t||{}).mode||this.defaults.mode,o=t.format||this.defaults.format,n=t.quality,r=t.onProgress||function(){},i=t.onCancel||function(){return!1},s=e.length;if(0===s)throw new Error("帧数组不能为空");const d=[],h=e[0].width,c=e[0].height;let m=n;if(void 0===m&&"jpeg"===o){const e=2*h*c;m=e<5e5?.7:e>2e6?.5:.6}const u=await this._sendTask("composeFrames",{frames:e,mode:a,width:h,height:c,frameCount:s});for(let e=0;e<s;e++){if(i())throw new Error("用户取消");const t=document.createElement("canvas");t.width=2*h,t.height=c;const a=t.getContext("2d"),n=a.createImageData(2*h,c);n.data.set(u[e].blackBgData),a.putImageData(n,0,0);const w=await new Promise(function(e){"png"===o?t.toBlob(e,"image/png"):t.toBlob(e,"image/jpeg",m)}),l=await w.arrayBuffer();d.push(new Uint8Array(l)),t.width=0,t.height=0,r((e+1)/s),e%5==0&&await new Promise(function(e){setTimeout(e,0)})}return d},setConfig:function(e){Object.assign(this.defaults,e)},getConfig:function(){return{...this.defaults}},destroy:function(){this._worker&&(this._worker.terminate(),this._worker=null)}};"undefined"!=typeof module&&module.exports?module.exports=t:e.MeeWoo.Services.DualChannelComposer=t}("undefined"!=typeof window?window:this);