!function(){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};var e=null,t=!1,o={initWebPXMux:async function(){if(e&&t)return e;if("undefined"==typeof WebPXMux){var o=window.MeeWoo.Core.libraryLoader;if(o&&await o.load(["webpxmux"],!0),"undefined"==typeof WebPXMux)throw new Error("WebPXMux 库加载失败")}return e=WebPXMux("assets/js/lib/webpxmux/webpxmux.wasm"),await e.waitRuntime(),t=!0,console.log("[WebP导出] webpxmux 初始化完成"),e},imageDataToRGBA:function(e){for(var t=e.data,o=e.width*e.height,r=new Uint32Array(o),a=0;a<o;a++){var n=t[4*a],i=t[4*a+1],w=t[4*a+2],u=t[4*a+3];r[a]=n<<24|i<<16|w<<8|u}return r},export:async function(e){var t=this;if(!e.getFrame)throw new Error("缺少 getFrame 回调");if(!e.totalFrames||e.totalFrames<=0)throw new Error("帧数无效");var o=e.width||300,r=e.height||300,a=e.fps||30,n=e.totalFrames,i=e.onProgress||function(){},w=e.onError||function(){},u=e.shouldCancel||function(){return!1};try{i(0,"init","初始化编码器...");var d=await this.initWebPXMux();if(u())throw new Error("导出已取消");var l=document.createElement("canvas");l.width=o,l.height=r;var h=l.getContext("2d",{willReadFrequently:!0,alpha:!0});i(.05,"capturing","捕获帧数据...");for(var c=[],s=Math.round(1e3/a),f=0;f<n;f++){if(u())throw new Error("导出已取消");var m=await e.getFrame(f);if(m){h.clearRect(0,0,o,r),h.drawImage(m,0,0,o,r);var g=h.getImageData(0,0,o,r),b=t.imageDataToRGBA(g);c.push({duration:s,isKeyframe:0===f,rgba:b}),i(.05+f/n*.55,"capturing","捕获帧 "+(f+1)+"/"+n)}else console.warn("[WebP导出] 帧 "+f+" 获取失败，跳过")}if(0===c.length)throw new Error("没有捕获到任何帧");console.log("[WebP导出] 捕获完成，共 "+c.length+" 帧"),i(.6,"encoding","编码WebP动画...");var p={frameCount:c.length,width:o,height:r,loopCount:0,bgColor:0,frames:c};if(u())throw new Error("导出已取消");i(.7,"encoding","正在编码...");var x=await d.encodeFrames(p);if(!x||0===x.length)throw new Error("webpxmux编码失败，未生成输出数据");i(.9,"downloading","生成下载文件...");var v=new Blob([x],{type:"image/webp"});return console.log("[WebP导出] 输出文件大小:",t.formatBytes(v.size)),t.download(v,"animation.webp"),i(1,"completed","导出完成"),v}catch(e){throw console.error("[WebP导出] 导出失败:",e),w(e),e}},download:function(e,t){var o=URL.createObjectURL(e),r=document.createElement("a");r.href=o,r.download=t||"animation.webp",document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(function(){URL.revokeObjectURL(o)},100)},estimate:function(e){var t=e.width||300,o=e.height||300,r=e.fps||30,a=e.duration||0,n=Math.ceil(a*r),i=t*o*.05*n;return{totalFrames:n,totalBytes:i,fileSizeText:this.formatBytes(i)}},formatBytes:function(e){if(0===e)return"0 B";var t=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,t)).toFixed(2)+" "+["B","KB","MB","GB"][t]}};window.MeeWoo.Exporters.WebPExporter=o}(window);