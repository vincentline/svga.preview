!function(){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const e={export:async function(e){if(!e.getFrame)throw new Error("缺少 getFrame 回调");var r=e.width||300,t=e.height||300,o=(e.fps,e.onProgress||function(){}),n=e.onError||function(){},a=e.shouldCancel||function(){return!1};try{o(0,"capturing","捕获帧数据...");var i=document.createElement("canvas");i.width=r,i.height=t;for(var w=i.getContext("2d",{willReadFrequently:!0,alpha:!0}),c=null,h=0;!c&&h<3;){h++;try{(c=await e.getFrame(0))||(console.warn("[WebP导出] 第"+h+"次尝试获取帧数据失败，重试..."),await new Promise(e=>setTimeout(e,200)))}catch(e){console.warn("[WebP导出] 第"+h+"次尝试获取帧数据出错:",e),await new Promise(e=>setTimeout(e,200))}}if(!c)throw new Error("无法获取帧数据");if(0===c.width||0===c.height)throw new Error("获取的帧画布尺寸无效");if(console.log("[WebP导出] 获取到帧数据:",{width:c.width,height:c.height,type:c.constructor.name}),a())throw new Error("导出已取消");o(.3,"converting","转换为WebP格式..."),w.clearRect(0,0,r,t),w.drawImage(c,0,0,r,t);var d=i.toDataURL("image/webp",.9);o(.8,"downloading","生成下载文件...");var s=document.createElement("a");return s.href=d,s.download="export.webp",document.body.appendChild(s),s.click(),document.body.removeChild(s),o(1,"completed","导出完成"),d}catch(e){throw n(e),e}},captureFrames:async function(e){var r=e.width||300,t=e.height||300,o=e.fps||30,n=e.duration||1,a=Math.ceil(n*o),i=[],w=e.seekToFrame,c=e.getCurrentFrameCanvas,h=e.onProgress||function(){},d=e.shouldCancel||function(){return!1};if(!w||!c)throw new Error("缺少必要的帧操作方法");for(var s=0;s<a;s++){if(d())throw new Error("导出已取消");var u=Math.floor(s/o*o);await w(u,o);var l=c();if(!l)throw new Error("无法获取帧画布");var m=document.createElement("canvas");m.width=r,m.height=t,m.getContext("2d").drawImage(l,0,0,r,t);var g=new Image;g.src=m.toDataURL("image/png"),await new Promise(function(e){g.onload=e}),i.push(g),h(s/a*.3,"capturing","捕获帧数据...")}return i}};window.MeeWoo.Exporters.WebPExporter=e}(window);