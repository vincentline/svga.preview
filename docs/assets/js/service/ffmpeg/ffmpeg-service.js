!function(e){"use strict";function t(){this.ffmpeg=null,this.isLoaded=!1,this.isLoading=!1,this.loadError=null,this.isBusy=!1,this._eventListeners={},this._instanceId=Math.random().toString(36).substr(2,9)}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},t.prototype={_getBestCorePath:async function(){var e=["https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js","https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js"];try{var t=e.map(function(e){return fetch(e,{method:"HEAD",mode:"cors"}).then(function(t){if(t.ok)return e;throw new Error("Network response was not ok")}).catch(function(){return new Promise(function(){})})});return await Promise.any(t)}catch(t){return console.warn("CDN测速失败，使用默认Core Path"),e[0]}},_emit:function(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(function(e){try{e(t)}catch(e){console.error("事件处理函数执行错误:",e)}})},init:async function(t){var i=(t=t||{}).onProgress||function(){},r=t.highPriority||!1,n=void 0!==t.log&&t.log;if(!this.isLoaded||!this.ffmpeg){if(this.isLoading){for(;this.isLoading;)await new Promise(function(e){setTimeout(e,100)});if(this.isLoaded)return;if(this.loadError)throw new Error(this.loadError)}this.isLoading=!0,this.loadError=null,this._emit("loading",{stage:"start",progress:0});try{this._checkSharedArrayBuffer(),"undefined"!=typeof FFmpeg&&void 0!==FFmpeg.createFFmpeg||(i({stage:"loading-library",progress:.1,message:"正在加载FFmpeg库..."}),this._emit("loading",{stage:"loading-library",progress:.1,message:"正在加载FFmpeg库..."}),e.MeeWoo.Core.libraryLoader?await e.MeeWoo.Core.libraryLoader.load(["ffmpeg"],r):await this._loadFFmpegLibrary());var s=t.corePath;s||(i({stage:"checking-cdn",progress:.2,message:"正在优选最佳线路..."}),this._emit("loading",{stage:"checking-cdn",progress:.2,message:"正在优选最佳线路..."}),s=await this._getBestCorePath(),console.log("Selected FFmpeg Core Path:",s)),i({stage:"creating-instance",progress:.3,message:"正在创建FFmpeg实例..."}),this._emit("loading",{stage:"creating-instance",progress:.3,message:"正在创建FFmpeg实例..."}),this.ffmpeg=FFmpeg.createFFmpeg({log:n,corePath:s,progress:function(e){}}),i({stage:"loading-core",progress:.5,message:"正在加载编码器（约25MB，首次加载较慢）..."}),this._emit("loading",{stage:"loading-core",progress:.5,message:"正在加载编码器（约25MB，首次加载较慢）..."}),await this.ffmpeg.load(),i({stage:"done",progress:1,message:"FFmpeg加载完成"}),this._emit("loading",{stage:"done",progress:1,message:"FFmpeg加载完成"}),this.isLoaded=!0,this._emit("loaded",{instanceId:this._instanceId})}catch(e){throw this.loadError=e.message,console.error("FFmpeg加载失败:",e),this._emit("error",{error:e,stage:"loading"}),new Error("加载FFmpeg失败："+e.message)}finally{this.isLoading=!1}}},_checkSharedArrayBuffer:function(){if("undefined"==typeof SharedArrayBuffer){if("serviceWorker"in navigator){var t='SharedArrayBuffer 未启用，需要刷新页面。\n\nService Worker 已就绪，但需要刷新页面才能启用跨域隔离。\n点击"确定"将自动刷新页面。';throw confirm(t)&&e.location.reload(),new Error("需要刷新页面启用 SharedArrayBuffer")}t="您的浏览器不支持 Service Worker，无法启用 SharedArrayBuffer。\n\n请使用现代浏览器（Chrome 67+、Firefox 79+、Safari 15.2+）。";throw alert(t),new Error(t)}},_loadFFmpegLibrary:async function(){var e=function(e){return new Promise(function(t,i){var r=setTimeout(function(){i(new Error("加载超时(30s): "+e))},3e4),n=document.createElement("script");n.src=e,n.onload=function(){clearTimeout(r),t()},n.onerror=function(){clearTimeout(r),i(new Error("加载失败: "+e))},document.head.appendChild(n)})};try{await e("https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js")}catch(t){console.warn("FFmpeg主线路加载失败，尝试备用线路:",t.message),await e("https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js")}if("undefined"==typeof FFmpeg||void 0===FFmpeg.createFFmpeg)throw new Error("FFmpeg库加载成功但对象未找到")},extractAudio:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,i=e.totalFrames,r=e.fps,n=e.speedRatio||1,s=e.onProgress||function(){},a=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});try{var o=this.ffmpeg,u="input_audio.mp4",c="audio.mp3";if(s(.1),a())throw new Error("用户取消");var h=await t.arrayBuffer();o.FS("writeFile",u,new Uint8Array(h)),s(.2);var f=["-i",u,"-vn","-acodec","libmp3lame","-q:a","2"];if(Math.abs(n-1)>.01){var p=this.buildAudioTempoFilter(n);f.push("-af",p)}if(f.push("-y",c),s(.3),a())throw new Error("用户取消");await o.run.apply(o,f),s(.9);var l=o.FS("readFile",c);if(this._cleanupFiles([u,c]),s(1),!l||0===l.length)return null;var m=0;return r>0&&(m=Math.round(i/r*1e3)),Number.isFinite(m)||(m=0),[{audioKey:"audio_0",audioData:new Uint8Array(l.buffer||l),startFrame:0,endFrame:i,startTime:0,totalTime:m}]}catch(e){if(this._cleanupFiles(["input_audio.mp4","audio.mp3"]),"用户取消"===e.message)throw this._emit("cancelled",{task:"extractAudio"}),e;return console.error("音频提取失败:",e),this._emit("error",{error:e,task:"extractAudio"}),null}finally{this.isBusy=!1,this._emit("busy",{status:!1})}},buildAudioTempoFilter:function(e){if(e<.2?(console.warn("音频变速比例 "+e+" 过小，强制限制为 0.2"),e=.2):e>12&&(console.warn("音频变速比例 "+e+" 过大，强制限制为 12.0"),e=12),e>=.5&&e<=2)return"atempo="+e.toFixed(4);var t=[];console.log("音频变速比例 "+e.toFixed(4)+" 超出 0.5-2.0 范围，正在构建链式滤镜");for(var i=e;i>2;)t.push("atempo=2.0"),i/=2;for(;i<.5;)t.push("atempo=0.5"),i/=.5;return Math.abs(i-1)>.01&&t.push("atempo="+i.toFixed(4)),t.join(",")},extractAudioWithSpeedRemap:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,i=e.keyframes,r=e.totalFrames,n=parseFloat(e.fps)||30;n<=0&&(n=30);var s=e.originalTotalFrames,a=e.originalFps||n;(!a||a<=0)&&(a=30);var o=e.onProgress||function(){},u=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});try{var c=this.ffmpeg,h="input_video.mp4",f=await t.arrayBuffer();if(c.FS("writeFile",h,new Uint8Array(f)),o(.1),u())throw new Error("用户取消");var p=s/a,l=r/n;Number.isFinite(l)||(l=0),console.log("多段变速音频 - 原始:",p.toFixed(2)+"s","目标:",l.toFixed(2)+"s");for(var m=[],d=0;d<i.length-1;d++){var g=i[d],F=i[d+1],y=g.originalFrame/s*p,w=F.originalFrame/s*p-y;if(!(w<=0)){var v=g.position*l,_=w/(F.position*l-v);m.push({startTime:y,duration:w,speedRatio:_,index:d})}}if(0===m.length)return console.log("无有效音频段"),c.FS("unlink",h),null;if(o(.2),u())throw new Error("用户取消");var b=[],S=m.filter(e=>{var t=Math.max(0,Math.min(e.startTime,p));return Math.min(e.duration,p-t)>0});if(0===S.length)return console.warn("无有效音频段(调整后)"),c.FS("unlink",h),null;var E=.6/S.length;for(d=0;d<m.length;d++){var I=m[d],A=Math.max(0,Math.min(I.startTime,p)),B=Math.min(I.duration,p-A);if(B<=0)console.warn("段"+d+"调整后持续时间为0，跳过");else{var k="segment_"+d+".wav",x=["-ss",A.toFixed(3),"-t",B.toFixed(3),"-i",h,"-vn","-acodec","pcm_s16le","-ar","44100","-ac","1"];if(Math.abs(I.speedRatio-1)>.01){var L=this.buildAudioTempoFilter(I.speedRatio);x.push("-af",L)}if(x.push("-y",k),await c.run.apply(c,x),b.push(k),o(.2+b.length*E),u()){for(var M=[],T=0;T<=d;T++)M.push("segment_"+T+".wav");throw this._cleanupFiles(M),new Error("用户取消")}}}var P="output_audio.mp3";if(1===b.length)await c.run("-i",b[0],"-acodec","libmp3lame","-ar","44100","-ac","1","-b:a","128k","-y",P),this._cleanupFiles([b[0]]);else{var C=b.map(function(e){return"file '"+e+"'"}).join("\n");c.FS("writeFile","concat_list.txt",(new TextEncoder).encode(C)),await c.run("-f","concat","-safe","0","-i","concat_list.txt","-acodec","libmp3lame","-ar","44100","-ac","1","-b:a","128k","-y",P),b.push("concat_list.txt"),this._cleanupFiles(b)}if(o(.9),u())throw new Error("用户取消");var W=c.FS("readFile",P),j=new Blob([W.buffer],{type:"audio/mpeg"}),U=await j.arrayBuffer(),R=Array.from(new Uint8Array(U)),V=0;n>0&&(V=Math.round(r/n*1e3)),Number.isFinite(V)||(V=0);var q=[{audioKey:"audio.mp3",startFrame:0,endFrame:r,startTime:0,totalTime:V,audioData:R}];return this._cleanupFiles([h,P]),o(1),q}catch(e){if(console.error("多段变速音频提取失败:",e),this._cleanupFiles(["input_video.mp4","output_audio.mp3"]),"用户取消"===e.message)throw this._emit("cancelled",{task:"extractAudioWithSpeedRemap"}),e;return this._emit("error",{error:e,task:"extractAudioWithSpeedRemap"}),null}finally{this.isBusy=!1,this._emit("busy",{status:!1})}},convertVideoFormat:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.inputFile,i=e.maxWidth||1280,r=e.onProgress||function(){},n=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var s=this.ffmpeg,a="input.mp4",o="output.mp4";try{if(r(.1),n())throw new Error("用户取消");var u=await t.arrayBuffer();s.FS("writeFile",a,new Uint8Array(u)),r(.2);if(s.setProgress(function(e){r(.2+.7*e.ratio)}),n())throw new Error("用户取消");var c="scale='min("+i+",iw)':-2";if(await s.run("-i",a,"-vf",c,"-c:v","libx264","-profile:v","baseline","-level","3.0","-crf","28","-preset","ultrafast","-c:a","aac","-b:a","96k","-max_muxing_queue_size","1024",o),r(.95),n())throw new Error("用户取消");var h=s.FS("readFile",o),f=new Blob([h.buffer],{type:"video/mp4"});return this._cleanupFiles([a,o]),r(1),f}catch(e){if(this._cleanupFiles([a,o]),"用户取消"===e.message)throw this._emit("cancelled",{task:"convertVideoFormat"}),e;throw this._emit("error",{error:e,task:"convertVideoFormat"}),e}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},convertFramesToMp4:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.frames,i=e.fps||30,r=e.inputFps||i,n=e.quality||80,s=e.audioData,a=e.audioSpeedRatio||1,o=e.onProgress||function(){},u=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var c=this.ffmpeg,h=t.length,f="output.mp4",p="audio.mp3";try{for(var l=0;l<h;l++){if(u())throw new Error("用户取消");var m="frame_"+String(l).padStart(6,"0")+".jpg",d=t[l];d instanceof Blob&&(d=new Uint8Array(await d.arrayBuffer())),d instanceof Uint8Array||(d=new Uint8Array(d)),c.FS("writeFile",m,d),l%5==0&&o(l/h*.4)}var g=!1;if(s&&s.length>0){var F=s;s instanceof Uint8Array||(F=new Uint8Array(s)),c.FS("writeFile",p,F),g=!0}o(.45);var y=Math.round(51-n/100*33),w=["-thread_queue_size","512","-framerate",String(r),"-i","frame_%06d.jpg"];if(g&&(w.push("-thread_queue_size","512"),w.push("-vn","-i",p)),w.push("-c:v","libx264","-preset","fast","-tune","animation","-profile:v","high","-level","4.0","-pix_fmt","yuv420p","-crf",String(y),"-movflags","+faststart","-r",String(i)),g){if(w.push("-c:a","aac","-b:a","128k"),Math.abs(a-1)>.01){var v=this.buildAudioTempoFilter(a);w.push("-af",v)}w.push("-shortest")}w.push("-y",f);if(c.setProgress(function(e){var t=0;void 0!==e.ratio?t=e.ratio:e.time&&e.duration&&(t=e.time/e.duration),o(.45+.5*t)}),u())throw new Error("用户取消");await c.run.apply(c,w),o(.95);var _=c.FS("readFile",f),b=new Blob([_.buffer],{type:"video/mp4"}),S=[f];g&&S.push(p);for(l=0;l<h;l++)S.push("frame_"+String(l).padStart(6,"0")+".jpg");return this._cleanupFiles(S),o(1),b}catch(e){var E=[f,p];for(l=0;l<h;l++)E.push("frame_"+String(l).padStart(6,"0")+".jpg");if(this._cleanupFiles(E),"用户取消"===e.message)throw this._emit("cancelled",{task:"convertFramesToMp4"}),e;throw this._emit("error",{error:e,task:"convertFramesToMp4"}),e}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},runCommand:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.args||[],i=e.inputFiles||[],r=e.outputFiles||[],n=e.onProgress||function(){};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var s=this.ffmpeg,a=[];try{for(var o=0;o<i.length;o++){var u=i[o];u.name&&u.data&&(s.FS("writeFile",u.name,new Uint8Array(u.data)),a.push(u.name))}s.setProgress(function(e){void 0!==e.ratio&&n(e.ratio)}),await s.run.apply(s,t);var c={};for(o=0;o<r.length;o++){var h=r[o];try{var f=s.FS("readFile",h);c[h]=f,a.push(h)}catch(e){console.warn("无法读取输出文件:",h,e)}}return this._cleanupFiles(a),c}catch(e){throw this._cleanupFiles(a),this._emit("error",{error:e,task:"runCommand"}),e}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},_cleanupFiles:function(e){if(this.ffmpeg){var t=this.ffmpeg;e.forEach(function(e){try{t.FS("unlink",e)}catch(e){}})}},getVersion:function(){return this.isLoaded?"FFmpeg 0.11.6 (ffmpeg-core 0.11.0)":"未加载"},reset:function(){if(this.ffmpeg)try{this._cleanupFiles(["input_audio.mp4","audio.mp3","input_video.mp4","output_audio.mp3","input.mp4","output.mp4","output.mp4","audio.mp3","concat_list.txt"])}catch(e){}this.ffmpeg=null,this.isLoaded=!1,this.isLoading=!1,this.loadError=null,this.isBusy=!1,this._emit("reset",{})},destroy:function(){this.reset(),this._eventListeners={},this._emit("destroy",{instanceId:this._instanceId})},on:function(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)},off:function(e,t){this._eventListeners[e]&&(this._eventListeners[e]=this._eventListeners[e].filter(function(e){return e!==t}))},getInstanceId:function(){return this._instanceId}};var i={_instance:null,_instances:[],getInstance:function(){return this._instance||(this._instance=new t,this._instances.push(this._instance)),this._instance},createInstance:function(){var e=new t;return this._instances.push(e),e},destroyInstance:function(e){e&&(e.destroy(),this._instances=this._instances.filter(function(t){return t.getInstanceId()!==e.getInstanceId()}),this._instance===e&&(this._instance=null))},destroyAllInstances:function(){this._instances.forEach(function(e){e.destroy()}),this._instances=[],this._instance=null},getAllInstances:function(){return[...this._instances]},init:function(){return this.getInstance().init.apply(this.getInstance(),arguments)},extractAudio:function(){return this.getInstance().extractAudio.apply(this.getInstance(),arguments)},extractAudioWithSpeedRemap:function(){return this.getInstance().extractAudioWithSpeedRemap.apply(this.getInstance(),arguments)},convertVideoFormat:function(){return this.getInstance().convertVideoFormat.apply(this.getInstance(),arguments)},convertFramesToMp4:function(){return this.getInstance().convertFramesToMp4.apply(this.getInstance(),arguments)},runCommand:function(){return this.getInstance().runCommand.apply(this.getInstance(),arguments)},getVersion:function(){return this.getInstance().getVersion.apply(this.getInstance(),arguments)},reset:function(){return this.getInstance().reset.apply(this.getInstance(),arguments)},destroy:function(){return this.getInstance().destroy.apply(this.getInstance(),arguments)},on:function(){return this.getInstance().on.apply(this.getInstance(),arguments)},off:function(){return this.getInstance().off.apply(this.getInstance(),arguments)},buildAudioTempoFilter:function(){return this.getInstance().buildAudioTempoFilter.apply(this.getInstance(),arguments)}};e.MeeWoo.Services.FFmpegService=i}(window);