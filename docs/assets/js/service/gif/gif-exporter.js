!function(r){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const e={encoder:null,export:async function(r){if(!r.getFrame)throw new Error("缺少 getFrame 回调");if(!r.totalFrames||r.totalFrames<=0)throw new Error("帧数无效");if("undefined"==typeof GIF){if(!(window.MeeWoo&&window.MeeWoo.Core&&window.MeeWoo.Core.libraryLoader))throw new Error("库加载器不可用");try{await window.MeeWoo.Core.libraryLoader.load("gif",!0)}catch(r){throw new Error("GIF.js库加载失败: "+r.message)}}var e=r.width||300,o=r.height||300,t=r.fps||30,n=r.totalFrames,a=Math.round(1e3/t),i=r.transparent||!1,s=r.dither||!1,f=r.ditherColor||"#ffffff",c=31-Math.max(1,Math.min(30,r.quality||10)),l=r.onProgress||function(){},d=r.onComplete||function(){},w=r.onError||function(){},h=r.shouldCancel||function(){return!1},u=document.createElement("canvas");u.width=e,u.height=o;var g=u.getContext("2d",{willReadFrequently:!0,alpha:!0});if("undefined"==typeof Worker){console.warn("浏览器不支持Web Worker，将使用单线程编码，可能会较慢");var p={workers:0,quality:Math.min(c,15),width:e,height:o,repeat:0,background:"#ffffff"}}else{var m=navigator.hardwareConcurrency||2,E=Math.max(1,Math.min(Math.floor(m/2),4));console.log("[GIF Exporter] 检测到",m,"个CPU核心，将使用",E,"个Worker");var F,I=[];if(k.on("workerCreated",function(r){I.push(r),console.log("[GIF Exporter] Worker创建，当前Worker数量:",I.length)}),"undefined"!=typeof window&&window.location){var b=window.location.origin+window.location.pathname;b=b.substring(0,b.lastIndexOf("/")+1),F=b+"src/assets/js/service/gif/gif.worker.js"}else F="src/assets/js/service/gif/gif.worker.js";try{fetch(F,{method:"HEAD"}).catch(function(){console.warn("Worker脚本路径可能不正确:",F)})}catch(r){console.warn("无法验证Worker脚本路径:",r)}p={workers:E,workerScript:F,quality:Math.min(c,20),width:e,height:o,repeat:0,background:"#ffffff"}}i?p.transparent=0:("transparent"===(M=r.backgroundColor||"#ffffff")&&(M="#ffffff"),p.background=M);var k=new GIF(p),v=new Promise(function(r,e){console.log("[GIF Exporter] 注册事件监听器..."),k.on("progress",function(r){console.log("[GIF Exporter] 编码进度:",r),l(50+Math.floor(50*r),"encoding","编码中...")}),k.on("finished",function(o){console.log("[GIF Exporter] 编码完成，blob:",o),o&&"object"==typeof o&&o.size?r(o):e(new Error("GIF编码器生成的blob无效"))}),k.on("abort",function(){console.log("[GIF Exporter] 编码被取消"),e(new Error("用户取消"))}),k.on("error",function(r){console.error("[GIF Exporter] 编码错误:",r),r.message&&(r.message.includes("Worker")||r.message.includes("worker"))?(console.warn("[GIF Exporter] Worker相关错误，建议禁用Worker重试"),e(new Error("Worker相关错误: "+(r.message||r)+"，请尝试禁用Worker重试"))):e(new Error("GIF编码失败: "+(r.message||r)))})});try{for(var x=0;x<n;x++){if(h())throw k.abort(),new Error("用户取消");var M,G=await r.getFrame(x);if(!G)throw new Error("无法获取帧 "+x);if(g.clearRect(0,0,e,o),!i)"transparent"===(M=r.backgroundColor||"#ffffff")&&(M="#ffffff"),g.fillStyle=M,g.fillRect(0,0,e,o);g.globalCompositeOperation="source-over",g.drawImage(G,0,0,e,o),i&&(s&&f?this._processDither(g,e,o,f):this._processAlphaThreshold(g,e,o));var y=g.getImageData(0,0,e,o);if(!y||!y.data||0===y.data.length)throw new Error("处理后的图像数据无效");var W={delay:a};i&&(W.transparent=!0),k.addFrame(y,W);var C=Math.floor(x/n*50);l(C,"capturing","捕获帧 "+(x+1)+"/"+n)}l(50,"encoding","编码中...");try{console.log("[GIF Exporter] 开始编码..."),console.log("[GIF Exporter] GIF实例:",k),console.log("[GIF Exporter] GIF选项:",k.options),console.log("[GIF Exporter] 帧数:",k.frames.length),k.render(),console.log("[GIF Exporter] 编码启动成功")}catch(r){throw console.error("[GIF Exporter] 编码启动失败:",r),new Error("编码启动失败: "+r.message)}var j=new Promise(function(r){setTimeout(function(){r(new Error("GIF编码超时，可能是由于GIF.js库问题或文件过大导致"))},12e4)}),D=await Promise.race([v,j]);if(!D||"object"!=typeof D||!D.size)throw new Error("生成的GIF blob无效");return d(D,D.size),D}catch(r){throw w(r),r}},_processDither:function(r,e,o,t){for(var n=r.getImageData(0,0,e,o),a=n.data,i=t.replace("#",""),s=parseInt(i.substr(0,2),16),f=parseInt(i.substr(2,2),16),c=parseInt(i.substr(4,2),16),l=0;l<a.length;l+=4){var d=a[l+3]/255;d>0&&d<1&&(a[l]=Math.round(a[l]*d+s*(1-d)),a[l+1]=Math.round(a[l+1]*d+f*(1-d)),a[l+2]=Math.round(a[l+2]*d+c*(1-d)),a[l+3]=255)}r.putImageData(n,0,0)},_processAlphaThreshold:function(r,e,o){for(var t=r.getImageData(0,0,e,o),n=t.data,a=0;a<n.length;a+=4){var i=n[a+3];i>0&&i<255&&(n[a+3]=i<128?0:255)}r.putImageData(t,0,0)},download:function(r,e){var o=URL.createObjectURL(r),t=document.createElement("a");t.href=o,t.download=e||"animation.gif",document.body.appendChild(t),t.click(),document.body.removeChild(t),setTimeout(function(){URL.revokeObjectURL(o)},100)},estimate:function(r){var e=r.width||100,o=r.height||100,t=r.fps||30,n=r.duration||0,a=Math.ceil(n*t),i=r.transparent||!1,s=r.dither||!1,f=i?.16:.13;i&&s&&(f=.18);var c=e*o*f*a,l="？";return a>0&&(l=c>=1048576?(c/1024/1024).toFixed(2)+"M":Math.round(c/1024)+"kb"),{frames:a,duration:n,fileSize:l,fileSizeBytes:c}},formatBytes:function(r){return r>=1048576?(r/1024/1024).toFixed(2)+" MB":r>=1024?(r/1024).toFixed(1)+" KB":r+" B"}};r.MeeWoo.Exporters.GifExporter=e}("undefined"!=typeof window?window:this);