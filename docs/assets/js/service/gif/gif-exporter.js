!function(e){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const r={encoder:null,export:async function(e){if(!e.getFrame)throw new Error("缺少 getFrame 回调");if(!e.totalFrames||e.totalFrames<=0)throw new Error("帧数无效");var r=e.width||300,t=e.height||300,o=e.fps||30,n=e.totalFrames,a=Math.round(1e3/o),i=e.transparent||!1,f=e.dither||!1,s=e.ditherColor||"#ffffff",c=31-Math.max(1,Math.min(15,e.quality||15));console.log("[GIF Exporter] Export parameters:",{width:r,height:t,fps:o,totalFrames:n,transparent:i});var d=e.onProgress||function(){},h=e.onComplete||function(){},u=e.onError||function(){},l=e.shouldCancel||function(){return!1},w=document.createElement("canvas");w.width=r,w.height=t;var p=w.getContext("2d",{willReadFrequently:!0,alpha:!0}),g={workers:1,workerScript:window.location.origin+"/assets/js/service/gif/gif.worker.js",quality:c,width:r,height:t,repeat:0,background:"#ffffff"};i?g.transparent=0:("transparent"===(F=e.backgroundColor||"#ffffff")&&(F="#ffffff"),g.background=F);var m=new GIF(g),b=new Promise(function(e,r){m.on("progress",function(e){d(50+Math.floor(50*e),"encoding","编码中...")}),m.on("finished",function(t){t&&"object"==typeof t&&t.size?e(t):r(new Error("GIF编码器生成的blob无效"))}),m.on("abort",function(){r(new Error("用户取消"))}),m.on("error",function(e){r(new Error("GIF编码失败: "+(e.message||e)))})});try{for(var v=0;v<n;v++){if(l())throw m.abort(),new Error("用户取消");var F,E=await e.getFrame(v);if(!E)throw new Error("无法获取帧 "+v);if(p.clearRect(0,0,r,t),!i)"transparent"===(F=e.backgroundColor||"#ffffff")&&(F="#ffffff"),p.fillStyle=F,p.fillRect(0,0,r,t);p.globalCompositeOperation="source-over",p.drawImage(E,0,0,r,t),i&&(f&&s?this._processDither(p,r,t,s):this._processAlphaThreshold(p,r,t));var M=p.getImageData(0,0,r,t),I={delay:a};i&&(I.transparent=!0),m.addFrame(M,I);var y=Math.floor(v/n*50);d(y,"capturing","捕获帧 "+(v+1)+"/"+n)}d(50,"encoding","编码中...");Date.now();try{m.render()}catch(e){throw e}var x=new Promise(function(e){setTimeout(function(){e(new Error("GIF编码超时，可能是由于GIF.js库问题或文件过大导致"))},6e4)}),k=await Promise.race([b,x]);if(!k||"object"!=typeof k||!k.size)throw new Error("生成的GIF blob无效");return h(k,k.size),k}catch(e){throw u(e),e}},_processDither:function(e,r,t,o){for(var n=e.getImageData(0,0,r,t),a=n.data,i=o.replace("#",""),f=parseInt(i.substr(0,2),16),s=parseInt(i.substr(2,2),16),c=parseInt(i.substr(4,2),16),d=0;d<a.length;d+=4){var h=a[d+3]/255;h>0&&h<1&&(a[d]=Math.round(a[d]*h+f*(1-h)),a[d+1]=Math.round(a[d+1]*h+s*(1-h)),a[d+2]=Math.round(a[d+2]*h+c*(1-h)),a[d+3]=255)}e.putImageData(n,0,0)},_processAlphaThreshold:function(e,r,t){for(var o=e.getImageData(0,0,r,t),n=o.data,a=0;a<n.length;a+=4){var i=n[a+3];i>0&&i<255&&(n[a+3]=i<128?0:255)}e.putImageData(o,0,0)},download:function(e,r){var t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download=r||"animation.gif",document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(function(){URL.revokeObjectURL(t)},100)},estimate:function(e){var r=e.width||100,t=e.height||100,o=e.fps||30,n=e.duration||0,a=Math.ceil(n*o),i=e.transparent||!1,f=e.dither||!1,s=i?.16:.13;i&&f&&(s=.18);var c=r*t*s*a,d="？";return a>0&&(d=c>=1048576?(c/1024/1024).toFixed(2)+"M":Math.round(c/1024)+"kb"),{frames:a,duration:n,fileSize:d,fileSizeBytes:c}},formatBytes:function(e){return e>=1048576?(e/1024/1024).toFixed(2)+" MB":e>=1024?(e/1024).toFixed(1)+" KB":e+" B"}};e.MeeWoo.Exporters.GifExporter=r}("undefined"!=typeof window?window:this);