!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{};var r="yyeffectmp4json";function t(){}t.prototype={constructor:t,parse:function(e){var r=this;return new Promise(function(t,n){var a=new FileReader;a.onload=function(e){try{var n=new Uint8Array(e.target.result),a=r._parseBuffer(n);t(a||null)}catch(e){console.warn("YYEVA 解析失败:",e),t(null)}},a.onerror=function(){t(null)},a.readAsArrayBuffer(e)})},parseFromArrayBuffer:function(e){try{var r=new Uint8Array(e);return this._parseBuffer(r)}catch(e){return console.warn("YYEVA 解析失败:",e),null}},_parseBuffer:function(e){var r=this._findMarker(e);if(-1===r)return null;var t=this._extractBase64Data(e,r);if(!t)return null;var n=this._base64Decode(t);if(!n)return null;var a=this._zlibDecompress(n);if(!a)return null;var o=new TextDecoder("utf-8").decode(a),f=JSON.parse(o);return f.descript&&1===f.descript.isEffect?{descript:f.descript,effect:f.effect||{},datas:f.datas||[]}:null},_findMarker:function(e){for(var t=(new TextEncoder).encode(r),n=0;n<=e.length-t.length;n++){for(var a=!0,o=0;o<t.length;o++)if(e[n+o]!==t[o]){a=!1;break}if(a)return n}return-1},_extractBase64Data:function(e,r){for(var t=r+15,n=Math.min(e.length-t,5e4),a="",o=t;o<t+n;o++)a+=String.fromCharCode(e[o]);var f=a.match(/\[\[([A-Za-z0-9+/=]+)\]\]/);return f&&f[1]?f[1]:null},_base64Decode:function(e){try{for(var r=atob(e),t=new Uint8Array(r.length),n=0;n<r.length;n++)t[n]=r.charCodeAt(n);return t}catch(e){return console.warn("Base64 解码失败:",e),null}},_zlibDecompress:function(e){if("undefined"!=typeof pako&&pako.inflate)try{return pako.inflate(e)}catch(e){console.warn("pako zlib 解压失败:",e)}return"undefined"!=typeof DecompressionStream?this._decompressWithStream(e):(console.warn("未找到 zlib 解压库 (pako)，请确保已加载"),null)},_decompressWithStream:async function(e){try{var r=new DecompressionStream("deflate"),t=r.writable.getWriter();t.write(e),t.close();for(var n=r.readable.getReader(),a=[],o=0;;){var f=await n.read(),i=f.done,c=f.value;if(i)break;a.push(c),o+=c.length}for(var u=new Uint8Array(o),s=0,l=0;l<a.length;l++)u.set(a[l],s),s+=a[l].length;return u}catch(e){return console.warn("DecompressionStream 解压失败:",e),null}},getEffectByTag:function(e,r){if(!e||!e.effect)return null;for(var t in e.effect)if(e.effect[t].effectTag===r)return{key:t,config:e.effect[t]};return null},getFrameData:function(e,r){if(!e||!e.datas)return null;for(var t=0;t<e.datas.length;t++)if(e.datas[t].frameIndex===r)return e.datas[t].data;return null},getTotalFrames:function(e){return e&&e.datas&&0!==e.datas.length?e.datas[e.datas.length-1].frameIndex+1:0}},e.MeeWoo.Services.YyevaParser=t}(window);