!function(e){"use strict";function t(){this.effectConfig={},this.imageCache={}}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},t.prototype={constructor:t,renderEffects:function(e,t,a,f){if(a&&a.datas){var r=a.datas,i=a.effect,n=this._findFrameData(r,t);if(n)for(var o=0;o<n.length;o++){var c=n[o],h=c.effectId,g=null;for(var s in i)if(i[s].effectId==h){g=i[s];break}if(g||(g=i[h]||i[String(h)]),!g){var l=c.outputFrame||c.renderFrame;if(!l)continue;var m=l[2]/l[3],d=[];for(var s in i)d.push(i[s]);for(var u=m>=1.5?"txt":"img",v=0;v<d.length;v++)if(d[v].effectType===u){g=d[v];break}if(!g&&d.length>0&&(g=d[0]),!g)continue}if("txt"===g.effectType)this._renderText(e,g,c,this.effectConfig[g.effectTag]||{});else if("img"===g.effectType){var C=this.effectConfig[g.effectTag]||{};C.imageSource&&this._renderImage(e,g,c,C,f)}}}},_findFrameData:function(e,t){for(var a=0;a<e.length;a++)if(e[a].frameIndex===t)return e[a].data;return null},_renderText:function(e,t,a,f){var r=a.renderFrame||a.outputFrame,i=r[0],n=r[1],o=r[2],c=r[3],h=f&&f.text?f.text:t.effectTag||"",g=f&&f.fontSize||t.fontSize||36,s=f&&f.fontColor||t.fontColor||"#ffffff",l=f&&f.textAlign||t.textAlign||"center";e.save(),e.beginPath(),e.rect(i,n,o,c),e.clip(),e.font=g+"px "+(t.fontFamily||"Arial, sans-serif"),e.fillStyle=s,e.textAlign=l,e.textBaseline="middle";var m=n+c/2;e.fillText(h,i+o/2,m),e.restore()},_renderImage:function(e,t,a,f,r){var i=a.renderFrame,n=a.outputFrame;if(i){var o=i[0],c=i[1],h=i[2],g=i[3],s=f&&f.imageSource;if(null!=s){var l="_yyevaImg_"+t.effectTag,m=this.imageCache[l];if(m||((m=new Image).src=s,this.imageCache[l]=m),m.complete&&m.naturalWidth>0){e.save(),e.beginPath(),e.rect(o,c,h,g),e.clip();var d="scaleFill";n&&r&&r.ctx?this._renderImageWithMask(e,m,o,c,h,g,d,n,r):this._drawImageToCanvas(e,m,o,c,h,g,d),e.restore()}}}},_renderImageWithMask:function(e,t,a,f,r,i,n,o,c){var h=Math.floor(o[0]),g=Math.floor(o[1]),s=Math.floor(o[2]),l=Math.floor(o[3]),m=document.createElement("canvas");m.width=Math.floor(r),m.height=Math.floor(i);var d=m.getContext("2d");this._drawImageToCanvas(d,t,0,0,r,i,n);try{var u=c.ctx,v=c.videoWidth,C=c.videoHeight;if(h>=0&&g>=0&&h+s<=v&&g+l<=C){var I=u.getImageData(h,g,s,l),M=document.createElement("canvas");M.width=Math.floor(r),M.height=Math.floor(i);var x=M.getContext("2d"),T=document.createElement("canvas");T.width=s,T.height=l,T.getContext("2d").putImageData(I,0,0),x.drawImage(T,0,0,s,l,0,0,r,i);for(var p=x.getImageData(0,0,Math.floor(r),Math.floor(i)),w=d.getImageData(0,0,Math.floor(r),Math.floor(i)),_=w.data,F=p.data,y=0;y<_.length;y+=4){var S=F[y];_[y+3]=Math.floor(_[y+3]*S/255)}d.putImageData(w,0,0),T.width=0,T.height=0,M.width=0,M.height=0}else console.warn("[YYEVA] 蒙版位置超出视频范围:",h,g,s,l,"视频尺寸:",v,C)}catch(e){console.error("[YYEVA] 提取蒙版失败:",e)}e.drawImage(m,a,f),m.width=0,m.height=0},_drawImageToCanvas:function(e,t,a,f,r,i,n){var o,c,h,g,s=t.width/t.height;"scaleFill"===n?(o=r,c=i,h=a,g=f):(s>r/i?(o=r,c=r/s):(c=i,o=i*s),h=a+(r-o)/2,g=f+(i-c)/2),e.drawImage(t,h,g,o,c)},setText:function(e,t){this.effectConfig[e]||(this.effectConfig[e]={}),Object.assign(this.effectConfig[e],t)},setImage:function(e,t){this.effectConfig[e]||(this.effectConfig[e]={}),this.effectConfig[e].imageSource=t},getEffects:function(e){if(!e||!e.effect)return[];var t=[];for(var a in e.effect){var f=e.effect[a];t.push({effectId:a,effectTag:f.effectTag,effectType:f.effectType,name:f.name||f.effectTag})}return t},clearImageCache:function(){this.imageCache={}},reset:function(){this.effectConfig={},this.clearImageCache()},getFrameData:function(e,t){return this._findFrameData(e,t)}},e.MeeWoo.Services.YyevaRenderer=t}(window);