!function(){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Services=window.MeeWoo.Services||{};const e={oxipngModule:null,initialized:!1,compressionFailed:!1,oxipngReady:!1,init:async function(){try{const{default:e,init:t}=await import("./oxipng/optimise.js");await t(),this.oxipngModule={optimise:e},this.initialized=!0,this.oxipngReady=!0,console.log("ImageCompressionService initialized with oxipng wasm")}catch(e){console.error("Failed to load oxipng wasm:",e),this.initialized=!0,this.oxipngReady=!1,console.log("ImageCompressionService initialized with fallback mode")}},isOxipngReady:function(){return this.oxipngReady},detectFileType:function(e){if(e.length>=8){const t=[137,80,78,71,13,10,26,10];let i=!0;for(let n=0;n<8;n++)if(e[n]!==t[n]){i=!1;break}if(i)return"png"}return"unknown"},compressWithOxipng:async function(e,t){if(this.initialized||await this.init(),!this.isOxipngReady())throw new Error("oxipng not available");try{const i=Math.min(6,Math.max(1,Math.round(t/20))),n=await this.oxipngModule.optimise(e.buffer,{level:i,interlace:!1,optimiseAlpha:!0});return new Uint8Array(n)}catch(e){throw console.error("oxipng compression failed:",e),e}},compressWithPako:async function(e){if("undefined"==typeof pako)throw new Error("pako not available");try{const t=new DataView(e.buffer),i=t.getUint32(16),n=t.getUint32(20),o=document.createElement("canvas");o.width=i,o.height=n;const r=o.getContext("2d",{willReadFrequently:!0}),a=await new Promise((t,i)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>i(new Error("Image load failed")),n.src=URL.createObjectURL(new Blob([e],{type:"image/png"}))});r.drawImage(a,0,0);const s=r.getImageData(0,0,i,n).data,c=new Uint8Array(n*(1+4*i));for(let e=0;e<n;e++){c[e*(1+4*i)]=0;for(let t=0;t<i;t++){const n=4*(e*i+t),o=e*(1+4*i)+1+4*t;c[o]=s[n],c[o+1]=s[n+1],c[o+2]=s[n+2],c[o+3]=s[n+3]}}const l=pako.deflate(c);return this._buildSimplePNG(i,n,l)}catch(e){throw console.error("pako compression failed:",e),e}},compressWithBrowserDefault:async function(e){try{const t=await new Promise((t,i)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>i(new Error("Image load failed")),n.src=URL.createObjectURL(new Blob([e],{type:"image/png"}))}),i=document.createElement("canvas");i.width=t.width,i.height=t.height;i.getContext("2d").drawImage(t,0,0);const n=await new Promise(e=>{i.toBlob(e,"image/png")}),o=await n.arrayBuffer();return new Uint8Array(o)}catch(e){throw console.error("Browser default compression failed:",e),e}},compressPNG:async function(e,t=80){let i;try{if(this.initialized||await this.init(),this.isOxipngReady())return i=await this.compressWithOxipng(e,t),console.log("oxipng compression succeeded"),i;console.log("oxipng not ready, trying pako...")}catch(e){console.error("oxipng compression failed:",e)}try{return i=await this.compressWithPako(e),console.log("pako compression succeeded"),i}catch(e){this.compressionFailed=!0,console.log("pako compression failed, trying browser default...")}try{return i=await this.compressWithBrowserDefault(e),console.log("browser default compression succeeded"),i}catch(t){return this.compressionFailed=!0,console.error("All compression methods failed, returning original data"),e}},compressCanvas:async function(e,t=80){const i=await new Promise(t=>{e.toBlob(t,"image/png")}),n=await i.arrayBuffer(),o=new Uint8Array(n);return await this.compressPNG(o,t)},compressImage:async function(e,t=80){return"png"===this.detectFileType(e)?await this.compressPNG(e,t):e},hasCompressionFailed:function(){return this.compressionFailed},resetCompressionFailed:function(){this.compressionFailed=!1},_buildSimplePNG:function(e,t,i){const n=new Uint8Array([137,80,78,71,13,10,26,10]),o=new Uint8Array(13),r=new DataView(o.buffer);r.setUint32(0,e),r.setUint32(4,t),o[8]=8,o[9]=6,o[10]=0,o[11]=0,o[12]=0;const a=this._createPNGChunk("IHDR",o),s=this._createPNGChunk("IDAT",i),c=this._createPNGChunk("IEND",new Uint8Array(0)),l=n.length+a.length+s.length+c.length,h=new Uint8Array(l);let d=0;return h.set(n,d),d+=n.length,h.set(a,d),d+=a.length,h.set(s,d),d+=s.length,h.set(c,d),h},_createPNGChunk:function(e,t){const i=t.length,n=new Uint8Array(12+i),o=new DataView(n.buffer);o.setUint32(0,i);for(let t=0;t<4;t++)n[4+t]=e.charCodeAt(t);n.set(t,8);const r=this._crc32(n.subarray(4,8+i));return o.setUint32(8+i,r),n},_crc32:function(e){if(!this._crc32Table){this._crc32Table=new Uint32Array(256);for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;this._crc32Table[e]=t}}let t=-1;for(let i=0;i<e.length;i++)t=this._crc32Table[255&(t^e[i])]^t>>>8;return(-1^t)>>>0},_crc32Table:null};window.MeeWoo.Services.ImageCompressionService=e}("undefined"!=typeof window&&window);