!function(e){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Services=window.MeeWoo.Services||{};const r={defaults:{protoPath:"./svga.proto",quality:80,fps:30,pngCompression:{enabled:!0,quality:80,speed:6}},build:async function(e){var r=this;this._validateDependencies(e.dependencies);var o=e.frames||[],t=e.width||100,a=e.height||100,i=e.fps||this.defaults.fps,n=Math.max(10,Math.min(100,e.quality||this.defaults.quality)),s=e.originalSize||null,c=e.audios||[],d=e.muted||!1,l=e.onProgress||function(){},u=e.protoPath||this.defaults.protoPath,f=e.dependencies.protobuf,h=e.dependencies.pako,p=o.length;if(0===p)throw new Error("帧数组不能为空");var w=n/100,v=Math.round(t*w),m=Math.round(a*w),g=1/w,y=s&&100===n&&t===s.width&&a===s.height,b=[];if(y)for(var P=0;P<p;P++){var M=o[P],S=await r._blobToArrayBuffer(M.blob),E=new Uint8Array(S);b.push(E),l((P+1)/p*.5)}else{for(var W=[],_=[],A=0;A<4;A++){var C=document.createElement("canvas");C.width=v,C.height=m;var U=C.getContext("2d",{willReadFrequently:!0});U.imageSmoothingEnabled=!1,W.push(C),_.push(U)}async function G(e,o){var t=await Promise.all(o.map(async(e,o)=>{var t,a=e.frame,i=e.index,s=W[o%4],c=_[o%4],d=await r._loadImageFromBlob(a.blob);return c.clearRect(0,0,v,m),c.drawImage(d,0,0,v,m),t=d.src,setTimeout(function(){URL.revokeObjectURL(t)},100),{index:i,pngData:await r._canvasToPNG(s,n)}}));t.forEach(e=>{b[e.index]=e.pngData}),l((e+o.length)/p*.5)}b=new Array(p);for(P=0;P<p;P+=4){for(var T=Math.min(P+4,p),k=[],F=P;F<T;F++)k.push({frame:o[F],index:F});if(await G(P,k),e.cancelled&&e.cancelled())throw new Error("用户取消转换")}}var I=await r._encodeSVGA({pngFrames:b,scaledWidth:v,scaledHeight:m,displayWidth:t,displayHeight:a,scaleUp:g,fps:i,audios:c,muted:d,protoPath:u,protobuf:f,pako:h,onProgress:function(e){l(.5+.5*e)}});if(window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService){var D=window.MeeWoo.Services.ImageCompressionService;D.hasCompressionFailed()&&(alert("部分图片压缩失败，已使用降级方案处理"),D.resetCompressionFailed())}return I},buildFromPNG:async function(e){this._validateDependencies(e.dependencies);var r=e.frames||[],o=e.scaledWidth,t=e.scaledHeight,a=e.displayWidth,i=e.displayHeight,n=1/(e.scaleFactor||1),s=e.fps||this.defaults.fps,c=Math.max(10,Math.min(100,e.quality||this.defaults.quality)),d=e.audios||[],l=e.muted||!1,u=e.onProgress||function(){},f=e.protoPath||this.defaults.protoPath,h=e.dependencies.protobuf,p=e.dependencies.pako;if(0===r.length)throw new Error("帧数组不能为空");if(window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService){for(var w=window.MeeWoo.Services.ImageCompressionService,v=[],m=0;m<r.length;m++){var g=await w.compressPNG(r[m],c);v.push(g),u((m+1)/r.length*.5)}r=v}var y=await this._encodeSVGA({pngFrames:r,scaledWidth:o,scaledHeight:t,displayWidth:a,displayHeight:i,scaleUp:n,fps:s,audios:d,muted:l,protoPath:f,protobuf:h,pako:p,onProgress:function(e){u(.5+.5*e)}});window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService&&((w=window.MeeWoo.Services.ImageCompressionService).hasCompressionFailed()&&(alert("部分图片压缩失败，已使用降级方案处理"),w.resetCompressionFailed()));return y},_encodeSVGA:function(e){var r=e.pngFrames,o=e.scaledWidth,t=e.scaledHeight,a=e.displayWidth,i=e.displayHeight,n=e.scaleUp,s=e.fps,c=e.audios||[],d=e.muted||!1,l=e.protoPath,u=e.protobuf,f=e.pako,h=e.onProgress,p=r.length;return new Promise(function(e,w){u.load(l,function(l,u){if(l)w(new Error("Proto加载失败: "+l.message));else try{var v=u.lookupType("com.opensource.svga.MovieEntity");if(!v)return void w(new Error("Proto文件中未找到MovieEntity定义"));for(var m={},g=0;g<p;g++){m[M="img_"+g]=r[g],h((g+1)/p*.4)}var y=[],b={alpha:1,layout:{x:0,y:0,width:o,height:t},transform:{a:n,b:0,c:0,d:n,tx:0,ty:0}},P={alpha:0};for(g=0;g<p;g++){var M="img_"+g,S=new Array(p);S[g]=b;for(var E=0;E<g;E++)S[E]=P;for(E=g+1;E<p;E++)S[E]=P;y.push({imageKey:M,frames:S}),h(.4+(g+1)/p*.4)}var W=[];!d&&c&&c.length>0&&c.forEach(function(e,r){var o=e.audioKey||"audio_"+r;e.audioData&&(m[o]=e.audioData),W.push({audioKey:o,startFrame:e.startFrame||0,endFrame:e.endFrame||p,startTime:e.startTime||0,totalTime:e.totalTime||0})});var _={version:"2.0",params:{viewBoxWidth:a,viewBoxHeight:i,fps:s,frames:p},images:m,sprites:y,audios:W};h(.8);var A=v.verify(_);if(A)return void w(new Error("MovieEntity验证失败: "+A));var C=v.create(_),U=v.encode(C).finish();h(.9);var T=f.deflate(U),k=new Blob([T],{type:"application/octet-stream"});h(1),e(k)}catch(e){w(new Error("SVGA构建失败: "+e.message))}})})},_validateDependencies:function(e){if(!e)throw new Error("缺少依赖配置");if(!e.protobuf)throw new Error("缺少依赖：protobuf.js");if(!e.pako)throw new Error("缺少依赖：pako")},_loadImageFromBlob:function(e){return new Promise(function(r,o){var t=new Image;t.onload=function(){r(t)},t.onerror=function(){o(new Error("图片加载失败"))},t.src=URL.createObjectURL(e)})},_blobToArrayBuffer:function(e){return new Promise(function(r,o){var t=new FileReader;t.onload=function(){r(t.result)},t.onerror=function(){o(new Error("Blob读取失败"))},t.readAsArrayBuffer(e)})},_canvasToPNG:async function(e,r){try{if(window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService)return await window.MeeWoo.Services.ImageCompressionService.compressCanvas(e,r)}catch(e){console.warn("ImageCompressionService压缩失败，使用优化的原始编码:",e)}for(var o=e.toDataURL("image/png").split(",")[1],t=atob(o),a=t.length,i=new Uint8Array(a),n=0;n<a;n++)i[n]=t.charCodeAt(n);return i},_buildSimplePNG:function(e,r,o){var t=new Uint8Array([137,80,78,71,13,10,26,10]),a=new Uint8Array(13),i=new DataView(a.buffer);i.setUint32(0,e),i.setUint32(4,r),a[8]=8,a[9]=6,a[10]=0,a[11]=0,a[12]=0;var n=this._createPNGChunk("IHDR",a),s=this._createPNGChunk("IDAT",o),c=this._createPNGChunk("IEND",new Uint8Array(0)),d=t.length+n.length+s.length+c.length,l=new Uint8Array(d),u=0;return l.set(t,u),u+=t.length,l.set(n,u),u+=n.length,l.set(s,u),u+=s.length,l.set(c,u),l},decode:function(e,r,o){this._validateDependencies(r),o=o||this.defaults.protoPath;var t=r.protobuf,a=r.pako;return new Promise(function(r,i){(e instanceof Blob?e.arrayBuffer():Promise.resolve(e)).then(function(e){try{var n=new Uint8Array(e),s=a.inflate(n);t.load(o,function(e,o){if(e)i(new Error("Proto加载失败: "+e.message));else{var t=o.lookupType("com.opensource.svga.MovieEntity");if(t){var a=t.decode(s);r(a)}else i(new Error("Proto文件中未找到MovieEntity定义"))}})}catch(e){i(new Error("SVGA解析失败: "+e.message))}}).catch(i)})},encode:function(e,r,o){this._validateDependencies(r),o=o||this.defaults.protoPath;var t=r.protobuf,a=r.pako;return new Promise(function(r,i){t.load(o,function(o,t){if(o)i(new Error("Proto加载失败: "+o.message));else try{var n=t.lookupType("com.opensource.svga.MovieEntity");if(!n)return void i(new Error("Proto文件中未找到MovieEntity定义"));var s=n.verify(e);if(s)return void i(new Error("MovieEntity验证失败: "+s));var c=n.create(e),d=n.encode(c).finish(),l=a.deflate(d),u=new Blob([l],{type:"application/octet-stream"});r(u)}catch(e){i(new Error("SVGA编码失败: "+e.message))}})})},_createPNGChunk:function(e,r){var o=r.length,t=new Uint8Array(12+o),a=new DataView(t.buffer);a.setUint32(0,o);for(var i=0;i<4;i++)t[4+i]=e.charCodeAt(i);t.set(r,8);var n=this._crc32(t.subarray(4,8+o));return a.setUint32(8+o,n),t},_crc32:function(e){if(!this._crc32Table){this._crc32Table=new Uint32Array(256);for(var r=0;r<256;r++){for(var o=r,t=0;t<8;t++)o=1&o?3988292384^o>>>1:o>>>1;this._crc32Table[r]=o}}var a=-1;for(r=0;r<e.length;r++)a=this._crc32Table[255&(a^e[r])]^a>>>8;return(-1^a)>>>0},_crc32Table:null};"undefined"!=typeof module&&module.exports?module.exports=r:e.MeeWoo.Services.SvgaBuilder=r}("undefined"!=typeof window?window:this);