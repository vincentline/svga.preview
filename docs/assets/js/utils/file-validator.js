!function(e){"use strict";function t(e){this.libraryLoader=e}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},t.prototype.validateFile=function(e,t){var n=this;return new Promise(function(a,i){"svga"===t?n._validateSvga(e,a,i):"lottie"===t?n._validateLottie(e,a,i):"yyeva"===t?n._validateYyeva(e,a,i):"mp4"===t?n._validateMp4(e,a,i):i("不支持的文件类型")})},t.prototype._validateSvga=function(e,t,n){var a=new FileReader;a.onload=function(a){var i=a.target.result,r=new Blob([i],{type:"application/octet-stream"}),o=URL.createObjectURL(r);(new SVGA.Parser).load(o,function(n){URL.revokeObjectURL(o),t({videoItem:n,file:e})},function(e){URL.revokeObjectURL(o),n("SVGA文件解析失败："+(e.message||e))})},a.onerror=function(){n("文件读取失败")},a.readAsArrayBuffer(e)},t.prototype._validateLottie=function(e,t,n){(e.name||"").toLowerCase().endsWith(".lottie")?this._validateLottieZip(e,t,n):this._validateLottieJson(e,t,n)},t.prototype._validateLottieZip=function(e,t,n){var a=this;this.libraryLoader.load("jszip",!0).then(function(){var i=new FileReader;i.onload=function(i){JSZip.loadAsync(i.target.result).then(function(i){var r=i.file("manifest.json");r?r.async("text").then(function(r){try{var o=JSON.parse(r),s="";if(o.animations&&o.animations.length>0){var l=o.activeAnimationId,c=o.animations[0];if(l)for(var f=0;f<o.animations.length;f++)if(o.animations[f].id===l){c=o.animations[f];break}s="animations/"+c.id+".json",i.file(s)||(i.file(c.id+".json")?s=c.id+".json":i.file(c.id)&&(s=c.id))}s&&i.file(s)?a._readZipJsonFile(i,s,e,t,n):a._findAndReadAnyJson(i,e,t,n)}catch(r){a._findAndReadAnyJson(i,e,t,n)}}).catch(function(){a._findAndReadAnyJson(i,e,t,n)}):a._findAndReadAnyJson(i,e,t,n)}).catch(function(e){n(".lottie文件解压失败："+e.message)})},i.onerror=function(){n("文件读取失败")},i.readAsArrayBuffer(e)}).catch(function(e){n("JSZip库加载失败")})},t.prototype._findAndReadAnyJson=function(e,t,n,a){var i=[];if(e.forEach(function(e,t){e.endsWith(".json")&&!e.startsWith("__MACOSX")&&i.push(e)}),0!==i.length){for(var r=i[0],o=0;o<i.length;o++)if(-1!==i[o].toLowerCase().indexOf("data.json")){r=i[o];break}this._readZipJsonFile(e,r,t,n,a)}else a(".lottie文件中未找到JSON数据")},t.prototype._readZipJsonFile=function(e,t,n,a,i){var r=this;e.file(t).async("text").then(function(e){try{var t=JSON.parse(e),o=t;t.animations&&Array.isArray(t.animations)&&t.animations.length>0&&(t.animations[0].data?o=t.animations[0].data:t.animations[0].animation&&(o=t.animations[0].animation)),r._validateLottieAnimationData(o,n,a,i)}catch(e){i("JSON解析失败："+e.message)}}).catch(function(e){i("读取JSON文件失败："+e.message)})},t.prototype._validateLottieJson=function(e,t,n){var a=this,i=new FileReader;i.onload=function(i){try{var r=JSON.parse(i.target.result),o=r;r.animation&&"object"==typeof r.animation&&(o=r.animation),a._validateLottieAnimationData(o,e,t,n)}catch(e){n("JSON解析失败："+e.message)}},i.onerror=function(){n("文件读取失败")},i.readAsText(e)},t.prototype._validateLottieAnimationData=function(e,t,n,a){var i=e.w||e.width||0,r=e.h||e.height||0;i&&r?n({animationData:e,file:t}):a("Lottie文件缺少尺寸信息，可能文件格式不正确")},t.prototype._validateYyeva=function(e,t,n){var a=this;Promise.all([new Promise(function(t,n){a.detectMp4Type(e,function(e,a){e?t({isDualChannel:!0,alphaDirection:a}):n("检测未发现透明通道特征，请确认是双通道MP4文件")})}),a.detectMp4Fps(e),a.detectYyevaType(e)]).then(function(n){var a=n[0],i=n[1],r=n[2];t({file:e,isDualChannel:a.isDualChannel,alphaDirection:a.alphaDirection,detectedFps:i,isYyeva:!!r&&r.isYyeva,yyevaData:r?r.data:null})}).catch(function(e){n(e)})},t.prototype.detectYyevaType=function(t){return new Promise(function(n){var a=function(){var e=new FileReader;e.onload=function(e){try{var t=function(e){for(var t="yyeffectmp4json",n=(new TextEncoder).encode(t),a=-1,i=0;i<=e.length-n.length;i++){for(var r=!0,o=0;o<n.length;o++)if(e[i+o]!==n[o]){r=!1;break}if(r){a=i;break}}if(-1===a)return null;for(var s=a+t.length,l=Math.min(e.length-s,5e4),c="",f=s;f<s+l;f++)c+=String.fromCharCode(e[f]);var u=c.match(/\[\[([A-Za-z0-9+/=]+)\]\]/);if(!u||!u[1])return null;try{for(var d=atob(u[1]),h=new Uint8Array(d.length),v=0;v<d.length;v++)h[v]=d.charCodeAt(v);if("undefined"==typeof pako||!pako.inflate)return console.warn("YYEVA 解析需要 pako 库，请确保已加载"),null;var p=pako.inflate(h),m=new TextDecoder("utf-8").decode(p),g=JSON.parse(m);return g.descript&&1===g.descript.isEffect?{descript:g.descript,effect:g.effect||{},datas:g.datas||[]}:null}catch(e){return console.warn("YYEVA 数据解析失败:",e),null}}(new Uint8Array(e.target.result));n(t?{isYyeva:!0,data:t}:{isYyeva:!1,data:null})}catch(e){console.warn("YYEVA 检测失败:",e),n({isYyeva:!1,data:null})}},e.onerror=function(){n({isYyeva:!1,data:null})},e.readAsArrayBuffer(t)};"undefined"!=typeof pako&&pako.inflate?a():e.MeeWoo&&e.MeeWoo.Core&&e.MeeWoo.Core.libraryLoader?e.MeeWoo.Core.libraryLoader.load("pako",!0).then(function(){a()}).catch(function(e){console.warn("pako 加载失败，跳过 YYEVA 检测:",e),n({isYyeva:!1,data:null})}):(console.warn("YYEVA 解析需要 pako 库，请确保已加载"),n({isYyeva:!1,data:null}))})},t.prototype._validateMp4=function(e,t,n){var a=this,i=URL.createObjectURL(e),r=document.createElement("video");r.src=i,r.muted=!0,r.onloadedmetadata=function(){URL.revokeObjectURL(i),a.detectMp4Fps(e).then(function(n){t({file:e,detectedFps:n})})},r.onerror=function(){URL.revokeObjectURL(i),n("视频文件加载失败")}},t.prototype.detectMp4Fps=function(e){return new Promise(function(t){var n=Math.min(e.size,512e3),a=new FileReader;a.onload=function(e){try{var n=e.target.result,a=function(e){var t=0,n=e.byteLength;function a(n,a){for(;t<a;){if(t+8>a)return null;var i=t,r=e.getUint32(t),o=String.fromCharCode(e.getUint8(t+4),e.getUint8(t+5),e.getUint8(t+6),e.getUint8(t+7));if(1!==r){if(0===r)return null;if(o===n)return t=i+8,{size:r,start:i,end:i+r};t=i+r}else t+=8,t=i+8+8}return null}var i=a("moov",n);if(!i)return null;t=i.start+8;var r=i.end;for(;t<r;){var o=a("trak",r);if(!o)break;var s=o.end;t=o.start+8;var l=a("mdia",s);if(l){t=l.start+8;for(var c=l.end,f=null,u=null,d=null,h=t;h<c;){t=h;var v=e.getUint32(t),p=String.fromCharCode(e.getUint8(t+4),e.getUint8(t+5),e.getUint8(t+6),e.getUint8(t+7));"hdlr"===p?f={start:t,size:v}:"mdhd"===p?u={start:t,size:v}:"minf"===p&&(d={start:t,size:v,end:t+v}),h+=v}if(f)if(t=f.start+8+4,t+=4,"vide"===String.fromCharCode(e.getUint8(t),e.getUint8(t+1),e.getUint8(t+2),e.getUint8(t+3))&&u&&d){t=u.start+8;var m=e.getUint8(t);t+=4;var g=0;1===m?(t+=16,g=e.getUint32(t)):(t+=8,g=e.getUint32(t)),t=d.start+8;var y=a("stbl",d.end);if(y){t=y.start+8;var A=a("stts",y.end);if(A){t=A.start+8,t+=4;var M=e.getUint32(t);if(t+=4,M>0){e.getUint32(t);var U=e.getUint32(t+4);if(U>0&&g>0)return Math.round(g/U)}}}}}t=s}return null}(new DataView(n));t(a)}catch(e){console.warn("MP4 FPS parsing failed:",e),t(null)}},a.onerror=function(){t(null)},a.readAsArrayBuffer(e.slice(0,n))})},t.prototype.detectMp4Type=function(e,t){var n=URL.createObjectURL(e),a=document.createElement("video");a.src=n,a.muted=!0;var i={pureBlackThreshold:.015,saturationDiffThreshold:.02,brightnessDiffThreshold:.03,checkFramePositions:[.3,.7]};function r(){a&&(a.onloadedmetadata=null,a.onseeked=null,a.onerror=null,a.removeAttribute("src"),a.src=""),n&&(setTimeout(function(){URL.revokeObjectURL(n)},100),n=null)}a.onloadedmetadata=function(){var e=a.videoWidth,n=a.videoHeight,o=a.duration,s=document.createElement("canvas"),l=Math.min(1,320/e),c=Math.max(1,Math.floor(e*l)),f=Math.max(1,Math.floor(n*l));s.width=c,s.height=f;var u=s.getContext("2d",{willReadFrequently:!0}),d=0,h=!1,v=null;function p(e){for(var t=e.data,n=0,a=0,i=0,r=0;r<t.length;r+=4){var o=t[r]/255,s=t[r+1]/255,l=t[r+2]/255,c=Math.max(o,s,l),f=Math.min(o,s,l);n+=0===c?0:(c-f)/c,a+=.299*o+.587*s+.114*l,i++}return{saturation:0===i?0:n/i,brightness:0===i?0:a/i}}function m(){u.drawImage(a,0,0,c,f);var e=Math.floor(c/2);if(e<=0||f<=0)return!1;var t=u.getImageData(0,0,e,f),n=u.getImageData(e,0,e,f),r=p(t),o=p(n),s=Math.abs(r.saturation-o.saturation),l=Math.abs(r.brightness-o.brightness),d=r.saturation<i.pureBlackThreshold||o.saturation<i.pureBlackThreshold,h=s>i.saturationDiffThreshold,v=l>i.brightnessDiffThreshold;return r.saturation<i.pureBlackThreshold&&o.saturation<i.pureBlackThreshold&&(h=s>.003,v=l>.003),d&&(h||v)?r.saturation<o.saturation?"left":"right":null}function g(){if(d>=i.checkFramePositions.length)return r(),void t(h,v);var e=i.checkFramePositions[d];if(!isFinite(o)||o<=0)if(0===d){var n=m();n&&(h=!0,v=n),r(),t(h,v)}else r(),t(h,v);else a.currentTime=o*e}a.onseeked=function(){var e=m();e&&(h=!0,v||(v=e)),d++,g()},a.onerror=function(){r(),t(!1,null)},g()},a.onerror=function(){r(),t(!1,null)}},t.prototype.isSequenceFrames=function(e){if(e.length<2)return!1;for(var t=/\d+/g,n=[],a=0;a<e.length;a++){var i=e[a].name.replace(/\.[^.]+$/,""),r=i.match(t);if(!r||0===r.length)return!1;var o=parseInt(r[r.length-1],10),s=i.lastIndexOf(r[r.length-1]),l=i.substring(0,s);n.push({file:e[a],seqNum:o,prefix:l})}for(var c=n[0].prefix,f=1;f<n.length;f++)if(n[f].prefix!==c)return!1;var u=n.map(function(e){return e.seqNum}),d=Math.min.apply(null,u);return Math.max.apply(null,u)-d+1<=1.5*e.length},e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},e.MeeWoo.Services.FileValidator=t}(window);