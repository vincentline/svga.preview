!function(t){"use strict";function e(t){this.libraryLoader=t}t.MeeWoo=t.MeeWoo||{},t.MeeWoo.Services=t.MeeWoo.Services||{},e.prototype.validateFile=function(t,e){var n=this;return new Promise(function(a,i){"svga"===e?n._validateSvga(t,a,i):"lottie"===e?n._validateLottie(t,a,i):"yyeva"===e?n._validateYyeva(t,a,i):"mp4"===e?n._validateMp4(t,a,i):i("不支持的文件类型")})},e.prototype._validateSvga=function(t,e,n){var a=new FileReader;a.onload=function(a){var i=a.target.result,r=new Blob([i],{type:"application/octet-stream"}),o=URL.createObjectURL(r);(new SVGA.Parser).load(o,function(n){URL.revokeObjectURL(o),e({videoItem:n,file:t})},function(t){URL.revokeObjectURL(o),n("SVGA文件解析失败："+(t.message||t))})},a.onerror=function(){n("文件读取失败")},a.readAsArrayBuffer(t)},e.prototype._validateLottie=function(t,e,n){(t.name||"").toLowerCase().endsWith(".lottie")?this._validateLottieZip(t,e,n):this._validateLottieJson(t,e,n)},e.prototype._validateLottieZip=function(t,e,n){var a=this;this.libraryLoader.load("jszip",!0).then(function(){var i=new FileReader;i.onload=function(i){JSZip.loadAsync(i.target.result).then(function(i){var r=i.file("manifest.json");r?r.async("text").then(function(r){try{var o=JSON.parse(r),s="";if(o.animations&&o.animations.length>0){var l=o.activeAnimationId,u=o.animations[0];if(l)for(var c=0;c<o.animations.length;c++)if(o.animations[c].id===l){u=o.animations[c];break}s="animations/"+u.id+".json",i.file(s)||(i.file(u.id+".json")?s=u.id+".json":i.file(u.id)&&(s=u.id))}s&&i.file(s)?a._readZipJsonFile(i,s,t,e,n):a._findAndReadAnyJson(i,t,e,n)}catch(r){a._findAndReadAnyJson(i,t,e,n)}}).catch(function(){a._findAndReadAnyJson(i,t,e,n)}):a._findAndReadAnyJson(i,t,e,n)}).catch(function(t){n(".lottie文件解压失败："+t.message)})},i.onerror=function(){n("文件读取失败")},i.readAsArrayBuffer(t)}).catch(function(t){n("JSZip库加载失败")})},e.prototype._findAndReadAnyJson=function(t,e,n,a){var i=[];if(t.forEach(function(t,e){t.endsWith(".json")&&!t.startsWith("__MACOSX")&&i.push(t)}),0!==i.length){for(var r=i[0],o=0;o<i.length;o++)if(-1!==i[o].toLowerCase().indexOf("data.json")){r=i[o];break}this._readZipJsonFile(t,r,e,n,a)}else a(".lottie文件中未找到JSON数据")},e.prototype._readZipJsonFile=function(t,e,n,a,i){var r=this;t.file(e).async("text").then(function(t){try{var e=JSON.parse(t),o=e;e.animations&&Array.isArray(e.animations)&&e.animations.length>0&&(e.animations[0].data?o=e.animations[0].data:e.animations[0].animation&&(o=e.animations[0].animation)),r._validateLottieAnimationData(o,n,a,i)}catch(t){i("JSON解析失败："+t.message)}}).catch(function(t){i("读取JSON文件失败："+t.message)})},e.prototype._validateLottieJson=function(t,e,n){var a=this,i=new FileReader;i.onload=function(i){try{var r=JSON.parse(i.target.result),o=r;r.animation&&"object"==typeof r.animation&&(o=r.animation),a._validateLottieAnimationData(o,t,e,n)}catch(t){n("JSON解析失败："+t.message)}},i.onerror=function(){n("文件读取失败")},i.readAsText(t)},e.prototype._validateLottieAnimationData=function(t,e,n,a){var i=t.w||t.width||0,r=t.h||t.height||0;i&&r?n({animationData:t,file:e}):a("Lottie文件缺少尺寸信息，可能文件格式不正确")},e.prototype._validateYyeva=function(t,e,n){var a=this;Promise.all([new Promise(function(e,n){a.detectMp4Type(t,function(t,a){t?e({isDualChannel:!0,alphaDirection:a}):n("检测未发现透明通道特征，请确认是双通道MP4文件")})}),a.detectMp4Fps(t)]).then(function(n){var a=n[0],i=n[1];e({file:t,isDualChannel:a.isDualChannel,alphaDirection:a.alphaDirection,detectedFps:i})}).catch(function(t){n(t)})},e.prototype._validateMp4=function(t,e,n){var a=this,i=URL.createObjectURL(t),r=document.createElement("video");r.src=i,r.muted=!0,r.onloadedmetadata=function(){URL.revokeObjectURL(i),a.detectMp4Fps(t).then(function(n){e({file:t,detectedFps:n})})},r.onerror=function(){URL.revokeObjectURL(i),n("视频文件加载失败")}},e.prototype.detectMp4Fps=function(t){return new Promise(function(e){var n=Math.min(t.size,512e3),a=new FileReader;a.onload=function(t){try{var n=t.target.result,a=function(t){var e=0,n=t.byteLength;function a(n,a){for(;e<a;){if(e+8>a)return null;var i=e,r=t.getUint32(e),o=String.fromCharCode(t.getUint8(e+4),t.getUint8(e+5),t.getUint8(e+6),t.getUint8(e+7));if(1!==r){if(0===r)return null;if(o===n)return e=i+8,{size:r,start:i,end:i+r};e=i+r}else e+=8,e=i+8+8}return null}var i=a("moov",n);if(!i)return null;e=i.start+8;var r=i.end;for(;e<r;){var o=a("trak",r);if(!o)break;var s=o.end;e=o.start+8;var l=a("mdia",s);if(l){e=l.start+8;for(var u=l.end,c=null,f=null,d=null,h=e;h<u;){e=h;var v=t.getUint32(e),m=String.fromCharCode(t.getUint8(e+4),t.getUint8(e+5),t.getUint8(e+6),t.getUint8(e+7));"hdlr"===m?c={start:e,size:v}:"mdhd"===m?f={start:e,size:v}:"minf"===m&&(d={start:e,size:v,end:e+v}),h+=v}if(c)if(e=c.start+8+4,e+=4,"vide"===String.fromCharCode(t.getUint8(e),t.getUint8(e+1),t.getUint8(e+2),t.getUint8(e+3))&&f&&d){e=f.start+8;var p=t.getUint8(e);e+=4;var g=0;1===p?(e+=16,g=t.getUint32(e)):(e+=8,g=t.getUint32(e)),e=d.start+8;var y=a("stbl",d.end);if(y){e=y.start+8;var U=a("stts",y.end);if(U){e=U.start+8,e+=4;var M=t.getUint32(e);if(e+=4,M>0){t.getUint32(e);var L=t.getUint32(e+4);if(L>0&&g>0)return Math.round(g/L)}}}}}e=s}return null}(new DataView(n));e(a)}catch(t){console.warn("MP4 FPS parsing failed:",t),e(null)}},a.onerror=function(){e(null)},a.readAsArrayBuffer(t.slice(0,n))})},e.prototype.detectMp4Type=function(t,e){var n=URL.createObjectURL(t),a=document.createElement("video");a.src=n,a.muted=!0;var i={pureBlackThreshold:.015,saturationDiffThreshold:.02,brightnessDiffThreshold:.03,checkFramePositions:[.3,.7]};function r(){a&&(a.onloadedmetadata=null,a.onseeked=null,a.onerror=null,a.removeAttribute("src"),a.src=""),n&&(setTimeout(function(){URL.revokeObjectURL(n)},100),n=null)}a.onloadedmetadata=function(){var t=a.videoWidth,n=a.videoHeight,o=a.duration,s=document.createElement("canvas"),l=Math.min(1,320/t),u=Math.max(1,Math.floor(t*l)),c=Math.max(1,Math.floor(n*l));s.width=u,s.height=c;var f=s.getContext("2d",{willReadFrequently:!0}),d=0,h=!1,v=null;function m(t){for(var e=t.data,n=0,a=0,i=0,r=0;r<e.length;r+=4){var o=e[r]/255,s=e[r+1]/255,l=e[r+2]/255,u=Math.max(o,s,l),c=Math.min(o,s,l);n+=0===u?0:(u-c)/u,a+=.299*o+.587*s+.114*l,i++}return{saturation:0===i?0:n/i,brightness:0===i?0:a/i}}function p(){f.drawImage(a,0,0,u,c);var t=Math.floor(u/2);if(t<=0||c<=0)return!1;var e=f.getImageData(0,0,t,c),n=f.getImageData(t,0,t,c),r=m(e),o=m(n),s=Math.abs(r.saturation-o.saturation),l=Math.abs(r.brightness-o.brightness),d=r.saturation<i.pureBlackThreshold||o.saturation<i.pureBlackThreshold,h=s>i.saturationDiffThreshold,v=l>i.brightnessDiffThreshold;return r.saturation<i.pureBlackThreshold&&o.saturation<i.pureBlackThreshold&&(h=s>.003,v=l>.003),d&&(h||v)?r.saturation<o.saturation?"left":"right":null}function g(){if(d>=i.checkFramePositions.length)return r(),void e(h,v);var t=i.checkFramePositions[d];if(!isFinite(o)||o<=0)if(0===d){var n=p();n&&(h=!0,v=n),r(),e(h,v)}else r(),e(h,v);else a.currentTime=o*t}a.onseeked=function(){var t=p();t&&(h=!0,v||(v=t)),d++,g()},a.onerror=function(){r(),e(!1,null)},g()},a.onerror=function(){r(),e(!1,null)}},e.prototype.isSequenceFrames=function(t){if(t.length<2)return!1;for(var e=/\d+/g,n=[],a=0;a<t.length;a++){var i=t[a].name.replace(/\.[^.]+$/,""),r=i.match(e);if(!r||0===r.length)return!1;var o=parseInt(r[r.length-1],10),s=i.lastIndexOf(r[r.length-1]),l=i.substring(0,s);n.push({file:t[a],seqNum:o,prefix:l})}for(var u=n[0].prefix,c=1;c<n.length;c++)if(n[c].prefix!==u)return!1;var f=n.map(function(t){return t.seqNum}),d=Math.min.apply(null,f);return Math.max.apply(null,f)-d+1<=1.5*t.length},t.MeeWoo=t.MeeWoo||{},t.MeeWoo.Services=t.MeeWoo.Services||{},t.MeeWoo.Services.FileValidator=e}(window);