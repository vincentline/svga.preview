!function(t){"use strict";function e(t){this.state=t}if(t.MeeWoo=t.MeeWoo||{},t.MeeWoo.Controllers=t.MeeWoo.Controllers||{},e.prototype={play:function(){throw new Error("子类必须实现 play")},pause:function(){throw new Error("子类必须实现 pause")},seekTo:function(t){throw new Error("子类必须实现 seekTo")},setMuted:function(t){throw new Error("子类必须实现 setMuted")},setVolume:function(t){throw new Error("子类必须实现 setVolume")},canHandle:function(){return this.state.hasFile},transformPercentage:function(t){return t},updateState:function(t){this.state=t}},"undefined"!=typeof Howl)u.init();else var o=setInterval(function(){"undefined"!=typeof Howl&&(u.init(),clearInterval(o))},100);function n(t){e.call(this,t)}function r(t,o){e.call(this,t),this.video=o}function a(t){r.call(this,t,t.yyevaVideo)}function s(t){r.call(this,t,t.mp4Video)}function i(t){e.call(this,t)}n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.canHandle=function(){return this.state.hasFile&&this.state.lottiePlayer},n.prototype.play=function(){this.state.lottiePlayer.play()},n.prototype.pause=function(){this.state.lottiePlayer.pause()},n.prototype.seekTo=function(t){var e=(this.state.lottiePlayer&&this.state.lottiePlayer.firstFrame||0)+Math.round(t*this.state.totalFrames);this.state.isPlaying?this.state.lottiePlayer.goToAndPlay(e,!0):this.state.lottiePlayer.goToAndStop(e,!0)},n.prototype.setMuted=function(t){},n.prototype.setVolume=function(t){},r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.canHandle=function(){return this.state.hasFile&&this.video},r.prototype.play=function(){var t=this;return this.video.play().then(function(){t.afterPlay()}).catch(function(t){console.error("播放失败:",t)})},r.prototype.pause=function(){this.video.pause(),this.afterPause()},r.prototype.seekTo=function(t){var e=this.transformPercentage(t),o=this.video.duration||1;this.video.currentTime=e*o},r.prototype.setMuted=function(t){this.video.muted=t},r.prototype.setVolume=function(t){t=Math.max(0,Math.min(1,t)),this.video.volume=t},r.prototype.afterPlay=function(){},r.prototype.afterPause=function(){},a.prototype=Object.create(r.prototype),a.prototype.constructor=a,a.prototype.afterPlay=function(){this.state.startYyevaRenderLoop&&this.state.startYyevaRenderLoop()},a.prototype.afterPause=function(){this.state.yyevaAnimationId&&(cancelAnimationFrame(this.state.yyevaAnimationId),this.state.yyevaAnimationId=null)},a.prototype.seekTo=function(t){if(r.prototype.seekTo.call(this,t),this.state.renderYyevaFrame){var e=this,o=function(){e.state.renderYyevaFrame(),e.video.removeEventListener("seeked",o)};this.video.seeking?this.video.addEventListener("seeked",o):this.state.renderYyevaFrame()}},s.prototype=Object.create(r.prototype),s.prototype.constructor=s,s.prototype.afterPlay=function(){this.state.startMp4ProgressLoop&&this.state.startMp4ProgressLoop()},s.prototype.afterPause=function(){this.state.stopMp4ProgressLoop&&this.state.stopMp4ProgressLoop()},s.prototype.transformPercentage=function(t){if(!this.state.speedRemapConfig||!this.state.speedRemapConfig.enabled||!this.state.speedRemapConfig.keyframes||this.state.speedRemapConfig.keyframes.length<2)return t;for(var e=this.state.speedRemapConfig.keyframes,o=this.state.speedRemapConfig.originalTotalFrames||this.state.totalFrames,n=t*e[e.length-1].position,r=0,a=0;a<e.length-1;a++){var s=e[a],i=e[a+1];if(n>=s.position&&n<=i.position){var u=i.position-s.position;if(u>0){var c=(n-s.position)/u;r=s.originalFrame+c*(i.originalFrame-s.originalFrame)}else r=s.originalFrame;break}}return r/o},i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.play=function(){this.state.startFramesPlayLoop&&this.state.startFramesPlayLoop()},i.prototype.pause=function(){this.state.stopFramesPlayLoop&&this.state.stopFramesPlayLoop()},i.prototype.seekTo=function(t){var e=Math.round(t*(this.state.totalFrames-1));this.state.seekFramesTo&&this.state.seekFramesTo(e)},i.prototype.setMuted=function(t){},i.prototype.setVolume=function(t){};var u={instances:[],initialized:!1,init:function(){this.initialized=!0},add:function(t){if(t&&(this.instances||(this.instances=[]),-1===this.instances.indexOf(t))){this.instances.push(t);var e=this;if("function"==typeof t.on)try{"object"==typeof t._events&&t.on("unload",function(){e.remove(t)})}catch(t){}}},remove:function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1)},stopAll:function(){this.instances.forEach(function(t){t.playing()&&t.stop()})},pauseAll:function(){this.instances.forEach(function(t){t.playing()&&t.pause()})},muteAll:function(t){this.instances.forEach(function(e){e.mute(t)})},setVolume:function(t){t=Math.max(0,Math.min(1,t)),this.instances.forEach(function(e){e.volume(t)})},getVolume:function(){return this.instances.length>0?this.instances[0].volume():1},unloadAll:function(){this.instances.slice().forEach(function(t){try{t.unload()}catch(t){console.warn("Unload error:",t)}}),this.instances=[]}};function c(t){e.call(this,t),u.init(),this.audioCache={}}function l(t){this.options=t||{},this.onProgressChange=t.onProgressChange||function(){},this.onVolumeChange=t.onVolumeChange||function(){};var e=t.onPlayStateChange||function(){},o=this;this.onPlayStateChange=function(t){o.handlePlayStateChange(t),e(t)},this.getPlayerState=t.getPlayerState||function(){return{}},this.isDragging=!1,this.progressBar=null,this.progressThumb=null,this.isVolumeDragging=!1,this.volumeBar=null,this.volumeThumb=null,this.currentAdapter=null,this.currentMode=null,this.getAdapter=this.getAdapter.bind(this),this.handlePlayStateChange=this.handlePlayStateChange.bind(this),t.progressBar&&t.progressThumb&&this.initProgressDrag(t.progressBar,t.progressThumb),t.volumeBar&&t.volumeThumb&&this.initVolumeDrag(t.volumeBar,t.volumeThumb)}c.prototype=Object.create(e.prototype),c.prototype.constructor=c,c.prototype.canHandle=function(){return this.state.hasFile&&this.state.svgaPlayer},c.prototype.play=function(){try{var t=(this.state.progress||0)/100;u.stopAll(),this.state.svgaPlayer.stepToPercentage(t,!0);var e=t*this.state.totalFrames;this.syncAudio(e),u.muteAll(this.state.isMuted)}catch(t){console.error("播放失败:",t)}},c.prototype.pause=function(){try{this.state.svgaPlayer.pauseAnimation(),u.stopAll()}catch(t){console.error("暂停失败:",t)}},c.prototype.seekTo=function(t,e){try{u.stopAll();var o=this.state.isPlaying&&!e;if(this.state.svgaPlayer.stepToPercentage(t,o),o){var n=t*this.state.totalFrames;this.syncAudio(n),u.muteAll(this.state.isMuted)}}catch(t){console.error("跳转失败:",t)}},c.prototype.syncAudio=function(t){if(this.state.isPlaying){var e=this.state.svgaAudios;if(e&&e.length){this._hasWarnedNoAudio=!1;var o=this.state.videoItem.FPS||30,n=this;e.forEach(function(e){var r="number"==typeof e.startFrame?e.startFrame:0,a="number"==typeof e.endFrame?e.endFrame:0;if(0===a&&(a=n.state.totalFrames||999999),t>=r&&t<a){var s=n.getHowlInstance(e.audioKey);if(s){if(!s.playing()){var i=(t-r)/o,u=(e.startTime||0)/1e3,c=Math.max(0,u+i);s.seek(c),s.play(),s.mute(n.state.isMuted)}}else console.warn("Howl instance not found for:",e.audioKey)}else if(n.audioCache[e.audioKey]){var l=n.audioCache[e.audioKey];l.playing()&&l.stop()}})}}},c.prototype.getHowlInstance=function(t){if(this.audioCache[t])return this.audioCache[t];var e=this.state.svgaAudioData||{},o=this.state.videoItem,n=o&&o.images?o.images:{},r=[t,t+".mp3",t+".wav","audio_"+t,t.replace(/\.[^.]+$/,""),"audio_"+t.replace(/\.[^.]+$/,"")];t.endsWith(".mp3")&&r.push(t.replace(".mp3",""));for(var a=null,s=0;s<r.length;s++)if(e[r[s]]){a=e[r[s]];break}if(!a&&n)for(s=0;s<r.length;s++)if(n[r[s]]){a=n[r[s]];break}if(!a)for(var i=Object.keys(e),c=0;c<i.length;c++){var l=i[c];if(l.length>3&&t.length>3&&(-1!==l.indexOf(t)||-1!==t.indexOf(l))){a=e[l];break}}if(!a)return null;var p=null;if("string"==typeof a)p=a.startsWith("data:")?a:"data:audio/mp3;base64,"+a;else if(a instanceof Uint8Array){var h=new Blob([a],{type:"audio/mp3"});p=URL.createObjectURL(h)}if(!p)return null;var d=new Howl({src:[p],format:["mp3","wav"],html5:!1,loop:!1,autoplay:!1,volume:u.getVolume(),onload:function(){},onloaderror:function(e,o){console.error("Howl Load Error:",o,"for key:",t)},onplayerror:function(e,o){console.error("Howl Play Error:",o,"for key:",t),"undefined"!=typeof Howler&&Howler.ctx&&"suspended"===Howler.ctx.state&&Howler.ctx.resume()}});return u.add(d),this.audioCache[t]=d,d},c.prototype.setMuted=function(t){u.muteAll(t)},c.prototype.setVolume=function(t){u.setVolume(t)},c.prototype.destroy=function(){u.unloadAll(),this.audioCache={}},l.prototype.getAdapter=function(){var t=this.getPlayerState(),e=t.mode;if(this.currentAdapter&&this.currentMode===e)return this.currentAdapter.updateState(t),this.currentAdapter;this.currentAdapter&&(this.currentAdapter.destroy&&this.currentAdapter.destroy(),this.currentAdapter=null);var o=null;switch(e){case"lottie":o=new n(t);break;case"yyeva":o=new a(t);break;case"mp4":o=new s(t);break;case"frames":o=new i(t);break;case"svga":o=new c(t)}return o&&o.canHandle()?(this.currentAdapter=o,this.currentMode=e,o):null},l.prototype.togglePlay=function(){var t=this.getPlayerState(),e=this.getAdapter();if(e)try{t.isPlaying?(e.pause(),this.onPlayStateChange(!1)):(e.play(),this.onPlayStateChange(!0))}catch(t){console.error("播放控制失败:",t)}},l.prototype.seekTo=function(t,e){t=Math.max(0,Math.min(1,t));var o=this.getPlayerState(),n=this.getAdapter();if(n)try{var r=Math.round(100*t),a=n.transformPercentage(t),s=Math.round(a*o.totalFrames);this.onProgressChange(r,s),n instanceof c?n.seekTo(t,e):n.seekTo(t)}catch(t){console.error("跳转失败:",t)}},l.prototype.setMuted=function(t){var e=this.getAdapter();if(e)try{e.setMuted(t)}catch(t){console.error("设置静音失败:",t)}},l.prototype.setVolume=function(t){var e=this.getAdapter();if(e)try{e.setVolume(t)}catch(t){console.error("设置音量失败:",t)}},l.prototype.step=function(t){var e=this.getPlayerState(),o=e.totalDuration||0,n=e.currentTime||0;if(!(o<2)){var r=n+(o<10?1:o<=60?2:5)*t;if(r<0&&(r=0),r>o&&(r=o),o>0){var a=r/o;this.seekTo(a)}}},l.prototype.syncAudio=function(t){var e=this.getAdapter();e&&e instanceof c&&e.syncAudio&&e.syncAudio(t)},l.prototype.handlePlayStateChange=function(t){var e=this.currentAdapter;e&&e instanceof c&&(t||e.pause())},l.prototype.initProgressDrag=function(t,e){var o=this;this.progressBar=t,this.progressThumb=e;var n,r,a,s=function(t){t.preventDefault(),o.isDragging=!0,o.wasPlaying=o.getPlayerState().isPlaying,l(t,!0),document.addEventListener("mousemove",u),document.addEventListener("mouseup",c),document.addEventListener("touchmove",u,{passive:!1}),document.addEventListener("touchend",c)},i=(n=function(t){l(t,!0)},r=50,function(){var t=arguments;a||(n.apply(this,t),a=!0,setTimeout(function(){a=!1},r))}),u=function(t){o.isDragging&&(t.preventDefault(),i(t))},c=function(){if(o.isDragging=!1,document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",c),document.removeEventListener("touchmove",u),document.removeEventListener("touchend",c),o.wasPlaying){var t=o.getAdapter();t&&t.play()}},l=function(t,e){var n=t.clientX||t.touches&&t.touches[0]&&t.touches[0].clientX;if(n){var r=o.progressBar.getBoundingClientRect(),a=(n-r.left)/r.width;o.seekTo(a,e)}};e.addEventListener("mousedown",s),e.addEventListener("touchstart",s,{passive:!1});var p=function(t){t.target===e||e.contains(t.target)||l(t,!1)};t.addEventListener("click",p),this._cleanupDrag=function(){e.removeEventListener("mousedown",s),e.removeEventListener("touchstart",s),t.removeEventListener("click",p),c()}},l.prototype.initVolumeDrag=function(t,e){var o=this;this.volumeBar=t,this.volumeThumb=e;var n,r,a,s=function(t){t.preventDefault(),o.isVolumeDragging=!0,l(t,!0),document.addEventListener("mousemove",u),document.addEventListener("mouseup",c),document.addEventListener("touchmove",u,{passive:!1}),document.addEventListener("touchend",c)},i=(n=function(t){l(t,!0)},r=50,function(){var t=arguments;a||(n.apply(this,t),a=!0,setTimeout(function(){a=!1},r))}),u=function(t){o.isVolumeDragging&&(t.preventDefault(),i(t))},c=function(){o.isVolumeDragging=!1,document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",c),document.removeEventListener("touchmove",u),document.removeEventListener("touchend",c)},l=function(t,e){var n=t.clientY||t.touches&&t.touches[0]&&t.touches[0].clientY;if(n){var r=o.volumeBar.getBoundingClientRect(),a=n-r.top,s=1-Math.max(0,Math.min(1,a/r.height)),i=Math.round(100*s)/100;o.onVolumeChange(i),o.setVolume(i)}};e.addEventListener("mousedown",s),e.addEventListener("touchstart",s,{passive:!1});var p=function(t){t.target===e||e.contains(t.target)||l(t,!1)};t.addEventListener("click",p),this._cleanupVolumeDrag=function(){e.removeEventListener("mousedown",s),e.removeEventListener("touchstart",s),t.removeEventListener("click",p),c()}},l.prototype.destroy=function(){this.currentAdapter&&(this.currentAdapter.destroy&&this.currentAdapter.destroy(),this.currentAdapter=null),this.currentMode=null,this._cleanupDrag&&(this._cleanupDrag(),this._cleanupDrag=null),this.progressBar=null,this.progressThumb=null,this._cleanupVolumeDrag&&(this._cleanupVolumeDrag(),this._cleanupVolumeDrag=null),this.volumeBar=null,this.volumeThumb=null},t.MeeWoo.Controllers.PlayerController=l,t.MeeWoo.Controllers.GlobalAudioManager=u}("undefined"!=typeof window?window:this);