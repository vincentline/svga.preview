!function(t){"use strict";function e(t){this.state=t}if(t.MeeWoo=t.MeeWoo||{},t.MeeWoo.Controllers=t.MeeWoo.Controllers||{},e.prototype={play:function(){throw new Error("子类必须实现 play")},pause:function(){throw new Error("子类必须实现 pause")},seekTo:function(t){throw new Error("子类必须实现 seekTo")},setMuted:function(t){throw new Error("子类必须实现 setMuted")},setVolume:function(t){throw new Error("子类必须实现 setVolume")},canHandle:function(){return this.state.hasFile},transformPercentage:function(t){return t},updateState:function(t){this.state=t}},"undefined"!=typeof Howl)u.init();else var o=setInterval(function(){"undefined"!=typeof Howl&&(u.init(),clearInterval(o))},100);function n(t){e.call(this,t)}function a(t,o){e.call(this,t),this.video=o}function r(t){a.call(this,t,t.yyevaVideo),this.yyevaData=t.yyevaData||null,this.effectConfig=t.yyevaEffectConfig||{}}function i(t){a.call(this,t,t.mp4Video)}function s(t){e.call(this,t)}n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.canHandle=function(){return this.state.hasFile&&this.state.lottiePlayer},n.prototype.play=function(){this.state.lottiePlayer.play()},n.prototype.pause=function(){this.state.lottiePlayer.pause()},n.prototype.seekTo=function(t){var e=(this.state.lottiePlayer&&this.state.lottiePlayer.firstFrame||0)+Math.round(t*this.state.totalFrames);this.state.isPlaying?this.state.lottiePlayer.goToAndPlay(e,!0):this.state.lottiePlayer.goToAndStop(e,!0)},n.prototype.setMuted=function(t){},n.prototype.setVolume=function(t){},a.prototype=Object.create(e.prototype),a.prototype.constructor=a,a.prototype.canHandle=function(){return this.state.hasFile&&this.video},a.prototype.play=function(){var t=this;return this.video.play().then(function(){t.afterPlay()}).catch(function(t){console.error("播放失败:",t)})},a.prototype.pause=function(){this.video.pause(),this.afterPause()},a.prototype.seekTo=function(t){var e=this.transformPercentage(t),o=this.video.duration||1;this.video.currentTime=e*o},a.prototype.setMuted=function(t){this.video.muted=t},a.prototype.setVolume=function(t){t=Math.max(0,Math.min(1,t)),this.video.volume=t},a.prototype.afterPlay=function(){},a.prototype.afterPause=function(){},r.prototype=Object.create(a.prototype),r.prototype.constructor=r,r.prototype.updateState=function(t){a.prototype.updateState.call(this,t),this.yyevaData=t.yyevaData||null,this.effectConfig=t.yyevaEffectConfig||{}},r.prototype.afterPlay=function(){this.state.startYyevaRenderLoop&&this.state.startYyevaRenderLoop()},r.prototype.afterPause=function(){this.state.yyevaAnimationId&&(cancelAnimationFrame(this.state.yyevaAnimationId),this.state.yyevaAnimationId=null)},r.prototype.seekTo=function(t){if(a.prototype.seekTo.call(this,t),this.state.renderYyevaFrame){var e=this,o=function(){e.state.renderYyevaFrame(),e.video.removeEventListener("seeked",o)};this.video.seeking?this.video.addEventListener("seeked",o):this.state.renderYyevaFrame()}},r.prototype.setYyevaText=function(t,e){this.effectConfig[t]=this.effectConfig[t]||{},Object.assign(this.effectConfig[t],e),this.state.yyevaEffectConfig&&(this.state.yyevaEffectConfig[t]=this.effectConfig[t])},r.prototype.setYyevaImage=function(t,e){this.effectConfig[t]=this.effectConfig[t]||{},this.effectConfig[t].imageSource=e,this.state.yyevaEffectConfig&&(this.state.yyevaEffectConfig[t]=this.effectConfig[t])},r.prototype.getYyevaEffects=function(){if(!this.yyevaData||!this.yyevaData.effect)return[];var t=[];for(var e in this.yyevaData.effect)t.push({key:e,config:this.yyevaData.effect[e]});return t},r.prototype.hasYyevaData=function(){return null!==this.yyevaData},i.prototype=Object.create(a.prototype),i.prototype.constructor=i,i.prototype.afterPlay=function(){this.state.startMp4ProgressLoop&&this.state.startMp4ProgressLoop()},i.prototype.afterPause=function(){this.state.stopMp4ProgressLoop&&this.state.stopMp4ProgressLoop()},i.prototype.transformPercentage=function(t){if(!this.state.speedRemapConfig||!this.state.speedRemapConfig.enabled||!this.state.speedRemapConfig.keyframes||this.state.speedRemapConfig.keyframes.length<2)return t;for(var e=this.state.speedRemapConfig.keyframes,o=this.state.speedRemapConfig.originalTotalFrames||this.state.totalFrames,n=t*e[e.length-1].position,a=0,r=0;r<e.length-1;r++){var i=e[r],s=e[r+1];if(n>=i.position&&n<=s.position){var u=s.position-i.position;if(u>0){var c=(n-i.position)/u;a=i.originalFrame+c*(s.originalFrame-i.originalFrame)}else a=i.originalFrame;break}}return a/o},s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype.play=function(){this.state.startFramesPlayLoop&&this.state.startFramesPlayLoop()},s.prototype.pause=function(){this.state.stopFramesPlayLoop&&this.state.stopFramesPlayLoop()},s.prototype.seekTo=function(t){var e=Math.round(t*(this.state.totalFrames-1));this.state.seekFramesTo&&this.state.seekFramesTo(e)},s.prototype.setMuted=function(t){},s.prototype.setVolume=function(t){};var u={instances:[],initialized:!1,init:function(){this.initialized=!0},add:function(t){if(t&&(this.instances||(this.instances=[]),-1===this.instances.indexOf(t))){this.instances.push(t);var e=this;if("function"==typeof t.on)try{"object"==typeof t._events&&t.on("unload",function(){e.remove(t)})}catch(t){}}},remove:function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1)},stopAll:function(){this.instances.forEach(function(t){t.playing()&&t.stop()})},pauseAll:function(){this.instances.forEach(function(t){t.playing()&&t.pause()})},muteAll:function(t){this.instances.forEach(function(e){e.mute(t)})},setVolume:function(t){t=Math.max(0,Math.min(1,t)),this.instances.forEach(function(e){e.volume(t)})},getVolume:function(){return this.instances.length>0?this.instances[0].volume():1},unloadAll:function(){this.instances.slice().forEach(function(t){try{t.unload()}catch(t){console.warn("Unload error:",t)}}),this.instances=[]}};function c(t){e.call(this,t),u.init(),this.audioCache={}}function l(t){this.options=t||{},this.onProgressChange=t.onProgressChange||function(){},this.onVolumeChange=t.onVolumeChange||function(){};var e=t.onPlayStateChange||function(){},o=this;this.onPlayStateChange=function(t){o.handlePlayStateChange(t),e(t)},this.getPlayerState=t.getPlayerState||function(){return{}},this.isDragging=!1,this.progressBar=null,this.progressThumb=null,this.isVolumeDragging=!1,this.volumeBar=null,this.volumeThumb=null,this.currentAdapter=null,this.currentMode=null,this.getAdapter=this.getAdapter.bind(this),this.handlePlayStateChange=this.handlePlayStateChange.bind(this),t.progressBar&&t.progressThumb&&this.initProgressDrag(t.progressBar,t.progressThumb),t.volumeBar&&t.volumeThumb&&this.initVolumeDrag(t.volumeBar,t.volumeThumb)}c.prototype=Object.create(e.prototype),c.prototype.constructor=c,c.prototype.canHandle=function(){return this.state.hasFile&&this.state.svgaPlayer},c.prototype.play=function(){try{var t=(this.state.progress||0)/100;u.stopAll(),this.state.svgaPlayer.stepToPercentage(t,!0);var e=t*this.state.totalFrames;this.syncAudio(e),u.muteAll(this.state.isMuted)}catch(t){console.error("播放失败:",t)}},c.prototype.pause=function(){try{this.state.svgaPlayer.pauseAnimation(),u.stopAll()}catch(t){console.error("暂停失败:",t)}},c.prototype.seekTo=function(t,e){try{u.stopAll();var o=this.state.isPlaying&&!e;if(this.state.svgaPlayer.stepToPercentage(t,o),o){var n=t*this.state.totalFrames;this.syncAudio(n),u.muteAll(this.state.isMuted)}}catch(t){console.error("跳转失败:",t)}},c.prototype.syncAudio=function(t){if(this.state.isPlaying){var e=this.state.svgaAudios;if(e&&e.length){this._hasWarnedNoAudio=!1;var o=this.state.videoItem.FPS||30,n=this;e.forEach(function(e){var a="number"==typeof e.startFrame?e.startFrame:0,r="number"==typeof e.endFrame?e.endFrame:0;if(0===r&&(r=n.state.totalFrames||999999),t>=a&&t<r){var i=n.getHowlInstance(e.audioKey);if(i){if(!i.playing()){var s=(t-a)/o,u=(e.startTime||0)/1e3,c=Math.max(0,u+s);i.seek(c),i.play(),i.mute(n.state.isMuted)}}else console.warn("Howl instance not found for:",e.audioKey)}else if(n.audioCache[e.audioKey]){var l=n.audioCache[e.audioKey];l.playing()&&l.stop()}})}}},c.prototype.getHowlInstance=function(t){if(this.audioCache[t])return this.audioCache[t];var e=this.state.svgaAudioData||{},o=this.state.videoItem,n=o&&o.images?o.images:{},a=[t,t+".mp3",t+".wav","audio_"+t,t.replace(/\.[^.]+$/,""),"audio_"+t.replace(/\.[^.]+$/,"")];t.endsWith(".mp3")&&a.push(t.replace(".mp3",""));for(var r=null,i=0;i<a.length;i++)if(e[a[i]]){r=e[a[i]];break}if(!r&&n)for(i=0;i<a.length;i++)if(n[a[i]]){r=n[a[i]];break}if(!r)for(var s=Object.keys(e),c=0;c<s.length;c++){var l=s[c];if(l.length>3&&t.length>3&&(-1!==l.indexOf(t)||-1!==t.indexOf(l))){r=e[l];break}}if(!r)return null;var h=null;if("string"==typeof r)h=r.startsWith("data:")?r:"data:audio/mp3;base64,"+r;else if(r instanceof Uint8Array){var p=new Blob([r],{type:"audio/mp3"});h=URL.createObjectURL(p)}if(!h)return null;var f=new Howl({src:[h],format:["mp3","wav"],html5:!1,loop:!1,autoplay:!1,volume:u.getVolume(),onload:function(){},onloaderror:function(e,o){console.error("Howl Load Error:",o,"for key:",t)},onplayerror:function(e,o){console.error("Howl Play Error:",o,"for key:",t),"undefined"!=typeof Howler&&Howler.ctx&&"suspended"===Howler.ctx.state&&Howler.ctx.resume()}});return u.add(f),this.audioCache[t]=f,f},c.prototype.setMuted=function(t){u.muteAll(t)},c.prototype.setVolume=function(t){u.setVolume(t)},c.prototype.destroy=function(){this.audioCache={}},l.prototype.getAdapter=function(){var t=this.getPlayerState(),e=t.mode;if(this.currentAdapter&&this.currentMode===e)return this.currentAdapter.updateState(t),this.currentAdapter;this.currentAdapter&&(this.currentAdapter.destroy&&this.currentAdapter.destroy(),this.currentAdapter=null);var o=null;switch(e){case"lottie":o=new n(t);break;case"yyeva":o=new r(t);break;case"mp4":o=new i(t);break;case"frames":o=new s(t);break;case"svga":o=new c(t)}return o&&o.canHandle()?(this.currentAdapter=o,this.currentMode=e,o):null},l.prototype.togglePlay=function(){var t=this.getPlayerState(),e=this.getAdapter();if(e)try{t.isPlaying?(e.pause(),this.onPlayStateChange(!1)):(e.play(),this.onPlayStateChange(!0))}catch(t){console.error("播放控制失败:",t)}},l.prototype.seekTo=function(t,e){t=Math.max(0,Math.min(1,t));var o=this.getPlayerState(),n=this.getAdapter();if(n)try{var a=Math.round(100*t),r=n.transformPercentage(t),i=Math.round(r*o.totalFrames);this.onProgressChange(a,i),n instanceof c?n.seekTo(t,e):n.seekTo(t)}catch(t){console.error("跳转失败:",t)}},l.prototype.setMuted=function(t){var e=this.getAdapter();if(e)try{e.setMuted(t)}catch(t){console.error("设置静音失败:",t)}},l.prototype.setVolume=function(t){var e=this.getAdapter();if(e)try{e.setVolume(t)}catch(t){console.error("设置音量失败:",t)}},l.prototype.step=function(t){var e=this.getPlayerState(),o=e.totalDuration||0,n=e.currentTime||0;if(!(o<2)){var a=n+(o<10?1:o<=60?2:5)*t;if(a<0&&(a=0),a>o&&(a=o),o>0){var r=a/o;this.seekTo(r)}}},l.prototype.syncAudio=function(t){var e=this.getAdapter();e&&e instanceof c&&e.syncAudio&&e.syncAudio(t)},l.prototype.handlePlayStateChange=function(t){var e=this.currentAdapter;e&&e instanceof c&&(t||e.pause())},l.prototype.initProgressDrag=function(t,e){var o=this;this.progressBar=t,this.progressThumb=e;var n,a,r,i=function(t){t.preventDefault(),o.isDragging=!0,o.wasPlaying=o.getPlayerState().isPlaying,l(t,!0),document.addEventListener("mousemove",u),document.addEventListener("mouseup",c),document.addEventListener("touchmove",u,{passive:!1}),document.addEventListener("touchend",c)},s=(n=function(t){l(t,!0)},a=50,function(){var t=arguments;r||(n.apply(this,t),r=!0,setTimeout(function(){r=!1},a))}),u=function(t){o.isDragging&&(t.preventDefault(),s(t))},c=function(){if(o.isDragging=!1,document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",c),document.removeEventListener("touchmove",u),document.removeEventListener("touchend",c),o.wasPlaying){var t=o.getAdapter();t&&t.play()}},l=function(t,e){var n=t.clientX||t.touches&&t.touches[0]&&t.touches[0].clientX;if(n){var a=o.progressBar.getBoundingClientRect(),r=(n-a.left)/a.width;o.seekTo(r,e)}};e.addEventListener("mousedown",i),e.addEventListener("touchstart",i,{passive:!1});var h=function(t){t.target===e||e.contains(t.target)||l(t,!1)};t.addEventListener("click",h),this._cleanupDrag=function(){e.removeEventListener("mousedown",i),e.removeEventListener("touchstart",i),t.removeEventListener("click",h),c()}},l.prototype.initVolumeDrag=function(t,e){var o=this;this.volumeBar=t,this.volumeThumb=e;var n,a,r,i=function(t){t.preventDefault(),o.isVolumeDragging=!0,l(t,!0),document.addEventListener("mousemove",u),document.addEventListener("mouseup",c),document.addEventListener("touchmove",u,{passive:!1}),document.addEventListener("touchend",c)},s=(n=function(t){l(t,!0)},a=50,function(){var t=arguments;r||(n.apply(this,t),r=!0,setTimeout(function(){r=!1},a))}),u=function(t){o.isVolumeDragging&&(t.preventDefault(),s(t))},c=function(){o.isVolumeDragging=!1,document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",c),document.removeEventListener("touchmove",u),document.removeEventListener("touchend",c)},l=function(t,e){var n=t.clientY||t.touches&&t.touches[0]&&t.touches[0].clientY;if(n){var a=o.volumeBar.getBoundingClientRect(),r=n-a.top,i=1-Math.max(0,Math.min(1,r/a.height)),s=Math.round(100*i)/100;o.onVolumeChange(s),o.setVolume(s)}};e.addEventListener("mousedown",i),e.addEventListener("touchstart",i,{passive:!1});var h=function(t){t.target===e||e.contains(t.target)||l(t,!1)};t.addEventListener("click",h),this._cleanupVolumeDrag=function(){e.removeEventListener("mousedown",i),e.removeEventListener("touchstart",i),t.removeEventListener("click",h),c()}},l.prototype.destroy=function(){this.currentAdapter&&(this.currentAdapter.destroy&&this.currentAdapter.destroy(),this.currentAdapter=null),this.currentMode=null,this._cleanupDrag&&(this._cleanupDrag(),this._cleanupDrag=null),this.progressBar=null,this.progressThumb=null,this._cleanupVolumeDrag&&(this._cleanupVolumeDrag(),this._cleanupVolumeDrag=null),this.volumeBar=null,this.volumeThumb=null},t.MeeWoo.Controllers.PlayerController=l,t.MeeWoo.Controllers.GlobalAudioManager=u}("undefined"!=typeof window?window:this);