<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>SVGA、带通道MP4、Lottie动画在线预览</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- SVGA / Lottie -->
    <script src="https://cdn.jsdelivr.net/npm/svgaplayerweb@2.3.1/build/svga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.6/lottie.min.js"></script>
    <!-- GIF.js for GIF export -->
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <!-- protobuf.js for SVGA export -->
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
    <!-- pako for zlib compression -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

    <style>
      /* ==================== 全局重置 & 基础布局 ==================== */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        font-family: 'Segoe UI', 'Noto Sans SC', -apple-system, BlinkMacSystemFont,
          sans-serif;
        overflow: hidden;
        background-color: #fcfcfc;
        background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNlM2UzZTMiLz48L3N2Zz4=');
        background-repeat: repeat;
        background-size: 8px 8px;
        transition: background-color 0.3s, background-image 0.3s;
      }

      body.dark-mode {
        background-color: #1a1a1a;
        background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiMzMzMzMzMiLz48L3N2Zz4=');
      }

      #app {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* ==================== 顶部导航栏 ==================== */

      .header-navbar {
        width: 100%;
        height: 36px;
        background-color: #ffffff;
        border-bottom: 1px solid #e3e3e3;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        position: relative;
        z-index: 100;
        transition: background-color 0.3s, border-color 0.3s;
      }

      .nav-link {
        font-family: 'Noto Sans SC', sans-serif;
        font-weight: 400;
        font-size: 12px;
        line-height: 1.2;
        color: #409eff;
        text-decoration: none;
        cursor: pointer;
        transition: opacity 0.3s;
        flex-shrink: 0;
      }

      .nav-link:hover {
        opacity: 0.7;
        text-decoration: underline;
      }

      body.dark-mode .nav-link {
        color: #66b1ff;
      }

      .avatar-link {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
        flex-shrink: 0;
      }

      .avatar-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
        transition: opacity 0.3s;
      }

      .avatar-link:hover .avatar-icon {
        opacity: 0.7;
      }

      body.dark-mode .header-navbar {
        background-color: #2a2a2a;
        border-bottom-color: #404040;
      }

      .header-navbar-title {
        font-family: 'Noto Sans SC', sans-serif;
        font-weight: 900;
        font-size: 12px;
        line-height: 1.2;
        color: #2c3e50;
        transition: color 0.3s;
        flex: 1;
        text-align: center;
      }

      body.dark-mode .header-navbar-title {
        color: #e0e0e0;
      }

      .theme-toggle {
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        cursor: pointer;
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s;
        flex-shrink: 0;
      }

      .theme-toggle:hover {
        opacity: 0.7;
      }

      .theme-toggle svg {
        width: 20px;
        height: 20px;
        fill: #2c3e50;
        transition: fill 0.3s;
      }

      body.dark-mode .theme-toggle svg {
        fill: #e0e0e0;
      }

      /* Tooltip 气泡 */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltip-text {
        visibility: hidden;
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ffffff;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        padding: 8px;
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 12px;
        line-height: 1.33;
        color: #818181;
        white-space: nowrap;
        box-shadow: 0px 6px 10px 0px rgba(51, 51, 51, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s, visibility 0.2s;
      }

      /* 主题切换按钮的 tooltip 在下方 */
      .theme-toggle .tooltip-text {
        bottom: auto;
        top: 125%;
      }

      body.dark-mode .tooltip .tooltip-text {
        background-color: #2a2a2a;
        border-color: #404040;
        color: #999999;
        box-shadow: 0px 6px 10px 0px rgba(0, 0, 0, 0.5);
      }

      .tooltip .tooltip-text::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #ffffff transparent transparent transparent;
      }

      /* 主题切换按钮的箭头在上方 */
      .theme-toggle .tooltip-text::after {
        top: auto;
        bottom: 100%;
        border-color: transparent transparent #ffffff transparent;
      }

      body.dark-mode .tooltip .tooltip-text::after {
        border-color: #2a2a2a transparent transparent transparent;
      }

      body.dark-mode .theme-toggle .tooltip-text::after {
        border-color: transparent transparent #2a2a2a transparent;
      }

      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }

      /* Help 按钮样式 */
      .help-button {
        width: 40px;
        height: 40px;
        border: none;
        background: none;
        cursor: pointer;
        outline: none;
        position: fixed;
        right: 8px;
        top: 44px;
        z-index: 1000;
      }

      .help-button:hover .help-popup {
        visibility: visible;
        opacity: 1;
      }

      .help-popup {
        visibility: hidden;
        opacity: 0;
        position: fixed;
        top: 92px;
        right: 8px;
        width: 360px;
        max-height: 70vh;
        background: #FFFFFF;
        border: 1px solid #E3E3E3;
        box-shadow: 0px 2px 8px rgba(51, 51, 51, 0.2);
        border-radius: 16px;
        padding: 24px;
        overflow-y: auto;
        z-index: 2000;
        transition: opacity 0.2s, visibility 0.2s;
        font-family: 'Segoe UI', 'Noto Sans SC', sans-serif;
        font-size: 13px;
        line-height: 2;
        color: #5b5b5b;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .help-popup ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
      }

      .help-popup li {
        margin-bottom: 8px;
      }

      .help-popup::-webkit-scrollbar {
        display: none;
      }

      body.dark-mode .help-popup {
        background: #2a2a2a;
        border-color: #404040;
        color: #999999;
        box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.5);
      }

      /* ==================== 主页面容器 ==================== */

      .main-page {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        position: relative;
      }

      /* 播放区域 */
      .viewer-area {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0px 200px 20px;
        position: relative;
      }

      .viewer-area.drag-hover {
        outline: 2px dashed #5b5b5b;
        outline-offset: -10px;
      }

      .viewer-container {
        position: relative;
        transform-origin: center center;
        display: flex;
        align-items: center;
        justify-content: center;
        /* transform 动态注入 */
        /* width 和 height 通过 style 动态设置 */
      }

      .viewer-canvas {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .viewer-canvas canvas {
        transition: background-color 0.3s;
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        transform: none !important;
        margin: 0 !important;
      }

      /* 空状态覆盖层 */
      .empty-state-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      .empty-state-icon {
        width: 100px;
        height: 100px;
        margin-bottom: 8px;
      }

      .empty-state-icon svg {
        width: 100%;
        height: 100%;
      }

      .empty-state-text {
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 20px;
        line-height: 1.33;
        color: #5b5b5b;
        text-align: center;
        pointer-events: auto;
      }

      .empty-state-text em {
        font-style: normal;
        font-weight: 700;
        color: #333333;
      }

      /* ==================== 底部浮层 ==================== */

      .footer-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 154px;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: center;
        padding: 10px;
        gap: 10px;
        transition: background-color 0.3s;
      }

      /* 广告位 */
      .ad-slot {
        display: none;
        width: 240px;
        height: 134px;
        background-color: #b1b1b1;
        border-radius: 4px;
        flex-shrink: 0;
      }

      /* 底部主控制区 */
      .footer-main {
        flex: 0 1 auto;
        min-width: 1000px;
        max-width: fit-content;
        height: 134px;
        background-color: #ffffff;
        border: 1px solid #e3e3e3;
        border-radius: 16px;
        box-shadow: 0px 10px 32px 0px rgba(51, 51, 51, 0.2);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
      }

      body.dark-mode .footer-main {
        background-color: #2a2a2a;
        border-color: #404040;
        box-shadow: 0px 10px 32px 0px rgba(0, 0, 0, 0.5);
      }

      /* 第一行：模块切换 + 清空按钮 */
      .footer-row-tabs {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        height: 28px;
      }

      .footer-tabs {
        display: flex;
        flex-direction: row;
        gap: 16px;
      }

      .footer-actions {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
      }

      .tab-btn {
        height: 28px;
        padding: 0 8px;
        border-radius: 8px;
        border: 1px solid #f3f3f3;
        background-color: #ffffff;
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 1.33;
        color: #333333;
        cursor: pointer;
        outline: none;
        transition: all 0.2s;
      }

      body.dark-mode .tab-btn {
        border-color: #404040;
        background-color: #1a1a1a;
        color: #e0e0e0;
      }

      .tab-btn:hover {
        background-color: #fcfcfc;
        border-color: #e3e3e3;
      }

      body.dark-mode .tab-btn:hover {
        background-color: #333333;
        border-color: #555555;
      }

      .tab-btn.is-active {
        background-color: #5b5b5b;
        border-color: #5b5b5b;
        color: #ffffff;
      }

      body.dark-mode .tab-btn.is-active {
        background-color: #666666;
        border-color: #666666;
      }

      .tab-btn.is-active:hover {
        border-color: #333333;
      }

      .tab-btn.is-active:active {
        background-color: #333333;
      }

      .close-btn {
        width: 28px;
        height: 28px;
        border: none;
        background-color: transparent;
        cursor: pointer;
        outline: none;
        position: relative;
      }

      .close-btn::before,
      .close-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 14px;
        height: 2px;
        background-color: #d3d3d3;
        transition: background-color 0.2s;
      }

      .close-btn::before {
        transform: translate(-50%, -50%) rotate(45deg);
      }

      .close-btn::after {
        transform: translate(-50%, -50%) rotate(-45deg);
      }

      .close-btn:hover::before,
      .close-btn:hover::after {
        background-color: #5b5b5b;
      }

      .close-btn:active::before,
      .close-btn:active::after {
        background-color: #333333;
      }

      /* 第二行：文件信息 */
      .footer-row-info {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
      }

      .info-item {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0;
      }

      .info-item-label {
        font-family: 'Segoe UI', sans-serif;
        font-style: normal;
        font-weight: 400;
        font-size: 14px;
        line-height: 22px;
        color: #818181;
        flex-shrink: 0;
        transition: color 0.3s;
      }

      body.dark-mode .info-item-label {
        color: #999999;
      }

      .info-item-value {
        font-family: 'Segoe UI', sans-serif;
        font-style: normal;
        font-weight: 600;
        font-size: 14px;
        line-height: 22px;
        color: #333333;
        transition: color 0.3s;
      }

      body.dark-mode .info-item-value {
        color: #e0e0e0;
      }

      /* 第三行：控制区域 */
      .footer-row-controls {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .controls-left {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }

      .controls-center {
        flex: 1;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .controls-right {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 6px;
      }

      /* 颜色选择按钮 */
      .color-btn {
        width: 28px;
        height: 28px;
        border-radius: 16px;
        border: 1px solid #e3e3e3;
        cursor: pointer;
        outline: none;
        transition: border-color 0.2s;
      }

      .color-btn:hover {
        border-color: #5b5b5b;
      }

      .color-btn.is-active {
        border-color: #333333;
        border-width: 2px;
      }

      /* 播放/暂停按钮 */
      .play-btn {
        width: 28px;
        height: 28px;
        border-radius: 16px;
        border: none;
        background-color: #5b5b5b;
        cursor: pointer;
        outline: none;
        position: relative;
        transition: all 0.2s;
      }

      .play-btn:hover {
        border: 1px solid #333333;
      }

      .play-btn:active {
        background-color: #333333;
      }

      .play-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-40%, -50%);
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 6px 0 6px 10px;
        border-color: transparent transparent transparent #ffffff;
      }

      .play-btn.is-playing::before {
        border: none;
        width: 8px;
        height: 12px;
        background: linear-gradient(
          to right,
          #ffffff 0,
          #ffffff 3px,
          transparent 3px,
          transparent 5px,
          #ffffff 5px,
          #ffffff 8px
        );
        transform: translate(-50%, -50%);
      }

      /* 进度条 */
      .progress-bar {
        width: 200px;
        height: 16px;
        background-color: #f3f3f3;
        border-radius: 0;
        border: 1px solid #e3e3e3;
        position: relative;
        cursor: pointer;
      }

      .progress-bar:hover {
        border-color: #5b5b5b;
      }

      .progress-fill {
        height: 100%;
        background-color: #409eff;
        border-radius: 0;
        transition: width 0.1s;
      }

      .progress-text {
        margin-left: 8px;
        width: 60px;
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 14px;
        line-height: 1.33;
        color: #818181;
        white-space: nowrap;
        text-align: left;
      }

      /* 通用按钮 */
      .btn-primary,
      .btn-secondary {
        height: 28px;
        padding: 0 16px;
        border-radius: 8px;
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 14px;
        line-height: 1.57;
        text-align: center;
        cursor: pointer;
        outline: none;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .btn-primary {
        background-color: #ffffff;
        border: 1px solid #e3e3e3;
        color: #333333;
      }

      body.dark-mode .btn-primary {
        background-color: #1a1a1a;
        border-color: #404040;
        color: #e0e0e0;
      }

      .btn-primary:hover {
        background-color: #e3e3e3;
        border-color: #5b5b5b;
      }

      body.dark-mode .btn-primary:hover {
        background-color: #333333;
        border-color: #666666;
      }

      .btn-primary:active {
        background-color: #d3d3d3;
        border-color: #333333;
      }

      body.dark-mode .btn-primary:active {
        background-color: #404040;
        border-color: #888888;
      }

      .btn-secondary {
        background-color: #5b5b5b;
        border: 1px solid #5b5b5b;
        color: #ffffff;
      }

      .btn-secondary:hover {
        background-color: #5b5b5b;
        border-color: #333333;
      }

      .btn-secondary:active {
        background-color: #333333;
        border-color: #333333;
      }

      /* 缩放按钮 */
      .zoom-btn {
        width: 28px;
        height: 28px;
        border: none;
        background-color: transparent;
        cursor: pointer;
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
        position: relative;
      }
      
      /* 百分比显示 */
      .scale-percentage {
        width: 60px;
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 14px;
        line-height: 1.33;
        color: #818181;
        text-align: right;
        transition: color 0.3s;
      }

      body.dark-mode .scale-percentage {
        color: #999999;
      }
      
      .zoom-icon {
        width: 28px;
        height: 28px;
        display: block;
        transition: opacity 0.2s;
      }
      
      /* 放大按钮 hover 状态 */
      .zoom-btn:hover .zoom-icon {
        opacity: 0;
      }
      
      .zoom-btn::after {
        content: '';
        position: absolute;
        width: 28px;
        height: 28px;
        opacity: 0;
        transition: opacity 0.2s;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
      }
      
      .zoom-btn:hover::after {
        opacity: 1;
      }
      
      /* 浅色模式下的 hover 图标 */
      .zoom-btn:hover::after {
        background-image: var(--zoom-hover-icon);
      }
      
      /* 暗黑模式下的 hover 图标 */
      body.dark-mode .zoom-btn:hover::after {
        background-image: var(--zoom-hover-icon-dark);
      }
      
      /* 1:1按钮 */
      .reset-scale-btn {
        width: 28px;
        height: 28px;
        border: none;
        background-color: transparent;
        cursor: pointer;
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin-left: 4px;
        position: relative;
      }
      
      .one-to-one-icon {
        width: 28px;
        height: 28px;
        display: block;
        transition: opacity 0.2s;
      }
      
      /* 1:1 按钮 hover 状态 */
      .reset-scale-btn:hover .one-to-one-icon {
        opacity: 0;
      }
      
      .reset-scale-btn::after {
        content: '';
        position: absolute;
        width: 28px;
        height: 28px;
        opacity: 0;
        transition: opacity 0.2s;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
      }
      
      .reset-scale-btn:hover::after {
        opacity: 1;
      }
      
      /* 浅色模式下的 hover 图标 */
      .reset-scale-btn:hover::after {
        background-image: url('assets/img/one2one_hover.png');
      }
      
      /* 暗黑模式下的 hover 图标 */
      body.dark-mode .reset-scale-btn:hover::after {
        background-image: url('assets/img/one2one_hover_dark.png');
      }

/* 清空/关闭按钮 (btn03样式) */
      .clear-btn {
        width: 32px;
        height: 28px;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        background-color: #ffffff;
        cursor: pointer;
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, border-color 0.2s;
        position: relative;
      }

      .clear-btn:hover {
        background-color: #e3e3e3;
        border-color: #5b5b5b;
      }

      .clear-btn:active {
        background-color: #d3d3d3;
        border-color: #333333;
      }

      .clear-btn svg {
        width: 24px;
        height: 24px;
      }

      .clear-btn svg path {
        stroke: #333333;
        transition: stroke 0.3s;
      }

      body.dark-mode .clear-btn {
        background-color: #1a1a1a;
        border-color: #404040;
      }

      body.dark-mode .clear-btn:hover {
        background-color: #333333;
        border-color: #666666;
      }

      body.dark-mode .clear-btn:active {
        background-color: #404040;
        border-color: #888888;
      }

      body.dark-mode .clear-btn svg path {
        stroke: #e0e0e0;
      }

      /* 空状态底部提示 */
      .footer-empty-tip {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 16px;
      }

      .footer-empty-tip-main {
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 16px;
        line-height: 1.33;
        color: #000000;
        transition: color 0.3s;
      }

      body.dark-mode .footer-empty-tip-main {
        color: #e0e0e0;
      }

      .footer-empty-tip-sub {
        font-family: 'Segoe UI', sans-serif;
        font-weight: 400;
        font-size: 14px;
        line-height: 1.33;
        color: #80868c;
        transition: color 0.3s;
      }

      body.dark-mode .footer-empty-tip-sub {
        color: #999999;
      }

      /* ==================== 素材弹窗 ==================== */

      .material-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        width: 380px;
        height: 100%;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 10px;
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
      }

      .material-panel.show {
        right: 0;
      }

      .material-panel-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        width: 380px;
        padding: 20px;
        gap: 16px;
        width: 360px;
        height: 100%;
        max-height: 100%;
        background: #FFFFFF;
        border: 1px solid #E3E3E3;
        box-shadow: 0px 10px 32px rgba(51, 51, 51, 0.2);
        border-radius: 16px;
        flex: none;
        align-self: stretch;
      }

      body.dark-mode .material-panel-container {
        background: #1a1a1a;
        border-color: #404040;
        box-shadow: 0px 10px 32px rgba(0, 0, 0, 0.5);
      }

      /* 顶部统计信息 */
      .material-panel-stats {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 0px;
        gap: 8px;
        width: 320px;
        flex: none;
        order: 0;
        align-self: stretch;
        transition: color 0.3s;
      }
      
      .stats-title {
        width: 320px;
        height: 19px;
        font-family: 'Segoe UI';
        font-style: normal;
        font-weight: 400;
        font-size: 14px;
        line-height: 19px;
        display: flex;
        align-items: center;
        color: #333333;
        flex: none;
        order: 0;
        align-self: stretch;
        transition: color 0.3s;
      }
      
      body.dark-mode .stats-title {
        color: #e0e0e0;
      }
      
      .stats-help {
        width: 320px;
        font-family: 'Segoe UI';
        font-style: normal;
        font-weight: 400;
        font-size: 12px;
        line-height: 20px;
        display: flex;
        align-items: center;
        color: #818181;
        flex: none;
        order: 1;
        align-self: stretch;
        transition: color 0.3s;
      }
      
      body.dark-mode .stats-help {
        color: #999999;
      }
      
      /* 搜索框 */
      .material-search {
        width: 320px;
        margin-top: 0;
        flex: none;
        order: 1;
        align-self: stretch;
      }
      
      .material-search-input {
        width: 100%;
        height: 32px;
        padding: 0 12px;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        font-family: 'Segoe UI';
        font-size: 14px;
        color: #333333;
        background: #ffffff;
        outline: none;
        transition: all 0.3s;
      }
      
      .material-search-input::placeholder {
        color: #999999;
      }
      
      .material-search-input:focus {
        border-color: #00b4ff;
      }
      
      body.dark-mode .material-search-input {
        background: #2a2a2a;
        border-color: #444444;
        color: #e0e0e0;
      }
      
      body.dark-mode .material-search-input::placeholder {
        color: #666666;
      }
      
      body.dark-mode .material-search-input:focus {
        border-color: #00b4ff;
      }

      /* 滚动区域 */
      .material-panel-scroll {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        min-height: auto;
        align-items: flex-start;
        align-content: flex-start;
        padding: 0px;
        gap: 16px 10px;
        width: 100%;
        flex: 1;
        min-height: 0;
        overflow-y: overlay;
        overflow-x: hidden;
      }

      /* 滚动条样式 - 默认隐藏 */
      .material-panel-scroll::-webkit-scrollbar {
        width: 6px;
      }

      .material-panel-scroll::-webkit-scrollbar-track {
        background: transparent;
      }

      .material-panel-scroll::-webkit-scrollbar-thumb {
        background: transparent;
        border-radius: 3px;
        transition: background 0.2s;
      }

      .material-panel-scroll:hover::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
      }

      .material-panel-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }

      body.dark-mode .material-panel-scroll:hover::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
      }

      body.dark-mode .material-panel-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .material-list {
        display: contents;
      }

      /* 素材卡片（列表样式）*/
      .material-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
        width: 161px;
        align-items: flex-start;
        padding: 0px;
        gap: 10px;
        width: 150px;
        height: auto;
        flex: none;
      }

      /* 缩略图 */
      .material-thumb {
        width: 161px;
        height: 100px;
        /* background 由 Vue 动态绑定 */
        flex: none;
        order: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: background-color 0.3s;
      }

.material-thumb img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      /* 素材信息区 (Frame 17) */
      .material-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        width: 161px;
        align-items: flex-start;
        padding: 0px;
        gap: 4px;
        width: 155px;
        height: 59px;
        flex: none;
        order: 1;
        align-self: stretch;
      }

      /* 素材名称行 */
      .material-name-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 4px;
        width: 150px;
        flex: none;
        order: 0;
        align-self: stretch;
      }
      
      .material-name {
        flex: 1;
        height: 19px;
        font-family: 'Segoe UI';
        font-style: normal;
        font-weight: 400;
        font-size: 14px;
        line-height: 19px;
        display: flex;
        align-items: center;
        color: #333333;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        transition: color 0.3s;
      }

      body.dark-mode .material-name {
        color: #e0e0e0;
      }
      
      /* 复制按钮 */
      .material-btn-copy {
        width: 20px;
        height: 20px;
        padding: 0;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        opacity: 0.6;
        transition: opacity 0.3s;
      }
      
      .material-btn-copy:hover {
        opacity: 1;
      }
      
      .material-btn-copy svg rect {
        transition: stroke 0.3s, fill 0.3s;
      }
      
      body.dark-mode .material-btn-copy svg rect {
        stroke: #999999;
        fill: #2a2a2a;
      }
      
      body.dark-mode .material-btn-copy svg rect:first-child {
        fill: none;
      }

      .material-meta {
        width: 150px;
        height: 16px;
        font-family: 'Segoe UI';
        font-style: normal;
        font-weight: 400;
        font-size: 12px;
        line-height: 16px;
        display: flex;
        align-items: center;
        color: #333333;
        flex: none;
        align-self: stretch;
      }

      body.dark-mode .material-meta {
        color: #8e8e93;
      }

      /* 操作按钮区 (Frame 29) */
      .material-actions {
        width: 161px;
        height: 28px;
        flex: none;
        order: 2;
        align-self: stretch;
        position: relative;
      }

      /* 替换按钮 (btn01_Medium) */
      .material-btn-replace {
        box-sizing: border-box;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        padding: 6px;
        width: auto;
        gap: 10px;
        position: absolute;
        width: 97px;
        min-width: 60px;
        height: 28px;
        left: 0px;
        top: 0px;
        background: #FFFFFF;
        border: 1px solid #E3E3E3;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .material-btn-replace span {
        width: 65px;
        min-width: 50px;
        height: 22px;
        font-family: 'Segoe UI';
        font-style: normal;
        font-weight: 400;
        font-size: 13px;
        line-height: 22px;
        display: flex;
        align-items: center;
        text-align: center;
        color: #333333;
        flex: none;
        order: 0;
      }

      .material-btn-replace:hover {
        background: #F5F5F7;
        border-color: #CCCCCC;
      }

      .material-btn-replace:active {
        background: #E8E8ED;
        transform: scale(0.98);
      }

      body.dark-mode .material-btn-replace {
        background: #2d2d2d;
        border-color: #505050;
      }

      body.dark-mode .material-btn-replace span {
        color: #e0e0e0;
      }

      body.dark-mode .material-btn-replace:hover {
        background: #3a3a3a;
        border-color: #606060;
      }

      /* 关闭/恢复按钮 (btn03_Medium) */
      .material-btn-close {
        box-sizing: border-box;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        border-radius: 8px;
        padding: 0px 4px;
        gap: 10px;
        position: absolute;
        width: 32px;
        height: 28px;
        left: 123px;
        top: 0px;
        background: #FFFFFF;
        border: 1px solid #E3E3E3;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .material-btn-close svg {
        width: 24px;
        height: 24px;
        flex: none;
        order: 0;
      }

      .material-btn-close:hover {
        background: #F5F5F7;
        border-color: #CCCCCC;
      }

      .material-btn-close:active {
        background: #E8E8ED;
        transform: scale(0.95);
      }

      body.dark-mode .material-btn-close {
        background: #2d2d2d;
        border-color: #505050;
      }

      body.dark-mode .material-btn-close:hover {
        background: #3a3a3a;
        border-color: #606060;
      }

      /* 底部按钮区 */
      .material-panel-footer {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0px;
        gap: 12px;
        width: 100%;
        height: auto;
        flex: none;
        order: 2;
      }

      /* 返回按钮 */
      .material-btn-back {
        box-sizing: border-box;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        padding: 0px;
        width: 48px;
        height: 44px;
        background: #FFFFFF;
        border: 1px solid #E3E3E3;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }

      .material-btn-back:hover {
        background: #E3E3E3;
        border-color: #5B5B5B;
      }

      .material-btn-back:active {
        background: #D3D3D3;
        border-color: #333333;
      }

      body.dark-mode .material-btn-back {
        background: #2d2d2d;
        border-color: #505050;
      }

      body.dark-mode .material-btn-back:hover {
        background: #3a3a3a;
        border-color: #606060;
      }

      /* 导出新SVGA按钮 (btn02_Large) */
      .material-btn-export {
        box-sizing: border-box;
        flex: 1;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        padding: 0px 20px;
        gap: 10px;
        width: 90px;
        min-width: 60px;
        height: 44px;
        background: #5B5B5B;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.15s ease;
        font-family: 'Segoe UI';
        font-size: 14px;
        font-weight: 400;
        color: #FFFFFF;
      }

      .material-btn-export:hover:not(:disabled) {
        background: #5B5B5B;
        border: 1px solid #333333;
      }

      .material-btn-export:active:not(:disabled) {
        background: #333333;
        border: 1px solid #333333;
      }

      .material-btn-export:disabled {
        background: rgba(91, 91, 91, 0.3);
        border: none;
        color: #FFFFFF;
        cursor: not-allowed;
      }

      body.dark-mode .material-btn-export {
        background: #e0e0e0;
        color: #000000;
      }

      body.dark-mode .material-btn-export:hover:not(:disabled) {
        background: #f0f0f0;
      }

      body.dark-mode .material-btn-export:active:not(:disabled) {
        background: #d0d0d0;
      }

      .material-empty {
        width: 100%;
        text-align: center;
        padding: 60px 20px;
        color: #999999;
        font-family: 'Segoe UI';
        font-size: 14px;
      }

      body.dark-mode .material-empty {
        color: #666;
      }

      /* 遮罩层 - 隐藏 */
      .material-overlay {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <!-- 顶部导航栏 -->
      <div class="header-navbar">
        <a href="avatar_auto.html" class="nav-link">大R头像框自助</a>
        <div class="header-navbar-title">
          SVGA、带通道MP4、Lottie动画在线预览
        </div>
        <button class="theme-toggle tooltip" @click="toggleTheme">
          <span class="tooltip-text">{{ isDarkMode ? '切换到白天模式' : '切换到暗黑模式' }}</span>
          <svg v-if="!isDarkMode" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <!-- 太阳图标 -->
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <svg v-else viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <!-- 月亮图标 -->
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
        <a href="https://saysth.design/" target="_blank" class="avatar-link">
          <img src="./assets/img/toux.png" alt="" class="avatar-icon">
        </a>
      </div>

      <!-- Help 按钮 -->
      <div class="help-button">
        <img src="./assets/img/help.png" alt="帮助" style="width: 40px; height: 40px;">
        <div class="help-popup" v-html="helpContent"></div>
      </div>

      <!-- 主页面 -->
      <div class="main-page">
        <!-- 播放区域 -->
        <div
          class="viewer-area"
          :class="{'drag-hover': dropHover}"
          @dragover.prevent="onDragOver"
          @dragleave="onDragLeave"
          @drop.prevent="onDrop"
          @wheel="onWheel"
          @mousedown="onMouseDown"
          @mousemove="onMouseMove"
          @mouseup="onMouseUp"
          @mouseleave="onMouseUp"
        >
          <div
            class="viewer-container"
            :style="viewerContainerStyle"
          >
            <div
              ref="svgaContainer"
              class="viewer-canvas"
            ></div>
          </div>

          <!-- 空状态覆盖层 -->
          <div v-if="isEmpty" class="empty-state-overlay">
            <div class="empty-state-icon">
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M12.5 4.17L87.5 4.17L87.5 79.17L25 95.83L12.5 79.17L12.5 4.17Z"
                  fill="none"
                  stroke="#D3D3D3"
                  stroke-width="2"
                />
                <path
                  d="M25 79.17L25 95.83M25 79.17L87.5 79.17M25 79.17L12.5 79.17"
                  stroke="#D3D3D3"
                  stroke-width="2"
                />
              </svg>
            </div>
            <div class="empty-state-text" @click="triggerFileUpload" style="cursor: pointer;">
              将文件拖到此处预览动画,或<em>点击上传</em>
            </div>
            <input
              ref="fileInput"
              type="file"
              accept=".svga,.json,.mp4"
              style="display: none;"
              @change="onFileSelect"
            />
          </div>
        </div>

        <!-- 底部浮层 -->
        <div class="footer-bar">
          <!-- 左侧广告位 -->
          <div class="ad-slot"></div>

          <!-- 中间主控制区 -->
          <div class="footer-main">
            <!-- 空状态 -->
            <template v-if="isEmpty">
              <div class="footer-empty-tip">
                <div class="footer-empty-tip-main">请将文件拖到上面</div>
                <div class="footer-empty-tip-sub">
                  支持文件包括：.svga、.json、MP4
                </div>
              </div>
            </template>

            <!-- 非空状态 -->
            <template v-else>
              <!-- 第一行：播放控制 + 背景色选择 + 缩放控制 -->
              <div class="footer-row-controls">
                <div class="controls-left">
                  <button
                    class="play-btn"
                    :class="{'is-playing': isPlaying}"
                    @click="togglePlay"
                  ></button>
                  <div class="progress-bar" @click="onProgressBarClick">
                    <div
                      class="progress-fill"
                      :style="{width: progress + '%'}"
                    ></div>
                  </div>
                  <div class="progress-text">
                    {{ currentFrame }}/{{ totalFrames }}
                  </div>
                </div>
                <div class="controls-center">
                  <button
                    class="color-btn"
                    :class="{'is-active': bgColorKey === 'black'}"
                    style="background-color: #000000"
                    @click="bgColorKey = 'black'"
                  ></button>
                  <button
                    class="color-btn"
                    :class="{'is-active': bgColorKey === 'white'}"
                    style="background-color: #ffffff"
                    @click="bgColorKey = 'white'"
                  ></button>
                  <button
                    class="color-btn"
                    :class="{'is-active': bgColorKey === 'green'}"
                    style="background-color: #00ff00"
                    @click="bgColorKey = 'green'"
                  ></button>
                  <button
                    class="color-btn"
                    :class="{'is-active': bgColorKey === 'red'}"
                    style="background-color: #df3321"
                    @click="bgColorKey = 'red'"
                  ></button>
                  <button
                    class="color-btn"
                    :class="{'is-active': bgColorKey === 'yellow'}"
                    style="background-color: #f1c40d"
                    @click="bgColorKey = 'yellow'"
                  ></button>
                  <button
                    class="color-btn"
                    :class="{'is-active': bgColorKey === 'blue'}"
                    style="background-color: #00b4ff"
                    @click="bgColorKey = 'blue'"
                  ></button>
                  <button
                    class="color-btn"
                    :class="{'is-active': bgColorKey === 'pattern'}"
                    style="
                      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNlM2UzZTMiLz48L3N2Zz4=');
                      background-repeat: repeat;
                      background-size: 8px 8px;
                    "
                    @click="bgColorKey = 'pattern'"
                  ></button>
                </div>
                <div class="controls-right">
                  <div class="scale-percentage">{{ Math.round(viewerScale * 100) }}%</div>
                  <button 
                    class="zoom-btn" 
                    @click="zoomOut" 
                    title="缩小"
                    :style="{
                      '--zoom-hover-icon': 'url(assets/img/zoom_out_hover.png)',
                      '--zoom-hover-icon-dark': 'url(assets/img/zoom_out_hover_dark.png)'
                    }"
                  >
                    <img :src="zoomOutIcon" class="zoom-icon" />
                  </button>
                  <button 
                    class="zoom-btn" 
                    @click="zoomIn" 
                    title="放大"
                    :style="{
                      '--zoom-hover-icon': 'url(assets/img/zoom_in_hover.png)',
                      '--zoom-hover-icon-dark': 'url(assets/img/zoom_in_hover_dark.png)'
                    }"
                  >
                    <img :src="zoomInIcon" class="zoom-icon" />
                  </button>
                  <button class="reset-scale-btn" @click="resetScale" title="恢复1:1尺寸">
                    <img :src="oneToOneIcon" class="one-to-one-icon" />
                  </button>
                </div>
              </div>

              <!-- 第二行：文件信息 -->
              <div class="footer-row-info">
                <div class="info-item" v-if="currentFileInfo.name">
                  <span class="info-item-label">文件名称：</span>
                  <span class="info-item-value">{{ currentFileInfo.name }}</span>
                </div>
                <div class="info-item" v-if="currentFileInfo.sizeText">
                  <span class="info-item-label">文件大小：</span>
                  <span class="info-item-value">{{ currentFileInfo.sizeText }}</span>
                </div>
                <div class="info-item" v-if="currentFileInfo.fps">
                  <span class="info-item-label">帧率：</span>
                  <span class="info-item-value">{{ currentFileInfo.fps }}</span>
                </div>
                <div class="info-item" v-if="currentFileInfo.sizeWH">
                  <span class="info-item-label">尺寸：</span>
                  <span class="info-item-value">{{ currentFileInfo.sizeWH }}</span>
                </div>
                <div class="info-item" v-if="currentFileInfo.duration">
                  <span class="info-item-label">时长：</span>
                  <span class="info-item-value">{{ currentFileInfo.duration }}</span>
                </div>
                <div class="info-item" v-if="currentFileInfo.memoryText">
                  <span class="info-item-label">内存占用：</span>
                  <span class="info-item-value">{{ currentFileInfo.memoryText }}</span>
                </div>
              </div>

              <!-- 第三行：模块切换 + 操作按钮 -->
              <div class="footer-row-tabs">
                <div class="footer-tabs">
                  <button
                    class="tab-btn"
                    :class="{'is-active': currentModule === 'svga'}"
                    @click="switchModule('svga')"
                  >
                    SVGA
                  </button>
                  <button
                    class="tab-btn tooltip"
                    :class="{'is-active': currentModule === 'yyeva'}"
                    @click="switchModule('yyeva')"
                  >
                    <span class="tooltip-text">还在开发中...</span>
                    YYEVA-MP4
                  </button>
                  <button
                    class="tab-btn tooltip"
                    :class="{'is-active': currentModule === 'lottie'}"
                    @click="switchModule('lottie')"
                  >
                    <span class="tooltip-text">还在开发中...</span>
                    Lottie
                  </button>
                </div>
                <div class="footer-actions">
                  <button class="clear-btn" @click="clearAll" title="清空画布">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M17 7L7 17" stroke="#333333" stroke-width="1.5" stroke-linecap="round"/>
                      <path d="M7 7L17 17" stroke="#333333" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </button>
                  <button class="btn-primary" @click="triggerReuploadSVGA" v-if="currentModule === 'svga' && svga.hasFile">
                    重传SVGA
                  </button>
                  <button class="btn-primary" @click="openMaterialPanel" v-if="currentModule === 'svga' && svga.hasFile">
                    素材图...
                  </button>
                  <button class="btn-primary tooltip" v-else>
                    <span class="tooltip-text">请先拖入 SVGA 文件</span>
                    素材图...
                  </button>
                  <button 
                    class="btn-primary"
                    :class="{'tooltip': !svga.hasFile}"
                    :disabled="!svga.hasFile || isExportingGIF"
                    @click="exportGIF"
                  >
                    <span v-if="!svga.hasFile" class="tooltip-text">请先拖入 SVGA 文件</span>
                    {{ isExportingGIF ? '导出中 ' + gifExportProgress + '%' : '导出GIF' }}
                  </button>
                  <button class="btn-secondary tooltip">
                    <span class="tooltip-text">还在开发中...</span>
                    转MP4
                  </button>
                </div>
              </div>
            </template>
          </div>

          <!-- 右侧广告位 -->
          <div class="ad-slot"></div>
        </div>
      </div>

      <!-- 素材弹窗 -->
      <div class="material-overlay" :class="{'show': showMaterialPanel}" @click="closeMaterialPanel"></div>
      <div class="material-panel" :class="{'show': showMaterialPanel}">
        <div class="material-panel-container">
          <!-- 顶部统计信息 -->
          <div class="material-panel-stats">
            <div class="stats-title">图像资源: {{ materialList.length }} 个    内存占用: {{ svga.fileInfo.memoryText }}</div>
            <div class="stats-help">你可以替换素材图片，然后导出新的SVGA。<br>选择替换的图片尺寸尽量和原图一致，否则会出现错位问题。</div>
          </div>
          
          <!-- 搜索框 -->
          <div class="material-search">
            <input 
              type="text" 
              class="material-search-input" 
              placeholder="搜索素材名称..." 
              v-model="materialSearchQuery"
            />
          </div>
          
          <!-- 素材列表 -->
          <div class="material-panel-scroll">
            <div v-if="filteredMaterialList.length === 0" class="material-empty">
              {{ materialSearchQuery ? '未找到匹配的素材' : '未检测到素材图片' }}
            </div>
            <div v-else class="material-list">
              <div 
                v-for="(item, index) in filteredMaterialList" 
                :key="item.imageKey"
                class="material-item"
              >
                <div class="material-thumb" :style="{ backgroundColor: materialThumbBgColor }">
                  <img :src="item.previewUrl" v-if="item.previewUrl" />
                </div>
                <div class="material-info">
                  <div class="material-name-row">
                    <div class="material-name" :title="item.imageKey">{{ item.imageKey }}</div>
                    <button class="material-btn-copy" @click="copyMaterialName(item.imageKey)" title="复制名称">
                      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4" y="4" width="8" height="8" rx="1" stroke="#666666" stroke-width="1.2" fill="none"/>
                        <rect x="2" y="2" width="8" height="8" rx="1" stroke="#666666" stroke-width="1.2" fill="#ffffff"/>
                      </svg>
                    </button>
                  </div>
                  <div class="material-meta">文件大小：{{ item.fileSizeText }}</div>
                  <div class="material-meta">尺寸：{{ item.sizeText }}</div>
                </div>
                <div class="material-actions">
                  <button class="material-btn-replace" @click="replaceMaterial(index)">
                    <span>替换此图片</span>
                  </button>
                  <button 
                    v-if="item.isReplaced" 
                    class="material-btn-close" 
                    @click="restoreMaterial(index)"
                    title="恢复原图"
                  >
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                      <circle cx="12" cy="12" r="6" stroke="#333333" stroke-width="1.3"/>
                      <path d="M14.5 10L17 12.5" stroke="#333333" stroke-width="1.3"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 底部操作按钮 -->
          <div class="material-panel-footer">
            <button class="material-btn-back" @click="closeMaterialPanel" title="关闭">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M12 16L6 10L12 4" stroke="#333333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button class="material-btn-export" @click="exportNewSVGA" :disabled="!hasReplacedMaterials">
              导出新SVGA
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      new Vue({
        el: '#app',
        data: function () {
          return {
            currentModule: 'svga', // 'svga' | 'yyeva' | 'lottie'
            dropHover: false,

            // 视图操作（缩放 + 平移）
            viewerScale: 1,
            viewerOffsetX: 0,
            viewerOffsetY: 0,
            dragging: false,
            dragStartX: 0,
            dragStartY: 0,
            dragStartOffsetX: 0,
            dragStartOffsetY: 0,

            // 主题模式
            isDarkMode: false,

            // Help 内容
            helpContent: '',

            // 底色
            bgColorKey: 'pattern', // 'black' | 'white' | 'pattern' | 'green' | 'red' | 'yellow' | 'blue'

            // 播放状态
            isPlaying: false,
            progress: 0, // 0-100
            currentFrame: 0,
            totalFrames: 0,

            // SVGA 状态
            svga: {
              hasFile: false,
              file: null,
              fileInfo: {
                name: '',
                size: 0,
                sizeText: '',
                fps: null,
                sizeWH: '',
                duration: '',
                memoryText: ''
              }
            },

            // YYEVA 状态（阶段1占位）
            yyeva: {
              hasFile: false,
              file: null,
              fileInfo: {
                name: '',
                size: 0,
                sizeText: ''
              }
            },

            // Lottie 状态（阶段1占位）
            lottie: {
              hasFile: false,
              file: null,
              fileInfo: {
                name: '',
                size: 0,
                sizeText: ''
              }
            },

            // 播放器实例
            svgaPlayer: null,
            svgaParser: null,
            svgaObjectUrl: null,

            // 素材替换
            showMaterialPanel: false,
            materialList: [],
            materialSearchQuery: '',
            originalVideoItem: null,
            replacedImages: {},

            // GIF 导出状态
            isExportingGIF: false,
            gifExportProgress: 0
          };
        },
        methods: {
          /* 拖拽上传 */

          onDragOver: function () {
            this.dropHover = true;
          },
          onDragLeave: function () {
            this.dropHover = false;
          },
          onDrop: function (event) {
            this.dropHover = false;
            var files = event.dataTransfer && event.dataTransfer.files;
            if (!files || !files.length) return;
            this.handleFile(files[0]);
          },

          triggerFileUpload: function () {
            this.$refs.fileInput.click();
          },

          onFileSelect: function (event) {
            var files = event.target.files;
            if (!files || !files.length) return;
            this.handleFile(files[0]);
            // 清空input，允许重复选择同一文件
            event.target.value = '';
          },

          handleFile: function (file) {
            var name = (file.name || '').toLowerCase();

            if (name.endsWith('.svga')) {
              this.loadSvga(file);
            } else if (name.endsWith('.json')) {
              this.loadLottiePlaceholder(file);
            } else if (name.endsWith('.mp4')) {
              this.loadYyevaPlaceholder(file);
            } else {
              alert('不支持的文件类型，只支持 .svga / .json / .mp4');
            }
          },

          /* 模块切换 */
          switchModule: function (key) {
            this.currentModule = key;
          },

          triggerReuploadSVGA: function () {
            // 触发隐藏的文件输入框
            var fileInput = document.getElementById('reupload-svga-input');
            if (fileInput) {
              fileInput.click();
            }
          },
          
          handleReuploadSVGA: function (event) {
            var file = event.target.files[0];
            if (!file) return;
            
            // 检查文件格式
            if (!file.name.toLowerCase().endsWith('.svga')) {
              alert('请选择 .svga 文件');
              event.target.value = ''; // 清空输入
              return;
            }
            
            // 重用现有的加载逻辑
            this.loadSVGA(file);
            
            // 清空输入，允许重复选择同一文件
            event.target.value = '';
          },

          /* 清空画布 */
          clearAll: function () {
            if (this.svgaPlayer) {
              try {
                this.svgaPlayer.stopAnimation();
                this.svgaPlayer.clear();
              } catch (e) {}
            }
            if (this.svgaObjectUrl) {
              URL.revokeObjectURL(this.svgaObjectUrl);
              this.svgaObjectUrl = null;
            }

            this.svga = {
              hasFile: false,
              file: null,
              fileInfo: {
                name: '',
                size: 0,
                sizeText: '',
                fps: null,
                sizeWH: '',
                duration: '',
                memoryText: ''
              }
            };
            this.yyeva = {
              hasFile: false,
              file: null,
              fileInfo: {
                name: '',
                size: 0,
                sizeText: ''
              }
            };
            this.lottie = {
              hasFile: false,
              file: null,
              fileInfo: {
                name: '',
                size: 0,
                sizeText: ''
              }
            };

            this.isPlaying = false;
            this.progress = 0;
            this.currentFrame = 0;
            this.totalFrames = 0;
            this.bgColorKey = 'pattern';
            
            // 关闭侧边栏
            this.showMaterialPanel = false;
          },

          /* SVGA 加载与播放 */

          loadHelpContent: function () {
            var _this = this;
            fetch('./help.md')
              .then(function(response) { return response.text(); })
              .then(function(markdown) {
                _this.helpContent = marked.parse(markdown);
              })
              .catch(function(error) {
                console.error('加载帮助文档失败:', error);
                _this.helpContent = '<p>无法加载帮助文档</p>';
              });
          },

          initSvgaPlayer: function () {
            var container = this.$refs.svgaContainer;
            if (!container) return;
            this.svgaPlayer = new SVGA.Player(container);
            this.svgaParser = new SVGA.Parser();
          },

          loadSvga: function (file) {
            var _this = this;
            this.currentModule = 'svga';

            // 重置视图状态
            this.viewerScale = 1;
            this.viewerOffsetX = 0;
            this.viewerOffsetY = 0;

            this.svga.hasFile = true;
            this.svga.file = file;
            this.svga.fileInfo.name = file.name;
            this.svga.fileInfo.size = file.size;
            this.svga.fileInfo.sizeText = this.formatBytes(file.size);

            this.progress = 0;
            this.currentFrame = 0;
            this.totalFrames = 0;
            this.isPlaying = false;

            var reader = new FileReader();
            reader.onload = function (e) {
              var arrayBuffer = e.target.result;
              var blob = new Blob([arrayBuffer], {
                type: 'application/octet-stream'
              });
              if (_this.svgaObjectUrl) {
                URL.revokeObjectURL(_this.svgaObjectUrl);
              }
              _this.svgaObjectUrl = URL.createObjectURL(blob);

              _this.svgaParser.load(
                _this.svgaObjectUrl,
                function (videoItem) {
                  _this.onSvgaLoaded(videoItem);
                },
                function () {
                  alert('SVGA 解析失败');
                }
              );
            };
            reader.readAsArrayBuffer(file);
          },

          onSvgaLoaded: function (videoItem) {
            if (!this.svgaPlayer) {
              this.initSvgaPlayer();
            }
            if (!this.svgaPlayer) return;

            var _this = this;
            
            // 保存原始 videoItem 以便后续素材替换
            this.originalVideoItem = videoItem;
            
            // 提取素材列表
            this.extractMaterialList(videoItem);

            try {
              if (videoItem.videoSize) {
                var w = videoItem.videoSize.width || 0;
                var h = videoItem.videoSize.height || 0;
                _this.svga.fileInfo.sizeWH = w + ' × ' + h;
              }
              _this.svga.fileInfo.fps = videoItem.FPS || videoItem.fps || null;
              var frames =
                videoItem.frames ||
                videoItem.framesCount ||
                videoItem.framesLength ||
                0;
              _this.totalFrames = frames;

              if (_this.svga.fileInfo.fps && frames) {
                var dur = (frames / _this.svga.fileInfo.fps).toFixed(1);
                _this.svga.fileInfo.duration = dur + 's';
              }

              // 计算内存占用：基于实际的图片素材（images），而不是sprites数量
              // SVGA 是矢量动画，使用 sprite 图片，不是每帧都有完整位图
              // 需要计算图片解码后的位图内存（RGBA格式，每像素4字节）
              // 注意：一个图片可能被多个sprite使用，所以要基于唯一的imageKey计算
              if (videoItem.images) {
                var imageKeys = Object.keys(videoItem.images);
                var imageCount = imageKeys.length;
                
                if (imageCount > 0 && videoItem.sprites && videoItem.sprites.length > 0) {
                  var totalBytes = 0;
                  var imageLayoutMap = {}; // imageKey -> layout尺寸
                  var failedKeys = []; // 无法获取尺寸的imageKey
                  
                  // 第一步：遍历所有sprites，为每个唯一的imageKey找到其layout尺寸
                  videoItem.sprites.forEach(function(sprite) {
                    if (sprite && sprite.imageKey) {
                      var imgKey = sprite.imageKey;
                      
                      // 如果这个imageKey还没有尺寸信息，尝试获取
                      if (!imageLayoutMap[imgKey]) {
                        var imgWidth = 0;
                        var imgHeight = 0;
                        
                        // 从第一帧的layout获取
                        if (sprite.frames && sprite.frames.length > 0) {
                          var firstFrame = sprite.frames[0];
                          if (firstFrame.layout) {
                            imgWidth = firstFrame.layout.width || 0;
                            imgHeight = firstFrame.layout.height || 0;
                          }
                        }
                        
                        // 如果没有layout，尝试从frameRect获取
                        if ((imgWidth === 0 || imgHeight === 0) && sprite.frameRect) {
                          imgWidth = sprite.frameRect.width || 0;
                          imgHeight = sprite.frameRect.height || 0;
                        }
                        
                        if (imgWidth > 0 && imgHeight > 0) {
                          imageLayoutMap[imgKey] = { width: imgWidth, height: imgHeight };
                        }
                      }
                    }
                  });
                  
                  // 第二步：为每个imageKey计算内存
                  // 对于没有找到sprite的图片，使用图片本身的数据来创建Image获取尺寸
                  var processedCount = 0;
                  var needLoadCount = 0;
                  
                  imageKeys.forEach(function(imgKey) {
                    if (imageLayoutMap[imgKey]) {
                      var layout = imageLayoutMap[imgKey];
                      var bytes = layout.width * layout.height * 4;
                      totalBytes += bytes;
                      processedCount++;
                    } else {
                      // 尝试从图片数据本身获取尺寸
                      var imgData = videoItem.images[imgKey];
                      if (imgData && typeof imgData === 'string') {
                        needLoadCount++;
                        var img = new Image();
                        img.onload = (function(key) {
                          return function() {
                            var bytes = this.width * this.height * 4;
                            totalBytes += bytes;
                            processedCount++;
                            
                            // 所有图片处理完成后更新显示
                            if (processedCount === imageCount) {
                              var mb = totalBytes / 1048576;
                              _this.svga.fileInfo.memoryText = mb.toFixed(2) + 'M';
                            }
                          };
                        })(imgKey);
                        img.onerror = (function(key) {
                          return function() {
                            processedCount++;
                            if (processedCount === imageCount) {
                              var mb = totalBytes / 1048576;
                              _this.svga.fileInfo.memoryText = mb.toFixed(2) + 'M';
                            }
                          };
                        })(imgKey);
                        // 添加data:image前缀（如果需要）
                        img.src = imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData);
                      } else {
                        failedKeys.push(imgKey);
                      }
                    }
                  });
                  
                  // 如果所有图片都同步处理完成，立即更新显示
                  if (processedCount === imageCount && totalBytes > 0) {
                    var mb = totalBytes / 1048576;
                    _this.svga.fileInfo.memoryText = mb.toFixed(2) + 'M';
                    console.log('总内存占用:', mb.toFixed(4) + 'M', '总字节数:', totalBytes);
                  } else if (needLoadCount > 0) {
                    _this.svga.fileInfo.memoryText = '计算中...';
                  } else if (totalBytes === 0) {
                    _this.svga.fileInfo.memoryText = '-';
                  }
                } else {
                  _this.svga.fileInfo.memoryText = '-';
                }
              } else if (w && h && frames) {
                // 降级方案：如果没有 images 信息，使用帧数估算（但这通常会高估）
                var bytes = w * h * 4 * frames;
                var mb = bytes / 1048576;
                _this.svga.fileInfo.memoryText = mb.toFixed(2) + 'M (估算)';
              }
            } catch (e) {}

            this.svgaPlayer.setVideoItem(videoItem);
            this.svgaPlayer.setContentMode('AspectFit');
            this.svgaPlayer.clearDynamicObjects();

            this.svgaPlayer.onFrame(function (frame) {
              _this.currentFrame = frame;
              if (_this.totalFrames > 0) {
                var p = (frame / (_this.totalFrames - 1)) * 100;
                _this.progress = Math.max(0, Math.min(100, Math.round(p)));
              }
            });

            this.svgaPlayer.onFinished(function () {
              _this.isPlaying = false;
            });

            this.svgaPlayer.startAnimation();
            this.isPlaying = true;

            this.applyCanvasBackground();
          },

          togglePlay: function () {
            if (!this.svgaPlayer || !this.svga.hasFile) return;
            if (this.isPlaying) {
              try {
                this.svgaPlayer.pauseAnimation();
              } catch (e) {}
              this.isPlaying = false;
            } else {
              try {
                var currentPercentage = this.progress / 100;
                this.svgaPlayer.stepToPercentage(currentPercentage, true);
              } catch (e) {}
              this.isPlaying = true;
            }
          },

          onProgressBarClick: function (event) {
            if (!this.svgaPlayer || !this.svga.hasFile) return;
            var rect = event.currentTarget.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var p = x / rect.width;
            p = Math.max(0, Math.min(1, p));
            this.progress = Math.round(p * 100);
            
            // 计算并立即更新当前帧数
            if (this.totalFrames > 0) {
              this.currentFrame = Math.round(p * (this.totalFrames - 1));
            }
            
            try {
              this.svgaPlayer.stepToPercentage(p, this.isPlaying);
            } catch (e) {}
          },

          /* Lottie / YYEVA 阶段1占位逻辑 */

          loadLottiePlaceholder: function (file) {
            // 重置视图状态
            this.viewerScale = 1;
            this.viewerOffsetX = 0;
            this.viewerOffsetY = 0;

            this.lottie.hasFile = true;
            this.lottie.file = file;
            this.lottie.fileInfo.name = file.name;
            this.lottie.fileInfo.size = file.size;
            this.lottie.fileInfo.sizeText = this.formatBytes(file.size);
            this.currentModule = 'lottie';
            alert('Lottie 模块将在后续阶段实现播放逻辑');
          },

          loadYyevaPlaceholder: function (file) {
            // 重置视图状态
            this.viewerScale = 1;
            this.viewerOffsetX = 0;
            this.viewerOffsetY = 0;

            this.yyeva.hasFile = true;
            this.yyeva.file = file;
            this.yyeva.fileInfo.name = file.name;
            this.yyeva.fileInfo.size = file.size;
            this.yyeva.fileInfo.sizeText = this.formatBytes(file.size);
            this.currentModule = 'yyeva';
            alert('YYEVA MP4 模块将在后续阶段实现播放逻辑');
          },

          /* 主题切换 */

          toggleTheme: function () {
            this.isDarkMode = !this.isDarkMode;
            if (this.isDarkMode) {
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
            } else {
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
            }
          },

          /* 缩放 + 平移 */

          onWheel: function (event) {
            if (!event.ctrlKey) return;
            event.preventDefault();
            var delta = event.deltaY || event.wheelDelta;
            var step = delta > 0 ? -0.1 : 0.1;
            var next = this.viewerScale + step;
            if (next < 0.2) next = 0.2;
            if (next > 5) next = 5;
            this.viewerScale = next;
          },

          onMouseDown: function (event) {
            if (event.button !== 1) return;
            event.preventDefault();
            this.dragging = true;
            this.dragStartX = event.clientX;
            this.dragStartY = event.clientY;
            this.dragStartOffsetX = this.viewerOffsetX;
            this.dragStartOffsetY = this.viewerOffsetY;
          },

          onMouseMove: function (event) {
            if (!this.dragging) return;
            var dx = event.clientX - this.dragStartX;
            var dy = event.clientY - this.dragStartY;
            this.viewerOffsetX = this.dragStartOffsetX + dx;
            this.viewerOffsetY = this.dragStartOffsetY + dy;
          },

          onMouseUp: function () {
            this.dragging = false;
          },

          resetScale: function () {
            this.viewerScale = 1;
            this.viewerOffsetX = 0;
            this.viewerOffsetY = 0;
          },
          
          zoomIn: function () {
            // 放大，每次增加 10%
            this.viewerScale = Math.min(this.viewerScale + 0.1, 5); // 最大 500%
          },
          
          zoomOut: function () {
            // 缩小，每次减少 10%
            this.viewerScale = Math.max(this.viewerScale - 0.1, 0.1); // 最小 10%
          },

          applyCanvasBackground: function () {
            var container = this.$refs.svgaContainer;
            if (!container) return;
            var canvas = container.querySelector('canvas');
            if (canvas) {
              if (this.bgColorKey === 'pattern') {
                // pattern模式：完全清除canvas背景，显示画布颜色
                canvas.style.backgroundColor = '';
                canvas.style.backgroundImage = '';
                canvas.style.backgroundRepeat = '';
                canvas.style.backgroundSize = '';
              } else {
                canvas.style.backgroundColor = this.currentBgColor;
                canvas.style.backgroundImage = 'none';
              }
            }
          },

          /* 素材替换功能 */

          openMaterialPanel: function () {
            if (!this.svga.hasFile || !this.originalVideoItem) return;
            // 切换侧边栏显示状态：如果已打开则关闭，否则打开
            this.showMaterialPanel = !this.showMaterialPanel;
          },

          closeMaterialPanel: function () {
            this.showMaterialPanel = false;
          },
          
          copyMaterialName: function (name) {
            var _this = this;
            // 使用 Clipboard API 复制文本
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(name).then(function() {
                // 可以添加一个简单的提示
                console.log('已复制: ' + name);
              }).catch(function(err) {
                console.error('复制失败:', err);
              });
            } else {
              // 降级方案：使用 textarea
              var textarea = document.createElement('textarea');
              textarea.value = name;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              try {
                document.execCommand('copy');
                console.log('已复制: ' + name);
              } catch (err) {
                console.error('复制失败:', err);
              }
              document.body.removeChild(textarea);
            }
          },

          extractMaterialList: function (videoItem) {
            var _this = this;
            this.materialList = [];
            this.replacedImages = {};
            
            if (!videoItem || !videoItem.images) return;
            
            var imageKeys = Object.keys(videoItem.images);
            imageKeys.forEach(function (imageKey) {
              var imgData = videoItem.images[imageKey];
              var previewUrl = '';
              
              // 处理图片数据，生成预览 URL
              if (imgData && typeof imgData === 'string') {
                previewUrl = imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData);
              }
              
              // 获取图片尺寸（异步）
              var img = new Image();
              var materialItem = {
                imageKey: imageKey,
                previewUrl: previewUrl,
                sizeText: '计算中...',
                fileSizeText: '计算中...',
                isReplaced: false,
                originalData: imgData,
                fileSize: 0
              };
              
              _this.materialList.push(materialItem);
              
              img.onload = function () {
                var bytes = this.width * this.height * 4;
                materialItem.fileSize = bytes;
                materialItem.fileSizeText = _this.formatBytes(bytes);
                materialItem.sizeText = this.width + 'px*' + this.height + 'px';
                // 保存原始宽高，用于后续图片替换时的缩放
                materialItem.width = this.width;
                materialItem.height = this.height;
              };
              
              img.onerror = function () {
                materialItem.sizeText = '-';
                materialItem.fileSizeText = '-';
              };
              
              if (previewUrl) {
                img.src = previewUrl;
              }
            });
          },

          replaceMaterial: function (index) {
            var _this = this;
            var material = this.materialList[index];
            if (!material) return;
            
            // 创建文件选择器
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png,image/jpeg,image/jpg';
            
            input.onchange = function (e) {
              var file = e.target.files[0];
              if (!file) return;
              
              // 读取文件为 base64
              var reader = new FileReader();
              reader.onload = function (evt) {
                var uploadedDataUrl = evt.target.result;
                
                // 加载上传的图片
                var uploadedImg = new Image();
                uploadedImg.onload = function () {
                  // 直接使用上传的图片，不进行缩放
                  // SVGA 播放器会自动处理图片尺寸
                  var resizedDataUrl = uploadedDataUrl;
                  
                  console.log('使用原始上传图片，尺寸:', uploadedImg.width, 'x', uploadedImg.height);
                  console.log('Base64 数据长度:', resizedDataUrl.length);
                  
                  // 更新预览
                  material.previewUrl = resizedDataUrl;
                  material.isReplaced = true;
                  
                  // 保存替换的图片 - 使用新对象触发响应式更新
                  var newReplacedImages = Object.assign({}, _this.replacedImages);
                  newReplacedImages[material.imageKey] = resizedDataUrl;
                  _this.replacedImages = newReplacedImages;
                  
                  // 更新文件大小信息（使用上传图片的实际尺寸）
                  var bytes = uploadedImg.width * uploadedImg.height * 4;
                  material.fileSize = bytes;
                  material.fileSizeText = _this.formatBytes(bytes);
                  material.sizeText = uploadedImg.width + 'px*' + uploadedImg.height + 'px';
                  
                  // 延迟后应用到 SVGA
                  setTimeout(function() {
                    _this.applyReplacedMaterials();
                  }, 300);
                };
                uploadedImg.onerror = function() {
                  console.error('上传的图片加载失败');
                  alert('图片加载失败，请确保图片格式正确');
                };
                uploadedImg.src = uploadedDataUrl;
              };
              
              reader.readAsDataURL(file);
            };
            
            input.click();
          },

          restoreMaterial: function (index) {
            var material = this.materialList[index];
            if (!material || !material.isReplaced) return;
            
            // 恢复原始图片
            var originalData = material.originalData;
            material.previewUrl = originalData.startsWith('data:') ? originalData : ('data:image/png;base64,' + originalData);
            material.isReplaced = false;
            
            // 移除替换记录 - 使用新对象触发响应式更新
            var newReplacedImages = Object.assign({}, this.replacedImages);
            delete newReplacedImages[material.imageKey];
            this.replacedImages = newReplacedImages;
            
            // 重新渲染 SVGA
            this.applyReplacedMaterials();
            
            // 重新计算尺寸
            var _this = this;
            var img = new Image();
            img.onload = function () {
              var bytes = this.width * this.height * 4;
              material.fileSize = bytes;
              material.fileSizeText = _this.formatBytes(bytes);
              material.sizeText = this.width + 'px*' + this.height + 'px';
            };
            img.src = material.previewUrl;
          },

          applyReplacedMaterials: function () {
            if (!this.svgaPlayer || !this.originalVideoItem) return;
            
            var _this = this;
            
            // 清除之前的动态替换
            this.svgaPlayer.clearDynamicObjects();
            
            // 预加载所有图片，然后一起应用
            var imageKeys = Object.keys(this.replacedImages);
            var loadedImages = {};
            var loadedCount = 0;
            var totalCount = imageKeys.length;
            
            if (totalCount === 0) {
              // 没有替换的图片，直接重启播放
              if (_this.isPlaying) {
                _this.svgaPlayer.startAnimation();
              } else {
                _this.svgaPlayer.stepToFrame(_this.currentFrame);
              }
              return;
            }
            
            // 加载所有图片
            imageKeys.forEach(function(imageKey) {
              var imageUrl = _this.replacedImages[imageKey];
              var img = new Image();
              
              img.onload = function() {
                loadedImages[imageKey] = img;
                loadedCount++;
                
                // 所有图片都加载完成
                if (loadedCount === totalCount) {
                  // 应用所有替换的图片
                  Object.keys(loadedImages).forEach(function(key) {
                    _this.svgaPlayer.setImage(loadedImages[key], key);
                  });
                  
                  // 重启播放
                  if (_this.isPlaying) {
                    _this.svgaPlayer.startAnimation();
                  } else {
                    _this.svgaPlayer.stepToFrame(_this.currentFrame);
                  }
                }
              };
              
              img.onerror = function() {
                console.error('图片加载失败:', imageKey);
                console.error('图片 URL 长度:', imageUrl ? imageUrl.length : 0);
                console.error('图片 URL 前100个字符:', imageUrl ? imageUrl.substring(0, 100) : '');
                loadedCount++;
                
                // 即使有错误也继续
                if (loadedCount === totalCount) {
                  Object.keys(loadedImages).forEach(function(key) {
                    _this.svgaPlayer.setImage(loadedImages[key], key);
                  });
                  
                  if (_this.isPlaying) {
                    _this.svgaPlayer.startAnimation();
                  } else {
                    _this.svgaPlayer.stepToFrame(_this.currentFrame);
                  }
                }
              };
              
              img.src = imageUrl;
            });
          },

          previewMaterials: function () {
            // 预览功能：当前已通过 applyReplacedMaterials 实时预览
            // 关闭弹窗即可看到效果
            this.closeMaterialPanel();
          },

          exportNewSVGA: function () {
            var _this = this;
            
            if (!this.svga.hasFile || !this.originalVideoItem || !this.svga.file) {
              alert('请先加载 SVGA 文件');
              return;
            }
            
            if (Object.keys(this.replacedImages).length === 0) {
              alert('请先替换至少一个素材');
              return;
            }

            var processing = confirm('即将导出替换后的 SVGA 文件。继续吗？');
            if (!processing) return;

            try {
              // 读取原始 SVGA 文件
              var reader = new FileReader();
              reader.onload = function(e) {
                try {
                  var arrayBuffer = e.target.result;
                  var uint8Array = new Uint8Array(arrayBuffer);
                  
                  // 解压缩
                  var inflatedData = pako.inflate(uint8Array);
                  
                  // 使用 protobuf.js 动态加载 proto 并解码
                  protobuf.load('svga.proto', function(err, root) {
                    if (err) {
                      alert('加载 proto 定义失败: ' + err.message);
                      return;
                    }
                    
                    try {
                      // 获取 MovieEntity 类型
                      var MovieEntity = root.lookupType('com.opensource.svga.MovieEntity');
                      
                      // 解码（直接操作 protobuf 消息对象）
                      var movieData = MovieEntity.decode(inflatedData);
                      
                      // 替换图片数据
                      var replacedCount = 0;
                      for (var imageKey in _this.replacedImages) {
                        if (_this.replacedImages.hasOwnProperty(imageKey)) {
                          // 检查 images 字典中是否存在该 key
                          if (movieData.images && movieData.images[imageKey]) {
                            var base64Data = _this.replacedImages[imageKey];
                            // 移除 data:image/xxx;base64, 前缀
                            var base64String = base64Data.split(',')[1] || base64Data;
                            // 转换为 Uint8Array
                            var binaryString = atob(base64String);
                            var bytes = new Uint8Array(binaryString.length);
                            for (var i = 0; i < binaryString.length; i++) {
                              bytes[i] = binaryString.charCodeAt(i);
                            }
                            // 直接替换 protobuf 消息中的 bytes 字段
                            movieData.images[imageKey] = bytes;
                            replacedCount++;
                          }
                        }
                      }
                      
                      if (replacedCount === 0) {
                        alert('未找到需要替换的图片');
                        return;
                      }
                      
                      // 直接编码 protobuf 消息
                      var buffer = MovieEntity.encode(movieData).finish();
                      
                      // 压缩
                      var deflatedData = pako.deflate(buffer);
                      
                      // 创建 Blob 并下载
                      var blob = new Blob([deflatedData], { type: 'application/octet-stream' });
                      var url = URL.createObjectURL(blob);
                      var a = document.createElement('a');
                      a.href = url;
                      var originalName = _this.svga.fileInfo.name.replace(/\.svga$/i, '');
                      a.download = originalName + '_modified.svga';
                      document.body.appendChild(a);
                      a.click();
                      document.body.removeChild(a);
                      
                      setTimeout(function() {
                        URL.revokeObjectURL(url);
                      }, 100);
                      
                      alert('导出成功！已替换 ' + replacedCount + ' 个素材。');
                      
                    } catch (decodeErr) {
                      console.error('编解码失败:', decodeErr);
                      alert('编解码失败: ' + decodeErr.message);
                    }
                  });
                  
                } catch (err) {
                  console.error('处理 SVGA 失败:', err);
                  alert('处理失败: ' + err.message);
                }
              };
              reader.readAsArrayBuffer(_this.svga.file);
              
            } catch (err) {
              console.error('导出 SVGA 失败:', err);
              alert('导出失败: ' + err.message);
            }
          },

          /* GIF 导出功能 */

          exportGIF: function () {
            var _this = this;
            
            if (!this.svgaPlayer || !this.svga.hasFile || !this.originalVideoItem) {
              alert('请先加载 SVGA 文件');
              return;
            }

            // 检查 gif.js 是否加载
            if (typeof GIF === 'undefined') {
              alert('GIF 导出库未加载，请刷新页面重试');
              return;
            }

            this.isExportingGIF = true;
            this.gifExportProgress = 0;

            // 获取 canvas 元素
            var container = this.$refs.svgaContainer;
            if (!container) {
              this.isExportingGIF = false;
              alert('无法获取画布元素');
              return;
            }
            var canvas = container.querySelector('canvas');
            if (!canvas) {
              this.isExportingGIF = false;
              alert('无法获取 canvas 元素');
              return;
            }

            // 获取 SVGA 信息
            var videoItem = this.originalVideoItem;
            var totalFrames = this.totalFrames;
            var fps = this.svga.fileInfo.fps || 20;
            var frameDelay = Math.round(1000 / fps); // 每帧延迟（毫秒）

            // 创建 GIF 编码器
            var gif = new GIF({
              workers: 2,  // 启用 2 个 worker 线程
              quality: 10,
              width: canvas.width,
              height: canvas.height,
              workerScript: 'gif.worker.js'  // 使用本地 worker 文件
            });

            // 监听进度
            gif.on('progress', function(p) {
              // 捕获阶段 0-50%，编码阶段 50-100%
              _this.gifExportProgress = 50 + Math.floor(p * 50);
            });

            // 完成时触发
            gif.on('finished', function(blob) {
              _this.isExportingGIF = false;
              _this.gifExportProgress = 0;

              // 下载 GIF
              var url = URL.createObjectURL(blob);
              var a = document.createElement('a');
              a.href = url;
              a.download = (_this.svga.fileInfo.name.replace(/\.svga$/i, '') || 'animation') + '.gif';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              
              setTimeout(function() {
                URL.revokeObjectURL(url);
              }, 100);

              alert('GIF 导出成功！大小: ' + (_this.formatBytes(blob.size)));
            });

            // 错误处理
            gif.on('abort', function() {
              _this.isExportingGIF = false;
              _this.gifExportProgress = 0;
              alert('GIF 导出已取消');
            });

            // 获取当前播放器状态
            var wasPlaying = this.isPlaying;
            if (wasPlaying) {
              this.svgaPlayer.pauseAnimation();
            }

            // 逐帧渲染并添加到 GIF
            var currentFrameIndex = 0;
            
            var captureFrame = function() {
              if (currentFrameIndex >= totalFrames) {
                // 所有帧都添加完毕，开始渲染 GIF
                console.log('开始编码 GIF...');
                _this.gifExportProgress = 50;
                
                setTimeout(function() {
                  try {
                    gif.render();
                  } catch (err) {
                    console.error('GIF 编码失败:', err);
                    _this.isExportingGIF = false;
                    _this.gifExportProgress = 0;
                    alert('GIF 编码失败: ' + err.message);
                    
                    // 恢复播放状态
                    if (wasPlaying) {
                      _this.svgaPlayer.startAnimation();
                    }
                  }
                }, 100);
                
                return;
              }

              // 跳转到指定帧
              _this.svgaPlayer.stepToFrame(currentFrameIndex, false);
              
              // 等待渲染完成，然后捕获帧
              setTimeout(function() {
                try {
                  // 创建临时 canvas 用于合成背景色
                  var tempCanvas = document.createElement('canvas');
                  tempCanvas.width = canvas.width;
                  tempCanvas.height = canvas.height;
                  var tempCtx = tempCanvas.getContext('2d');
                  
                  // 填充背景色
                  var bgColor = '#ffffff'; // 默认白色
                  if (_this.bgColorKey && _this.bgColorKey !== 'pattern') {
                    // 使用当前背景色（白色、绿色、红色等）
                    var computedBgColor = _this.currentBgColor;
                    if (computedBgColor !== 'transparent' && computedBgColor !== '#000000') {
                      bgColor = computedBgColor;
                    }
                  }
                  tempCtx.fillStyle = bgColor;
                  tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                  
                  // 将 SVGA 画布绘制到临时 canvas 上
                  tempCtx.drawImage(canvas, 0, 0);
                  
                  // 使用合成后的 canvas 添加到 GIF
                  gif.addFrame(tempCanvas, {copy: true, delay: frameDelay});
                  currentFrameIndex++;
                  
                  // 更新进度（捕获阶段占 0-50%）
                  _this.gifExportProgress = Math.floor((currentFrameIndex / totalFrames) * 50);
                  
                  // 继续下一帧
                  captureFrame();
                } catch (err) {
                  console.error('捕获帧失败:', err);
                  _this.isExportingGIF = false;
                  _this.gifExportProgress = 0;
                  alert('捕获帧失败: ' + err.message);
                  
                  // 恢复播放状态
                  if (wasPlaying) {
                    _this.svgaPlayer.startAnimation();
                  }
                }
              }, 50); // 给每帧 50ms 渲染时间
            };

            // 开始捕获
            console.log('开始捕获帧，总帧数:', totalFrames);
            captureFrame();
          },

          /* 工具方法 */

          formatBytes: function (bytes) {
            if (!bytes && bytes !== 0) return '';
            var kb = bytes / 1024;
            if (kb < 1024) return kb.toFixed(0) + 'kb';
            var mb = kb / 1024;
            return mb.toFixed(2) + 'M';
          }
        },
        computed: {
          hasReplacedMaterials: function () {
            return Object.keys(this.replacedImages).length > 0;
          },
          
          isEmpty: function () {
            return !this.svga.hasFile && !this.yyeva.hasFile && !this.lottie.hasFile;
          },
          
          currentFileInfo: function () {
            if (this.currentModule === 'svga' && this.svga.hasFile) {
              return this.svga.fileInfo;
            } else if (this.currentModule === 'yyeva' && this.yyeva.hasFile) {
              return this.yyeva.fileInfo;
            } else if (this.currentModule === 'lottie' && this.lottie.hasFile) {
              return this.lottie.fileInfo;
            }
            return {};
          },
          
          currentBgColor: function () {
            if (this.bgColorKey === 'white') return '#ffffff';
            if (this.bgColorKey === 'green') return '#00ff00';
            if (this.bgColorKey === 'red') return '#df3321';
            if (this.bgColorKey === 'yellow') return '#f1c40d';
            if (this.bgColorKey === 'blue') return '#00b4ff';
            if (this.bgColorKey === 'pattern') {
              return 'transparent';
            }
            return '#000000';
          },
          
          materialThumbBgColor: function () {
            // 如果有设置背景色且不是透明格子，使用当前背景色
            if (this.bgColorKey && this.bgColorKey !== 'pattern') {
              return this.currentBgColor;
            }
            // 否则使用默认颜色：浅色模式 #fcfcfc，暗黑模式 #2a2a2a
            return this.isDarkMode ? '#2a2a2a' : '#fcfcfc';
          },
          
          filteredMaterialList: function () {
            var _this = this;
            if (!this.materialSearchQuery) {
              return this.materialList;
            }
            var query = this.materialSearchQuery.toLowerCase();
            return this.materialList.filter(function(item) {
              return item.imageKey.toLowerCase().indexOf(query) !== -1;
            });
          },
          
          zoomInIcon: function () {
            if (this.isDarkMode) {
              return 'assets/img/zoom_in_dark.png';
            }
            return 'assets/img/zoom_in.png';
          },
          
          zoomOutIcon: function () {
            if (this.isDarkMode) {
              return 'assets/img/zoom_out_dark.png';
            }
            return 'assets/img/zoom_out.png';
          },
          
          oneToOneIcon: function () {
            if (this.isDarkMode) {
              return 'assets/img/one2one_dark.png';
            }
            return 'assets/img/one2one.png';
          },
          
          viewerContainerStyle: function () {
            var style = {
              transform: 'translate(' + this.viewerOffsetX + 'px, ' + this.viewerOffsetY + 'px) scale(' + this.viewerScale + ')',
              cursor: this.dragging ? 'grabbing' : 'grab'
            };
            
            // 根据当前模块设置容器尺寸
            if (this.currentModule === 'svga' && this.svga.hasFile) {
              // SVGA 使用实际尺寸
              var sizeWH = this.svga.fileInfo.sizeWH;
              if (sizeWH) {
                var parts = sizeWH.split(' × ');
                if (parts.length === 2) {
                  style.width = parts[0] + 'px';
                  style.height = parts[1] + 'px';
                }
              }
            }
            
            return style;
          }
        },
        watch: {
          bgColorKey: function () {
            var _this = this;
            this.$nextTick(function() {
              _this.applyCanvasBackground();
            });
          }
        },
        mounted: function () {
          var _this = this;
          this.initSvgaPlayer();
          var savedTheme = localStorage.getItem('theme');
          if (savedTheme === 'dark') {
            this.isDarkMode = true;
            document.body.classList.add('dark-mode');
          }
          // 加载 help.md
          this.loadHelpContent();
          
          // 绑定重传SVGA文件输入框的事件
          var reuploadInput = document.getElementById('reupload-svga-input');
          if (reuploadInput) {
            reuploadInput.addEventListener('change', function(event) {
              _this.handleReuploadSVGA(event);
            });
          }
        }
      });
    </script>
    
    <!-- 隐藏的文件输入框，用于重传SVGA -->
    <input 
      type="file" 
      id="reupload-svga-input" 
      accept=".svga" 
      style="display: none;"
    />
  </body>
</html>
