<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>Á¥†ÊùêËá™Âä©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Â§öËØ≠Ë®ÄÂ≠ó‰ΩìÔºöGoogle Fonts Noto Sans Á≥ªÂàó -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Sans+Arabic:wght@400;500;700&family=Noto+Sans+Thai:wght@400;500;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        width: 100%;
        height: 100%;
        font-family: 'Noto Sans', 'Noto Sans SC', 'Noto Sans Arabic', 'Noto Sans Thai', 
                     'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        overflow: hidden;
        background-color: #fcfcfc;
        transition: background-color 0.3s;
      }

      body.dark-mode {
        background-color: #1a1a1a;
      }

      #app {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* ==================== È°∂ÈÉ®ÂØºËà™Ê†è ==================== */
      .header-navbar {
        width: 100%;
        height: 36px;
        background-color: #ffffff;
        border-bottom: 1px solid #e3e3e3;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 16px;
        position: relative;
        z-index: 100;
        transition: background-color 0.3s, border-color 0.3s;
      }

      body.dark-mode .header-navbar {
        background-color: #2a2a2a;
        border-bottom-color: #404040;
      }

      .header-navbar-title {
        font-weight: 700;
        font-size: 12px;
        color: #2c3e50;
        transition: color 0.3s;
      }

      body.dark-mode .header-navbar-title {
        color: #e0e0e0;
      }

      .back-link {
        position: absolute;
        left: 16px;
        font-size: 12px;
        color: #409eff;
        text-decoration: none;
        cursor: pointer;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      body.dark-mode .back-link {
        color: #66b1ff;
      }

      .theme-toggle {
        position: absolute;
        right: 16px;
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .theme-toggle svg {
        width: 18px;
        height: 18px;
        fill: #2c3e50;
        transition: fill 0.3s;
      }

      body.dark-mode .theme-toggle svg {
        fill: #e0e0e0;
      }

      /* ==================== Tab Ê†áÁ≠æÊ†è ==================== */
      .tab-bar {
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        background-color: #ffffff;
        border-bottom: 1px solid #e3e3e3;
        transition: background-color 0.3s, border-color 0.3s;
      }

      body.dark-mode .tab-bar {
        background-color: #2a2a2a;
        border-bottom-color: #404040;
      }

      .tab-btn {
        height: 28px;
        padding: 0 12px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 8px;
        color: #818181;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .tab-btn:hover {
        background: #f5f5f5;
        color: #333333;
      }

      .tab-btn.active {
        background: #ffffff;
        border-color: #e3e3e3;
        color: #333333;
      }

      body.dark-mode .tab-btn {
        color: #a0a0a0;
      }

      body.dark-mode .tab-btn:hover {
        background: #333333;
        color: #e0e0e0;
      }

      body.dark-mode .tab-btn.active {
        background: #2a2a2a;
        border-color: #404040;
        color: #e0e0e0;
      }

      /* ==================== ‰∏ªÂÜÖÂÆπÂå∫Âüü ==================== */
      .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }

      /* ÂºÄÂèë‰∏≠ÊèêÁ§∫ */
      .dev-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 300px;
        color: #999999;
        font-size: 16px;
      }

      body.dark-mode .dev-placeholder {
        color: #666666;
      }

      /* ÂàóË°®ÁΩëÊ†º */
      .frame-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        max-width: 900px;
        margin: 0 auto;
      }

      .frame-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        background: #ffffff;
        border: 1px solid #e3e3e3;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .frame-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .frame-item:hover {
        background: #f5f5f5;
        border-color: #409eff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      body.dark-mode .frame-item {
        background: #2a2a2a;
        border-color: #404040;
      }

      body.dark-mode .frame-item:hover {
        background: #333333;
        border-color: #409eff;
      }

      .frame-icon {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin-bottom: 8px;
      }

      .frame-name {
        font-size: 12px;
        color: #333333;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      body.dark-mode .frame-name {
        color: #e0e0e0;
      }

      /* Âä†ËΩΩÊèêÁ§∫ */
      .loading-tip {
        text-align: center;
        padding: 40px;
        color: #999;
        font-size: 14px;
      }

      /* ToastÊèêÁ§∫ */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .toast.show {
        opacity: 1;
        visibility: visible;
      }

      /* ==================== ËíôÂ±ÇÂºπÁ™ó ==================== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      body.dark-mode .modal-overlay {
        background: rgba(0, 0, 0, 0.7);
      }

      .modal-container {
        display: flex;
        width: 90%;
        max-width: 1000px;
        height: 80%;
        max-height: 700px;
        overflow: hidden;
        position: relative;
        border-radius: 16px;
        background: #ffffff;
        background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNlM2UzZTMiLz48L3N2Zz4=);
        background-size: 8px 8px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      }

      body.dark-mode .modal-container {
        background: #2a2a2a;
        background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiM0MDQwNDAiLz48L3N2Zz4=);
        background-size: 8px 8px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
      }

      .modal-close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s;
      }

      .modal-close-btn:hover {
        background: rgba(0, 0, 0, 0.2);
        transform: scale(1.1);
      }

      .modal-close-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      body.dark-mode .modal-close-btn {
        background: rgba(255, 255, 255, 0.1);
      }

      body.dark-mode .modal-close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-close-btn svg {
        width: 16px;
        height: 16px;
        stroke: #333;
        stroke-width: 2;
      }

      body.dark-mode .modal-close-btn svg {
        stroke: #e0e0e0;
      }

      .preview-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 24px;
      }

      .preview-player {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        max-height: 400px;
      }

      body.dark-mode .preview-player {
        background: #1a1a1a;
      }

      #darSvgaContainer, #giftSvgaContainer {
        width: 400px;
        height: 400px;
      }

      .preview-info {
        margin-top: 16px;
        padding: 12px;
        background: #fff;
        border-radius: 8px;
      }

      body.dark-mode .preview-info {
        background: #1a1a1a;
      }

      .material-preview-container {
        margin-top: 16px;
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .material-preview-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .material-preview-info .section-title {
        text-align: center;
      }

      .material-preview-info .material-card {
        max-width: 400px;
      }

      .info-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 12px;
        justify-content: center;
      }

      .info-item {
        display: flex;
        gap: 4px;
      }

      .info-label {
        color: #999;
      }

      .info-value {
        color: #333;
        font-weight: 500;
      }

      .info-value.warning {
        color: #ff4444;
      }

      body.dark-mode .info-value {
        color: #e0e0e0;
      }

      .settings-panel {
        width: 360px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      }

      body.dark-mode .settings-panel {
        background: #1e1e1e;
      }

      .panel-section {
        padding: 20px;
        border-bottom: 1px solid #e3e3e3;
      }

      body.dark-mode .panel-section {
        border-bottom-color: #404040;
      }

      .panel-section:last-child {
        border-bottom: none;
      }

      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
      }

      body.dark-mode .section-title {
        color: #e0e0e0;
      }

      .material-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f5f5f5;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      body.dark-mode .material-card {
        background: #1a1a1a;
      }

      .material-thumb {
        width: 48px;
        height: 48px;
        background: #fff;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      body.dark-mode .material-thumb {
        background: #2a2a2a;
        border-color: #404040;
      }

      .material-thumb img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .material-info {
        flex: 1;
        min-width: 0;
      }

      .material-name {
        font-size: 12px;
        color: #333;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      body.dark-mode .material-name {
        color: #e0e0e0;
      }

      .material-btns {
        display: flex;
        gap: 8px;
      }

      .btn {
        height: 28px;
        padding: 0 12px;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        background: #ffffff;
        color: #333;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .btn:hover {
        background: #f5f5f5;
        border-color: #d0d0d0;
      }

      body.dark-mode .btn {
        background: #2a2a2a;
        border-color: #404040;
        color: #e0e0e0;
      }

      body.dark-mode .btn:hover {
        background: #333333;
        border-color: #505050;
      }

      .btn-primary {
        background: #409eff;
        border-color: #409eff;
        color: #fff;
      }

      .btn-primary:hover {
        background: #66b1ff;
        border-color: #66b1ff;
      }

      .btn-success {
        background: #67c23a;
        border-color: #67c23a;
        color: #fff;
      }

      .btn-success:hover {
        background: #85ce61;
        border-color: #85ce61;
      }

      .btn-icon {
        width: 28px;
        padding: 0;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .text-effect-area {
        margin-bottom: 16px;
      }

      .text-canvas-wrapper {
        width: 100%;
        height: 70px;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        position: relative;
      }

      body.dark-mode .text-canvas-wrapper {
        background: #2a2a2a;
      }

      .text-canvas {
        max-width: 100%;
        max-height: 100%;
        border: 1px solid #e3e3e3;
      }

      .text-input {
        width: 100%;
        height: 40px;
        padding: 0 12px;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        background: #ffffff;
        color: #333;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .text-input:focus {
        outline: none;
        border-color: #409eff;
      }

      body.dark-mode .text-input {
        background: #1a1a1a;
        border-color: #404040;
        color: #e0e0e0;
      }

      .position-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }

      .position-btns {
        display: flex;
        gap: 4px;
      }

      .pos-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        border: 1px solid #e3e3e3;
        border-radius: 6px;
        background: #ffffff;
        color: #333;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .pos-btn:hover {
        background: #f5f5f5;
        border-color: #409eff;
        color: #409eff;
      }

      body.dark-mode .pos-btn {
        background: #2a2a2a;
        border-color: #404040;
        color: #e0e0e0;
      }

      body.dark-mode .pos-btn:hover {
        background: #333;
        border-color: #409eff;
        color: #409eff;
      }

      .export-section {
        padding: 20px;
        border-top: 1px solid #e3e3e3;
        margin-top: auto;
      }

      body.dark-mode .export-section {
        border-top-color: #404040;
      }

      .export-btn {
        width: 100%;
        height: 40px;
        font-size: 14px;
        font-weight: 500;
      }

      /* ÂõæÊ†áÁîüÊàêÊïàÊûú */
      .icon-generator {
        display: flex;
        justify-content: center;
        padding: 16px 0;
      }

      .icon-preview {
        display: block;
        width: 300px;
        height: 300px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #f9f9f9;
      }

      body.dark-mode .icon-preview {
        border-color: #404040;
        background: #2a2a2a;
      }

      /* Ë£ÅÂâ™ÂºπÁ™ó */
      .crop-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .crop-modal-content {
        background: #fff;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      body.dark-mode .crop-modal-content {
        background: #2a2a2a;
      }

      .crop-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      body.dark-mode .crop-modal-header {
        border-bottom-color: #404040;
      }

      .crop-modal-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .close-btn:hover {
        background: #f0f0f0;
      }

      body.dark-mode .close-btn {
        color: #999;
      }

      body.dark-mode .close-btn:hover {
        background: #404040;
      }

      .crop-modal-body {
        padding: 20px;
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .crop-container {
        position: relative;
        width: 100%;
        height: 500px;
        background: #f5f5f5;
        border-radius: 8px;
        overflow: hidden;
        cursor: move;
      }

      body.dark-mode .crop-container {
        background: #1a1a1a;
      }

      .crop-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .crop-controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333;
      }

      body.dark-mode .crop-controls label {
        color: #e0e0e0;
      }

      .crop-scale-slider {
        width: 400px;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: #ddd;
        outline: none;
        border-radius: 2px;
      }

      .crop-scale-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        background: #007bff;
        cursor: pointer;
        border-radius: 50%;
      }

      body.dark-mode .crop-scale-slider {
        background: #404040;
      }

      .crop-scale-value {
        min-width: 50px;
        font-weight: 500;
        color: #007bff;
      }

      body.dark-mode .crop-scale-value {
        color: #4a9eff;
      }

      .crop-canvas {
        width: 100%;
        height: 100%;
      }

      .crop-tips {
        text-align: center;
        color: #999;
        font-size: 13px;
      }

      .crop-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      body.dark-mode .crop-modal-footer {
        border-top-color: #404040;
      }

      /* ==================== Áî®Êà∑ÂããÁ´†Ê†∑Âºè ==================== */
      .frame-item.add-btn {
        border: 2px dashed #e3e3e3;
        justify-content: center;
        color: #999;
      }
      
      .frame-item.add-btn:hover {
        border-color: #409eff;
        color: #409eff;
      }

      .add-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .delete-badge-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 5;
      }

      .edit-badge-btn {
        position: absolute;
        top: 4px;
        right: 28px;
        width: 20px;
        height: 20px;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 5;
      }

      .frame-item:hover .delete-badge-btn,
      .frame-item:hover .edit-badge-btn {
        opacity: 1;
      }

      .frame-item {
        position: relative;
      }

      /* ‰∏ä‰º†Âå∫Âüü */
      .upload-area {
        border: 2px dashed #e3e3e3;
        border-radius: 12px;
        height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: #fafafa;
        transition: all 0.3s;
        margin-bottom: 16px;
        position: relative;
        overflow: hidden;
      }

      .upload-area:hover {
        border-color: #409eff;
        background: #f0f7ff;
      }

      body.dark-mode .upload-area {
        background: #2a2a2a;
        border-color: #404040;
      }

      body.dark-mode .upload-area:hover {
        background: #333;
      }

      .upload-preview-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .upload-placeholder {
        text-align: center;
        color: #999;
      }

      /* ÂããÁ´†ÁîüÊàêÈ¢ÑËßà */
      .badge-gen-preview {
        width: 100%;
        height: 300px;
        background: #f5f5f5;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        overflow: hidden;
        position: relative;
        background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNlM2UzZTMiLz48L3N2Zz4=);
      }

      body.dark-mode .badge-gen-preview {
        background-color: #1a1a1a;
        background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiM0MDQwNDAiLz48L3N2Zz4=);
      }

      .badge-canvas-wrapper {
        position: relative;
        cursor: move;
      }

      .css-input {
        width: 100%;
        height: 100px;
        padding: 12px;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        background: #ffffff;
        color: #333;
        font-family: monospace;
        font-size: 12px;
        resize: vertical;
        margin-bottom: 12px;
      }

      body.dark-mode .css-input {
        background: #1a1a1a;
        border-color: #404040;
        color: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div id="app" @mousemove="onDragMove" @mouseup="onDragEnd">
      <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
      <div class="header-navbar">
        <a href="index.html" class="back-link">‚Üê ËøîÂõû</a>
        <div class="header-navbar-title">Á¥†ÊùêËá™Âä©</div>
        <button class="theme-toggle" @click="toggleTheme" :title="isDarkMode ? 'ÂàáÊç¢‰∏∫ÁôΩÂ§©Ê®°Âºè' : 'ÂàáÊç¢‰∏∫ÊöóÈªëÊ®°Âºè'">
          <svg v-if="!isDarkMode" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
          </svg>
          <svg v-else viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="4"/>
            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/>
          </svg>
        </button>
      </div>

      <!-- Tab Ê†áÁ≠æÊ†è -->
      <div class="tab-bar">
        <button 
          class="tab-btn" 
          :class="{ active: activeTab === 'dar' }"
          @click="switchTab('dar')"
        >Â§ßRÂ§¥ÂÉèÊ°Ü</button>
        <button 
          class="tab-btn" 
          :class="{ active: activeTab === 'gift_1photo' }"
          @click="switchTab('gift_1photo')"
        >Âêç‰∫∫Á§ºÁâ©Âü∫Êú¨Ê¨æ</button>
        <button 
          class="tab-btn" 
          :class="{ active: activeTab === 'gift_3photo' }"
          @click="switchTab('gift_3photo')"
        >Âêç‰∫∫Á§ºÁâ©3ÂõæÊ¨æ</button>
        <button 
          class="tab-btn" 
          :class="{ active: activeTab === 'gift_video' }"
          @click="switchTab('gift_video')"
        >Âêç‰∫∫Á§ºÁâ©ËßÜÈ¢ëÊ¨æ</button>
        <button 
          class="tab-btn" 
          :class="{ active: activeTab === 'badge' }"
          @click="switchTab('badge')"
        >Áî®Êà∑ÂããÁ´†</button>
      </div>

      <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
      <div class="main-content">
        <!-- Â§ßRÂ§¥ÂÉèÊ°ÜÂàóË°® -->
        <template v-if="activeTab === 'dar'">
          <div v-if="dar.loading" class="loading-tip">Âä†ËΩΩ‰∏≠...</div>
          <div v-else-if="dar.frameList.length === 0" class="loading-tip">ÊöÇÊó†Â§¥ÂÉèÊ°ÜÔºåËØ∑Â∞ÜSVGAÊñá‰ª∂ÊîæÂÖ• assets/dar_svga ÁõÆÂΩï</div>
          <div v-else class="frame-grid">
            <div 
              v-for="(item, index) in dar.frameList"
              :key="'dar_' + item.name"
              class="frame-item"
              :class="{ 'disabled': dar.isExporting }"
              @click="!dar.isExporting && openDarFrame(item)"
            >
              <img :src="'assets/dar_svga/' + item.icon" :alt="item.name" class="frame-icon" />
              <div class="frame-name">{{ item.name }}</div>
            </div>
          </div>
        </template>

        <!-- Âêç‰∫∫Á§ºÁâ©Âü∫Êú¨Ê¨æÂàóË°® -->
        <template v-if="activeTab === 'gift_1photo'">
          <div v-if="gift.loading" class="loading-tip">Âä†ËΩΩ‰∏≠...</div>
          <div v-else-if="gift.frameList.length === 0" class="loading-tip">ÊöÇÊó†Á§ºÁâ©ÔºåËØ∑Â∞ÜSVGAÊñá‰ª∂ÊîæÂÖ• assets/mingren_gift_1photo ÁõÆÂΩï</div>
          <div v-else class="frame-grid">
            <div 
              v-for="(item, index) in gift.frameList"
              :key="'gift_' + item.name"
              class="frame-item"
              :class="{ 'disabled': gift.isExporting || gift.isConvertingMP4 }"
              @click="!gift.isExporting && !gift.isConvertingMP4 && openGiftFrame(item)"
            >
              <img :src="'assets/mingren_gift_1photo/' + item.icon" :alt="item.name" class="frame-icon" />
              <div class="frame-name">{{ item.name }}</div>
            </div>
          </div>
        </template>

        <!-- Âêç‰∫∫Á§ºÁâ©3ÂõæÊ¨æÔºàÂºÄÂèë‰∏≠Ôºâ -->
        <template v-if="activeTab === 'gift_3photo'">
          <div class="dev-placeholder">ÂºÄÂèë‰∏≠...</div>
        </template>

        <!-- Âêç‰∫∫Á§ºÁâ©ËßÜÈ¢ëÊ¨æÔºàÂºÄÂèë‰∏≠Ôºâ -->
        <template v-if="activeTab === 'gift_video'">
          <div class="dev-placeholder">ÂºÄÂèë‰∏≠...</div>
        </template>

        <!-- Áî®Êà∑ÂããÁ´†ÂàóË°® -->
        <template v-if="activeTab === 'badge'">
          <div class="frame-grid">
            <!-- Â¢ûÂä†Ê†∑ÂºèÊåâÈíÆ -->
            <div class="frame-item add-btn" @click="openBadgeAddModal">
              <div class="add-icon">+</div>
              <div class="frame-name">Â¢ûÂä†Ê†∑Âºè</div>
            </div>
            <!-- ÂããÁ´†ÂàóË°® -->
            <div 
              v-for="(item, index) in badge.list"
              :key="'badge_' + index"
              class="frame-item"
              @click="openBadgeGenModal(item)"
            >
              <div class="delete-badge-btn" v-if="item.isCustom" @click.stop="deleteBadge(item)">√ó</div>
              <div class="edit-badge-btn" v-if="item.isCustom" @click.stop="openBadgeEditModal(item)">‚úé</div>
              <img :src="item.url" :alt="item.name" class="frame-icon" />
              <div class="frame-name">{{ item.name }}</div>
            </div>
          </div>
        </template>
      </div>

      <!-- ToastÊèêÁ§∫ -->
      <div class="toast" :class="{show: toastVisible}">{{ toastMessage }}</div>

      <!-- Â§ßRÂ§¥ÂÉèÊ°ÜÂºπÁ™ó -->
      <div class="modal-overlay" :class="{show: dar.showModal}">
        <div class="modal-container" v-if="dar.currentFrame">
          <button class="modal-close-btn" :disabled="dar.isExporting" @click="closeDarModal" title="ÂÖ≥Èó≠">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <div class="preview-section">
            <div class="preview-player">
              <div id="darSvgaContainer"></div>
            </div>
            <div class="preview-info">
              <div class="info-row">
                <div class="info-item"><span class="info-label">Êñá‰ª∂ÂêçÔºö</span><span class="info-value">{{ dar.currentFrame.name }}.svga</span></div>
                <div class="info-item"><span class="info-label">Â∞∫ÂØ∏Ôºö</span><span class="info-value">{{ dar.svgaInfo.width }}√ó{{ dar.svgaInfo.height }}</span></div>
                <div class="info-item"><span class="info-label">Â∏ßÁéáÔºö</span><span class="info-value">{{ dar.svgaInfo.fps }} FPS</span></div>
              </div>
            </div>
            <div class="material-preview-container" v-if="dar.materialKeys.length > 0">
              <div class="material-preview-info" v-for="key in dar.materialKeys" :key="key" v-if="dar.materials[key]">
                <div class="section-title">Á¥†ÊùêÔºö{{ key }}</div>
                <div class="material-card">
                  <div class="material-thumb"><img :src="dar.materials[key].previewUrl" v-if="dar.materials[key].previewUrl" /></div>
                  <div class="material-info"><div class="material-name">{{ dar.materials[key].sizeText }}</div></div>
                  <div class="material-btns">
                    <button class="btn" :disabled="dar.isExporting" @click="darReplaceMaterial(key)">ÊõøÊç¢</button>
                    <button class="btn btn-icon" :disabled="dar.isExporting" @click="darDownloadMaterial(key)" title="‰∏ãËΩΩ">‚Üì</button>
                    <button class="btn btn-icon" v-if="dar.replacedImages[key]" :disabled="dar.isExporting" @click="darRestoreMaterial(key)" title="ÊÅ¢Â§ç">‚Ü∫</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="settings-panel">
            <div class="panel-section">
               <div class="section-title">ÊñáÊú¨ÂÜÖÂÆπËæìÂÖ•</div>
               <input type="text" class="text-input" v-model="dar.textInput1" placeholder="ËæìÂÖ•ÊñáÂ≠óÔºåÊîØÊåÅemoji üòä" @input="darRenderText" />
               <div class="position-controls">
                  <div class="position-btns">
                    <button class="pos-btn" @click="darMoveText('up')">‚Üë</button>
                    <button class="pos-btn" @click="darMoveText('down')">‚Üì</button>
                    <button class="pos-btn" @click="darMoveText('left')">‚Üê</button>
                    <button class="pos-btn" @click="darMoveText('right')">‚Üí</button>
                    <button class="pos-btn" @click="darScaleText('down')" title="Áº©Â∞è">-</button>
                    <button class="pos-btn" @click="darScaleText('up')" title="ÊîæÂ§ß">+</button>
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn" style="flex: 1;" @click="darResetText">ÊÅ¢Â§çÈªòËÆ§‰ΩçÁΩÆ</button>
                </div>
            </div>

            <div class="panel-section" v-for="(key, index) in dar.materialKeys" :key="'panel_' + key" v-if="dar.materials[key]">
              <div class="section-title">ÊñáÊú¨ÊïàÊûúÂå∫ÂüüÔºö{{ key }}</div>
              <div class="text-effect-area">
                <div class="text-canvas-wrapper" @mousedown="darStartDragText" @wheel="darHandleWheel">
                  <canvas ref="darTextCanvas" class="text-canvas" width="300" height="50"></canvas>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-primary" style="flex: 1;" @click="darApplyText(key, index)">ÊõøÊç¢"{{ key }}"</button>
                </div>
              </div>
            </div>

            <div class="panel-section" v-if="dar.materialKeys.length === 0">
              <div class="loading-tip">ËØ•SVGAÊú™ÈÖçÁΩÆÂèØÊõøÊç¢Á¥†Êùê</div>
            </div>
            <div class="export-section">
              <button class="btn btn-success export-btn" :disabled="!darCanExport || dar.isExporting" @click="darExportSVGA">ÂØºÂá∫Êñ∞SVGA</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Âêç‰∫∫Á§ºÁâ©Âü∫Êú¨Ê¨æÂºπÁ™ó -->
      <div class="modal-overlay" :class="{show: gift.showModal}">
        <div class="modal-container" v-if="gift.currentFrame">
          <button class="modal-close-btn" :disabled="gift.isExporting || gift.isConvertingMP4" @click="closeGiftModal" title="ÂÖ≥Èó≠">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <div class="preview-section">
            <div class="preview-player">
              <div id="giftSvgaContainer"></div>
            </div>
            <div class="preview-info">
              <div class="info-row">
                <div class="info-item"><span class="info-label">Êñá‰ª∂ÂêçÔºö</span><span class="info-value">{{ gift.currentFrame.name }}.svga</span></div>
                <div class="info-item"><span class="info-label">Â∞∫ÂØ∏Ôºö</span><span class="info-value">{{ gift.svgaInfo.width }}√ó{{ gift.svgaInfo.height }}</span></div>
                <div class="info-item"><span class="info-label">Â∏ßÁéáÔºö</span><span class="info-value">{{ gift.svgaInfo.fps }} FPS</span></div>
              </div>
            </div>
            <div class="material-preview-container" v-if="gift.materials.zaky">
              <div class="material-preview-info">
                <div class="section-title">Á¥†ÊùêÔºözaky</div>
                <div class="material-card">
                  <div class="material-thumb"><img :src="gift.materials.zaky.previewUrl" v-if="gift.materials.zaky.previewUrl" /></div>
                  <div class="material-info"><div class="material-name">{{ gift.materials.zaky.sizeText }}</div></div>
                  <div class="material-btns">
                    <button class="btn" :disabled="gift.isExporting || gift.isConvertingMP4" @click="giftReplaceMaterial('zaky')">ÊõøÊç¢</button>
                    <button class="btn btn-icon" :disabled="gift.isExporting || gift.isConvertingMP4" @click="giftDownloadMaterial('zaky')" title="‰∏ãËΩΩ">‚Üì</button>
                    <button class="btn btn-icon" v-if="gift.replacedImages.zaky" :disabled="gift.isExporting || gift.isConvertingMP4" @click="giftRestoreMaterial('zaky')" title="ÊÅ¢Â§ç">‚Ü∫</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="settings-panel">
            <div class="panel-section" v-if="gift.materials.zaky">
              <div class="section-title">ÂõæÊ†áÁîüÊàêÊïàÊûú</div>
              <div class="icon-generator"><canvas ref="giftIconCanvas" width="300" height="300" class="icon-preview"></canvas></div>
            </div>
            <div class="panel-section" v-if="!gift.materials.zaky">
              <div class="loading-tip">Êú™Ê£ÄÊµãÂà∞ zaky Á¥†Êùê</div>
            </div>
            <div class="export-section">
              <button class="btn btn-success export-btn" :disabled="!giftCanExportMP4 || gift.isConvertingMP4 || gift.isExporting" @click="giftExportMP4AndIcon">
                <span v-if="!gift.isConvertingMP4">ÂØºÂá∫ÂèåÈÄöÈÅìMP4ÂíåPNGÂõæÊ†á</span>
                <span v-else>{{ gift.mp4ConvertStage }} {{ gift.mp4ConvertProgress }}%</span>
              </button>
              <button class="btn btn-success export-btn" style="margin-top: 8px;" :disabled="!giftCanExport || gift.isExporting" @click="giftExportAll">ÂØºÂá∫Êñ∞SVGAÂíåPNGÂõæÊ†á</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Âêç‰∫∫Á§ºÁâ©Ë£ÅÂâ™ÂºπÁ™ó -->
      <div class="crop-modal" v-if="gift.showCropModal" @click.self="!gift.isExporting && !gift.isConvertingMP4 && giftCloseCropModal">
        <div class="crop-modal-content">
          <div class="crop-modal-header">
            <h3>Ë£ÅÂâ™ÂõæÁâáÔºà322√ó423Ôºâ</h3>
            <button class="close-btn" :disabled="gift.isExporting || gift.isConvertingMP4" @click="giftCloseCropModal">√ó</button>
          </div>
          <div class="crop-modal-body">
            <div class="crop-container"><canvas ref="giftCropCanvas" class="crop-canvas"></canvas></div>
            <div class="crop-controls">
              <label>Áº©ÊîæÔºö
                <input type="range" min="0.1" max="4" step="0.0025" v-model.number="gift.cropImageScale" @input="giftRenderCropCanvas" class="crop-scale-slider"/>
                <span class="crop-scale-value">{{ Math.round(gift.cropImageScale * 100) }}%</span>
              </label>
            </div>
            <div class="crop-tips">ÊãñÂä®Ë∞ÉÊï¥ÂõæÁâá‰ΩçÁΩÆÔºåÊªöËΩÆÊàñÊªëÂùóÁº©ÊîæÂõæÁâá</div>
          </div>
          <div class="crop-modal-footer">
            <button class="btn" :disabled="gift.isExporting || gift.isConvertingMP4" @click="giftCloseCropModal">ÂèñÊ∂à</button>
            <button class="btn btn-primary" :disabled="gift.isExporting || gift.isConvertingMP4" @click="giftConfirmCrop">Á°ÆËÆ§Ë£ÅÂâ™</button>
          </div>
        </div>
      </div>

      <!-- Áî®Êà∑ÂããÁ´†ÔºöÂ¢ûÂä†Ê†∑ÂºèÂºπÁ™ó -->
      <div class="modal-overlay" :class="{show: badge.showAddModal}">
        <div class="modal-container" style="height: auto; max-height: 90%;">
          <button class="modal-close-btn" @click="closeBadgeAddModal" title="ÂÖ≥Èó≠">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <div class="preview-section" style="border-right: 1px solid #e3e3e3;">
             <div class="section-title">‰∏ä‰º†PNGÂõæÁâá (ÊãñÊãΩÊàñÁÇπÂáª)</div>
             <div 
               class="upload-area" 
               @click="$refs.badgeFileInput.click()"
               @dragover.prevent
               @drop.prevent="badgeHandleDrop"
             >
               <img v-if="badge.addForm.previewUrl" :src="badge.addForm.previewUrl" class="upload-preview-img" />
               <div v-else class="upload-placeholder">
                 <div style="font-size: 24px; margin-bottom: 8px;">+</div>
                 <div>ÁÇπÂáªÊàñÊãñÊãΩPNGÂõæÁâáÂà∞Ê≠§Â§Ñ</div>
                 <div style="font-size: 12px; margin-top: 4px;">PNG, < 5MB, < 3000px</div>
               </div>
             </div>
          </div>
          <div class="settings-panel" style="width: 400px; box-shadow: none;">
            <div class="panel-section">
              <div class="section-title">{{ badge.editingId ? '‰øÆÊîπÁî®Êà∑ÂããÁ´†Ê†∑Âºè' : 'Â¢ûÂä†Áî®Êà∑ÂããÁ´†Ê†∑Âºè' }}</div>
              <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">ÂêçÁß∞ (ÈùûÂøÖÂ°´ÔºåÈªòËÆ§Êñá‰ª∂Âêç)</div>
                <input type="text" class="text-input" v-model="badge.addForm.name" placeholder="ËØ∑ËæìÂÖ•ÂããÁ´†ÂêçÁß∞" />
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">ÊñáÂ≠óCSSÊ†∑Âºè (ÊâæËÆæËÆ°Â∏àÊèê‰æõÔºåÈùûÂøÖÂ°´)</div>
                <textarea class="css-input" v-model="badge.addForm.css" placeholder="Á≤òË¥¥CSSÊ†∑Âºè‰ª£Á†Å..."></textarea>
              </div>
            </div>
            <div class="export-section">
              <button class="btn btn-success export-btn" :disabled="!badge.addForm.file && !badge.addForm.previewUrl" @click="badgeSubmitAdd">Êèê‰∫§</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Áî®Êà∑ÂããÁ´†ÔºöÁîüÊàêÂõæÁâáÂºπÁ™ó -->
      <div class="modal-overlay" :class="{show: badge.showGenModal}">
        <div class="modal-container" style="width: 500px; height: auto;">
          <button class="modal-close-btn" @click="closeBadgeGenModal" title="ÂÖ≥Èó≠">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <div style="flex: 1; display: flex; flex-direction: column; padding: 24px;">
            <div class="section-title" style="text-align: center;">ÁîüÊàêÁî®Êà∑ÂããÁ´†ÂõæÁâá</div>
            
            <div class="badge-gen-preview" @wheel="badgeHandleWheel">
              <div class="badge-canvas-wrapper" @mousedown="badgeStartDrag">
                <canvas ref="badgeCanvas"></canvas>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <input type="text" class="text-input" v-model="badge.genText" placeholder="ËØ∑ËæìÂÖ•ÊñáÂ≠ó (ÊîØÊåÅEmoji)" @input="badgeRenderCanvas" />
            </div>

            <button class="btn btn-success export-btn" :disabled="!badge.genText || !badge.genText.trim()" @click="badgeExport">ÂØºÂá∫PNGÂõæÁâá</button>
          </div>
        </div>
      </div>

      <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
      <input type="file" ref="darFileInput" accept="image/*" style="display:none" @change="darHandleFileSelect" />
      <input type="file" ref="giftFileInput" accept="image/*" style="display:none" @change="giftHandleFileSelect" />
      <input type="file" ref="badgeFileInput" accept="image/png" style="display:none" @change="badgeHandleFileSelect" />
    </div>

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <!-- SVGA Player -->
    <script src="https://cdn.jsdelivr.net/npm/svgaplayerweb@2.3.1/build/svga.min.js"></script>
    <!-- Pako (Áî®‰∫éÂéãÁº©/Ëß£Âéã) -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.0.4/dist/pako.min.js"></script>
    <!-- Protobuf.js (Áî®‰∫éËß£Êûêproto) -->
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

    <script>
      new Vue({
        el: '#app',
        data: function() {
          return {
            isDarkMode: false,
            activeTab: 'dar',
            toastVisible: false,
            toastMessage: '',
            
            // Â§ßRÂ§¥ÂÉèÊ°ÜÊï∞ÊçÆ
            dar: {
              loading: true,
              frameList: [],
              currentFrame: null,
              svgaPlayer: null,
              svgaParser: null,
              svgaVideoItem: null,
              svgaFile: null,
              svgaInfo: { width: 0, height: 0, fps: 0 },
              materials: {}, // Âä®ÊÄÅÂ≠òÂÇ®Á¥†Êùê‰ø°ÊÅØ
              materialKeys: [], // ÂΩìÂâçSVGAÂåÖÂê´ÁöÑÁ¥†ÊùêkeyÂàóË°®
              replacedImages: {},
              textInput1: '',
              textOffset: { x: 0, y: 0 },
              textScale: 1,
              draggingText: false,
              dragStartPos: { x: 0, y: 0 },
              textStyle: {
                fontSize: 24,
                fontFamily: "'Noto Sans', 'Noto Sans SC', sans-serif",
                fillColor: '#ffffff',
                strokeColor: '#000000',
                strokeWidth: 2,
                textAlign: 'center'
              },
              customTextStyle: {},
              currentReplaceTarget: null,
              showModal: false,
              isExporting: false
            },
            
            // Âêç‰∫∫Á§ºÁâ©Âü∫Êú¨Ê¨æÊï∞ÊçÆ
            gift: {
              loading: true,
              frameList: [],
              currentFrame: null,
              svgaPlayer: null,
              svgaParser: null,
              svgaVideoItem: null,
              svgaFile: null,
              svgaInfo: { width: 0, height: 0, fps: 0 },
              materials: { zaky: null },
              replacedImages: {},
              showModal: false,
              showCropModal: false,
              cropImage: null,
              cropImageScale: 1,
              cropImageOffset: { x: 0, y: 0 },
              cropDragging: false,
              cropDragStart: { x: 0, y: 0 },
              croppedImageData: null,
              currentReplaceTarget: null,
              isExporting: false,
              isConvertingMP4: false,
              mp4ConvertProgress: 0,
              mp4ConvertStage: ''
            },

            // Áî®Êà∑ÂããÁ´†Êï∞ÊçÆ
            badge: {
              list: [],
              customList: [],
              current: null,
              showAddModal: false,
              showGenModal: false,
              editingId: null,
              
              // Â¢ûÂä†Ê†∑ÂºèË°®Âçï
              addForm: {
                name: '',
                file: null,
                previewUrl: '',
                css: '',
                width: 0,
                height: 0
              },
              
              // ÁîüÊàêÂõæÁâá
              genText: '',
              genOffset: { x: 0, y: 0 },
              genScale: 1,
              dragging: false,
              dragStartPos: { x: 0, y: 0 }
            }
          };
        },
        
        mounted: function() {
          var savedTheme = localStorage.getItem('theme');
          if (savedTheme === 'dark') {
            this.isDarkMode = true;
            document.body.classList.add('dark-mode');
          }
          this.loadDarFrameList();
          this.loadGiftFrameList();
          this.badgeLoadList(); // Âä†ËΩΩÂããÁ´†ÂàóË°®
          document.addEventListener('mousemove', this.onDragMove);
          document.addEventListener('mouseup', this.onDragEnd);
        },
        
        beforeDestroy: function() {
          document.removeEventListener('mousemove', this.onDragMove);
          document.removeEventListener('mouseup', this.onDragEnd);
        },
        
        computed: {
          darCanExport: function() { return Object.keys(this.dar.replacedImages).length > 0; },
          giftCanExport: function() { return Object.keys(this.gift.replacedImages).length > 0; },
          giftCanExportMP4: function() { return this.gift.svgaVideoItem !== null; }
        },
        
        methods: {
          toggleTheme: function() {
            this.isDarkMode = !this.isDarkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
          },
          switchTab: function(tab) { this.activeTab = tab; },
          showToast: function(msg) {
            this.toastMessage = msg;
            this.toastVisible = true;
            var _this = this;
            setTimeout(function() { _this.toastVisible = false; }, 2000);
          },
          getTimestampFilename: function(baseName, ext) {
            var now = new Date();
            var y = now.getFullYear();
            var m = String(now.getMonth() + 1).padStart(2, '0');
            var d = String(now.getDate()).padStart(2, '0');
            var h = String(now.getHours()).padStart(2, '0');
            var mi = String(now.getMinutes()).padStart(2, '0');
            var s = String(now.getSeconds()).padStart(2, '0');
            return baseName + '_' + y + m + d + h + mi + s + '.' + ext;
          },
          formatBytes: function(bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          },
          
          // ==================== ÈÄöÁî®SVGAÂä†ËΩΩÊñπÊ≥ï ====================
          loadSVGA: function(module, item, containerId) {
            var _this = this;
            var svgaUrl = item.svga;
            if (svgaUrl.indexOf('http') === 0) svgaUrl += (svgaUrl.indexOf('?') > -1 ? '&' : '?') + '_t=' + Date.now();
            var container = document.getElementById(containerId);
            if (container) container.innerHTML = '';
            module.svgaPlayer = new SVGA.Player('#' + containerId);
            module.svgaParser = new SVGA.Parser('#' + containerId);
            fetch(svgaUrl, { mode: 'cors' })
              .then(function(res) { if (!res.ok) throw new Error('HTTP ' + res.status); return res.blob(); })
              .then(function(blob) {
                module.svgaFile = blob;
                var objectUrl = URL.createObjectURL(blob);
                module.svgaParser.load(objectUrl, function(videoItem) {
                  URL.revokeObjectURL(objectUrl);
                  module.svgaVideoItem = videoItem;
                  module.svgaPlayer.setVideoItem(videoItem);
                  module.svgaPlayer.loops = 0;
                  module.svgaPlayer.startAnimation();
                  module.svgaInfo.width = videoItem.videoSize.width;
                  module.svgaInfo.height = videoItem.videoSize.height;
                  module.svgaInfo.fps = videoItem.FPS;
                  if (module === _this.dar) _this.darExtractMaterials(videoItem);
                  else if (module === _this.gift) _this.giftExtractMaterials(videoItem);
                }, function(err) { URL.revokeObjectURL(objectUrl); _this.showToast('Âä†ËΩΩSVGAÂ§±Ë¥•'); });
              })
              .catch(function(err) { _this.showToast('Ëé∑ÂèñÊñá‰ª∂Â§±Ë¥•'); });
          },
          
          // ÈÄöÁî®ÂØºÂá∫SVGAÊñπÊ≥ï
          exportSVGA: function(module, baseName) {
            var _this = this;
            if (!module.svgaFile || Object.keys(module.replacedImages).length === 0) {
              _this.showToast('ËØ∑ÂÖàÊõøÊç¢Ëá≥Â∞ë‰∏Ä‰∏™Á¥†Êùê'); return;
            }
            _this.showToast('Ê≠£Âú®ÂØºÂá∫...');
            var reader = new FileReader();
            reader.onload = function(e) {
              try {
                var arrayBuffer = e.target.result;
                var uint8Array = new Uint8Array(arrayBuffer);
                var inflatedData = pako.inflate(uint8Array);
                protobuf.load('svga.proto', function(err, root) {
                  if (err) { _this.showToast('ProtoÂä†ËΩΩÂ§±Ë¥•'); return; }
                  try {
                    var MovieEntity = root.lookupType('com.opensource.svga.MovieEntity');
                    var movieData = MovieEntity.decode(inflatedData);
                    for (var imageKey in module.replacedImages) {
                      if (module.replacedImages.hasOwnProperty(imageKey) && movieData.images[imageKey]) {
                        var base64Data = module.replacedImages[imageKey];
                        var base64String = base64Data.split(',')[1] || base64Data;
                        var binaryString = atob(base64String);
                        var bytes = new Uint8Array(binaryString.length);
                        for (var i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                        movieData.images[imageKey] = bytes;
                      }
                    }
                    var buffer = MovieEntity.encode(movieData).finish();
                    var deflatedData = pako.deflate(buffer);
                    var fileName = _this.getTimestampFilename(baseName, 'svga');
                    var blob = new Blob([deflatedData], { type: 'application/octet-stream' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url; a.download = fileName; a.click();
                    URL.revokeObjectURL(url);
                    _this.showToast('ÂØºÂá∫ÊàêÂäüÔºÅ');
                  } catch (decodeErr) { _this.showToast('ÁºñÁ†ÅÂ§±Ë¥•'); }
                });
              } catch (err) { _this.showToast('Â§ÑÁêÜÂ§±Ë¥•'); }
            };
            reader.readAsArrayBuffer(module.svgaFile);
          },
          
          // ÈÄöÁî®Â∫îÁî®Âà∞SVGAÊñπÊ≥ï
          applyImageToSVGA: function(player, imageKey, dataUrl) {
            var img = new Image();
            img.onload = function() {
              player.setImage(img, imageKey);
              player.startAnimation();
            };
            img.src = dataUrl;
          },
          
          // ==================== Â§ßRÂ§¥ÂÉèÊ°ÜÊñπÊ≥ï ====================
          loadDarFrameList: function() {
            var _this = this;
            fetch('assets/dar_svga/file-list.json')
              .then(function(res) { return res.json(); })
              .then(function(list) {
                _this.dar.frameList = list.map(function(item) {
                  return { 
                    name: item.name, 
                    svga: item.svga, 
                    icon: item.name + '.png',
                    textStyle: item.textStyle || null
                  };
                });
                _this.dar.loading = false;
              })
              .catch(function() { _this.dar.frameList = []; _this.dar.loading = false; });
          },
          
          openDarFrame: function(item) {
            if (this.dar.svgaPlayer) this.dar.svgaPlayer.clear();
            this.dar.currentFrame = item;
            this.dar.showModal = true;
            this.dar.materials = {};
            this.dar.materialKeys = item.textStyle ? Object.keys(item.textStyle) : [];
            this.dar.replacedImages = {};
            this.dar.textInput1 = '';
            this.dar.textOffset = { x: 0, y: 0 };
            this.dar.textScale = 1;
            
            // ÂàùÂßãÂåñÊ†∑ÂºèÈÖçÁΩÆ
            this.dar.customTextStyle = item.textStyle || {};
            
            this.$nextTick(function() { this.loadDarSVGA(item); }.bind(this));
          },
          
          closeDarModal: function() {
            if (this.dar.isExporting) return;
            this.dar.showModal = false;
            if (this.dar.svgaPlayer) this.dar.svgaPlayer.clear();
            this.dar.currentFrame = null;
          },
          
          loadDarSVGA: function(item) {
            this.loadSVGA(this.dar, item, 'darSvgaContainer');
          },
          
          darExtractMaterials: function(videoItem) {
            var _this = this;
            var images = videoItem.images || {};
            
            // ÈÅçÂéÜÊâÄÊúâÂä®ÊÄÅkey
            this.dar.materialKeys.forEach(function(key) {
              if (images[key]) {
                var imgData = images[key];
                var previewUrl = typeof imgData === 'string' ? (imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData)) : '';
                var img = new Image();
                img.onload = function() {
                  _this.$set(_this.dar.materials, key, { 
                    previewUrl: previewUrl, 
                    width: this.width, 
                    height: this.height, 
                    sizeText: this.width + '√ó' + this.height 
                  });
                  _this.$forceUpdate();
                  _this.$nextTick(function() {
                     // Ëß¶ÂèëÈáçÁªò
                     _this.darRenderText();
                  });
                };
                img.src = previewUrl;
              }
            });
          },
          
          darRenderTextToCanvas: function(canvas, text, offset, scale, targetKey) {
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var baseStyle = this.dar.textStyle;
            var customStyle = targetKey && this.dar.customTextStyle[targetKey] ? this.dar.customTextStyle[targetKey] : null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!text) return;
            ctx.save();
            var fontSize = baseStyle.fontSize * scale;
            var fontWeight = (customStyle && customStyle.fontWeight) || 'normal';
            ctx.font = fontWeight + ' ' + fontSize + 'px ' + baseStyle.fontFamily;
            ctx.textAlign = baseStyle.textAlign;
            ctx.textBaseline = 'middle';
            var x = canvas.width / 2 + offset.x;
            var y = canvas.height / 2 + offset.y;
            
            if (customStyle && customStyle.multiShadow) {
              for (var i = 0; i < customStyle.multiShadow.length; i++) {
                var parts = customStyle.multiShadow[i].match(/([\d.-]+)px\s+([\d.-]+)px\s+([\d.-]+)px\s+([^\)]+(?:\([^\)]+\))?)/i);
                if (parts) {
                  ctx.shadowOffsetX = parseFloat(parts[1]);
                  ctx.shadowOffsetY = parseFloat(parts[2]);
                  ctx.shadowBlur = parseFloat(parts[3]);
                  ctx.shadowColor = parts[4].trim();
                  if (customStyle.gradient) {
                    var textMetrics = ctx.measureText(text);
                    var textHeight = fontSize;
                    var grad = ctx.createLinearGradient(x, y - textHeight/2, x, y + textHeight/2);
                    for (var j = 0; j < customStyle.gradient.colors.length; j++) {
                      grad.addColorStop(customStyle.gradient.positions[j], customStyle.gradient.colors[j]);
                    }
                    ctx.fillStyle = grad;
                  } else {
                    ctx.fillStyle = customStyle.fillColor || baseStyle.fillColor;
                  }
                  ctx.fillText(text, x, y);
                }
              }
              ctx.shadowOffsetX = 0;
              ctx.shadowOffsetY = 0;
              ctx.shadowBlur = 0;
            } else if (customStyle && customStyle.textShadow) {
              var shadowParts = customStyle.textShadow.match(/([\d.-]+)px\s+([\d.-]+)px\s+([\d.-]+)px\s+([^\)]+(?:\([^\)]+\))?)/i);
              if (shadowParts) {
                ctx.shadowOffsetX = parseFloat(shadowParts[1]);
                ctx.shadowOffsetY = parseFloat(shadowParts[2]);
                ctx.shadowBlur = parseFloat(shadowParts[3]);
                ctx.shadowColor = shadowParts[4].trim();
              }
            } else {
              ctx.shadowOffsetX = 0;
              ctx.shadowOffsetY = 0;
              ctx.shadowBlur = 0;
            }
            
            var strokeW = customStyle && customStyle.strokeWidth !== undefined ? customStyle.strokeWidth : (customStyle ? 0 : baseStyle.strokeWidth);
            if (strokeW > 0) {
              ctx.strokeStyle = (customStyle && customStyle.strokeColor) || baseStyle.strokeColor;
              ctx.lineWidth = strokeW * scale;
              ctx.lineJoin = 'round';
              ctx.strokeText(text, x, y);
            }
            
            if (customStyle && customStyle.gradient) {
              var textMetrics = ctx.measureText(text);
              var textHeight = fontSize;
              var gradient = ctx.createLinearGradient(x, y - textHeight/2, x, y + textHeight/2);
              for (var k = 0; k < customStyle.gradient.colors.length; k++) {
                gradient.addColorStop(customStyle.gradient.positions[k], customStyle.gradient.colors[k]);
              }
              ctx.fillStyle = gradient;
            } else {
              ctx.fillStyle = (customStyle && customStyle.fillColor) || baseStyle.fillColor;
            }
            ctx.fillText(text, x, y);
            ctx.restore();
          },
          
          darRenderText: function() {
            var _this = this;
            var canvases = this.$refs.darTextCanvas;
            if (!canvases || !Array.isArray(canvases)) return;
            
            this.dar.materialKeys.forEach(function(key, index) {
               // Á°Æ‰øùCanvasÂ∞∫ÂØ∏‰∏éÁ¥†ÊùêÂåπÈÖç
               var canvas = canvases[index];
               if (canvas && _this.dar.materials[key]) {
                  if (canvas.width !== _this.dar.materials[key].width || canvas.height !== _this.dar.materials[key].height) {
                    canvas.width = _this.dar.materials[key].width;
                    canvas.height = _this.dar.materials[key].height;
                  }
                  _this.darRenderTextToCanvas(canvas, _this.dar.textInput1, _this.dar.textOffset, _this.dar.textScale, key);
               }
            });
          },
          
          darMoveText: function(direction) {
            switch(direction) {
              case 'up': this.dar.textOffset.y -= 1; break;
              case 'down': this.dar.textOffset.y += 1; break;
              case 'left': this.dar.textOffset.x -= 1; break;
              case 'right': this.dar.textOffset.x += 1; break;
            }
            this.darRenderText();
          },
          
          darScaleText: function(direction) {
            if (direction === 'up') this.dar.textScale += 0.1;
            else this.dar.textScale = Math.max(0.1, this.dar.textScale - 0.1);
            this.darRenderText();
          },
          
          darHandleWheel: function(e) {
            e.preventDefault();
            var delta = e.deltaY > 0 ? -0.05 : 0.05;
            this.dar.textScale = Math.max(0.1, Math.min(5, this.dar.textScale + delta));
            this.darRenderText();
          },
          
          darStartDragText: function(e) {
            this.dar.draggingText = true;
            this.dar.dragStartPos = { x: e.clientX, y: e.clientY };
            e.preventDefault();
          },
          
          darResetText: function() {
            this.dar.textInput1 = '';
            this.dar.textOffset = { x: 0, y: 0 };
            this.dar.textScale = 1;
            this.darRenderText();
          },
          
          darApplyText: function(key, index) {
            var canvases = this.$refs.darTextCanvas;
            if (!canvases || !canvases[index] || !this.dar.textInput1) { this.showToast('ËØ∑ËæìÂÖ•ÊñáÂ≠ó'); return; }
            var dataUrl = canvases[index].toDataURL('image/png');
            this.$set(this.dar.replacedImages, key, dataUrl);
            this.darApplyToSVGA(key, dataUrl);
            this.showToast('Â∑≤Â∫îÁî®Âà∞ ' + key);
          },
          
          darApplyToSVGA: function(imageKey, dataUrl) {
            this.applyImageToSVGA(this.dar.svgaPlayer, imageKey, dataUrl);
          },
          
          darReplaceMaterial: function(key) {
            this.dar.currentReplaceTarget = key;
            this.$refs.darFileInput.click();
          },
          
          darHandleFileSelect: function(e) {
            var _this = this;
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(evt) {
              var dataUrl = evt.target.result;
              var key = _this.dar.currentReplaceTarget;
              var material = _this.dar.materials[key];
              if (material) {
                _this.darScaleImageToSize(dataUrl, material.width, material.height, function(scaledDataUrl) {
                  _this.$set(_this.dar.replacedImages, key, scaledDataUrl);
                  _this.darApplyToSVGA(key, scaledDataUrl);
                  _this.showToast('Â∑≤ÊõøÊç¢ ' + key);
                });
              }
            };
            reader.readAsDataURL(file);
            e.target.value = '';
          },
          
          darScaleImageToSize: function(dataUrl, width, height, callback) {
            var img = new Image();
            img.onload = function() {
              var canvas = document.createElement('canvas');
              canvas.width = width; canvas.height = height;
              var ctx = canvas.getContext('2d');
              var scale = Math.max(width / img.width, height / img.height);
              var scaledWidth = img.width * scale;
              var scaledHeight = img.height * scale;
              var x = (width - scaledWidth) / 2;
              var y = (height - scaledHeight) / 2;
              ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
              callback(canvas.toDataURL('image/png'));
            };
            img.src = dataUrl;
          },
          
          darDownloadMaterial: function(key) {
            var material = this.dar.materials[key];
            if (!material || !material.previewUrl) return;
            var a = document.createElement('a');
            a.href = material.previewUrl;
            a.download = key + '.png';
            a.click();
          },
          
          darRestoreMaterial: function(key) {
            this.$delete(this.dar.replacedImages, key);
            if (this.dar.currentFrame) this.loadDarSVGA(this.dar.currentFrame);
            this.showToast('Â∑≤ÊÅ¢Â§ç ' + key);
          },
          
          darExportSVGA: function() {
            this.dar.isExporting = true;
            var _this = this;
            this.exportSVGA(this.dar, this.dar.currentFrame.name);
            setTimeout(function() {
              _this.darExportFrame5PNG();
              _this.dar.isExporting = false;
            }, 50);
          },
          
          darExportFrame5PNG: function() {
            var _this = this;
            if (!_this.dar.svgaPlayer) return;
            _this.dar.svgaPlayer.pauseAnimation();
            _this.dar.svgaPlayer.stepToFrame(4);
            setTimeout(function() {
              var container = document.getElementById('darSvgaContainer');
              var canvas = container ? container.querySelector('canvas') : null;
              if (canvas) {
                var dataUrl = canvas.toDataURL('image/png');
                var a = document.createElement('a');
                a.href = dataUrl;
                a.download = _this.getTimestampFilename(_this.dar.currentFrame.name + '_frame5', 'png');
                a.click();
              }
              _this.dar.svgaPlayer.startAnimation();
            }, 100);
          },
          
          // ==================== Âêç‰∫∫Á§ºÁâ©Âü∫Êú¨Ê¨æÊñπÊ≥ï ====================
          loadGiftFrameList: function() {
            var _this = this;
            fetch('assets/mingren_gift_1photo/file-list.json')
              .then(function(res) { return res.json(); })
              .then(function(list) {
                _this.gift.frameList = list.map(function(item) {
                  return { name: item.name, svga: item.svga, icon: item.name + '.png' };
                });
                _this.gift.loading = false;
              })
              .catch(function() { _this.gift.frameList = []; _this.gift.loading = false; });
          },
          
          openGiftFrame: function(item) {
            if (this.gift.svgaPlayer) this.gift.svgaPlayer.clear();
            this.gift.currentFrame = item;
            this.gift.showModal = true;
            this.gift.materials = { zaky: null };
            this.gift.replacedImages = {};
            this.gift.croppedImageData = null;
            this.$nextTick(function() { this.loadGiftSVGA(item); }.bind(this));
          },
          
          closeGiftModal: function() {
            if (this.gift.isExporting || this.gift.isConvertingMP4) return;
            this.gift.showModal = false;
            if (this.gift.svgaPlayer) this.gift.svgaPlayer.clear();
            this.gift.currentFrame = null;
          },
          
          loadGiftSVGA: function(item) {
            this.loadSVGA(this.gift, item, 'giftSvgaContainer');
          },
          
          giftExtractMaterials: function(videoItem) {
            var _this = this;
            var images = videoItem.images || {};
            if (images['zaky']) {
              var imgData = images['zaky'];
              var previewUrl = typeof imgData === 'string' ? (imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData)) : '';
              var img = new Image();
              img.onload = function() {
                _this.gift.materials.zaky = { previewUrl: previewUrl, width: this.width, height: this.height, sizeText: this.width + '√ó' + this.height };
                _this.$forceUpdate();
              };
              img.src = previewUrl;
            }
          },
          
          giftApplyToSVGA: function(imageKey, dataUrl) {
            this.applyImageToSVGA(this.gift.svgaPlayer, imageKey, dataUrl);
          },
          
          giftReplaceMaterial: function(key) {
            this.gift.currentReplaceTarget = key;
            this.$refs.giftFileInput.click();
          },
          
          giftHandleFileSelect: function(e) {
            var _this = this;
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(evt) {
              var img = new Image();
              img.onload = function() {
                _this.gift.cropImage = img;
                _this.gift.showCropModal = true;
                _this.gift.cropImageScale = 1;
                _this.gift.cropImageOffset = { x: 0, y: 0 };
                _this.$nextTick(function() { _this.giftInitCropCanvas(); });
              };
              img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
          },
          
          giftInitCropCanvas: function() {
            var canvas = this.$refs.giftCropCanvas;
            if (!canvas) return;
            var container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            this.giftRenderCropCanvas();
            canvas.addEventListener('mousedown', this.giftStartCropDrag);
            canvas.addEventListener('wheel', this.giftHandleCropWheel);
          },
          
          giftRenderCropCanvas: function() {
            var canvas = this.$refs.giftCropCanvas;
            if (!canvas || !this.gift.cropImage) return;
            var ctx = canvas.getContext('2d');
            var cw = canvas.width, ch = canvas.height;
            ctx.clearRect(0, 0, cw, ch);
            var img = this.gift.cropImage;
            var scale = this.gift.cropImageScale;
            var offset = this.gift.cropImageOffset;
            var imgW = img.width * scale, imgH = img.height * scale;
            var imgX = (cw - imgW) / 2 + offset.x, imgY = (ch - imgH) / 2 + offset.y;
            ctx.drawImage(img, imgX, imgY, imgW, imgH);
            var cropW = 322, cropH = 423;
            var cropX = (cw - cropW) / 2, cropY = (ch - cropH) / 2;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, cw, cropY);
            ctx.fillRect(0, cropY, cropX, cropH);
            ctx.fillRect(cropX + cropW, cropY, cw - cropX - cropW, cropH);
            ctx.fillRect(0, cropY + cropH, cw, ch - cropY - cropH);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
            ctx.strokeRect(cropX, cropY, cropW, cropH);
            ctx.fillStyle = '#fff'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('322 √ó 423', cw / 2, cropY - 10);
          },
          
          giftStartCropDrag: function(e) {
            this.gift.cropDragging = true;
            this.gift.cropDragStart = { x: e.clientX, y: e.clientY };
          },
          
          onDragMove: function(e) {
            if (this.dar.draggingText) {
              var dx = (e.clientX - this.dar.dragStartPos.x) / 1.2;
              var dy = (e.clientY - this.dar.dragStartPos.y) / 1.2;
              this.dar.textOffset.x += dx;
              this.dar.textOffset.y += dy;
              this.dar.dragStartPos = { x: e.clientX, y: e.clientY };
              this.darRenderText();
            }
            if (this.gift.cropDragging) {
              var dx2 = e.clientX - this.gift.cropDragStart.x;
              var dy2 = e.clientY - this.gift.cropDragStart.y;
              this.gift.cropImageOffset.x += dx2;
              this.gift.cropImageOffset.y += dy2;
              this.gift.cropDragStart = { x: e.clientX, y: e.clientY };
              this.giftRenderCropCanvas();
            }
            if (this.badge.dragging) {
              var dx3 = e.clientX - this.badge.dragStartPos.x;
              var dy3 = e.clientY - this.badge.dragStartPos.y;
              this.badge.genOffset.x += dx3;
              this.badge.genOffset.y += dy3;
              this.badge.dragStartPos = { x: e.clientX, y: e.clientY };
              this.badgeRenderCanvas();
            }
          },
          
          onDragEnd: function() {
            this.dar.draggingText = false;
            this.gift.cropDragging = false;
            this.badge.dragging = false;
          },
          
          giftHandleCropWheel: function(e) {
            e.preventDefault();
            var delta = e.deltaY > 0 ? -0.05 : 0.05;
            this.gift.cropImageScale = Math.max(0.1, Math.min(5, this.gift.cropImageScale + delta));
            this.giftRenderCropCanvas();
          },
          
          giftCloseCropModal: function() {
            this.gift.showCropModal = false;
            this.gift.cropImage = null;
            this.gift.cropImageScale = 1;
            this.gift.cropImageOffset = { x: 0, y: 0 };
          },
          
          giftConfirmCrop: function() {
            var _this = this;
            var canvas = this.$refs.giftCropCanvas;
            if (!canvas || !this.gift.cropImage) return;
            var cropCanvas = document.createElement('canvas');
            cropCanvas.width = 322; cropCanvas.height = 423;
            var cropCtx = cropCanvas.getContext('2d');
            var cw = canvas.width, ch = canvas.height;
            var cropX = (cw - 322) / 2, cropY = (ch - 423) / 2;
            var img = this.gift.cropImage;
            var scale = this.gift.cropImageScale;
            var offset = this.gift.cropImageOffset;
            var imgW = img.width * scale, imgH = img.height * scale;
            var imgX = (cw - imgW) / 2 + offset.x, imgY = (ch - imgH) / 2 + offset.y;
            var sx = (cropX - imgX) / scale, sy = (cropY - imgY) / scale;
            var sw = 322 / scale, sh = 423 / scale;
            cropCtx.drawImage(img, sx, sy, sw, sh, 0, 0, 322, 423);
            var croppedDataUrl = cropCanvas.toDataURL('image/png');
            this.gift.croppedImageData = croppedDataUrl;
            var key = this.gift.currentReplaceTarget;
            this.$set(this.gift.replacedImages, key, croppedDataUrl);
            this.giftApplyToSVGA(key, croppedDataUrl);
            this.giftGenerateIcon();
            this.giftCloseCropModal();
            this.showToast('Â∑≤Ë£ÅÂâ™Âπ∂Â∫îÁî®Âà∞ ' + key);
          },
          
          giftGenerateIcon: function() {
            var _this = this;
            var canvas = this.$refs.giftIconCanvas;
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 300, 300);
            var loadCount = 0, colorImg = null, zakyImg = null, maskImg = null;
            function checkComplete() {
              loadCount++;
              if (loadCount === 3) drawIcon();
            }
            function drawIcon() {
              var maskedZakyCanvas = null;
              if (zakyImg) {
                var zakyW = 155.57, zakyH = 204.36;
                var tempCanvas = document.createElement('canvas');
                tempCanvas.width = 300; tempCanvas.height = 300;
                var tempCtx = tempCanvas.getContext('2d');
                var zakyX = 76.82, zakyY = 42.71;
                tempCtx.save();
                tempCtx.translate(zakyX + zakyW/2, zakyY + zakyH/2);
                tempCtx.rotate(15 * Math.PI / 180);
                tempCtx.drawImage(zakyImg, -zakyW/2, -zakyH/2, zakyW, zakyH);
                tempCtx.restore();
                if (maskImg) {
                  tempCtx.globalCompositeOperation = 'destination-in';
                  tempCtx.drawImage(maskImg, 0, 0, 300, 300);
                }
                maskedZakyCanvas = tempCanvas;
              }
              if (maskedZakyCanvas) ctx.drawImage(maskedZakyCanvas, 0, 0, 300, 300);
              if (colorImg) ctx.drawImage(colorImg, 0, 0, 300, 300);
            }
            if (this.gift.croppedImageData) {
              var zakyImage = new Image();
              zakyImage.onload = function() { zakyImg = zakyImage; checkComplete(); };
              zakyImage.onerror = checkComplete;
              zakyImage.src = this.gift.croppedImageData;
            } else { checkComplete(); }
            var maskImage = new Image();
            maskImage.onload = function() { maskImg = maskImage; checkComplete(); };
            maskImage.onerror = checkComplete;
            maskImage.src = 'assets/img/icon_musk.png';
            if (this.gift.currentFrame && this.gift.currentFrame.icon) {
              var colorImage = new Image();
              colorImage.onload = function() { colorImg = colorImage; checkComplete(); };
              colorImage.onerror = checkComplete;
              colorImage.src = 'assets/mingren_gift_1photo/' + this.gift.currentFrame.icon;
            } else { checkComplete(); }
          },
          
          giftDownloadMaterial: function(key) {
            var material = this.gift.materials[key];
            if (!material || !material.previewUrl) return;
            var a = document.createElement('a');
            a.href = material.previewUrl;
            a.download = key + '.png';
            a.click();
          },
          
          giftRestoreMaterial: function(key) {
            this.$delete(this.gift.replacedImages, key);
            this.gift.croppedImageData = null;
            if (this.gift.currentFrame) this.loadGiftSVGA(this.gift.currentFrame);
            var canvas = this.$refs.giftIconCanvas;
            if (canvas) canvas.getContext('2d').clearRect(0, 0, 300, 300);
            this.showToast('Â∑≤ÊÅ¢Â§ç ' + key);
          },
          
          giftExportIconPNG: function() {
            var canvas = this.$refs.giftIconCanvas;
            if (canvas) {
              var baseName = this.gift.currentFrame ? this.gift.currentFrame.name : 'icon';
              var filename = this.getTimestampFilename(baseName + '_icon', 'png');
              var dataUrl = canvas.toDataURL('image/png');
              var a = document.createElement('a');
              a.href = dataUrl; a.download = filename; a.click();
            }
          },
          
          giftExportAll: function() {
            this.gift.isExporting = true;
            try {
              this.giftExportSVGA();
              var _this = this;
              setTimeout(function() {
                _this.giftExportIconPNG();
                _this.gift.isExporting = false;
              }, 50);
            } catch (err) { this.gift.isExporting = false; }
          },
          
          giftExportSVGA: function() {
            this.exportSVGA(this.gift, this.gift.currentFrame.name);
          },
          
          giftExportMP4AndIcon: async function() {
            var _this = this;
            if (!this.gift.svgaVideoItem) { this.showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Á§ºÁâ©'); return; }
            this.gift.isExporting = true;
            try {
              this.giftExportIconPNG();
              await new Promise(function(r) { setTimeout(r, 50); });
              await this.giftConvertToMP4();
            } catch (err) {
              console.error('MP4ÂØºÂá∫ÈîôËØØ:', err);
              this.showToast('MP4ÂØºÂá∫Â§±Ë¥•: ' + err.message);
            } finally {
              this.gift.isExporting = false;
            }
          },
          
          giftConvertToMP4: async function() {
            var _this = this;
            _this.gift.isConvertingMP4 = true;
            _this.gift.mp4ConvertProgress = 0;
            try {
              var width = _this.gift.svgaInfo.width || 0;
              var height = _this.gift.svgaInfo.height || 0;
              var fps = _this.gift.svgaInfo.fps || 30;
              if (width === 0 || height === 0) { _this.showToast('SVGAÂ∞∫ÂØ∏‰ø°ÊÅØÈîôËØØ'); _this.gift.isConvertingMP4 = false; return; }
              _this.gift.mp4ConvertStage = 'Âä†ËΩΩËΩ¨Êç¢Âô®'; _this.gift.mp4ConvertProgress = 5;
              await _this.giftLoadFFmpeg();
              _this.gift.mp4ConvertStage = 'ÊèêÂèñÂ∫èÂàóÂ∏ß'; _this.gift.mp4ConvertProgress = 15;
              var frames = await _this.giftExtractFrames(width, height);
              _this.gift.mp4ConvertStage = 'ÂêàÊàêÂèåÈÄöÈÅì'; _this.gift.mp4ConvertProgress = 45;
              var dualFrames = await _this.giftComposeDualFrames(frames, width, height);
              _this.gift.mp4ConvertStage = 'ÁºñÁ†ÅMP4'; _this.gift.mp4ConvertProgress = 70;
              var mp4Blob = await _this.giftEncodeMP4(dualFrames, width, height, fps);
              _this.gift.mp4ConvertProgress = 95;
              var baseName = _this.gift.currentFrame ? _this.gift.currentFrame.name : 'gift';
              var filename = _this.getTimestampFilename(baseName + '_dual', 'mp4');
              var url = URL.createObjectURL(mp4Blob);
              var a = document.createElement('a');
              a.href = url; a.download = filename; a.click();
              URL.revokeObjectURL(url);
              _this.gift.mp4ConvertProgress = 100;
              _this.showToast('MP4ÂØºÂá∫ÊàêÂäü');
            } catch (err) {
              console.error('MP4ËΩ¨Êç¢ÈîôËØØ:', err);
              _this.showToast('MP4ËΩ¨Êç¢Â§±Ë¥•: ' + err.message);
            } finally {
              _this.gift.isConvertingMP4 = false;
              _this.gift.mp4ConvertStage = '';
              _this.gift.mp4ConvertProgress = 0;
            }
          },
          
          giftLoadFFmpeg: async function() {
            if (window.ffmpegInstance && window.ffmpegLoaded) return window.ffmpegInstance;
            if (!window.FFmpeg) {
              await new Promise(function(resolve, reject) {
                var script = document.createElement('script');
                script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js';
                script.onload = resolve; script.onerror = reject;
                document.head.appendChild(script);
              });
            }
            var ffmpeg = window.FFmpeg.createFFmpeg({ log: false });
            await ffmpeg.load();
            window.ffmpegInstance = ffmpeg;
            window.ffmpegLoaded = true;
            return ffmpeg;
          },
          
          giftExtractFrames: async function(targetWidth, targetHeight) {
            var _this = this;
            var frames = [];
            var totalFrames = _this.gift.svgaVideoItem.frames;
            var player = _this.gift.svgaPlayer;
            var wasPlaying = !player.paused;
            if (wasPlaying) player.pauseAnimation();
            var container = document.getElementById('giftSvgaContainer');
            var canvas = container.querySelector('canvas');
            if (!canvas) throw new Error('Êú™ÊâæÂà∞SVGA canvasÂÖÉÁ¥†');
            for (var i = 0; i < totalFrames; i++) {
              player.stepToFrame(i);
              await new Promise(function(r) { setTimeout(r, 16); });
              var tempCanvas = document.createElement('canvas');
              tempCanvas.width = targetWidth; tempCanvas.height = targetHeight;
              var ctx = tempCanvas.getContext('2d');
              ctx.imageSmoothingEnabled = false;
              ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
              var imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
              frames.push(imageData);
              if (i % 5 === 0) await new Promise(function(r) { setTimeout(r, 0); });
            }
            if (wasPlaying) player.startAnimation();
            else player.stepToFrame(0);
            return frames;
          },
          
          giftComposeDualFrames: async function(frames, width, height) {
            var dualFrames = [];
            for (var i = 0; i < frames.length; i++) {
              var dualCanvas = this.giftComposeDualChannel(frames[i]);
              dualFrames.push(dualCanvas);
              if (i % 5 === 0) await new Promise(function(r) { setTimeout(r, 0); });
            }
            return dualFrames;
          },
          
          giftComposeDualChannel: function(imageData) {
            var width = imageData.width, height = imageData.height;
            var dualCanvas = document.createElement('canvas');
            dualCanvas.width = width * 2; dualCanvas.height = height;
            var dualCtx = dualCanvas.getContext('2d', { alpha: true, willReadFrequently: true });
            dualCtx.imageSmoothingEnabled = false;
            dualCtx.clearRect(0, 0, width * 2, height);
            var leftData = dualCtx.createImageData(width, height);
            var rightData = dualCtx.createImageData(width, height);
            for (var i = 0; i < imageData.data.length; i += 4) {
              var r = imageData.data[i + 0], g = imageData.data[i + 1], b = imageData.data[i + 2], a = imageData.data[i + 3];
              var finalR = r, finalG = g, finalB = b;
              if (a > 0 && a < 255) {
                finalR = Math.min(255, Math.round(r * 255 / a));
                finalG = Math.min(255, Math.round(g * 255 / a));
                finalB = Math.min(255, Math.round(b * 255 / a));
              } else if (a === 0) { finalR = finalG = finalB = 0; }
              leftData.data[i + 0] = finalR; leftData.data[i + 1] = finalG; leftData.data[i + 2] = finalB; leftData.data[i + 3] = a;
              rightData.data[i + 0] = a; rightData.data[i + 1] = a; rightData.data[i + 2] = a; rightData.data[i + 3] = 255;
            }
            dualCtx.putImageData(leftData, 0, 0);
            dualCtx.putImageData(rightData, width, 0);
            return dualCanvas;
          },
          
          giftEncodeMP4: async function(dualFrames, width, height, fps) {
            var ffmpeg = window.ffmpegInstance;
            for (var i = 0; i < dualFrames.length; i++) {
              var canvas = dualFrames[i];
              var blackCanvas = document.createElement('canvas');
              blackCanvas.width = width * 2; blackCanvas.height = height;
              var blackCtx = blackCanvas.getContext('2d');
              var dualData = canvas.getContext('2d').getImageData(0, 0, width * 2, height);
              var blackData = blackCtx.createImageData(width * 2, height);
              for (var j = 0; j < dualData.data.length; j += 4) {
                blackData.data[j + 0] = dualData.data[j + 0];
                blackData.data[j + 1] = dualData.data[j + 1];
                blackData.data[j + 2] = dualData.data[j + 2];
                blackData.data[j + 3] = 255;
              }
              blackCtx.putImageData(blackData, 0, 0);
              var blob = await new Promise(function(resolve) { blackCanvas.toBlob(resolve, 'image/jpeg', 0.6); });
              var data = new Uint8Array(await blob.arrayBuffer());
              var filename = 'frame_' + String(i).padStart(4, '0') + '.jpg';
              ffmpeg.FS('writeFile', filename, data);
              if (i % 5 === 0) await new Promise(function(r) { setTimeout(r, 0); });
            }
            var args = ['-framerate', String(fps), '-i', 'frame_%04d.jpg', '-c:v', 'libx264', '-profile:v', 'high', '-level', '4.0', '-pix_fmt', 'yuv420p', '-crf', '23', '-preset', 'medium', '-movflags', '+faststart', '-an', 'output.mp4'];
            await ffmpeg.run.apply(ffmpeg, args);
            var mp4Data = ffmpeg.FS('readFile', 'output.mp4');
            var mp4Blob = new Blob([mp4Data.buffer], { type: 'video/mp4' });
            for (var k = 0; k < dualFrames.length; k++) {
              try { ffmpeg.FS('unlink', 'frame_' + String(k).padStart(4, '0') + '.jpg'); } catch (e) {}
            }
            try { ffmpeg.FS('unlink', 'output.mp4'); } catch (e) {}
            return mp4Blob;
          },

          // ==================== Áî®Êà∑ÂããÁ´†ÊñπÊ≥ï ====================
          badgeLoadList: function() {
            var _this = this;
            // 1. Âä†ËΩΩÊú¨Âú∞Â≠òÂÇ®ÁöÑËá™ÂÆö‰πâÂããÁ´†
            var custom = [];
            try {
              var stored = localStorage.getItem('custom_badges');
              if (stored) custom = JSON.parse(stored);
            } catch(e) { console.error('Âä†ËΩΩÊú¨Âú∞ÂããÁ´†Â§±Ë¥•', e); }
            this.badge.customList = custom;
            
            // 2. Âä†ËΩΩxunzhangÊñá‰ª∂Â§πÈáåÁöÑÈÖçÁΩÆ (ÊöÇÊú™Êèê‰æõÔºåÂÖàÁΩÆÁ©∫ÊàñÂ∞ùËØïÂä†ËΩΩ)
            // ÂÅáËÆæÊúâ‰∏™ assets/xunzhang/file-list.jsonÔºåÊ≤°ÊúâÁöÑËØùÂ∞±Âè™ÊúâËá™ÂÆö‰πâ
            this.badge.list = [];
            // ÂêàÂπ∂ÊòæÁ§∫
            this.badgeUpdateList();
          },

          badgeUpdateList: function() {
            // ÂêàÂπ∂ÔºöÈ¢ÑÁΩÆÂàóË°® + Ëá™ÂÆö‰πâÂàóË°®
            // È¢ÑÁΩÆÂàóË°®ÊöÇ‰∏∫Á©∫ÔºåÂêéÁª≠ÂèØÊâ©Â±ï
            var defaultList = []; 
            this.badge.list = defaultList.concat(this.badge.customList.map(function(item) {
              return { 
                name: item.name, 
                url: item.url, 
                css: item.css, 
                width: item.width,
                height: item.height,
                isCustom: true,
                id: item.id
              };
            }));
          },

          openBadgeAddModal: function() {
            this.badge.editingId = null;
            this.badge.addForm = {
              name: '',
              file: null,
              previewUrl: '',
              css: '',
              width: 0,
              height: 0
            };
            this.badge.showAddModal = true;
          },

          openBadgeEditModal: function(item) {
            this.badge.editingId = item.id;
            this.badge.addForm = {
              name: item.name,
              file: null, // ÁºñËæëÊó∂‰∏çÂº∫Âà∂ÈáçÊñ∞‰∏ä‰º†Êñá‰ª∂
              previewUrl: item.url,
              css: item.css || '',
              width: item.width,
              height: item.height
            };
            this.badge.showAddModal = true;
          },

          closeBadgeAddModal: function() {
            this.badge.showAddModal = false;
            this.badge.editingId = null;
          },

          badgeHandleFileSelect: function(e) {
            var file = e.target.files[0];
            this.badgeProcessFile(file);
            e.target.value = '';
          },

          badgeHandleDrop: function(e) {
            var file = e.dataTransfer.files[0];
            this.badgeProcessFile(file);
          },

          badgeProcessFile: function(file) {
            var _this = this;
            if (!file) return;
            
            // Ê†°È™åÔºöÊòØÂê¶PNG
            if (file.type !== 'image/png') {
              this.showToast('Âè™ÊîØÊåÅPNGÂõæÁâá');
              return;
            }
            
            // Ê†°È™åÔºöÂ§ßÂ∞èÊòØÂê¶Ë∂ÖËøá5M
            if (file.size > 5 * 1024 * 1024) {
              this.showToast('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá5M');
              return;
            }

            var reader = new FileReader();
            reader.onload = function(evt) {
              var img = new Image();
              img.onload = function() {
                // Ê†°È™åÔºöÂ∞∫ÂØ∏ÊòØÂê¶Ë∂ÖËøá3000px
                if (img.width > 3000 || img.height > 3000) {
                  _this.showToast('ÂõæÁâáÂÆΩÈ´ò‰∏çËÉΩË∂ÖËøá3000px');
                  return;
                }
                
                _this.badge.addForm.file = file;
                _this.badge.addForm.previewUrl = evt.target.result;
                _this.badge.addForm.width = img.width;
                _this.badge.addForm.height = img.height;
                
                // ÈªòËÆ§ÂêçÁß∞‰ΩøÁî®Êñá‰ª∂ÂêçÔºàÂéªÊâ©Â±ïÂêçÔºâ
                if (!_this.badge.addForm.name) {
                  var name = file.name.replace(/\.[^/.]+$/, "");
                  _this.badge.addForm.name = name;
                }
              };
              img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
          },

          badgeSubmitAdd: function() {
            var form = this.badge.addForm;
            var _this = this;
            if ((!form.file && !form.previewUrl)) {
              this.showToast('ËØ∑‰∏ä‰º†ÂõæÁâá');
              return;
            }
            
            // ÁÆÄÂçïÁöÑCSSÊ†°È™å (ÈùûÂº∫Âà∂Ôºå‰ªÖÊèêÁ§∫)
            if (form.css && form.css.trim() !== '') {
               // ËøôÈáå‰∏çÂÅö‰∏•Ê†ºÊ†°È™åÔºåÁî®Êà∑Ë¥üË¥£Á≤òË¥¥Ê≠£Á°ÆÁöÑCSS
            }

            if (this.badge.editingId) {
              // ÁºñËæëÁé∞Êúâ
              var index = this.badge.customList.findIndex(function(i) { return i.id === _this.badge.editingId; });
              if (index > -1) {
                var updatedItem = Object.assign({}, this.badge.customList[index], {
                  name: form.name || 'Êú™ÂëΩÂêçÂããÁ´†',
                  url: form.previewUrl,
                  css: form.css,
                  width: form.width,
                  height: form.height,
                  // idÂíåtimestamp‰øùÊåÅ‰∏çÂèò
                });
                // Vue‰∏çËÉΩÊ£ÄÊµãÁ¥¢ÂºïËµãÂÄºÔºå‰ΩøÁî®splice
                this.badge.customList.splice(index, 1, updatedItem);
                this.showToast('‰øÆÊîπÊàêÂäü');
              }
            } else {
              // Êñ∞Â¢û
              var newItem = {
                id: Date.now(),
                name: form.name || 'Êú™ÂëΩÂêçÂããÁ´†',
                url: form.previewUrl, // Â≠òBase64Âà∞Êú¨Âú∞
                css: form.css,
                width: form.width,
                height: form.height,
                timestamp: Date.now()
              };
              this.badge.customList.push(newItem);
              this.showToast('Ê∑ªÂä†ÊàêÂäü');
            }

            this.badgeSaveCustomList();
            this.badgeUpdateList();
            this.closeBadgeAddModal();
          },

          badgeSaveCustomList: function() {
            try {
              localStorage.setItem('custom_badges', JSON.stringify(this.badge.customList));
            } catch(e) {
              if (e.name === 'QuotaExceededError') {
                this.showToast('Êú¨Âú∞Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºåÊó†Ê≥ï‰øùÂ≠òÊõ¥Â§öÂããÁ´†');
              } else {
                console.error(e);
              }
            }
          },

          deleteBadge: function(item) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂããÁ´†ÂêóÔºü')) return;
            var index = this.badge.customList.findIndex(function(i) { return i.id === item.id; });
            if (index > -1) {
              this.badge.customList.splice(index, 1);
              this.badgeSaveCustomList();
              this.badgeUpdateList();
              this.showToast('Â∑≤Âà†Èô§');
            }
          },

          openBadgeGenModal: function(item) {
            this.badge.current = item;
            this.badge.genText = '';
            this.badge.genOffset = { x: 0, y: 0 };
            this.badge.genScale = 1;
            this.badge.showGenModal = true;
            this.$nextTick(function() {
              this.badgeRenderCanvas();
            }.bind(this));
          },

          closeBadgeGenModal: function() {
            this.badge.showGenModal = false;
            this.badge.current = null;
          },

          badgeStartDrag: function(e) {
            this.badge.dragging = true;
            this.badge.dragStartPos = { x: e.clientX, y: e.clientY };
            e.preventDefault();
          },

          badgeHandleWheel: function(e) {
            e.preventDefault();
            var delta = e.deltaY > 0 ? -0.1 : 0.1;
            this.badge.genScale = Math.max(0.1, Math.min(5, this.badge.genScale + delta));
            this.badgeRenderCanvas();
          },

          badgeRenderCanvas: function() {
            var canvas = this.$refs.badgeCanvas;
            if (!canvas || !this.badge.current) return;
            var item = this.badge.current;
            
            // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏‰∏∫ÂõæÁâáÂ∞∫ÂØ∏
            if (canvas.width !== item.width || canvas.height !== item.height) {
              canvas.width = item.width;
              canvas.height = item.height;
              // Ë∞ÉÊï¥Â§ñÂ±ÇÂÆπÂô®Ê†∑Âºè‰ª•ÈÄÇÂ∫î
              var wrapper = canvas.parentElement;
              var preview = wrapper.parentElement;
              var scale = Math.min(preview.clientWidth / item.width, preview.clientHeight / item.height, 1) * 0.9;
              wrapper.style.transform = 'scale(' + scale + ')';
              wrapper.style.transformOrigin = 'center center';
            }

            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            var _this = this;
            var img = new Image();
            img.onload = function() {
              ctx.drawImage(img, 0, 0);
              
              // ÁªòÂà∂ÊñáÂ≠ó
              if (_this.badge.genText) {
                _this.badgeDrawText(ctx, item.width, item.height);
              }
            };
            img.src = item.url;
          },

          badgeDrawText: function(ctx, width, height) {
             var text = this.badge.genText;
             var offset = this.badge.genOffset;
             var scale = this.badge.genScale;
             var customCss = this.badge.current.css;
             
             ctx.save();
             
             // ÈªòËÆ§Ê†∑Âºè
             var fontSize = 24 * scale;
             var fontFamily = "'Noto Sans', 'Noto Sans SC', sans-serif";
             var fillColor = '#ffffff';
             var strokeColor = '#000000';
             var strokeWidth = 2 * scale;
             
             // Â∞ùËØïËß£ÊûêCSS
             // ËøôÈáåÂè™ÂÅöÁÆÄÂçïÁöÑËß£ÊûêÔºåÊîØÊåÅ color, font-size, font-family, text-shadow, -webkit-text-stroke
             if (customCss) {
               // ÊèêÂèñÈ¢úËâ≤
               var colorMatch = customCss.match(/color:\s*([^;]+)/i);
               if (colorMatch) fillColor = colorMatch[1];
               
               // ÊèêÂèñÂ≠ó‰ΩìÂ§ßÂ∞è (Âü∫‰∫éÈªòËÆ§24pxÁº©Êîæ)
               var sizeMatch = customCss.match(/font-size:\s*([\d.]+)px/i);
               if (sizeMatch) fontSize = parseFloat(sizeMatch[1]) * scale;
               
               // ÊèêÂèñÂ≠ó‰Ωì
               var fontMatch = customCss.match(/font-family:\s*([^;]+)/i);
               if (fontMatch) fontFamily = fontMatch[1];
               
               // ÊèêÂèñÊèèËæπ
               var strokeMatch = customCss.match(/-webkit-text-stroke:\s*([\d.]+)px\s*([^;]+)/i);
               if (strokeMatch) {
                 strokeWidth = parseFloat(strokeMatch[1]) * scale;
                 strokeColor = strokeMatch[2];
               }
             }

             ctx.font = 'bold ' + fontSize + 'px ' + fontFamily;
             ctx.textAlign = 'center';
             ctx.textBaseline = 'middle';
             var x = width / 2 + offset.x;
             var y = height / 2 + offset.y;
             
             // Â§ÑÁêÜÈò¥ÂΩ± (text-shadow)
             if (customCss) {
               var shadowMatch = customCss.match(/text-shadow:\s*([^;]+)/i);
               if (shadowMatch) {
                 var shadows = shadowMatch[1].split(',').map(function(s) { return s.trim(); });
                 // CanvasÂè™ÊîØÊåÅÂçïÂ±ÇshadowÔºåÂ¶ÇÊûúÊúâÂ§ö‰∏™ÔºåÂè™ËÉΩÁîªÂ§öÊ¨°ÊàñËÄÖÂèñÁ¨¨‰∏Ä‰∏™
                 // ËøôÈáåÂ∞ùËØïÁîªÂ§öÊ¨°
                 shadows.forEach(function(shadow) {
                   var parts = shadow.match(/([\d.-]+)px\s+([\d.-]+)px\s+([\d.-]+)px\s+(.+)/);
                   if (parts) {
                     ctx.save();
                     ctx.shadowOffsetX = parseFloat(parts[1]);
                     ctx.shadowOffsetY = parseFloat(parts[2]);
                     ctx.shadowBlur = parseFloat(parts[3]);
                     ctx.shadowColor = parts[4];
                     ctx.fillStyle = fillColor;
                     ctx.fillText(text, x, y);
                     ctx.restore();
                   }
                 });
                 // Â¶ÇÊûúÊúâÈò¥ÂΩ±Ôºå‰∏∫‰∫ÜÈÅøÂÖçÂè†Âä†È¢úËâ≤ËøáÊ∑±ÔºåËøôÈáåÂèØËÉΩ‰∏çÈúÄË¶ÅÂÜçÁîª‰∏ÄÊ¨°Á∫ØËâ≤ÔºåÈô§ÈùûÈò¥ÂΩ±ÊòØÂ§ñÂèëÂÖâ
                 // ‰ΩÜCanvas shadowÁªòÂà∂Êú∫Âà∂ÊòØÔºöÈò¥ÂΩ±+Ê∫êÂõæÂÉè„ÄÇÊâÄ‰ª•‰∏äÈù¢Â∑≤ÁªèÁîª‰∫ÜÊñáÂ≠ó„ÄÇ
                 // Â¶ÇÊûúÂè™ÊòØÊôÆÈÄöÁöÑÊèèËæπ+Â°´ÂÖÖÔºå‰∏ãÈù¢ÁªßÁª≠
               }
             }
             
             // ÊèèËæπ
             if (strokeWidth > 0) {
               ctx.strokeStyle = strokeColor;
               ctx.lineWidth = strokeWidth;
               ctx.lineJoin = 'round';
               ctx.strokeText(text, x, y);
             }
             
             // Â°´ÂÖÖ
             ctx.fillStyle = fillColor;
             ctx.fillText(text, x, y);
             
             ctx.restore();
          },

          badgeExport: function() {
             var canvas = this.$refs.badgeCanvas;
             if (!canvas) return;
             var name = this.badge.current.name || 'badge';
             var filename = this.getTimestampFilename(name, 'png');
             var dataUrl = canvas.toDataURL('image/png');
             var a = document.createElement('a');
             a.href = dataUrl;
             a.download = filename;
             a.click();
          }
        }
      });
    </script>
  </body>
</html>
