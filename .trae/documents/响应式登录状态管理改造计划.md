# 响应式登录状态管理改造计划

## 改造目标
- 实现登录状态的响应式管理
- 自动检测登录状态变化并更新 UI
- 最小化代码改动，主要在 `user-type-controller.js` 中实现
- 为未来的类似功能提供可扩展的解决方案

## 改造步骤

### 1. 增强 UserTypeController 类

**添加响应式管理功能**：
- 添加观察者列表，用于监听登录状态变化
- 添加登录状态轮询检测机制
- 添加扩展的元素控制 API

**具体修改**：
- 在构造函数中添加 `observers`、`lastLoginStatus` 和 `pollingInterval` 属性
- 添加 `startLoginStatusPolling()` 方法，定期检查登录状态变化
- 添加 `stopLoginStatusPolling()` 方法，停止轮询检测
- 添加 `addObserver()` 和 `removeObserver()` 方法，实现观察者模式
- 添加 `notifyObservers()` 方法，通知观察者登录状态变化

### 2. 扩展元素控制 API

**添加更灵活的元素控制方法**：
- `registerElement()`：注册单个需要控制的元素
- `registerElements()`：批量注册需要控制的元素
- `shouldShowElement()`：检查元素是否应该显示
- `isLoggedIn()`：获取当前登录状态
- `getCurrentUserType()`：获取当前用户类型
- `addCustomRule()`：添加自定义元素控制规则
- `removeCustomRule()`：移除自定义元素控制规则

### 3. 修改初始化逻辑

**更新初始化和使用方式**：
- 在初始化完成后启动登录状态轮询检测
- 确保轮询检测在 DOM 加载完成后启动

### 4. 更新 app.js 文件

**移除手动调用**：
- 移除 `updateLoginStatus()` 方法中手动调用 `UserTypeController.refresh()` 的代码
- 保留登录状态更新逻辑

### 5. 测试和验证

**测试改造效果**：
- 测试登录/登出时，侧边栏按钮是否自动显示/隐藏
- 测试不同用户类型的按钮显示规则是否正确应用
- 测试新添加的 API 是否正常工作
- 验证现有功能是否不受影响

## 改造优势

1. **响应式管理**：登录状态变化时自动更新 UI，无需手动调用 `refresh()`
2. **最小化改动**：主要在 `user-type-controller.js` 文件中实现，保持现有代码结构
3. **扩展性强**：为未来可能增加的类似功能或元素提供了更好的管理方案
4. **兼容性好**：与现有代码完全兼容，不影响现有功能
5. **API 简洁**：提供了更简洁的 API 用于控制元素的显示/隐藏

## 注意事项

1. **性能考虑**：登录状态轮询检测设置为每 500ms 一次，对性能影响很小
2. **内存管理**：在 Vue 组件销毁时，记得移除观察者，避免内存泄漏
3. **错误处理**：添加了错误处理，确保自定义规则执行失败时不会影响其他功能
4. **向后兼容**：保持了与现有代码的完全兼容，现有功能不受影响