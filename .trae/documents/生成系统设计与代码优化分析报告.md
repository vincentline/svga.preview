# 系统设计与代码优化分析报告

针对 `docs/assets/js/app.js` 及其周边架构的详细审查报告。

## 1. 核心设计问题：上帝对象 (God Object)

当前 `app.js` 已经膨胀到近 9600 行，承担了过多的职责。它不仅是 View Model，还充当了控制器、业务逻辑层和资源管理器。

* **症状**：

  * **混合关注点**：文件内同时包含 UI 交互（弹窗开关）、业务逻辑（文件格式转换流程）、底层操作（Canvas 绘图、文件读取）和事件监听（拖拽、快捷键）。

  * **状态爆炸**：`data` 中包含了数十个 `isConverting...`、`show...Panel` 标志位，管理起来非常脆弱。

  * **脆弱的依赖**：修改一个功能的 UI 逻辑（如 MP4 导出）可能会意外影响到另一个功能的状态（如 SVGA 播放），因为它们共享同一个 `this` 上下文和大量全局变量。

## 2. 代码重构建议：应拆分的模块 (Extract)

建议将以下逻辑块从 `app.js` 中剥离，形成独立的控制器或模块：

### 2.1 拖拽交互控制器 (`DragDropController`)已完成

* **现状**：`onDragOver`, `onDrop` 以及 `mounted` 中的 `document.body` 事件监听散落在 `app.js` 中。

* **建议**：创建一个 `DragDropController`，专门处理文件拖入事件，解析文件列表，并仅在验证通过后通过回调通知 `app.js` 加载文件。

### 2.2 转换任务编排 (`ConversionTaskController`)

* **现状**：`startMP4Conversion`, `startSVGAConversion` 等方法在 `app.js` 中占据了大量篇幅。它们不仅调用 `FFmpegService`，还手动管理进度条更新 (`this.mp4ConvertProgress = ...`)、取消状态检查和 UI 提示文案。

* **建议**：封装一个 `ConversionTaskController` 或 `TaskManager`。

  * **收益**：`app.js` 只需要调用 `taskManager.start('mp4-to-svga', config)`，并监听 `progress` 和 `complete` 事件，无需关心具体的步骤和取消逻辑。

### 2.3 侧边栏/弹窗管理器 (`PanelManager`)？

* **现状**：`openRightPanel`, `closeAllPanels` 以及每个弹窗的 `open/close` 方法（如 `openMaterialPanel`, `closeMaterialPanel`）充斥代码。

* **建议**：

  * **短期**：创建一个 `PanelManager` 统一管理所有弹窗的互斥逻辑（打开 A 自动关闭 B）。

  * **长期**：将侧边栏拆分为独立的 Vue 组件（如 `<MaterialPanel />`, `<Mp4ExportPanel />`），将弹窗内部的表单逻辑移入组件内部，`app.js` 只需控制组件的显示/隐藏。

### 2.4 模式策略模式 (`ModeStrategy`)已完成

* **现状**：`switchMode` 和 `cleanup...` 方法中充斥着大量的 `if (mode === 'svga') ... else if (mode === 'mp4') ...`。

* **建议**：定义统一的接口 `IModeController` (含 `load`, `play`, `pause`, `cleanup` 方法)，分别为 `SvgaMode`, `Mp4Mode`, `LottieMode` 实现该接口。`app.js` 只需持有当前模式的实例，调用 `currentMode.cleanup()` 即可，无需手动判断类型。

## 3. 代码简化建议 (Simplify)

### 3.1 简化任务取消逻辑 已完成

* **现状**：`cancelOngoingTasks` 手动维护了一个任务列表。如果新增任务忘记在这里添加，会导致 BUG。

* **优化**：建立一个全局的 `runningTasks` 注册表。每个耗时任务开始时注册一个 `cancel` 回调，需要取消时遍历执行所有回调即可。

### 3.2 简化资源释放  已完成

* **现状**：多处使用 `setTimeout(..., 100)` 来延迟释放 `ObjectURL`，这是一种不稳定的 Hack。

* **优化**：引入 `ResourceManager`，统一管理 `ObjectURL` 的生命周期。在明确资源不再使用（如模式切换完成、图片加载完成）时统一释放，或者使用更可靠的事件钩子。

## 4. 现有代码逻辑隐患与修复 (Fixes)已完成

基于之前的详细检查，以下是需要修复的具体逻辑问题：

### 4.1 性能：序列帧串行加载 (Critical)已完成

* **位置**：`loadFrameSequence` 方法（约 2700 行）。

* **问题**：使用 `for` 循环配合 `await` 逐张加载图片。

* **后果**：加载 100 张图片的时间是单张的 100 倍，极慢。

* **修复**：使用 `Promise.all` 并发加载所有图片。

### 4.2 稳定性：错误吞没 (Error Swallowing)已完成

* **位置**：多处 `catch (e) { }` 空代码块（如 `FFmpegService.init` 失败后）。

* **后果**：用户点击无反应，控制台无报错，无法排查问题。

* **修复**：必须添加 `console.error(e)` 或 UI 提示。

### 4.3 稳定性：硬编码超时 (Hardcoded Timeout)已完成

* **位置**：YYEVA 导出时的 `checkCount > 25` (500ms) 超时判断。

* **后果**：在性能较差的机器上，如果渲染超过 500ms，会导致导出黑屏或丢帧。

* **修复**：应监听 `canplay` 或 `seeked` 事件，而不是轮询等待固定时间。

### 4.4 规范：直接 DOM 操作已完成

* **位置**：`document.querySelector('.mp4-select-wrapper')`。

* **修复**：使用 Vue 的 `ref` 机制（`this.$refs.mp4SelectWrapper`）来访问元素，避免类名变更导致逻辑失效。

## 5. 建议删除的代码 (Delete)已完成

* **重复的逻辑实现**：检查 `loadImageFromFile` 等方法，确认 `app.js` 中是否保留了旧的实现代码。目前看大多已改为调用 `utils.js` 的包装器，但如果包装器内没有特殊逻辑（如维护 `this` 状态），可以直接在调用处使用 `utils.js`，删除包装器以减少代码量。

***

**后续行动**：在您确认后，我将不修改代码，而是将上述内容整理为一份 Markdown 文档保存到项目中（如 `docs/CODE_REVIEW.md`），供您参考或分发给其他开发者。
