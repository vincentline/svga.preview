# 重构方案：基于配置映射表的模式切换优化

本方案旨在通过引入**配置映射表 (Configuration Map)**，消除 `app.js` 中 `switchMode` 方法里冗长的 `if-else` 判断逻辑。该重构完全在 `app.js` 内部进行，**零风险**，不涉及类拆分或文件迁移。

## 1. 核心变更点

### A. 新增 `modeStrategies` 映射表
在 Vue 实例的 `data` 中新增一个对象 `modeStrategies`，将每种模式（Key）与其对应的清理方法（cleanup）关联起来。

**代码位置**：`app.js` -> `data` 属性中

```javascript
data: {
    // ... 现有数据 ...
    
    // [新增] 模式策略配置表
    // Key: 模式名称 (currentModule 的值)
    // Value: 配置对象，包含 cleanup 方法名（字符串）
    modeStrategies: {
        'svga':   { cleanup: 'cleanupSvga' },
        'yyeva':  { cleanup: 'cleanupYyeva' },
        'mp4':    { cleanup: 'cleanupMp4' },
        'lottie': { cleanup: 'cleanupLottie' },
        'frames': { cleanup: 'cleanupFrames' }
    },
    
    // ... 现有数据 ...
}
```

### B. 重构 `switchMode` 方法
利用上述映射表，将原本几十行的 `if-else` 逻辑简化为通用的动态调用。

**代码位置**：`app.js` -> `methods` -> `switchMode`

**重构前逻辑**：
```javascript
if (fromMode === 'svga') { this.cleanupSvga(); }
else if (fromMode === 'yyeva') { this.cleanupYyeva(); }
// ... 重复5次 ...
```

**重构后逻辑**：
```javascript
// 获取当前模式的策略配置
var strategy = this.modeStrategies[fromMode];

// 如果存在对应的策略，且配置了清理方法名
if (strategy && strategy.cleanup) {
    // 动态调用清理方法（相当于 this.cleanupSvga()）
    // 使用 this[methodName] 访问 methods 中的函数
    if (typeof this[strategy.cleanup] === 'function') {
        this[strategy.cleanup]();
    }
}
```

## 2. 实施步骤

1.  **修改 `data`**：在 `app.js` 的 `data` 对象末尾添加 `modeStrategies` 配置表。
2.  **重构 `switchMode`**：
    *   保留 `switchMode` 函数签名的前置检查逻辑（如 `skipCleanup` 判断）。
    *   删除中间处理 `fromMode` 清理逻辑的大段 `if-else` 代码块。
    *   插入上述新的动态调用逻辑。
    *   保留后置的 UI 状态重置逻辑（如 `closeAllPanels`, `setScale`）。
3.  **验证**：
    *   依次打开 SVGA、MP4、Lottie 文件，确保能正常播放。
    *   在播放中拖入另一种格式的文件（触发 `switchMode`），观察控制台无报错，且旧资源（如音频、Canvas）被正确清理。

## 3. 预期收益

*   **代码量减少**：`switchMode` 方法体积将减少约 **20-30行**。
*   **可维护性提升**：未来如果新增一种格式（例如 `apng`），只需在 `modeStrategies` 表里加一行配置，无需修改 `switchMode` 的核心逻辑。
*   **零风险**：没有改变任何业务逻辑的执行顺序，只是改变了代码的书写方式。
