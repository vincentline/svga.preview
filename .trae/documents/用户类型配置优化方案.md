# 用户类型配置优化改造计划

## 改造目标

按照新的用户类型逻辑改造现有配置和代码，实现以下结构：
- **未登录用户**（anonymous）：默认展示配置
- **登录普通用户**（loggedIn）：继承默认配置，仅配置差异部分
- **登录管理员**（admin）：继承登录用户配置，仅配置差异部分

## 改造内容

### 1. 配置文件改造 (`site-config.json`)

**新配置结构**：
```json
{
  "version": "2.0.0",
  "features": {
    "advertisement": {
      "enabled": true,
      "position": "right-float"
    },
    "userLevels": {
      "anonymous": {
        "hideButtons": ["material-self-service", "celebrity-gift-video", "avatar-generator", "ai-generate"],
        "showAdvertisement": true
      },
      "loggedIn": {
        "showButtons": ["material-self-service"],
        "showAdvertisement": false
      },
      "admin": {
        "showButtons": ["ai-generate"],
        "showAllButtons": true
      }
    }
  }
}
```

**配置说明**：
- `anonymous`：未登录用户的默认配置
- `loggedIn`：登录用户的配置，仅列出需要额外显示的功能
- `admin`：管理员的配置，在登录用户基础上的额外配置

### 2. 代码改造

#### 2.1 UserTypeController 改造

**核心改动**：
- 修改 `getUserType()` 方法：根据登录状态和用户角色返回新的用户类型
- 修改 `applyUserTypeConfig()` 方法：实现层级继承的配置应用逻辑
- 修改 `shouldShowElement()` 方法：根据新的配置结构判断元素是否应该显示

**关键逻辑**：
```javascript
// 层级继承逻辑
const userTypeOrder = ['anonymous', 'loggedIn', 'admin'];
const currentIndex = userTypeOrder.indexOf(currentUserType);

// 从默认配置开始，逐层应用高级配置
let finalConfig = { ...userLevels.anonymous };
for (let i = 1; i <= currentIndex; i++) {
  const levelConfig = userLevels[userTypeOrder[i]];
  if (levelConfig) {
    // 合并配置，高级配置覆盖低级配置
    finalConfig = this.mergeUserLevelConfigs(finalConfig, levelConfig);
  }
}
```

#### 2.2 SiteConfigLoader 改造

**核心改动**：
- 更新配置结构解析逻辑
- 添加 `getUserLevelConfig()` 方法：获取用户层级配置
- 更新文档和注释

### 3. 文档更新

**更新内容**：
- `UPDATE_LOG.md`：添加配置结构变更记录
- `README.md`：更新用户类型控制说明
- `site-config.json`：添加详细的配置说明和使用指南

## 改造优势

1. **更符合实际用户场景**：反映真实的用户登录状态和权限差异
2. **逻辑清晰**：采用层级继承模式，减少配置冗余
3. **扩展性强**：易于添加更多用户层级和权限控制
4. **维护成本低**：配置变更时只需修改相关层级，不影响其他层级
5. **灵活性高**：可针对不同登录状态和权限级别进行精细化控制

## 实施步骤

1. **更新配置文件结构**：修改 `site-config.json` 为新的层级结构
2. **改造 UserTypeController**：实现新的用户类型检测和配置应用逻辑
3. **改造 SiteConfigLoader**：更新配置解析逻辑
4. **更新文档**：更新相关文档和注释
5. **测试验证**：测试不同用户类型的展示效果

## 预期效果

- **未登录用户**：显示广告，隐藏高级功能
- **登录普通用户**：不显示广告，显示素材自助功能
- **登录管理员**：显示所有功能，包括AI生成功能
- **配置灵活性**：可通过简单修改配置文件调整不同用户类型的展示内容