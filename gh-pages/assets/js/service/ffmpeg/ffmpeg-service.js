!function(e){"use strict";function t(){this.ffmpeg=null,this.isLoaded=!1,this.isLoading=!1,this.loadError=null,this.isBusy=!1,this._eventListeners={},this._instanceId=Math.random().toString(36).substr(2,9)}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},t.prototype={_getBestCorePath:async function(){var e="https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js";return console.log("[调试] 使用固定FFmpeg Core Path:",e),e},_emit:function(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(function(e){try{e(t)}catch(e){console.error("事件处理函数执行错误:",e)}})},init:async function(t){var r=(t=t||{}).onProgress||function(){},i=t.highPriority||!1,s=void 0!==t.log&&t.log;if(!this.isLoaded||!this.ffmpeg){if(this.isLoading){for(;this.isLoading;)await new Promise(function(e){setTimeout(e,100)});if(this.isLoaded)return;if(this.loadError)throw new Error(this.loadError)}this.isLoading=!0,this.loadError=null,this._emit("loading",{stage:"start",progress:0});try{this._checkSharedArrayBuffer(),"undefined"!=typeof FFmpeg&&void 0!==FFmpeg.createFFmpeg||(r({stage:"loading-library",progress:.1,message:"正在加载FFmpeg库..."}),this._emit("loading",{stage:"loading-library",progress:.1,message:"正在加载FFmpeg库..."}),e.MeeWoo.Core.libraryLoader?await e.MeeWoo.Core.libraryLoader.load(["ffmpeg"],i):await this._loadFFmpegLibrary());var n=t.corePath;n||(r({stage:"checking-cdn",progress:.2,message:"正在优选最佳线路..."}),this._emit("loading",{stage:"checking-cdn",progress:.2,message:"正在优选最佳线路..."}),n=await this._getBestCorePath(),console.log("Selected FFmpeg Core Path:",n)),r({stage:"creating-instance",progress:.3,message:"正在创建FFmpeg实例..."}),this._emit("loading",{stage:"creating-instance",progress:.3,message:"正在创建FFmpeg实例..."}),this.ffmpeg=FFmpeg.createFFmpeg({log:s,corePath:n,progress:function(e){}}),r({stage:"loading-core",progress:.5,message:"正在加载编码器（约25MB，首次加载较慢）..."}),this._emit("loading",{stage:"loading-core",progress:.5,message:"正在加载编码器（约25MB，首次加载较慢）..."}),await this.ffmpeg.load(),r({stage:"done",progress:1,message:"FFmpeg加载完成"}),this._emit("loading",{stage:"done",progress:1,message:"FFmpeg加载完成"}),this.isLoaded=!0,this._emit("loaded",{instanceId:this._instanceId})}catch(e){throw this.loadError=e.message,console.error("FFmpeg加载失败:",e),this._emit("error",{error:e,stage:"loading"}),new Error("加载FFmpeg失败："+e.message)}finally{this.isLoading=!1}}},_checkSharedArrayBuffer:function(){if("undefined"==typeof SharedArrayBuffer){if("serviceWorker"in navigator){var t='SharedArrayBuffer 未启用，需要刷新页面。\n\nService Worker 已就绪，但需要刷新页面才能启用跨域隔离。\n点击"确定"将自动刷新页面。';throw confirm(t)&&e.location.reload(),new Error("需要刷新页面启用 SharedArrayBuffer")}t="您的浏览器不支持 Service Worker，无法启用 SharedArrayBuffer。\n\n请使用现代浏览器（Chrome 67+、Firefox 79+、Safari 15.2+）。";throw alert(t),new Error(t)}},_loadFFmpegLibrary:async function(){var e;if(await(e="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js",new Promise(function(t,r){var i=setTimeout(function(){r(new Error("加载超时(30s): "+e))},3e4),s=document.createElement("script");s.src=e,s.onload=function(){clearTimeout(i),t()},s.onerror=function(){clearTimeout(i),r(new Error("加载失败: "+e))},document.head.appendChild(s)})),"undefined"==typeof FFmpeg||void 0===FFmpeg.createFFmpeg)throw new Error("FFmpeg库加载成功但对象未找到")},extractAudio:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,r=e.totalFrames,i=e.fps,s=e.speedRatio||1,n=e.onProgress||function(){},a=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});try{var o=this.ffmpeg,u="input_audio.mp4",h="audio.mp3";if(n(.1),a())throw new Error("用户取消");var c=await t.arrayBuffer();o.FS("writeFile",u,new Uint8Array(c)),n(.2);var f=["-i",u,"-vn","-acodec","libmp3lame","-q:a","2"];if(Math.abs(s-1)>.01){var p=this.buildAudioTempoFilter(s);f.push("-af",p)}if(f.push("-y",h),n(.3),a())throw new Error("用户取消");await o.run.apply(o,f),n(.9);var l=o.FS("readFile",h);if(this._cleanupFiles([u,h]),n(1),!l||0===l.length)return null;var m=0;return i>0&&(m=Math.round(r/i*1e3)),Number.isFinite(m)||(m=0),[{audioKey:"audio_0",audioData:new Uint8Array(l.buffer||l),startFrame:0,endFrame:r,startTime:0,totalTime:m}]}catch(e){if(this._cleanupFiles(["input_audio.mp4","audio.mp3"]),"用户取消"===e.message)throw this._emit("cancelled",{task:"extractAudio"}),e;return console.error("音频提取失败:",e),this._emit("error",{error:e,task:"extractAudio"}),null}finally{this.isBusy=!1,this._emit("busy",{status:!1})}},buildAudioTempoFilter:function(e){if(e<.2?(console.warn("音频变速比例 "+e+" 过小，强制限制为 0.2"),e=.2):e>12&&(console.warn("音频变速比例 "+e+" 过大，强制限制为 12.0"),e=12),e>=.5&&e<=2)return"atempo="+e.toFixed(4);var t=[];console.log("音频变速比例 "+e.toFixed(4)+" 超出 0.5-2.0 范围，正在构建链式滤镜");for(var r=e;r>2;)t.push("atempo=2.0"),r/=2;for(;r<.5;)t.push("atempo=0.5"),r/=.5;return Math.abs(r-1)>.01&&t.push("atempo="+r.toFixed(4)),t.join(",")},extractAudioWithSpeedRemap:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,r=e.keyframes,i=e.totalFrames,s=parseFloat(e.fps)||30;s<=0&&(s=30);var n=e.originalTotalFrames,a=e.originalFps||s;(!a||a<=0)&&(a=30);var o=e.onProgress||function(){},u=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});try{var h=this.ffmpeg,c="input_video.mp4",f=await t.arrayBuffer();if(h.FS("writeFile",c,new Uint8Array(f)),o(.1),u())throw new Error("用户取消");var p=n/a,l=i/s;Number.isFinite(l)||(l=0),console.log("多段变速音频 - 原始:",p.toFixed(2)+"s","目标:",l.toFixed(2)+"s");for(var m=[],g=0;g<r.length-1;g++){var d=r[g],F=r[g+1],y=d.originalFrame/n*p,w=F.originalFrame/n*p-y;if(!(w<=0)){var v=d.position*l,_=w/(F.position*l-v);m.push({startTime:y,duration:w,speedRatio:_,index:g})}}if(0===m.length)return console.log("无有效音频段"),h.FS("unlink",c),null;if(o(.2),u())throw new Error("用户取消");var b=[],S=m.filter(e=>{var t=Math.max(0,Math.min(e.startTime,p));return Math.min(e.duration,p-t)>0});if(0===S.length)return console.warn("无有效音频段(调整后)"),h.FS("unlink",c),null;var E=.6/S.length;for(g=0;g<m.length;g++){var I=m[g],B=Math.max(0,Math.min(I.startTime,p)),A=Math.min(I.duration,p-B);if(A<=0)console.warn("段"+g+"调整后持续时间为0，跳过");else{var x="segment_"+g+".wav",k=["-ss",B.toFixed(3),"-t",A.toFixed(3),"-i",c,"-vn","-acodec","pcm_s16le","-ar","44100","-ac","1"];if(Math.abs(I.speedRatio-1)>.01){var L=this.buildAudioTempoFilter(I.speedRatio);k.push("-af",L)}if(k.push("-y",x),await h.run.apply(h,k),b.push(x),o(.2+b.length*E),u()){for(var M=[],P=0;P<=g;P++)M.push("segment_"+P+".wav");throw this._cleanupFiles(M),new Error("用户取消")}}}var T="output_audio.mp3";if(1===b.length)await h.run("-i",b[0],"-acodec","libmp3lame","-ar","44100","-ac","1","-b:a","128k","-y",T),this._cleanupFiles([b[0]]);else{var C=b.map(function(e){return"file '"+e+"'"}).join("\n");h.FS("writeFile","concat_list.txt",(new TextEncoder).encode(C)),await h.run("-f","concat","-safe","0","-i","concat_list.txt","-acodec","libmp3lame","-ar","44100","-ac","1","-b:a","128k","-y",T),b.push("concat_list.txt"),this._cleanupFiles(b)}if(o(.9),u())throw new Error("用户取消");var W=h.FS("readFile",T),U=new Blob([W.buffer],{type:"audio/mpeg"}),R=await U.arrayBuffer(),j=Array.from(new Uint8Array(R)),V=0;s>0&&(V=Math.round(i/s*1e3)),Number.isFinite(V)||(V=0);var $=[{audioKey:"audio.mp3",startFrame:0,endFrame:i,startTime:0,totalTime:V,audioData:j}];return this._cleanupFiles([c,T]),o(1),$}catch(e){if(console.error("多段变速音频提取失败:",e),this._cleanupFiles(["input_video.mp4","output_audio.mp3"]),"用户取消"===e.message)throw this._emit("cancelled",{task:"extractAudioWithSpeedRemap"}),e;return this._emit("error",{error:e,task:"extractAudioWithSpeedRemap"}),null}finally{this.isBusy=!1,this._emit("busy",{status:!1})}},convertVideoFormat:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.inputFile,r=e.maxWidth||1280,i=e.onProgress||function(){},s=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var n=this.ffmpeg,a="input.mp4",o="output.mp4";try{if(i(.1),s())throw new Error("用户取消");var u=await t.arrayBuffer();n.FS("writeFile",a,new Uint8Array(u)),i(.2);if(n.setProgress(function(e){i(.2+.7*e.ratio)}),s())throw new Error("用户取消");var h="scale='min("+r+",iw)':-2";if(await n.run("-i",a,"-vf",h,"-c:v","libx264","-profile:v","baseline","-level","3.0","-crf","28","-preset","ultrafast","-c:a","aac","-b:a","96k","-max_muxing_queue_size","1024",o),i(.95),s())throw new Error("用户取消");var c=n.FS("readFile",o),f=new Blob([c.buffer],{type:"video/mp4"});return this._cleanupFiles([a,o]),i(1),f}catch(e){if(this._cleanupFiles([a,o]),"用户取消"===e.message)throw this._emit("cancelled",{task:"convertVideoFormat"}),e;throw this._emit("error",{error:e,task:"convertVideoFormat"}),e}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},convertFramesToMp4:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.frames,r=e.fps||30,i=e.inputFps||r,s=e.quality||80,n=e.audioData,a=e.audioSpeedRatio||1,o=e.onProgress||function(){},u=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var h=this.ffmpeg,c=t.length,f="output.mp4",p="audio.mp3";try{for(var l=0;l<c;l++){if(u())throw new Error("用户取消");var m="frame_"+String(l).padStart(6,"0")+".jpg",g=t[l];g instanceof Blob&&(g=new Uint8Array(await g.arrayBuffer())),g instanceof Uint8Array||(g=new Uint8Array(g)),h.FS("writeFile",m,g),l%5==0&&o(l/c*.4)}var d=!1;if(n&&n.length>0){var F=n;n instanceof Uint8Array||(F=new Uint8Array(n)),h.FS("writeFile",p,F),d=!0}o(.45);var y=Math.round(51-s/100*33),w=["-thread_queue_size","512","-framerate",String(i),"-i","frame_%06d.jpg"];if(d&&(w.push("-thread_queue_size","512"),w.push("-vn","-i",p)),w.push("-c:v","libx264","-preset","fast","-tune","animation","-profile:v","high","-level","4.0","-pix_fmt","yuv420p","-crf",String(y),"-movflags","+faststart","-r",String(r)),d){if(w.push("-c:a","aac","-b:a","128k"),Math.abs(a-1)>.01){var v=this.buildAudioTempoFilter(a);w.push("-af",v)}w.push("-shortest")}w.push("-y",f);if(h.setProgress(function(e){var t=0;void 0!==e.ratio?t=e.ratio:e.time&&e.duration&&(t=e.time/e.duration),o(.45+.5*t)}),u())throw new Error("用户取消");await h.run.apply(h,w),o(.95);var _=h.FS("readFile",f),b=new Blob([_.buffer],{type:"video/mp4"}),S=[f];d&&S.push(p);for(l=0;l<c;l++)S.push("frame_"+String(l).padStart(6,"0")+".jpg");return this._cleanupFiles(S),o(1),b}catch(e){var E=[f,p];for(l=0;l<c;l++)E.push("frame_"+String(l).padStart(6,"0")+".jpg");if(this._cleanupFiles(E),"用户取消"===e.message)throw this._emit("cancelled",{task:"convertFramesToMp4"}),e;throw this._emit("error",{error:e,task:"convertFramesToMp4"}),e}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},extractFrames:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.videoFile,r=e.fps||30,i=e.width,s=e.height,n=e.onProgress||function(){},a=e.checkCancelled||function(){return!1};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var o=this.ffmpeg,u="input.mp4";try{if(n(.1),a())throw new Error("用户取消");var h=await t.arrayBuffer();o.FS("writeFile",u,new Uint8Array(h)),n(.2);var c=["-i",u,"-vf",`fps=${r},scale=${i}:${s}`,"-f","image2","-y","frame_%d.png"];if(n(.3),a())throw new Error("用户取消");if(o.setProgress(function(e){var t=0;void 0!==e.ratio?t=e.ratio:e.time&&e.duration&&(t=e.time/e.duration),n(.3+.5*t)}),await o.run.apply(o,c),n(.8),a())throw new Error("用户取消");for(var f=[],p=1;;){var l=`frame_${p}.png`;try{var m=o.FS("readFile",l);f.push(new Uint8Array(m.buffer||m)),p++}catch(e){break}}for(var g=[u],d=1;d<p;d++)g.push(`frame_${d}.png`);return this._cleanupFiles(g),n(1),f}catch(e){this._cleanupFiles([u]);for(p=1;;){l=`frame_${p}.png`;try{o.FS("unlink",l),p++}catch(e){break}}if("用户取消"===e.message)throw this._emit("cancelled",{task:"extractFrames"}),e;throw console.error("帧提取失败:",e),this._emit("error",{error:e,task:"extractFrames"}),e}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},runCommand:async function(e){if(!this.isLoaded||!this.ffmpeg)throw new Error("FFmpeg未初始化，请先调用init()");var t=e.args||[],r=e.inputFiles||[],i=e.outputFiles||[],s=e.onProgress||function(){};if(this.isBusy)throw new Error("FFmpeg服务正忙，请稍后再试");this.isBusy=!0,this._emit("busy",{status:!0});var n=this.ffmpeg,a=[];try{for(var o=0;o<r.length;o++){var u=r[o];u.name&&u.data&&(n.FS("writeFile",u.name,new Uint8Array(u.data)),a.push(u.name))}n.setProgress(function(e){void 0!==e.ratio&&s(e.ratio)}),await n.run.apply(n,t);var h={};for(o=0;o<i.length;o++){var c=i[o];try{var f=n.FS("readFile",c);h[c]=f,a.push(c)}catch(e){console.warn("无法读取输出文件:",c,e)}}return this._cleanupFiles(a),h}catch(e){throw this._cleanupFiles(a),this._emit("error",{error:e,task:"runCommand"}),e}finally{this.ffmpeg&&this.ffmpeg.setProgress(function(){}),this.isBusy=!1,this._emit("busy",{status:!1})}},_cleanupFiles:function(e){if(this.ffmpeg){var t=this.ffmpeg;e.forEach(function(e){try{t.FS("unlink",e)}catch(e){}})}},getVersion:function(){return this.isLoaded?"FFmpeg 0.11.6 (ffmpeg-core 0.11.0)":"未加载"},reset:function(){if(this.ffmpeg)try{this._cleanupFiles(["input_audio.mp4","audio.mp3","input_video.mp4","output_audio.mp3","input.mp4","output.mp4","output.mp4","audio.mp3","concat_list.txt"])}catch(e){}this.ffmpeg=null,this.isLoaded=!1,this.isLoading=!1,this.loadError=null,this.isBusy=!1,this._emit("reset",{})},destroy:function(){this.reset(),this._eventListeners={},this._emit("destroy",{instanceId:this._instanceId})},on:function(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)},off:function(e,t){this._eventListeners[e]&&(this._eventListeners[e]=this._eventListeners[e].filter(function(e){return e!==t}))},getInstanceId:function(){return this._instanceId}};var r={_instance:null,_instances:[],getInstance:function(){return this._instance||(this._instance=new t,this._instances.push(this._instance)),this._instance},createInstance:function(){var e=new t;return this._instances.push(e),e},destroyInstance:function(e){e&&(e.destroy(),this._instances=this._instances.filter(function(t){return t.getInstanceId()!==e.getInstanceId()}),this._instance===e&&(this._instance=null))},destroyAllInstances:function(){this._instances.forEach(function(e){e.destroy()}),this._instances=[],this._instance=null},getAllInstances:function(){return[...this._instances]},init:function(){return this.getInstance().init.apply(this.getInstance(),arguments)},extractAudio:function(){return this.getInstance().extractAudio.apply(this.getInstance(),arguments)},extractAudioWithSpeedRemap:function(){return this.getInstance().extractAudioWithSpeedRemap.apply(this.getInstance(),arguments)},convertVideoFormat:function(){return this.getInstance().convertVideoFormat.apply(this.getInstance(),arguments)},convertFramesToMp4:function(){return this.getInstance().convertFramesToMp4.apply(this.getInstance(),arguments)},extractFrames:function(){return this.getInstance().extractFrames.apply(this.getInstance(),arguments)},runCommand:function(){return this.getInstance().runCommand.apply(this.getInstance(),arguments)},getVersion:function(){return this.getInstance().getVersion.apply(this.getInstance(),arguments)},reset:function(){return this.getInstance().reset.apply(this.getInstance(),arguments)},destroy:function(){return this.getInstance().destroy.apply(this.getInstance(),arguments)},on:function(){return this.getInstance().on.apply(this.getInstance(),arguments)},off:function(){return this.getInstance().off.apply(this.getInstance(),arguments)},buildAudioTempoFilter:function(){return this.getInstance().buildAudioTempoFilter.apply(this.getInstance(),arguments)}};e.MeeWoo.Services.FFmpegService=r}(window);