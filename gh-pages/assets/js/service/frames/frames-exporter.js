!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Service=e.MeeWoo.Service||{};class t{constructor(){this.zip=null,this.currentFrame=0,this.totalFrames=0,this.callbacks={progress:null,error:null,complete:null}}async initJSZip(){if("undefined"==typeof JSZip)throw new Error("JSZip library not loaded");this.zip=new JSZip}async exportFrames(e,t,r,s,a,c){try{this.callbacks.progress=s,this.callbacks.error=a,this.callbacks.complete=c,await this.initJSZip(),this.totalFrames=Math.ceil(r*e.fps),this.currentFrame=0;const i=this.zip.folder("frames");await this.captureFrames(i,t,e),await this.generateZip()}catch(e){console.error("导出序列帧失败:",e),this.callbacks.error&&this.callbacks.error(e.message)}}async captureFrames(e,t,r){return new Promise((s,a)=>{const c=async()=>{if(this.currentFrame>=this.totalFrames)s();else try{const s=this.currentFrame/this.totalFrames;this.callbacks.progress&&this.callbacks.progress(s,`正在捕获第 ${this.currentFrame+1} 帧`);const a=document.createElement("canvas");a.width=r.width,a.height=r.height;a.getContext("2d").drawImage(t,0,0,r.width,r.height);const i=await this.canvasToPNG(a,r.quality),o=`frame_${String(this.currentFrame).padStart(4,"0")}.png`;e.file(o,i,{binary:!0}),this.currentFrame++,requestAnimationFrame(c)}catch(e){a(e)}};c()})}async canvasToPNG(e,t){return new Promise(t=>{e.toBlob(e=>{t(e)},"image/png")})}async generateZip(){return new Promise((e,t)=>{this.callbacks.progress&&this.callbacks.progress(.9,"正在生成ZIP文件"),this.zip.generateAsync({type:"blob"},e=>{const t=.9+e.percent/100*.1;this.callbacks.progress&&this.callbacks.progress(t,"正在生成ZIP文件")}).then(t=>{this.downloadZip(t),this.callbacks.progress&&this.callbacks.progress(1,"导出完成"),this.callbacks.complete&&this.callbacks.complete(),e()}).catch(e=>{t(e)})})}downloadZip(e){const t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download=`frames_${Date.now()}.zip`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t)}cancel(){this.zip=null,this.currentFrame=0,this.totalFrames=0}}e.MeeWoo.Service.FramesExporter=t,e.FramesExporter=t}(window);