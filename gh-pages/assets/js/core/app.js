function initApp(){var e=window.MeeWoo||{},t=(e.Utils,e.Core),i=e.Controllers,a=e.Services,s=e.Mixins,n=e.Exporters;Vue.config.errorHandler=function(e,t,i){console.error("[Vue Error] "+e.toString(),i),console.error(e)};new Vue({el:"#app",components:{"material-panel":e.Components.MaterialPanel,"gif-panel":e.Components.GifPanel,"frames-panel":e.Components.FramesPanel,"webp-panel":e.Components.WebpPanel,"standard-mp4-panel":e.Components.StandardMp4Panel,"dual-channel-panel":e.Components.DualChannelPanel,"to-svga-panel":e.Components.ToSvgaPanel,"chromakey-panel":e.Components.ChromaKeyPanel},mixins:[s.MaterialEditor,s.PanelMixin],data:function(){return{isLoading:!1,currentModule:"svga",currentLoadTaskId:0,dropHover:!1,footerTransitioning:!1,footerContentVisible:!1,viewerScale:1,viewerOffsetX:0,viewerOffsetY:0,viewMode:"fit-height",isImmersiveMode:!1,modeNameFadeOut:!1,modeNameFadeTimer:null,dragging:!1,isDarkMode:!1,isThemeManuallySet:!1,helpContent:"",loadingLibraryInfo:null,bgColorKey:"pattern",isPlaying:!1,progress:0,currentFrame:0,totalFrames:0,currentTime:0,totalDuration:0,svga:{hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:"",memoryText:""}},yyeva:{hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},alphaPosition:"right",originalWidth:0,originalHeight:0,displayWidth:0,displayHeight:0},lottie:{hasFile:!1,file:null,frameRate:30,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0,animationData:null},taskManager:null,mp4:{hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},mp4HasAudio:!1,materialList:[],replacedImages:{},compressedScaleInfo:{},showCompressModal:!1,isCompressingMaterials:!1,compressProgress:0,compressConfig:{scalePercent:70,pngQuality:80,exportMuted:!1},hasCompressedMaterials:!1,preCompressMaterials:null,preCompressReplacedImages:null,preCompressScaleInfo:null,svgaAudioData:null,svgaMovieData:null,gifConfig:{width:0,height:0,fps:30,quality:10,transparent:!1,dither:!1,ditherColor:"#ffffff"},isExportingGIF:!1,gifExportProgress:0,gifExportStage:"",gifExportMessage:"",gifExportCancelled:!1,framesConfig:{width:0,height:0,fps:24,quality:80,transparent:!1},isExportingFrames:!1,framesExportProgress:0,framesExportStage:"",framesExportMessage:"",framesExportCancelled:!1,webpConfig:{width:0,height:0,fps:24},webpSourceInfo:{name:"",sizeWH:"",duration:0,fileSize:"",fps:24,typeLabel:""},isExportingWebp:!1,webpExportProgress:0,webpExportMessage:"",webpExportCancelled:!1,isExportingLottie:!1,lottieExportProgress:0,showStandardMp4Panel:!1,isConvertingStandardMp4:!1,standardMp4Progress:0,standardMp4Message:"",standardMp4Config:{width:0,height:0,quality:80,fps:30,muted:!1},standardMp4SourceInfo:{sizeWH:"",duration:"",typeLabel:"文件"},showMoreDrawer:!1,showChromaKeyPanel:!1,chromaKeyEnabled:!1,chromaKeySimilarity:40,chromaKeySmoothness:10,chromaKeyConfig:{enabled:!1,similarity:40,smoothness:20,applied:!1},showSpeedRemapEditor:!1,selectedKeyframeIndex:-1,timelineHoverX:-1,showEditFrameDialog:!1,editingKeyframeIndex:-1,editFrameInput:"",showVideoConvertModal:!1,isConverting:!1,videoConvertProgress:0,speedRemapConfig:{enabled:!1,keyframes:[],originalTotalFrames:0,originalDuration:0,fps:30},dualChannelStage:"",toastVisible:!1,toastMessage:"",toastTimer:null,isMuted:!1,volume:1,isDraggingVolume:!1,yyevaHasAudio:!1,frames:{hasFile:!1,files:[],fileInfo:{name:"",size:0,sizeText:"",fps:25,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},framesStartTime:0,framesPausedAt:0,showFramesFpsDialog:!1,framesFpsInput:25,framesWasPlayingBeforeDialog:void 0,isLoggedIn:!1,userInfo:null}},methods:{getOngoingTasks:function(){return this.taskManager.getRunningTasks()},cancelOngoingTasks:function(e){var t=this.taskManager.cancelAll();return!e&&t.length>0&&this.utils.showToast("已取消："+t.join("、")),t},confirmIfHasOngoingTasks:function(e,t){var i=this.getOngoingTasks();if(0===i.length)return!0;var a=i.map(function(e){return e.name}).join("、"),s="";return"load"===t?s="您的"+a+"还在进行中，立即播放将退出"+a+"。\n\n确定继续吗？":"clear"===t?s="您的"+a+"还在进行中，清空画布将退出"+a+"。\n\n确定继续吗？":"task"===t&&(s="您的"+a+"还在进行中，立即"+e+"可能造成卡顿。\n\n确定继续吗？"),confirm(s)},loadUserConfig:function(){if(this.configManager){this._migrateOldData();var e=this.configManager.get("bgColorKey");e&&(this.bgColorKey=e);var t=this.configManager.get("lastMode");t&&-1!==["svga","lottie","mp4","frames","yyeva"].indexOf(t)&&(this.currentModule=t);var i=this.configManager.get("gifConfig");i&&(i.fps&&(this.gifConfig.fps=i.fps),i.quality&&(this.gifConfig.quality=i.quality),void 0!==i.transparent&&(this.gifConfig.transparent=i.transparent),void 0!==i.dither&&(this.gifConfig.dither=i.dither),i.width&&(this.gifConfig.width=i.width),i.height&&(this.gifConfig.height=i.height))}},_migrateOldData:function(){if(this.configManager)try{var e=localStorage.getItem("theme");e&&(this.configManager.set("theme",e),localStorage.removeItem("theme"));var t=localStorage.getItem("svga_preview_bg");t&&(this.configManager.set("bgColorKey",t),localStorage.removeItem("svga_preview_bg"))}catch(e){console.error("迁移旧数据失败:",e)}},saveUserConfig:function(e,t){this.configManager&&this.configManager.set(e,t)},handleLogin:function(){this.isLoggedIn?console.log("用户已登录:",this.userInfo):window.authUtils&&window.authUtils.redirectToLogin(window.location.href)},handleLogout:function(){window.authUtils&&(window.authUtils.clearAuth(),this.updateLoginStatus(),window.location.reload())},updateLoginStatus:function(){if(window.authUtils){var e=window.authUtils.isLoggedIn();console.log("登录状态更新:",e),this.isLoggedIn=e,this.userInfo=window.authUtils.getUserInfo()}},handleLoginCallback:function(){if(window.authUtils){var e=window.authUtils.handleLoginCallback();return e&&this.updateLoginStatus(),e}return!1},switchMode:function(e,t){t=t||{};var i=this.currentModule;if(i!==e||!t.skipCleanup){if(this.cancelOngoingTasks(!0),!t.skipCleanup&&i){var a=this.modeStrategies[i];a&&"function"==typeof a.cleanup?a.cleanup.call(this):console.warn("[switchMode] 未找到模式的清理策略:",i),this.resourceManager&&this.resourceManager.releaseGroup(i)}this.closeRightPanel(),this.currentModule=e,this.viewportController&&(this.viewportController.setScale(1,!0),this.viewportController.setOffset(0,0,!0))}},loadLibrary:function(e,i){return t.libraryLoader.load(e,i)},preloadLibraries:function(){t.libraryLoader.preload()},triggerFileUpload:function(){this.$refs.fileInput.click()},handleReuploadSVGA:function(e){var t=e.target.files;if(t&&0!==t.length){var i=t[0];i.name.toLowerCase().endsWith(".svga")?this.handleFile(i):alert("请选择有效的 SVGA 文件"),e.target.value=""}},onFileSelect:function(e){var t=e.target.files;t&&t.length&&(this.handleFiles(t),e.target.value="")},handleFiles:function(e,t){if(!t){if(!this.confirmIfHasOngoingTasks("播放新文件","load"))return;this.cancelOngoingTasks(!0)}var i=Array.prototype.slice.call(e),a=i.filter(function(e){var t=e.name.toLowerCase();return t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg")});a.length>1&&this.isSequenceFrames(a)?this.loadFrameSequence(a):i.length>=1&&this.handleFile(i[0],!0)},isSequenceFrames:function(e){return this.fileValidator.isSequenceFrames(e)},validateFile:function(e,t){return this.fileValidator.validateFile(e,t)},handleFile:function(e,t){var i=this,a=(e.name||"").toLowerCase(),s=null;if(!t){if(!this.confirmIfHasOngoingTasks("播放新文件","load"))return;this.cancelOngoingTasks(!0)}if(a.endsWith(".svga"))s="svga";else{if(!a.endsWith(".json")&&!a.endsWith(".lottie")){if(a.endsWith(".mp4")){var n=++this.currentLoadTaskId;return void this.detectMp4Type(e,function(t,a){if(n===i.currentLoadTaskId){var s=t?"yyeva":"mp4";i.validateFile(e,s).then(function(e){n===i.currentLoadTaskId&&("yyeva"===s?(e.alphaPosition=a||"right",e.detectionTaskId=n,i.loadYyeva(e)):i.loadMp4File(e))}).catch(function(e){n===i.currentLoadTaskId&&alert(e)})}else console.warn("MP4检测任务已取消 (TaskId mismatch)",n)})}return void alert("不支持的文件类型，只支持 .svga / .json / .lottie / .mp4")}s="lottie"}this.validateFile(e,s).then(function(e){"svga"===s?i.loadSvgaFile(e):"lottie"===s&&i.loadLottieFile(e)}).catch(function(e){alert(e)})},detectMp4Type:function(e,t){this.fileValidator.detectMp4Type(e,t)},triggerChangePreviewFile:function(){this.$refs.changePreviewFileInput&&this.$refs.changePreviewFileInput.click()},handleChangePreviewFile:function(e){var t=e.target.files[0];t&&(this.handleFile(t),e.target.value="")},clearAll:function(){var e=this;this.confirmIfHasOngoingTasks("清空画布","clear")&&(this.cancelOngoingTasks(!0),this.resourceManager?window.MeeWoo.Controllers&&window.MeeWoo.Controllers.GlobalAudioManager&&window.MeeWoo.Controllers.GlobalAudioManager.unloadAll():"undefined"!=typeof Howler&&Howler.unload(),this.isImmersiveMode&&(this.isImmersiveMode=!1,this.viewportController&&(this.viewportController.setHeaderHeight(36),this.viewportController.setFooterHeight(154))),this.footerContentVisible=!1,this.footerTransitioning=!0,setTimeout(function(){e.switchMode("svga"),e.lottie={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:""}},e.bgColorKey="pattern",setTimeout(function(){e.footerTransitioning=!1,e.$nextTick(function(){})},300)},200))},restorePlayback:function(){if(this.confirmIfHasOngoingTasks("恢复播放","restore")){this.cancelOngoingTasks(!0),this.isImmersiveMode&&(this.isImmersiveMode=!1,this.viewportController&&(this.viewportController.setHeaderHeight(36),this.viewportController.setFooterHeight(154)));var e=this.currentModule,t=null,i=this.originalVideoItem,a=null;"svga"===e&&this.svga.hasFile?t=this.svga.file:"yyeva"===e&&this.yyeva.hasFile?(t=this.yyeva.file,a=this.yyeva.alphaPosition):"mp4"===e&&this.mp4.hasFile?t=this.mp4.file:"lottie"===e&&this.lottie.hasFile?t=this.lottie.file:"frames"===e&&this.frames.hasFile&&(t=this.frames.file),t?(this.bgColorKey="pattern",this.replacedImages={},this.clearAllMaterialEditStates&&this.clearAllMaterialEditStates(),this.editor&&(this.editor.show=!1,this.editor.targetIndex=-1,window.MeeWoo.Core.MaterialState.resetEditorState(this.editor)),this.showCompressModal=!1,this.isCompressingMaterials=!1,this.compressProgress=0,this.hasCompressedMaterials=!1,this.preCompressMaterials=null,this.preCompressReplacedImages=null,this.chromaKeyEnabled=!1,this.chromaKeyApplied=!1,this.chromaKeySimilarity=40,this.chromaKeySmoothness=20,this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null),this.showSpeedRemapEditor=!1,this.speedRemapConfig={enabled:!1,keyframes:[],originalTotalFrames:0,originalDuration:0,fps:30},this.selectedKeyframeIndex=-1,this.timelineHoverX=-1,this.isPlaying&&this.togglePlay(),this.currentFrame=0,this.currentTime=0,this.progress=0,"svga"===e?this.loadSvgaFile({file:t,videoItem:i}):"yyeva"===e?this.loadYyeva({file:t,alphaPosition:a}):"mp4"===e?this.loadMp4File({file:t}):"lottie"===e?this.loadLottie({file:t}):"frames"===e&&this.loadFrames({file:t}),this.utils.showToast("已恢复到初始状态")):this.utils.showToast("没有文件可以恢复")}},loadHelpContent:function(){var e=this;this.loadLibrary("marked",!1).then(function(){return fetch("./help.md")}).then(function(e){return e.text()}).then(function(t){e.helpContent=marked.parse(t)}).catch(function(t){e.helpContent="<p>无法加载帮助文档</p>"})},initSvgaPlayer:function(){var e=this,t=this.$refs.svgaContainer;t&&(this.svgaPlayer=new SVGA.Player(t),this.svgaParser=new SVGA.Parser,this.svgaPlayer.onFrame(function(t){"svga"===e.currentModule&&e.totalFrames>0&&(e.currentFrame=t,e.progress=Math.round(t/e.totalFrames*100),e.currentTime=t/(e.svgaFps||30),e.playerController&&e.playerController.syncAudio&&e.isPlaying&&e.playerController.syncAudio(t))}))},initEmptyStateSvgaPlayer:function(e){void 0===e&&(e=0);var t=this,i=this.$refs.emptyStateSvgaContainer;if(i)this.emptyStateSvgaPlayer=new SVGA.Player(i),this.emptyStateSvgaParser=new SVGA.Parser,fetch("assets/svga/file-list.json").then(function(e){if(!e.ok)throw new Error("无法加载文件列表");return e.json()}).then(function(e){if(e&&0!==e.length){var i="assets/svga/"+e[Math.floor(Math.random()*e.length)];t.emptyStateSvgaParser.load(i,function(e){t.emptyStateSvgaPlayer.setVideoItem(e),t.emptyStateSvgaPlayer.startAnimation()},function(e){alert("加载空状态SVGA失败")})}}).catch(function(e){alert("读取SVGA文件列表失败")});else{if(e>50)return;setTimeout(function(){t.initEmptyStateSvgaPlayer(e+1)},100)}},loadSvgaFile:function(e){var t=this,i=e.file,a=e.videoItem,s=++this.currentLoadTaskId;this.isLoading=!0,this.switchMode("svga"),this.svga.hasFile=!0,window.MeeWoo&&window.MeeWoo.Controllers&&window.MeeWoo.Controllers.UserTypeController&&setTimeout(()=>{window.MeeWoo.Controllers.UserTypeController.refresh()},0),this.svga.file=Object.freeze(i),this.svga.fileInfo.name=i.name,this.svga.fileInfo.size=i.size,this.svga.fileInfo.sizeText=this.utils.formatBytes(i.size),this.originalVideoItem=a,this.extractMaterialList(a);try{if(a.videoSize){var n=a.videoSize.width||0,o=a.videoSize.height||0;t.svga.fileInfo.sizeWH=n+" × "+o,t.svga.originalWidth=n,t.svga.originalHeight=o}t.svga.fileInfo.fps=a.FPS||a.fps||null;var r=a.frames||a.framesCount||a.framesLength||0;t.totalFrames=r,t.svgaFps=t.svga.fileInfo.fps||30,t.totalDuration=r/t.svgaFps,t.svga.fileInfo.duration=t.totalDuration.toFixed(2)+"s",t.currentTime=0}catch(e){}this.footerTransitioning=!0,this.footerContentVisible=!1;var l=i.arrayBuffer().then(function(e){return s!==t.currentLoadTaskId?Promise.reject("task_cancelled"):t.parseSvgaAudioData(e)}),h=new Promise(function(e){setTimeout(e,50)});Promise.all([l,h]).then(function(e){if(s===t.currentLoadTaskId){t.isLoading=!1,t.footerTransitioning=!1,t.footerContentVisible=!0,t.svgaPlayer||t.initSvgaPlayer(),i&&(t.svgaObjectUrl=t.resourceManager.createObjectURL(i,"svga"));var n=null,o=e[0];n=o&&o.audios&&o.audios.length>0?o.audios:t.svgaMovieData&&t.svgaMovieData.audios&&t.svgaMovieData.audios.length>0?t.svgaMovieData.audios:a.audios,t.svgaAudios=n?JSON.parse(JSON.stringify(n)):[],a.audios&&(a.audios=[]),t.svgaPlayer.setVideoItem(a),t.svgaPlayer.onFrame(function(e){"svga"===t.currentModule&&t.totalFrames>0&&(t.currentFrame=e,t.progress=Math.round(e/t.totalFrames*100),t.currentTime=e/(t.svgaFps||30),t.playerController&&t.playerController.syncAudio&&t.playerController.syncAudio(e))}),t.svgaPlayer&&(t.svgaPlayer.startAnimation(),t.isPlaying=!0),t.playerController||t.initPlayerController(),t.currentFrame=0,t.progress=0,t.applyCanvasBackground(),a.videoSize&&t.viewportController&&t.viewportController.resetView()}}).catch(function(e){"task_cancelled"!==e&&(console.error("SVGA Load Error:",e),s===t.currentLoadTaskId&&(t.isLoading=!1,t.footerTransitioning=!1,t.footerContentVisible=!0,t.svgaPlayer||t.initSvgaPlayer(),t.svgaPlayer.setVideoItem(a),t.svgaPlayer&&(t.svgaPlayer.startAnimation(),t.isPlaying=!0),t.playerController||t.initPlayerController()))})},loadLottieFile:function(e){var t=this,i=e.file,a=e.animationData,s=++this.currentLoadTaskId;this.switchMode("lottie");var n=a.w||a.width||0,o=a.h||a.height||0,r=a.fr||30,l=a.ip||0,h=(a.op||0)-l,g=h/r;this.lottie.hasFile=!0,this.lottie.file=Object.freeze(i),this._lottieAnimationData=a,this.lottie.animationData=null,this.lottie.originalWidth=n,this.lottie.originalHeight=o,this.lottie.frameRate=r,this.lottie.fileInfo.name=i.name,this.lottie.fileInfo.size=i.size,this.lottie.fileInfo.sizeText=this.utils.formatBytes(i.size),this.lottie.fileInfo.fps=r+" FPS",this.lottie.fileInfo.sizeWH=n+"x"+o,this.lottie.fileInfo.width=n,this.lottie.fileInfo.height=o,this.lottie.fileInfo.duration=g.toFixed(2)+"s",this.totalFrames=h,this.currentFrame=0,this.progress=0,this.isPlaying=!1,this.totalDuration=g,this.currentTime=0,this.footerTransitioning=!0,this.footerContentVisible=!1,this.loadLibrary("lottie",!0).then(function(){s===t.currentLoadTaskId&&t.initLottiePlayer()}).catch(function(e){console.error("Lottie Load Error:",e),alert("Lottie库加载失败，请刷新页面重试"),t.switchMode("svga")})},loadYyeva:function(e){var t,i=this,a=e.file,s=e.alphaPosition||"right";if(e.detectionTaskId){if((t=e.detectionTaskId)!==this.currentLoadTaskId)return void console.warn("YYEVA加载任务已过期 (TaskId mismatch)",t,"当前:",this.currentLoadTaskId)}else t=++this.currentLoadTaskId;this.switchMode("yyeva"),this.yyeva.hasFile=!0,this.yyeva.file=Object.freeze(a),this.yyeva.fileInfo.name=a.name,this.yyeva.fileInfo.size=a.size,this.yyeva.fileInfo.sizeText=this.utils.formatBytes(a.size),this.footerTransitioning=!0,this.footerContentVisible=!1;var n=this.resourceManager.createObjectURL(a,"yyeva");this.yyevaObjectUrl=n;var o=document.createElement("video");o.src=n,o.crossOrigin="anonymous",o.preload="auto",o.loop=!0,o.muted=!0,o.onloadedmetadata=function(){if(t!==i.currentLoadTaskId)return console.warn("YYEVA加载任务已取消 (TaskId mismatch)",t),o.onerror=null,o.pause(),o.src="",void(i.resourceManager&&i.resourceManager.revokeObjectURL(n,"yyeva"));var a=o.videoWidth,r=o.videoHeight,l=o.duration,h=e.detectedFps||i.yyeva.detectedFps||30;e.detectedFps&&(i.yyeva.detectedFps=e.detectedFps);var g=Math.round(l*h);i.yyeva.displayWidth=Math.floor(a/2),i.yyeva.displayHeight=r,i.yyeva.fileInfo.sizeWH=i.yyeva.displayWidth+" × "+i.yyeva.displayHeight,i.yyeva.fileInfo.width=i.yyeva.displayWidth,i.yyeva.fileInfo.height=i.yyeva.displayHeight,i.yyeva.fileInfo.fps=(e.detectedFps||i.yyeva.detectedFps?e.detectedFps||i.yyeva.detectedFps:"30 (Default)")+" FPS",i.yyeva.fileInfo.duration=l.toFixed(2)+"s",i.totalFrames=g,i.totalDuration=l,i.currentFrame=0,i.currentTime=0,i.progress=0,i.isPlaying=!1,i.yyevaVideo=o,i.yyevaAlphaPosition="left",i.yyeva.alphaPosition=s,i.yyevaHasAudio=i.detectVideoHasAudio(o),setTimeout(function(){t===i.currentLoadTaskId&&(i.footerTransitioning=!1,i.footerContentVisible=!0,i.initYyevaCanvas(),i.viewportController&&i.viewportController.resetView(),o.onseeked=function(){o.onseeked=null,t===i.currentLoadTaskId&&(s||i.detectAlphaPosition(o),i.renderYyevaFrame(),setTimeout(function(){t===i.currentLoadTaskId&&o.play().then(function(){t===i.currentLoadTaskId?(i.isPlaying=!0,i.startYyevaRenderLoop(),i.isMuted||(o.muted=!1),setTimeout(function(){if(t===i.currentLoadTaskId){var e=i.detectVideoHasAudio(o);e!==i.yyevaHasAudio&&(i.yyevaHasAudio=e)}},500)):o.pause()}).catch(function(e){alert("播放失败")})},100))},o.currentTime=.1)},400)},o.onerror=function(){t===i.currentLoadTaskId&&(i.resourceManager&&i.resourceManager.revokeObjectURL(n,"mp4"),alert("视频加载失败"))}},loadMp4File:function(e){var t=this,i=e.file,a=++this.currentLoadTaskId;this.switchMode("mp4"),this.showSpeedRemapEditor=!1,this.speedRemapConfig={enabled:!1,keyframes:[],originalTotalFrames:0,originalDuration:0,fps:30},this.selectedKeyframeIndex=-1,this.mp4.hasFile=!0,this.mp4.file=Object.freeze(i),this.mp4.fileInfo.name=i.name,this.mp4.fileInfo.size=i.size,this.mp4.fileInfo.sizeText=this.utils.formatBytes(i.size),this.mp4ObjectUrl=this.resourceManager.createObjectURL(i,"mp4");var s=document.createElement("video");s.src=this.mp4ObjectUrl,s.crossOrigin="anonymous",s.preload="auto",s.muted=this.isMuted,s.loop=!0,s.playsInline=!0,s.disableRemotePlayback=!0,s.controls=!1,s.autoplay=!1,s.style.cssText="display: block; width: 100%; height: 100%; object-fit: contain;",this.mp4Video=s,s.onloadedmetadata=function(){if(a!==t.currentLoadTaskId)return console.warn("MP4加载任务已取消 (TaskId mismatch)",a),s.onerror=null,s.pause(),void(s.src="");var i=s.videoWidth,n=s.videoHeight,o=s.duration,r=e.detectedFps||t.mp4.detectedFps||30;e.detectedFps&&(t.mp4.detectedFps=e.detectedFps);var l=Math.round(o*r);t.mp4.originalWidth=i,t.mp4.originalHeight=n,t.mp4.fileInfo.sizeWH=i+"x"+n,t.mp4.fileInfo.fps=(e.detectedFps||t.mp4.detectedFps?e.detectedFps||t.mp4.detectedFps:"30 (Default)")+" FPS",t.mp4.fileInfo.duration=o.toFixed(2)+"s",t.totalFrames=l,t.totalDuration=o,t.currentFrame=0,t.currentTime=0,t.progress=0,t.isPlaying=!1,t.mp4HasAudio=t.detectVideoHasAudio(s);var h=t.$refs.svgaContainer;h&&(h.innerHTML="",h.appendChild(s)),t.viewportController&&t.viewportController.resetView(),t.footerTransitioning=!0,t.footerContentVisible=!1,setTimeout(function(){a===t.currentLoadTaskId&&(t.footerTransitioning=!1,t.footerContentVisible=!0,setTimeout(function(){a===t.currentLoadTaskId&&s.play().then(function(){a===t.currentLoadTaskId?(t.isPlaying=!0,t.startMp4ProgressLoop(),setTimeout(function(){if(a===t.currentLoadTaskId){var e=t.detectVideoHasAudio(s);e!==t.mp4HasAudio&&(t.mp4HasAudio=e)}},500)):s.pause()}).catch(function(e){alert("播放失败")})},100))},400)},s.onerror=function(){a===t.currentLoadTaskId&&(URL.revokeObjectURL(t.mp4ObjectUrl),alert("视频加载失败"))}},parseSizeWH:function(e){var t=0,i=0;if(e){var a=e.split("x");(2===a.length||2===(a=e.split(" × ")).length)&&(t=parseInt(a[0]),i=parseInt(a[1]))}return{width:t,height:i}},openStandardMp4Panel:function(e){var t="svga"===e?this.svga.fileInfo:"lottie"===e?this.lottie.fileInfo:this.yyeva.fileInfo;if(t){var i=0,s=0;if("svga"===e)i=this.svga.originalWidth,s=this.svga.originalHeight;else if("lottie"===e){var n=this.parseSizeWH(t.sizeWH);i=n.width,s=n.height}else"yyeva"===e&&(i=this.yyeva.displayWidth,s=this.yyeva.displayHeight);if(!i||!s){var o=this.parseSizeWH(t.sizeWH);i=o.width,s=o.height}var r=30;t.fps&&(r=parseInt(t.fps)||30),this.standardMp4SourceInfo={sizeWH:t.sizeWH||i+" × "+s,duration:t.duration||"",typeLabel:"svga"===e?"SVGA":"yyeva"===e?"MP4":"Lottie"},this.standardMp4Config={width:i,height:s,quality:80,fps:r,muted:!1,aspectRatio:i/s},this.openRightPanel("showStandardMp4Panel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}},closeStandardMp4Panel:function(){this.showStandardMp4Panel=!1},cancelStandardMp4Conversion:function(){this.isConvertingStandardMp4=!1},startStandardMp4Conversion:async function(e){if(!this.isConvertingStandardMp4){var t=this;if(this.confirmIfHasOngoingTasks("转换为普通MP4","task")){this.isConvertingStandardMp4=!0,this.standardMp4Progress=0,this.standardMp4Message="准备中...";var i=e||this.standardMp4Config;if(!i.width||!i.height)return alert("请输入有效的尺寸"),void(this.isConvertingStandardMp4=!1);try{await a.FFmpegService.init()}catch(e){return alert("FFmpeg加载失败："+e.message),void(this.isConvertingStandardMp4=!1)}try{var s=null;this.taskManager&&(s=this.taskManager.register("转换为普通MP4",function(){t.isConvertingStandardMp4=!1,t.standardMp4Progress=0}));var n="svga"===this.currentModule?this.svga.fileInfo:"lottie"===this.currentModule?this.lottie.fileInfo:this.yyeva.fileInfo,o=this.isPlaying;await this.pauseForExport();var r=[],l=i.fps,h=this.totalDuration||0;h<=0&&(h=1);for(var g=Math.ceil(h*l),d=parseFloat(n.fps)||30,f=function(){if(!t.isConvertingStandardMp4)throw new Error("User Cancelled")},u=0;u<g;u++){f();var c=u/l,m=Math.round(c*d);await this.seekToFrame(m,d,n),"yyeva"===t.currentModule?(await new Promise(function(e){var i=0,a=function(){t.yyevaVideo.readyState>=2||++i>25?e():setTimeout(a,20)};a()}),await new Promise(function(e){setTimeout(e,30)})):await new Promise(function(e){setTimeout(e,50)});var p=null;if("yyeva"===t.currentModule){if(t.renderYyevaFrame(),!(p=t.yyevaCanvas)){console.error("YYEVA Canvas not found");continue}p.width!==i.width||(p.height,i.height)}else p=this.getCurrentFrameCanvas();if(p){var v=document.createElement("canvas");v.width=i.width,v.height=i.height;var y=v.getContext("2d"),C=t.currentBgColor;C&&"transparent"!==C&&"rgba(0,0,0,0)"!==C&&"pattern"!==t.bgColorKey||(C="#000000"),y.fillStyle=C,y.fillRect(0,0,i.width,i.height),y.drawImage(p,0,0,i.width,i.height);for(var M=v.toDataURL("image/jpeg",i.quality),w=atob(M.split(",")[1]),F=w.length,S=new Uint8Array(F);F--;)S[F]=w.charCodeAt(F);r.push(S)}}var P=null;if(!i.muted&&"yyeva"===this.currentModule&&this.yyeva.file)try{P=new Uint8Array(await this.yyeva.file.arrayBuffer())}catch(e){console.warn("读取音频数据失败:",e)}else if(!i.muted&&"svga"===this.currentModule&&this.svgaAudioData){var I=Object.keys(this.svgaAudioData);I.length>0&&(P=this.svgaAudioData[I[0]])}this.standardMp4Message="FFmpeg转换中...";var T=await a.FFmpegService.convertFramesToMp4({frames:r,fps:l,quality:i.quality,audioData:P,muted:i.muted,onProgress:function(e){t.standardMp4Progress=30+Math.round(70*e),t.standardMp4Message=e<.3?"写入文件...":e<.9?"编码中...":"生成文件中..."},checkCancelled:function(){return!t.isConvertingStandardMp4}}),b=(("svga"===this.currentModule?this.svga.fileInfo.name:"lottie"===this.currentModule?this.lottie.fileInfo.name:this.yyeva.fileInfo.name)||"output").replace(/\.[^/.]+$/,"")+".mp4";this.utils.downloadFile(T,b),alert("转换成功！"),this.closeStandardMp4Panel()}catch(e){"User Cancelled"===e.message||("FFmpeg服务正忙，请稍后再试"===e.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error(e),alert("转换失败: "+e.message)))}finally{this.taskManager&&s&&this.taskManager.finish(s),this.isConvertingStandardMp4=!1,o&&this.resumeAfterExport()}}}},initPlayerController:function(){var e=this;this.playerController&&(this.playerController.destroy(),this.playerController=null),this.$nextTick(function(){var t=e.$refs.progressBar,a=e.$refs.progressThumb,s=e.$refs.volumeSliderTrack,n=e.$refs.volumeSliderHandle;t&&a&&(e.playerController=new i.PlayerController({progressBar:t,progressThumb:a,volumeBar:s,volumeThumb:n,onProgressChange:function(t,i){e.progress=t,e.currentFrame=i,e.totalDuration>0&&(e.currentTime=t/100*e.totalDuration)},onVolumeChange:function(t){e.volume=t},onPlayStateChange:function(t){e.isPlaying=t},getPlayerState:function(){return{mode:e.currentModule,isPlaying:e.isPlaying,progress:e.progress,totalFrames:e.totalFrames,totalDuration:e.totalDuration,currentTime:e.currentTime,isMuted:e.isMuted,hasFile:e.svga.hasFile||e.yyeva.hasFile||e.mp4.hasFile||e.lottie.hasFile||e.frames.hasFile,svgaPlayer:e.svgaPlayer,lottiePlayer:e.lottiePlayer,yyevaVideo:e.yyevaVideo,yyevaAnimationId:e.yyevaAnimationId,mp4Video:e.mp4Video,speedRemapConfig:e.speedRemapConfig,svgaAudios:e.svgaAudios,svgaAudioData:e.svgaAudioData,videoItem:e.originalVideoItem,startYyevaRenderLoop:function(){e.startYyevaRenderLoop()},startMp4ProgressLoop:function(){e.startMp4ProgressLoop()},stopFramesPlayLoop:function(){e.stopFramesPlayLoop()},startFramesPlayLoop:function(){e.startFramesPlayLoop()},renderYyevaFrame:function(){e.renderYyevaFrame()},seekFramesTo:function(t){e.seekFramesTo(t)}}}}))})},initViewportController:function(){var e=this;this.viewportController&&(this.viewportController.destroy(),this.viewportController=null),this.viewportController=new i.ViewportController({getContentSize:function(){return e.getContentOriginalSize()},onViewportChange:function(t,i,a,s){e.viewerScale=t,e.viewerOffsetX=i,e.viewerOffsetY=a,void 0!==s&&(e.dragging=s),e.viewMode=e.viewportController.getViewMode()},footerHeight:154,screenHeightRatio:.75,minScale:.1,maxScale:5,zoomStep:.1})},togglePlay:function(){this.playerController&&this.playerController.togglePlay()},toggleMute:function(){this.hasAudio&&(this.isMuted=!this.isMuted,this.playerController&&this.playerController.setMuted(this.isMuted))},startVolumeDrag:function(e){e.preventDefault(),this.isDraggingVolume=!0,this.updateVolume(e),document.addEventListener("mousemove",this.updateVolume),document.addEventListener("mouseup",this.stopVolumeDrag),document.addEventListener("touchmove",this.updateVolume),document.addEventListener("touchend",this.stopVolumeDrag)},updateVolume:function(e){if(this.isDraggingVolume){e.preventDefault();var t=e.currentTarget;if(t){var i=t.getBoundingClientRect(),a=e.clientY||e.touches&&e.touches[0]&&e.touches[0].clientY;if(a){var s=a-i.top,n=1-Math.max(0,Math.min(1,s/i.height));this.volume=n,this.playerController&&this.playerController.setVolume(n)}}}},stopVolumeDrag:function(){this.isDraggingVolume=!1,document.removeEventListener("mousemove",this.updateVolume),document.removeEventListener("mouseup",this.stopVolumeDrag),document.removeEventListener("touchmove",this.updateVolume),document.removeEventListener("touchend",this.stopVolumeDrag)},detectVideoHasAudio:function(e){if(void 0!==e.audioTracks&&null!==e.audioTracks)return e.audioTracks.length>0;if(void 0!==e.mozHasAudio)return e.mozHasAudio;if(void 0!==e.webkitAudioDecodedByteCount){if(e.webkitAudioDecodedByteCount>0)return!0;if(e.currentTime>.2)return!1}return!0},initLottiePlayer:function(){var e=this,t=this.$refs.svgaContainer;t&&(t.innerHTML="",this.lottiePlayer=lottie.loadAnimation({container:t,renderer:"canvas",loop:!0,autoplay:!1,animationData:this._lottieAnimationData}),this.lottiePlayer.addEventListener("enterFrame",function(t){e.currentFrame=Math.floor(t.currentTime);var i=e.lottie.frameRate||30;e.currentTime=t.currentTime/i,e.totalDuration>0?e.progress=Math.round(e.currentTime/e.totalDuration*100):e.progress=Math.round(t.currentTime/e.totalFrames*100)}),this.lottiePlayer.addEventListener("loopComplete",function(){e.currentFrame=0,e.progress=0}),setTimeout(function(){e.footerTransitioning=!1,e.footerContentVisible=!0,e.$nextTick(function(){e.applyCanvasBackground(),e.viewportController&&e.viewportController.resetView(),setTimeout(function(){e.playerController&&!e.isPlaying&&e.playerController.togglePlay()},100)})},400))},cleanupLottie:function(){this.lottiePlayer&&(this.lottiePlayer.destroy(),this.lottiePlayer=null),this.lottieCanvas=null,this.lottieCtx=null,this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.lottie={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0,animationData:null},this._lottieAnimationData=null,this.isPlaying=!1,this.progress=0,this.currentFrame=0,this.totalFrames=0},loadFrameSequence:function(e){var t=this,i=this.utils.sortFilesByName(e),a=i[0],s=new FileReader;s.onload=function(e){var s=new Image;s.onload=function(){t.switchMode("frames");var e=i.reduce(function(e,t){return e+t.size},0);t.frames={hasFile:!0,files:i,fileInfo:{name:a.name+" 等 "+i.length+" 帧",size:e,sizeText:t.utils.formatBytes(e),fps:25,sizeWH:s.width+" x "+s.height,duration:(i.length/25).toFixed(2)+"s"},originalWidth:s.width,originalHeight:s.height},t.totalFrames=i.length,t.currentFrame=0,t.progress=0,t.isPlaying=!1,t.framesFpsInput=25,t.showFramesFpsDialog=!0,t.preloadFrameImages()},s.src=e.target.result},s.readAsDataURL(a)},loadFrames:function(e){var t=this,i=e.file;if(!Array.isArray(i)){if(!(this.frames.files&&this.frames.files.length>0))return void console.error("没有可以加载的序列帧文件");i=this.frames.files}var a=this.utils.sortFilesByName(i),s=a[0],n=new FileReader;n.onload=function(e){var i=new Image;i.onload=function(){var e=a.reduce(function(e,t){return e+t.size},0);t.frames={hasFile:!0,files:a,fileInfo:{name:s.name+" 等 "+a.length+" 帧",size:e,sizeText:t.utils.formatBytes(e),fps:25,sizeWH:i.width+" x "+i.height,duration:(a.length/25).toFixed(2)+"s"},originalWidth:i.width,originalHeight:i.height},t.totalFrames=a.length,t.currentFrame=0,t.progress=0,t.isPlaying=!1,t.preloadFrameImages(),t.footerTransitioning=!0,t.footerContentVisible=!1,setTimeout(function(){t.footerTransitioning=!1,t.footerContentVisible=!0,t.$nextTick(function(){t.viewportController&&t.viewportController.resetView()})},300)},i.src=e.target.result},n.readAsDataURL(s)},preloadFrameImages:async function(){var e=this,t=this.frames.files;this.framesImages=new Array(t.length).fill(null);for(var i=[],a=0;a<t.length;a++)i.push({index:a,file:t[a]});for(var s=async function(){if(0!==i.length){var t=i.shift();try{var a=e.resourceManager.createObjectURL(t.file,"frames"),n=await new Promise(function(e,t){var i=new Image;i.onload=function(){e(i)},i.onerror=t,i.src=a});e.framesImages[t.index]=n}catch(e){console.error("Failed to load frame "+t.index,e)}await s()}},n=[],o=0;o<Math.min(5,t.length);o++)n.push(s());await Promise.all(n),this.framesImages=this.framesImages.filter(function(e){return null!==e}),this.initFramesPlayer()},initFramesPlayer:function(){var e=this.$refs.svgaContainer;if(e){e.innerHTML="";var t=document.createElement("canvas");t.width=this.frames.originalWidth,t.height=this.frames.originalHeight,t.style.width=this.frames.originalWidth+"px",t.style.height=this.frames.originalHeight+"px",e.appendChild(t),this.framesCanvas=t,this.framesCtx=t.getContext("2d",{alpha:!0}),this.applyCanvasBackground(),this.renderFramesFrame(0)}},renderFramesFrame:function(e){if(this.framesCtx&&this.framesImages.length){var t=this.framesImages[e];if(t){var i=this.framesCtx;i.clearRect(0,0,this.framesCanvas.width,this.framesCanvas.height),i.drawImage(t,0,0),this.currentFrame=e;var a=this.frames.fileInfo.fps||25;this.currentTime=e/a,this.totalDuration>0?this.progress=this.currentTime/this.totalDuration*100||0:this.progress=e/(this.totalFrames-1)*100||0}}},startFramesPlayLoop:function(){var e=this,t=1e3/(this.frames.fileInfo.fps||25);this.framesStartTime=performance.now()-this.currentFrame*t;var i=function(a){if(e.isPlaying&&"frames"===e.currentModule){var s=a-e.framesStartTime,n=Math.floor(s/t)%e.totalFrames;e.renderFramesFrame(n),e.framesAnimationId=requestAnimationFrame(i)}};this.framesAnimationId=requestAnimationFrame(i)},stopFramesPlayLoop:function(){this.framesAnimationId&&(cancelAnimationFrame(this.framesAnimationId),this.framesAnimationId=null)},seekFramesTo:function(e){if(e<0&&(e=0),e>=this.totalFrames&&(e=this.totalFrames-1),this.renderFramesFrame(e),this.isPlaying){var t=1e3/(this.frames.fileInfo.fps||25);this.framesStartTime=performance.now()-e*t}},confirmFramesFps:function(){var e=this,t=parseInt(this.framesFpsInput)||25;t<1&&(t=1),t>120&&(t=120),this.frames.fileInfo.fps=t,this.frames.fileInfo.duration=(this.totalFrames/t).toFixed(2)+"s",this.showFramesFpsDialog=!1,this.totalDuration=this.totalFrames/t,this.currentTime=0,void 0===this.framesWasPlayingBeforeDialog?(this.footerTransitioning=!0,this.footerContentVisible=!1,setTimeout(function(){e.footerTransitioning=!1,e.footerContentVisible=!0,e.$nextTick(function(){e.viewportController&&e.viewportController.resetView(),setTimeout(function(){e.isPlaying=!0,e.startFramesPlayLoop()},50)})},400)):(this.framesWasPlayingBeforeDialog&&(this.isPlaying=!0,this.startFramesPlayLoop()),this.framesWasPlayingBeforeDialog=void 0)},openChangeFpsDialog:function(){this.framesFpsInput=this.frames.fileInfo.fps||25,this.showFramesFpsDialog=!0,this.framesWasPlayingBeforeDialog=this.isPlaying,this.isPlaying&&(this.isPlaying=!1,this.stopFramesPlayLoop())},cleanupFrames:function(){this.stopFramesPlayLoop(),this.framesBlobUrls&&(this.framesBlobUrls=[]),this.framesCanvas=null,this.framesCtx=null,this.framesImages=[],this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.frames={hasFile:!1,files:[],fileInfo:{name:"",size:0,sizeText:"",fps:25,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},this.isPlaying=!1,this.progress=0,this.currentFrame=0,this.totalFrames=0},detectAlphaPosition:function(e){var t=document.createElement("canvas"),i=t.getContext("2d",{willReadFrequently:!0}),a=Math.floor(e.videoWidth/2),s=e.videoHeight;t.width=e.videoWidth,t.height=s,i.drawImage(e,0,0);var n=i.getImageData(a/4,s/4,10,10),o=i.getImageData(a+a/4,s/4,10,10),r=this.calculateColorVariance(n.data),l=this.calculateColorVariance(o.data);this.yyeva.alphaPosition=r<l?"left":"right"},calculateColorVariance:function(e){for(var t=0,i=0;i<e.length;i+=4){var a=e[i],s=e[i+1],n=e[i+2];t+=Math.abs(a-s)+Math.abs(s-n)+Math.abs(a-n)}return t},initYyevaCanvas:function(){var e=this.$refs.svgaContainer;if(e){e.innerHTML="";var t=document.createElement("canvas");t.width=this.yyeva.displayWidth,t.height=this.yyeva.displayHeight,t.style.width=this.yyeva.displayWidth+"px",t.style.height=this.yyeva.displayHeight+"px",e.appendChild(t),this.yyevaCanvas=t,this.yyevaCtx=t.getContext("2d",{willReadFrequently:!0}),this.yyevaTempCanvas=document.createElement("canvas"),this.yyevaTempCtx=this.yyevaTempCanvas.getContext("2d",{willReadFrequently:!0})}},startYyevaRenderLoop:function(){var e=this,t=0;!function i(a){e.yyevaVideo&&e.yyevaCanvas&&e.yyevaCtx&&(a||(a=performance.now()),e.renderYyevaFrame(),a-t>30&&(e.updateYyevaProgress(),t=a),e.yyevaAnimationId=requestAnimationFrame(i))}()},renderYyevaFrame:function(){var e=this.yyevaVideo,t=this.yyevaCanvas,i=this.yyevaCtx;if(e&&t&&i&&!(e.readyState<2)){var a=Math.floor(e.videoWidth/2),s=e.videoHeight,n="left"!==this.yyeva.alphaPosition,o=n?0:a,r=n?a:0,l=this.yyevaTempCanvas,h=this.yyevaTempCtx;l.width===e.videoWidth&&l.height===s||(l.width=e.videoWidth,l.height=s),h.clearRect(0,0,l.width,l.height),h.drawImage(e,0,0);for(var g=h.getImageData(o,0,a,s),d=h.getImageData(r,0,a,s),f=0;f<g.data.length;f+=4){var u=d.data[f];u>0&&(g.data[f]=Math.min(255,255*g.data[f]/u),g.data[f+1]=Math.min(255,255*g.data[f+1]/u),g.data[f+2]=Math.min(255,255*g.data[f+2]/u)),g.data[f+3]=u}i.clearRect(0,0,t.width,t.height),i.putImageData(g,0,0)}},updateYyevaProgress:function(){if(this.yyevaVideo){var e=this.yyevaVideo,t=e.currentTime,i=e.duration||1,a=this.yyeva.detectedFps||30;this.currentTime=t,this.totalDuration=i,this.progress=t/i*100,this.currentFrame=Math.round(t*a)}},cleanupSvga:function(){if(this.svgaPlayer){try{this.svgaPlayer.stopAnimation(),this.svgaPlayer.clear()}catch(e){console.warn("Stop SVGA animation failed:",e)}this.svgaPlayer=null}if(this.svgaAudioPlayer){try{this.svgaAudioPlayer.stop(),this.svgaAudioPlayer.unload()}catch(e){}this.svgaAudioPlayer=null}this.svgaObjectUrl&&(this.resourceManager&&this.resourceManager.revokeObjectURL(this.svgaObjectUrl,"svga"),this.svgaObjectUrl=null),this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.svga={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:""}},this.svgaAudioData=null,this.svgaMovieData=null,this.isPlaying=!1,this.progress=0,this.currentFrame=0,this.totalFrames=0},cleanupYyeva:function(){this.yyevaAnimationId&&(cancelAnimationFrame(this.yyevaAnimationId),this.yyevaAnimationId=null),this.yyevaVideo&&(this.yyevaVideo.onerror=null,this.yyevaVideo.onloadedmetadata=null,this.yyevaVideo.pause(),this.yyevaVideo.removeAttribute("src"),this.yyevaVideo.load(),this.yyevaVideo=null),this.yyevaObjectUrl&&(this.resourceManager&&this.resourceManager.revokeObjectURL(this.yyevaObjectUrl,"yyeva"),this.yyevaObjectUrl=null),this.yyevaCanvas=null,this.yyevaCtx=null,this.yyevaTempCanvas=null,this.yyevaTempCtx=null,this.playerController&&(this.playerController.destroy(),this.playerController=null);var e=this.$refs.svgaContainer;e&&(e.innerHTML=""),this.yyeva={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},alphaPosition:"right",originalWidth:0,originalHeight:0,displayWidth:0,displayHeight:0},this.yyevaHasAudio=!1},startMp4ProgressLoop:function(){var e=this,t=this.mp4Video;if(t){var i=1,a=-1,s=-1,n=0,o=!1,r=0;requestAnimationFrame(function l(h){if(e.mp4Video&&"mp4"===e.currentModule){if(h||(h=performance.now()),s!==t.currentTime||t.paused||t.ended)n=0;else if(++n>=120&&!o)return o=!0,t.pause(),e.isPlaying=!1,e.showVideoConvertModal=!0,e.videoConvertProgress=0,void(e.isConverting=!1);if(s=t.currentTime,t.duration>0){var g=e.mp4.detectedFps||30,d=Math.floor(t.currentTime*g);if(e.speedRemapConfig.enabled&&e.speedRemapConfig.keyframes.length>=2){for(var f=e.speedRemapConfig.keyframes,u=e.speedRemapConfig.originalTotalFrames||1,c=0,m=-1,p=Math.max(0,a),v=f.length,y=p;y<v-1;y++){var C=f[y],M=f[y+1];if(d>=C.originalFrame&&d<=M.originalFrame){if(m=y,(P=M.originalFrame-C.originalFrame)>0){var w=(d-C.originalFrame)/P;c=C.position+w*(M.position-C.position)}else c=C.position;break}}var F=f[f.length-1],S=t.duration*F.position;if(h-r>30&&(e.progress=c/F.position*100,e.currentTime=c*t.duration,e.totalDuration=S,r=h),m!==a&&-1!==m){a=m;C=f[m];var P=(M=f[m+1]).originalFrame-C.originalFrame,I=M.position-C.position;I>0&&P>0&&(i=P/(I*u),i=Math.max(.1,Math.min(12,i)),t.playbackRate=i)}}else h-r>30&&(e.currentTime=t.currentTime,e.totalDuration=t.duration,e.progress=t.currentTime/t.duration*100,r=h),1!==t.playbackRate&&(t.playbackRate=1);e.currentFrame=d}e.isPlaying&&requestAnimationFrame(l)}})}},cleanupMp4:function(){if(this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null),this.mp4Video&&(this.mp4Video.onerror=null,this.mp4Video.onloadedmetadata=null,this.mp4Video.pause(),this.mp4Video.removeAttribute("src"),this.mp4Video.load(),this.mp4Video=null),this.mp4ObjectUrl){if(this.resourceManager){var e=this.mp4ObjectUrl,t=this.resourceManager;setTimeout(function(){t.revokeObjectURL(e,"mp4")},100)}this.mp4ObjectUrl=null}this.playerController&&(this.playerController.destroy(),this.playerController=null);var i=this.$refs.svgaContainer;i&&(i.innerHTML=""),this.mp4={hasFile:!1,file:null,fileInfo:{name:"",size:0,sizeText:"",fps:null,sizeWH:"",duration:""},originalWidth:0,originalHeight:0},this.mp4HasAudio=!1,this.chromaKeyEnabled=!1,this.chromaKeyApplied=!1},confirmConvertVideo:async function(){var e=this;if(this.isConverting)confirm("当前正在转换视频格式，是否退出转换？")&&(this.isConverting=!1,this.showVideoConvertModal=!1);else{this.isConverting=!0,this.videoConvertProgress=0;try{if(await a.FFmpegService.init({onProgress:function(t){e.videoConvertProgress=Math.round(10*t.progress)}}),!this.isConverting)throw new Error("用户取消");var t=this.mp4.file;if(!t)throw new Error("视频文件不存在");var i=await a.FFmpegService.convertVideoFormat({inputFile:t,maxWidth:1280,onProgress:function(t){e.videoConvertProgress=10+Math.round(85*t)},checkCancelled:function(){return!e.isConverting}});this.videoConvertProgress=95;var s=new File([i],t.name.replace(/\.mp4$/,"_converted.mp4"),{type:"video/mp4"});this.cleanupMp4(),this.currentModule="mp4",this.mp4.hasFile=!0,this.mp4.file=Object.freeze(s),this.mp4.fileInfo.name=s.name,this.mp4.fileInfo.size=s.size,this.mp4.fileInfo.sizeText=this.utils.formatBytes(s.size),this.mp4ObjectUrl=this.resourceManager.createObjectURL(i,"mp4");var n=document.createElement("video");n.src=this.mp4ObjectUrl,n.loop=!0,n.playsInline=!0,n.style.cssText="display: block;",this.mp4Video=n,n.onloadedmetadata=function(){var t=n.videoWidth,i=n.videoHeight;e.mp4.originalWidth=t,e.mp4.originalHeight=i,e.mp4.fileInfo.sizeWH=t+"x"+i;var a=n.duration;e.mp4.fileInfo.duration=a.toFixed(2)+"s",e.mp4.fileInfo.fps="30 FPS",e.totalFrames=Math.round(30*a),e.mp4HasAudio=e.detectVideoHasAudio(n);var s=e.$refs.svgaContainer;s&&(s.innerHTML="",s.appendChild(n)),e.viewportController&&e.viewportController.resetView(),e.footerTransitioning=!0,e.footerContentVisible=!1,setTimeout(function(){e.footerTransitioning=!1,e.footerContentVisible=!0,setTimeout(function(){n.play().then(function(){e.isPlaying=!0,e.startMp4ProgressLoop()}).catch(function(e){alert("普通MP4播放失败")})},50)},400)},this.videoConvertProgress=100,setTimeout(function(){e.showVideoConvertModal=!1,e.isConverting=!1},500)}catch(e){"用户取消"!==e.message&&alert("视频转换失败："+e.message),this.showVideoConvertModal=!1,this.isConverting=!1}}},cancelConvertVideo:function(){this.isConverting?confirm("当前正在转换视频格式，是否退出转换？")&&(this.isConverting=!1,this.showVideoConvertModal=!1):this.showVideoConvertModal=!1},initTheme:function(){var e=sessionStorage.getItem("theme");if(null!==e)this.isDarkMode="dark"===e,this.isThemeManuallySet=!0;else{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;this.isDarkMode=t,this.isThemeManuallySet=!1}this.isDarkMode?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")},setupThemeListener:function(){var e=this,t=window.matchMedia("(prefers-color-scheme: dark)"),i=function(t){e.isThemeManuallySet||(e.isDarkMode=t.matches,e.isDarkMode?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode"))};t.addEventListener?t.addEventListener("change",i):t.addListener(i),this._themeMediaQuery=t,this._themeChangeHandler=i},toggleTheme:function(){this.isDarkMode=!this.isDarkMode,this.isDarkMode?(document.body.classList.add("dark-mode"),sessionStorage.setItem("theme","dark")):(document.body.classList.remove("dark-mode"),sessionStorage.setItem("theme","light")),this.isThemeManuallySet=!0},onWheel:function(e){this.viewportController&&this.viewportController.handleWheel(e)},onMouseDown:function(e){this.viewportController&&this.viewportController.handleMouseDown(e)},onMouseMove:function(e){this.viewportController&&this.viewportController.handleMouseMove(e)},onMouseUp:function(e){this.viewportController&&this.viewportController.handleMouseUp(e)},getContentOriginalSize:function(){if("svga"===this.currentModule&&this.svga.hasFile){var e=this.svga.fileInfo.sizeWH;if(e){var t=e.split(" × ");if(2===t.length)return{width:parseInt(t[0]),height:parseInt(t[1])}}}else{if("lottie"===this.currentModule&&this.lottie.hasFile)return{width:this.lottie.originalWidth,height:this.lottie.originalHeight};if("yyeva"===this.currentModule&&this.yyeva.hasFile)return{width:this.yyeva.displayWidth,height:this.yyeva.displayHeight};if("mp4"===this.currentModule&&this.mp4.hasFile)return{width:this.mp4.originalWidth,height:this.mp4.originalHeight};if("frames"===this.currentModule&&this.frames.hasFile)return{width:this.frames.originalWidth,height:this.frames.originalHeight}}return null},centerViewer:function(){this.viewportController&&this.viewportController.centerView()},zoomIn:function(){this.viewportController&&this.viewportController.zoomIn()},zoomOut:function(){this.viewportController&&this.viewportController.zoomOut()},resetScale:function(){this.viewportController&&this.viewportController.toggleViewMode()},toggleImmersiveMode:function(){var e=this;if(this.isImmersiveMode=!this.isImmersiveMode,this.modeNameFadeTimer&&(clearTimeout(this.modeNameFadeTimer),this.modeNameFadeTimer=null),this.isImmersiveMode?(this.modeNameFadeOut=!1,this.modeNameFadeTimer=setTimeout(function(){e.modeNameFadeOut=!0},5e3)):this.modeNameFadeOut=!1,this.viewportController){var t=this.isImmersiveMode?0:36,i=this.isImmersiveMode?80:154;this.viewportController.setHeaderHeight(t),this.viewportController.setFooterHeight(i),this.viewportController.centerView()}this.$nextTick(function(){e.initPlayerController()})},applyCanvasBackground:function(){var e=this.$refs.svgaContainer;if(e){var t=e.querySelector("canvas");t&&("pattern"===this.bgColorKey?(t.style.backgroundColor="",t.style.backgroundImage="",t.style.backgroundRepeat="",t.style.backgroundSize=""):(t.style.backgroundColor=this.currentBgColor,t.style.backgroundImage="none"))}},openMaterialPanel:function(){this.svga.hasFile&&this.originalVideoItem&&this.openRightPanel("material")},parseSvgaAudioData:function(e){var t=this;return new Promise(function(i,a){t.loadLibrary(["protobuf","pako"],!0).then(function(){try{var a=new Uint8Array(e),s=pako.inflate(a);protobuf.load("./svga.proto",function(e,a){if(e)return console.error("Protobuf load failed:",e),void i(null);try{var n=a.lookupType("com.opensource.svga.MovieEntity");if(!n)return console.error("Proto文件中未找到MovieEntity定义"),void i(null);var o=n.decode(s);if(t.svgaMovieData=o,o.audios&&o.audios.length>0&&o.images){var r={};o.audios.forEach(function(e){var t=e.audioKey;[t,t+".mp3",t+".wav","audio_"+t,t.replace(/\.[^.]+$/,"")].forEach(function(e){o.images[e]&&(r[t]=o.images[e])})}),Object.keys(r).length>0&&(t.svgaAudioData=r)}i(o)}catch(e){console.error("SVGA Parser: Decode error",e),i(null)}})}catch(e){console.error("Data processing error:",e),i(null)}}).catch(function(e){console.error("Failed to load libraries for audio parsing:",e),i(null)})})},extractMaterialList:function(e){var t=this;if(this.materialList=[],this.replacedImages={},e&&e.images){this.svga.fileInfo.memoryText="计算中...";var i=Object.keys(e.images),a=i.length,s=0,n=0,o=new Set;e.audios&&e.audios.length>0&&e.audios.forEach(function(e){if(e.audioKey){o.add(e.audioKey),o.add(e.audioKey+".mp3"),o.add(e.audioKey+".wav"),o.add("audio_"+e.audioKey);var t=e.audioKey.replace(/\.[^.]+$/,"");t!==e.audioKey&&o.add(t)}}),i.forEach(function(i){if(o.has(i))s++;else{var r=e.images[i];if(r&&r.constructor===Uint8Array&&r.length>=3&&73===r[0]&&68===r[1]&&51===r[2])s++;else{if(r&&"string"==typeof r){var l=r.startsWith("data:")?r.split(",")[1]:r;try{var h=atob(l.substring(0,8));if(h.length>=3&&73===h.charCodeAt(0)&&68===h.charCodeAt(1)&&51===h.charCodeAt(2))return void s++}catch(e){}}var g="";r&&"string"==typeof r&&(g=r.startsWith("data:")?r:"data:image/png;base64,"+r);var d=new Image,f={imageKey:i,previewUrl:g,sizeText:"计算中...",fileSizeText:"计算中...",isReplaced:!1,originalData:r,fileSize:0};t.materialList.push(f),(d=new Image).onload=function(){var e=this.width*this.height*4;f.fileSize=e,f.fileSizeText=t.utils.formatBytes(e),f.sizeText=this.width+" × "+this.height,f.originalWidth=this.width,f.originalHeight=this.height,n+=e,++s===a&&(t.svga.fileInfo.memoryText=t.utils.formatBytes(n))},d.onerror=function(){f.sizeText="-",f.fileSizeText="-",++s===a&&(t.svga.fileInfo.memoryText=n>0?t.utils.formatBytes(n):"-")},g&&(d.src=g)}}}),s===a&&(this.svga.fileInfo.memoryText=n>0?this.utils.formatBytes(n):"-")}},scaleImageToFill:function(e,t,i){var a=document.createElement("canvas");a.width=t,a.height=i;var s=a.getContext("2d",{willReadFrequently:!0}),n=e.width,o=e.height,r=t/n,l=i/o,h=Math.max(r,l),g=n*h,d=o*h,f=(t-g)/2,u=(i-d)/2;return s.clearRect(0,0,t,i),s.drawImage(e,f,u,g,d),a},getOriginalImageSize:function(e){if(!this.originalVideoItem||!this.originalVideoItem.images)return null;if(!this.originalVideoItem.images[e])return null;var t=this.materialList.find(function(t){return t.imageKey===e});return t&&t.originalWidth&&t.originalHeight?{width:t.originalWidth,height:t.originalHeight}:null},replaceMaterial:function(e){var t=this,i=this.materialList[e];if(i){var a=document.createElement("input");a.type="file",a.accept="image/png,image/jpeg,image/jpg",a.onchange=function(e){var a=e.target.files[0];if(a){var s=new FileReader;s.onload=function(e){var a=e.target.result,s=new Image;s.onload=function(){var e;i.originalWidth&&i.originalHeight?e=t.scaleImageToFill(s,i.originalWidth,i.originalHeight).toDataURL("image/png"):e=a;i.previewUrl=e,i.isReplaced=!0;var n=Object.assign({},t.replacedImages);n[i.imageKey]=e,t.replacedImages=n;var o=i.originalWidth||s.width,r=i.originalHeight||s.height,l=o*r*4;i.fileSize=l,i.fileSizeText=t.utils.formatBytes(l),i.sizeText=o+"px*"+r+"px",setTimeout(function(){t.applyReplacedMaterials()},300)},s.onerror=function(){alert("图片加载失败，请确保图片格式正确")},s.src=a},s.readAsDataURL(a)}},a.click()}},restoreMaterial:function(e){window.MeeWoo.Core.MaterialOperations.restoreOriginalMaterial(this,e)},downloadMaterial:function(e){var t=this.materialList[e];if(t){var i=this.replacedImages[t.imageKey]||t.previewUrl;if(i){var a=(t.imageKey||"material_"+e)+".png";this.utils.downloadFromDataURL(i,a)}else alert("图片数据不存在")}},applyReplacedMaterials:function(){if(this.svgaPlayer&&this.originalVideoItem){var e=this;this.svgaPlayer.clearDynamicObjects();var t=Object.keys(this.replacedImages),i={},a=0,s=t.length;0!==s?t.forEach(function(t){var n=e.replacedImages[t],o=new Image;o.onload=function(){i[t]=o,++a===s&&(Object.keys(i).forEach(function(t){e.svgaPlayer.setImage(i[t],t)}),e.isPlaying?e.svgaPlayer.startAnimation():e.svgaPlayer.stepToFrame(e.currentFrame))},o.onerror=function(){++a===s&&(Object.keys(i).forEach(function(t){e.svgaPlayer.setImage(i[t],t)}),e.isPlaying?e.svgaPlayer.startAnimation():e.svgaPlayer.stepToFrame(e.currentFrame))},o.src=n}):e.isPlaying?e.svgaPlayer.startAnimation():e.svgaPlayer.stepToFrame(e.currentFrame)}},openCompressAndExportModal:function(){this.showCompressModal=!0},closeCompressModal:function(){this.showCompressModal=!1},startCompressAndExport:async function(){await this.startCompressMaterials(),this.hasCompressedMaterials&&await this.exportNewSVGA()},startCompressMaterials:async function(){if(0!==this.materialList.length){this.showCompressModal=!1,this.isCompressingMaterials=!0,this.compressProgress=0,this.preCompressMaterials=JSON.parse(JSON.stringify(this.materialList)),this.preCompressReplacedImages=Object.assign({},this.replacedImages),this.preCompressScaleInfo=Object.assign({},this.compressedScaleInfo);var e=this.materialList.length,t=0,i=this.compressConfig.scalePercent/100;try{window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService&&window.MeeWoo.Services.ImageCompressionService.resetCompressionFailed();for(var a=0;a<this.materialList.length;a++){var s=this.materialList[a],n=s.previewUrl;if(n){var o=await this._loadImage(n),r=Math.round(o.width*i),l=Math.round(o.height*i);r=Math.max(1,r),l=Math.max(1,l);var h,g,d=document.createElement("canvas");if(d.width=r,d.height=l,d.getContext("2d").drawImage(o,0,0,r,l),window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService)try{var f=await window.MeeWoo.Services.ImageCompressionService.compressCanvas(d,this.compressConfig.pngQuality),u=new Blob([f],{type:"image/png"});h=await new Promise(function(e,t){var i=new FileReader;i.onloadend=function(){e(i.result)},i.onerror=t,i.readAsDataURL(u)})}catch(e){console.error("PNG压缩失败，使用Canvas原生输出:",e),h=d.toDataURL("image/png")}else h=d.toDataURL("image/png");try{g=await this._loadImage(h)}catch(e){throw e}var c=this.scaleImageToFill(g,s.originalWidth,s.originalHeight).toDataURL("image/png");s.previewUrl=c,s.isReplaced=!0,s.sizeText=r+"px*"+l+"px";var m=r*l*4;s.fileSize=m,s.fileSizeText=this.utils.formatBytes(m)+" (压缩后)";var p=Object.assign({},this.replacedImages);p[s.imageKey]=c,this.replacedImages=p;var v=Object.assign({},this.compressedScaleInfo);v[s.imageKey]={scaledWidth:r,scaledHeight:l,originalWidth:s.originalWidth,originalHeight:s.originalHeight,compressedDataUrl:h},this.compressedScaleInfo=v,t++,this.compressProgress=Math.round(t/e*100)}else t++,this.compressProgress=Math.round(t/e*100)}this.hasCompressedMaterials=!0,this.isCompressingMaterials=!1,this._recalculateTotalMemory(),this.applyReplacedMaterials();var y=!1;window.MeeWoo&&window.MeeWoo.Services&&window.MeeWoo.Services.ImageCompressionService&&(y=window.MeeWoo.Services.ImageCompressionService.hasCompressionFailed()),y?this.utils.showToast("压缩完成，但部分图片使用了降级压缩方案"):this.utils.showToast("压缩完成，共压缩 "+e+" 个素材")}catch(e){console.error("压缩失败:",e),alert("压缩失败: "+e.message),this.isCompressingMaterials=!1}}else alert("没有可压缩的素材")},undoCompressMaterials:function(){this.preCompressMaterials&&this.preCompressReplacedImages?(this.materialList=JSON.parse(JSON.stringify(this.preCompressMaterials)),this.replacedImages=Object.assign({},this.preCompressReplacedImages),this.compressedScaleInfo=Object.assign({},this.preCompressScaleInfo||{}),this.preCompressMaterials=null,this.preCompressReplacedImages=null,this.preCompressScaleInfo=null,this.hasCompressedMaterials=!1,this.showCompressModal=!1,this._recalculateTotalMemory(),this.applyReplacedMaterials(),this.utils.showToast("已撤销压缩")):alert("没有可撤销的压缩记录")},_loadImage:function(e){return new Promise(function(t,i){var a=new Image;e.startsWith("blob:")&&(a.crossOrigin="Anonymous"),a.onload=function(){t(a)},a.onerror=function(t){console.error("图片加载失败，src:",e.substring(0,100)+"..."),i(new Error("图片加载失败"))},a.src=e})},_recalculateTotalMemory:function(){for(var e=0,t=0;t<this.materialList.length;t++)this.materialList[t].fileSize&&(e+=this.materialList[t].fileSize);this.svga.fileInfo.memoryText=this.utils.formatBytes(e)},exportNewSVGA:async function(){var e=this;if(this.svga.hasFile&&this.originalVideoItem&&this.svga.file)if(0!==Object.keys(this.replacedImages).length){try{await this.loadLibrary(["protobuf","pako"],!0)}catch(e){return void alert("库加载失败，请检查网络")}try{var t=new FileReader;t.onload=function(t){try{var i=t.target.result;new Uint8Array(i);a.SvgaBuilder.decode(i,{protobuf:protobuf,pako:pako}).then(function(t){try{if(e.compressConfig.exportMuted){var i=[];t.audios&&t.audios.length>0&&t.audios.forEach(function(e){if(e.audioKey){i.push(e.audioKey),i.push(e.audioKey+".mp3"),i.push(e.audioKey+".wav"),i.push("audio_"+e.audioKey);var t=e.audioKey.replace(/\.[^.]+$/,"");t!==e.audioKey&&i.push(t)}}),t.audios=[],t.images&&i.length>0&&i.forEach(function(e){t.images[e]&&delete t.images[e]})}var s=0,n=[];for(var o in e.replacedImages)e.replacedImages.hasOwnProperty(o)&&t.images&&t.images[o]&&n.push({imageKey:o,base64Data:e.replacedImages[o]});if(0===n.length)return void alert("未找到需要替换的图片");n.forEach(function(i){for(var a,n=e.compressedScaleInfo[i.imageKey],o=(a=n&&n.compressedDataUrl?n.compressedDataUrl:i.base64Data).split(",")[1]||a,r=atob(o),l=new Uint8Array(r.length),h=0;h<r.length;h++)l[h]=r.charCodeAt(h);t.images[i.imageKey]=l,s++}),Object.keys(e.compressedScaleInfo).length>0&&t.sprites&&t.sprites.forEach(function(t){var i=e.compressedScaleInfo[t.imageKey];if(i&&t.frames){var a=i.originalWidth/i.scaledWidth;t.frames.forEach(function(e){e.transform||(e.transform={a:1,b:0,c:0,d:1,tx:0,ty:0});var t=void 0!==e.transform.a?e.transform.a:1,i=void 0!==e.transform.b?e.transform.b:0,s=void 0!==e.transform.c?e.transform.c:0,n=void 0!==e.transform.d?e.transform.d:1,o=void 0!==e.transform.tx?e.transform.tx:0,r=void 0!==e.transform.ty?e.transform.ty:0;e.transform.a=t*a,e.transform.b=i*a,e.transform.c=s*a,e.transform.d=n*a,e.transform.tx=o,e.transform.ty=r})}}),a.SvgaBuilder.encode(t,{protobuf:protobuf,pako:pako}).then(function(t){var i=e.svga.fileInfo.name.replace(/\.svga$/i,"");e.utils.downloadFile(t,i+"_modified.svga"),e.utils.showToast("导出成功！已替换 "+s+" 个素材。")}).catch(function(e){console.error("编码失败:",e),alert("编码失败: "+e.message)})}catch(e){console.error("逻辑处理失败:",e),alert("逻辑处理失败: "+e.message)}}).catch(function(e){console.error("SVGA解码失败:",e),alert("SVGA解码失败: "+e.message)})}catch(e){alert("处理 SVGA 失败: "+e.message)}},t.readAsArrayBuffer(e.svga.file)}catch(e){alert("导出 SVGA 失败: "+e.message)}}else alert("请先替换至少一个素材");else alert("请先加载 SVGA 文件")},openGifPanel:function(){var e=!1;"svga"===this.currentModule?e=this.svga.hasFile:"yyeva"===this.currentModule?e=this.yyeva.hasFile:"mp4"===this.currentModule?e=this.mp4.hasFile:"lottie"===this.currentModule?e=this.lottie.hasFile:"frames"===this.currentModule&&(e=this.frames.hasFile),e?(this.openRightPanel("gif"),this.loadLibrary("gif",!0).catch(function(e){console.warn("Library preload failed:",e)})):alert("请先加载文件")},closeGifPanel:function(){this.activeRightPanel=null},handleGifConfigChange:function(e){this.gifConfig=Object.assign({},this.gifConfig,e)},handleFramesConfigChange:function(e){this.framesConfig=Object.assign({},this.framesConfig,e)},handleGifExport:function(e){this.gifConfig=Object.assign({},this.gifConfig,e),this.startGifExport()},cancelGifExport:function(){this.gifExportCancelled=!0,this.isExportingGIF=!1,this.gifExportProgress=0,this.gifExportStage="",this.gifExportMessage=""},openFramesPanel:function(){console.log("[调试] openFramesPanel被调用"),console.log("[调试] currentModule:",this.currentModule),console.log("[调试] svga.hasFile:",this.svga.hasFile);var e=!1;"svga"===this.currentModule?e=this.svga.hasFile:"yyeva"===this.currentModule?e=this.yyeva.hasFile:"mp4"===this.currentModule?e=this.mp4.hasFile:"lottie"===this.currentModule?e=this.lottie.hasFile:"frames"===this.currentModule&&(e=this.frames.hasFile),console.log("[调试] hasFile:",e),e?(console.log('[调试] 调用openRightPanel("frames")'),this.openRightPanel("frames"),this.loadLibrary("jszip",!0).catch(function(e){console.warn("Library preload failed:",e)})):alert("请先加载文件")},closeFramesPanel:function(){this.activeRightPanel=null},handleFramesExport:function(e){this.framesConfig=Object.assign({},this.framesConfig,e),this.startFramesExport()},cancelFramesExport:function(){this.framesExportCancelled=!0,this.isExportingFrames=!1,this.framesExportProgress=0,this.framesExportStage="",this.framesExportMessage=""},openWebpPanel:function(){var e=!1;if("svga"===this.currentModule?e=this.svga.hasFile:"yyeva"===this.currentModule?e=this.yyeva.hasFile:"mp4"===this.currentModule?e=this.mp4.hasFile:"lottie"===this.currentModule?e=this.lottie.hasFile:"frames"===this.currentModule&&(e=this.frames.hasFile),e)if("webp"!==this.activeRightPanel){var t=this;this.activeRightPanel=null,this.$nextTick(function(){t.openRightPanel("webp")})}else this.closeWebpPanel();else alert("请先加载文件")},closeWebpPanel:function(){this.activeRightPanel=null},handleWebpConfigChange:function(e){this.webpConfig=Object.assign({},this.webpConfig,e)},handleWebpExport:function(e){this.webpConfig=Object.assign({},this.webpConfig,e),this.startWebpExport()},startWebpExport:function(){var e=this;this.isExportingWebp=!0,this.webpExportProgress=0,this.webpExportMessage="准备导出...",this.webpExportCancelled=!1,this.runWebpExport().catch(function(t){console.error("WebP导出失败:",t),e.webpExportMessage="导出失败: "+(t.message||"未知错误"),e.isExportingWebp=!1})},captureFrames:async function(e,t,i){var a=this,s=this.getWebpSourceInfo().duration,n=Math.ceil(s*i),o=[],r=this.isPlaying;await this.pauseForExport();try{for(var l=0;l<n;l++){if(a.webpExportCancelled)throw new Error("导出已取消");var h=l/i;await a.seekToTime(h);var g=a.getCurrentFrameCanvas();if(!g)throw new Error("无法获取画布元素");var d=document.createElement("canvas");d.width=e,d.height=t,d.getContext("2d").drawImage(g,0,0,e,t);var f=new Image;f.src=d.toDataURL("image/png"),await new Promise(function(e){f.onload=e}),o.push(f),a.webpExportProgress=l/n*.3}return o}finally{r&&a.resumeAfterExport()}},runWebpExport:async function(){var e=this,t=this.webpConfig;try{e.webpExportMessage="捕获帧数据...";var i=await this.captureFrames(t.width,t.height,t.fps);if(e.webpExportCancelled)throw new Error("导出已取消");if(e.webpExportProgress=.3,e.webpExportMessage="转换为WebP格式...",i.length>0){var a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(i[0],0,0,t.width,t.height);var s=a.toDataURL("image/webp",.9);e.webpExportProgress=.8,e.webpExportMessage="生成下载文件...";var n=document.createElement("a");n.href=s,n.download="export.webp",document.body.appendChild(n),n.click(),document.body.removeChild(n),i.forEach(function(e){URL.revokeObjectURL(e.src)})}e.webpExportProgress=1,e.webpExportMessage="导出完成",setTimeout(function(){e.isExportingWebp=!1,e.activeRightPanel=null},1e3)}catch(t){throw console.error("WebP导出错误:",t),e.webpExportMessage="导出失败: "+(t.message||"未知错误"),e.isExportingWebp=!1,t}},cancelWebpExport:function(){this.webpExportCancelled=!0,this.isExportingWebp=!1,this.webpExportProgress=0,this.webpExportMessage=""},getWebpSourceInfo:function(){var e=0,t=0,i=24,a=0,s=0;if("svga"===this.currentModule&&this.svga.hasFile){var n=this.svga.fileInfo.sizeWH;if(n){var o=n.split(" × ");2===o.length&&(e=parseInt(o[0]),t=parseInt(o[1]))}i=this.svga.fileInfo.fps||20,a=(s=this.totalFrames||0)/i}else if("yyeva"===this.currentModule&&this.yyeva.hasFile)e=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),t=this.yyeva.displayHeight||this.yyeva.originalHeight,i=parseFloat(this.yyeva.fileInfo.fps)||30,a=this.yyevaVideo?this.yyevaVideo.duration:0,s=Math.ceil(a*i);else if("mp4"===this.currentModule&&this.mp4.hasFile)if(e=this.mp4.originalWidth,t=this.mp4.originalHeight,i=parseFloat(this.mp4.fileInfo.fps)||30,a=this.mp4Video?this.mp4Video.duration:0,this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var r=this.buildFrameMap();r&&r.length>0?a=(s=r.length)/i:s=Math.ceil(a*i)}else s=Math.ceil(a*i);else"lottie"===this.currentModule&&this.lottie.hasFile?(e=this.lottie.originalWidth,t=this.lottie.originalHeight,i=this.lottie.frameRate||30,a=(s=this.totalFrames||0)/i):"frames"===this.currentModule&&this.frames.hasFile&&(e=this.frames.originalWidth,t=this.frames.originalHeight,i=this.frames.fileInfo.fps||25,a=(s=this.totalFrames||0)/i);return{width:e,height:t,fps:i,duration:a,totalFrames:s,sizeWH:e+" × "+t}},getFramesSourceInfo:function(){var e=0,t=0,i=24,a=0,s=0;if("svga"===this.currentModule&&this.svga.hasFile){var n=this.svga.fileInfo.sizeWH;if(n){var o=n.split(" × ");2===o.length&&(e=parseInt(o[0]),t=parseInt(o[1]))}i=this.svga.fileInfo.fps||20,a=(s=this.totalFrames||0)/i}else if("yyeva"===this.currentModule&&this.yyeva.hasFile)e=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),t=this.yyeva.displayHeight||this.yyeva.originalHeight,i=parseFloat(this.yyeva.fileInfo.fps)||30,a=this.yyevaVideo?this.yyevaVideo.duration:0,s=Math.ceil(a*i);else if("mp4"===this.currentModule&&this.mp4.hasFile)if(e=this.mp4.originalWidth,t=this.mp4.originalHeight,i=parseFloat(this.mp4.fileInfo.fps)||30,a=this.mp4Video?this.mp4Video.duration:0,this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var r=this.buildFrameMap();r&&r.length>0?a=(s=r.length)/i:s=Math.ceil(a*i)}else s=Math.ceil(a*i);else"lottie"===this.currentModule&&this.lottie.hasFile?(e=this.lottie.originalWidth,t=this.lottie.originalHeight,i=this.lottie.frameRate||30,a=(s=this.totalFrames||0)/i):"frames"===this.currentModule&&this.frames.hasFile&&(e=this.frames.originalWidth,t=this.frames.originalHeight,i=this.frames.fileInfo.fps||25,a=(s=this.totalFrames||0)/i);return{width:e,height:t,fps:i,duration:a,totalFrames:s,sizeWH:e+" × "+t}},getGifSourceInfo:function(){var e=0,t=0,i=30,a=0,s=0;if("svga"===this.currentModule&&this.svga.hasFile){var n=this.svga.fileInfo.sizeWH;if(n){var o=n.split(" × ");2===o.length&&(e=parseInt(o[0]),t=parseInt(o[1]))}i=this.svga.fileInfo.fps||20,a=(s=this.totalFrames||0)/i}else if("yyeva"===this.currentModule&&this.yyeva.hasFile)e=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),t=this.yyeva.displayHeight||this.yyeva.originalHeight,i=parseFloat(this.yyeva.fileInfo.fps)||30,a=this.yyevaVideo?this.yyevaVideo.duration:0,s=Math.ceil(a*i);else if("mp4"===this.currentModule&&this.mp4.hasFile)if(e=this.mp4.originalWidth,t=this.mp4.originalHeight,i=parseFloat(this.mp4.fileInfo.fps)||30,a=this.mp4Video?this.mp4Video.duration:0,this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var r=this.buildFrameMap();r&&r.length>0?a=(s=r.length)/i:s=Math.ceil(a*i)}else s=Math.ceil(a*i);else"lottie"===this.currentModule&&this.lottie.hasFile?(e=this.lottie.originalWidth,t=this.lottie.originalHeight,i=this.lottie.frameRate||30,a=(s=this.totalFrames||0)/i):"frames"===this.currentModule&&this.frames.hasFile&&(e=this.frames.originalWidth,t=this.frames.originalHeight,i=this.frames.fileInfo.fps||25,a=(s=this.totalFrames||0)/i);return{width:e,height:t,fps:i,duration:a,totalFrames:s,sizeWH:e+" × "+t}},confirmExportLimits:function(e,t){var i=[],a=e.duration||0,s=e.fileSizeBytes||0;if(s>10485760&&i.push("文件大小超过10MB ("+this.utils.formatBytes(s)+")，处理和导出可能需要较长时间"),a>60&&i.push("动画时长超过60秒 ("+a.toFixed(1)+"秒)，处理和导出可能需要较长时间"),i.length>0){var n="注意 (导出"+t+")：\n\n"+i.join("\n")+"\n\n确定要继续吗？";return confirm(n)}return!0},startGifExport:async function(){var e=this;if(this.confirmIfHasOngoingTasks("导出GIF","task")){var t=this.getGifSourceInfo();if(this.confirmExportLimits(t,"GIF")){try{await this.loadLibrary("gif",!0)}catch(e){return void alert("GIF导出库加载失败，请检查网络")}this.isExportingGIF=!0,this.gifExportProgress=0,this.gifExportCancelled=!1,this.gifExportStage="capturing",this.gifExportMessage="捕获帧...";var i=null;this.taskManager&&(i=this.taskManager.register("导出GIF",function(){e.isExportingGIF=!1,e.gifExportProgress=0,e.gifExportCancelled=!0}));try{await this.runGifExport()}catch(e){"用户取消"!==e.message&&alert("GIF导出失败: "+e.message)}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isExportingGIF=!1,this.gifExportProgress=0,this.gifExportStage="",this.gifExportMessage=""}}}},startFramesExport:async function(){var e=this;if(this.confirmIfHasOngoingTasks("导出序列帧","task")){var t=this.getFramesSourceInfo();if(this.confirmExportLimits(t,"序列帧")){try{await this.loadLibrary("jszip",!0)}catch(e){return void alert("序列帧导出库加载失败，请检查网络")}this.isExportingFrames=!0,this.framesExportProgress=0,this.framesExportCancelled=!1,this.framesExportStage="capturing",this.framesExportMessage="捕获帧...";var i=null;this.taskManager&&(i=this.taskManager.register("导出序列帧",function(){e.isExportingFrames=!1,e.framesExportProgress=0,e.framesExportCancelled=!0}));try{await this.runFramesExport()}catch(e){"用户取消"!==e.message&&alert("序列帧导出失败: "+e.message)}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isExportingFrames=!1,this.framesExportProgress=0,this.framesExportStage="",this.framesExportMessage=""}}}},runFramesExport:async function(){var e=this,t=this.framesConfig,i=this.getFramesSourceInfo(),a=(t.fps,i.duration),s=this.isPlaying;await this.pauseForExport();try{var n=new MeeWoo.Service.FramesExporter,o=this.getCurrentFrameCanvas();if(!o)throw new Error("无法获取画布元素");await new Promise(function(i,s){n.exportFrames(t,o,a,function(t,i){e.framesExportProgress=t,e.framesExportMessage=i},function(e){s(new Error(e))},function(){i()})}),alert("序列帧导出成功！"),e.closeFramesPanel()}finally{s&&this.resumeAfterExport()}},runGifExport:async function(){var e=this,t=this.gifConfig,i=this.getGifSourceInfo(),a=t.fps,s=Math.ceil(i.duration*a),o=null;"mp4"===this.currentModule&&this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(o=this.buildFrameMap(a))&&o.length>0&&(s=o.length);var r=this.isPlaying;await this.pauseForExport();try{var l=await n.GifExporter.export({width:t.width,height:t.height,fps:a,quality:parseInt(t.quality)||10,repeat:0,totalFrames:s,transparent:t.transparent,dither:t.dither,ditherColor:t.ditherColor,backgroundColor:"pattern"===this.bgColorKey?"#ffffff":this.currentBgColor,getFrame:async function(t){var s=t,n=a;return o&&(void 0!==o[t]?(s=o[t],"mp4"===e.currentModule&&e.mp4&&e.mp4.fileInfo&&e.mp4.fileInfo.fps&&(n=parseFloat(e.mp4.fileInfo.fps)||30)):o.length>0&&(s=o[o.length-1],"mp4"===e.currentModule&&e.mp4&&e.mp4.fileInfo&&e.mp4.fileInfo.fps&&(n=parseFloat(e.mp4.fileInfo.fps)||30))),await e.seekToFrame(s,n,i),await new Promise(function(e){setTimeout(e,50)}),e.getCurrentFrameCanvas()},onProgress:function(t,i,a){e.gifExportProgress=t,e.gifExportStage=i,e.gifExportMessage=a},shouldCancel:function(){return e.gifExportCancelled}}),h=this.getGifFileName();n.GifExporter.download(l,h),alert("GIF 导出成功！大小: "+n.GifExporter.formatBytes(l.size))}finally{r&&this.resumeAfterExport()}},getCurrentFrameCanvas:function(){var e=this.$refs.svgaContainer;if(!e)return null;if("svga"===this.currentModule)return e.querySelector("canvas");if("yyeva"===this.currentModule)return this.yyevaCanvas;if("mp4"===this.currentModule){if(!this.mp4Video)return null;if(this.chromaKeyEnabled){var t=e.querySelector("canvas.chromakey-canvas");if(t)return t}var i=this.mp4.originalWidth,a=this.mp4.originalHeight;return this._cachedMp4Canvas&&this._cachedMp4Canvas.width===i&&this._cachedMp4Canvas.height===a||(this._cachedMp4Canvas=document.createElement("canvas"),this._cachedMp4Canvas.width=i,this._cachedMp4Canvas.height=a,this._cachedMp4Ctx=this._cachedMp4Canvas.getContext("2d",{willReadFrequently:!0})),this._cachedMp4Ctx.drawImage(this.mp4Video,0,0),this._cachedMp4Canvas}return"lottie"===this.currentModule?e.querySelector("canvas"):"frames"===this.currentModule?this.framesCanvas:null},seekToFrame:async function(e,t,i){var a=this;if("svga"===this.currentModule)this.svgaPlayer.stepToFrame(e,!1);else if("yyeva"===this.currentModule){var s=e/t;this.yyevaVideo.currentTime=s,await new Promise(function(e){a.yyevaVideo.onseeked=e}),this.renderYyevaFrame()}else if("mp4"===this.currentModule){s=e/t;this.mp4Video.currentTime=s,await new Promise(function(e){a.mp4Video.onseeked=e})}else"lottie"===this.currentModule?this.lottiePlayer.goToAndStop(e,!0):"frames"===this.currentModule&&this.renderFramesFrame(e)},pauseForExport:async function(){this.playerController&&this.isPlaying&&this.playerController.togglePlay(),this.isPlaying=!1},resumeAfterExport:function(){this.playerController&&!this.isPlaying&&this.playerController.togglePlay(),this.isPlaying=!0},getGifFileName:function(){var e="animation";return"svga"===this.currentModule&&this.svga.fileInfo.name?e=this.svga.fileInfo.name.replace(/\.svga$/i,""):"yyeva"===this.currentModule&&this.yyeva.fileInfo.name?e=this.yyeva.fileInfo.name.replace(/\.mp4$/i,""):"mp4"===this.currentModule&&this.mp4.fileInfo.name?e=this.mp4.fileInfo.name.replace(/\.mp4$/i,""):"lottie"===this.currentModule&&this.lottie.fileInfo.name?e=this.lottie.fileInfo.name.replace(/\.json$/i,""):"frames"===this.currentModule&&this.frames.files.length>0&&(e=this.frames.files[0].name.replace(/\d+\.(png|jpg|jpeg)$/i,"").replace(/[_-]$/,"")||"frames"),e+".gif"},exportLottie:async function(){var e=this;if(this.svgaPlayer&&this.svga.hasFile&&this.originalVideoItem){if(this.confirmIfHasOngoingTasks("导出Lottie","task")&&confirm("警告：这是实验性功能。\n\n生成的Lottie文件将每帧都作为静态关键帧导出，类似“定格动画”效果。\n原动画不会有平滑的运动曲线。\n\n生成的JSON文件可能很大（数MB），但能导入After Effects进行编辑。\n\n是否继续？")){this.isExportingLottie=!0,this.lottieExportProgress=0;var t=null;this.taskManager&&(t=this.taskManager.register("导出Lottie",function(){e.isExportingLottie=!1,e.lottieExportProgress=0}));try{var i=this.$refs.svgaContainer;if(!i)throw new Error("无法获取画布元素");var a=i.querySelector("canvas");if(!a)throw new Error("无法获取 canvas 元素");this.originalVideoItem;var s=this.totalFrames,n=parseFloat(this.svga.fileInfo.fps)||20,o=this.svga.originalWidth,r=this.svga.originalHeight;if(!o||!r)throw new Error("无法获取 SVGA 尺寸信息 (width: "+o+", height: "+r+")");var l=this.isPlaying;l&&this.svgaPlayer.pauseAnimation();var h=[],g=document.createElement("canvas");g.width=o,g.height=r;for(var d=g.getContext("2d",{alpha:!0}),f=0;f<s;f++){if(!this.isExportingLottie)throw new Error("User Cancelled");d.clearRect(0,0,o,r),this.svgaPlayer.stepToFrame(f,!1),await new Promise(function(e){setTimeout(e,100)}),d.drawImage(a,0,0);var u=g.toDataURL("image/png");h.push({index:f,dataUrl:u}),this.lottieExportProgress=Math.floor((f+1)/s*50),f%5==0&&await new Promise(function(e){setTimeout(e,0)})}this.lottieExportProgress=55;var c=this.buildLottieFromFrames(h,o,r,n,s);this.lottieExportProgress=90;var m=JSON.stringify(c,null,2),p=new Blob([m],{type:"application/json"});this.utils.downloadFile(p,(this.svga.fileInfo.name.replace(/\.svga$/i,"")||"animation")+".json"),this.lottieExportProgress=100,setTimeout(function(){e.isExportingLottie=!1,e.lottieExportProgress=0,alert("Lottie 导出成功！\n\n文件大小: "+e.utils.formatBytes(p.size)+"\n\n请将JSON文件导入After Effects进行编辑。")},300),l&&this.svgaPlayer&&"svga"===this.currentModule&&this.svgaPlayer.startAnimation()}catch(e){"User Cancelled"===e.message||alert("Lottie导出失败: "+e.message)}finally{this.taskManager&&t&&this.taskManager.finish(t),this.isExportingLottie=!1,this.lottieExportProgress=0}}}else alert("请先加载 SVGA 文件")},buildLottieFromFrames:function(e,t,i,a,s){var n={v:"5.7.0",fr:a,ip:0,op:s,w:t,h:i,nm:"SVGA to Lottie Export",ddd:0,assets:[],layers:[]};return e.forEach(function(e,a){var s="image_"+a;n.assets.push({id:s,w:t,h:i,u:"",p:e.dataUrl,e:0})}),e.forEach(function(e,a){var s="image_"+a,o=a,r=a+1;n.layers.push({ddd:0,ind:a+1,ty:2,nm:"Frame "+a,refId:s,sr:1,ks:{o:{a:1,k:[{i:{x:[1],y:[1]},o:{x:[0],y:[0]},t:o,s:[100]},{t:r,s:[0]}]},r:{a:0,k:0},p:{a:0,k:[t/2,i/2,0]},a:{a:0,k:[t/2,i/2,0]},s:{a:0,k:[100,100,100]}},ao:0,ip:o,op:r,st:o,bm:0})}),n},openChromaKeyPanel:function(){this.mp4Video&&this.mp4.hasFile?(this.chromaKeyConfig={enabled:this.chromaKeyEnabled,similarity:this.chromaKeySimilarity,smoothness:this.chromaKeySmoothness,applied:this.chromaKeyApplied},this.showChromaKeyPanel=!this.showChromaKeyPanel):alert("请先加载 MP4 文件")},applyChromaKey:function(e){this.chromaKeyEnabled=e.enabled,this.chromaKeySimilarity=e.similarity,this.chromaKeySmoothness=e.smoothness,this.chromaKeyApplied=e.applied,this.chromaKeyEnabled?this.updateChromaKeyEffect():this.removeChromaKeyEffect(),this.showChromaKeyPanel=!1},closeChromaKeyPanel:function(){this.showChromaKeyPanel=!1},toggleChromaKey:function(){this.chromaKeyEnabled=!this.chromaKeyEnabled,this.chromaKeyEnabled?this.updateChromaKeyEffect():this.removeChromaKeyEffect()},updateChromaKeyEffect:function(){if(this.chromaKeyEnabled&&this.mp4Video){var e=this,t=this.mp4Video,i=this.$refs.svgaContainer;if(i){this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null);var a=i.querySelector("canvas.chromakey-canvas");a&&i.removeChild(a),this._chromaKeyCanvas||(this._chromaKeyCanvas=document.createElement("canvas"),this._chromaKeyCanvas.className="chromakey-canvas",this._chromaKeyCanvas.style.cssText="display: block;"),this._chromaKeyCanvas.width=t.videoWidth,this._chromaKeyCanvas.height=t.videoHeight,this._chromaKeyCtx||(this._chromaKeyCtx=this._chromaKeyCanvas.getContext("2d",{willReadFrequently:!0,alpha:!0}));var s=this._chromaKeyCanvas,n=this._chromaKeyCtx;t.style.display="none",i.appendChild(s);var o=this.chromaKeySimilarity/100,r=this.chromaKeySmoothness/100,l=0,h=1e3/30,g=function(i){if(!e.chromaKeyEnabled||!e.mp4Video||"mp4"!==e.currentModule)return e.chromaKeyRenderLoop=null,void e.removeChromaKeyEffect();if(i-l<h)e.chromaKeyRenderLoop=requestAnimationFrame(g);else{l=i,n.drawImage(t,0,0);var a=n.getImageData(0,0,s.width,s.height),d=a.data;o=e.chromaKeySimilarity/100,r=e.chromaKeySmoothness/100;for(var f=0;f<d.length;f+=4){var u=d[f],c=d[f+1],m=d[f+2];if(c>u*(1+o)&&c>m*(1+o)){var p=(c-Math.max(u,m))/255,v=Math.max(0,1-p/(1-r+.01));d[f+3]=Math.floor(255*v)}}n.putImageData(a,0,0),e.chromaKeyRenderLoop=requestAnimationFrame(g)}};g()}}else this.removeChromaKeyEffect()},removeChromaKeyEffect:function(){this.chromaKeyRenderLoop&&(cancelAnimationFrame(this.chromaKeyRenderLoop),this.chromaKeyRenderLoop=null);var e=this.$refs.svgaContainer;e&&this.mp4Video&&(e.querySelectorAll("canvas").forEach(function(t){t.classList.contains("chromakey-canvas")&&e.removeChild(t)}),this.mp4Video.style.display="block",this.mp4Video.style.visibility="visible",this.mp4Video.style.opacity="1",this.currentTime>0&&(this.mp4Video.currentTime=this.currentTime),this.isPlaying&&this.mp4Video.play(),this._chromaKeyCanvas=null,this._chromaKeyCtx=null)},applyChromaKey:function(){this.chromaKeyApplied=this.chromaKeyEnabled,this.chromaKeyEnabled?this.updateChromaKeyEffect():this.removeChromaKeyEffect(),this.closeChromaKeyPanel()},openSpeedRemapEditor:function(){if(this.mp4Video&&this.mp4.hasFile){if(this.showSpeedRemapEditor)return this.showSpeedRemapEditor=!1,this.selectedKeyframeIndex=-1,void(this.timelineHoverX=-1);var e=this.mp4Video,t=this.mp4.detectedFps||30,i=e.duration||0,a=Math.ceil(i*t);if(this.speedRemapConfig.fps=t,this.speedRemapConfig.originalDuration=i,this.speedRemapConfig.originalTotalFrames=a,!this.speedRemapConfig.keyframes||this.speedRemapConfig.keyframes.length<2)this.speedRemapConfig.keyframes=[{originalFrame:0,position:0,isEndpoint:!0},{originalFrame:a,position:1,isEndpoint:!0}];else this.speedRemapConfig.keyframes[this.speedRemapConfig.keyframes.length-1].originalFrame=a;this.showSpeedRemapEditor=!0,this.selectedKeyframeIndex=-1,this.timelineHoverX=-1}else alert("请先加载 MP4 文件")},cancelSpeedRemap:function(){this.showSpeedRemapEditor=!1,this.selectedKeyframeIndex=-1,this.timelineHoverX=-1},resetSpeedRemap:function(){var e=this.speedRemapConfig.originalTotalFrames;this.speedRemapConfig.keyframes=[{originalFrame:0,position:0,isEndpoint:!0},{originalFrame:e,position:1,isEndpoint:!0}],this.speedRemapConfig.enabled=!1,this.selectedKeyframeIndex=-1},onFrameLabelDblClick:function(e){var t=this.speedRemapConfig.keyframes[e];t&&(t.isEndpoint||(this.editingKeyframeIndex=e,this.editFrameInput=t.originalFrame.toString(),this.showEditFrameDialog=!0))},confirmEditFrame:function(){var e=parseInt(this.editFrameInput,10),t=this.speedRemapConfig.originalTotalFrames;if(isNaN(e))this.utils.showToast("请输入有效的帧数");else if(e<0||e>t)this.utils.showToast("帧数范围: 0-"+t);else{for(var i=this.speedRemapConfig.keyframes,a=this.editingKeyframeIndex,s=0;s<i.length;s++)if(s!==a&&i[s].originalFrame===e)return void this.utils.showToast("该帧数已存在K帧");i[a].originalFrame=e,i.sort(function(e,t){return e.originalFrame-t.originalFrame}),this.showEditFrameDialog=!1,this.editingKeyframeIndex=-1,this.editFrameInput=""}},cancelEditFrame:function(){this.showEditFrameDialog=!1,this.editingKeyframeIndex=-1,this.editFrameInput=""},confirmSpeedRemap:function(){var e=this,t=this.speedRemapConfig.keyframes,i=t.length>2;if(!i&&t.length>=2){var a=t[0],s=t[t.length-1];i=0!==a.position||1!==s.position}var n=!1,o=this.speedRemapConfig.originalTotalFrames||1;if(i&&t.length>=2)for(var r=0;r<t.length-1;r++){var l=t[r],h=t[r+1],g=h.originalFrame-l.originalFrame,d=h.position-l.position;if(d>0&&g>0){var f=g/(d*o);if(f<.1||f>12){n=!0;for(var u=g/(Math.max(.1,Math.min(12,f))*o)-d,c=r+1;c<t.length;c++)t[c].position+=u}}}this.speedRemapConfig.enabled=i,this.showSpeedRemapEditor=!1,this.selectedKeyframeIndex=-1,n?this.utils.showToast("超出变速范围0.1-12，已自动调整为范围内速度"):i&&this.utils.showToast("变速配置已应用"),i&&(this.isPlaying&&this.togglePlay(),this.playerController&&this.playerController.seekTo(0),setTimeout(function(){e.isPlaying||e.togglePlay()},100))},onTimelineMouseMove:function(e){var t=this.$refs.speedRemapTimeline;if(t){var i=t.getBoundingClientRect(),a=e.clientX-i.left,s=(a=Math.max(0,Math.min(500,a)))/500,n=this.speedRemapConfig.keyframes,o=n[0]?n[0].position:0,r=n[n.length-1]?n[n.length-1].position:1;if(s<=o||s>=r)this.timelineHoverX=-1;else{for(var l=0;l<n.length;l++){var h=500*n[l].position;if(Math.abs(a-h)<8)return void(this.timelineHoverX=-1)}this.timelineHoverX=a}}},onTimelineMouseLeave:function(){this.timelineHoverX=-1},onTimelineClick:function(e){var t=this.$refs.speedRemapTimeline;if(t){var i=t.getBoundingClientRect(),a=e.clientX-i.left,s=Math.max(0,Math.min(1,a/500)),n=this.speedRemapConfig.keyframes,o=n[0]?n[0].position:0,r=n[n.length-1]?n[n.length-1].position:1;if(!(s<=o||s>=r)){for(var l=0;l<n.length;l++){var h=500*n[l].position;if(Math.abs(a-h)<8)return}this.addKeyframe(s)}}},addKeyframe:function(e){var t=this.speedRemapConfig.keyframes;if(t.length>=10)this.utils.showToast("最多支持10个关键帧");else{var i={originalFrame:this.getOriginalFrameAtPosition(e),position:e,isEndpoint:!1};t.push(i),t.sort(function(e,t){return e.position-t.position}),this.timelineHoverX=-1}},getOriginalFrameAtPosition:function(e){var t=this.speedRemapConfig.keyframes;if(!t||t.length<2)return Math.round(e*this.speedRemapConfig.originalTotalFrames);for(var i=0;i<t.length-1;i++){var a=t[i],s=t[i+1];if(e>=a.position&&e<=s.position){if(s.position===a.position)return a.originalFrame;var n=(e-a.position)/(s.position-a.position);return Math.round(a.originalFrame+(s.originalFrame-a.originalFrame)*n)}}return Math.round(e*this.speedRemapConfig.originalTotalFrames)},getSpeedAtPosition:function(e){var t=this.speedRemapConfig.keyframes;if(!t||t.length<2)return 1;var i=this.speedRemapConfig.originalTotalFrames;if(!i)return 1;for(var a=0;a<t.length-1;a++){var s=t[a],n=t[a+1];if(e>=s.position&&e<=n.position){var o=n.originalFrame-s.originalFrame,r=n.position-s.position;return r<=0||o<=0?1:o/(r*i)}}return 1},onKeyframeLineClick:function(e){var t=this.speedRemapConfig.keyframes[e];t&&(t.isEndpoint||this.speedRemapConfig.keyframes.splice(e,1))},onKeyframeMouseDown:function(e,t){var i=this,a=this.speedRemapConfig.keyframes[t];if(a){var s=this.$refs.speedRemapTimeline;if(s){this.selectedKeyframeIndex=t,this.timelineHoverX=-1;s.getBoundingClientRect();var n=e.clientX,o=a.position,r=function(e){var s=e.clientX-n,r=o+s/500,l=i.speedRemapConfig.keyframes,h=l[t-1]?l[t-1].position+.01:0,g=l[t+1]?l[t+1].position-.01:1;r=Math.max(h,Math.min(g,r)),a.position=r},l=function(){document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",l),i.selectedKeyframeIndex=-1};document.addEventListener("mousemove",r),document.addEventListener("mouseup",l),e.preventDefault()}}},buildFrameMap:function(e){var t=this.speedRemapConfig;if(!t.enabled||!t.keyframes||t.keyframes.length<2)return null;var i,a=t.originalTotalFrames,s=t.keyframes,n=s[0].position,o=s[s.length-1].position-n;if(e&&(e=Number(e)),e&&e>0&&this.mp4Video&&this.mp4Video.duration){var r=o*this.mp4Video.duration;i=Math.ceil(r*e)}else i=Math.ceil(o*a);i<1&&(i=1);for(var l=[],h=0;h<i;h++){var g=n+h/i*o,d=this.getOriginalFrameAtPosition(g);d=Math.max(0,Math.min(a-1,d)),l.push(d)}return l},openSvgaToDualChannelPanel:function(){if(this.svgaPlayer&&this.svga.hasFile&&this.originalVideoItem){var e=this.getGifSourceInfo();if(this.confirmExportLimits(e,"SVGA 转 MP4")){var t=this.originalVideoItem;this.dualChannelConfig.width=t.videoSize.width,this.dualChannelConfig.height=t.videoSize.height,this.dualChannelConfig.aspectRatio=t.videoSize.width/t.videoSize.height;var i=t.FPS||t.fps||30;if(this.dualChannelConfig.fps=i,this.dualChannelSourceInfo={name:this.svga.fileInfo.name,sizeWH:t.videoSize.width+" x "+t.videoSize.height,duration:e.duration.toFixed(1)+"s",fileSize:this.svga.fileInfo.sizeText,fps:i},this.configManager){var s=this.configManager.get("mp4_fps");void 0!==s&&(this.dualChannelConfig.fps=parseInt(s));var n=this.configManager.get("mp4_quality");void 0!==n&&(this.dualChannelConfig.quality=parseInt(n))}this.openRightPanel("showSvgaToDualChannelPanel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}}else alert("请先加载 SVGA 文件")},closeSvgaToDualChannelPanel:function(){if(this.isConvertingToDualChannel){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToDualChannel=!1,this.dualChannelProgress=0}this.showSvgaToDualChannelPanel=!1},openMp4ToDualChannelPanel:function(){if(this.mp4Video&&this.mp4.hasFile){var e=this.mp4.fileInfo.fps||30;this.dualChannelSourceInfo={name:this.mp4.fileInfo.name,sizeWH:this.mp4.originalWidth+" x "+this.mp4.originalHeight,duration:this.mp4Video.duration.toFixed(1)+"s",fileSize:this.mp4.fileInfo.sizeText,fps:e},this.dualChannelConfig.width=this.mp4.originalWidth,this.dualChannelConfig.height=this.mp4.originalHeight,this.dualChannelConfig.aspectRatio=this.mp4.originalWidth/this.mp4.originalHeight;var t=this.mp4.fileInfo.fps||30;this.dualChannelConfig.fps=Math.min(120,Math.max(1,Math.round(parseFloat(t))));try{if(this.configManager){var i=this.configManager.get("mp4_quality");void 0!==i&&(this.dualChannelConfig.quality=parseInt(i))}}catch(e){}this.openRightPanel("showMp4ToDualChannelPanel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载 MP4 文件")},closeMp4ToDualChannelPanel:function(){if(this.isConvertingToDualChannel){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToDualChannel=!1,this.dualChannelProgress=0}this.showMp4ToDualChannelPanel=!1},toggleMp4DualChannelModeDropdown:function(){this.showMp4DualChannelModeDropdown=!this.showMp4DualChannelModeDropdown},selectMp4DualChannelMode:function(e){this.mp4DualChannelConfig.channelMode=e,this.showMp4DualChannelModeDropdown=!1},onMp4DualChannelWidthChange:function(){var e=this.mp4DualChannelConfig.width;e>0&&this.mp4DualChannelConfig.aspectRatio>0&&(this.mp4DualChannelConfig.height=Math.round(e/this.mp4DualChannelConfig.aspectRatio))},onMp4DualChannelHeightChange:function(){var e=this.mp4DualChannelConfig.height;e>0&&this.mp4DualChannelConfig.aspectRatio>0&&(this.mp4DualChannelConfig.width=Math.round(e*this.mp4DualChannelConfig.aspectRatio))},cancelMp4ToDualChannelConversion:function(){confirm("确定要取消转换吗？")&&(this.dualChannelCancelled=!0)},startMp4ToDualChannelConversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.mp4Video&&this.mp4.hasFile){var i=this.getGifSourceInfo();if(this.confirmExportLimits(i,"MP4 转双通道"))if((e=this.dualChannelConfig).width<1||e.width>9999)alert("宽度超出范围！\n\n合法范围：1-9999 像素");else if(e.height<1||e.height>9999)alert("高度超出范围！\n\n合法范围：1-9999 像素");else if(e.quality<1||e.quality>100)alert("压缩质量超出范围！\n\n合法范围：1-100");else if(e.fps<1||e.fps>120)alert("帧率超出范围！\n\n合法范围：1-120 fps");else{try{this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(e){console.error("Config save failed:",e)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var s=null;this.taskManager&&(s=this.taskManager.register("MP4转双通道",function(){t.cancelMp4ToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";var n=await this.extractMp4FramesForDualChannel();if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var o=await this.composeDualChannelFrames(n);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var r=null,l=1;if(this.mp4HasAudio&&this.mp4.file){var h=this.mp4Video.duration;if(this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2)try{this.dualChannelMessage="正在处理音频...";var g=Math.ceil(h*(this.mp4.fileInfo.fps||30)),d=await this.extractAudioFromMp4(this.mp4.file,n.length,e.fps,g,this.mp4.fileInfo.fps||30);d&&d.length>0&&d[0].audioData&&(r=d[0].audioData,l=1)}catch(t){console.error("音频变速处理失败，回退到平均变速模式",t),r=new Uint8Array(await this.mp4.file.arrayBuffer()),l=h/(n.length/e.fps)}else try{r=new Uint8Array(await this.mp4.file.arrayBuffer());var f=n.length/e.fps;f>0&&(l=h/f)}catch(e){console.error("读取音频失败",e)}}var u=await a.FFmpegService.convertFramesToMp4({frames:o,fps:e.fps,quality:e.quality,audioData:r,audioSpeedRatio:l,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadDualChannelMP4(u,"mp4"),setTimeout(function(){alert("✅ 转换完成！")},500),this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(e){"用户取消转换"===e.message||("FFmpeg服务正忙，请稍后再试"===e.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("MP4转双通道失败:",e),alert("转换失败："+e.message)))}finally{this.taskManager&&s&&this.taskManager.finish(s),this.isConvertingToDualChannel=!1,this.dualChannelProgress=0,this.dualChannelStage="",this.dualChannelMessage=""}}}else alert("请先加载 MP4 文件")},extractMp4FramesForDualChannel:async function(){var e=this.mp4Video,t=this.dualChannelConfig,i=t.fps,a=e.duration,s=Math.ceil(a*i),n=[],o=null;this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(o=this.buildFrameMap(i))&&o.length>0&&(s=o.length);var r=document.createElement("canvas");r.width=t.width,r.height=t.height;var l=r.getContext("2d",{willReadFrequently:!0,alpha:!0}),h=this.chromaKeyEnabled,g=null;h&&(g=this.$refs.svgaContainer.querySelector("canvas.chromakey-canvas"));var d=!e.paused;e.pause();for(var f=0;f<s&&!this.dualChannelCancelled;f++){var u,c=f;o&&void 0!==o[f]&&(c=o[f]);var m=this.speedRemapConfig.originalTotalFrames||30*a;u=c/m*a,e.currentTime=u;try{await new Promise(function(t,i){var a=function(){e.removeEventListener("seeked",a),t()};if(e.addEventListener("seeked",a),!e.seeking&&Math.abs(e.currentTime-u)<.1)return e.removeEventListener("seeked",a),void t();setTimeout(function(){e.removeEventListener("seeked",a),i(new Error("Seek timeout"))},2e3)})}catch(e){if(console.warn("Seek timeout or error, skipping frame "+f),this.dualChannelCancelled)break}l.clearRect(0,0,t.width,t.height),h&&g?(this.applyChromaKeyFrame(),await new Promise(function(e){setTimeout(e,30)}),l.drawImage(g,0,0,t.width,t.height)):(l.fillStyle="#000000",l.fillRect(0,0,t.width,t.height),l.drawImage(e,0,0,t.width,t.height));var p=l.getImageData(0,0,t.width,t.height);n.push(p);var v=Math.min(30,Math.round(f/s*30));this.dualChannelProgress=v}return d&&e.play(),this.dualChannelProgress<30&&(this.dualChannelProgress=30),console.log("帧提取完成，实际提取帧数:",n.length),n},applyChromaKeyFrame:function(){var e=this.mp4Video,t=this.$refs.svgaContainer.querySelector("canvas.chromakey-canvas");if(t&&e){var i=t.getContext("2d",{willReadFrequently:!0,alpha:!0});i.drawImage(e,0,0);for(var a=i.getImageData(0,0,t.width,t.height),s=a.data,n=this.chromaKeySimilarity/100,o=this.chromaKeySmoothness/100,r=0;r<s.length;r+=4){var l=s[r],h=s[r+1],g=s[r+2],d=h-Math.max(l,g),f=255*n;if(d>.5*f){var u=1-Math.min(1,(d-.5*f)/(f*o+1));s[r+3]=Math.round(255*u)}}i.putImageData(a,0,0)}},buildAudioTempoFilter:function(e){return a.FFmpegService.buildAudioTempoFilter(e)},downloadDualChannelMP4:function(e,t){var i="dual-channel";"mp4"===t&&this.mp4.fileInfo.name?i=this.mp4.fileInfo.name.replace(/\.mp4$/i,""):"lottie"===t&&this.lottie.fileInfo.name&&(i=this.lottie.fileInfo.name.replace(/\.json$/i,"")),this.utils.downloadFile(e,i+"_dual.mp4")},openLottieToDualChannelPanel:function(){if(this.lottiePlayer&&this.lottie.hasFile){var e=this.lottie.frameRate||30,t=0;this.lottiePlayer&&"function"==typeof this.lottiePlayer.getDuration&&(t=this.lottiePlayer.getDuration(!1)),this.dualChannelSourceInfo={name:this.lottie.fileInfo.name,sizeWH:(this.lottie.originalWidth||0)+" x "+(this.lottie.originalHeight||0),duration:t.toFixed(1)+"s",fileSize:this.lottie.fileInfo.sizeText,fps:e},this.dualChannelConfig.width=this.lottie.originalWidth||300,this.dualChannelConfig.height=this.lottie.originalHeight||300,this.dualChannelConfig.aspectRatio=this.dualChannelConfig.width/this.dualChannelConfig.height,this.dualChannelConfig.fps=Math.min(120,Math.max(1,Math.round(e)));try{if(this.configManager){var i=this.configManager.get("mp4_quality");void 0!==i&&(this.dualChannelConfig.quality=parseInt(i))}}catch(e){console.error("Config load failed:",e)}this.openRightPanel("showLottieToDualChannelPanel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载 Lottie 文件")},closeLottieToDualChannelPanel:function(){if(this.isConvertingToDualChannel){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToDualChannel=!1,this.dualChannelProgress=0}this.showLottieToDualChannelPanel=!1},toggleLottieDualChannelModeDropdown:function(){this.showLottieDualChannelModeDropdown=!this.showLottieDualChannelModeDropdown},selectLottieDualChannelMode:function(e){this.lottieDualChannelConfig.channelMode=e,this.showLottieDualChannelModeDropdown=!1},onLottieDualChannelWidthChange:function(){var e=this.lottieDualChannelConfig.width;e>0&&this.lottieDualChannelConfig.aspectRatio>0&&(this.lottieDualChannelConfig.height=Math.round(e/this.lottieDualChannelConfig.aspectRatio))},onLottieDualChannelHeightChange:function(){var e=this.lottieDualChannelConfig.height;e>0&&this.lottieDualChannelConfig.aspectRatio>0&&(this.lottieDualChannelConfig.width=Math.round(e*this.lottieDualChannelConfig.aspectRatio))},cancelLottieToDualChannelConversion:function(){confirm("确定要取消转换吗？")&&(this.dualChannelCancelled=!0)},startLottieToDualChannelConversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.lottiePlayer&&this.lottie.hasFile)if((e=this.dualChannelConfig).width<1||e.width>9999)alert("宽度超出范围！");else if(e.height<1||e.height>9999)alert("高度超出范围！");else if(e.quality<1||e.quality>100)alert("压缩质量超出范围！");else if(e.fps<1||e.fps>120)alert("帧率超出范围！");else{try{this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(e){console.error("Config save failed:",e)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var i=null;this.taskManager&&(i=this.taskManager.register("Lottie转双通道",function(){t.cancelLottieToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";var s=await this.extractLottieFrames();if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var n=await this.composeDualChannelFrames(s);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var o=await a.FFmpegService.convertFramesToMp4({frames:n,fps:e.fps,quality:e.quality,audioData:null,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadDualChannelMP4(o,"lottie"),setTimeout(function(){alert("✅ 转换完成！")},500),this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(e){"用户取消转换"===e.message||("FFmpeg服务正忙，请稍后再试"===e.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("Lottie转双通道失败:",e),alert("转换失败："+e.message)))}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isConvertingToDualChannel=!1,this.dualChannelProgress=0,this.dualChannelStage="",this.dualChannelMessage=""}}else alert("请先加载 Lottie 文件")},extractLottieFrames:async function(){var e=this.lottiePlayer,t=this.dualChannelConfig,i=this._lottieAnimationData,a=i.op-i.ip,s=[],n=this.$refs.svgaContainer.querySelector("canvas");if(!n)throw new Error("无法获取Lottie渲染canvas");var o=document.createElement("canvas");o.width=t.width,o.height=t.height;var r=o.getContext("2d",{willReadFrequently:!0,alpha:!0}),l=!e.isPaused;e.pause();for(var h=0;h<a&&!this.dualChannelCancelled;h++){e.goToAndStop(h,!0),await new Promise(function(e){setTimeout(e,30)}),r.clearRect(0,0,t.width,t.height),r.drawImage(n,0,0,t.width,t.height);var g=r.getImageData(0,0,t.width,t.height);s.push(g),h%10==0&&console.log("提取帧进度:",h+1,"/",a),this.dualChannelProgress=Math.floor(h/a*30)}return l&&e.play(),s},openYyevaToSvgaPanel:function(){if(this.yyevaVideo&&this.yyeva.hasFile){var e=this.yyeva.fileInfo.fps||30,t=this.yyeva.displayWidth||Math.floor(this.yyeva.originalWidth/2),i=this.yyeva.displayHeight||this.yyeva.originalHeight;if(this.toSvgaSourceInfo={name:this.yyeva.fileInfo.name,sizeWH:t+" x "+i,duration:this.yyevaVideo.duration.toFixed(1)+"s",fileSize:this.yyeva.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=t,this.toSvgaConfig.height=i,this.toSvgaConfig.fps=Math.min(60,Math.max(1,Math.round(parseFloat(e)))),this.configManager){var s=this.configManager.get("svga_quality");void 0!==s&&(this.toSvgaConfig.quality=parseInt(s))}this.openRightPanel("showYyevaToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)}),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载双通道 MP4 文件")},closeYyevaToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showYyevaToSvgaPanel=!1},cancelYyevaToSvgaConversion:function(){this.toSvgaCancelled=!0,this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""},openMp4ToSvgaPanel:function(){if(this.mp4Video&&this.mp4.hasFile){var e=this.mp4.fileInfo.fps||30;if(this.toSvgaSourceInfo={name:this.mp4.fileInfo.name,sizeWH:this.mp4.originalWidth+" x "+this.mp4.originalHeight,duration:this.mp4Video.duration.toFixed(1)+"s",fileSize:this.mp4.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=this.mp4.originalWidth||0,this.toSvgaConfig.height=this.mp4.originalHeight||0,this.toSvgaConfig.fps=Math.min(60,Math.max(1,Math.round(parseFloat(e)))),this.configManager){var t=this.configManager.get("toSvgaConfig");t&&t.quality&&(this.toSvgaConfig.quality=t.quality)}this.openRightPanel("showMp4ToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)})}else alert("请先加载 MP4 文件")},closeMp4ToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showMp4ToSvgaPanel=!1},cancelMp4ToSvgaConversion:function(){this.toSvgaCancelled=!0,this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""},onMp4ToSvgaWidthChange:function(){var e=this.mp4.originalWidth||0,t=this.mp4.originalHeight||0;if(e&&t){var i=t/e,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.width)||0)),s=Math.floor(a*i);this.toSvgaConfig.width=a,this.toSvgaConfig.height=s}},onMp4ToSvgaHeightChange:function(){var e=this.mp4.originalWidth||0,t=this.mp4.originalHeight||0;if(e&&t){var i=e/t,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.height)||0)),s=Math.floor(a*i);this.toSvgaConfig.width=s,this.toSvgaConfig.height=a}},startMp4ToSvgaConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),!this.isConvertingToSvga)if(this.mp4Video&&this.mp4.hasFile){if(this.confirmIfHasOngoingTasks("转SVGA","task")){var i=this.getGifSourceInfo();if(this.confirmExportLimits(i,"MP4 转 SVGA"))try{var s=this.taskManager.register("MP4转SVGA",function(){t.isConvertingToSvga=!1,t.toSvgaCancelled=!0});if(this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="加载库...",await this.loadLibrary(["protobuf","pako"],!1),this.toSvgaCancelled)return void this.taskManager.finish(s);this.toSvgaStage="extracting",this.toSvgaMessage="提取帧...";var n=await this.extractMp4Frames();if(this.toSvgaCancelled)return n=null,void this.taskManager.finish(s);var o=null;if(!this.toSvgaConfig.muted&&this.mp4.file){this.toSvgaMessage="提取音频...";try{await a.FFmpegService.init();var r=parseFloat(this.mp4.fileInfo.fps)||30,l=this.mp4Video?this.mp4Video.duration:0,h=Math.ceil(l*r),g=parseFloat(this.toSvgaConfig.fps)||30;if(this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2)o=await this.extractAudioFromMp4(this.mp4.file,n.length,g,h,r);else{var d=1;if(l>0&&n.length>0)d=l/(n.length/g);o=await a.FFmpegService.extractAudio({videoFile:this.mp4.file,totalFrames:n.length,fps:g,speedRatio:d})}}catch(e){console.warn("音频提取失败:",e),"FFmpeg服务正忙，请稍后再试"===e.message&&alert("FFmpeg服务正忙，音频提取跳过")}if(this.toSvgaCancelled)return}this.toSvgaStage="building";var f=await this.buildSVGAFromConfig("mp4",{frames:n,width:this.toSvgaConfig.width,height:this.toSvgaConfig.height,fps:this.toSvgaConfig.fps,quality:this.toSvgaConfig.quality,audios:o,muted:this.toSvgaConfig.muted,dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(this.toSvgaCancelled)return void this.taskManager.finish(s);var u=(this.mp4.fileInfo.name||"video").replace(/\.[^.]+$/,"");this.downloadSVGA(f,u+".svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。"),this.configManager&&this.configManager.set("toSvgaConfig",{quality:this.toSvgaConfig.quality}),this.isConvertingToSvga=!1,setTimeout(function(){t.isConvertingToSvga||(t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage="")},1e3)}catch(e){"FFmpeg服务正忙，请稍后再试"===e.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("MP4转SVGA失败:",e),alert("转换失败: "+e.message)),this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""}finally{this.taskManager&&s&&this.taskManager.finish(s)}}}else alert("请先加载 MP4 文件")},extractMp4Frames:async function(){var e=this.mp4Video,t=this.toSvgaConfig.fps,i=e.duration,a=Math.ceil(i*t),s=[],n=null;this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(n=this.buildFrameMap(t))&&n.length>0&&(a=n.length);var o=document.createElement("canvas");o.width=this.mp4.originalWidth,o.height=this.mp4.originalHeight;for(var r=o.getContext("2d",{willReadFrequently:!0}),l=this.chromaKeyEnabled,h=0;h<a&&!this.toSvgaCancelled;h++){var g;if(n&&void 0!==n[h]){var d=n[h],f=this.speedRemapConfig.originalTotalFrames||30*i;g=d/f*i}else g=h/t;g>i&&(g=i),e.currentTime=g;try{await new Promise(function(t,i){var a=function(){e.removeEventListener("seeked",a),t()};if(e.addEventListener("seeked",a),!e.seeking&&Math.abs(e.currentTime-g)<.1)return e.removeEventListener("seeked",a),void t();setTimeout(function(){e.removeEventListener("seeked",a),i(new Error("Seek timeout"))},2e3)})}catch(e){if(console.warn("Seek timeout or error, skipping frame "+h),this.toSvgaCancelled)break}if(r.drawImage(e,0,0,o.width,o.height),l){var u=r.getImageData(0,0,o.width,o.height);this.applyChromaKeyToImageData(u),r.putImageData(u,0,0)}var c=await new Promise(function(e){o.toBlob(e,"image/png")});s.push({index:h,blob:c}),this.toSvgaProgress=Math.round(h/a*50)}return s},applyChromaKeyToImageData:function(e){for(var t=e.data,i=this.chromaKeySimilarity/100,a=this.chromaKeySmoothness/100,s=0;s<t.length;s+=4){var n=t[s],o=t[s+1],r=t[s+2];if(o>n*(1+i)&&o>r*(1+i)){var l=(o-Math.max(n,r))/255,h=Math.max(0,1-l/(1-a+.01));t[s+3]=Math.floor(255*h)}}},openLottieToSvgaPanel:function(){if(this.lottiePlayer&&this.lottie.hasFile){var e=this.lottie.frameRate||30,t=0;if(this.lottiePlayer&&"function"==typeof this.lottiePlayer.getDuration&&(t=this.lottiePlayer.getDuration(!1)),this.toSvgaSourceInfo={name:this.lottie.fileInfo.name,sizeWH:(this.lottie.originalWidth||0)+" x "+(this.lottie.originalHeight||0),duration:t.toFixed(1)+"s",fileSize:this.lottie.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=this.lottie.originalWidth||0,this.toSvgaConfig.height=this.lottie.originalHeight||0,this.toSvgaConfig.fps=Math.min(60,Math.max(1,Math.round(e))),this.configManager){var i=this.configManager.get("toSvgaConfig");i&&i.quality&&(this.toSvgaConfig.quality=i.quality)}this.openRightPanel("showLottieToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)})}else alert("请先加载 Lottie 文件")},closeLottieToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showLottieToSvgaPanel=!1},onLottieToSvgaWidthChange:function(){var e=this.lottie.originalWidth,t=this.lottie.originalHeight;if(e&&t){var i=t/e,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.width)||0)),s=Math.floor(a*i);this.toSvgaConfig.width=a,this.toSvgaConfig.height=s}},onLottieToSvgaHeightChange:function(){var e=this.lottie.originalWidth,t=this.lottie.originalHeight;if(e&&t){var i=e/t,a=Math.max(1,Math.min(3e3,parseInt(this.toSvgaConfig.height)||0)),s=Math.floor(a*i);this.toSvgaConfig.width=s,this.toSvgaConfig.height=a}},startLottieToSvgaConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),this.lottiePlayer&&this.lottie.hasFile){if(this.confirmIfHasOngoingTasks("Lottie转SVGA","task")){var i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,s=this.toSvgaConfig.quality,n=this.toSvgaConfig.fps;if(i<1||i>3e3||a<1||a>3e3)alert("尺寸超出范围！合法范围：1-3000 像素");else{this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="加载库...";var o=this.taskManager.register("Lottie转SVGA",function(){t.isConvertingToSvga=!1,t.toSvgaProgress=0,t.toSvgaCancelled=!0});try{if(await this.loadLibrary(["protobuf","pako"],!1),this.toSvgaCancelled)return void this.taskManager.finish(o);this.toSvgaStage="extracting",this.toSvgaMessage="提取帧...";var r=await this.extractLottieFramesForSvga();if(this.toSvgaCancelled)return void this.taskManager.finish(o);this.toSvgaStage="building",this.toSvgaMessage="生成SVGA...";var l=await this.buildSVGAFromConfig("lottie",{frames:r,width:i,height:a,fps:n,quality:s,dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(this.toSvgaCancelled)return void this.taskManager.finish(o);var h=(this.lottie.file.name||"animation").replace(/\.[^.]+$/,"");this.downloadSVGA(l,h+".svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。"),this.configManager&&this.configManager.set("toSvgaConfig",{quality:s}),setTimeout(function(){t.isConvertingToSvga||(t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage="")},1e3)}catch(e){"FFmpeg服务正忙，请稍后再试"===e.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("Lottie转SVGA失败:",e),alert("转换失败: "+e.message)),this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""}finally{this.taskManager&&o&&this.taskManager.finish(o)}}}}else alert("请先加载 Lottie 文件")},extractLottieFramesForSvga:async function(){var e=this.lottiePlayer,t=(this.toSvgaConfig.fps,this.toSvgaConfig.width),i=this.toSvgaConfig.height,a=e.totalFrames||this.totalFrames,s=[],n=document.createElement("canvas");n.width=t,n.height=i;var o=n.getContext("2d");this.isPlaying&&(e.pause(),this.isPlaying=!1);for(var r=this.$refs.svgaContainer.querySelector("svg, canvas"),l=0;l<a&&!this.toSvgaCancelled;l++){if(e.goToAndStop(l,!0),await new Promise(function(e){setTimeout(e,20)}),o.clearRect(0,0,t,i),r&&"SVG"===r.tagName){var h=(new XMLSerializer).serializeToString(r),g=new Blob([h],{type:"image/svg+xml;charset=utf-8"}),d=URL.createObjectURL(g),f=new Image;f.width=t,f.height=i,await new Promise(function(e,t){f.onload=e,f.onerror=t,f.src=d}),o.drawImage(f,0,0,t,i),URL.revokeObjectURL(d)}else r&&"CANVAS"===r.tagName&&o.drawImage(r,0,0,t,i);var u=await new Promise(function(e){n.toBlob(e,"image/png")});s.push({index:l,blob:u}),this.toSvgaProgress=Math.round(l/a*50)}return s},openFramesToSvgaPanel:function(){if(this.frames.hasFile&&this.frames.files.length){var e=this.frames.fileInfo.fps||25;if(this.toSvgaSourceInfo={name:this.frames.fileInfo.name,sizeWH:(this.frames.originalWidth||0)+" x "+(this.frames.originalHeight||0),duration:this.frames.fileInfo.duration,fileSize:this.frames.fileInfo.sizeText,fps:e},this.toSvgaConfig.width=this.frames.originalWidth||0,this.toSvgaConfig.height=this.frames.originalHeight||0,this.toSvgaConfig.fps=e,this.configManager){var t=this.configManager.get("framesToSvgaConfig");t&&t.quality&&(this.toSvgaConfig.quality=t.quality)}this.openRightPanel("showImagesToSvgaPanel"),this.loadLibrary(["protobuf","pako"],!0).catch(function(e){console.warn("Library preload failed:",e)})}else alert("请先加载序列帧文件")},closeImagesToSvgaPanel:function(){if(this.isConvertingToSvga){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaCancelled=!0}this.showImagesToSvgaPanel=!1},onFramesToSvgaWidthChange:function(){var e=this.frames.originalWidth,t=this.frames.originalHeight;if(e&&t){var i=t/e,a=Math.max(1,Math.min(3e3,parseInt(this.framesToSvgaConfig.width)||0)),s=Math.floor(a*i);this.framesToSvgaConfig.width=a,this.framesToSvgaConfig.height=s}},onFramesToSvgaHeightChange:function(){var e=this.frames.originalWidth,t=this.frames.originalHeight;if(e&&t){var i=e/t,a=Math.max(1,Math.min(3e3,parseInt(this.framesToSvgaConfig.height)||0)),s=Math.floor(a*i);this.framesToSvgaConfig.width=s,this.framesToSvgaConfig.height=a}},startFramesToSvgaConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),this.frames.hasFile&&this.frames.files.length){if(this.confirmIfHasOngoingTasks("序列帧转SVGA","task")){var i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,s=this.toSvgaConfig.quality,n=this.toSvgaConfig.fps;if(i<1||i>3e3||a<1||a>3e3)alert("尺寸超出范围！合法范围：1-3000 像素");else{this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="加载库...";var o=this.taskManager.register("序列帧转SVGA",function(){t.isConvertingToSvga=!1,t.toSvgaProgress=0,t.toSvgaCancelled=!0});try{if(await this.loadLibrary(["protobuf","pako"],!1),this.toSvgaCancelled)return void this.taskManager.finish(o);this.toSvgaStage="extracting",this.toSvgaMessage="处理帧...";for(var r=[],l=this.frames.files,h=0;h<l.length;h++){if(this.toSvgaCancelled){this.taskManager.finish(o);break}r.push({index:h,blob:l[h]}),t.toSvgaProgress=Math.round(h/l.length*50)}if(this.toSvgaCancelled)return void this.taskManager.finish(o);this.toSvgaStage="building";var g=await this.buildSVGAFromConfig("frames",{frames:r,width:i,height:a,fps:n,quality:s,originalSize:{width:this.frames.originalWidth,height:this.frames.originalHeight},dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(this.toSvgaCancelled)return void this.taskManager.finish(o);this.downloadSVGA(g,"sequence.svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。"),this.configManager&&this.configManager.set("framesToSvgaConfig",{quality:s}),setTimeout(function(){t.isConvertingToSvga=!1,t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage=""},1e3),this.taskManager.finish(o)}catch(e){this.taskManager.finish(o),"FFmpeg服务正忙，请稍后再试"===e.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("序列帧转SVGA失败:",e),alert("转换失败: "+e.message)),this.isConvertingToSvga=!1,this.toSvgaProgress=0,this.toSvgaStage="",this.toSvgaMessage=""}finally{this.taskManager&&o&&this.taskManager.finish(o)}}}}else alert("请先加载序列帧文件")},cancelFramesToSvgaConversion:function(){this.toSvgaCancelled=!0,this.toSvgaMessage="正在取消..."},openFramesToDualChannelPanel:function(){if(this.frames.hasFile&&this.frames.files.length){var e=this.frames.fileInfo.fps||25;this.dualChannelSourceInfo={name:this.frames.fileInfo.name,sizeWH:(this.frames.originalWidth||0)+" x "+(this.frames.originalHeight||0),duration:this.frames.fileInfo.duration,fileSize:this.frames.fileInfo.sizeText,fps:e},this.dualChannelConfig.width=this.frames.originalWidth,this.dualChannelConfig.height=this.frames.originalHeight,this.dualChannelConfig.fps=e,this.dualChannelConfig.height>0?this.dualChannelConfig.aspectRatio=this.dualChannelConfig.width/this.dualChannelConfig.height:this.dualChannelConfig.aspectRatio=1;try{if(this.configManager){var t=this.configManager.get("mp4_quality");void 0!==t&&(this.dualChannelConfig.quality=parseInt(t))}}catch(e){console.error("Config load failed:",e)}this.openRightPanel("showImagesToDualChannelPanel"),a.FFmpegService.init({highPriority:!0}).catch(function(e){console.warn("FFmpeg预加载失败:",e)})}else alert("请先加载序列帧文件")},closeImagesToDualChannelPanel:function(){if(this.isConvertingToDualChannel){if(!confirm("正在转换中，确定要取消吗？"))return;this.isConvertingToDualChannel=!1,this.dualChannelProgress=0,this.dualChannelCancelled=!0}this.showImagesToDualChannelPanel=!1},cancelFramesToDualChannelConversion:function(){this.dualChannelCancelled=!0,this.dualChannelMessage="正在取消..."},startFramesToDualChannelConversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.frames.hasFile&&this.frames.files.length){if(this.confirmIfHasOngoingTasks("序列帧转MP4","task"))if((e=this.dualChannelConfig).width<1||e.width>9999)alert("宽度超出范围！\n\n合法范围：1-9999 像素");else if(e.height<1||e.height>9999)alert("高度超出范围！\n\n合法范围：1-9999 像素");else if(e.quality<1||e.quality>100)alert("压缩质量超出范围！\n\n合法范围：1-100");else if(e.fps<1||e.fps>120)alert("帧率超出范围！\n\n合法范围：1-120 fps");else{try{this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(e){console.error("Config save failed:",e)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var i=null;this.taskManager&&(i=this.taskManager.register("序列帧转双通道",function(){t.cancelFramesToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";try{var s=await this.extractFramesForDualChannel();if(this.dualChannelCancelled)throw new Error("用户取消转换")}catch(e){return this.isConvertingToDualChannel=!1,this.dualChannelProgress=0,this.dualChannelMessage="转换失败",void alert("提取序列帧失败: "+e.message)}this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var n=await this.composeFramesDualChannel(s);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var o=await a.FFmpegService.convertFramesToMp4({frames:n,fps:e.fps,quality:e.quality,audioData:null,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadDualChannelMP4(o,"frames"),setTimeout(function(){alert("✅ 转换完成！")},500),this.configManager&&this.configManager.set("mp4_quality",e.quality)}catch(e){"用户取消转换"===e.message||("FFmpeg服务正忙，请稍后再试"===e.message?alert("FFmpeg服务正忙，请稍后再试"):(console.error("序列帧转双通道MP4失败:",e),alert("转换失败："+e.message)))}finally{this.taskManager&&i&&this.taskManager.finish(i),this.isConvertingToDualChannel=!1}}}else alert("请先加载序列帧文件")},extractFramesForDualChannel:async function(){var e=this.dualChannelConfig,t=this.framesImages,i=t.length,a=[];console.log("开始提取帧，总帧数:",i,"尺寸:",e.width,"x",e.height);var s=document.createElement("canvas");s.width=e.width,s.height=e.height;for(var n=s.getContext("2d",{willReadFrequently:!0,alpha:!0}),o=0;o<i&&!this.dualChannelCancelled;o++){var r=t[o];n.clearRect(0,0,e.width,e.height),n.drawImage(r,0,0,e.width,e.height);var l=n.getImageData(0,0,e.width,e.height);a.push(l),this.dualChannelProgress=Math.floor(o/i*30)}return a},composeFramesDualChannel:async function(e,t){var i=this;return console.log("开始合成双通道帧，帧数:",e.length,"格式:",t),a.DualChannelComposer.composeFrames(e,{mode:this.dualChannelConfig.channelMode,format:t||"jpeg",onProgress:function(t){i.dualChannelProgress=30+Math.round(30*t),i.dualChannelMessage="合成双通道帧 "+Math.round(t*e.length)+"/"+e.length},onCancel:function(){return i.dualChannelCancelled}})},startSVGAConversion:async function(e){var t=this;if(e&&(this.toSvgaConfig=Object.assign({},this.toSvgaConfig,e)),this.yyevaVideo&&this.yyeva.hasFile){if(this.confirmIfHasOngoingTasks("转SVGA","task")){var i=this.toSvgaConfig.width,s=this.toSvgaConfig.height,n=this.toSvgaConfig.quality,o=this.toSvgaConfig.fps;if(i<1||i>3e3)alert("宽度超出范围！\n\n合法范围：1-3000 像素\n当前值："+i);else if(s<1||s>3e3)alert("高度超出范围！\n\n合法范围：1-3000 像素\n当前值："+s);else if(n<1||n>100)alert("压缩质量超出范围！\n\n合法范围：1-100\n当前值："+n);else if(o<1||o>60)alert("帧率超出范围！\n\n合法范围：1-60 fps\n当前值："+o);else{this.configManager&&this.configManager.set("svga_quality",this.toSvgaConfig.quality),this.isConvertingToSvga=!0,this.toSvgaProgress=0,this.toSvgaCancelled=!1,this.toSvgaStage="loading",this.toSvgaMessage="正在加载库...";var r=null;this.taskManager&&(r=this.taskManager.register("双通道MP4转SVGA",function(){t.cancelYyevaToSvgaConversion()}));try{if(await this.loadLibrary(["protobuf","pako"],!0),this.toSvgaCancelled)throw new Error("用户取消转换");this.toSvgaStage="extracting",this.toSvgaMessage="正在提取序列帧...";var l=await this.extractYyevaFramesOptimized();if(this.toSvgaCancelled)throw new Error("用户取消转换");var h=null;if(!this.toSvgaConfig.muted&&this.yyeva.file){this.toSvgaMessage="正在提取音频...";try{await a.FFmpegService.init();var g=this.speedRemapConfig.originalTotalFrames,d=30,f=this.yyevaVideo;f&&f.duration>0&&g&&(d=g/f.duration),h=await this.extractAudioFromMp4(this.yyeva.file,l.frames.length,this.toSvgaConfig.fps,g,d)}catch(e){console.warn("Audio extraction failed, exporting silent SVGA:",e)}if(this.toSvgaCancelled)throw new Error("用户取消转换")}this.toSvgaStage="building";var u=await this.buildSVGAFromConfig("yyeva",{buildType:"fromPNG",frames:l.frames,scaledWidth:l.scaledWidth,scaledHeight:l.scaledHeight,displayWidth:l.displayWidth,displayHeight:l.displayHeight,scaleFactor:l.scaleFactor,fps:this.toSvgaConfig.fps,audios:h,muted:this.toSvgaConfig.muted,dependencies:{protobuf:protobuf,pako:pako}},{progressField:"toSvgaProgress",messageField:"toSvgaMessage",cancelledField:"toSvgaCancelled"});if(console.log("[调试] FFmpeg提取帧完成，共提取:",l.frames.length,"帧"),console.log("[调试] 缩放信息 - scaledWidth:",l.scaledWidth,"scaledHeight:",l.scaledHeight,"scaleFactor:",l.scaleFactor),this.toSvgaCancelled)throw new Error("用户取消转换");this.toSvgaStage="done";var c=this.yyeva.fileInfo.name.replace(/\.mp4$/i,"");this.downloadSVGA(u,c+".svga"),alert("✅ 转换完成！\n\n已成功生成SVGA文件。")}catch(e){"用户取消转换"!==e.message&&(console.error("SVGA转换失败:",e),alert("转换失败："+e.message)),setTimeout(function(){t.isConvertingToSvga||(t.toSvgaProgress=0,t.toSvgaStage="",t.toSvgaMessage="")},1e3)}finally{this.taskManager&&r&&this.taskManager.finish(r),this.isConvertingToSvga=!1}}}}else alert("请先加载双通道 MP4 文件")},extractYyevaFrames:async function(){var e=this.yyevaVideo,t=this.toSvgaConfig.fps,i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,s=(this.toSvgaConfig.quality||100)/100,n=Math.round(i*s),o=Math.round(a*s);n=Math.max(1,n),o=Math.max(1,o);var r=e.duration,l=Math.ceil(r*t);e.pause();var h=e.videoWidth,g=e.videoHeight,d=Math.floor(h/2),f=this.yyeva.alphaPosition,u=null;try{u=new OffscreenCanvas(h,g)}catch(e){(u=document.createElement("canvas")).width=h,u.height=g}var c=u.getContext("2d",{willReadFrequently:!0}),m=null;try{m=new OffscreenCanvas(n,o)}catch(e){(m=document.createElement("canvas")).width=n,m.height=o}for(var p=m.getContext("2d",{willReadFrequently:!0}),v=[],y=0;y<l&&!this.toSvgaCancelled;y++){var C=y/t;e.currentTime=C,await new Promise(function(t){if(e.currentTime===C&&e.readyState>=2)t();else{var i=function(){e.removeEventListener("seeked",i),t()};e.addEventListener("seeked",i),setTimeout(function(){e.removeEventListener("seeked",i),t()},2e3)}}),c.drawImage(e,0,0);for(var M="right"===f?0:d,w="right"===f?d:0,F=c.getImageData(M,0,d,g),S=c.getImageData(w,0,d,g),P=0;P<F.data.length;P+=4){var I=S.data[P];I>0&&(F.data[P]=Math.min(255,255*F.data[P]/I),F.data[P+1]=Math.min(255,255*F.data[P+1]/I),F.data[P+2]=Math.min(255,255*F.data[P+2]/I)),F.data[P+3]=I}var T=document.createElement("canvas");T.width=d,T.height=g,T.getContext("2d").putImageData(F,0,0),p.clearRect(0,0,n,o),p.drawImage(T,0,0,d,g,0,0,n,o);var b=await new Promise(function(e){m.toBlob(function(t){e(t)},"image/png")}),x=await b.arrayBuffer();v.push(new Uint8Array(x)),this.toSvgaProgress=Math.round((y+1)/l*50),(y+1)%10==0?await new Promise(function(e){setTimeout(e,16)}):await new Promise(function(e){setTimeout(e,0)})}return{frames:v,scaledWidth:n,scaledHeight:o,displayWidth:i,displayHeight:a,scaleFactor:s}},extractYyevaFramesOptimized:async function(){console.log("[调试] 开始使用FFmpeg优化版提取帧");var e=this,t=this.toSvgaConfig.fps,i=this.toSvgaConfig.width,a=this.toSvgaConfig.height,s=this.toSvgaConfig.quality||100;console.log("[调试] 提取帧参数 - fps:",t,"width:",i,"height:",a,"quality:",s);var n=s/100,o=Math.round(i*n),r=Math.round(a*n);o=Math.max(1,o),r=Math.max(1,r);var l=this.yyeva.alphaPosition;console.log("[调试] Alpha通道位置:",l);var h=null;this.yyevaVideo&&this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2&&(h=this.buildFrameMap(t))&&h.length>0&&console.log("[调试] 启用变速，构建帧映射表，总帧数:",h.length);try{if(console.log("[调试] 开始加载FFmpeg库"),await this.loadLibrary(["ffmpeg"],!0),console.log("[调试] FFmpeg库加载成功"),this.toSvgaCancelled)throw new Error("用户取消转换");var g=this.yyeva.file;if(!g)throw new Error("没有找到视频文件");console.log("[调试] 找到视频文件:",g.name,"大小:",g.size,"字节"),console.log("[调试] 开始使用FFmpeg提取帧");var d=await window.MeeWoo.Services.FFmpegService.extractFrames({videoFile:g,fps:t,width:2*i,height:a,onProgress:function(t){e.toSvgaProgress=Math.round(50*t),console.log("[调试] FFmpeg提取帧进度:",Math.round(100*t),"%")},checkCancelled:function(){return e.toSvgaCancelled}});if(console.log("[调试] FFmpeg提取帧完成，共提取:",d.length,"帧"),this.toSvgaCancelled)throw new Error("用户取消转换");var f=d;if(h&&h.length>0){console.log("[调试] 使用帧映射表处理变速");for(var u=[],c=0;c<h.length&&!this.toSvgaCancelled;c++){var m=h[c],p=Math.min(Math.max(0,Math.round(m*d.length/this.speedRemapConfig.originalTotalFrames)),d.length-1);u.push(d[p])}f=u}var v=[],y=f.length;console.log("[调试] 开始处理提取的帧，分离双通道，总帧数:",y);var C=null;try{C=new OffscreenCanvas(0,0)}catch(e){C=document.createElement("canvas")}var M=C.getContext("2d",{willReadFrequently:!0}),w=null;try{w=new OffscreenCanvas(o,r)}catch(e){(w=document.createElement("canvas")).width=o,w.height=r}var F=w.getContext("2d");for(c=0;c<y&&!this.toSvgaCancelled;c++){var S=new Blob([f[c]],{type:"image/png"}),P=URL.createObjectURL(S),I=await new Promise(function(e,t){var i=new Image;i.onload=function(){e(i)},i.onerror=function(){t(new Error("加载帧失败"))},i.src=P});C.width=I.width,C.height=I.height;var T=Math.floor(I.width/2);M.drawImage(I,0,0);for(var b="right"===l?0:T,x="right"===l?T:0,k=M.getImageData(b,0,T,I.height),E=M.getImageData(x,0,T,I.height),L=0;L<k.data.length;L+=4){var D=E.data[L];D>0&&(k.data[L]=Math.min(255,255*k.data[L]/D),k.data[L+1]=Math.min(255,255*k.data[L+1]/D),k.data[L+2]=Math.min(255,255*k.data[L+2]/D)),k.data[L+3]=D}var R=document.createElement("canvas");R.width=T,R.height=I.height,R.getContext("2d").putImageData(k,0,0),F.clearRect(0,0,o,r),F.drawImage(R,0,0,T,I.height,0,0,o,r);var V=await new Promise(function(e){w.toBlob(function(t){e(t)},"image/png")}),A=await V.arrayBuffer();v.push(new Uint8Array(A)),URL.revokeObjectURL(P),e.toSvgaProgress=Math.round((c+1)/y*50),(c+1)%10==0?await new Promise(function(e){setTimeout(e,16)}):await new Promise(function(e){setTimeout(e,0)})}return{frames:v,scaledWidth:o,scaledHeight:r,displayWidth:i,displayHeight:a,scaleFactor:n}}catch(e){throw console.error("FFmpeg提取帧失败:",e),new Error("FFmpeg加载失败或提取帧失败："+e.message)}},startMP4Conversion:async function(e){var t=this;if(e&&(this.dualChannelConfig=Object.assign({},this.dualChannelConfig,e)),this.svgaPlayer&&this.svga.hasFile&&this.originalVideoItem){if(this.confirmIfHasOngoingTasks("SVGA转双通道","task")){var i=this.dualChannelConfig.width,s=this.dualChannelConfig.height,n=this.dualChannelConfig.quality,o=this.dualChannelConfig.fps;if(i<1||i>9999)alert("宽度超出范围！\n\n合法范围：1-9999 像素\n当前值："+i);else if(s<1||s>9999)alert("高度超出范围！\n\n合法范围：1-9999 像素\n当前值："+s);else if(n<1||n>100)alert("压缩质量超出范围！\n\n合法范围：1-100\n当前值："+n);else if(o<1||o>120)alert("帧率超出范围！\n\n合法范围：1-120 fps\n当前值："+o);else{try{this.configManager&&(this.configManager.set("mp4_quality",this.dualChannelConfig.quality),this.configManager.set("mp4_fps",this.dualChannelConfig.fps))}catch(e){console.error("Failed to save MP4 config:",e)}this.isConvertingToDualChannel=!0,this.dualChannelProgress=0,this.dualChannelCancelled=!1,this.dualChannelStage="loading",this.dualChannelMessage="正在加载转换器...";var r=null;this.taskManager&&(r=this.taskManager.register("SVGA转双通道",function(){t.cancelSvgaToDualChannelConversion()}));try{if(await a.FFmpegService.init(),this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="extracting",this.dualChannelMessage="正在提取序列帧...";var l=await this.extractFrames();if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="composing",this.dualChannelMessage="正在合成双通道...";var h=await this.composeDualChannelFrames(l);if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="encoding",this.dualChannelMessage="正在编码为MP4...";var g=null,d=this.svgaAudioData&&Object.keys(this.svgaAudioData).length>0;if(!this.dualChannelConfig.muted&&d){var f=Object.keys(this.svgaAudioData);g=this.svgaAudioData[f[0]]}var u=this.originalVideoItem,c=u.FPS||u.fps||30,m=await a.FFmpegService.convertFramesToMp4({frames:h,fps:this.dualChannelConfig.fps,inputFps:c,quality:this.dualChannelConfig.quality,audioData:g,onProgress:function(e){t.dualChannelProgress=Math.round(100*e),t.dualChannelMessage=e<.4?"正在写入帧数据... "+Math.round(e/.4*100)+"%":e<.45?"正在处理音频...":e<.95?"正在编码视频... "+Math.round((e-.45)/.5*100)+"%":"正在生成文件..."},checkCancelled:function(){return t.dualChannelCancelled}});if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelStage="done",this.dualChannelMessage="转换完成！",this.dualChannelProgress=100,this.downloadMP4(m),setTimeout(function(){var e="";(e=t.dualChannelConfig.muted?"✅ 转换完成！\n\n已按您的要求生成静音MP4文件。":d?g?"✅ 转换完成！\n\n已成功将SVGA中的音频合成到MP4文件中。\n\n请播放检查音频效果，如有问题请反馈。":"✅ 转换完成！":"✅ 转换完成！\n\nSVGA文件不包含音频，已生成静音MP4文件。")&&alert(e)},500),setTimeout(function(){t.isConvertingToDualChannel||(t.dualChannelProgress=0,t.dualChannelStage="",t.dualChannelMessage="")},1e3)}catch(e){"用户取消转换"!==e.message&&(console.error("MP4转换失败:",e),alert("转换失败："+e.message))}finally{this.taskManager&&r&&this.taskManager.finish(r),this.isConvertingToDualChannel=!1}}}}else alert("请先加载 SVGA 文件")},extractAudioFromMp4:async function(e,t,i,s,n){if((i=parseFloat(i)||30)<=0&&(i=30),n&&Math.abs(n-i)>.1&&(console.warn("帧率变化检测: Source="+n+"fps, Target="+i+"fps"),console.warn("注意：如果变速关键帧是基于Source帧率打点的，直接应用到Target帧率可能会导致时间轴偏移。")),!a.FFmpegService.isLoaded)try{await a.FFmpegService.init()}catch(e){return console.error("FFmpeg初始化失败:",e),null}try{if(this.speedRemapConfig.enabled&&this.speedRemapConfig.keyframes&&this.speedRemapConfig.keyframes.length>=2){var o=this.speedRemapConfig.keyframes,r=(s=this.speedRemapConfig.originalTotalFrames,o.length>2);if(r||2!==o.length||(r=0!==o[0].position||1!==o[1].position),r){var l=s/(this.mp4Video?this.mp4Video.duration:0),h=o[0].position,g=o[o.length-1].position,d=g-h;return d<1e-4&&(d=1),console.log("音频变速预处理: 归一化关键帧范围",h.toFixed(3)+"-"+g.toFixed(3),"Range:",d.toFixed(3)),(o=o.map(function(e){return{frame:e.frame,originalFrame:e.originalFrame,position:(e.position-h)/d,speed:e.speed}})).length>0&&(o[0].position=0,o[o.length-1].position=1),await a.FFmpegService.extractAudioWithSpeedRemap({videoFile:e,keyframes:o,totalFrames:t,fps:i,originalTotalFrames:s,originalFps:l})}if((u=this.mp4Video?this.mp4Video.duration:0)>0&&i>0){var f=u/(t/i);return await a.FFmpegService.extractAudio({videoFile:e,totalFrames:t,fps:i,speedRatio:f})}}var u;f=1;if(s&&n&&n!==i)f=(u=s/n)/(t/i);return await a.FFmpegService.extractAudio({videoFile:e,totalFrames:t,fps:i,speedRatio:f})}catch(e){return console.error("音频提取失败:",e),null}},extractFrames:async function(){var e=this.originalVideoItem;if(!e)throw new Error("请先加载SVGA文件");var t=e.frames,i=e.videoSize.width,a=e.videoSize.height,s=e.FPS||24,n=this.dualChannelConfig.width||i,o=this.dualChannelConfig.height||a,r=[],l=this.isPlaying;l&&this.svgaPlayer.pauseAnimation();var h=this.svgaPlayer.$canvas||this.$refs.svgaContainer.querySelector("canvas");if(!h)throw new Error("无法获取播放器Canvas");var g=Math.max(16,Math.ceil(1e3/s*1.5)),d=document.createElement("canvas");d.width=n,d.height=o;var f=d.getContext("2d",{alpha:!0,willReadFrequently:!0});f.imageSmoothingEnabled=!1;try{for(var u=0;u<t;u++){if(this.dualChannelCancelled)throw new Error("用户取消转换");this.dualChannelProgress=Math.round((u+1)/t*100),this.dualChannelMessage="提取序列帧 "+(u+1)+"/"+t,this.svgaPlayer.stepToFrame(u,!1),h.requestPaint&&h.requestPaint(),await new Promise(function(e){requestAnimationFrame(function(){setTimeout(e,g)})}),f.clearRect(0,0,n,o),f.drawImage(h,0,0,h.width,h.height,0,0,n,o);var c=f.getImageData(0,0,n,o);r.push(c),u%5==0&&await new Promise(function(e){setTimeout(e,0)})}}finally{l&&this.svgaPlayer&&"svga"===this.currentModule&&this.svgaPlayer.startAnimation()}return r},composeDualChannelFrames:async function(e){var t=this,i="color-left-alpha-right";return this.dualChannelConfig&&(i=this.dualChannelConfig.channelMode),this.dualChannelConfig&&(i=this.dualChannelConfig.channelMode),this.dualChannelConfig&&(i=this.dualChannelConfig.channelMode),(this.isConvertingToDualChannel&&"svga"===this.currentModule||this.isConvertingToDualChannel&&"mp4"===this.currentModule||this.isConvertingToDualChannel&&"lottie"===this.currentModule)&&(i=this.dualChannelConfig.channelMode),a.DualChannelComposer.composeToJPEG(e,{mode:i,onProgress:function(i){t.dualChannelProgress=Math.round(100*i),t.dualChannelMessage="合成双通道帧 "+Math.round(i*e.length)+"/"+e.length},onCancel:function(){return t.dualChannelCancelled}})},downloadMP4:function(e){var t=this.svga.fileInfo.name||"svga";t=(t=t.replace(/\.svga$/i,""))+("color-left-alpha-right"===(this.dualChannelConfig?this.dualChannelConfig.channelMode:"color-left-alpha-right")?"_yyeva_LR":"_yyeva_RL")+".mp4";var i=URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)},buildSVGAFromConfig:async function(e,t,i){var s=this,n=i.progressField,o=i.messageField,r=i.cancelledField;this[o]="生成SVGA...";var l,h=t.onProgress;if(t.onProgress=function(e){s[n]=Math.round(50+50*e),h&&h(e)},l="fromPNG"===t.buildType?await a.SvgaBuilder.buildFromPNG(t):await a.SvgaBuilder.build(t),this[r])throw new Error("用户取消转换");return this[n]=100,this[o]="转换完成！",l},downloadSVGA:function(e,t){this.utils.downloadFile(e,t)},cancelSvgaToDualChannelConversion:function(){this.dualChannelCancelled=!0,this.dualChannelMessage="正在取消..."}},computed:{isGlobalTaskRunning:function(){return this.taskManager&&this.taskManager.hasRunningTasks()},hasReplacedMaterials:function(){return Object.keys(this.replacedImages).length>0},isEmpty:function(){return!(this.svga.hasFile||this.yyeva.hasFile||this.mp4.hasFile||this.lottie.hasFile||this.frames.hasFile)},currentFileInfo:function(){return"svga"===this.currentModule&&this.svga.hasFile?this.svga.fileInfo:"yyeva"===this.currentModule&&this.yyeva.hasFile?this.yyeva.fileInfo:"mp4"===this.currentModule&&this.mp4.hasFile?this.mp4.fileInfo:"lottie"===this.currentModule&&this.lottie.hasFile?this.lottie.fileInfo:"frames"===this.currentModule&&this.frames.hasFile?this.frames.fileInfo:{}},currentBgColor:function(){return"white"===this.bgColorKey?"#ffffff":"green"===this.bgColorKey?"#00ff00":"red"===this.bgColorKey?"#df3321":"yellow"===this.bgColorKey?"#f1c40d":"blue"===this.bgColorKey?"#00b4ff":"pattern"===this.bgColorKey?"transparent":"#000000"},hasAudio:function(){if("svga"===this.currentModule){var e=this.originalVideoItem&&this.originalVideoItem.audios&&this.originalVideoItem.audios.length>0||this.svgaMovieData&&this.svgaMovieData.audios&&this.svgaMovieData.audios.length>0,t=this.svgaAudioData&&Object.keys(this.svgaAudioData).length>0;return e&&t}return"yyeva"===this.currentModule?this.yyevaHasAudio:"mp4"===this.currentModule?this.mp4HasAudio:(this.currentModule,!1)},materialThumbBgColor:function(){return this.bgColorKey&&"pattern"!==this.bgColorKey?this.currentBgColor:this.isDarkMode?"#2a2a2a":"#fcfcfc"},speedRemapSegments:function(){var e=this.speedRemapConfig.keyframes;if(!e||e.length<2)return[];for(var t=this.speedRemapConfig.originalTotalFrames||1,i=[],a=0;a<e.length-1;a++){var s=e[a],n=e[a+1],o=n.originalFrame-s.originalFrame,r=n.position-s.position,l=1;r>0&&o>0&&(l=o/(r*t));var h=0;l>1?h=Math.min(1,.2*(l-1)):l<1&&(h=Math.min(1,2*(1-l))),i.push({startPos:s.position,endPos:n.position,speed:l,opacity:h})}return i},yyevaToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0,i=this.toSvgaConfig.fps||30,a=this.toSvgaConfig.quality||80,s=this.toSvgaConfig.muted,n=a/100,o=Math.round(e*n),r=Math.round(t*n),l=0;this.yyevaVideo&&(l=this.yyevaVideo.duration||0);var h=Math.ceil(l*i),g=0;this.yyeva.fileInfo&&this.yyeva.fileInfo.size&&(g=(4*this.yyeva.fileInfo.size/1024/1024).toFixed(1));var d=(o*r*h*4/1024/1024).toFixed(1),f="0kb";this.yyeva.fileInfo&&this.yyeva.fileInfo.size&&(f=this.utils.formatBytes(this.yyeva.fileInfo.size));var u=o*r*.5*h*.7;!s&&this.yyevaHasAudio&&(u+=16*l*1024/8);return{frames:h,duration:l,beforeMemory:g+"M",afterMemory:d+"M",beforeFileSize:f,afterFileSize:h>0?this.utils.formatBytes(u):"？"}},mp4ToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0,i=this.toSvgaConfig.fps||30,a=(this.toSvgaConfig.quality||80)/100,s=Math.round(e*a),n=Math.round(t*a),o=0;this.mp4Video&&(o=this.mp4Video.duration||0);var r=Math.ceil(o*i),l=(s*n*r*4/1024/1024).toFixed(1),h="0kb";this.mp4.fileInfo&&this.mp4.fileInfo.size&&(h=this.utils.formatBytes(this.mp4.fileInfo.size));var g=s*n*.5*r*.7;return{frames:r,duration:o,afterMemory:l+"M",beforeFileSize:h,afterFileSize:r>0?this.utils.formatBytes(g):"？"}},lottieToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0,i=this.toSvgaConfig.fps||30,a=(this.toSvgaConfig.quality||80)/100,s=Math.round(e*a),n=Math.round(t*a),o=0;this.lottie&&this.lottie.fileInfo&&this.lottie.fileInfo.duration&&(o=this.lottie.fileInfo.duration);var r=Math.ceil(o*i),l=(s*n*r*4/1024/1024).toFixed(1),h=s*n*.5*r*.7,g="？";return r>0&&(g=this.utils.formatBytes(h)),{frames:r,duration:o,afterMemory:l+"M",afterFileSize:g}},imagesToSvgaEstimate:function(){var e=this.toSvgaConfig.width||0,t=this.toSvgaConfig.height||0,i=(this.toSvgaConfig.fps,(this.toSvgaConfig.quality||80)/100),a=Math.round(e*i),s=Math.round(t*i),n=this.frames.files?this.frames.files.length:0,o=(a*s*n*4/1024/1024).toFixed(1),r=a*s*.5*n*.7,l="？";return n>0&&(l=this.utils.formatBytes(r)),{frames:n,afterMemory:o+"M",afterFileSize:l}},gifSourceInfo:function(){return this.getGifSourceInfo()},gifEstimate:function(){var e=this.gifConfig,t=this.getGifSourceInfo(),i=e.width||t.width||100,a=e.height||t.height||100,s=e.fps||30,n=t.duration||0,o=Math.ceil(n*s),r=e.transparent?.16:.13;e.transparent&&e.dither&&(r=.18);var l=i*a*r*o,h="？";return o>0&&(h=this.utils.formatBytes(l)),{frames:o,duration:n,fileSize:h,fileSizeBytes:l}},timeScaleTicks:function(){var e=this.speedRemapConfig.originalDuration||0,t=[];if(e<=0)return t;for(var i=e/10,a=[.5,1,2,5,10,20,30,60,120,300,600],s=.5,n=0;n<a.length;n++)if(a[n]>=i){s=a[n];break}i>a[a.length-1]&&(s=a[a.length-1]);for(var o=0;o<=e;o+=s){var r=o/e*500,l="";if(s<1)l=o.toFixed(1)+"s",o%1==0&&(l=Math.round(o)+"s");else if(s<60)l=Math.round(o)+"s";else{var h=Math.floor(o/60),g=Math.round(o%60);l=0===g?h+"m":h+"m"+g+"s"}t.push({time:o,position:r,label:l})}return t},speedRemapEstimate:function(){var e=this.speedRemapConfig,t=e.originalDuration||0,i=e.keyframes;if(!i||i.length<2)return{outputDuration:t.toFixed(2),outputTotalFrames:e.originalTotalFrames||0,durationChange:0,durationChangePercent:"0%"};var a=i[0].position,s=i[i.length-1].position-a,n=s*t,o=Math.ceil(s*(e.originalTotalFrames||0)),r=n-t,l=t>0?Math.round(r/t*100):0;return{outputDuration:n.toFixed(2),outputTotalFrames:o,durationChange:r.toFixed(2),durationChangePercent:(l>=0?"+":"")+l+"%"}},viewerContainerStyle:function(){var e={transform:"translate("+this.viewerOffsetX+"px, "+this.viewerOffsetY+"px) scale("+this.viewerScale+")",cursor:this.dragging?"grabbing":"grab"},t=this.getContentOriginalSize();return t&&(e.width=t.width+"px",e.height=t.height+"px"),e},viewerFilenameStyle:function(){var e=this.viewerScale,t={transform:"scale("+1/e+")",transformOrigin:"left bottom",marginBottom:8*e+"px"},i=this.getContentOriginalSize();return i&&(t.maxWidth=i.width*e+"px"),t}},created:function(){this.libraryLoader=t.libraryLoader,this.resourceManager=t.resourceManager,this.playerController=null,this.fileValidator=new a.FileValidator(this.libraryLoader),this.utils=e.Utils,t.ConfigManager&&(this.configManager=new t.ConfigManager,this.loadUserConfig()),this.initTheme(),this.setupThemeListener(),this.modeStrategies={svga:{cleanup:this.cleanupSvga},yyeva:{cleanup:this.cleanupYyeva},mp4:{cleanup:this.cleanupMp4},lottie:{cleanup:this.cleanupLottie},frames:{cleanup:this.cleanupFrames}};var i=new URLSearchParams(window.location.search),s=i.get("src")||i.get("file");if(s){var n=this;if(0!==s.indexOf("http")){var o=document.createElement("a");o.href=s,s=o.href}fetch(s).then(function(e){return e.blob()}).then(function(e){var t=new File([e],s.split("/").pop(),{type:e.type});n.handleFile(t)}).catch(function(e){console.error("加载URL文件失败:",e)})}this.taskManager=t.taskManager,this.svgaPlayer=null,this.svgaParser=null,this.svgaObjectUrl=null,this.svgaAudioData=null,this.svgaMovieData=null,this.emptyStateSvgaPlayer=null,this.emptyStateSvgaParser=null,this.yyevaVideo=null,this.yyevaCanvas=null,this.yyevaCtx=null,this.yyevaAnimationId=null,this.yyevaObjectUrl=null,this.yyevaTempCanvas=null,this.yyevaTempCtx=null,this.lottiePlayer=null,this.lottieCanvas=null,this.lottieCtx=null,this.lottieAnimationId=null,this.mp4Video=null,this.mp4ObjectUrl=null,this.chromaKeyRenderLoop=null,this.framesCanvas=null,this.framesCtx=null,this.framesAnimationId=null,this.framesImages=[],this.framesBlobUrls=[],this.originalVideoItem=null},watch:{bgColorKey:function(e){var t=this;this.saveUserConfig("bgColorKey",e),this.$nextTick(function(){t.applyCanvasBackground()})},currentModule:function(e){this.saveUserConfig("lastMode",e)},gifConfig:{handler:function(e){var t={fps:e.fps,quality:e.quality,transparent:e.transparent,dither:e.dither,width:e.width,height:e.height};this.saveUserConfig("gifConfig",t)},deep:!0},footerContentVisible:function(e){e&&!this.playerController&&this.initPlayerController()},chromaKeyEnabled:function(){this.updateChromaKeyEffect()},chromaKeySimilarity:function(){this.chromaKeyEnabled&&this.updateChromaKeyEffect()},chromaKeySmoothness:function(){this.chromaKeyEnabled&&this.updateChromaKeyEffect()}},mounted:function(){var e=this;this.showEditFrameDialog=!1,this.editingKeyframeIndex=-1,this.editFrameInput="",this.showFramesFpsDialog=!1,this.showMoreDrawer=!1,this.initSvgaPlayer(),this.initViewportController();var a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;(this.isDarkMode=a,a&&document.body.classList.add("dark-mode"),window.matchMedia)&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(t){if(!e.isThemeManuallySet){var i=t.matches;e.isDarkMode=i,i?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")}});document.addEventListener("click",function(t){if(e.showChannelModeDropdown){var i=e.$refs.mp4SelectWrapper;i&&!i.contains(t.target)&&(e.showChannelModeDropdown=!1)}}),window.MeeWoo_GlobalInputController&&(window.MeeWoo_GlobalInputController.destroy&&window.MeeWoo_GlobalInputController.destroy(),window.MeeWoo_GlobalInputController=null),this.inputController&&(this.inputController.destroy&&this.inputController.destroy(),this.inputController=null);var s=new i.InputController({container:document.body,onHoverChange:function(t){e.dropHover=t},onDrop:function(t){e.handleFiles(t,!1)}});this.inputController=s,window.MeeWoo_GlobalInputController=s,this.loadHelpContent(),window.authUtils&&(this.handleLoginCallback(),this.updateLoginStatus()),t.libraryLoader?t.libraryLoader.onProgress(function(t){e.loadingLibraryInfo=t?{name:t.name,progress:t.progress}:null}):console.warn("libraryLoader not found"),document.addEventListener("keydown",function(t){var i=document.activeElement;if(!(i&&("INPUT"===i.tagName||"TEXTAREA"===i.tagName||i.isContentEditable))&&!e.isEmpty)if(32===t.keyCode||" "===t.key)t.preventDefault(),e.togglePlay();else if(("ArrowLeft"===t.key||"ArrowRight"===t.key)&&(t.preventDefault(),e.playerController)){var a="ArrowLeft"===t.key?-1:1;e.playerController.step(a)}}),this.preloadLibraries()},beforeDestroy:function(){this.inputController&&(this.inputController.destroy(),this.inputController=null)}})}!function(){var e=setInterval(function(){var t;"undefined"!=typeof Vue&&"undefined"!=typeof SVGA&&(clearInterval(e),(t=document.getElementById("loading-skeleton"))&&(t.style.display="none"),initApp())},100)}();