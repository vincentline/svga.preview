!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={exportFormats:{PNG:"png",JPG:"jpg",JPEG:"jpeg",SVG:"svg",CANVAS:"canvas"},initExportManager:function(e,t){var a={defaultFormat:this.exportFormats.PNG,defaultQuality:1,defaultScale:1};return{stageInstance:e,config:Object.assign({},a,t)}},exportStage:function(e,t){var a,r={format:e.config.defaultFormat,quality:e.config.defaultQuality,scale:e.config.defaultScale,layers:null,area:null,download:!1,filename:"export"},o=Object.assign({},r,t);switch(o.format.toLowerCase()){case this.exportFormats.PNG:a=this.exportToPNG;break;case this.exportFormats.JPG:case this.exportFormats.JPEG:a=this.exportToJPG;break;case this.exportFormats.SVG:a=this.exportToSVG;break;case this.exportFormats.CANVAS:a=this.exportToCanvas;break;default:return Promise.reject(new Error("Unsupported export format: "+o.format))}return this.triggerExportEvent(e,"start",o),a.call(this,e,o).then(function(t){return this.triggerExportEvent(e,"success",o,t),o.download&&this.downloadExport(t,o),t}.bind(this)).catch(function(t){throw this.triggerExportEvent(e,"error",o,t),t}.bind(this))},exportToPNG:function(e,t){return new Promise(function(a,r){try{var o,i=e.stageInstance.stage;if(t.layers){Array.isArray(t.layers)||(t.layers=[t.layers]);var n=new Konva.Stage({width:i.width(),height:i.height()});t.layers.forEach(function(t){var a=e.stageInstance.layers[t];a&&n.add(a.clone())}),o=n.toDataURL({pixelRatio:t.scale,mimeType:"image/png",quality:t.quality}),n.destroy()}else o=i.toDataURL({pixelRatio:t.scale,mimeType:"image/png",quality:t.quality,x:t.area?t.area.x:0,y:t.area?t.area.y:0,width:t.area?t.area.width:i.width(),height:t.area?t.area.height:i.height()});a(o)}catch(e){r(e)}})},exportToJPG:function(e,t){return new Promise(function(a,r){try{var o,i=e.stageInstance.stage;if(t.layers){Array.isArray(t.layers)||(t.layers=[t.layers]);var n=new Konva.Stage({width:i.width(),height:i.height()});t.layers.forEach(function(t){var a=e.stageInstance.layers[t];a&&n.add(a.clone())}),o=n.toDataURL({pixelRatio:t.scale,mimeType:"image/jpeg",quality:t.quality}),n.destroy()}else o=i.toDataURL({pixelRatio:t.scale,mimeType:"image/jpeg",quality:t.quality,x:t.area?t.area.x:0,y:t.area?t.area.y:0,width:t.area?t.area.width:i.width(),height:t.area?t.area.height:i.height()});a(o)}catch(e){r(e)}})},exportToSVG:function(e,t){return new Promise(function(a,r){try{var o=e.stageInstance.stage;a(o.toSVG({x:t.area?t.area.x:0,y:t.area?t.area.y:0,width:t.area?t.area.width:o.width(),height:t.area?t.area.height:o.height()}))}catch(e){r(e)}})},exportToCanvas:function(e,t){return new Promise(function(a,r){try{var o,i=e.stageInstance.stage;if(t.layers){Array.isArray(t.layers)||(t.layers=[t.layers]);var n=new Konva.Stage({width:i.width(),height:i.height()});t.layers.forEach(function(t){var a=e.stageInstance.layers[t];a&&n.add(a.clone())}),o=n.toCanvas({pixelRatio:t.scale}),n.destroy()}else o=i.toCanvas({pixelRatio:t.scale,x:t.area?t.area.x:0,y:t.area?t.area.y:0,width:t.area?t.area.width:i.width(),height:t.area?t.area.height:i.height()});a(o)}catch(e){r(e)}})},downloadExport:function(e,t){var a=t.filename||"export",r=t.format||this.exportFormats.PNG,o=e;if(e instanceof HTMLCanvasElement){var i=this.getMimeType(r);o=e.toDataURL(i,t.quality)}var n=document.createElement("a");n.download=a+"."+r,n.href=o,n.style.display="none",document.body.appendChild(n),n.click(),setTimeout(function(){document.body.removeChild(n)},100)},getMimeType:function(e){switch(e.toLowerCase()){case this.exportFormats.PNG:return"image/png";case this.exportFormats.JPG:case this.exportFormats.JPEG:return"image/jpeg";case this.exportFormats.SVG:return"image/svg+xml";default:return"image/png"}},triggerExportEvent:function(e,t,a,r){e.stageInstance.stage.fire("export:"+t,{exportState:e,exportOptions:a,data:r})},batchExport:function(e,t){if(!Array.isArray(t))return Promise.reject(new Error("exportTasks must be an array"));var a=t.map(function(t){return this.exportStage(e,t)},this);return Promise.all(a)},getExportConfig:function(e){return e.config},updateExportConfig:function(e,t){Object.assign(e.config,t)}};e.MeeWoo.Core.KonvaExport=t}(window);