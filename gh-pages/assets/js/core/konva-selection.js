!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={initSelectionManager:function(e,t){if("undefined"==typeof Konva)throw new Error("Konva library not loaded");var n={selectedElements:[],isDragging:!1,isBoxSelecting:!1,startPoint:null,selectionBox:null,stageInstance:e,config:Object.assign({},{selectable:!0,draggable:!0,multiselect:!0,boxSelect:!0,shiftMultiselect:!0,ctrlMultiselect:!0,selectionStroke:"#0099ff",selectionStrokeWidth:1,selectionDash:[5,5],selectionFill:"rgba(0, 153, 255, 0.1)",hitStrokeWidth:10},t)};return this.initSelectionBox(n),this.initSelectionEvents(n),n},initSelectionBox:function(e){var t=new Konva.Rect({name:"selection-box",stroke:e.config.selectionStroke,strokeWidth:e.config.selectionStrokeWidth,dash:e.config.selectionDash,fill:e.config.selectionFill,visible:!1});e.stageInstance.layers.helperLayer&&e.stageInstance.layers.helperLayer.add(t),e.selectionBox=t},initSelectionEvents:function(e){var t=e.stageInstance.stage,n=e.stageInstance.layers.editLayer;t.on("mousedown",this.handleMouseDown.bind(this,e)),t.on("mousemove",this.handleMouseMove.bind(this,e)),t.on("mouseup",this.handleMouseUp.bind(this,e)),t.on("mouseleave",this.handleMouseLeave.bind(this,e)),n.on("click tap",".element-*",this.handleElementClick.bind(this,e))},handleMouseDown:function(e,t){t.target===e.stageInstance.stage&&(e.isBoxSelecting=!0,e.startPoint={x:t.evt.clientX,y:t.evt.clientY},e.selectionBox.visible(!0),e.selectionBox.width(0),e.selectionBox.height(0),e.selectionBox.x(t.evt.layerX),e.selectionBox.y(t.evt.layerY),e.selectionBox.getLayer().draw())},handleMouseMove:function(e,t){if(e.isBoxSelecting&&e.startPoint){var n={x:t.evt.clientX,y:t.evt.clientY},i=Math.min(e.startPoint.x,n.x),l=Math.min(e.startPoint.y,n.y),s=Math.abs(n.x-e.startPoint.x),o=Math.abs(n.y-e.startPoint.y),c=e.stageInstance.stage,a=(c.getPointerPosition(),c.container().getBoundingClientRect());i-=a.left,l-=a.top,e.selectionBox.x(i),e.selectionBox.y(l),e.selectionBox.width(s),e.selectionBox.height(o),e.selectionBox.getLayer().draw()}},handleMouseUp:function(e,t){e.isBoxSelecting&&this.finishBoxSelection(e)},handleMouseLeave:function(e){e.isBoxSelecting&&this.finishBoxSelection(e)},finishBoxSelection:function(e){e.selectionBox.visible(!1),e.selectionBox.getLayer().draw();var t=e.selectionBox,n={x:t.x(),y:t.y(),width:t.width(),height:t.height()};if(n.width<5||n.height<5)return e.isBoxSelecting=!1,void(e.startPoint=null);var i=e.stageInstance.layers.editLayer.find(".element-*"),l=[];i.forEach(function(e){var t=e.getClientRect();this.isRectIntersect(t,n)&&l.push(e)},this),l.length>0&&this.setSelectedElements(e,l),e.isBoxSelecting=!1,e.startPoint=null},handleElementClick:function(e,t){var n=t.target,i=t.evt,l=!1;(e.config.shiftMultiselect&&i.shiftKey||e.config.ctrlMultiselect&&(i.ctrlKey||i.metaKey))&&(l=!0),l?this.toggleElementSelection(e,n):this.setSelectedElement(e,n)},setSelectedElement:function(e,t){this.clearSelection(e),e.selectedElements.push(t),this.updateElementSelectionState(t,!0),this.triggerSelectionEvent(e,"select",t)},setSelectedElements:function(e,t){this.clearSelection(e),e.selectedElements=t,t.forEach(function(e){this.updateElementSelectionState(e,!0)},this),this.triggerSelectionEvent(e,"select",t)},toggleElementSelection:function(e,t){var n=e.selectedElements.indexOf(t);n>-1?(e.selectedElements.splice(n,1),this.updateElementSelectionState(t,!1),this.triggerSelectionEvent(e,"deselect",t)):(e.selectedElements.push(t),this.updateElementSelectionState(t,!0),this.triggerSelectionEvent(e,"select",t))},clearSelection:function(e){e.selectedElements.forEach(function(e){this.updateElementSelectionState(e,!1)},this),e.selectedElements.length>0&&this.triggerSelectionEvent(e,"deselectAll",e.selectedElements),e.selectedElements=[]},updateElementSelectionState:function(e,t){e&&e instanceof Konva.Node&&(t?e.setAttr("selected",!0):e.setAttr("selected",!1),e.getLayer().draw())},triggerSelectionEvent:function(e,t,n){e.stageInstance.stage.fire("selection:"+t,{selectionState:e,data:n})},isRectIntersect:function(e,t){return!(e.x>t.x+t.width||e.x+e.width<t.x||e.y>t.y+t.height||e.y+e.height<t.y)},getSelectedElements:function(e){return e.selectedElements},getFirstSelectedElement:function(e){return e.selectedElements[0]||null},isElementSelected:function(e,t){return e.selectedElements.indexOf(t)>-1},getSelectedCount:function(e){return e.selectedElements.length},destroySelectionManager:function(e){this.clearSelection(e),e.selectionBox&&(e.selectionBox.destroy(),e.selectionBox=null)}};e.MeeWoo.Core.KonvaSelection=t}(window);