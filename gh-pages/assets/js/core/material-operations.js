!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={filterTextStyle:function(e){if(!e)return{};for(var t={},i=(e=e.replace(/\/\*[\s\S]*?\*\//g,"")).split(";"),o=["position","top","bottom","left","right","width","height","min-width","min-height","max-width","max-height","flex","flex-grow","flex-shrink","flex-basis","flex-direction","flex-wrap","flex-flow","justify-content","justify-items","justify-self","align-content","align-items","align-self","place-content","place-items","place-self","order","gap","margin","margin-top","margin-right","margin-bottom","margin-left","z-index","transform","transform-origin","float","clear","white-space","overflow","overflow-x","overflow-y","line-height","text-decoration","text-decoration-line","text-decoration-style","text-decoration-color","text-decoration-thickness"],r=0;r<i.length;r++){var a=i[r].trim();if(a){var n=a.indexOf(":");if(-1!==n){var l=a.substring(0,n).trim().toLowerCase(),s=a.substring(n+1).trim();l&&s&&-1===o.indexOf(l)&&(t[l]=s)}}}var d="text"===t["-webkit-background-clip"]||"text"===t["background-clip"],c="transparent"===t.color||"transparent"===t["-webkit-text-fill-color"]||"transparent"===t["text-fill-color"],f=-1!==(t.background||t["background-image"]||"").indexOf("gradient");return d&&!c&&f&&(t.color="transparent",t["-webkit-text-fill-color"]||(t["-webkit-text-fill-color"]="transparent")),t},convertStylesToCssString:function(e){var t="";for(var i in e)e.hasOwnProperty(i)&&(t+=i+":"+e[i]+";");return t},renderEditorPreview:function(e){var t=this;e.editor.show&&e.editor.showText&&e.$nextTick(function(){var i=e.$refs.editorTextCanvas;if(i){var o=i.getContext("2d",{willReadFrequently:!0}),r=e.editor.baseImageWidth,a=e.editor.baseImageHeight;o.clearRect(0,0,r,a);var n=r*e.editor.textPosX/100,l=a*e.editor.textPosY/100;o.save(),o.translate(n,l),o.scale(e.editor.textScale,e.editor.textScale),t.drawRichText(e,o,r,a),o.restore()}})},parseStroke:function(e){if(!e)return null;var t=e.match(/(-?[\d.]+(?:px|em)?)\s+(#[0-9a-fA-F]+|rgba?\([^)]+\)|transparent)/i);return t?{width:parseFloat(t[1]),color:t[2]}:null},drawRichText:function(e,t,i,o){var r=e.editorTextStyleFiltered,a=e.editor.textContent;if(a){var n=parseFloat(r["font-size"])||24,l=r["font-family"]||"sans-serif",s=r["font-weight"]||"normal",d=r["font-style"]||"normal";l=l.replace(/['"]/g,""),t.save(),t.font=d+" "+s+" "+n+'px "'+l+'"',t.textAlign=e.editor.textAlign,t.textBaseline="middle";var c=r.color||"#000000",f=r.background||r["background-image"],g="text"===r["-webkit-background-clip"]||"text"===r["background-clip"],h=a.split("\n"),m=1.2*n,u=h.length*m;if(f&&-1!==f.indexOf("gradient")&&g){for(var p,x=f.match(/linear-gradient\((\d+)deg/),v=x?parseInt(x[1]):180,w=[],b=/(#[0-9a-fA-F]+|rgba?\([^)]+\))\s*(\d+(?:\.\d+)?%?)/g;null!==(p=b.exec(f));){var y=p[2];y=(y.indexOf("%"),parseFloat(y)/100),w.push({color:p[1],stop:y})}if(w.length>=2){var S,C,T,M;if((null===w[0].stop||isNaN(w[0].stop))&&(w[0].stop=0),(null===w[w.length-1].stop||isNaN(w[w.length-1].stop))&&(w[w.length-1].stop=1),0===v)S=0,C=u/2,T=0,M=-u/2;else if(90===v){for(var k=0,O=0;O<h.length;O++){(I=t.measureText(h[O]).width)>k&&(k=I)}S=-k/2,C=0,T=k/2,M=0}else if(270===v){for(k=0,O=0;O<h.length;O++){var I;(I=t.measureText(h[O]).width)>k&&(k=I)}S=k/2,C=0,T=-k/2,M=0}else S=0,C=-u/2,T=0,M=u/2;for(var E=t.createLinearGradient(S,C,T,M),L=0;L<w.length;L++){var P=Math.max(0,Math.min(1,w[L].stop));E.addColorStop(P,w[L].color)}c=E}}var W=-u/2+m/2;if(r["text-shadow"]){var X=r["text-shadow"].replace(/rgba?\([^)]+\)/gi,function(e){return e.replace(/,/g,"|")}).split(",").map(function(e){return e.replace(/\|/g,",").trim()});for(O=0;O<X.length;O++){var Y=X[O].match(/(-?[\d.]+(?:px)?|0)\s+(-?[\d.]+(?:px)?|0)(?:\s+(-?[\d.]+(?:px)?|0))?\s+(#[0-9a-fA-F]+|rgba?\([^)]+\))/i);if(Y){t.save(),t.shadowOffsetX=parseFloat(Y[1]),t.shadowOffsetY=parseFloat(Y[2]),t.shadowBlur=Y[3]?parseFloat(Y[3]):0,t.shadowColor=Y[4],t.fillStyle=c;for(var A=0;A<h.length;A++){var R=W+A*m;t.fillText(h[A],0,R)}t.restore()}}t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0}var U=r["-webkit-text-stroke"]||r.border;if(U){var F=this.parseStroke(U);if(F){t.lineWidth=F.width,t.strokeStyle="transparent"===F.color&&c instanceof CanvasGradient?c:F.color,t.lineJoin="round";for(A=0;A<h.length;A++){R=W+A*m;t.strokeText(h[A],0,R)}}}t.fillStyle=c;for(A=0;A<h.length;A++){R=W+A*m;t.fillText(h[A],0,R)}t.restore()}},generateEditedMaterial:function(e){return new Promise(function(t,i){if("undefined"!=typeof html2canvas){var o=e.$refs.editorPreviewContent;if(!o)return void i(new Error("Editor preview container not found"));var r=o.querySelector(".editor-controls"),a=null;r&&(a=r,r.parentNode.removeChild(r)),html2canvas(o,{backgroundColor:null,scale:1,logging:!1,timeout:1e4,useCORS:!0,allowTaint:!0,ignoreElements:function(e){return e.classList&&(e.classList.contains("editor-controls")||e.classList.contains("editor-toolbar")||e.classList.contains("editor-buttons")||e.classList.contains("editor-layer-tag"))},cacheBust:!1,imageTimeout:3e3,removeContainer:!1,skipFonts:!1,useWebGL:!1,onclone:function(e){var t=e.querySelector(".editor-preview-content");if(t){var i=t.cloneNode(!0);t.parentNode.replaceChild(i,t)}},width:o.clientWidth,height:o.clientHeight}).then(function(e){a&&o.appendChild(a);var i=e.toDataURL("image/png",1);t(i)}).catch(function(e){a&&o.appendChild(a),i(e)})}else i(new Error("html2canvas is not loaded"))})},setTextAlign:function(e,t){e.editor.textAlign=t,this.renderEditorPreview(e)},restoreOriginalMaterial:function(t,i){var o,r;if(void 0!==i?"number"==typeof i?(r=t.materialList[i])&&(o=r.imageKey):(o=i,r=t.materialList.find(function(e){return e.imageKey===o})):(o=t.editor.targetKey)&&(r=t.materialList.find(function(e){return e.imageKey===o})),o&&r){if(e.MeeWoo.Core.MaterialState.clearMaterialEditState(t.materialEditStates,o),r.originalUrl?r.previewUrl=r.originalUrl:r.originalData&&(r.previewUrl=r.originalData.startsWith("data:")?r.originalData:"data:image/png;base64,"+r.originalData),r.isReplaced=!1,t.replacedImages){var a=Object.assign({},t.replacedImages);delete a[o],t.replacedImages=a}t.editor&&t.editor.targetKey===o&&(t.editor.showImage=!0,t.editor.showText=!1,t.editor.textContent="示例文案",t.editor.textStyle="color: white;\ntext-shadow: 1px 1px 2px #000000;\nfont-size: 24px;\nfont-weight: bold;",t.editor.textPosX=50,t.editor.textPosY=50,t.editor.textScale=1,t.editor.textAlign="left",t.editor.imageOffsetX=0,t.editor.imageOffsetY=0,t.editor.imageScale=1,t.editor.showRestoreBtn=!1,t.editor.scale=1,t.editor.offsetX=0,t.editor.offsetY=0,t.editor.viewMode="fit-height",t.editor.baseImage=r.originalUrl||r.previewUrl,this.renderEditorPreview(t)),t.applyReplacedMaterials&&t.applyReplacedMaterials(),t.showToast&&t.showToast("已恢复原图")}},openMaterialEditor:function(t,i){var o=i;if("number"==typeof i&&(o=t.materialList[i]),o){t.loadLibrary&&t.loadLibrary("html2canvas",!0).catch(function(e){}),t.editor.targetKey=o.imageKey,t.editor.show=!0,e.MeeWoo&&e.MeeWoo.Controllers&&e.MeeWoo.Controllers.UserTypeController&&setTimeout(()=>{e.MeeWoo.Controllers.UserTypeController.refresh()},0),t.editor.loading=!1,t.editor.viewMode="fit-height",t.editor.scale=1,t.editor.offsetX=0,t.editor.offsetY=0;var r,a=t.materialEditStates[o.imageKey];a?(t.editor.showImage=a.showImage,t.editor.showText=a.showText,t.editor.textContent=a.textContent||"",t.editor.textStyle=a.textStyle||"",t.editor.textPosX=void 0!==a.textPosX?a.textPosX:50,t.editor.textPosY=void 0!==a.textPosY?a.textPosY:50,t.editor.textScale=void 0!==a.textScale?a.textScale:1,t.editor.textAlign=void 0!==a.textAlign?a.textAlign:"left",t.editor.imageOffsetX=void 0!==a.imageOffsetX?a.imageOffsetX:0,t.editor.imageOffsetY=void 0!==a.imageOffsetY?a.imageOffsetY:0,t.editor.imageScale=void 0!==a.imageScale?a.imageScale:1):(t.editor.showImage=!0,t.editor.showText=!1,t.editor.textContent="示例文案",t.editor.textStyle="color: white;\ntext-shadow: 1px 1px 2px #000000;\nfont-size: 24px;\nfont-weight: bold;",t.editor.textPosX=50,t.editor.textPosY=50,t.editor.textScale=1,t.editor.textAlign="left",t.editor.imageOffsetX=0,t.editor.imageOffsetY=0,t.editor.imageScale=1),t.editor.activeElement="none",t.editor.lastClickElement="none",t.editor.lastClickTime=0,r=o.originalUrl?o.originalUrl:o.originalData?o.originalData.startsWith("data:")?o.originalData:"data:image/png;base64,"+o.originalData:o.previewUrl,t.editor.defaultBaseImage=r,t.updateRestoreBtnState&&t.updateRestoreBtnState(),a&&a.customBaseImage&&(r=a.customBaseImage),this.loadAndSetImageDimensions(t,r)}},loadAndSetImageDimensions:function(e,t){var i=new Image;i.onload=function(){e.editor.baseImageWidth=i.width,e.editor.baseImageHeight=i.height,e.editor.baseImage=t,e.editor.showText&&e.$nextTick(function(){e.renderEditorPreview()})},i.onerror=function(){},i.crossOrigin="Anonymous",i.src=t},generateEditedMaterial:function(e){return new Promise(function(t,i){if("undefined"!=typeof html2canvas){var o=e.$refs.editorPreviewContent;if(!o)return void i(new Error("Editor preview container not found"));var r=o.querySelector(".editor-controls"),a=null;r&&(a=r,r.parentNode.removeChild(r)),html2canvas(o,{backgroundColor:null,scale:1,logging:!1,timeout:1e4,useCORS:!0,allowTaint:!0,ignoreElements:function(e){return e.classList&&(e.classList.contains("editor-controls")||e.classList.contains("editor-toolbar")||e.classList.contains("editor-buttons")||e.classList.contains("editor-layer-tag"))},cacheBust:!1,imageTimeout:3e3,removeContainer:!1,skipFonts:!1,useWebGL:!1,onclone:function(e){var t=e.querySelector(".editor-preview-content");if(t){var i=t.cloneNode(!0);t.parentNode.replaceChild(i,t)}},width:o.clientWidth,height:o.clientHeight}).then(function(e){a&&o.appendChild(a);var i=e.toDataURL("image/png",1);t(i)}).catch(function(e){a&&o.appendChild(a),i(e)})}else i(new Error("html2canvas is not loaded"))})},closeMaterialEditor:function(e){e.editor.show=!1},saveMaterialEdit:function(t){var i=!1,o=t.editor,r=o.defaultBaseImage;r&&o.baseImage!==r?i=!0:o.showImage?(o.showText||0!==o.imageOffsetX||0!==o.imageOffsetY||Math.abs(o.imageScale-1)>.001)&&(i=!0):i=!0,i?(t.editor.loading=!0,t.generateEditedMaterial().then(function(i){var o=t.editor.targetKey;if(o){var r=t.materialList.find(function(e){return e.imageKey===o});if(r){if(e.MeeWoo.Core.MaterialState.saveMaterialEditState(t.materialEditStates,o,t.editor),r.previewUrl=i,t.replacedImages[o]=i,r.isReplaced=!0,t.svgaPlayer){var a=new Image;a.onload=function(){t.svgaPlayer.setImage(a,o)},a.src=i}t.editor.show=!1,t.editor.loading=!1,t.showToast&&t.showToast("素材编辑已保存")}}}).catch(function(e){t.editor.loading=!1,t.showToast&&t.showToast("保存失败，请重试")})):t.editor.show=!1}};e.MeeWoo.Core.MaterialOperations=t}(window);