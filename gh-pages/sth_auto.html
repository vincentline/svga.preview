<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <title>ç´ æè‡ªåŠ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- å¤šè¯­è¨€å­—ä½“ï¼šGoogle Fonts Noto Sans ç³»åˆ— (æœ¬åœ°åŒ–ä¼˜åŒ–ï¼šæ³¨é‡Šæ‰å¤–éƒ¨å¼•ç”¨) -->
  <!--
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Sans+Arabic:wght@400;500;700&family=Noto+Sans+Thai:wght@400;500;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    -->

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      font-family: 'Noto Sans', 'Noto Sans SC', 'Noto Sans Arabic', 'Noto Sans Thai',
        'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      background-color: #fcfcfc;
      transition: background-color 0.3s;
    }

    body.dark-mode {
      background-color: #1a1a1a;
    }

    #app {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* ==================== é¡¶éƒ¨å¯¼èˆªæ  ==================== */
    .header-navbar {
      width: 100%;
      height: 56px;
      background-color: #ffffff;
      border-bottom: 1px solid #e3e3e3;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      position: relative;
      z-index: 100;
      transition: background-color 0.3s, border-color 0.3s;
    }

    body.dark-mode .header-navbar {
      background-color: #2a2a2a;
      border-bottom-color: #404040;
    }

    .header-logo {
      height: 24px;
      width: auto;
      margin-right: 12px;
      content: url('assets/img/logo.png');
      transition: all 0.2s ease;
    }

    .header-logo:hover {
      content: url('assets/img/logo_hover.png');
    }

    body.dark-mode .header-logo {
      content: url('assets/img/logo_dark.png');
    }

    body.dark-mode .header-logo:hover {
      content: url('assets/img/logo_hover.png');
    }

    .header-navbar-title {
      font-weight: 700;
      font-size: 12px;
      color: #2c3e50;
      transition: color 0.3s;
    }

    body.dark-mode .header-navbar-title {
      color: #e0e0e0;
    }

    .back-link {
      position: absolute;
      left: 16px;
      font-size: 12px;
      color: #409eff;
      text-decoration: none;
      cursor: pointer;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    body.dark-mode .back-link {
      color: #66b1ff;
    }

    .theme-toggle {
      width: 24px;
      height: 24px;
      border: none;
      background: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
      fill: #2c3e50;
      transition: fill 0.3s;
    }

    body.dark-mode .theme-toggle svg {
      fill: #e0e0e0;
    }

    /* ==================== Tab æ ‡ç­¾æ  ==================== */
    .tab-bar {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      background-color: #ffffff;
      border-bottom: 1px solid #e3e3e3;
      transition: background-color 0.3s, border-color 0.3s;
    }

    body.dark-mode .tab-bar {
      background-color: #2a2a2a;
      border-bottom-color: #404040;
    }

    .tab-btn {
      height: 28px;
      padding: 0 12px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 8px;
      color: #818181;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      background: #f5f5f5;
      color: #333333;
    }

    .tab-btn.active {
      background: #ffffff;
      border-color: #e3e3e3;
      color: #333333;
    }

    body.dark-mode .tab-btn {
      color: #a0a0a0;
    }

    body.dark-mode .tab-btn:hover {
      background: #333333;
      color: #e0e0e0;
    }

    body.dark-mode .tab-btn.active {
      background: #2a2a2a;
      border-color: #404040;
      color: #e0e0e0;
    }

    /* ==================== ä¸»å†…å®¹åŒºåŸŸ ==================== */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    /* å¼€å‘ä¸­æç¤º */
    .dev-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #999999;
      font-size: 16px;
    }

    body.dark-mode .dev-placeholder {
      color: #666666;
    }

    /* åˆ—è¡¨ç½‘æ ¼ */
    .frame-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      max-width: 900px;
      margin: 0 auto;
    }

    .frame-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      background: #ffffff;
      border: 1px solid #e3e3e3;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .frame-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .frame-item:hover {
      background: #f5f5f5;
      border-color: #409eff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .frame-item {
      background: #2a2a2a;
      border-color: #404040;
    }

    body.dark-mode .frame-item:hover {
      background: #333333;
      border-color: #409eff;
    }

    .frame-icon {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 8px;
    }

    .frame-name {
      font-size: 12px;
      color: #333333;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    body.dark-mode .frame-name {
      color: #e0e0e0;
    }

    /* åŠ è½½æç¤º */
    .loading-tip {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 14px;
    }

    /* Toastæç¤º */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
    }

    /* ==================== è’™å±‚å¼¹çª— ==================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    body.dark-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.7);
    }

    .modal-container {
      display: flex;
      width: 90%;
      max-width: 1000px;
      height: 80%;
      max-height: 700px;
      overflow: hidden;
      position: relative;
      border-radius: 16px;
      background: #ffffff;
      background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNlM2UzZTMiLz48L3N2Zz4=);
      background-size: 8px 8px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .modal-container {
      background: #2a2a2a;
      background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiM0MDQwNDAiLz48L3N2Zz4=);
      background-size: 8px 8px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
    }

    .modal-close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
    }

    .modal-close-btn:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: scale(1.1);
    }

    .modal-close-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    body.dark-mode .modal-close-btn {
      background: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .modal-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-close-btn svg {
      width: 16px;
      height: 16px;
      stroke: #333;
      stroke-width: 2;
    }

    body.dark-mode .modal-close-btn svg {
      stroke: #e0e0e0;
    }

    .preview-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
    }

    .preview-player {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      max-height: 400px;
    }

    body.dark-mode .preview-player {
      background: #1a1a1a;
    }

    #darSvgaContainer,
    #giftSvgaContainer {
      width: 400px;
      height: 400px;
    }

    .preview-info {
      margin-top: 16px;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
    }

    body.dark-mode .preview-info {
      background: #1a1a1a;
    }

    .material-preview-container {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .material-preview-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .material-preview-info .section-title {
      text-align: center;
    }

    .material-preview-info .material-card {
      max-width: 400px;
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 12px;
      justify-content: center;
    }

    .info-item {
      display: flex;
      gap: 4px;
    }

    .info-label {
      color: #999;
    }

    .info-value {
      color: #333;
      font-weight: 500;
    }

    .info-value.warning {
      color: #ff4444;
    }

    body.dark-mode .info-value {
      color: #e0e0e0;
    }

    .settings-panel {
      width: 360px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .settings-panel {
      background: #1e1e1e;
    }

    .panel-section {
      padding: 20px;
      border-bottom: 1px solid #e3e3e3;
    }

    body.dark-mode .panel-section {
      border-bottom-color: #404040;
    }

    .panel-section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }

    body.dark-mode .section-title {
      color: #e0e0e0;
    }

    .material-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    body.dark-mode .material-card {
      background: #1a1a1a;
    }

    .material-thumb {
      width: 48px;
      height: 48px;
      background: #fff;
      border: 1px solid #e3e3e3;
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.dark-mode .material-thumb {
      background: #2a2a2a;
      border-color: #404040;
    }

    .material-thumb img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .material-info {
      flex: 1;
      min-width: 0;
    }

    .material-name {
      font-size: 12px;
      color: #333;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.dark-mode .material-name {
      color: #e0e0e0;
    }

    .material-btns {
      display: flex;
      gap: 8px;
    }

    .btn {
      height: 28px;
      padding: 0 12px;
      border: 1px solid #e3e3e3;
      border-radius: 8px;
      background: #ffffff;
      color: #333;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn:hover {
      background: #f5f5f5;
      border-color: #d0d0d0;
    }

    body.dark-mode .btn {
      background: #2a2a2a;
      border-color: #404040;
      color: #e0e0e0;
    }

    body.dark-mode .btn:hover {
      background: #333333;
      border-color: #505050;
    }

    .btn-primary {
      background: #409eff;
      border-color: #409eff;
      color: #fff;
    }

    .btn-primary:hover {
      background: #66b1ff;
      border-color: #66b1ff;
    }

    .btn-success {
      background: #67c23a;
      border-color: #67c23a;
      color: #fff;
    }

    .btn-success:hover {
      background: #85ce61;
      border-color: #85ce61;
    }

    .btn-icon {
      width: 28px;
      padding: 0;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .text-effect-area {
      margin-bottom: 16px;
    }

    .text-canvas-wrapper {
      width: 100%;
      height: 70px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      position: relative;
    }

    body.dark-mode .text-canvas-wrapper {
      background: #2a2a2a;
    }

    .text-canvas {
      max-width: 100%;
      max-height: 100%;
      border: 1px solid #e3e3e3;
    }

    .text-input {
      width: 100%;
      height: 40px;
      padding: 0 12px;
      border: 1px solid #e3e3e3;
      border-radius: 8px;
      background: #ffffff;
      color: #333;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .text-input:focus {
      outline: none;
      border-color: #409eff;
    }

    body.dark-mode .text-input {
      background: #1a1a1a;
      border-color: #404040;
      color: #e0e0e0;
    }

    .position-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .position-btns {
      display: flex;
      gap: 4px;
    }

    .pos-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border: 1px solid #e3e3e3;
      border-radius: 6px;
      background: #ffffff;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .pos-btn:hover {
      background: #f5f5f5;
      border-color: #409eff;
      color: #409eff;
    }

    body.dark-mode .pos-btn {
      background: #2a2a2a;
      border-color: #404040;
      color: #e0e0e0;
    }

    body.dark-mode .pos-btn:hover {
      background: #333;
      border-color: #409eff;
      color: #409eff;
    }

    .export-section {
      padding: 20px;
      border-top: 1px solid #e3e3e3;
      margin-top: auto;
    }

    body.dark-mode .export-section {
      border-top-color: #404040;
    }

    .export-btn {
      width: 100%;
      height: 40px;
      font-size: 14px;
      font-weight: 500;
    }

    /* å›¾æ ‡ç”Ÿæˆæ•ˆæœ */
    .icon-generator {
      display: flex;
      justify-content: center;
      padding: 16px 0;
    }

    .icon-preview {
      display: block;
      width: 300px;
      height: 300px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
    }

    body.dark-mode .icon-preview {
      border-color: #404040;
      background: #2a2a2a;
    }

    /* è£å‰ªå¼¹çª— */
    .crop-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .crop-modal-content {
      background: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    body.dark-mode .crop-modal-content {
      background: #2a2a2a;
    }

    .crop-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    body.dark-mode .crop-modal-header {
      border-bottom-color: #404040;
    }

    .crop-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 500;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .close-btn:hover {
      background: #f0f0f0;
    }

    body.dark-mode .close-btn {
      color: #999;
    }

    body.dark-mode .close-btn:hover {
      background: #404040;
    }

    .crop-modal-body {
      padding: 20px;
      flex: 1;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .crop-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: #f5f5f5;
      border-radius: 8px;
      overflow: hidden;
      cursor: move;
    }

    body.dark-mode .crop-container {
      background: #1a1a1a;
    }

    .crop-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }

    .crop-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #333;
    }

    body.dark-mode .crop-controls label {
      color: #e0e0e0;
    }

    .crop-scale-slider {
      width: 400px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: #ddd;
      outline: none;
      border-radius: 2px;
    }

    .crop-scale-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #007bff;
      cursor: pointer;
      border-radius: 50%;
    }

    body.dark-mode .crop-scale-slider {
      background: #404040;
    }

    .crop-scale-value {
      min-width: 50px;
      font-weight: 500;
      color: #007bff;
    }

    body.dark-mode .crop-scale-value {
      color: #4a9eff;
    }

    .crop-canvas {
      width: 100%;
      height: 100%;
    }

    .crop-tips {
      text-align: center;
      color: #999;
      font-size: 13px;
    }

    .crop-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    body.dark-mode .crop-modal-footer {
      border-top-color: #404040;
    }

    /* ==================== ç”¨æˆ·å‹‹ç« æ ·å¼ ==================== */
    .frame-item.add-btn {
      border: 2px dashed #e3e3e3;
      justify-content: center;
      color: #999;
    }

    .frame-item.add-btn:hover {
      border-color: #409eff;
      color: #409eff;
    }

    .add-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .delete-badge-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 5;
    }

    .edit-badge-btn {
      position: absolute;
      top: 4px;
      right: 28px;
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 5;
    }

    .frame-item:hover .delete-badge-btn,
    .frame-item:hover .edit-badge-btn {
      opacity: 1;
    }

    .frame-item {
      position: relative;
    }

    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-area {
      border: 2px dashed #e3e3e3;
      border-radius: 12px;
      height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #fafafa;
      transition: all 0.3s;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .upload-area:hover {
      border-color: #409eff;
      background: #f0f7ff;
    }

    body.dark-mode .upload-area {
      background: #2a2a2a;
      border-color: #404040;
    }

    body.dark-mode .upload-area:hover {
      background: #333;
    }

    .upload-preview-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .upload-placeholder {
      text-align: center;
      color: #999;
    }

    /* å‹‹ç« ç”Ÿæˆé¢„è§ˆ */
    .badge-gen-preview {
      width: 100%;
      height: 300px;
      background: #f5f5f5;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      overflow: hidden;
      position: relative;
      background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNlM2UzZTMiLz48L3N2Zz4=);
    }

    body.dark-mode .badge-gen-preview {
      background-color: #1a1a1a;
      background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiM0MDQwNDAiLz48L3N2Zz4=);
    }

    .badge-canvas-wrapper {
      position: relative;
      cursor: move;
    }

    .css-input {
      width: 100%;
      height: 100px;
      padding: 12px;
      border: 1px solid #e3e3e3;
      border-radius: 8px;
      background: #ffffff;
      color: #333;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
      margin-bottom: 12px;
    }

    body.dark-mode .css-input {
      background: #1a1a1a;
      border-color: #404040;
      color: #e0e0e0;
    }
  </style>
</head>

<body>
  <div id="app" @mousemove="onDragMove" @mouseup="onDragEnd">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header-navbar">
      <a href="index.html?type=internal" style="display:flex;align-items:center;text-decoration:none;color:inherit;">
        <img class="header-logo" src="assets/img/logo.png" alt="Logo">
        <div class="header-navbar-title">ç´ æè‡ªåŠ©</div>
      </a>
      <button class="theme-toggle" @click="toggleTheme" :title="isDarkMode ? 'åˆ‡æ¢ä¸ºç™½å¤©æ¨¡å¼' : 'åˆ‡æ¢ä¸ºæš—é»‘æ¨¡å¼'">
        <svg v-if="!isDarkMode" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
        </svg>
        <svg v-else viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="4" />
          <path
            d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" />
        </svg>
      </button>
    </div>

    <!-- Tab æ ‡ç­¾æ  -->
    <div class="tab-bar">
      <button class="tab-btn" :class="{ active: activeTab === 'dar' }" @click="switchTab('dar')">å¤§Rå¤´åƒæ¡†</button>
      <button class="tab-btn" :class="{ active: activeTab === 'gift_1photo' }"
        @click="switchTab('gift_1photo')">åäººç¤¼ç‰©åŸºæœ¬æ¬¾</button>
      <button class="tab-btn" :class="{ active: activeTab === 'gift_3photo' }"
        @click="switchTab('gift_3photo')">åäººç¤¼ç‰©3å›¾æ¬¾</button>
      <button class="tab-btn" :class="{ active: activeTab === 'gift_video' }"
        @click="switchTab('gift_video')">åäººç¤¼ç‰©è§†é¢‘æ¬¾</button>
      <button class="tab-btn" :class="{ active: activeTab === 'badge' }" @click="switchTab('badge')">ç”¨æˆ·å‹‹ç« </button>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <!-- å¤§Rå¤´åƒæ¡†åˆ—è¡¨ -->
      <template v-if="activeTab === 'dar'">
        <div v-if="dar.loading" class="loading-tip">åŠ è½½ä¸­...</div>
        <div v-else-if="dar.frameList.length === 0" class="loading-tip">æš‚æ— å¤´åƒæ¡†ï¼Œè¯·å°†SVGAæ–‡ä»¶æ”¾å…¥ assets/dar_svga ç›®å½•</div>
        <div v-else class="frame-grid">
          <div v-for="(item, index) in dar.frameList" :key="'dar_' + item.name" class="frame-item"
            :class="{ 'disabled': dar.isExporting }" @click="!dar.isExporting && openDarFrame(item)">
            <img :src="'assets/dar_svga/' + item.icon" :alt="item.name" class="frame-icon" />
            <div class="frame-name">{{ item.name }}</div>
          </div>
        </div>
      </template>

      <!-- åäººç¤¼ç‰©åŸºæœ¬æ¬¾åˆ—è¡¨ -->
      <template v-if="activeTab === 'gift_1photo'">
        <div v-if="gift.loading" class="loading-tip">åŠ è½½ä¸­...</div>
        <div v-else-if="gift.frameList.length === 0" class="loading-tip">æš‚æ— ç¤¼ç‰©ï¼Œè¯·å°†SVGAæ–‡ä»¶æ”¾å…¥ assets/mingren_gift_1photo ç›®å½•
        </div>
        <div v-else class="frame-grid">
          <div v-for="(item, index) in gift.frameList" :key="'gift_' + item.name" class="frame-item"
            :class="{ 'disabled': gift.isExporting || gift.isConvertingMP4 }"
            @click="!gift.isExporting && !gift.isConvertingMP4 && openGiftFrame(item)">
            <img :src="'assets/mingren_gift_1photo/' + item.icon" :alt="item.name" class="frame-icon" />
            <div class="frame-name">{{ item.name }}</div>
          </div>
        </div>
      </template>

      <!-- åäººç¤¼ç‰©3å›¾æ¬¾ï¼ˆå¼€å‘ä¸­ï¼‰ -->
      <template v-if="activeTab === 'gift_3photo'">
        <div class="dev-placeholder">å¼€å‘ä¸­...</div>
      </template>

      <!-- åäººç¤¼ç‰©è§†é¢‘æ¬¾ï¼ˆå¼€å‘ä¸­ï¼‰ -->
      <template v-if="activeTab === 'gift_video'">
        <div class="dev-placeholder">å¼€å‘ä¸­...</div>
      </template>

      <!-- ç”¨æˆ·å‹‹ç« åˆ—è¡¨ -->
      <template v-if="activeTab === 'badge'">
        <div class="frame-grid">
          <!-- å¢åŠ æ ·å¼æŒ‰é’® -->
          <div class="frame-item add-btn" @click="openBadgeAddModal">
            <div class="add-icon">+</div>
            <div class="frame-name">å¢åŠ æ ·å¼</div>
          </div>
          <!-- å‹‹ç« åˆ—è¡¨ -->
          <div v-for="(item, index) in badge.list" :key="'badge_' + index" class="frame-item"
            @click="openBadgeGenModal(item)">
            <div class="delete-badge-btn" v-if="item.isCustom" @click.stop="deleteBadge(item)">Ã—</div>
            <div class="edit-badge-btn" v-if="item.isCustom" @click.stop="openBadgeEditModal(item)">âœ</div>
            <img :src="item.url" :alt="item.name" class="frame-icon" />
            <div class="frame-name">{{ item.name }}</div>
          </div>
        </div>
      </template>
    </div>

    <!-- Toastæç¤º -->
    <div class="toast" :class="{show: toastVisible}">{{ toastMessage }}</div>

    <!-- å¤§Rå¤´åƒæ¡†å¼¹çª— -->
    <div class="modal-overlay" :class="{show: dar.showModal}">
      <div class="modal-container" v-if="dar.currentFrame">
        <button class="modal-close-btn" :disabled="dar.isExporting" @click="closeDarModal" title="å…³é—­">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <div class="preview-section">
          <div class="preview-player">
            <div id="darSvgaContainer"></div>
          </div>
          <div class="preview-info">
            <div class="info-row">
              <div class="info-item"><span class="info-label">æ–‡ä»¶åï¼š</span><span class="info-value">{{
                  dar.currentFrame.name }}.svga</span></div>
              <div class="info-item"><span class="info-label">å°ºå¯¸ï¼š</span><span class="info-value">{{ dar.svgaInfo.width
                  }}Ã—{{ dar.svgaInfo.height }}</span></div>
              <div class="info-item"><span class="info-label">å¸§ç‡ï¼š</span><span class="info-value">{{ dar.svgaInfo.fps }}
                  FPS</span></div>
            </div>
          </div>
          <div class="material-preview-container" v-if="dar.materialKeys.length > 0">
            <div class="material-preview-info" v-for="key in dar.materialKeys" :key="key" v-if="dar.materials[key]">
              <div class="section-title">ç´ æï¼š{{ key }}</div>
              <div class="material-card">
                <div class="material-thumb"><img :src="dar.materials[key].previewUrl"
                    v-if="dar.materials[key].previewUrl" /></div>
                <div class="material-info">
                  <div class="material-name">{{ dar.materials[key].sizeText }}</div>
                </div>
                <div class="material-btns">
                  <button class="btn" :disabled="dar.isExporting" @click="darReplaceMaterial(key)">æ›¿æ¢</button>
                  <button class="btn btn-icon" :disabled="dar.isExporting" @click="darDownloadMaterial(key)"
                    title="ä¸‹è½½">â†“</button>
                  <button class="btn btn-icon" v-if="dar.replacedImages[key]" :disabled="dar.isExporting"
                    @click="darRestoreMaterial(key)" title="æ¢å¤">â†º</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-panel">
          <div class="panel-section">
            <div class="section-title">æ–‡æœ¬å†…å®¹è¾“å…¥</div>
            <input type="text" class="text-input" v-model="dar.textInput1" placeholder="è¾“å…¥æ–‡å­—ï¼Œæ”¯æŒemoji ğŸ˜Š"
              @input="darRenderText" />
            <div class="position-controls">
              <div class="position-btns">
                <button class="pos-btn" @click="darMoveText('up')">â†‘</button>
                <button class="pos-btn" @click="darMoveText('down')">â†“</button>
                <button class="pos-btn" @click="darMoveText('left')">â†</button>
                <button class="pos-btn" @click="darMoveText('right')">â†’</button>
                <button class="pos-btn" @click="darScaleText('down')" title="ç¼©å°">-</button>
                <button class="pos-btn" @click="darScaleText('up')" title="æ”¾å¤§">+</button>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn" style="flex: 1;" @click="darResetText">æ¢å¤é»˜è®¤ä½ç½®</button>
            </div>
          </div>

          <div class="panel-section" v-for="(key, index) in dar.materialKeys" :key="'panel_' + key"
            v-if="dar.materials[key]">
            <div class="section-title">æ–‡æœ¬æ•ˆæœåŒºåŸŸï¼š{{ key }}</div>
            <div class="text-effect-area">
              <div class="text-canvas-wrapper" @mousedown="darStartDragText" @wheel="darHandleWheel">
                <canvas ref="darTextCanvas" class="text-canvas" width="300" height="50"></canvas>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" style="flex: 1;" @click="darApplyText(key, index)">æ›¿æ¢"{{ key
                  }}"</button>
              </div>
            </div>
          </div>

          <div class="panel-section" v-if="dar.materialKeys.length === 0">
            <div class="loading-tip">è¯¥SVGAæœªé…ç½®å¯æ›¿æ¢ç´ æ</div>
          </div>
          <div class="export-section">
            <button class="btn btn-success export-btn" :disabled="!darCanExport || dar.isExporting"
              @click="darExportSVGA">å¯¼å‡ºæ–°SVGA</button>
          </div>
        </div>
      </div>
    </div>

    <!-- åäººç¤¼ç‰©åŸºæœ¬æ¬¾å¼¹çª— -->
    <div class="modal-overlay" :class="{show: gift.showModal}">
      <div class="modal-container" v-if="gift.currentFrame">
        <button class="modal-close-btn" :disabled="gift.isExporting || gift.isConvertingMP4" @click="closeGiftModal"
          title="å…³é—­">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <div class="preview-section">
          <div class="preview-player">
            <div id="giftSvgaContainer"></div>
          </div>
          <div class="preview-info">
            <div class="info-row">
              <div class="info-item"><span class="info-label">æ–‡ä»¶åï¼š</span><span class="info-value">{{
                  gift.currentFrame.name }}.svga</span></div>
              <div class="info-item"><span class="info-label">å°ºå¯¸ï¼š</span><span class="info-value">{{ gift.svgaInfo.width
                  }}Ã—{{ gift.svgaInfo.height }}</span></div>
              <div class="info-item"><span class="info-label">å¸§ç‡ï¼š</span><span class="info-value">{{ gift.svgaInfo.fps }}
                  FPS</span></div>
            </div>
          </div>
          <div class="material-preview-container" v-if="gift.materials.zaky">
            <div class="material-preview-info">
              <div class="section-title">ç´ æï¼šzaky</div>
              <div class="material-card">
                <div class="material-thumb"><img :src="gift.materials.zaky.previewUrl"
                    v-if="gift.materials.zaky.previewUrl" /></div>
                <div class="material-info">
                  <div class="material-name">{{ gift.materials.zaky.sizeText }}</div>
                </div>
                <div class="material-btns">
                  <button class="btn" :disabled="gift.isExporting || gift.isConvertingMP4"
                    @click="giftReplaceMaterial('zaky')">æ›¿æ¢</button>
                  <button class="btn btn-icon" :disabled="gift.isExporting || gift.isConvertingMP4"
                    @click="giftDownloadMaterial('zaky')" title="ä¸‹è½½">â†“</button>
                  <button class="btn btn-icon" v-if="gift.replacedImages.zaky"
                    :disabled="gift.isExporting || gift.isConvertingMP4" @click="giftRestoreMaterial('zaky')"
                    title="æ¢å¤">â†º</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-panel">
          <div class="panel-section" v-if="gift.materials.zaky">
            <div class="section-title">å›¾æ ‡ç”Ÿæˆæ•ˆæœ</div>
            <div class="icon-generator"><canvas ref="giftIconCanvas" width="300" height="300"
                class="icon-preview"></canvas></div>
          </div>
          <div class="panel-section" v-if="!gift.materials.zaky">
            <div class="loading-tip">æœªæ£€æµ‹åˆ° zaky ç´ æ</div>
          </div>
          <div class="export-section">
            <button class="btn btn-success export-btn"
              :disabled="!giftCanExportMP4 || gift.isConvertingMP4 || gift.isExporting" @click="giftExportMP4AndIcon">
              <span v-if="!gift.isConvertingMP4">å¯¼å‡ºåŒé€šé“MP4å’ŒPNGå›¾æ ‡</span>
              <span v-else>{{ gift.mp4ConvertStage }} {{ gift.mp4ConvertProgress }}%</span>
            </button>
            <button class="btn btn-success export-btn" style="margin-top: 8px;"
              :disabled="!giftCanExport || gift.isExporting" @click="giftExportAll">å¯¼å‡ºæ–°SVGAå’ŒPNGå›¾æ ‡</button>
          </div>
        </div>
      </div>
    </div>

    <!-- åäººç¤¼ç‰©è£å‰ªå¼¹çª— -->
    <div class="crop-modal" v-if="gift.showCropModal"
      @click.self="!gift.isExporting && !gift.isConvertingMP4 && giftCloseCropModal">
      <div class="crop-modal-content">
        <div class="crop-modal-header">
          <h3>è£å‰ªå›¾ç‰‡ï¼ˆ322Ã—423ï¼‰</h3>
          <button class="close-btn" :disabled="gift.isExporting || gift.isConvertingMP4"
            @click="giftCloseCropModal">Ã—</button>
        </div>
        <div class="crop-modal-body">
          <div class="crop-container"><canvas ref="giftCropCanvas" class="crop-canvas"></canvas></div>
          <div class="crop-controls">
            <label>ç¼©æ”¾ï¼š
              <input type="range" min="0.1" max="4" step="0.0025" v-model.number="gift.cropImageScale"
                @input="giftRenderCropCanvas" class="crop-scale-slider" />
              <span class="crop-scale-value">{{ Math.round(gift.cropImageScale * 100) }}%</span>
            </label>
          </div>
          <div class="crop-tips">æ‹–åŠ¨è°ƒæ•´å›¾ç‰‡ä½ç½®ï¼Œæ»šè½®æˆ–æ»‘å—ç¼©æ”¾å›¾ç‰‡</div>
        </div>
        <div class="crop-modal-footer">
          <button class="btn" :disabled="gift.isExporting || gift.isConvertingMP4"
            @click="giftCloseCropModal">å–æ¶ˆ</button>
          <button class="btn btn-primary" :disabled="gift.isExporting || gift.isConvertingMP4"
            @click="giftConfirmCrop">ç¡®è®¤è£å‰ª</button>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·å‹‹ç« ï¼šå¢åŠ æ ·å¼å¼¹çª— -->
    <div class="modal-overlay" :class="{show: badge.showAddModal}">
      <div class="modal-container" style="height: auto; max-height: 90%;">
        <button class="modal-close-btn" @click="closeBadgeAddModal" title="å…³é—­">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <div class="preview-section" style="border-right: 1px solid #e3e3e3;">
          <div class="section-title">ä¸Šä¼ PNGå›¾ç‰‡ (æ‹–æ‹½æˆ–ç‚¹å‡»)</div>
          <div class="upload-area" @click="$refs.badgeFileInput.click()" @dragover.prevent
            @drop.prevent="badgeHandleDrop">
            <img v-if="badge.addForm.previewUrl" :src="badge.addForm.previewUrl" class="upload-preview-img" />
            <div v-else class="upload-placeholder">
              <div style="font-size: 24px; margin-bottom: 8px;">+</div>
              <div>ç‚¹å‡»æˆ–æ‹–æ‹½PNGå›¾ç‰‡åˆ°æ­¤å¤„</div>
              <div style="font-size: 12px; margin-top: 4px;">PNG, < 5MB, < 3000px</div>
              </div>
            </div>
          </div>
          <div class="settings-panel" style="width: 400px; box-shadow: none;">
            <div class="panel-section">
              <div class="section-title">{{ badge.editingId ? 'ä¿®æ”¹ç”¨æˆ·å‹‹ç« æ ·å¼' : 'å¢åŠ ç”¨æˆ·å‹‹ç« æ ·å¼' }}</div>
              <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">åç§° (éå¿…å¡«ï¼Œé»˜è®¤æ–‡ä»¶å)</div>
                <input type="text" class="text-input" v-model="badge.addForm.name" placeholder="è¯·è¾“å…¥å‹‹ç« åç§°" />
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">æ–‡å­—CSSæ ·å¼ (æ‰¾è®¾è®¡å¸ˆæä¾›ï¼Œéå¿…å¡«)</div>
                <textarea class="css-input" v-model="badge.addForm.css" placeholder="ç²˜è´´CSSæ ·å¼ä»£ç ..."></textarea>
              </div>
            </div>
            <div class="export-section">
              <button class="btn btn-success export-btn" :disabled="!badge.addForm.file && !badge.addForm.previewUrl"
                @click="badgeSubmitAdd">æäº¤</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ç”¨æˆ·å‹‹ç« ï¼šç”Ÿæˆå›¾ç‰‡å¼¹çª— -->
      <div class="modal-overlay" :class="{show: badge.showGenModal}">
        <div class="modal-container" style=" height: auto;">
          <button class="modal-close-btn" @click="closeBadgeGenModal" title="å…³é—­">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div style="flex: 1; display: flex; flex-direction: column; padding: 24px;">
            <div class="section-title" style="text-align: center;">ç”Ÿæˆç”¨æˆ·å‹‹ç« å›¾ç‰‡</div>

            <div class="badge-gen-preview" @wheel="badgeHandleWheel">
              <div class="badge-canvas-wrapper" @mousedown="badgeStartDrag">
                <canvas ref="badgeCanvas"></canvas>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <input type="text" class="text-input" v-model="badge.genText" placeholder="è¯·è¾“å…¥æ–‡å­— (æ”¯æŒEmoji)"
                @input="badgeRenderCanvas" />
            </div>

            <button class="btn btn-success export-btn" :disabled="!badge.genText || !badge.genText.trim()"
              @click="badgeExport">å¯¼å‡ºPNGå›¾ç‰‡</button>
          </div>
        </div>
      </div>

      <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
      <input type="file" ref="darFileInput" accept="image/*" style="display:none" @change="darHandleFileSelect" />
      <input type="file" ref="giftFileInput" accept="image/*" style="display:none" @change="giftHandleFileSelect" />
      <input type="file" ref="badgeFileInput" accept="image/png" style="display:none" @change="badgeHandleFileSelect" />
    </div>

    <!-- Vue.js -->
    <script src="assets/js/lib/vue.min.js"></script>
    <!-- SVGA Player -->
    <script src="assets/js/lib/svga.min.js"></script>
    <!-- Pako (ç”¨äºå‹ç¼©/è§£å‹) -->
    <script src="assets/js/lib/pako.min.js"></script>
    <!-- Protobuf.js (ç”¨äºè§£æproto) -->
    <script src="assets/js/lib/protobuf.min.js"></script>

    <script>
      new Vue({
        el: '#app',
        data: function () {
          return {
            isDarkMode: false,
            activeTab: 'dar',
            toastVisible: false,
            toastMessage: '',

            // å¤§Rå¤´åƒæ¡†æ•°æ®
            dar: {
              loading: true,
              frameList: [],
              currentFrame: null,
              svgaPlayer: null,
              svgaParser: null,
              svgaVideoItem: null,
              svgaFile: null,
              svgaInfo: { width: 0, height: 0, fps: 0 },
              materials: {}, // åŠ¨æ€å­˜å‚¨ç´ æä¿¡æ¯
              materialKeys: [], // å½“å‰SVGAåŒ…å«çš„ç´ ækeyåˆ—è¡¨
              replacedImages: {},
              textInput1: '',
              textOffset: { x: 0, y: 0 },
              textScale: 1,
              draggingText: false,
              dragStartPos: { x: 0, y: 0 },
              textStyle: {
                fontSize: 24,
                fontFamily: "'Noto Sans', 'Noto Sans SC', sans-serif",
                fillColor: '#ffffff',
                strokeColor: '#000000',
                strokeWidth: 2,
                textAlign: 'center'
              },
              customTextStyle: {},
              currentReplaceTarget: null,
              showModal: false,
              isExporting: false
            },

            // åäººç¤¼ç‰©åŸºæœ¬æ¬¾æ•°æ®
            gift: {
              loading: true,
              frameList: [],
              currentFrame: null,
              svgaPlayer: null,
              svgaParser: null,
              svgaVideoItem: null,
              svgaFile: null,
              svgaInfo: { width: 0, height: 0, fps: 0 },
              materials: { zaky: null },
              replacedImages: {},
              showModal: false,
              showCropModal: false,
              cropImage: null,
              cropImageScale: 1,
              cropImageOffset: { x: 0, y: 0 },
              cropDragging: false,
              cropDragStart: { x: 0, y: 0 },
              croppedImageData: null,
              currentReplaceTarget: null,
              isExporting: false,
              isConvertingMP4: false,
              mp4ConvertProgress: 0,
              mp4ConvertStage: ''
            },

            // ç”¨æˆ·å‹‹ç« æ•°æ®
            badge: {
              list: [],
              customList: [],
              current: null,
              showAddModal: false,
              showGenModal: false,
              editingId: null,

              // å¢åŠ æ ·å¼è¡¨å•
              addForm: {
                name: '',
                file: null,
                previewUrl: '',
                css: '',
                width: 0,
                height: 0
              },

              // ç”Ÿæˆå›¾ç‰‡
              genText: '',
              genOffset: { x: 0, y: 0 },
              genScale: 1,
              dragging: false,
              dragStartPos: { x: 0, y: 0 },
              cachedImage: null
            }
          };
        },

        mounted: function () {
          var savedTheme = localStorage.getItem('theme');
          if (savedTheme === 'dark') {
            this.isDarkMode = true;
            document.body.classList.add('dark-mode');
          }
          this.loadDarFrameList();
          this.loadGiftFrameList();
          this.badgeLoadList(); // åŠ è½½å‹‹ç« åˆ—è¡¨
          document.addEventListener('mousemove', this.onDragMove);
          document.addEventListener('mouseup', this.onDragEnd);
        },

        beforeDestroy: function () {
          document.removeEventListener('mousemove', this.onDragMove);
          document.removeEventListener('mouseup', this.onDragEnd);
        },

        computed: {
          darCanExport: function () { return Object.keys(this.dar.replacedImages).length > 0; },
          giftCanExport: function () { return Object.keys(this.gift.replacedImages).length > 0; },
          giftCanExportMP4: function () { return this.gift.svgaVideoItem !== null; }
        },

        methods: {
          toggleTheme: function () {
            this.isDarkMode = !this.isDarkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
          },
          switchTab: function (tab) { this.activeTab = tab; },
          showToast: function (msg) {
            this.toastMessage = msg;
            this.toastVisible = true;
            var _this = this;
            setTimeout(function () { _this.toastVisible = false; }, 2000);
          },
          getTimestampFilename: function (baseName, ext) {
            var now = new Date();
            var y = now.getFullYear();
            var m = String(now.getMonth() + 1).padStart(2, '0');
            var d = String(now.getDate()).padStart(2, '0');
            var h = String(now.getHours()).padStart(2, '0');
            var mi = String(now.getMinutes()).padStart(2, '0');
            var s = String(now.getSeconds()).padStart(2, '0');
            return baseName + '_' + y + m + d + h + mi + s + '.' + ext;
          },
          formatBytes: function (bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          },

          // ==================== é€šç”¨SVGAåŠ è½½æ–¹æ³• ====================
          loadSVGA: function (module, item, containerId) {
            var _this = this;
            var svgaUrl = item.svga;
            if (svgaUrl.indexOf('http') === 0) svgaUrl += (svgaUrl.indexOf('?') > -1 ? '&' : '?') + '_t=' + Date.now();
            var container = document.getElementById(containerId);
            if (container) container.innerHTML = '';
            module.svgaPlayer = new SVGA.Player('#' + containerId);
            module.svgaParser = new SVGA.Parser('#' + containerId);
            fetch(svgaUrl, { mode: 'cors' })
              .then(function (res) { if (!res.ok) throw new Error('HTTP ' + res.status); return res.blob(); })
              .then(function (blob) {
                module.svgaFile = blob;
                var objectUrl = URL.createObjectURL(blob);
                module.svgaParser.load(objectUrl, function (videoItem) {
                  URL.revokeObjectURL(objectUrl);
                  module.svgaVideoItem = videoItem;
                  module.svgaPlayer.setVideoItem(videoItem);
                  module.svgaPlayer.loops = 0;
                  module.svgaPlayer.startAnimation();
                  module.svgaInfo.width = videoItem.videoSize.width;
                  module.svgaInfo.height = videoItem.videoSize.height;
                  module.svgaInfo.fps = videoItem.FPS;
                  if (module === _this.dar) _this.darExtractMaterials(videoItem);
                  else if (module === _this.gift) _this.giftExtractMaterials(videoItem);
                }, function (err) { URL.revokeObjectURL(objectUrl); _this.showToast('åŠ è½½SVGAå¤±è´¥'); });
              })
              .catch(function (err) { _this.showToast('è·å–æ–‡ä»¶å¤±è´¥'); });
          },

          // é€šç”¨å¯¼å‡ºSVGAæ–¹æ³•
          exportSVGA: function (module, baseName) {
            var _this = this;
            if (!module.svgaFile || Object.keys(module.replacedImages).length === 0) {
              _this.showToast('è¯·å…ˆæ›¿æ¢è‡³å°‘ä¸€ä¸ªç´ æ'); return;
            }
            _this.showToast('æ­£åœ¨å¯¼å‡º...');
            var reader = new FileReader();
            reader.onload = function (e) {
              try {
                var arrayBuffer = e.target.result;
                var uint8Array = new Uint8Array(arrayBuffer);
                var inflatedData = pako.inflate(uint8Array);
                protobuf.load('svga.proto', function (err, root) {
                  if (err) { _this.showToast('ProtoåŠ è½½å¤±è´¥'); return; }
                  try {
                    var MovieEntity = root.lookupType('com.opensource.svga.MovieEntity');
                    var movieData = MovieEntity.decode(inflatedData);
                    for (var imageKey in module.replacedImages) {
                      if (module.replacedImages.hasOwnProperty(imageKey) && movieData.images[imageKey]) {
                        var base64Data = module.replacedImages[imageKey];
                        var base64String = base64Data.split(',')[1] || base64Data;
                        var binaryString = atob(base64String);
                        var bytes = new Uint8Array(binaryString.length);
                        for (var i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                        movieData.images[imageKey] = bytes;
                      }
                    }
                    var buffer = MovieEntity.encode(movieData).finish();
                    var deflatedData = pako.deflate(buffer);
                    var fileName = _this.getTimestampFilename(baseName, 'svga');
                    var blob = new Blob([deflatedData], { type: 'application/octet-stream' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url; a.download = fileName; a.click();
                    URL.revokeObjectURL(url);
                    _this.showToast('å¯¼å‡ºæˆåŠŸï¼');
                  } catch (decodeErr) { _this.showToast('ç¼–ç å¤±è´¥'); }
                });
              } catch (err) { _this.showToast('å¤„ç†å¤±è´¥'); }
            };
            reader.readAsArrayBuffer(module.svgaFile);
          },

          // é€šç”¨åº”ç”¨åˆ°SVGAæ–¹æ³•
          applyImageToSVGA: function (player, imageKey, dataUrl) {
            var img = new Image();
            img.onload = function () {
              player.setImage(img, imageKey);
              player.startAnimation();
            };
            img.src = dataUrl;
          },

          // ==================== å¤§Rå¤´åƒæ¡†æ–¹æ³• ====================
          loadDarFrameList: function () {
            var _this = this;
            fetch('assets/dar_svga/file-list.json')
              .then(function (res) { return res.json(); })
              .then(function (list) {
                _this.dar.frameList = list.map(function (item) {
                  return {
                    name: item.name,
                    svga: item.svga,
                    icon: item.name + '.png',
                    textStyle: item.textStyle || null
                  };
                });
                _this.dar.loading = false;
              })
              .catch(function () { _this.dar.frameList = []; _this.dar.loading = false; });
          },

          openDarFrame: function (item) {
            if (this.dar.svgaPlayer) this.dar.svgaPlayer.clear();
            this.dar.currentFrame = item;
            this.dar.showModal = true;
            this.dar.materials = {};
            this.dar.materialKeys = item.textStyle ? Object.keys(item.textStyle) : [];
            this.dar.replacedImages = {};
            this.dar.textInput1 = '';
            this.dar.textOffset = { x: 0, y: 0 };
            this.dar.textScale = 1;

            // åˆå§‹åŒ–æ ·å¼é…ç½®
            this.dar.customTextStyle = item.textStyle || {};

            this.$nextTick(function () { this.loadDarSVGA(item); }.bind(this));
          },

          closeDarModal: function () {
            if (this.dar.isExporting) return;
            this.dar.showModal = false;
            if (this.dar.svgaPlayer) this.dar.svgaPlayer.clear();
            this.dar.currentFrame = null;
          },

          loadDarSVGA: function (item) {
            this.loadSVGA(this.dar, item, 'darSvgaContainer');
          },

          darExtractMaterials: function (videoItem) {
            var _this = this;
            var images = videoItem.images || {};

            // éå†æ‰€æœ‰åŠ¨æ€key
            this.dar.materialKeys.forEach(function (key) {
              if (images[key]) {
                var imgData = images[key];
                var previewUrl = typeof imgData === 'string' ? (imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData)) : '';
                var img = new Image();
                img.onload = function () {
                  _this.$set(_this.dar.materials, key, {
                    previewUrl: previewUrl,
                    width: this.width,
                    height: this.height,
                    sizeText: this.width + 'Ã—' + this.height
                  });
                  _this.$forceUpdate();
                  _this.$nextTick(function () {
                    // è§¦å‘é‡ç»˜
                    _this.darRenderText();
                  });
                };
                img.src = previewUrl;
              }
            });
          },

          darRenderTextToCanvas: function (canvas, text, offset, scale, targetKey) {
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var baseStyle = this.dar.textStyle;
            var customStyle = targetKey && this.dar.customTextStyle[targetKey] ? this.dar.customTextStyle[targetKey] : null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!text) return;
            ctx.save();
            var fontSize = baseStyle.fontSize * scale;
            var fontWeight = (customStyle && customStyle.fontWeight) || 'normal';
            ctx.font = fontWeight + ' ' + fontSize + 'px ' + baseStyle.fontFamily;
            ctx.textAlign = baseStyle.textAlign;
            ctx.textBaseline = 'middle';
            var x = canvas.width / 2 + offset.x;
            var y = canvas.height / 2 + offset.y;

            if (customStyle && customStyle.multiShadow) {
              for (var i = 0; i < customStyle.multiShadow.length; i++) {
                var parts = customStyle.multiShadow[i].match(/([\d.-]+)px\s+([\d.-]+)px\s+([\d.-]+)px\s+([^\)]+(?:\([^\)]+\))?)/i);
                if (parts) {
                  ctx.shadowOffsetX = parseFloat(parts[1]);
                  ctx.shadowOffsetY = parseFloat(parts[2]);
                  ctx.shadowBlur = parseFloat(parts[3]);
                  ctx.shadowColor = parts[4].trim();
                  if (customStyle.gradient) {
                    var textMetrics = ctx.measureText(text);
                    var textHeight = fontSize;
                    var grad = ctx.createLinearGradient(x, y - textHeight / 2, x, y + textHeight / 2);
                    for (var j = 0; j < customStyle.gradient.colors.length; j++) {
                      grad.addColorStop(customStyle.gradient.positions[j], customStyle.gradient.colors[j]);
                    }
                    ctx.fillStyle = grad;
                  } else {
                    ctx.fillStyle = customStyle.fillColor || baseStyle.fillColor;
                  }
                  ctx.fillText(text, x, y);
                }
              }
              ctx.shadowOffsetX = 0;
              ctx.shadowOffsetY = 0;
              ctx.shadowBlur = 0;
            } else if (customStyle && customStyle.textShadow) {
              var shadowParts = customStyle.textShadow.match(/([\d.-]+)px\s+([\d.-]+)px\s+([\d.-]+)px\s+([^\)]+(?:\([^\)]+\))?)/i);
              if (shadowParts) {
                ctx.shadowOffsetX = parseFloat(shadowParts[1]);
                ctx.shadowOffsetY = parseFloat(shadowParts[2]);
                ctx.shadowBlur = parseFloat(shadowParts[3]);
                ctx.shadowColor = shadowParts[4].trim();
              }
            } else {
              ctx.shadowOffsetX = 0;
              ctx.shadowOffsetY = 0;
              ctx.shadowBlur = 0;
            }

            var strokeW = customStyle && customStyle.strokeWidth !== undefined ? customStyle.strokeWidth : (customStyle ? 0 : baseStyle.strokeWidth);
            if (strokeW > 0) {
              ctx.strokeStyle = (customStyle && customStyle.strokeColor) || baseStyle.strokeColor;
              ctx.lineWidth = strokeW * scale;
              ctx.lineJoin = 'round';
              ctx.strokeText(text, x, y);
            }

            if (customStyle && customStyle.gradient) {
              var textMetrics = ctx.measureText(text);
              var textHeight = fontSize;
              var gradient = ctx.createLinearGradient(x, y - textHeight / 2, x, y + textHeight / 2);
              for (var k = 0; k < customStyle.gradient.colors.length; k++) {
                gradient.addColorStop(customStyle.gradient.positions[k], customStyle.gradient.colors[k]);
              }
              ctx.fillStyle = gradient;
            } else {
              ctx.fillStyle = (customStyle && customStyle.fillColor) || baseStyle.fillColor;
            }
            ctx.fillText(text, x, y);
            ctx.restore();
          },

          darRenderText: function () {
            var _this = this;
            var canvases = this.$refs.darTextCanvas;
            if (!canvases || !Array.isArray(canvases)) return;

            this.dar.materialKeys.forEach(function (key, index) {
              // ç¡®ä¿Canvaså°ºå¯¸ä¸ç´ æåŒ¹é…
              var canvas = canvases[index];
              if (canvas && _this.dar.materials[key]) {
                if (canvas.width !== _this.dar.materials[key].width || canvas.height !== _this.dar.materials[key].height) {
                  canvas.width = _this.dar.materials[key].width;
                  canvas.height = _this.dar.materials[key].height;
                }
                _this.darRenderTextToCanvas(canvas, _this.dar.textInput1, _this.dar.textOffset, _this.dar.textScale, key);
              }
            });
          },

          darMoveText: function (direction) {
            switch (direction) {
              case 'up': this.dar.textOffset.y -= 1; break;
              case 'down': this.dar.textOffset.y += 1; break;
              case 'left': this.dar.textOffset.x -= 1; break;
              case 'right': this.dar.textOffset.x += 1; break;
            }
            this.darRenderText();
          },

          darScaleText: function (direction) {
            if (direction === 'up') this.dar.textScale += 0.1;
            else this.dar.textScale = Math.max(0.1, this.dar.textScale - 0.1);
            this.darRenderText();
          },

          darHandleWheel: function (e) {
            e.preventDefault();
            var delta = e.deltaY > 0 ? -0.05 : 0.05;
            this.dar.textScale = Math.max(0.1, Math.min(5, this.dar.textScale + delta));
            this.darRenderText();
          },

          darStartDragText: function (e) {
            this.dar.draggingText = true;
            this.dar.dragStartPos = { x: e.clientX, y: e.clientY };
            e.preventDefault();
          },

          darResetText: function () {
            this.dar.textInput1 = '';
            this.dar.textOffset = { x: 0, y: 0 };
            this.dar.textScale = 1;
            this.darRenderText();
          },

          darApplyText: function (key, index) {
            var canvases = this.$refs.darTextCanvas;
            if (!canvases || !canvases[index] || !this.dar.textInput1) { this.showToast('è¯·è¾“å…¥æ–‡å­—'); return; }
            var dataUrl = canvases[index].toDataURL('image/png');
            this.$set(this.dar.replacedImages, key, dataUrl);
            this.darApplyToSVGA(key, dataUrl);
            this.showToast('å·²åº”ç”¨åˆ° ' + key);
          },

          darApplyToSVGA: function (imageKey, dataUrl) {
            this.applyImageToSVGA(this.dar.svgaPlayer, imageKey, dataUrl);
          },

          darReplaceMaterial: function (key) {
            this.dar.currentReplaceTarget = key;
            this.$refs.darFileInput.click();
          },

          darHandleFileSelect: function (e) {
            var _this = this;
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (evt) {
              var dataUrl = evt.target.result;
              var key = _this.dar.currentReplaceTarget;
              var material = _this.dar.materials[key];
              if (material) {
                _this.darScaleImageToSize(dataUrl, material.width, material.height, function (scaledDataUrl) {
                  _this.$set(_this.dar.replacedImages, key, scaledDataUrl);
                  _this.darApplyToSVGA(key, scaledDataUrl);
                  _this.showToast('å·²æ›¿æ¢ ' + key);
                });
              }
            };
            reader.readAsDataURL(file);
            e.target.value = '';
          },

          darScaleImageToSize: function (dataUrl, width, height, callback) {
            var img = new Image();
            img.onload = function () {
              var canvas = document.createElement('canvas');
              canvas.width = width; canvas.height = height;
              var ctx = canvas.getContext('2d');
              var scale = Math.max(width / img.width, height / img.height);
              var scaledWidth = img.width * scale;
              var scaledHeight = img.height * scale;
              var x = (width - scaledWidth) / 2;
              var y = (height - scaledHeight) / 2;
              ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
              callback(canvas.toDataURL('image/png'));
            };
            img.src = dataUrl;
          },

          darDownloadMaterial: function (key) {
            var material = this.dar.materials[key];
            if (!material || !material.previewUrl) return;
            var a = document.createElement('a');
            a.href = material.previewUrl;
            a.download = key + '.png';
            a.click();
          },

          darRestoreMaterial: function (key) {
            this.$delete(this.dar.replacedImages, key);
            if (this.dar.currentFrame) this.loadDarSVGA(this.dar.currentFrame);
            this.showToast('å·²æ¢å¤ ' + key);
          },

          darExportSVGA: function () {
            this.dar.isExporting = true;
            var _this = this;
            this.exportSVGA(this.dar, this.dar.currentFrame.name);
            setTimeout(function () {
              _this.darExportFrame5PNG();
              _this.dar.isExporting = false;
            }, 50);
          },

          darExportFrame5PNG: function () {
            var _this = this;
            if (!_this.dar.svgaPlayer) return;
            _this.dar.svgaPlayer.pauseAnimation();
            _this.dar.svgaPlayer.stepToFrame(4);
            setTimeout(function () {
              var container = document.getElementById('darSvgaContainer');
              var canvas = container ? container.querySelector('canvas') : null;
              if (canvas) {
                var dataUrl = canvas.toDataURL('image/png');
                var a = document.createElement('a');
                a.href = dataUrl;
                a.download = _this.getTimestampFilename(_this.dar.currentFrame.name + '_frame5', 'png');
                a.click();
              }
              _this.dar.svgaPlayer.startAnimation();
            }, 100);
          },

          // ==================== åäººç¤¼ç‰©åŸºæœ¬æ¬¾æ–¹æ³• ====================
          loadGiftFrameList: function () {
            var _this = this;
            fetch('assets/mingren_gift_1photo/file-list.json')
              .then(function (res) { return res.json(); })
              .then(function (list) {
                _this.gift.frameList = list.map(function (item) {
                  return { name: item.name, svga: item.svga, icon: item.name + '.png' };
                });
                _this.gift.loading = false;
              })
              .catch(function () { _this.gift.frameList = []; _this.gift.loading = false; });
          },

          openGiftFrame: function (item) {
            if (this.gift.svgaPlayer) this.gift.svgaPlayer.clear();
            this.gift.currentFrame = item;
            this.gift.showModal = true;
            this.gift.materials = { zaky: null };
            this.gift.replacedImages = {};
            this.gift.croppedImageData = null;
            this.$nextTick(function () { this.loadGiftSVGA(item); }.bind(this));
          },

          closeGiftModal: function () {
            if (this.gift.isExporting || this.gift.isConvertingMP4) return;
            this.gift.showModal = false;
            if (this.gift.svgaPlayer) this.gift.svgaPlayer.clear();
            this.gift.currentFrame = null;
          },

          loadGiftSVGA: function (item) {
            this.loadSVGA(this.gift, item, 'giftSvgaContainer');
          },

          giftExtractMaterials: function (videoItem) {
            var _this = this;
            var images = videoItem.images || {};
            if (images['zaky']) {
              var imgData = images['zaky'];
              var previewUrl = typeof imgData === 'string' ? (imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData)) : '';
              var img = new Image();
              img.onload = function () {
                _this.gift.materials.zaky = { previewUrl: previewUrl, width: this.width, height: this.height, sizeText: this.width + 'Ã—' + this.height };
                _this.$forceUpdate();
              };
              img.src = previewUrl;
            }
          },

          giftApplyToSVGA: function (imageKey, dataUrl) {
            this.applyImageToSVGA(this.gift.svgaPlayer, imageKey, dataUrl);
          },

          giftReplaceMaterial: function (key) {
            this.gift.currentReplaceTarget = key;
            this.$refs.giftFileInput.click();
          },

          giftHandleFileSelect: function (e) {
            var _this = this;
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (evt) {
              var img = new Image();
              img.onload = function () {
                _this.gift.cropImage = img;
                _this.gift.showCropModal = true;
                _this.gift.cropImageScale = 1;
                _this.gift.cropImageOffset = { x: 0, y: 0 };
                _this.$nextTick(function () { _this.giftInitCropCanvas(); });
              };
              img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
          },

          giftInitCropCanvas: function () {
            var canvas = this.$refs.giftCropCanvas;
            if (!canvas) return;
            var container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            this.giftRenderCropCanvas();
            canvas.addEventListener('mousedown', this.giftStartCropDrag);
            canvas.addEventListener('wheel', this.giftHandleCropWheel);
          },

          giftRenderCropCanvas: function () {
            var canvas = this.$refs.giftCropCanvas;
            if (!canvas || !this.gift.cropImage) return;
            var ctx = canvas.getContext('2d');
            var cw = canvas.width, ch = canvas.height;
            ctx.clearRect(0, 0, cw, ch);
            var img = this.gift.cropImage;
            var scale = this.gift.cropImageScale;
            var offset = this.gift.cropImageOffset;
            var imgW = img.width * scale, imgH = img.height * scale;
            var imgX = (cw - imgW) / 2 + offset.x, imgY = (ch - imgH) / 2 + offset.y;
            ctx.drawImage(img, imgX, imgY, imgW, imgH);
            var cropW = 322, cropH = 423;
            var cropX = (cw - cropW) / 2, cropY = (ch - cropH) / 2;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, cw, cropY);
            ctx.fillRect(0, cropY, cropX, cropH);
            ctx.fillRect(cropX + cropW, cropY, cw - cropX - cropW, cropH);
            ctx.fillRect(0, cropY + cropH, cw, ch - cropY - cropH);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
            ctx.strokeRect(cropX, cropY, cropW, cropH);
            ctx.fillStyle = '#fff'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('322 Ã— 423', cw / 2, cropY - 10);
          },

          giftStartCropDrag: function (e) {
            this.gift.cropDragging = true;
            this.gift.cropDragStart = { x: e.clientX, y: e.clientY };
          },

          onDragMove: function (e) {
            if (this.dar.draggingText) {
              var dx = (e.clientX - this.dar.dragStartPos.x) / 1.2;
              var dy = (e.clientY - this.dar.dragStartPos.y) / 1.2;
              this.dar.textOffset.x += dx;
              this.dar.textOffset.y += dy;
              this.dar.dragStartPos = { x: e.clientX, y: e.clientY };
              this.darRenderText();
            }
            if (this.gift.cropDragging) {
              var dx2 = e.clientX - this.gift.cropDragStart.x;
              var dy2 = e.clientY - this.gift.cropDragStart.y;
              this.gift.cropImageOffset.x += dx2;
              this.gift.cropImageOffset.y += dy2;
              this.gift.cropDragStart = { x: e.clientX, y: e.clientY };
              this.giftRenderCropCanvas();
            }
            if (this.badge.dragging) {
              var dx3 = e.clientX - this.badge.dragStartPos.x;
              var dy3 = e.clientY - this.badge.dragStartPos.y;
              this.badge.genOffset.x += dx3;
              this.badge.genOffset.y += dy3;
              this.badge.dragStartPos = { x: e.clientX, y: e.clientY };
              this.badgeRenderCanvas();
            }
          },

          onDragEnd: function () {
            this.dar.draggingText = false;
            this.gift.cropDragging = false;
            this.badge.dragging = false;
          },

          giftHandleCropWheel: function (e) {
            e.preventDefault();
            var delta = e.deltaY > 0 ? -0.05 : 0.05;
            this.gift.cropImageScale = Math.max(0.1, Math.min(5, this.gift.cropImageScale + delta));
            this.giftRenderCropCanvas();
          },

          giftCloseCropModal: function () {
            this.gift.showCropModal = false;
            this.gift.cropImage = null;
            this.gift.cropImageScale = 1;
            this.gift.cropImageOffset = { x: 0, y: 0 };
          },

          giftConfirmCrop: function () {
            var _this = this;
            var canvas = this.$refs.giftCropCanvas;
            if (!canvas || !this.gift.cropImage) return;
            var cropCanvas = document.createElement('canvas');
            cropCanvas.width = 322; cropCanvas.height = 423;
            var cropCtx = cropCanvas.getContext('2d');
            var cw = canvas.width, ch = canvas.height;
            var cropX = (cw - 322) / 2, cropY = (ch - 423) / 2;
            var img = this.gift.cropImage;
            var scale = this.gift.cropImageScale;
            var offset = this.gift.cropImageOffset;
            var imgW = img.width * scale, imgH = img.height * scale;
            var imgX = (cw - imgW) / 2 + offset.x, imgY = (ch - imgH) / 2 + offset.y;
            var sx = (cropX - imgX) / scale, sy = (cropY - imgY) / scale;
            var sw = 322 / scale, sh = 423 / scale;
            cropCtx.drawImage(img, sx, sy, sw, sh, 0, 0, 322, 423);
            var croppedDataUrl = cropCanvas.toDataURL('image/png');
            this.gift.croppedImageData = croppedDataUrl;
            var key = this.gift.currentReplaceTarget;
            this.$set(this.gift.replacedImages, key, croppedDataUrl);
            this.giftApplyToSVGA(key, croppedDataUrl);
            this.giftGenerateIcon();
            this.giftCloseCropModal();
            this.showToast('å·²è£å‰ªå¹¶åº”ç”¨åˆ° ' + key);
          },

          giftGenerateIcon: function () {
            var _this = this;
            var canvas = this.$refs.giftIconCanvas;
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 300, 300);
            var loadCount = 0, colorImg = null, zakyImg = null, maskImg = null;
            function checkComplete() {
              loadCount++;
              if (loadCount === 3) drawIcon();
            }
            function drawIcon() {
              var maskedZakyCanvas = null;
              if (zakyImg) {
                var zakyW = 155.57, zakyH = 204.36;
                var tempCanvas = document.createElement('canvas');
                tempCanvas.width = 300; tempCanvas.height = 300;
                var tempCtx = tempCanvas.getContext('2d');
                var zakyX = 76.82, zakyY = 42.71;
                tempCtx.save();
                tempCtx.translate(zakyX + zakyW / 2, zakyY + zakyH / 2);
                tempCtx.rotate(15 * Math.PI / 180);
                tempCtx.drawImage(zakyImg, -zakyW / 2, -zakyH / 2, zakyW, zakyH);
                tempCtx.restore();
                if (maskImg) {
                  tempCtx.globalCompositeOperation = 'destination-in';
                  tempCtx.drawImage(maskImg, 0, 0, 300, 300);
                }
                maskedZakyCanvas = tempCanvas;
              }
              if (maskedZakyCanvas) ctx.drawImage(maskedZakyCanvas, 0, 0, 300, 300);
              if (colorImg) ctx.drawImage(colorImg, 0, 0, 300, 300);
            }
            if (this.gift.croppedImageData) {
              var zakyImage = new Image();
              zakyImage.onload = function () { zakyImg = zakyImage; checkComplete(); };
              zakyImage.onerror = checkComplete;
              zakyImage.src = this.gift.croppedImageData;
            } else { checkComplete(); }
            var maskImage = new Image();
            maskImage.onload = function () { maskImg = maskImage; checkComplete(); };
            maskImage.onerror = checkComplete;
            maskImage.src = 'assets/img/icon_musk.png';
            if (this.gift.currentFrame && this.gift.currentFrame.icon) {
              var colorImage = new Image();
              colorImage.onload = function () { colorImg = colorImage; checkComplete(); };
              colorImage.onerror = checkComplete;
              colorImage.src = 'assets/mingren_gift_1photo/' + this.gift.currentFrame.icon;
            } else { checkComplete(); }
          },

          giftDownloadMaterial: function (key) {
            var material = this.gift.materials[key];
            if (!material || !material.previewUrl) return;
            var a = document.createElement('a');
            a.href = material.previewUrl;
            a.download = key + '.png';
            a.click();
          },

          giftRestoreMaterial: function (key) {
            this.$delete(this.gift.replacedImages, key);
            this.gift.croppedImageData = null;
            if (this.gift.currentFrame) this.loadGiftSVGA(this.gift.currentFrame);
            var canvas = this.$refs.giftIconCanvas;
            if (canvas) canvas.getContext('2d').clearRect(0, 0, 300, 300);
            this.showToast('å·²æ¢å¤ ' + key);
          },

          giftExportIconPNG: function () {
            var canvas = this.$refs.giftIconCanvas;
            if (canvas) {
              var baseName = this.gift.currentFrame ? this.gift.currentFrame.name : 'icon';
              var filename = this.getTimestampFilename(baseName + '_icon', 'png');
              var dataUrl = canvas.toDataURL('image/png');
              var a = document.createElement('a');
              a.href = dataUrl; a.download = filename; a.click();
            }
          },

          giftExportAll: function () {
            this.gift.isExporting = true;
            try {
              this.giftExportSVGA();
              var _this = this;
              setTimeout(function () {
                _this.giftExportIconPNG();
                _this.gift.isExporting = false;
              }, 50);
            } catch (err) { this.gift.isExporting = false; }
          },

          giftExportSVGA: function () {
            this.exportSVGA(this.gift, this.gift.currentFrame.name);
          },

          giftExportMP4AndIcon: async function () {
            var _this = this;
            if (!this.gift.svgaVideoItem) { this.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¤¼ç‰©'); return; }
            this.gift.isExporting = true;
            try {
              this.giftExportIconPNG();
              await new Promise(function (r) { setTimeout(r, 50); });
              await this.giftConvertToMP4();
            } catch (err) {
              console.error('MP4å¯¼å‡ºé”™è¯¯:', err);
              this.showToast('MP4å¯¼å‡ºå¤±è´¥: ' + err.message);
            } finally {
              this.gift.isExporting = false;
            }
          },

          giftConvertToMP4: async function () {
            var _this = this;
            _this.gift.isConvertingMP4 = true;
            _this.gift.mp4ConvertProgress = 0;
            try {
              var width = _this.gift.svgaInfo.width || 0;
              var height = _this.gift.svgaInfo.height || 0;
              var fps = _this.gift.svgaInfo.fps || 30;
              if (width === 0 || height === 0) { _this.showToast('SVGAå°ºå¯¸ä¿¡æ¯é”™è¯¯'); _this.gift.isConvertingMP4 = false; return; }
              _this.gift.mp4ConvertStage = 'åŠ è½½è½¬æ¢å™¨'; _this.gift.mp4ConvertProgress = 5;
              await _this.giftLoadFFmpeg();
              _this.gift.mp4ConvertStage = 'æå–åºåˆ—å¸§'; _this.gift.mp4ConvertProgress = 15;
              var frames = await _this.giftExtractFrames(width, height);
              _this.gift.mp4ConvertStage = 'åˆæˆåŒé€šé“'; _this.gift.mp4ConvertProgress = 45;
              var dualFrames = await _this.giftComposeDualFrames(frames, width, height);
              _this.gift.mp4ConvertStage = 'ç¼–ç MP4'; _this.gift.mp4ConvertProgress = 70;
              var mp4Blob = await _this.giftEncodeMP4(dualFrames, width, height, fps);
              _this.gift.mp4ConvertProgress = 95;
              var baseName = _this.gift.currentFrame ? _this.gift.currentFrame.name : 'gift';
              var filename = _this.getTimestampFilename(baseName + '_dual', 'mp4');
              var url = URL.createObjectURL(mp4Blob);
              var a = document.createElement('a');
              a.href = url; a.download = filename; a.click();
              URL.revokeObjectURL(url);
              _this.gift.mp4ConvertProgress = 100;
              _this.showToast('MP4å¯¼å‡ºæˆåŠŸ');
            } catch (err) {
              console.error('MP4è½¬æ¢é”™è¯¯:', err);
              _this.showToast('MP4è½¬æ¢å¤±è´¥: ' + err.message);
            } finally {
              _this.gift.isConvertingMP4 = false;
              _this.gift.mp4ConvertStage = '';
              _this.gift.mp4ConvertProgress = 0;
            }
          },

          giftLoadFFmpeg: async function () {
            if (window.ffmpegInstance && window.ffmpegLoaded) return window.ffmpegInstance;
            if (!window.FFmpeg) {
              await new Promise(function (resolve, reject) {
                var script = document.createElement('script');
                script.src = 'assets/js/lib/ffmpeg.min.js';
                script.onload = resolve; script.onerror = reject;
                document.head.appendChild(script);
              });
            }
            var ffmpeg = window.FFmpeg.createFFmpeg({ log: false });
            await ffmpeg.load();
            window.ffmpegInstance = ffmpeg;
            window.ffmpegLoaded = true;
            return ffmpeg;
          },

          giftExtractFrames: async function (targetWidth, targetHeight) {
            var _this = this;
            var frames = [];
            var totalFrames = _this.gift.svgaVideoItem.frames;
            var player = _this.gift.svgaPlayer;
            var wasPlaying = !player.paused;
            if (wasPlaying) player.pauseAnimation();
            var container = document.getElementById('giftSvgaContainer');
            var canvas = container.querySelector('canvas');
            if (!canvas) throw new Error('æœªæ‰¾åˆ°SVGA canvaså…ƒç´ ');
            for (var i = 0; i < totalFrames; i++) {
              player.stepToFrame(i);
              await new Promise(function (r) { setTimeout(r, 16); });
              var tempCanvas = document.createElement('canvas');
              tempCanvas.width = targetWidth; tempCanvas.height = targetHeight;
              var ctx = tempCanvas.getContext('2d');
              ctx.imageSmoothingEnabled = false;
              ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
              var imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
              frames.push(imageData);
              if (i % 5 === 0) await new Promise(function (r) { setTimeout(r, 0); });
            }
            if (wasPlaying) player.startAnimation();
            else player.stepToFrame(0);
            return frames;
          },

          giftComposeDualFrames: async function (frames, width, height) {
            var dualFrames = [];
            for (var i = 0; i < frames.length; i++) {
              var dualCanvas = this.giftComposeDualChannel(frames[i]);
              dualFrames.push(dualCanvas);
              if (i % 5 === 0) await new Promise(function (r) { setTimeout(r, 0); });
            }
            return dualFrames;
          },

          giftComposeDualChannel: function (imageData) {
            var width = imageData.width, height = imageData.height;
            var dualCanvas = document.createElement('canvas');
            dualCanvas.width = width * 2; dualCanvas.height = height;
            var dualCtx = dualCanvas.getContext('2d', { alpha: true, willReadFrequently: true });
            dualCtx.imageSmoothingEnabled = false;
            dualCtx.clearRect(0, 0, width * 2, height);
            var leftData = dualCtx.createImageData(width, height);
            var rightData = dualCtx.createImageData(width, height);
            for (var i = 0; i < imageData.data.length; i += 4) {
              var r = imageData.data[i + 0], g = imageData.data[i + 1], b = imageData.data[i + 2], a = imageData.data[i + 3];
              var finalR = r, finalG = g, finalB = b;
              if (a > 0 && a < 255) {
                finalR = Math.min(255, Math.round(r * 255 / a));
                finalG = Math.min(255, Math.round(g * 255 / a));
                finalB = Math.min(255, Math.round(b * 255 / a));
              } else if (a === 0) { finalR = finalG = finalB = 0; }
              leftData.data[i + 0] = finalR; leftData.data[i + 1] = finalG; leftData.data[i + 2] = finalB; leftData.data[i + 3] = a;
              rightData.data[i + 0] = a; rightData.data[i + 1] = a; rightData.data[i + 2] = a; rightData.data[i + 3] = 255;
            }
            dualCtx.putImageData(leftData, 0, 0);
            dualCtx.putImageData(rightData, width, 0);
            return dualCanvas;
          },

          giftEncodeMP4: async function (dualFrames, width, height, fps) {
            var ffmpeg = window.ffmpegInstance;
            for (var i = 0; i < dualFrames.length; i++) {
              var canvas = dualFrames[i];
              var blackCanvas = document.createElement('canvas');
              blackCanvas.width = width * 2; blackCanvas.height = height;
              var blackCtx = blackCanvas.getContext('2d');
              var dualData = canvas.getContext('2d').getImageData(0, 0, width * 2, height);
              var blackData = blackCtx.createImageData(width * 2, height);
              for (var j = 0; j < dualData.data.length; j += 4) {
                blackData.data[j + 0] = dualData.data[j + 0];
                blackData.data[j + 1] = dualData.data[j + 1];
                blackData.data[j + 2] = dualData.data[j + 2];
                blackData.data[j + 3] = 255;
              }
              blackCtx.putImageData(blackData, 0, 0);
              var blob = await new Promise(function (resolve) { blackCanvas.toBlob(resolve, 'image/jpeg', 0.6); });
              var data = new Uint8Array(await blob.arrayBuffer());
              var filename = 'frame_' + String(i).padStart(4, '0') + '.jpg';
              ffmpeg.FS('writeFile', filename, data);
              if (i % 5 === 0) await new Promise(function (r) { setTimeout(r, 0); });
            }
            var args = ['-framerate', String(fps), '-i', 'frame_%04d.jpg', '-c:v', 'libx264', '-profile:v', 'high', '-level', '4.0', '-pix_fmt', 'yuv420p', '-crf', '23', '-preset', 'medium', '-movflags', '+faststart', '-an', 'output.mp4'];
            await ffmpeg.run.apply(ffmpeg, args);
            var mp4Data = ffmpeg.FS('readFile', 'output.mp4');
            var mp4Blob = new Blob([mp4Data.buffer], { type: 'video/mp4' });
            for (var k = 0; k < dualFrames.length; k++) {
              try { ffmpeg.FS('unlink', 'frame_' + String(k).padStart(4, '0') + '.jpg'); } catch (e) { }
            }
            try { ffmpeg.FS('unlink', 'output.mp4'); } catch (e) { }
            return mp4Blob;
          },

          // ==================== ç”¨æˆ·å‹‹ç« æ–¹æ³• ====================
          badgeLoadList: function () {
            var _this = this;
            // 1. åŠ è½½æœ¬åœ°å­˜å‚¨çš„è‡ªå®šä¹‰å‹‹ç« 
            var custom = [];
            try {
              var stored = localStorage.getItem('custom_badges');
              if (stored) custom = JSON.parse(stored);
            } catch (e) { console.error('åŠ è½½æœ¬åœ°å‹‹ç« å¤±è´¥', e); }
            this.badge.customList = custom;

            // 2. åŠ è½½xunzhangæ–‡ä»¶å¤¹é‡Œçš„é…ç½® (æš‚æœªæä¾›ï¼Œå…ˆç½®ç©ºæˆ–å°è¯•åŠ è½½)
            // å‡è®¾æœ‰ä¸ª assets/xunzhang/file-list.jsonï¼Œæ²¡æœ‰çš„è¯å°±åªæœ‰è‡ªå®šä¹‰
            this.badge.list = [];
            // åˆå¹¶æ˜¾ç¤º
            this.badgeUpdateList();
          },

          badgeUpdateList: function () {
            // åˆå¹¶ï¼šé¢„ç½®åˆ—è¡¨ + è‡ªå®šä¹‰åˆ—è¡¨
            // é¢„ç½®åˆ—è¡¨æš‚ä¸ºç©ºï¼Œåç»­å¯æ‰©å±•
            var defaultList = [];
            this.badge.list = defaultList.concat(this.badge.customList.map(function (item) {
              return {
                name: item.name,
                url: item.url,
                css: item.css,
                width: item.width,
                height: item.height,
                isCustom: true,
                id: item.id
              };
            }));
          },

          openBadgeAddModal: function () {
            this.badge.editingId = null;
            this.badge.addForm = {
              name: '',
              file: null,
              previewUrl: '',
              css: '',
              width: 0,
              height: 0
            };
            this.badge.showAddModal = true;
          },

          openBadgeEditModal: function (item) {
            this.badge.editingId = item.id;
            this.badge.addForm = {
              name: item.name,
              file: null, // ç¼–è¾‘æ—¶ä¸å¼ºåˆ¶é‡æ–°ä¸Šä¼ æ–‡ä»¶
              previewUrl: item.url,
              css: item.css || '',
              width: item.width,
              height: item.height
            };
            this.badge.showAddModal = true;
          },

          closeBadgeAddModal: function () {
            this.badge.showAddModal = false;
            this.badge.editingId = null;
          },

          badgeHandleFileSelect: function (e) {
            var file = e.target.files[0];
            this.badgeProcessFile(file);
            e.target.value = '';
          },

          badgeHandleDrop: function (e) {
            var file = e.dataTransfer.files[0];
            this.badgeProcessFile(file);
          },

          badgeProcessFile: function (file) {
            var _this = this;
            if (!file) return;

            // æ ¡éªŒï¼šæ˜¯å¦PNG
            if (file.type !== 'image/png') {
              this.showToast('åªæ”¯æŒPNGå›¾ç‰‡');
              return;
            }

            // æ ¡éªŒï¼šå¤§å°æ˜¯å¦è¶…è¿‡5M
            if (file.size > 5 * 1024 * 1024) {
              this.showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5M');
              return;
            }

            var reader = new FileReader();
            reader.onload = function (evt) {
              var img = new Image();
              img.onload = function () {
                // æ ¡éªŒï¼šå°ºå¯¸æ˜¯å¦è¶…è¿‡3000px
                if (img.width > 3000 || img.height > 3000) {
                  _this.showToast('å›¾ç‰‡å®½é«˜ä¸èƒ½è¶…è¿‡3000px');
                  return;
                }

                _this.badge.addForm.file = file;
                _this.badge.addForm.previewUrl = evt.target.result;
                _this.badge.addForm.width = img.width;
                _this.badge.addForm.height = img.height;

                // é»˜è®¤åç§°ä½¿ç”¨æ–‡ä»¶åï¼ˆå»æ‰©å±•åï¼‰
                if (!_this.badge.addForm.name) {
                  var name = file.name.replace(/\.[^/.]+$/, "");
                  _this.badge.addForm.name = name;
                }
              };
              img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
          },

          badgeSubmitAdd: function () {
            var form = this.badge.addForm;
            var _this = this;
            if ((!form.file && !form.previewUrl)) {
              this.showToast('è¯·ä¸Šä¼ å›¾ç‰‡');
              return;
            }

            // ç®€å•çš„CSSæ ¡éªŒ (éå¼ºåˆ¶ï¼Œä»…æç¤º)
            if (form.css && form.css.trim() !== '') {
              // è¿™é‡Œä¸åšä¸¥æ ¼æ ¡éªŒï¼Œç”¨æˆ·è´Ÿè´£ç²˜è´´æ­£ç¡®çš„CSS
            }

            if (this.badge.editingId) {
              // ç¼–è¾‘ç°æœ‰
              var index = this.badge.customList.findIndex(function (i) { return i.id === _this.badge.editingId; });
              if (index > -1) {
                var updatedItem = Object.assign({}, this.badge.customList[index], {
                  name: form.name || 'æœªå‘½åå‹‹ç« ',
                  url: form.previewUrl,
                  css: form.css,
                  width: form.width,
                  height: form.height,
                  // idå’Œtimestampä¿æŒä¸å˜
                });
                // Vueä¸èƒ½æ£€æµ‹ç´¢å¼•èµ‹å€¼ï¼Œä½¿ç”¨splice
                this.badge.customList.splice(index, 1, updatedItem);
                this.showToast('ä¿®æ”¹æˆåŠŸ');
              }
            } else {
              // æ–°å¢
              var newItem = {
                id: Date.now(),
                name: form.name || 'æœªå‘½åå‹‹ç« ',
                url: form.previewUrl, // å­˜Base64åˆ°æœ¬åœ°
                css: form.css,
                width: form.width,
                height: form.height,
                timestamp: Date.now()
              };
              this.badge.customList.push(newItem);
              this.showToast('æ·»åŠ æˆåŠŸ');
            }

            this.badgeSaveCustomList();
            this.badgeUpdateList();
            this.closeBadgeAddModal();
          },

          badgeSaveCustomList: function () {
            try {
              localStorage.setItem('custom_badges', JSON.stringify(this.badge.customList));
            } catch (e) {
              if (e.name === 'QuotaExceededError') {
                this.showToast('æœ¬åœ°å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œæ— æ³•ä¿å­˜æ›´å¤šå‹‹ç« ');
              } else {
                console.error(e);
              }
            }
          },

          deleteBadge: function (item) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‹‹ç« å—ï¼Ÿ')) return;
            var index = this.badge.customList.findIndex(function (i) { return i.id === item.id; });
            if (index > -1) {
              this.badge.customList.splice(index, 1);
              this.badgeSaveCustomList();
              this.badgeUpdateList();
              this.showToast('å·²åˆ é™¤');
            }
          },

          openBadgeGenModal: function (item) {
            this.badge.current = item;
            this.badge.genText = '';
            this.badge.genOffset = { x: 0, y: 0 };
            this.badge.genScale = 1;
            this.badge.showGenModal = true;
            this.badge.cachedImage = null;

            var img = new Image();
            var _this = this;
            img.onload = function () {
              _this.badge.cachedImage = img;
              _this.$nextTick(function () {
                _this.badgeRenderCanvas();
              });
            };
            img.src = item.url;
          },

          closeBadgeGenModal: function () {
            this.badge.showGenModal = false;
            this.badge.current = null;
            this.badge.cachedImage = null;
          },

          badgeStartDrag: function (e) {
            this.badge.dragging = true;
            this.badge.dragStartPos = { x: e.clientX, y: e.clientY };
            e.preventDefault();
          },

          badgeHandleWheel: function (e) {
            e.preventDefault();
            var delta = e.deltaY > 0 ? -0.1 : 0.1;
            this.badge.genScale = Math.max(0.1, Math.min(5, this.badge.genScale + delta));
            this.badgeRenderCanvas();
          },

          badgeRenderCanvas: function () {
            var canvas = this.$refs.badgeCanvas;
            if (!canvas || !this.badge.current || !this.badge.cachedImage) return;
            var item = this.badge.current;

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸ºå›¾ç‰‡å°ºå¯¸
            if (canvas.width !== item.width || canvas.height !== item.height) {
              canvas.width = item.width;
              canvas.height = item.height;
              // è°ƒæ•´å¤–å±‚å®¹å™¨æ ·å¼ä»¥é€‚åº”
              var wrapper = canvas.parentElement;
              var preview = wrapper.parentElement;
              var scale = Math.min(preview.clientWidth / item.width, preview.clientHeight / item.height, 1) * 0.9;
              wrapper.style.transform = 'scale(' + scale + ')';
              wrapper.style.transformOrigin = 'center center';
            }

            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.drawImage(this.badge.cachedImage, 0, 0);

            // ç»˜åˆ¶æ–‡å­—
            if (this.badge.genText) {
              this.badgeDrawText(ctx, item.width, item.height);
            }
          },

          badgeDrawText: function (ctx, width, height) {
            var text = this.badge.genText;
            var offset = this.badge.genOffset;
            var scale = this.badge.genScale;
            var customCss = this.badge.current.css;

            ctx.save();

            // é»˜è®¤æ ·å¼
            var fontSize = 24 * scale;
            var fontFamily = "'Noto Sans', 'Noto Sans SC', sans-serif";
            var fillColor = '#ffffff';
            var strokeColor = '#000000';
            var strokeWidth = 0; // é»˜è®¤æè¾¹å®½åº¦æ”¹ä¸º0
            var hasStroke = false; // æ ‡è®°æ˜¯å¦æœ‰æ˜¾å¼æè¾¹

            // å°è¯•è§£æCSS
            // å¢å¼ºCSSè§£æï¼Œæ”¯æŒæ¸å˜è‰² background-image/background 
            var gradient = null;

            if (customCss) {
              // æå–é¢œè‰²
              var colorMatch = customCss.match(/color:\s*([^;]+)/i);
              if (colorMatch) fillColor = colorMatch[1];

              // æå–å­—ä½“å¤§å° (åŸºäºé»˜è®¤24pxç¼©æ”¾)
              var sizeMatch = customCss.match(/font-size:\s*([\d.]+)px/i);
              if (sizeMatch) fontSize = parseFloat(sizeMatch[1]) * scale;

              // æå–å­—ä½“
              var fontMatch = customCss.match(/font-family:\s*([^;]+)/i);
              if (fontMatch) fontFamily = fontMatch[1];

              // æå–æè¾¹
              var strokeMatch = customCss.match(/-webkit-text-stroke:\s*([\d.]+)px\s*([^;]+)/i);
              if (strokeMatch) {
                strokeWidth = parseFloat(strokeMatch[1]) * scale;
                strokeColor = strokeMatch[2];
                hasStroke = true;
              }

              // æå–æ¸å˜è‰²
              // background: linear-gradient(180deg, #FFF1A2 0%, #FFFFFF 50%, #FFF1A2 72.12%, #FFBE32 100%);
              var bgMatch = customCss.match(/background:\s*linear-gradient\(([\d]+)deg,\s*(.+)\)/i);
              if (bgMatch) {
                var angle = parseInt(bgMatch[1]); // 180deg
                var stopsStr = bgMatch[2];

                // ç®€å•çš„æ¸å˜æ–¹å‘è®¡ç®— (ä»…æ”¯æŒ0, 90, 180, 270ç­‰ç®€å•æƒ…å†µï¼Œè¿™é‡Œé’ˆå¯¹180degåšå‚ç›´æ¸å˜)
                // Canvasæ¸å˜åæ ‡: x0, y0, x1, y1
                var x0 = x, y0 = y - fontSize / 2, x1 = x, y1 = y + fontSize / 2; // é»˜è®¤180deg (ä»ä¸Šåˆ°ä¸‹)

                if (angle === 90) { // ä»å·¦åˆ°å³
                  x0 = x - width / 2; y0 = y; x1 = x + width / 2; y1 = y;
                }

                // åˆ›å»ºæ¸å˜å¯¹è±¡
                // ç”±äºæ–‡å­—å®½åº¦æœªçŸ¥ï¼Œè¿™é‡Œåªèƒ½ä¼°ç®—æˆ–è€…å…ˆmeasureText
                // ä¸ºäº†æ›´ç²¾ç¡®ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢measureTextä¹‹åå†åˆ›å»ºgradient
                // è¿™é‡Œå…ˆè§£æé¢œè‰²ç‚¹
                var stops = [];
                // ç®€å•çš„åˆ†å‰²ï¼Œå‡è®¾é¢œè‰²å’Œç™¾åˆ†æ¯”ä¹‹é—´æœ‰ç©ºæ ¼ï¼Œé€—å·åˆ†éš”
                // #FFF1A2 0%, #FFFFFF 50% ...
                // æ­£åˆ™æå–: (#[\w\d]+|rgba?\(.+?\))\s*([\d.]+)%
                var stopRegex = /(#[\w\d]+|rgba?\(.+?\))\s*([\d.]+)%/g;
                var stopMatch;
                while ((stopMatch = stopRegex.exec(stopsStr)) !== null) {
                  stops.push({
                    color: stopMatch[1],
                    pos: parseFloat(stopMatch[2]) / 100
                  });
                }

                if (stops.length > 0) {
                  gradient = {
                    angle: angle,
                    stops: stops
                  };
                }
              }
            }

            ctx.font = 'bold ' + fontSize + 'px ' + fontFamily;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            var x = width / 2 + offset.x;
            var y = height / 2 + offset.y;

            // å¦‚æœæœ‰æ¸å˜ï¼Œéœ€è¦åŸºäºæ–‡å­—å®é™…é«˜åº¦åˆ›å»ºCanvasGradient
            if (gradient) {
              // ä¼°ç®—æ–‡å­—é«˜åº¦åŒºåŸŸ
              var textTop = y - fontSize / 2;
              var textBottom = y + fontSize / 2;
              var grd = ctx.createLinearGradient(x, textTop, x, textBottom); // é»˜è®¤180deg

              gradient.stops.forEach(function (s) {
                grd.addColorStop(s.pos, s.color);
              });
              fillColor = grd;
            }

            // å¤„ç†é˜´å½± (text-shadow)
            if (customCss) {
              var shadowMatch = customCss.match(/text-shadow:\s*([^;]+)/i);
              if (shadowMatch) {
                var shadowsStr = shadowMatch[1];
                // å¤æ‚çš„é˜´å½±åˆ†å‰²é€»è¾‘ï¼Œå› ä¸ºrgbaä¸­ä¹ŸåŒ…å«é€—å·
                // ç®€å•çš„æŒ‰é€—å·åˆ†å‰²ä¼šåˆ‡æ–­rgba
                // ç­–ç•¥ï¼šæŒ‰ "px" åçš„é€—å·æˆ–è€… ") " åçš„é€—å·åˆ†å‰²
                // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ ˆç­–ç•¥æˆ–è€…æ­£åˆ™æ›¿æ¢ä¿æŠ¤æ¥å¤„ç†

                // å…ˆå°† rgba(...) ä¸­çš„é€—å·ä¸´æ—¶æ›¿æ¢ä¸ºå ä½ç¬¦
                var tempStr = shadowsStr.replace(/rgba?\([^)]+\)/gi, function (match) {
                  return match.replace(/,/g, '|');
                });

                var shadows = tempStr.split(',').map(function (s) {
                  return s.replace(/\|/g, ',').trim();
                });

                // Canvasåªæ”¯æŒå•å±‚shadowï¼Œå¦‚æœæœ‰å¤šä¸ªï¼Œåªèƒ½ç”»å¤šæ¬¡
                // æ³¨æ„ï¼šCanvasçš„shadowæ˜¯åŸºäºç»˜åˆ¶å†…å®¹çš„ï¼Œå¦‚æœè¿ç»­ç”»å¤šæ¬¡å¸¦shadowçš„æ–‡å­—ï¼Œæ–‡å­—æœ¬èº«ä¹Ÿä¼šé‡å å˜ç²—
                // æ­£ç¡®çš„å¤šé‡é˜´å½±ç»˜åˆ¶æ–¹æ³•ï¼š
                // 1. å…ˆç»˜åˆ¶æœ€åº•å±‚çš„é˜´å½±ï¼ˆæ–‡å­—é¢œè‰²è®¾ä¸ºé€æ˜ï¼Œåªç•™é˜´å½±ï¼‰-> è¿™ä¸€æ­¥Canvasæ¯”è¾ƒéš¾ç›´æ¥åšï¼Œå› ä¸ºshadowä¾é™„äºå®ä½“
                // 2. æˆ–è€…ï¼šæ¯å±‚é˜´å½±éƒ½å®Œæ•´ç»˜åˆ¶ä¸€éæ–‡å­—

                shadows.forEach(function (shadow) {
                  // è§£æé˜´å½±å‚æ•°: x y blur color
                  // å¯èƒ½æ ¼å¼: 0px 2px 1px rgba(0,0,0,0.5) æˆ– rgba(0,0,0,0.5) 0px 2px 1px
                  // ç®€å•èµ·è§ï¼Œå‡è®¾ px åœ¨å‰
                  var pxMatches = shadow.match(/([-\d.]+)px\s+([-\d.]+)px\s+([-\d.]+)px/);
                  var colorMatch = shadow.match(/(#[\w\d]+|rgba?\([^)]+\))/);

                  if (pxMatches && colorMatch) {
                    ctx.save();
                    ctx.shadowOffsetX = parseFloat(pxMatches[1]);
                    ctx.shadowOffsetY = parseFloat(pxMatches[2]);
                    ctx.shadowBlur = parseFloat(pxMatches[3]);
                    ctx.shadowColor = colorMatch[1];

                    // å…³é”®ï¼šä¸ºäº†åªç”»é˜´å½±ä¸åŠ æ·±æ–‡å­—ï¼Œæˆ–è€…ä¸ºäº†æ”¯æŒå¤šé‡é˜´å½±çš„å±‚å æ•ˆæœ
                    // è¿™é‡Œçš„ç­–ç•¥æ˜¯ï¼šæ¯ä¸€å±‚é˜´å½±éƒ½ç”»ä¸€éæ–‡å­—
                    // å¦‚æœfillColoræ˜¯æ¸å˜ï¼Œå¤šæ¬¡ç»˜åˆ¶å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜æˆ–æ•ˆæœåå·®ï¼Œä½†åœ¨Canvasé‡Œè¿™æ˜¯æ ‡å‡†åšæ³•
                    ctx.fillStyle = fillColor;
                    ctx.fillText(text, x, y);
                    ctx.restore();
                  }
                });

                // é˜´å½±ç»˜åˆ¶å®Œåï¼Œæœ€åå†ç»˜åˆ¶ä¸€æ¬¡ä¸å¸¦é˜´å½±çš„ä¸»ä½“æ–‡å­—ï¼ˆè¦†ç›–åœ¨é˜´å½±ä¹‹ä¸Šï¼‰
                // è¿™æ ·å¯ä»¥ç¡®ä¿æ–‡å­—æ¸…æ™°ï¼Œä¸”é¿å…é˜´å½±ç»˜åˆ¶æ—¶çš„æ–‡å­—é‡å å¯¼è‡´è¾¹ç¼˜é”¯é½¿
                // ä½†æ˜¯ï¼Œä¸Šé¢çš„forEachå·²ç»ç”»äº†å¤šæ¬¡æ–‡å­—æœ¬èº«äº†ï¼ˆè™½ç„¶æ˜¯ä¸ºäº†é˜´å½±ï¼‰
                // ä¼˜åŒ–ï¼šå…¶å®Canvasçš„shadowç»˜åˆ¶æ—¶ï¼Œæ˜¯å…ˆç”»é˜´å½±å†ç”»å®ä½“çš„ã€‚
                // å¦‚æœç”»å¤šæ¬¡ï¼Œå®ä½“ä¼šå åŠ ã€‚
                // æŠ€å·§ï¼šå°†globalCompositeOperationè®¾ä¸ºdestination-over (åœ¨ä¸‹æ–¹ç»˜åˆ¶) ? ä¸è¡Œï¼Œå› ä¸ºé˜´å½±ä¹Ÿæ˜¯é€šè¿‡fillTextè§¦å‘çš„
                // 
                // æ›´å¥½çš„å¤šé‡é˜´å½±æ¨¡æ‹Ÿï¼š
                // å€’åºç»˜åˆ¶é˜´å½±ï¼Ÿä¸ï¼Œé˜´å½±é€šå¸¸åœ¨æ–‡å­—ä¸‹æ–¹ã€‚
                // æˆ‘ä»¬çš„shadowsæ•°ç»„é€šå¸¸æ˜¯ç¬¬ä¸€å±‚æœ€æ¥è¿‘æ–‡å­—ã€‚
                // 
                // æœ€ç»ˆç­–ç•¥ï¼š
                // 1. ä¸åœ¨å¾ªç¯é‡Œç”»ï¼Œå¾ªç¯åªæ”¶é›†é…ç½®
                // 2. å®é™…ä¸ŠCanvas APIä¸æ”¯æŒä¸€æ¬¡è®¾ç½®å¤šé‡é˜´å½±
                // 3. æ‰€ä»¥å¿…é¡»å¤šæ¬¡è°ƒç”¨fillText
                // 4. ä¸ºäº†é¿å…å®ä½“æ–‡å­—å¤šæ¬¡å åŠ å˜è‰²ï¼ˆç‰¹åˆ«æ˜¯åŠé€æ˜é¢œè‰²æ—¶ï¼‰ï¼Œåº”è¯¥ï¼š
                //    æ¯æ¬¡ç»˜åˆ¶é˜´å½±æ—¶ï¼Œå°† fillStyle è®¾ä¸ºå…¨é€æ˜ï¼Ÿä¸è¡Œï¼Œå…¨é€æ˜æ–‡å­—æ²¡æœ‰é˜´å½±ã€‚
                //    æ­£ç¡®åšæ³•ï¼šåœ¨ç¦»å±Canvasæˆ–è€…ä¸´æ—¶ä½ç½®ç»˜åˆ¶é˜´å½±ï¼Œæˆ–è€…...
                //    
                //    **ç®€å•æœ‰æ•ˆçš„æ–¹æ³•**ï¼š
                //    å¾ªç¯ç»˜åˆ¶æ‰€æœ‰é˜´å½±ï¼š
                //      ctx.shadowColor = ...; ctx.fillText(...);
                //    æœ€åç»˜åˆ¶ä¸€æ¬¡æ— é˜´å½±çš„å®ä½“æ–‡å­—ï¼š
                //      ctx.shadowColor = 'transparent'; ctx.fillText(...);
                //    
                //    ä½†æ˜¯æ¯æ¬¡fillTextéƒ½ä¼šæŠŠæ–‡å­—å®ä½“ç”»ä¸Šå»ã€‚å¦‚æœæ–‡å­—æ˜¯ä¸é€æ˜çš„ï¼Œå¤šå±‚å åŠ æ²¡é—®é¢˜ï¼ˆé™¤äº†è¾¹ç¼˜å¯èƒ½é”¯é½¿ï¼‰ã€‚
                //    å¦‚æœæ–‡å­—æ˜¯åŠé€æ˜æˆ–æ¸å˜ï¼Œå åŠ ä¼šå˜è‰²ã€‚
                //    
                //    é’ˆå¯¹æœ¬éœ€æ±‚ï¼ˆé€šå¸¸å‹‹ç« æ–‡å­—ä¸é€æ˜ï¼‰ï¼Œç›´æ¥å¤šæ¬¡ç»˜åˆ¶å³å¯ã€‚
                //    ä¸ºäº†ä¿è¯æœ€åæ–‡å­—é¢œè‰²æ­£ç¡®ï¼Œæˆ‘ä»¬åœ¨å¾ªç¯ç»“æŸåï¼Œæ¸…é™¤é˜´å½±ï¼Œå†ç”»ä¸€æ¬¡â€œçº¯å‡€â€çš„æ–‡å­—ã€‚
                return; // ä¸­æ–­åç»­çš„é»˜è®¤ç»˜åˆ¶ï¼Œæ”¹ç”±è¿™é‡Œæ¥ç®¡
              }
            }

            // å¦‚æœæ²¡æœ‰é˜´å½±é€»è¾‘æ¥ç®¡ï¼Œæˆ–è€…æ²¡æœ‰é˜´å½±ï¼Œèµ°ä¸‹é¢çš„æ™®é€šç»˜åˆ¶

            // æè¾¹
            if (hasStroke) {
              ctx.strokeStyle = strokeColor;
              ctx.lineWidth = strokeWidth;
              ctx.lineJoin = 'round';
              ctx.strokeText(text, x, y);
            }

            // å¡«å……
            ctx.fillStyle = fillColor;
            ctx.fillText(text, x, y);

            ctx.restore();
          },

          badgeExport: function () {
            var canvas = this.$refs.badgeCanvas;
            if (!canvas) return;
            var name = this.badge.current.name || 'badge';
            var filename = this.getTimestampFilename(name, 'png');
            var dataUrl = canvas.toDataURL('image/png');
            var a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            a.click();
          }
        }
      });
    </script>
</body>

</html>