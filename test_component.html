<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>测试 DualChannelPanel 组件</title>
  <style>
    /* 基础样式 - 所有侧边弹窗共有属性 */
    .side-panel {
      position: fixed;
      top: 0;
      height: 85%;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      padding: 10px;
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 默认状态：飞出去位置 */
    .side-panel--right {
      right: -400px;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 显示状态：默认位置 */
    .side-panel--right.show {
      right: 0;
    }

    /* 容器样式 - 所有弹窗容器共有属性 */
    .side-panel-container {
      display: flex;
      flex-direction: column;
      align-self: stretch;
      padding: 20px;
      gap: 16px;
      width: 380px;
      background: #FFFFFF;
      border: 1px solid #e6e6e6;
      box-shadow: none;
      border-radius: 16px;
      overflow-y: auto;
      transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .side-panel.show .side-panel-container {
      box-shadow: 0px 10px 32px 0px rgba(51, 51, 51, 0.2);
    }

    /* 面板标题样式 */
    .side-panel-header {
      display: flex;
      flex-direction: column;
      align-self: stretch;
      gap: 12px;
      cursor: move;
      user-select: none;
    }

    .side-panel-title {
      font-family: 'Segoe UI', sans-serif;
      font-weight: 400;
      font-size: 12px;
      line-height: 16px;
      color: #818181;
      margin: 0;
    }

    .side-panel-divider {
      width: 100%;
      height: 1px;
      background: #F3F3F3;
    }

    /* 面板页脚样式 */
    .side-panel-footer {
      margin-top: auto;
      display: flex;
      flex-direction: row;
      justify-content: flex-end;
      gap: 12px;
    }

    /* 双通道MP4面板特有样式 */
    .dual-channel-panel {
      width: 400px;
    }

    /* 按钮样式 */
    .btn {
      padding: 8px 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
    }

    .btn-primary {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    /* 测试控制区域 */
    .test-controls {
      margin: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>测试 DualChannelPanel 组件</h1>
  
  <!-- 测试控制区域 -->
  <div class="test-controls">
    <h2>测试控制</h2>
    <button id="togglePanel" class="btn btn-primary">切换双通道MP4面板</button>
    <button id="checkState" class="btn">检查组件状态</button>
  </div>

  <!-- 双通道MP4面板模板 -->
  <script type="text/x-template" id="tpl-dual-channel-panel">
    <div class="side-panel side-panel--right dual-channel-panel" :class="{'show': visible}">
      <div class="side-panel-container">
        <!-- 标题区 -->
        <div class="side-panel-header">
          <h3 class="side-panel-title">转换为双通道MP4格式</h3>
          <div class="side-panel-divider"></div>
        </div>

        <!-- 信息区 -->
        <div class="mp4-info-section">
          <div class="mp4-info-row">{{ sourceInfo.typeLabel }}尺寸：{{ sourceInfo.sizeWH }} 时长：{{ sourceInfo.duration }}</div>
          <div class="mp4-compress-hint">注意：第一次转换需要加载FFmpeg（25M），请耐心等待<br>压缩质量调越低，文件就越小，画面越糊。</div>
        </div>

        <!-- 配置区域 -->
        <div class="mp4-config-section" :class="{disabled: isConverting}">
          <!-- 遮罩位置 -->
          <div class="mp4-config-item">
            <div class="mp4-config-label">遮罩位置：</div>
            <div class="mp4-select-wrapper" :class="{open: showChannelModeDropdown, disabled: isConverting}"
              @click="!isConverting && toggleChannelModeDropdown()">
              <div class="mp4-select-text">
                {{ config.channelMode === 'color-left-alpha-right' ? '左彩右灰' : '左灰右彩' }}
              </div>
              <div class="mp4-select-icon">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round" />
                </svg>
              </div>
              <!-- 下拉菜单 -->
              <div class="mp4-select-dropdown">
                <div class="mp4-select-option" :class="{selected: config.channelMode === 'color-left-alpha-right'}"
                  @click.stop="selectChannelMode('color-left-alpha-right')">
                  左彩右灰（左侧彩色通道，右侧Alpha通道）
                </div>
                <div class="mp4-select-option" :class="{selected: config.channelMode === 'alpha-left-color-right'}"
                  @click.stop="selectChannelMode('alpha-left-color-right')">
                  左灰右彩（左侧Alpha通道，右侧彩色通道）
                </div>
              </div>
            </div>
          </div>

          <!-- 尺寸 -->
          <div class="mp4-config-item">
            <div class="mp4-config-label">尺寸：</div>
            <div class="mp4-size-container">
              <div class="input-wrapper input-wrapper--lg mp4-size-input-wrapper">
                <input type="number" class="base-input" v-model.number="config.width" @input="onWidthChange"
                  :disabled="isConverting" min="0" max="3000" />
              </div>
              <div class="mp4-size-lock">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M4.66667 7.33333V5.33333C4.66667 3.86057 5.86057 2.66667 7.33333 2.66667H8.66667C10.1394 2.66667 11.3333 3.86057 11.3333 5.33333V7.33333M5.33333 7.33333H10.6667C11.403 7.33333 12 7.93029 12 8.66667V12C12 12.7364 11.403 13.3333 10.6667 13.3333H5.33333C4.59695 13.3333 4 12.7364 4 12V8.66667C4 7.93029 4.59695 7.33333 5.33333 7.33333Z"
                    stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
              <div class="input-wrapper input-wrapper--lg mp4-size-input-wrapper">
                <input type="number" class="base-input" v-model.number="config.height" @input="onHeightChange"
                  :disabled="isConverting" min="0" max="3000" />
              </div>
            </div>
          </div>

          <!-- 压缩到质量 -->
          <div class="mp4-config-item">
            <div class="mp4-config-label">压缩到质量：</div>
            <div class="mp4-value-container">
              <div class="input-wrapper input-wrapper--lg mp4-value-input-wrapper">
                <input type="number" class="base-input" v-model.number="config.quality" :disabled="isConverting"
                  min="1" max="100" />
              </div>
              <div class="input-unit">%</div>
            </div>
          </div>

          <!-- 帧率修改 -->
          <div class="mp4-config-item">
            <div class="mp4-config-label">帧率修改：</div>
            <div class="mp4-value-container">
              <div class="input-wrapper input-wrapper--lg mp4-value-input-wrapper">
                <input type="number" class="base-input" v-model.number="config.fps" :disabled="isConverting"
                  min="1" max="120" />
              </div>
              <div class="input-unit">FPS</div>
            </div>
          </div>

          <!-- 静音 -->
          <div class="mp4-config-item">
            <div class="mp4-config-label">静音</div>
            <div class="mp4-mute-toggle" :class="{active: config.muted, disabled: isConverting}"
              @click="!isConverting && (config.muted = !config.muted)">
              <div class="mp4-mute-toggle-handle"></div>
            </div>
          </div>
        </div>

        <!-- 底部按钮 -->
        <div class="side-panel-footer">
          <!-- 返回按钮（转换中变为取消按钮） -->
          <button v-if="!isConverting" class="material-btn-back" @click="close" title="返回">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M12 16L6 10L12 4" stroke="#333333" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            <span>取消</span>
          </button>
          <button v-else class="material-btn-back mp4-btn-cancel" @click="cancel" title="取消转换">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M5 5L15 15M15 5L5 15" stroke="#ff4444" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            <span>取消</span>
          </button>

          <!-- 转换按钮 -->
          <button class="btn-large-secondary" :class="{mp4-btn-converting: isConverting}"
            :data-progress="progress" :disabled="disabled" @click="start">
            <template v-if="isConverting">
              <span class="mp4-progress-text">{{ progress }}%</span>
              <span class="mp4-stage-text">{{ message }}</span>
            </template>
            <template v-else>
              开始转换双通道MP4
            </template>
          </button>
        </div>
      </div>
    </div>
  </script>

  <!-- 挂载点 -->
  <div id="app">
    <dual-channel-panel 
      :visible="showDualChannelPanel" 
      :source-info="dualChannelSourceInfo" 
      :initial-config="dualChannelConfig"
      :is-converting="isConvertingToDualChannel"
      :progress="dualChannelProgress"
      :message="dualChannelMessage"
      :disabled="isGlobalTaskRunning"
      @close="closeDualChannelPanel"
      @cancel="cancelDualChannelConversion"
      @convert="handleDualChannelConvert"
    ></dual-channel-panel>
  </div>

  <!-- 引入 Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

  <!-- 双通道MP4面板组件 -->
  <script>
    // 双通道MP4转换配置面板组件
    Vue.component('dual-channel-panel', {
      name: 'DualChannelPanel',
      template: '#tpl-dual-channel-panel',
      props: {
        // 面板可见性
        visible: { type: Boolean, default: false },
        // 源文件信息
        sourceInfo: { type: Object, default: function () { return {}; } },
        // 初始配置
        initialConfig: { type: Object, default: function () { return null; } },
        // 是否正在转换
        isConverting: { type: Boolean, default: false },
        // 转换进度
        progress: { type: Number, default: 0 },
        // 转换状态消息
        message: { type: String, default: '' },
        // 是否禁用
        disabled: { type: Boolean, default: false }
      },
      mounted: function () {
        console.log('DualChannelPanel组件已挂载', this.visible);
      },
      watch: {
        // 面板打开时初始化参数
        visible: function (newVal) {
          console.log('DualChannelPanel visible变化:', newVal);
          if (newVal) {
            this.initParams();
            console.log('DualChannelPanel初始化参数完成');
          }
        }
      },
      data: function () {
        return {
          // 内部配置对象
          config: {
            channelMode: 'color-left-alpha-right',
            width: 300,
            height: 300,
            fps: 30,
            quality: 80,
            muted: false
          },
          // 下拉菜单状态
          showChannelModeDropdown: false
        };
      },
      methods: {
        /**
         * 初始化转换参数
         */
        initParams: function () {
          var source = this.sourceInfo;

          // 1. 尺寸初始化
          if (this.initialConfig && this.initialConfig.width > 0) {
            this.config.width = this.initialConfig.width;
            if (this.initialConfig.height > 0) {
              var ratio = this.initialConfig.height / this.initialConfig.width;
              this.config.height = Math.floor(this.config.width * ratio);
            } else if (source.width && source.height) {
              var ratio = source.height / source.width;
              this.config.height = Math.floor(this.config.width * ratio);
            }
          } else if (source.width && source.height) {
            this.config.width = source.width;
            this.config.height = source.height;
          } else {
            this.config.width = 300;
            this.config.height = 300;
          }

          // 2. 帧率初始化
          if (this.initialConfig && this.initialConfig.fps) {
            this.config.fps = this.initialConfig.fps;
          } else if (source.fps) {
            this.config.fps = Math.min(60, Math.max(1, source.fps));
          } else {
            this.config.fps = 30;
          }

          // 3. 其他配置初始化
          if (this.initialConfig) {
            this.config.quality = this.initialConfig.quality || 80;
            this.config.muted = this.initialConfig.muted || false;
            this.config.channelMode = this.initialConfig.channelMode || 'color-left-alpha-right';
          }
        },

        /**
         * 关闭面板
         */
        close: function () {
          if (this.isConverting) {
            if (!confirm('正在转换中，确定要取消吗？')) {
              return;
            }
            this.$emit('cancel');
          }
          this.$emit('close');
        },

        /**
         * 宽度变化处理
         */
        onWidthChange: function () {
          var source = this.sourceInfo;
          if (!source.width || !source.height) return;

          var ratio = source.height / source.width;
          var newWidth = Math.max(1, Math.min(3000, parseInt(this.config.width) || 0));
          var newHeight = Math.floor(newWidth * ratio);

          this.config.width = newWidth;
          this.config.height = newHeight;
        },

        /**
         * 高度变化处理
         */
        onHeightChange: function () {
          var source = this.sourceInfo;
          if (!source.width || !source.height) return;

          var ratio = source.width / source.height;
          var newHeight = Math.max(1, Math.min(3000, parseInt(this.config.height) || 0));
          var newWidth = Math.floor(newHeight * ratio);

          this.config.width = newWidth;
          this.config.height = newHeight;
        },

        /**
         * 开始转换
         */
        startConvert: function () {
          this.$emit('convert', this.config);
        },

        /**
         * 开始转换（模板中使用）
         */
        start: function () {
          this.startConvert();
        },

        /**
         * 取消转换（模板中使用）
         */
        cancel: function () {
          this.$emit('cancel');
        },

        /**
         * 切换通道模式下拉菜单
         */
        toggleChannelModeDropdown: function () {
          this.showChannelModeDropdown = !this.showChannelModeDropdown;
        },

        /**
         * 选择通道模式
         */
        selectChannelMode: function (mode) {
          this.config.channelMode = mode;
          this.showChannelModeDropdown = false;
        }
      }
    });

    // 创建 Vue 实例
    var app = new Vue({
      el: '#app',
      data: {
        showDualChannelPanel: false,
        dualChannelSourceInfo: {
          name: 'test.svga',
          sizeWH: '300x300',
          duration: '1.00s',
          fileSize: '100KB',
          fps: 30,
          typeLabel: 'SVGA',
          width: 300,
          height: 300
        },
        dualChannelConfig: {
          channelMode: 'color-left-alpha-right',
          width: 300,
          height: 300,
          quality: 80,
          fps: 30,
          muted: false
        },
        isConvertingToDualChannel: false,
        dualChannelProgress: 0,
        dualChannelMessage: '',
        isGlobalTaskRunning: false
      },
      methods: {
        closeDualChannelPanel: function () {
          this.showDualChannelPanel = false;
        },
        cancelDualChannelConversion: function () {
          this.isConvertingToDualChannel = false;
        },
        handleDualChannelConvert: function (config) {
          console.log('开始转换双通道MP4', config);
          this.isConvertingToDualChannel = true;
          this.dualChannelProgress = 0;
          this.dualChannelMessage = '准备转换...';

          // 模拟转换过程
          var self = this;
          var progress = 0;
          var interval = setInterval(function () {
            progress += 10;
            self.dualChannelProgress = progress;
            
            if (progress < 30) {
              self.dualChannelMessage = '加载FFmpeg...';
            } else if (progress < 60) {
              self.dualChannelMessage = '处理视频...';
            } else if (progress < 90) {
              self.dualChannelMessage = '编码中...';
            } else {
              self.dualChannelMessage = '生成文件...';
            }

            if (progress >= 100) {
              clearInterval(interval);
              setTimeout(function () {
                self.isConvertingToDualChannel = false;
                self.dualChannelMessage = '';
                self.showDualChannelPanel = false;
                alert('转换成功！');
              }, 500);
            }
          }, 500);
        }
      }
    });

    // 测试控制按钮
    document.getElementById('togglePanel').addEventListener('click', function () {
      app.showDualChannelPanel = !app.showDualChannelPanel;
    });

    document.getElementById('checkState').addEventListener('click', function () {
      console.log('当前状态:', {
        showDualChannelPanel: app.showDualChannelPanel,
        dualChannelSourceInfo: app.dualChannelSourceInfo,
        dualChannelConfig: app.dualChannelConfig
      });
    });
  </script>
</body>
</html>